<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç™„É™„Éë„Ç∑„Éü„É•„É¨„Éº„Çø„Éº„É¶„Éã„Ç≥„Éº„É≥ v1.0</title>
    <style>
        :root {
            /* ÊúÄÊñ∞„ÅÆiOSÈ¢®„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà */
            --sf-blue: #007AFF;
            --sf-indigo: #5856D6;
            --sf-orange: #FF9500;
            --sf-green: #34C759;
            --sf-teal: #5AC8FA;
            --sf-red: #FF3B30;
            --sf-purple: #AF52DE;
            --sf-pink: #FF2D55;
            --sf-yellow: #FFCC00;
            --sf-gray: #8E8E93;
            --sf-gray-2: #AEAEB2;
            --sf-gray-3: #C7C7CC;
            --sf-gray-4: #D1D1D6;
            --sf-gray-5: #E5E5EA;
            --sf-gray-6: #F2F2F7;
            --sf-white: #FFFFFF;
            --sf-black: #000000;

            /* Âº∑Âåñ„Åï„Çå„Åü„Ç∑„É£„Éâ„Ç¶ */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.16);
            --shadow-2xl: 0 24px 64px rgba(0, 0, 0, 0.20);

            /* „Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É†Áî®„Ç∑„É£„Éâ„Ç¶ */
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);

            /* „Çà„ÇäÂ§ß„Åç„Å™border-radius */
            --radius-xs: 8px;
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;

            /* „Çπ„É†„Éº„Ç∫„Å™„Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥ */
            --transition-fast: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* ÂãïÁöÑ„Å™„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ËÉåÊôØ */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(
                135deg,
                #e8eef3 0%,
                #dce4ec 25%,
                #e0e7ed 50%,
                #dde5ee 75%,
                #e5ebf1 100%
            );
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            min-height: 100vh;
            letter-spacing: -0.02em;
            line-height: 1.6;
            color: rgba(0, 0, 0, 0.9);
            position: relative;
            overflow-x: hidden;
            overflow-y: scroll;
        }

        /* „Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É†ËÉåÊôØ„É¨„Ç§„É§„Éº */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(
                circle at 30% 50%,
                rgba(0, 122, 255, 0.03) 0%,
                transparent 50%
            ),
            radial-gradient(
                circle at 70% 80%,
                rgba(100, 126, 234, 0.04) 0%,
                transparent 50%
            );
            animation: float 25s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            33% {
                transform: translate(30px, -50px) rotate(120deg);
            }
            66% {
                transform: translate(-20px, 20px) rotate(240deg);
            }
        }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä - „Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É† */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(80px) saturate(200%);
            -webkit-backdrop-filter: blur(80px) saturate(200%);
            padding: 40px;
            border-radius: var(--radius-2xl);
            box-shadow:
                0 30px 90px rgba(0, 0, 0, 0.1),
                0 12px 40px rgba(0, 0, 0, 0.06),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 2px 8px rgba(255, 255, 255, 0.7) inset;
            border: 0.5px solid rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 1;
            animation: containerFadeIn 0.8s var(--transition-smooth);
        }

        @keyframes containerFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* „Çø„Ç§„Éà„É´ */
        h1 {
            color: rgba(0, 0, 0, 0.9);
            text-align: center;
            margin: 0 0 40px 0;
            font-size: 3em;
            font-weight: 700;
            letter-spacing: -0.03em;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            animation: titleSlideIn 1s var(--transition-smooth);
        }

        @keyframes titleSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* „Éê„Éº„Ç∏„Éß„É≥„Éê„ÉÉ„Ç∏ */
        .version-badge {
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 6px 16px;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 700;
            margin-left: 16px;
            vertical-align: middle;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
        }

        /* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .tab-navigation {
            display: flex;
            gap: 12px;
            margin: 0 0 32px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: var(--radius-xl);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
        }

        .tab-button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            background: transparent;
            color: rgba(0, 0, 0, 0.6);
            font-size: 15px;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            letter-spacing: -0.01em;
        }

        .tab-button:hover {
            background: rgba(0, 122, 255, 0.08);
            color: rgba(0, 0, 0, 0.8);
        }

        .tab-button.active {
            background: rgba(0, 122, 255, 0.85);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            box-shadow:
                0 6px 20px rgba(0, 122, 255, 0.35),
                0 2px 10px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset;
        }

        /* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .tab-content {
            display: none;
            animation: tabFadeIn 0.4s var(--transition-smooth);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes tabFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* „Ç∞„É™„ÉÉ„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà */
        .main-grid {
            display: grid;
            grid-template-columns: 460px 1fr;
            gap: 32px;
            animation: gridFadeIn 1s var(--transition-smooth) 0.2s both;
        }

        @keyframes gridFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* left-panel„ÅÆË°®Á§∫È†Ü„ÇíÂà∂Âæ° */
        .left-panel > .panel:nth-child(1) { order: 1; } /* Âü∫Êú¨Ë®≠ÂÆö */
        .left-panel > .panel:nth-child(2) { order: 3; } /* „Éè„Ç∫„É¨ÁÆ°ÁêÜ ‚Üí 3Áï™ÁõÆ„Å∏ */
        .left-panel > .panel:nth-child(3) { order: 2; } /* ÊôØÂìÅÁÆ°ÁêÜ ‚Üí 2Áï™ÁõÆ„Å∏ */

        /* „Éë„Éç„É´ - Âº∑Âåñ„Åï„Çå„Åü„Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É† */
        .panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            padding: 28px;
            border-radius: var(--radius-xl);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 16px 50px rgba(0, 0, 0, 0.07),
                0 6px 20px rgba(0, 0, 0, 0.04),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 1px 4px rgba(255, 255, 255, 0.7) inset;
            position: relative;
            overflow: hidden;
        }

        /* „Éë„Éç„É´„Éò„ÉÉ„ÉÄ„Éº */
        .panel h2 {
            margin: 0 0 24px 0;
            color: rgba(0, 0, 0, 0.9);
            padding-bottom: 16px;
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: -0.02em;
            position: relative;
        }

        .panel h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--sf-blue);
            border-radius: var(--radius-full);
            transition: width 0.3s var(--transition-smooth);
        }

        .panel:hover h2::after {
            width: 120px;
        }

        /* „Éï„Ç©„Éº„É†„Ç∞„É´„Éº„Éó */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
            font-size: 14px;
            letter-spacing: -0.01em;
            transition: color 0.3s var(--transition-smooth);
        }

        .form-group:focus-within label {
            color: var(--sf-blue);
        }

        /* „Ç§„É≥„Éó„ÉÉ„Éà */
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 18px;
            border: 1.5px solid rgba(0, 0, 0, 0.12);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.04),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset;
            transition: all 0.3s var(--transition-smooth);
            color: rgba(0, 0, 0, 0.9);
        }

        .form-group input:hover,
        .form-group select:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.15);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.06),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--sf-blue);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            box-shadow:
                0 0 0 4px rgba(0, 122, 255, 0.12),
                0 4px 16px rgba(0, 0, 0, 0.08),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset;
            transform: translateY(-1px);
        }

        /* „Ç®„É©„ÉºÁä∂ÊÖã */
        .form-group input.error {
            border-color: var(--sf-red);
            background-color: rgba(255, 59, 48, 0.08);
            animation: shakeError 0.4s var(--transition-smooth);
        }

        @keyframes shakeError {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .form-group input.error:focus {
            border-color: var(--sf-red);
            box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.15);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .calculated-value {
            background: rgba(52, 199, 89, 0.1);
            color: var(--sf-green);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-weight: 600;
            text-align: center;
            border: 2px solid rgba(52, 199, 89, 0.3);
        }

        .prize-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .prize-item {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: var(--radius-md);
            padding: 16px;
            position: relative;
            transition: all 0.3s var(--transition-smooth);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            overflow: hidden;
        }

        .prize-item:hover {
            border-color: var(--sf-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .prize-rank {
            display: inline-block;
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .prize-rank.rank-1 { background: #FFD700; color: var(--sf-black); }
        .prize-rank.rank-2 { background: #C0C0C0; color: var(--sf-black); }
        .prize-rank.rank-3 { background: #CD7F32; color: var(--sf-white); }
        .prize-rank.rank-4 { background: var(--sf-green); }
        .prize-rank.rank-5 { background: var(--sf-blue); }

        .prize-content {
            margin-top: 8px;
        }

        .prize-name {
            font-weight: 500;
            color: var(--sf-black);
            word-break: break-word;
            margin-bottom: 8px;
        }

        .prize-value, .prize-count, .prize-purchase {
            font-size: 12px;
            color: var(--sf-gray);
            white-space: nowrap;
        }

        /* „Éú„Çø„É≥ - „Ç∑„É≥„Éó„É´„Å™iOSÈ¢® */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            letter-spacing: -0.01em;
            position: relative;
            overflow: hidden;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-primary {
            background: rgba(0, 122, 255, 0.85);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 6px 20px rgba(0, 122, 255, 0.35),
                0 2px 10px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset,
                0 1px 4px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-primary:hover {
            background: rgba(0, 102, 221, 0.9);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(0, 122, 255, 0.45),
                0 4px 15px rgba(0, 122, 255, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset,
                0 2px 6px rgba(255, 255, 255, 0.7) inset;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
            background: rgba(0, 81, 213, 0.95);
            box-shadow:
                0 3px 12px rgba(0, 122, 255, 0.35),
                0 1px 6px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-danger {
            background: rgba(255, 59, 48, 0.8);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.75);
            box-shadow:
                0 6px 20px rgba(255, 59, 48, 0.35),
                0 2px 10px rgba(255, 59, 48, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset,
                0 1px 4px rgba(255, 255, 255, 0.5) inset;
        }

        .btn-danger:hover {
            background: rgba(230, 52, 42, 0.85);
            transform: translateY(-2px) scale(1.02);
        }

        .btn-warning {
            background: rgba(255, 149, 0, 0.8);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.75);
            box-shadow:
                0 6px 20px rgba(255, 149, 0, 0.35),
                0 2px 10px rgba(255, 149, 0, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset,
                0 1px 4px rgba(255, 255, 255, 0.5) inset;
        }

        .btn-warning:hover {
            background: rgba(245, 139, 0, 0.85);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(255, 149, 0, 0.45),
                0 4px 15px rgba(255, 149, 0, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.5) inset,
                0 2px 6px rgba(255, 255, 255, 0.4) inset;
        }

        .btn-warning:active {
            transform: translateY(0) scale(0.98);
            background: rgba(235, 129, 0, 0.8);
            box-shadow:
                0 3px 12px rgba(255, 149, 0, 0.35),
                0 1px 6px rgba(255, 149, 0, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.4) inset;
        }

        .btn-danger:active {
            transform: translateY(0) scale(0.98);
            background: rgba(204, 46, 36, 0.8);
            box-shadow:
                0 3px 12px rgba(255, 59, 48, 0.35),
                0 1px 6px rgba(255, 59, 48, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.3) inset;
        }

        .btn-success {
            background: rgba(52, 199, 89, 0.8);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.75);
            box-shadow:
                0 6px 20px rgba(52, 199, 89, 0.35),
                0 2px 10px rgba(52, 199, 89, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset,
                0 1px 4px rgba(255, 255, 255, 0.5) inset;
        }

        .btn-success:hover {
            background: rgba(47, 179, 80, 0.85);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(52, 199, 89, 0.45),
                0 4px 15px rgba(52, 199, 89, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset,
                0 2px 6px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-success:active {
            transform: translateY(0) scale(0.98);
            background: rgba(40, 167, 69, 0.9);
            box-shadow:
                0 3px 12px rgba(52, 199, 89, 0.35),
                0 1px 6px rgba(52, 199, 89, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.5) inset;
        }

        /* btn-accent„Çíbtn-primary„Å®Áµ±‰∏Ä */
        .btn-accent {
            background: rgba(0, 122, 255, 0.85);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 6px 20px rgba(0, 122, 255, 0.35),
                0 2px 10px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset,
                0 1px 4px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-accent:hover {
            background: rgba(0, 102, 221, 0.9);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(0, 122, 255, 0.45),
                0 4px 15px rgba(0, 122, 255, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset,
                0 2px 6px rgba(255, 255, 255, 0.7) inset;
        }

        .btn-accent:active {
            transform: translateY(0) scale(0.98);
            background: rgba(0, 81, 213, 0.95);
            box-shadow:
                0 3px 12px rgba(0, 122, 255, 0.35),
                0 1px 6px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset;
        }
        
        /* „Ç¨„ÉÅ„É£‰ΩìÈ®ì„Çπ„Çø„Ç§„É´ */
        .gacha-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .gacha-btn {
            flex: 1;
            min-width: 120px;
            font-weight: 600;
        }
        .gacha-results {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 0.5px solid rgba(255, 255, 255, 0.85);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 20px;
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.06),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset;
        }
        .gacha-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .gacha-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(52, 199, 89, 0.08);
            border-radius: 8px;
        }
        .gacha-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--sf-green);
        }
        .gacha-stat-label {
            font-size: 0.9em;
            color: var(--sf-gray);
        }
        .gacha-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .gacha-draw-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        .gacha-draw-prize {
            background: var(--sf-green);
            color: white;
        }
        .gacha-draw-loss {
            background: var(--sf-orange);
            color: white;
        }

        .add-prize-form {
            background: rgba(0, 122, 255, 0.03);
            border: 2px dashed rgba(0, 122, 255, 0.3);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 16px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 24px;
        }

        /* ÁµêÊûú„Éë„Éç„É´ */
        .result-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            padding: 28px;
            border-radius: var(--radius-xl);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 16px 50px rgba(0, 0, 0, 0.07),
                0 6px 20px rgba(0, 0, 0, 0.04),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 1px 4px rgba(255, 255, 255, 0.7) inset;
            position: relative;
            overflow: hidden;
        }

        .result-panel h3 {
            margin: 0 0 20px 0;
            color: rgba(0, 0, 0, 0.9);
            padding-bottom: 16px;
            font-size: 1.4em;
            font-weight: 700;
            letter-spacing: -0.02em;
            position: relative;
        }

        .result-panel h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--sf-blue);
            border-radius: var(--radius-full);
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--sf-gray-5);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: var(--sf-black);
        }

        .result-value {
            color: var(--sf-gray);
            font-weight: 600;
        }

        .highlight {
            background: rgba(255, 149, 0, 0.12);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 149, 0, 0.3);
            color: var(--sf-orange);
            font-weight: 600;
        }

        .loss-panel {
            background: rgba(255, 149, 0, 0.05);
            border: 1px solid rgba(255, 149, 0, 0.15);
        }

        .loss-panel h3::after {
            background: var(--sf-orange);
        }

        .expected-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .ev-item {
            text-align: center;
            padding: 8px;
            background: rgba(52, 199, 89, 0.08);
            border-radius: 8px;
            font-size: 12px;
        }

        .ev-count {
            font-weight: 600;
            color: var(--sf-green);
        }

        .ev-value {
            color: var(--sf-gray);
            font-size: 11px;
        }

        .warning {
            background: rgba(255, 59, 48, 0.1);
            color: var(--sf-red);
            padding: 16px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 59, 48, 0.2);
            margin-top: 24px;
            font-size: 14px;
        }

        /* „Éó„É™„Çª„ÉÉ„Éà„Ç™„É™„Éë„ÅÆ„Çπ„Çø„Ç§„É´ */
        .preset-section label {
            transition: all 0.2s var(--transition-smooth);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
        }

        .preset-section label:hover {
            background: rgba(0, 122, 255, 0.05);
            border-color: rgba(0, 122, 255, 0.2);
        }

        .preset-section input[type="radio"]:checked + span {
            color: var(--sf-blue);
            font-weight: 600;
        }

        .preset-section input[type="radio"]:checked {
            accent-color: var(--sf-blue);
        }

        /* „É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„Çø„Ç§„É´ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s var(--transition-smooth);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            border: 0.5px solid rgba(255, 255, 255, 0.9);
            border-radius: var(--radius-xl);
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 2px 8px rgba(255, 255, 255, 0.6) inset;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s var(--transition-smooth);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--sf-gray-5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 600;
            color: var(--sf-black);
        }

        .modal-close {
            font-size: 32px;
            color: var(--sf-gray);
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s var(--transition);
        }

        .modal-close:hover {
            color: var(--sf-red);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--sf-gray-5);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-footer .btn {
            min-width: 100px;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥ - Âº∑Âåñ */
        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 420px 1fr;
                gap: 28px;
            }
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 400px 1fr;
                gap: 24px;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        @media (max-width: 1024px) {
            body {
                padding: 16px;
            }

            .container {
                padding: 28px;
                border-radius: var(--radius-xl);
            }

            h1 {
                font-size: 2.2em;
                margin-bottom: 32px;
            }

            .main-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 20px;
                border-radius: var(--radius-lg);
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 24px;
            }

            .version-badge {
                display: block;
                margin: 12px auto 0;
                width: fit-content;
            }

            .panel, .result-panel {
                padding: 20px;
                border-radius: var(--radius-lg);
            }

            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 16px;
                border-radius: var(--radius-md);
            }

            h1 {
                font-size: 1.5em;
            }

            .panel, .result-panel {
                padding: 16px;
            }
        }

        /* „Çπ„É†„Éº„Ç∫„Çπ„ÇØ„É≠„Éº„É´ */
        html {
            scroll-behavior: smooth;
            overflow-y: scroll;
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-full);
            transition: background 0.3s var(--transition-smooth);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* „Çª„É¨„ÇØ„Ç∑„Éß„É≥ */
        ::selection {
            background: rgba(0, 122, 255, 0.3);
            color: var(--sf-white);
        }

        /* „Éï„Ç©„Éº„Ç´„ÇπË°®Á§∫„ÅÆÊîπÂñÑ */
        *:focus-visible {
            outline: 2px solid var(--sf-blue);
            outline-offset: 2px;
        }

        /* ÊôØÂìÅ‰∏ÄË¶ß„Éö„Éº„Ç∏Áî®„Çπ„Çø„Ç§„É´ */
        .prize-master-list {
            display: grid;
            gap: 16px;
        }

        .prize-master-item {
            background: rgba(255, 255, 255, 0.95);
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            border-radius: var(--radius-lg);
            padding: 24px;
            position: relative;
            transition: all 0.3s var(--transition-smooth);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        }

        .prize-master-item:hover {
            border-color: var(--sf-blue);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        .prize-master-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .prize-master-title {
            flex: 1;
        }

        .prize-master-name {
            font-size: 18px;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.9);
            margin-bottom: 8px;
        }

        .prize-master-rank-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        .prize-master-rank-badge.rank-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: var(--sf-black);
        }

        .prize-master-rank-badge.rank-2 {
            background: linear-gradient(135deg, #E0E0E0, #B0B0B0);
            color: var(--sf-black);
        }

        .prize-master-rank-badge.rank-3 {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: var(--sf-white);
        }

        .prize-master-rank-badge.rank-4 {
            background: var(--sf-green);
            color: var(--sf-white);
        }

        .prize-master-rank-badge.rank-5 {
            background: var(--sf-blue);
            color: var(--sf-white);
        }

        .prize-master-actions {
            display: flex;
            gap: 8px;
        }

        .prize-master-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .prize-master-info-item {
            text-align: center;
        }

        .prize-master-info-label {
            font-size: 12px;
            color: var(--sf-gray);
            margin-bottom: 4px;
        }

        .prize-master-info-value {
            font-size: 16px;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.9);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            font-size: 18px;
        }

        /* „É©„Éô„É´‰ªò„Åç„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .btn-with-label {
            position: relative;
            width: auto;
            min-width: 36px;
            padding: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-with-label .btn-icon-emoji {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            font-size: 18px;
            flex-shrink: 0;
        }

        .btn-with-label .btn-label {
            display: inline-block;
            max-width: 0;
            overflow: hidden;
            white-space: nowrap;
            opacity: 0;
            font-size: 13px;
            font-weight: 600;
            padding: 0;
            transition: all 0.3s ease;
        }

        .btn-with-label:hover {
            width: auto;
            padding-right: 12px;
        }

        .btn-with-label:hover .btn-label {
            max-width: 100px;
            opacity: 1;
            padding-left: 4px;
        }


        /* Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: var(--radius-xl);
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            animation: modalSlideIn 0.3s var(--transition-smooth);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .edit-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.9);
        }

        .edit-modal-close {
            background: transparent;
            border: none;
            font-size: 28px;
            color: var(--sf-gray);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .edit-modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.8);
        }

        .edit-modal-footer {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* „Ç´„Çπ„Çø„É†„Ç¢„É©„Éº„Éà„É¢„Éº„ÉÄ„É´„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ÈÄöÁü•„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>„Ç™„É™„Éë„Ç∑„Éü„É•„É¨„Éº„Çø„Éº„É¶„Éã„Ç≥„Éº„É≥ <span class="version-badge">v1.0</span></h1>

        <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('main', event)">„É°„Ç§„É≥</button>
            <button class="tab-button" onclick="switchTab('prize-list', event)">ÊôØÂìÅ„Éû„Çπ„Çø„Éº</button>
            <button class="tab-button" onclick="switchTab('inventory-adjustment', event)">üì¶ Âú®Â∫´Ë™øÊï¥</button>
        </div>

        <!-- „É°„Ç§„É≥„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div id="tab-main" class="tab-content active">
        <div class="main-grid">
            <div class="left-panel" style="display: grid; gap: 24px;">
                <!-- Âü∫Êú¨Ë®≠ÂÆö -->
                <div class="panel">
                    <h2>Âü∫Êú¨Ë®≠ÂÆö</h2>

                    <!-- „Ç™„É™„ÉëÂêç -->
                    <div class="form-group">
                        <label>„Ç™„É™„ÉëÂêç</label>
                        <input type="text" id="cloudConfigName" placeholder="‰æã: „Éù„Ç±„É¢„É≥„Ç™„É™„ÉëAÊ°à„ÄÅ1.9Ë≥ûÈáë" oninput="sanitizeConfigNameInput(this)">
                        <div id="configNameWarning" style="font-size: 11px; color: var(--sf-blue); margin-top: 4px; display: none;">
                            üí° ‰øùÂ≠òÊôÇ„Å´‰ΩøÁî®„Åß„Åç„Å™„ÅÑÊñáÂ≠ó„ÅØÂÜÖÈÉ®ÁöÑ„Å´Â§âÊèõ„Åï„Çå„Åæ„Åô„Åå„ÄÅË°®Á§∫Âêç„ÅØ„Åù„ÅÆ„Åæ„Åæ‰øùÊåÅ„Åï„Çå„Åæ„Åô
                        </div>
                    </div>

                    <div class="form-group">
                        <label>„Éë„ÉÉ„ÇØÂçò‰æ° (ÂÜÜ)</label>
                        <input type="number" id="packPrice" value="40000">
                    </div>
                    <div class="form-group">
                        <label>Á∑èÂè£Êï∞</label>
                        <input type="number" id="totalPacks" value="100">
                    </div>
                    <div class="form-group">
                        <label>„Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§</label>
                        <div class="calculated-value" id="totalValue">¬•0</div>
                    </div>

                    <!-- „É°„É¢Ê¨Ñ -->
                    <div class="form-group" style="margin-top: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            üìù „É°„É¢
                            <span style="font-size: 12px; color: var(--sf-gray); font-weight: 400;">Ôºà„ÇØ„É©„Ç¶„ÉâÂÖ±Êúâ„Åï„Çå„Åæ„ÅôÔºâ</span>
                        </label>
                        <textarea id="configMemo" placeholder="„Åì„ÅÆ„Ç™„É™„Éë„Å´Èñ¢„Åô„Çã„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ&#10;‰æã: È´òÈ°ç„Ç´„Éº„ÉâÂ§ö„ÇÅ„ÅÆË®≠ÂÆö„ÄÅÂàùÂøÉËÄÖÂêë„Åë„ÄÅÊúüÈñìÈôêÂÆö„Å™„Å©"
                                  style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: var(--radius-md); font-family: inherit; font-size: 14px; resize: vertical; line-height: 1.6;"></textarea>
                    </div>

                    <div style="margin-top: 16px;">
                        <button class="btn btn-success" onclick="calculate()" style="width: 100%; font-size: 16px; padding: 14px;">
                            üßÆ Ë®àÁÆó„Åô„Çã
                        </button>
                        <button class="btn btn-danger" onclick="clearAllSettings()" style="width: 100%; font-size: 14px; padding: 12px; margin-top: 12px;">
                            üóëÔ∏è ÂÖ®„ÇØ„É™„Ç¢ÔºàÊñ∞Ë¶è„Ç™„É™„Éë‰ΩúÊàêÔºâ
                        </button>
                    </div>

                    <!-- „ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„ÉªÂÖ±Êúâ -->
                    <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--sf-gray-5);">
                        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--sf-blue);">‚òÅÔ∏è „ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„ÉªÂÖ±Êúâ</h3>

                        <!-- ‰øùÂ≠ò„Éú„Çø„É≥ -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <button class="btn btn-primary" onclick="saveToCloudWithName()" style="font-size: 12px;">
                                üíæ Êñ∞Ë¶è‰øùÂ≠ò
                            </button>
                            <button class="btn btn-accent" onclick="updateCloudConfig()" style="font-size: 12px;" id="updateCloudBtn" disabled>
                                üîÑ ‰∏äÊõ∏„ÅçÊõ¥Êñ∞
                            </button>
                        </div>

                        <!-- Ë™≠„ÅøËæº„Åø„Çª„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="form-group">
                            <label style="font-size: 13px;">„ÇØ„É©„Ç¶„ÉâË®≠ÂÆö‰∏ÄË¶ß</label>
                            <select id="cloudConfigList" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small); font-size: 13px;">
                                <option value="">Ë®≠ÂÆö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <button class="btn btn-success" onclick="loadSelectedCloudConfig()" style="font-size: 12px;">
                                üìÇ Ë™≠„ÅøËæº„Åø
                            </button>
                            <button class="btn btn-danger" onclick="deleteSelectedCloudConfig()" style="font-size: 12px;">
                                üóëÔ∏è ÂâäÈô§
                            </button>
                        </div>

                        <button class="btn btn-primary" onclick="refreshCloudConfigList()" style="width: 100%; font-size: 12px; margin-bottom: 12px;">
                            üîÑ ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                        </button>

                        <!-- ÂÖ±Êúâ„É™„É≥„ÇØ -->
                        <div style="padding-top: 12px; border-top: 1px solid var(--sf-gray-5);">
                            <button class="btn btn-accent" onclick="generateShareLink()" style="width: 100%; font-size: 12px;" id="shareBtn" disabled>
                                üîó ÂÖ±Êúâ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº
                            </button>
                            <div id="shareStatus" style="margin-top: 8px; font-size: 11px; color: var(--sf-gray); text-align: center;"></div>
                        </div>

                        <div id="cloudStatus" style="margin-top: 12px; font-size: 12px; color: var(--sf-gray);"></div>
                    </div>
                </div>

                <!-- „Éè„Ç∫„É¨ÁÆ°ÁêÜ -->
                <div class="panel">
                    <h2>„Éè„Ç∫„É¨ÁÆ°ÁêÜ</h2>
                    <p style="color: var(--sf-gray); font-size: 13px; margin-bottom: 16px;">
                        „Éè„Ç∫„É¨„ÇíÊâãÂãï„ÅßË®≠ÂÆö„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅÊúÄ‰Ωé‰øùË®º‰æ°ÂÄ§„ÅßËá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åô
                    </p>

                    <!-- ÊúÄ‰Ωé‰øùË®ºËá™ÂãïË®àÁÆó„ÅÆË®≠ÂÆö -->
                    <div class="form-group" style="background: rgba(0, 122, 255, 0.05); padding: 16px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.2); margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <input type="checkbox" id="enableMinGuaranteeAuto" style="width: 20px; height: 20px; cursor: pointer;">
                            <label for="enableMinGuaranteeAuto" style="cursor: pointer; margin: 0; font-weight: 600; color: var(--sf-blue);">
                                üí° ÊâãÂãï„Éè„Ç∫„É¨„Å®ÊúÄ‰Ωé‰øùË®º„Çí‰ΩµÁî®„Åô„Çã
                            </label>
                        </div>
                        <div style="font-size: 12px; color: var(--sf-gray); line-height: 1.6; margin-bottom: 12px;">
                            ON„Å´„Åô„Çã„Å®„ÄÅÊâãÂãï„ÅßË®≠ÂÆö„Åó„Åü„Éè„Ç∫„É¨„Å´Âä†„Åà„Å¶„ÄÅÊÆã„Çä„ÅÆÂè£Êï∞„ÇíÊúÄ‰Ωé‰øùË®º‰æ°ÂÄ§„ÅÆ„Éè„Ç∫„É¨„ÅßËá™ÂãïÁöÑ„Å´Âüã„ÇÅ„Åæ„Åô„ÄÇ
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>ÊúÄ‰Ωé‰øùË®º‰æ°ÂÄ§ (ÂÜÜ)</label>
                            <input type="number" id="minGuaranteeValue" value="1" min="1" step="1">
                        </div>
                    </div>

                    <div class="prize-list" id="lossList" style="margin-top: 16px;">
                        <!-- „Éè„Ç∫„É¨„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>

                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>„Éè„Ç∫„É¨Âêç</label>
                            <input type="text" id="lossName" placeholder="‰æã: „Éè„Ç∫„É¨A">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‰æ°ÂÄ§ (ÂÜÜ)</label>
                                <input type="number" id="lossValue" placeholder="100" min="1">
                            </div>
                            <div class="form-group">
                                <label>ÊûöÊï∞</label>
                                <input type="number" id="lossCount" min="1" value="1">
                            </div>
                        </div>
                        <button class="btn btn-success" id="addLossBtn" onclick="addLoss()" style="width: 100%;">„Éè„Ç∫„É¨„ÇíËøΩÂä†</button>
                        <button class="btn btn-success" id="updateLossBtn" onclick="updateLoss()" style="display: none; width: 100%;">„Éè„Ç∫„É¨„ÇíÊõ¥Êñ∞</button>
                        <button class="btn btn-danger" id="cancelEditLossBtn" onclick="cancelEditLoss()" style="display: none; margin-top: 8px;">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </div>

                <!-- ÊôØÂìÅÁÆ°ÁêÜ -->
                <div class="panel">
                    <h2>ÊôØÂìÅÁÆ°ÁêÜ</h2>
                    <div class="prize-list" id="prizeList">
                        <!-- ÊôØÂìÅ„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>

                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>ÊôØÂìÅÂêç</label>
                            <input type="text" id="prizeName" placeholder="‰∏ã„ÅÆ„Éú„Çø„É≥„Åã„ÇâÊôØÂìÅ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" readonly style="background: rgba(0, 0, 0, 0.02); cursor: not-allowed;">
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <button class="btn btn-primary" onclick="selectFromPrizeMasterForMain()" style="flex: 1; white-space: nowrap;">
                                    üìã „Éû„Çπ„Çø„Éº„Åã„ÇâÈÅ∏Êäû
                                </button>
                            </div>
                        </div>

                        <!-- ÁîªÂÉè„Å®‰ªïÂÖ•„Çå‰æ°Ê†º„ÅÆË°®Á§∫„Ç®„É™„Ç¢ -->
                        <div id="prizeReadonlyInfo" style="display: none; background: rgba(0, 0, 0, 0.02); padding: 12px; border-radius: var(--radius-md); margin-bottom: 16px;">
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <div id="prizeImageDisplay"></div>
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">‰ªïÂÖ•„Çå‰æ°Ê†ºÔºàÁ®éËæºÔºâ</div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <input type="text" id="prizePurchasePriceInput" placeholder="50,000"
                                               oninput="formatPrizeValue(this)"
                                               style="width: 120px; padding: 8px 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--radius-sm); font-size: 14px; font-weight: 600;">
                                        <span style="font-size: 14px; color: var(--sf-gray);">ÂÜÜ</span>
                                    </div>
                                    <div id="prizePurchasePriceHint" style="font-size: 11px; color: var(--sf-gray); margin-top: 4px;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" id="prizeRankGroup">
                            <label>Á≠âÁ¥ö</label>
                            <select id="prizeRank" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                                <option value="1">1Á≠â</option>
                                <option value="2">2Á≠â</option>
                                <option value="3">3Á≠â</option>
                                <option value="4">4Á≠â</option>
                                <option value="5">5Á≠â</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ÊôØÂìÅ„Çø„Ç§„Éó</label>
                            <select id="prizeType" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);" onchange="handlePrizeTypeChange()">
                                <option value="normal">ÈÄöÂ∏∏ÊôØÂìÅ</option>
                                <option value="lastOne">„É©„Çπ„Éà„ÉØ„É≥Ë≥û</option>
                                <option value="milestone">„Ç≠„É™Áï™Ë≥û</option>
                            </select>
                            <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;" id="prizeTypeDescription">
                                ÈÄöÂ∏∏„ÅÆ„Ç¨„ÉÅ„É£ÊôØÂìÅ„Å®„Åó„Å¶ÊäΩÈÅ∏„Éó„Éº„É´„Å´ÂÖ•„Çä„Åæ„Åô
                            </div>
                        </div>
                        <div class="form-group">
                            <label>„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§</label>
                            <input type="text" id="prizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                        </div>
                        <div class="form-group">
                            <label>Â∞ÅÂÖ•Êï∞</label>
                            <input type="number" id="prizeCount" min="1" value="1">
                            <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;" id="prizeCountDescription">
                            </div>
                        </div>
                        <button class="btn btn-success" id="addPrizeBtn" onclick="addPrizeFromForm()" style="width: 100%;">ÊôØÂìÅ„ÇíËøΩÂä†</button>
                        <button class="btn btn-success" id="updatePrizeBtn" onclick="updatePrizeFromForm()" style="display: none; width: 100%;">ÊôØÂìÅ„ÇíÊõ¥Êñ∞</button>
                        <button class="btn btn-primary" id="replacePrizeBtn" onclick="selectFromPrizeMasterForReplace()" style="display: none; margin-top: 8px;">üîÑ Âà•„ÅÆÊôØÂìÅ„Å´ÁΩÆ„ÅçÊèõ„Åà</button>
                        <button class="btn btn-danger" id="cancelEditBtn" onclick="cancelEditPrize()" style="display: none; margin-top: 8px;">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </div>

            </div>

            <div class="results-grid">
                <!-- „Çµ„Éû„É™„Éº -->
                <div class="result-panel">
                    <h3>„Çµ„Éû„É™„Éº</h3>
                    <div class="result-row">
                        <span class="result-label">Á∑èÈÇÑÂÖÉÁéá</span>
                        <span class="result-value" id="summaryTotalReturn">98.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ÂÆüË≥™ÈÇÑÂÖÉÁéáÔºàÂ£≤‰∏äÂéü‰æ°ÁéáÔºâ</span>
                        <span class="result-value highlight" id="summaryRealReturn">0.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Á∑èÂΩìÈÅ∏ËÄÖÊï∞</span>
                        <span class="result-value" id="summaryWinnerCount">0‰∫∫</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Á∑è‰ªïÂÖ•„ÇåÈ°ç</span>
                        <span class="result-value" id="summaryTotalPurchase">¬•0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ÂΩì„Åü„ÇäÊôØÂìÅÈÇÑÂÖÉÁ∑èÈ°ç</span>
                        <span class="result-value" id="summaryPrizeTotalReward">¬•0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">„Éè„Ç∫„É¨ÈÇÑÂÖÉÁ∑èÈ°ç</span>
                        <span class="result-value" id="summaryLossTotalReward">¬•0</span>
                    </div>
                </div>

                <!-- ÊôØÂìÅË©≥Á¥∞ -->
                <div class="result-panel">
                    <h3>ÊôØÂìÅË©≥Á¥∞</h3>
                    <div id="prizeDetails">
                        <p style="color: var(--sf-gray); text-align: center;">ÊôØÂìÅ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                </div>

                <!-- „Éè„Ç∫„É¨Ë©≥Á¥∞ + ÂàÜÂ∏É -->
                <div class="result-panel loss-panel">
                    <h3>„Éè„Ç∫„É¨Ë©≥Á¥∞ÔºàËá™ÂãïË®àÁÆóÔºâ</h3>
                    <div id="lossDetailsContainer">
                        <!-- „Éè„Ç∫„É¨Ë©≥Á¥∞„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>
                    <div class="result-row">
                        <span class="result-label">„Éè„Ç∫„É¨Á∑èÊûöÊï∞</span>
                        <span class="result-value" id="totalLossCount">0Êûö</span>
                    </div>

                    <!-- „Éè„Ç∫„É¨ÂΩìÈÅ∏ËÄÖÂàÜÂ∏É -->
                    <div style="margin-top: 24px; padding-top: 24px; border-top: 1.5px solid rgba(255, 255, 255, 0.4);">
                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--sf-black);">„Éè„Ç∫„É¨ÂΩìÈÅ∏ËÄÖÂàÜÂ∏É</h4>
                        <div class="chart-container">
                            <canvas id="lossDistributionChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>




                <!-- „Ç¨„ÉÅ„É£‰ΩìÈ®ì -->
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <h3>üéÆ „Ç¨„ÉÅ„É£‰ΩìÈ®ì</h3>
                    <p style="color: var(--sf-gray); font-size: 14px; margin-bottom: 20px;">
                        ÂÆüÈöõ„Å´„Ç™„É™„Éë„ÇíÂºï„ÅÑ„Å¶„ÄÅË®≠Ë®à„Åó„Åü„Ç¨„ÉÅ„É£„ÅÆ‰ΩìÈ®ì„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô
                    </p>
                    
                    <!-- „Ç¨„ÉÅ„É£„Éú„Çø„É≥ -->
                    <div class="gacha-controls">
                        <button class="btn btn-primary gacha-btn" onclick="drawGacha(1)">
                            üé≤ 1ÂõûÂºï„Åè
                        </button>
                        <button class="btn btn-secondary gacha-btn" onclick="drawGacha(10)">
                            üé≤ 10ÂõûÂºï„Åè
                        </button>
                        <button class="btn btn-accent gacha-btn" onclick="drawGacha(100)">
                            üé≤ 100ÂõûÂºï„Åè
                        </button>
                        <button class="btn btn-danger gacha-btn" onclick="resetGacha()" id="resetGachaBtn" style="display: none;">
                            üîÑ „É™„Çª„ÉÉ„Éà
                        </button>
                    </div>
                    
                    <!-- „Ç¨„ÉÅ„É£ÁµêÊûú -->
                    <div id="gachaResults" class="gacha-results" style="display: none;">
                        <h4>„Ç¨„ÉÅ„É£ÁµêÊûú</h4>
                        <div id="gachaStats" class="gacha-stats"></div>
                        <div id="gachaHistory" class="gacha-history"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="warnings"></div>
        </div>
        <!-- /„É°„Ç§„É≥„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->

        <!-- ÊôØÂìÅ‰∏ÄË¶ß„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div id="tab-prize-list" class="tab-content">
            <div class="panel">
                <h2>ÊôØÂìÅ„Éû„Çπ„Çø„Éº</h2>
                <p style="color: var(--sf-gray); font-size: 14px; margin-bottom: 24px;">
                    „Ç™„É™„Éë„Åß‰ΩøÁî®„Åô„ÇãÊôØÂìÅ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇÊôØÂìÅ„Éá„Éº„Çø„ÅØ„ÇØ„É©„Ç¶„Éâ„Å´Ëá™Âãï‰øùÂ≠ò„Åï„Çå„ÄÅ„É°„Ç§„É≥„Çø„Éñ„ÅßÈÅ∏Êäû„Åó„Å¶‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ
                </p>

                <!-- Âú®Â∫´„Çµ„Éû„É™„Éº„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div id="inventorySummary" style="background: linear-gradient(135deg, rgba(0, 122, 255, 0.08) 0%, rgba(88, 86, 214, 0.08) 100%); padding: 20px; border-radius: var(--radius-lg); border: 1px solid rgba(0, 122, 255, 0.2); margin-bottom: 24px; box-shadow: var(--shadow-sm);">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--sf-black); display: flex; align-items: center; gap: 8px;">
                        üìä Âú®Â∫´„Çµ„Éû„É™„Éº
                        <span style="font-size: 12px; font-weight: 500; color: var(--sf-gray);">ÔºàÂú®Â∫´„ÅÇ„Çä„ÅÆ„Ç´„Éº„Éâ„ÅÆ„ÅøÔºâ</span>
                    </h3>

                    <!-- „É°„Ç§„É≥Áµ±Ë®à -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div style="background: white; padding: 16px; border-radius: var(--radius-md); box-shadow: var(--shadow-xs); border: 1px solid rgba(0, 0, 0, 0.05);">
                            <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">Âú®Â∫´Êï∞</div>
                            <div id="summaryStockCount" style="font-size: 24px; font-weight: 700; color: var(--sf-blue);">0 Êûö</div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: var(--radius-md); box-shadow: var(--shadow-xs); border: 1px solid rgba(0, 0, 0, 0.05);">
                            <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">‰ªïÂÖ•„ÇåÁ∑è‰æ°Ê†º</div>
                            <div id="summaryTotalPurchasePrice" style="font-size: 24px; font-weight: 700; color: var(--sf-green);">¬•0</div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: var(--radius-md); box-shadow: var(--shadow-xs); border: 1px solid rgba(0, 0, 0, 0.05);">
                            <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">ÈÇÑÂÖÉ„Éù„Ç§„É≥„ÉàÁ∑è‰æ°Ê†º</div>
                            <div id="summaryTotalRewardValue" style="font-size: 24px; font-weight: 700; color: var(--sf-orange);">¬•0</div>
                        </div>
                    </div>

                    <!-- ÈÇÑÂÖÉ„Éù„Ç§„É≥„Éà‰æ°Ê†ºÂ∏ØÂà•ÊûöÊï∞ -->
                    <div style="background: white; padding: 16px; border-radius: var(--radius-md); box-shadow: var(--shadow-xs); border: 1px solid rgba(0, 0, 0, 0.05);">
                        <div style="font-size: 13px; font-weight: 600; color: var(--sf-label); margin-bottom: 12px;">ÈÇÑÂÖÉ„Éù„Ç§„É≥„Éà‰æ°Ê†ºÂ∏ØÂà•ÊûöÊï∞</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(142, 142, 147, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-gray);">„Äú1,000pt</span>
                                <span id="summaryRange0" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(52, 199, 89, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-green);">1,001„Äú5,000pt</span>
                                <span id="summaryRange1" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(0, 122, 255, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-blue);">5,001„Äú10,000pt</span>
                                <span id="summaryRange2" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(175, 82, 222, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-purple);">10,001„Äú20,000pt</span>
                                <span id="summaryRange3" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255, 149, 0, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-orange);">20,001„Äú50,000pt</span>
                                <span id="summaryRange4" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255, 45, 85, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-pink);">50,001„Äú100,000pt</span>
                                <span id="summaryRange5" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255, 59, 48, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-red);">100,001„Äú200,000pt</span>
                                <span id="summaryRange6" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: linear-gradient(135deg, rgba(255, 204, 0, 0.15) 0%, rgba(255, 149, 0, 0.15) 100%); border-radius: var(--radius-sm); border: 1px solid rgba(255, 204, 0, 0.3);">
                                <span style="font-size: 13px; color: #B8860B; font-weight: 600;">200,001pt„Äú</span>
                                <span id="summaryRange7" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                        </div>
                    </div>

                    <!-- Á®ÆÈ°ûÂà•ÊûöÊï∞ -->
                    <div style="background: white; padding: 16px; border-radius: var(--radius-md); box-shadow: var(--shadow-xs); border: 1px solid rgba(0, 0, 0, 0.05); margin-top: 16px;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--sf-label); margin-bottom: 12px;">Á®ÆÈ°ûÂà•ÊûöÊï∞</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(0, 122, 255, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-blue);">üèÜ PSA10</span>
                                <span id="summaryTypePSA10" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(52, 199, 89, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-green);">‚ú® ÁæéÂìÅ</span>
                                <span id="summaryTypeÁæéÂìÅ" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255, 149, 0, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-orange);">üì¶ „Éë„ÉÉ„ÇØ</span>
                                <span id="summaryType„Éë„ÉÉ„ÇØ" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0ÂÄã</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(175, 82, 222, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-purple);">üì¶ „Éú„ÉÉ„ÇØ„Çπ</span>
                                <span id="summaryType„Éú„ÉÉ„ÇØ„Çπ" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0ÂÄã</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(142, 142, 147, 0.1); border-radius: var(--radius-sm);">
                                <span style="font-size: 13px; color: var(--sf-gray);">üìã „Åù„ÅÆ‰ªñ</span>
                                <span id="summaryType„Åù„ÅÆ‰ªñ" style="font-size: 15px; font-weight: 600; color: var(--sf-black);">0Êûö</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 24px;">
                    <!-- „ÇØ„É©„Ç¶„ÉâÂêåÊúü„Çπ„ÉÜ„Éº„Çø„Çπ -->
                    <div style="background: rgba(52, 199, 89, 0.1); padding: 12px 16px; border-radius: var(--radius-md); border: 1px solid rgba(52, 199, 89, 0.3); margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">‚òÅÔ∏è „ÇØ„É©„Ç¶„ÉâÂêåÊúü„Çπ„ÉÜ„Éº„Çø„Çπ</div>
                            <div id="syncStatus" style="font-size: 14px; font-weight: 600; color: var(--sf-green);">ÂàùÊúüÂåñ‰∏≠...</div>
                        </div>
                        <button class="btn btn-primary" onclick="manualSyncPrizeMaster()" style="padding: 8px 16px; font-size: 13px;">
                            üîÑ ‰ªä„Åô„ÅêÂêåÊúü
                        </button>
                    </div>

                    <!-- „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉªÂæ©ÂÖÉ„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <div style="background: rgba(255, 149, 0, 0.1); padding: 12px 16px; border-radius: var(--radius-md); border: 1px solid rgba(255, 149, 0, 0.3); margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                            <div>
                                <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">üíæ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉªÂæ©ÂÖÉ</div>
                                <div style="font-size: 13px; color: var(--sf-orange);">‰∏á„Åå‰∏Ä„Å´ÂÇô„Åà„Å¶ÂÆöÊúüÁöÑ„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂèñ„Çä„Åæ„Åó„Çá„ÅÜ</div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="exportPrizeMasterJson()" style="padding: 8px 16px; background: var(--sf-blue); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600;">
                                    üì• JSON„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                                </button>
                                <label style="padding: 8px 16px; background: var(--sf-green); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600;">
                                    üì§ JSON„Ç§„É≥„Éù„Éº„Éà
                                    <input type="file" accept=".json" onchange="importPrizeMasterJson(event)" style="display: none;">
                                </label>
                                <button onclick="openCloudBackupModal()" style="padding: 8px 16px; background: var(--sf-purple); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600;">
                                    ‚òÅÔ∏è „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
                                </button>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="toggleAddPrizeForm()" style="flex: 1; min-width: 200px;">
                            ‚ûï Êñ∞Ë¶èÊôØÂìÅ„ÇíÁôªÈå≤
                        </button>
                    </div>

                    <!-- Êñ∞Ë¶èÊôØÂìÅÁôªÈå≤„Éï„Ç©„Éº„É† -->
                    <div id="addPrizeFormContainer" style="display: none; background: rgba(0, 122, 255, 0.05); padding: 20px; border-radius: var(--radius-lg); border: 2px solid rgba(0, 122, 255, 0.3); margin-bottom: 16px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--sf-black);">Êñ∞Ë¶èÊôØÂìÅ„ÇíÁôªÈå≤</h3>

                        <div class="form-group">
                            <label>ÊôØÂìÅÂêç</label>
                            <input type="text" id="newPrizeName" placeholder="‰æã: „É¨„Ç¢„Ç´„Éº„Éâ">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>‰ªïÂÖ•„Çå‰æ°Ê†º</label>
                                <input type="text" id="newPrizePurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this)">
                            </div>
                            <div class="form-group">
                                <label>„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§</label>
                                <input type="text" id="newPrizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Âú®Â∫´Êï∞</label>
                            <input type="number" id="newPrizeCount" min="0" value="1">
                        </div>

                        <div class="form-group">
                            <label>ÊôØÂìÅÁ®ÆÈ°û</label>
                            <select id="newPrizeType" style="padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                                <option value="PSA10" selected>PSA10</option>
                                <option value="ÁæéÂìÅ">ÁæéÂìÅ</option>
                                <option value="„Éë„ÉÉ„ÇØ">„Éë„ÉÉ„ÇØ</option>
                                <option value="„Éú„ÉÉ„ÇØ„Çπ">„Éú„ÉÉ„ÇØ„Çπ</option>
                                <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                                <input type="checkbox" id="newPrizeIsWanted" style="width: 20px; height: 20px; cursor: pointer;">
                                <span>‚ù§Ô∏è Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„É™„Çπ„Éà„Å´ËøΩÂä†</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label>ÊôØÂìÅÁîªÂÉèURLÔºà‰ªªÊÑèÔºâ</label>
                            <input type="text" id="newPrizeImageUrl" placeholder="https://example.com/image.jpg" oninput="previewImageFromUrl(this.value, 'prizeImagePreviewImg', 'prizeImagePreview')">
                            <div id="prizeImagePreview" style="margin-top: 12px; display: none;">
                                <img id="prizeImagePreviewImg" style="max-width: 200px; max-height: 200px; border-radius: var(--radius-md); border: 2px solid rgba(0, 0, 0, 0.1);" onerror="this.style.border='2px solid red';">
                                <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;">„Éó„É¨„Éì„É•„Éº</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-danger" onclick="cancelAddPrize()" style="flex: 1;">„Ç≠„É£„É≥„Çª„É´</button>
                            <button class="btn btn-primary" onclick="addNewPrizeToMaster()" style="flex: 1;">ÁôªÈå≤</button>
                        </div>
                    </div>

                    <div style="background: rgba(0, 122, 255, 0.05); padding: 16px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.2);">
                        <div style="font-size: 13px; color: var(--sf-gray); margin-bottom: 8px;">
                            üí° <strong>„ÇØ„É©„Ç¶„ÉâÂÖ±ÊúâÊ©üËÉΩ</strong>
                        </div>
                        <div style="font-size: 12px; color: var(--sf-gray); line-height: 1.6;">
                            ‚Ä¢ ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅØËá™ÂãïÁöÑ„Å´„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô<br>
                            ‚Ä¢ ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåËøΩÂä†„Åó„ÅüÊôØÂìÅ„ÇÇËá™ÂãïÁöÑ„Å´ÂêåÊúü„Åï„Çå„Åæ„Åô<br>
                            ‚Ä¢ JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„Ç§„É≥„Éù„Éº„Éà„Åó„ÅüÊôØÂìÅ„ÇÇÂÖ®„É¶„Éº„Ç∂„Éº„ÅßÂÖ±Êúâ„Åï„Çå„Åæ„Åô
                        </div>
                    </div>
                </div>

                <!-- ‰∏¶„Å≥Êõø„Åà„Éª„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö -->
                <div style="margin-bottom: 16px; padding: 16px; background: rgba(0, 0, 0, 0.02); border-radius: var(--radius-lg); display: flex; gap: 12px; align-items: center; flex-wrap: wrap; min-height: 60px;">
                    <label style="font-weight: 600; font-size: 14px; color: var(--sf-label); flex-shrink: 0;">‰∏¶„Å≥Êõø„Åà:</label>
                    <select id="prizeMasterSortBy" onchange="updatePrizeMasterList()" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; cursor: pointer; min-width: 140px; height: 38px;">
                        <option value="price">‰ªïÂÖ•„Çå‰æ°Ê†ºÈ†Ü</option>
                        <option value="date">ÁôªÈå≤Êó•ÊôÇÈ†Ü</option>
                    </select>
                    <select id="prizeMasterSortOrder" onchange="updatePrizeMasterList()" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; cursor: pointer; min-width: 180px; height: 38px;">
                        <option value="desc">ÈôçÈ†ÜÔºàÈ´ò„ÅÑ/Êñ∞„Åó„ÅÑÈ†ÜÔºâ</option>
                        <option value="asc">ÊòáÈ†ÜÔºàÂÆâ„ÅÑ/Âè§„ÅÑÈ†ÜÔºâ</option>
                    </select>
                    <div style="width: 1px; height: 24px; background: rgba(0, 0, 0, 0.1); flex-shrink: 0;"></div>
                    <label style="font-weight: 600; font-size: 14px; color: var(--sf-label); flex-shrink: 0;">Âú®Â∫´:</label>
                    <select id="prizeMasterFilter" onchange="updatePrizeMasterList()" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; cursor: pointer; min-width: 140px; height: 38px;">
                        <option value="all">„Åô„Åπ„Å¶</option>
                        <option value="inStock">Âú®Â∫´„ÅÇ„Çä</option>
                        <option value="outOfStock">Âú®Â∫´„Å™„Åó</option>
                    </select>
                    <label style="font-weight: 600; font-size: 14px; color: var(--sf-label); flex-shrink: 0;">Á®ÆÈ°û:</label>
                    <select id="prizeMasterTypeFilter" onchange="updatePrizeMasterList()" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; cursor: pointer; min-width: 120px; height: 38px;">
                        <option value="all">„Åô„Åπ„Å¶</option>
                        <option value="PSA10">PSA10</option>
                        <option value="ÁæéÂìÅ">ÁæéÂìÅ</option>
                        <option value="„Éë„ÉÉ„ÇØ">„Éë„ÉÉ„ÇØ</option>
                        <option value="„Éú„ÉÉ„ÇØ„Çπ">„Éú„ÉÉ„ÇØ„Çπ</option>
                        <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                    </select>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; padding: 6px 12px; background: rgba(255, 192, 203, 0.2); border-radius: var(--radius-md); border: 2px solid rgba(255, 105, 180, 0.4);">
                        <input type="checkbox" id="prizeMasterWantedFilter" onchange="updatePrizeMasterList()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; font-size: 14px; color: #ff1493;">‚ù§Ô∏è Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„É™„Çπ„Éà</span>
                    </label>
                    <div style="width: 1px; height: 24px; background: rgba(0, 0, 0, 0.1); flex-shrink: 0;"></div>
                    <label style="font-weight: 600; font-size: 14px; color: var(--sf-label); flex-shrink: 0;">Ë≤©Â£≤Áä∂Ê≥Å:</label>
                    <select id="prizeMasterSalesFilter" onchange="updatePrizeMasterList()" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; height: 38px; cursor: pointer;">
                        <option value="all">„Åô„Åπ„Å¶</option>
                        <option value="inSale">„Ç™„É™„Éë„ÅßË≤©Â£≤‰∏≠</option>
                        <option value="notInSale">Êú™Ë≤©Â£≤</option>
                    </select>
                    <div style="width: 1px; height: 24px; background: rgba(0, 0, 0, 0.1); flex-shrink: 0;"></div>
                    <label style="font-weight: 600; font-size: 14px; color: var(--sf-label); flex-shrink: 0;">Ê§úÁ¥¢:</label>
                    <input type="text" id="prizeMasterSearchText" oninput="updatePrizeMasterList()" placeholder="ÊôØÂìÅÂêç„ÅßÊ§úÁ¥¢..." style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; min-width: 200px; height: 38px;">
                </div>

                <!-- ÈáëÈ°çÁØÑÂõ≤„Éï„Ç£„É´„Çø„Éº -->
                <div style="margin-bottom: 16px; padding: 16px; background: rgba(0, 122, 255, 0.03); border-radius: var(--radius-lg); border: 1px solid rgba(0, 122, 255, 0.15);">
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
                        <!-- ‰ªïÂÖ•„Çå‰æ°Ê†ºÁØÑÂõ≤ -->
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label style="font-weight: 600; font-size: 14px; color: var(--sf-blue); flex-shrink: 0;">‰ªïÂÖ•„Çå‰æ°Ê†º:</label>
                            <input type="number" id="prizeMasterMinPurchasePrice" oninput="updatePrizeMasterList()" placeholder="ÊúÄÂ∞è" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.3); background: white; font-size: 14px; width: 120px; height: 38px;">
                            <span style="color: var(--sf-gray);">„Äú</span>
                            <input type="number" id="prizeMasterMaxPurchasePrice" oninput="updatePrizeMasterList()" placeholder="ÊúÄÂ§ß" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.3); background: white; font-size: 14px; width: 120px; height: 38px;">
                            <span style="font-size: 14px; color: var(--sf-gray);">ÂÜÜ</span>
                        </div>

                        <div style="width: 1px; height: 24px; background: rgba(0, 122, 255, 0.2); flex-shrink: 0;"></div>

                        <!-- „Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§ÁØÑÂõ≤ -->
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label style="font-weight: 600; font-size: 14px; color: var(--sf-blue); flex-shrink: 0;">ÈÇÑÂÖÉ‰æ°ÂÄ§:</label>
                            <input type="number" id="prizeMasterMinRewardValue" oninput="updatePrizeMasterList()" placeholder="ÊúÄÂ∞è" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.3); background: white; font-size: 14px; width: 120px; height: 38px;">
                            <span style="color: var(--sf-gray);">„Äú</span>
                            <input type="number" id="prizeMasterMaxRewardValue" oninput="updatePrizeMasterList()" placeholder="ÊúÄÂ§ß" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.3); background: white; font-size: 14px; width: 120px; height: 38px;">
                            <span style="font-size: 14px; color: var(--sf-gray);">ÂÜÜ</span>
                        </div>

                        <!-- „ÇØ„É™„Ç¢„Éú„Çø„É≥ -->
                        <button class="btn btn-primary" onclick="clearPriceRangeFilters('master')" style="padding: 8px 16px; font-size: 13px; height: 38px;">
                            üîÑ ÁØÑÂõ≤„ÇØ„É™„Ç¢
                        </button>
                    </div>
                </div>

                <div id="prizeMasterList" class="prize-master-list">
                    <!-- ÊôØÂìÅ‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                </div>
            </div>
        </div>
        <!-- /ÊôØÂìÅ‰∏ÄË¶ß„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->

        <!-- Âú®Â∫´Ë™øÊï¥„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div id="tab-inventory-adjustment" class="tab-content">
            <h2 style="color: var(--sf-blue); border-bottom: 2px solid var(--sf-blue); padding-bottom: 12px; margin-bottom: 20px;">
                üì¶ Âú®Â∫´Ë™øÊï¥
            </h2>

            <!-- „Çµ„Éñ„Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); padding-bottom: 12px;">
                <button class="inv-subtab-btn active" onclick="switchInventorySubTab('decrease', this)" style="padding: 10px 20px; border: none; background: var(--sf-blue); color: white; border-radius: var(--radius-md); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    üì§ Âú®Â∫´Ê∏õÂ∞ë
                </button>
                <button class="inv-subtab-btn" onclick="switchInventorySubTab('register', this)" style="padding: 10px 20px; border: none; background: rgba(0, 0, 0, 0.05); color: var(--sf-gray); border-radius: var(--radius-md); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    üì• Âú®Â∫´ÁôªÈå≤
                </button>
                <button class="inv-subtab-btn" onclick="switchInventorySubTab('history', this)" style="padding: 10px 20px; border: none; background: rgba(0, 0, 0, 0.05); color: var(--sf-gray); border-radius: var(--radius-md); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    üìä Âú®Â∫´Â¢óÊ∏õÁ¢∫Ë™ç
                </button>
            </div>

            <!-- ========== Âú®Â∫´Ê∏õÂ∞ë„Çª„ÇØ„Ç∑„Éß„É≥ ========== -->
            <div id="inv-subtab-decrease" class="inv-subtab-content">
                <!-- CSV„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--sf-black);">
                        üìÑ Ê≥®Êñá‰∏ÄË¶ßCSV„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                    </h3>
                    <p style="font-size: 13px; color: var(--sf-gray); margin-bottom: 16px;">
                        Fortune Cookie„ÅÆÊ≥®Êñá‰∏ÄË¶ßCSV„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„ÄÅÁô∫ÈÄÅÊ∏à„Åø„ÉªÁô∫ÈÄÅÂæÖ„Å°„ÅÆÊôØÂìÅ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ<br>
                        <span style="color: var(--sf-orange);">‚Äª „Ç≥„Ç§„É≥„ÄÅ„ÉÅ„Ç±„ÉÉ„Éà„ÄÅ„Éó„É¨„Çº„É≥„Éà„ÅØËá™ÂãïÁöÑ„Å´Èô§Â§ñ„Åï„Çå„Åæ„Åô</span>
                    </p>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <input type="file" id="shippingCsvInput" accept=".csv" onchange="loadShippingCsv(event)" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('shippingCsvInput').click()" style="padding: 12px 24px; background: var(--sf-orange);">
                            üìÇ CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû
                        </button>
                        <span id="shippingCsvFileName" style="font-size: 14px; color: var(--sf-gray);"></span>
                    </div>
                    <div id="shippingCsvStatus" style="margin-top: 12px; font-size: 14px;"></div>
                </div>

                <!-- „Çπ„ÉÜ„ÉÉ„Éó1: Ê≥®ÊñáÈÅ∏Êäû -->
                <div id="orderSelectionStep" style="display: none; background: white; padding: 20px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                        <h3 style="font-size: 16px; font-weight: 700; color: var(--sf-black); margin: 0;">
                            üìã „Çπ„ÉÜ„ÉÉ„Éó1: Âèñ„ÇäËæº„ÇÄÊ≥®Êñá„ÇíÈÅ∏Êäû
                        </h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span id="orderSelectedCount" style="font-size: 13px; color: var(--sf-blue); font-weight: 600;"></span>
                            <button onclick="selectAllOrders()" style="padding: 6px 12px; background: var(--sf-blue); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                ‚úì ÂÖ®ÈÅ∏Êäû
                            </button>
                            <button onclick="deselectAllOrders()" style="padding: 6px 12px; background: rgba(0,0,0,0.1); color: var(--sf-gray); border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                ‚úó ÂÖ®Ëß£Èô§
                            </button>
                        </div>
                    </div>
                    <p style="font-size: 13px; color: var(--sf-gray); margin-bottom: 16px;">
                        üí° Êó¢„Å´Âá¶ÁêÜÊ∏à„Åø„ÅÆÊ≥®Êñá„ÅØ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÈÅ∏Êäû„Åó„ÅüÊ≥®Êñá„ÅÆ„Åø„ÅåÂú®Â∫´Ê∏õÂ∞ë„ÅÆÂØæË±°„Å´„Å™„Çä„Åæ„Åô„ÄÇ
                    </p>
                    <div id="orderSelectionContainer" style="display: grid; gap: 8px; max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
                        <!-- Ê≥®Êñá„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                    <div style="display: flex; gap: 12px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 16px;">
                        <button class="btn btn-primary" onclick="confirmOrderSelection()" style="padding: 12px 24px;">
                            ‚úÖ ÈÅ∏Êäû„Åó„ÅüÊ≥®Êñá„ÇíÂèñ„ÇäËæº„ÇÄ
                        </button>
                        <button class="btn" onclick="resetOrderSelection()" style="padding: 12px 24px;">
                            üîÑ „É™„Çª„ÉÉ„Éà
                        </button>
                    </div>
                </div>

                <!-- „Çπ„ÉÜ„ÉÉ„Éó2: Ë™≠„ÅøËæº„ÅøÁµêÊûú„Çµ„Éû„É™„Éº -->
                <div id="shippingCsvSummary" style="display: none; background: white; padding: 20px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--sf-black);">
                        üìä „Çπ„ÉÜ„ÉÉ„Éó2: ÈÅ∏Êäû„Åó„ÅüÊ≥®Êñá„ÅÆÊôØÂìÅ‰∏ÄË¶ß
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        <div style="background: rgba(52, 199, 89, 0.1); padding: 16px; border-radius: var(--radius-md);">
                            <div style="font-size: 12px; color: var(--sf-green); margin-bottom: 4px;">Áô∫ÈÄÅÊ∏à„ÅøÔºà„Ç´„Éº„ÉâÁ≠âÔºâ</div>
                            <div id="csvSummaryShipped" style="font-size: 24px; font-weight: 700; color: var(--sf-black);">0 ‰ª∂</div>
                        </div>
                        <div style="background: rgba(255, 149, 0, 0.1); padding: 16px; border-radius: var(--radius-md);">
                            <div style="font-size: 12px; color: var(--sf-orange); margin-bottom: 4px;">Êú™Áô∫ÈÄÅ</div>
                            <div id="csvSummaryPending" style="font-size: 24px; font-weight: 700; color: var(--sf-black);">0 ‰ª∂</div>
                        </div>
                        <div style="background: rgba(175, 82, 222, 0.1); padding: 16px; border-radius: var(--radius-md); cursor: pointer;" onclick="openRandomPackModal()">
                            <div style="font-size: 12px; color: var(--sf-purple); margin-bottom: 4px;">„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ üì¶</div>
                            <div id="csvSummaryRandomPack" style="font-size: 24px; font-weight: 700; color: var(--sf-black);">0 Êûö</div>
                            <div style="font-size: 11px; color: var(--sf-purple); margin-top: 4px;">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Âú®Â∫´Ë™øÊï¥</div>
                        </div>
                    </div>

                    <!-- „Éû„ÉÉ„ÉÅ„É≥„Ç∞Áä∂Ê≥Å -->
                    <div id="matchingStatus" style="margin-top: 16px; padding: 12px; background: rgba(255, 149, 0, 0.05); border-radius: var(--radius-md); display: none;">
                        <div style="font-size: 13px; color: var(--sf-orange); font-weight: 600; margin-bottom: 8px;">
                            ‚ö†Ô∏è „Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åß„Åç„Å™„Åã„Å£„ÅüÊôØÂìÅ„Åå„ÅÇ„Çä„Åæ„Åô
                        </div>
                        <div id="unmatchedItemsList" style="font-size: 12px; color: var(--sf-gray); max-height: 100px; overflow-y: auto;"></div>
                        <button class="btn" onclick="openManualMatchModal()" style="margin-top: 8px; padding: 8px 16px; font-size: 12px;">
                            üîß ÊâãÂãï„Åß„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                        </button>
                    </div>

                    <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="confirmAndApplyShippedDecrease()" style="padding: 12px 24px;">
                            ‚úÖ Áô∫ÈÄÅÊ∏à„Åø„ÇíÂú®Â∫´„Åã„ÇâÊ∏õÂ∞ë
                        </button>
                        <button class="btn" onclick="openRandomPackModal()" style="padding: 12px 24px; background: var(--sf-purple); color: white;">
                            üì¶ „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØÂú®Â∫´Ë™øÊï¥
                        </button>
                        <button class="btn" onclick="backToOrderSelection()" style="padding: 12px 24px;">
                            ‚Üê Ê≥®ÊñáÈÅ∏Êäû„Å´Êàª„Çã
                        </button>
                    </div>
                </div>

                <!-- Áô∫ÈÄÅÊ∏à„Åø‰∏ÄË¶ßÔºàÊôØÂìÅ„Ç∞„É´„Éº„ÉóÔºâ -->
                <div id="shippedOrdersList" style="display: none; margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 700; color: var(--sf-black); display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        ‚úÖ Áô∫ÈÄÅÊ∏à„ÅøÊôØÂìÅÔºà„Ç∞„É´„Éº„ÉóÔºâ
                        <span id="shippedOrdersCount" style="font-size: 12px; font-weight: 500; color: var(--sf-gray);"></span>
                    </h3>
                    <div id="shippedOrdersContainer" style="display: grid; gap: 12px; max-height: 400px; overflow-y: auto;">
                        <!-- Áô∫ÈÄÅÊ∏à„ÅøÊôØÂìÅ„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                    </div>
                </div>

                <!-- Êú™Áô∫ÈÄÅ‰∏ÄË¶ß -->
                <div id="pendingOrdersList" style="display: none;">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--sf-black); display: flex; align-items: center; gap: 8px;">
                        üì¶ Êú™Áô∫ÈÄÅÊ≥®Êñá
                        <span id="pendingOrdersCount" style="font-size: 12px; font-weight: 500; color: var(--sf-gray);"></span>
                    </h3>
                    <div id="pendingOrdersContainer" style="display: grid; gap: 12px; max-height: 400px; overflow-y: auto;">
                        <!-- Êú™Áô∫ÈÄÅÊ≥®Êñá„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                    </div>
                </div>
            </div>

            <!-- ========== Âú®Â∫´ÁôªÈå≤„Çª„ÇØ„Ç∑„Éß„É≥ ========== -->
            <div id="inv-subtab-register" class="inv-subtab-content" style="display: none;">
                <!-- Ë¶ÅÂÖ•Ëç∑„É™„Çπ„ÉàÔºàÊú™Áô∫ÈÄÅ„ÅßÂú®Â∫´0„ÅÆ„ÇÇ„ÅÆÔºâ -->
                <div id="needRestockSection" style="margin-bottom: 24px; display: none;">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--sf-red); display: flex; align-items: center; gap: 8px;">
                        üö® Ë¶ÅÂÖ•Ëç∑„É™„Çπ„Éà
                        <span id="needRestockCount" style="font-size: 12px; font-weight: 500; color: var(--sf-red);">(0‰ª∂)</span>
                    </h3>
                    <p style="font-size: 13px; color: var(--sf-gray); margin-bottom: 12px;">
                        Êú™Áô∫ÈÄÅÊ≥®Êñá„Åå„ÅÇ„ÇäÂú®Â∫´„Åå0„ÅÆÊôØÂìÅ„Åß„Åô„ÄÇÂÖ•Ëç∑„Åó„Åü„Çâ„Åô„Åê„Å´ÁôªÈå≤„Åß„Åç„Åæ„Åô„ÄÇ
                    </p>
                    <div id="needRestockContainer" style="display: grid; gap: 8px; max-height: 400px; overflow-y: auto;">
                        <!-- Ë¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>

                <!-- ÊôØÂìÅÊ§úÁ¥¢„ÉªÈÅ∏Êäû -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--sf-black);">
                        üì• Âú®Â∫´„ÇíÁôªÈå≤ÔºàÂÖ•Â∫´Ôºâ
                    </h3>
                    <p style="font-size: 13px; color: var(--sf-gray); margin-bottom: 16px;">
                        ÂÖ•Â∫´„Åó„ÅüÊôØÂìÅ„ÇíÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÈÅ∏Êäû„Åó„Å¶Âú®Â∫´„ÇíÂ¢óÂä†„Åï„Åõ„Åæ„Åô„ÄÇ
                    </p>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 16px;">
                        <input type="text" id="registerPrizeSearch" oninput="searchPrizesForRegister()" placeholder="ÊôØÂìÅÂêç„ÅßÊ§úÁ¥¢..." style="flex: 1; min-width: 250px; padding: 12px 16px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: rgba(0,0,0,0.03); font-size: 14px;">
                    </div>
                    <!-- Ê§úÁ¥¢ÁµêÊûú -->
                    <div id="registerPrizeResults" style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.02); border-radius: var(--radius-md); border: 1px solid rgba(0,0,0,0.05); display: none;">
                        <!-- Ê§úÁ¥¢ÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>

            </div>

            <!-- ========== Âú®Â∫´Â¢óÊ∏õÁ¢∫Ë™ç„Çª„ÇØ„Ç∑„Éß„É≥ ========== -->
            <div id="inv-subtab-history" class="inv-subtab-content" style="display: none;">
                <!-- Êó•‰ªòÈÅ∏Êäû -->
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                        <label style="font-weight: 600; font-size: 14px; color: var(--sf-label);">Êó•‰ªò„ÇíÈÅ∏Êäû:</label>
                        <input type="date" id="historyDatePicker" onchange="loadInventoryHistory()" style="padding: 10px 16px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: rgba(0,0,0,0.03); font-size: 14px;">
                        <button class="btn" onclick="setHistoryDateToday()" style="padding: 10px 16px;">‰ªäÊó•</button>
                        <button class="btn" onclick="setHistoryDateYesterday()" style="padding: 10px 16px;">Êò®Êó•</button>
                    </div>
                </div>

                <!-- Êó•Âà•„Çµ„Éû„É™„Éº -->
                <div id="historyDaySummary" style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                        <h3 style="font-size: 16px; font-weight: 700; color: var(--sf-black); margin: 0;">
                            üìä <span id="historyDateLabel">-</span> „ÅÆÂú®Â∫´Â¢óÊ∏õ
                        </h3>
                        <button id="resetDayButton" onclick="confirmResetDayChanges()" style="padding: 12px 24px; background: #ff3b30; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; display: none;">
                            üîÑ „Åì„ÅÆÊó•„ÅÆÂ§âÂãï„Çí„É™„Çª„ÉÉ„Éà
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        <div style="background: rgba(255, 59, 48, 0.1); padding: 16px; border-radius: var(--radius-md);">
                            <div style="font-size: 12px; color: var(--sf-red); margin-bottom: 4px;">Âá∫Â∫´ÔºàÊ∏õÂ∞ëÔºâ</div>
                            <div id="historyTotalDecrease" style="font-size: 24px; font-weight: 700; color: var(--sf-black);">0 ÁÇπ</div>
                        </div>
                        <div style="background: rgba(52, 199, 89, 0.1); padding: 16px; border-radius: var(--radius-md);">
                            <div style="font-size: 12px; color: var(--sf-green); margin-bottom: 4px;">ÂÖ•Â∫´ÔºàÂ¢óÂä†Ôºâ</div>
                            <div id="historyTotalIncrease" style="font-size: 24px; font-weight: 700; color: var(--sf-black);">0 ÁÇπ</div>
                        </div>
                        <div style="background: rgba(0, 122, 255, 0.1); padding: 16px; border-radius: var(--radius-md);">
                            <div style="font-size: 12px; color: var(--sf-blue); margin-bottom: 4px;">Â∑ÆÂºï</div>
                            <div id="historyNetChange" style="font-size: 24px; font-weight: 700; color: var(--sf-black);">0 ÁÇπ</div>
                        </div>
                    </div>
                </div>

                <!-- Â±•Ê≠¥‰∏ÄË¶ß -->
                <div>
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--sf-black);">
                        üìú Ë©≥Á¥∞Â±•Ê≠¥
                    </h3>
                    <div id="historyListContainer" style="max-height: 500px; overflow-y: auto;">
                        <p style="color: var(--sf-gray); text-align: center; padding: 40px 0;">
                            Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Âú®Â∫´Ë™øÊï¥„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    </div>
    <!-- /container -->

    <!-- „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="randomPackModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: var(--radius-lg); padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-2xl);">
            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--sf-black);">
                üéÅ „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅÆÂÜÖÂÆπ„ÇíÈÅ∏Êäû
            </h3>
            <p style="font-size: 13px; color: var(--sf-gray); margin-bottom: 8px;">
                ÂÆüÈöõ„Å´Áô∫ÈÄÅ„Åó„Åü„Éë„ÉÉ„ÇØ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà<span id="randomPackCount">0</span>ÊûöÔºâ
            </p>
            <p id="randomPackStockInfo" style="font-size: 12px; color: var(--sf-orange); margin-bottom: 16px; display: none;">
                ‚ö†Ô∏è ÈÅ∏ÊäûÂèØËÉΩ„Å™Âú®Â∫´: <span id="randomPackTotalStock">0</span>Êûö
            </p>
            <div id="randomPackPrizeList" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
                <!-- „Éë„ÉÉ„ÇØ‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn" onclick="closeRandomPackModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-primary" onclick="confirmRandomPackSelection()">Á¢∫ÂÆö</button>
            </div>
        </div>
    </div>

    <!-- ÊâãÂãï„Éû„ÉÉ„ÉÅ„É≥„Ç∞„É¢„Éº„ÉÄ„É´ -->
    <div id="manualMatchModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: var(--radius-lg); padding: 24px; max-width: 1000px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: var(--shadow-2xl); display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                    <h3 style="font-size: 18px; font-weight: 700; color: var(--sf-black); margin: 0;">
                        üîß ÊâãÂãï„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                    </h3>
                    <p style="font-size: 13px; color: var(--sf-gray); margin: 4px 0 0 0;">
                        Â∑¶„ÅÆCSVÊôØÂìÅ„ÇíÈÅ∏Êäû„Åó„ÄÅÂè≥„ÅÆ„É™„Çπ„Éà„Åã„ÇâÂØæÂøú„Åô„ÇãÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ
                    </p>
                </div>
                <button onclick="closeManualMatchModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--sf-gray);">&times;</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 16px; flex: 1; overflow: hidden; min-height: 0;">
                <!-- Â∑¶: „Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åß„Åç„Å™„Åã„Å£„ÅüÊôØÂìÅ -->
                <div style="display: flex; flex-direction: column; overflow: hidden;">
                    <div style="font-weight: 600; font-size: 14px; color: var(--sf-orange); margin-bottom: 8px;">
                        ‚ö†Ô∏è „Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åß„Åç„Å™„Åã„Å£„ÅüÊôØÂìÅ
                    </div>
                    <div id="manualMatchList" style="flex: 1; overflow-y: auto; border: 1px solid rgba(0,0,0,0.1); border-radius: var(--radius-md); background: rgba(255, 149, 0, 0.02);">
                        <!-- „Éû„ÉÉ„ÉÅ„É≥„Ç∞‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>

                <!-- Âè≥: ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÈÅ∏Êäû -->
                <div style="display: flex; flex-direction: column; overflow: hidden;">
                    <div style="font-weight: 600; font-size: 14px; color: var(--sf-blue); margin-bottom: 8px;">
                        üìã ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÈÅ∏Êäû
                    </div>
                    <!-- Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ -->
                    <div style="margin-bottom: 8px;">
                        <input type="text" id="manualMatchSearchText" oninput="updateManualMatchPrizeList()" placeholder="ÊôØÂìÅÂêç„ÅßÊ§úÁ¥¢..." style="width: 100%; padding: 10px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.15); background: white; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <!-- „Éï„Ç£„É´„Çø„Éº -->
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                        <select id="manualMatchTypeFilter" onchange="updateManualMatchPrizeList()" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 12px;">
                            <option value="all">„Åô„Åπ„Å¶</option>
                            <option value="PSA10">PSA10</option>
                            <option value="ÁæéÂìÅ">ÁæéÂìÅ</option>
                            <option value="„Éë„ÉÉ„ÇØ">„Éë„ÉÉ„ÇØ</option>
                            <option value="„Éú„ÉÉ„ÇØ„Çπ">„Éú„ÉÉ„ÇØ„Çπ</option>
                        </select>
                        <select id="manualMatchStockFilter" onchange="updateManualMatchPrizeList()" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 12px;">
                            <option value="all">Âú®Â∫´„Åô„Åπ„Å¶</option>
                            <option value="inStock">Âú®Â∫´„ÅÇ„Çä</option>
                        </select>
                    </div>
                    <!-- ÊôØÂìÅ„É™„Çπ„Éà -->
                    <div id="manualMatchPrizeList" style="flex: 1; overflow-y: auto; border: 1px solid rgba(0,0,0,0.1); border-radius: var(--radius-md); background: rgba(0, 122, 255, 0.02);">
                        <!-- ÊôØÂìÅ‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.1);">
                <button class="btn" onclick="closeManualMatchModal()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <!-- „Ç´„Çπ„Çø„É†„Ç¢„É©„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
    <div id="customAlertModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); animation: slideIn 0.2s ease-out;">
            <div id="customAlertIcon" style="font-size: 48px; text-align: center; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <div id="customAlertTitle" style="font-size: 18px; font-weight: 700; color: rgba(0, 0, 0, 0.9); margin-bottom: 12px; text-align: center;"></div>
            <div id="customAlertMessage" style="font-size: 14px; color: rgba(0, 0, 0, 0.7); line-height: 1.6; white-space: pre-wrap; margin-bottom: 20px;"></div>
            <button onclick="closeCustomAlert()" style="width: 100%; padding: 12px; background: var(--sf-blue); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                OK
            </button>
        </div>
    </div>

    <!-- ÈáçË§áÊ≥®ÊñáIDË≠¶Âëä„É¢„Éº„ÉÄ„É´ -->
    <div id="duplicateOrderModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: var(--radius-lg); padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-2xl);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="font-size: 18px; font-weight: 700; color: var(--sf-orange); margin: 0;">
                    ‚ö†Ô∏è ÈáçË§á„Åô„ÇãÊ≥®ÊñáID„Åå„ÅÇ„Çä„Åæ„Åô
                </h3>
                <button onclick="closeDuplicateOrderModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--sf-gray);">&times;</button>
            </div>

            <div style="background: rgba(255, 149, 0, 0.1); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 13px; color: var(--sf-gray); margin-bottom: 8px;">‰ª•‰∏ã„ÅÆÊ≥®ÊñáID„ÅØÊó¢„Å´Êú™Áô∫ÈÄÅ„É™„Çπ„Éà„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô:</div>
                <div id="duplicateOrderIds" style="font-size: 14px; color: var(--sf-black); font-weight: 600; max-height: 150px; overflow-y: auto;"></div>
            </div>

            <p style="font-size: 13px; color: var(--sf-gray); margin-bottom: 20px;">
                „Åì„Çå„Çâ„ÅÆÊ≥®Êñá„Çí„Å©„ÅÆ„Çà„ÅÜ„Å´Âá¶ÁêÜ„Åó„Åæ„Åô„ÅãÔºü
            </p>

            <div style="display: grid; gap: 12px;">
                <button onclick="handleDuplicateOrders('overwrite')" style="width: 100%; padding: 14px; background: var(--sf-orange); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    üîÑ ‰∏äÊõ∏„Åç„Åô„ÇãÔºàÊó¢Â≠ò„ÇíÂâäÈô§„Åó„Å¶Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÅßÁΩÆÊèõÔºâ
                </button>
                <button onclick="handleDuplicateOrders('exclude')" style="width: 100%; padding: 14px; background: var(--sf-blue); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    ‚è≠Ô∏è Èô§Â§ñ„Åô„ÇãÔºàÈáçË§áID„ÅØ„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶Êñ∞Ë¶è„ÅÆ„ÅøÂèñ„ÇäËæº„ÇÄÔºâ
                </button>
                <button onclick="closeDuplicateOrderModal()" style="width: 100%; padding: 14px; background: rgba(0,0,0,0.1); color: var(--sf-gray); border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
            </div>
        </div>
    </div>

    <!-- Êú™ÁôªÈå≤ÊôØÂìÅÂá¶ÁêÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="unregisteredPrizeModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: var(--radius-lg); padding: 24px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-2xl);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="font-size: 18px; font-weight: 700; color: var(--sf-black); margin: 0;">
                    ‚ö†Ô∏è ÊôØÂìÅ„Éû„Çπ„Çø„ÉºÊú™ÁôªÈå≤
                </h3>
                <button onclick="closeUnregisteredPrizeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--sf-gray);">&times;</button>
            </div>

            <div style="background: rgba(255, 149, 0, 0.1); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: var(--sf-orange); font-size: 14px;">ÂØæË±°„ÅÆÊôØÂìÅÂêç:</div>
                <div id="unregPrizeName" style="font-size: 15px; color: var(--sf-black); margin-top: 4px; word-break: break-all;"></div>
                <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;">ÂøÖË¶ÅÊï∞Èáè: <span id="unregNeededQty">0</span>ÂÄã</div>
            </div>

            <p style="font-size: 13px; color: var(--sf-gray); margin-bottom: 16px;">
                „Åì„ÅÆÊôØÂìÅ„ÅØÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ‰ª•‰∏ã„Åã„ÇâÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
            </p>

            <!-- „Çø„ÉñÂàá„ÇäÊõø„Åà -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button id="unregTabNew" onclick="switchUnregTab('new')" style="flex: 1; padding: 10px; border: 2px solid var(--sf-blue); background: var(--sf-blue); color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    üìù Êñ∞Ë¶èÁôªÈå≤
                </button>
                <button id="unregTabExisting" onclick="switchUnregTab('existing')" style="flex: 1; padding: 10px; border: 2px solid var(--sf-blue); background: white; color: var(--sf-blue); border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    üîó Êó¢Â≠ò„Åã„ÇâÂèÇÁÖß
                </button>
            </div>

            <!-- Êñ∞Ë¶èÁôªÈå≤„Çø„Éñ -->
            <div id="unregContentNew" style="display: block;">
                <div style="background: rgba(0,0,0,0.02); border-radius: 8px; padding: 16px;">
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 12px; font-weight: 600; color: var(--sf-gray); margin-bottom: 4px;">ÊôØÂìÅÂêç</label>
                        <input type="text" id="unregNewName" style="width: 100%; padding: 10px; border: 1px solid rgba(0,0,0,0.15); border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--sf-gray); margin-bottom: 4px;">Á®ÆÈ°û</label>
                            <select id="unregNewType" style="width: 100%; padding: 10px; border: 1px solid rgba(0,0,0,0.15); border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                                <option value="PSA10">PSA10</option>
                                <option value="ÁæéÂìÅ">ÁæéÂìÅ</option>
                                <option value="„Éë„ÉÉ„ÇØ">„Éë„ÉÉ„ÇØ</option>
                                <option value="„Éú„ÉÉ„ÇØ„Çπ">„Éú„ÉÉ„ÇØ„Çπ</option>
                                <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--sf-gray); margin-bottom: 4px;">ÁîªÂÉèURLÔºà‰ªªÊÑèÔºâ</label>
                            <input type="text" id="unregNewImage" placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid rgba(0,0,0,0.15); border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                        </div>
                    </div>
                    <button onclick="registerNewPrizeFromModal()" style="width: 100%; padding: 12px; background: var(--sf-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                        üìù ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ÁôªÈå≤
                    </button>
                    <p style="font-size: 11px; color: var(--sf-gray); margin-top: 8px; text-align: center;">
                        ‚Äª Âú®Â∫´„ÅÆÂÖ•Â∫´„ÅØË¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„Åã„ÇâË°å„Åà„Åæ„Åô
                    </p>
                </div>
            </div>

            <!-- Êó¢Â≠ò„Åã„ÇâÂèÇÁÖß„Çø„Éñ -->
            <div id="unregContentExisting" style="display: none;">
                <div style="margin-bottom: 12px;">
                    <input type="text" id="unregSearchExisting" oninput="searchExistingPrizesForUnreg()" placeholder="ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÊ§úÁ¥¢..." style="width: 100%; padding: 10px 12px; border: 1px solid rgba(0,0,0,0.15); border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                </div>
                <div id="unregExistingList" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px;">
                    <!-- Ê§úÁ¥¢ÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                </div>
                <p style="font-size: 11px; color: var(--sf-gray); margin-top: 8px; text-align: center;">
                    ‚Äª ÈÅ∏Êäû„Åô„Çã„Å®Êú™Áô∫ÈÄÅ„Å®Á¥ê‰ªò„Åë„Åæ„ÅôÔºàÂú®Â∫´„ÅØÂ§â„Çè„Çä„Åæ„Åõ„ÇìÔºâ
                </p>
            </div>
        </div>
    </div>

    <!-- ÊôØÂìÅÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="editPrizeModal" class="edit-modal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title">ÊôØÂìÅ„ÇíÁ∑®ÈõÜ</h3>
                <button class="edit-modal-close" onclick="closeEditPrizeModal()">&times;</button>
            </div>
            <div class="edit-modal-body">
                <div class="form-group">
                    <label>ÊôØÂìÅÂêç</label>
                    <input type="text" id="editPrizeName" placeholder="‰æã: „É¨„Ç¢„Ç´„Éº„Éâ">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>‰ªïÂÖ•„Çå‰æ°Ê†º</label>
                        <input type="text" id="editPrizePurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this)">
                    </div>
                    <div class="form-group">
                        <label>„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§</label>
                        <input type="text" id="editPrizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                    </div>
                </div>
                <div class="form-group">
                    <label>Âú®Â∫´Êï∞</label>
                    <input type="number" id="editPrizeCount" min="0" value="1">
                </div>
                <div class="form-group">
                    <label>ÊôØÂìÅÁ®ÆÈ°û</label>
                    <select id="editPrizeType" style="padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                        <option value="PSA10">PSA10</option>
                        <option value="ÁæéÂìÅ">ÁæéÂìÅ</option>
                        <option value="„Éë„ÉÉ„ÇØ">„Éë„ÉÉ„ÇØ</option>
                        <option value="„Éú„ÉÉ„ÇØ„Çπ">„Éú„ÉÉ„ÇØ„Çπ</option>
                        <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="editPrizeIsWanted" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>‚ù§Ô∏è Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„É™„Çπ„Éà„Å´ËøΩÂä†</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>ÊôØÂìÅÁîªÂÉèURLÔºà‰ªªÊÑèÔºâ</label>
                    <input type="text" id="editPrizeImageUrl" placeholder="https://example.com/image.jpg" oninput="previewImageFromUrl(this.value, 'editPrizeImagePreviewImg', 'editPrizeImagePreview')">
                    <div id="editPrizeImagePreview" style="margin-top: 12px; display: none;">
                        <img id="editPrizeImagePreviewImg" style="max-width: 200px; max-height: 200px; border-radius: var(--radius-md); border: 2px solid rgba(0, 0, 0, 0.1);" onerror="this.style.border='2px solid red';">
                        <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;">„Éó„É¨„Éì„É•„Éº</div>
                    </div>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="btn btn-danger" onclick="closeEditPrizeModal()" style="flex: 1;">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-primary" onclick="saveEditedPrize()" style="flex: 1;">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- Âú®Â∫´Ë™øÊï¥„É¢„Éº„ÉÄ„É´ -->
    <!-- ÊôØÂìÅ„Éû„Çπ„Çø„ÉºÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="selectPrizeMasterModal" class="edit-modal">
        <div class="edit-modal-content" style="max-width: 900px;">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title">ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÈÅ∏Êäû</h3>
                <button class="edit-modal-close" onclick="closeSelectPrizeMasterModal()">&times;</button>
            </div>
            <div class="edit-modal-body" style="max-height: 600px; overflow-y: auto; padding: 0;">
                <!-- „Éï„Ç£„É´„Çø„Éº„Éª‰∏¶„Å≥Êõø„Åà„ÉªÊ§úÁ¥¢„Ç®„É™„Ç¢ -->
                <div id="modalFilterArea" style="padding: 16px; background: rgba(0, 0, 0, 0.02); border-bottom: 1px solid rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 10;">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
                        <label style="font-weight: 600; font-size: 13px; color: var(--sf-label); flex-shrink: 0;">‰∏¶„Å≥Êõø„Åà:</label>
                        <select id="modalSortBy" onchange="updatePrizeMasterSelectList()" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 13px; cursor: pointer; min-width: 120px;">
                            <option value="price">‰ªïÂÖ•„Çå‰æ°Ê†ºÈ†Ü</option>
                            <option value="date">ÁôªÈå≤Êó•ÊôÇÈ†Ü</option>
                        </select>
                        <select id="modalSortOrder" onchange="updatePrizeMasterSelectList()" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 13px; cursor: pointer; min-width: 150px;">
                            <option value="desc">ÈôçÈ†ÜÔºàÈ´ò„ÅÑ/Êñ∞„Åó„ÅÑÈ†ÜÔºâ</option>
                            <option value="asc">ÊòáÈ†ÜÔºàÂÆâ„ÅÑ/Âè§„ÅÑÈ†ÜÔºâ</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <label style="font-weight: 600; font-size: 13px; color: var(--sf-label); flex-shrink: 0;">Âú®Â∫´:</label>
                        <select id="modalStockFilter" onchange="updatePrizeMasterSelectList()" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 13px; cursor: pointer; min-width: 120px;">
                            <option value="all">„Åô„Åπ„Å¶</option>
                            <option value="inStock">Âú®Â∫´„ÅÇ„Çä</option>
                            <option value="outOfStock">Âú®Â∫´„Å™„Åó</option>
                        </select>
                        <label style="font-weight: 600; font-size: 13px; color: var(--sf-label); flex-shrink: 0;">Á®ÆÈ°û:</label>
                        <select id="modalTypeFilter" onchange="updatePrizeMasterSelectList()" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 13px; cursor: pointer; min-width: 100px;">
                            <option value="all">„Åô„Åπ„Å¶</option>
                            <option value="PSA10">PSA10</option>
                            <option value="ÁæéÂìÅ">ÁæéÂìÅ</option>
                            <option value="„Éë„ÉÉ„ÇØ">„Éë„ÉÉ„ÇØ</option>
                            <option value="„Éú„ÉÉ„ÇØ„Çπ">„Éú„ÉÉ„ÇØ„Çπ</option>
                            <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                        </select>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; user-select: none; padding: 4px 8px; background: rgba(255, 192, 203, 0.2); border-radius: var(--radius-md); border: 1.5px solid rgba(255, 105, 180, 0.4);">
                            <input type="checkbox" id="modalWantedFilter" onchange="updatePrizeMasterSelectList()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-weight: 600; font-size: 13px; color: #ff1493;">‚ù§Ô∏è Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ</span>
                        </label>
                    </div>
                    <div style="margin-top: 12px;">
                        <input type="text" id="modalSearchText" oninput="updatePrizeMasterSelectList()" placeholder="ÊôØÂìÅÂêç„ÅßÊ§úÁ¥¢..." style="width: 100%; padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px;">
                    </div>

                    <!-- ÈáëÈ°çÁØÑÂõ≤„Éï„Ç£„É´„Çø„Éº -->
                    <div style="margin-top: 12px; padding: 12px; background: rgba(0, 122, 255, 0.05); border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.2);">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                            <!-- ‰ªïÂÖ•„Çå‰æ°Ê†ºÁØÑÂõ≤ -->
                            <div style="display: flex; gap: 6px; align-items: center;">
                                <label style="font-weight: 600; font-size: 13px; color: var(--sf-blue); flex-shrink: 0;">‰ªïÂÖ•„Çå‰æ°Ê†º:</label>
                                <input type="number" id="modalMinPurchasePrice" oninput="updatePrizeMasterSelectList()" placeholder="ÊúÄÂ∞è" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.3); background: white; font-size: 13px; width: 100px;">
                                <span style="color: var(--sf-gray); font-size: 13px;">„Äú</span>
                                <input type="number" id="modalMaxPurchasePrice" oninput="updatePrizeMasterSelectList()" placeholder="ÊúÄÂ§ß" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.3); background: white; font-size: 13px; width: 100px;">
                                <span style="font-size: 13px; color: var(--sf-gray);">ÂÜÜ</span>
                            </div>

                            <div style="width: 1px; height: 20px; background: rgba(0, 122, 255, 0.2); flex-shrink: 0;"></div>

                            <!-- „Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§ÁØÑÂõ≤ -->
                            <div style="display: flex; gap: 6px; align-items: center;">
                                <label style="font-weight: 600; font-size: 13px; color: var(--sf-blue); flex-shrink: 0;">ÈÇÑÂÖÉ‰æ°ÂÄ§:</label>
                                <input type="number" id="modalMinRewardValue" oninput="updatePrizeMasterSelectList()" placeholder="ÊúÄÂ∞è" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.3); background: white; font-size: 13px; width: 100px;">
                                <span style="color: var(--sf-gray); font-size: 13px;">„Äú</span>
                                <input type="number" id="modalMaxRewardValue" oninput="updatePrizeMasterSelectList()" placeholder="ÊúÄÂ§ß" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.3); background: white; font-size: 13px; width: 100px;">
                                <span style="font-size: 13px; color: var(--sf-gray);">ÂÜÜ</span>
                            </div>

                            <!-- „ÇØ„É™„Ç¢„Éú„Çø„É≥ -->
                            <button class="btn btn-primary" onclick="clearPriceRangeFilters('modal')" style="padding: 6px 12px; font-size: 12px;">
                                üîÑ ÁØÑÂõ≤„ÇØ„É™„Ç¢
                            </button>
                        </div>
                    </div>
                </div>
                <!-- ÊôØÂìÅ„É™„Çπ„Éà -->
                <div id="prizeMasterSelectList" style="padding: 16px;"></div>

                <!-- Êñ∞Ë¶èÁôªÈå≤„Éï„Ç©„Éº„É† -->
                <div id="modalNewPrizeForm" style="display: none; padding: 16px;">
                    <div style="background: rgba(0, 122, 255, 0.05); padding: 16px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.2); margin-bottom: 16px;">
                        <div style="font-size: 14px; color: var(--sf-blue); font-weight: 600; margin-bottom: 8px;">üí° Êñ∞Ë¶èÊôØÂìÅÁôªÈå≤</div>
                        <div style="font-size: 13px; color: var(--sf-gray); line-height: 1.6;">
                            „Åì„Åì„ÅßÁôªÈå≤„Åó„ÅüÊôØÂìÅ„ÅØÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´„ÇÇËøΩÂä†„Åï„Çå„ÄÅ‰ªñ„ÅÆ„Ç™„É™„Éë„Åß„ÇÇ‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ÊôØÂìÅÂêç *</label>
                        <input type="text" id="modalPrizeName" placeholder="‰æã: „É¨„Ç¢„Ç´„Éº„Éâ" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                    </div>

                    <div class="form-group">
                        <label>ÊôØÂìÅÁ®ÆÈ°û</label>
                        <select id="modalPrizeType" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                            <option value="PSA10">PSA10</option>
                            <option value="ÁæéÂìÅ">ÁæéÂìÅ</option>
                            <option value="„Éë„ÉÉ„ÇØ">„Éë„ÉÉ„ÇØ</option>
                            <option value="„Éú„ÉÉ„ÇØ„Çπ">„Éú„ÉÉ„ÇØ„Çπ</option>
                            <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>‰ªïÂÖ•„Çå‰æ°Ê†º *</label>
                        <input type="text" id="modalPurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this); updateModalRewardValueIfSame();" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                    </div>

                    <div class="form-group">
                        <label>„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§ *</label>
                        <input type="text" id="modalPrizeValue" placeholder="70,000" oninput="formatPrizeValue(this)" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                        <div style="margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                                <input type="checkbox" id="modalSamePriceAsReward" onchange="handleSamePriceAsRewardChange()" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 600; color: var(--sf-blue);">ÊôØÂìÅ‰æ°Ê†º„Å®ÂêåÈ°ç„Å´„Åô„Çã</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Âú®Â∫´Êï∞ *</label>
                        <input type="number" id="modalPrizeCount" min="0" value="0" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                    </div>

                    <div class="form-group">
                        <label>ÁîªÂÉèURL</label>
                        <input type="url" id="modalPrizeImage" placeholder="https://example.com/image.jpg" oninput="previewModalImage(this.value)" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                        <div id="modalImagePreview" style="margin-top: 12px; display: none;">
                            <img id="modalImagePreviewImg" style="width: 100px; height: 150px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1);">
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="modalPrizeWanted" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-weight: 600; color: #ff1493;">‚ù§Ô∏è Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„É™„Çπ„Éà„Å´ËøΩÂä†</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="edit-modal-footer" style="display: flex; gap: 12px;">
                <button class="btn btn-danger" id="modalCancelBtn" onclick="closeSelectPrizeMasterModal()" style="flex: 1;">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-success" id="modalNewPrizeBtn" onclick="showModalNewPrizeForm()" style="flex: 1;">‚ûï Êñ∞Ë¶èÁôªÈå≤</button>
                <button class="btn btn-danger" id="modalFormCancelBtn" onclick="hideModalNewPrizeForm()" style="flex: 1; display: none;">Êàª„Çã</button>
                <button class="btn btn-success" id="modalFormSaveBtn" onclick="saveModalNewPrize()" style="flex: 1; display: none;">ÊôØÂìÅ„ÇíÁôªÈå≤</button>
            </div>
        </div>
    </div>

    <!-- ÁîªÂÉèÊã°Â§ßË°®Á§∫„É¢„Éº„ÉÄ„É´ -->
    <div id="imageViewModal" class="edit-modal" onclick="closeImageViewModal()">
        <div class="edit-modal-content" style="max-width: 90vw; max-height: 90vh; background: rgba(0, 0, 0, 0.95); border: none;">
            <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                <button class="edit-modal-close" onclick="closeImageViewModal()" style="position: absolute; top: 10px; right: 10px; z-index: 10; background: rgba(255, 255, 255, 0.2); color: white; border: none; font-size: 32px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer;">&times;</button>
                <img id="imageViewImg" style="max-width: 100%; max-height: 85vh; object-fit: contain; border-radius: var(--radius-md);">
            </div>
        </div>
    </div>

    <!-- ÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
    <div id="deleteConfirmModal" class="edit-modal" style="display: none;">
        <div class="edit-modal-content" style="max-width: 500px;">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title">ÂâäÈô§Á¢∫Ë™ç</h3>
            </div>
            <div class="edit-modal-body">
                <p id="deleteConfirmMessage" style="font-size: 16px; line-height: 1.6; margin: 20px 0;"></p>
            </div>
            <div class="edit-modal-footer" style="display: flex; gap: 12px;">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal(false)" style="flex: 1;">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button" class="btn btn-danger" onclick="closeDeleteConfirmModal(true)" style="flex: 1;">ÂâäÈô§</button>
            </div>
        </div>
    </div>

    <!-- „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„É¢„Éº„ÉÄ„É´ -->
    <div id="cloudBackupModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>‚òÅÔ∏è „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁÆ°ÁêÜ</h2>
                <span class="modal-close" onclick="closeCloudBackupModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <p style="font-size: 14px; color: var(--sf-gray); margin-bottom: 12px;">
                        ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅÆ„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åó„Åæ„Åô„ÄÇ„ÅÑ„Å§„Åß„ÇÇÈÅéÂéª„ÅÆÁä∂ÊÖã„Å´Êàª„Åõ„Åæ„Åô„ÄÇ
                    </p>
                    <button onclick="createCloudBackup()" style="padding: 12px 24px; background: var(--sf-blue); color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">
                        üì∏ ‰ªä„Åô„Åê„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê
                    </button>
                </div>
                <div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 20px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--sf-black);">
                        üìÇ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂ±•Ê≠¥
                        <span id="backupCount" style="font-size: 12px; font-weight: 500; color: var(--sf-gray);"></span>
                    </h3>
                    <div id="cloudBackupList" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: var(--sf-gray); text-align: center; padding: 40px 0;">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeCloudBackupModal()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== „Ç´„Çπ„Çø„É†„Ç¢„É©„Éº„Éà ====================
        function showCustomAlert(message, title = '', icon = '‚ö†Ô∏è') {
            const modal = document.getElementById('customAlertModal');
            const iconEl = document.getElementById('customAlertIcon');
            const titleEl = document.getElementById('customAlertTitle');
            const messageEl = document.getElementById('customAlertMessage');

            iconEl.textContent = icon;
            titleEl.textContent = title;
            messageEl.textContent = message;

            modal.style.display = 'flex';
        }

        function closeCustomAlert() {
            const modal = document.getElementById('customAlertModal');
            modal.style.display = 'none';
        }

        // Escape„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCustomAlert();
            }
        });

        // „É¢„Éº„ÉÄ„É´ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('customAlertModal');
            if (event.target === modal) {
                closeCustomAlert();
            }
        });

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let prizes = [];
        let losses = []; // „Éè„Ç∫„É¨„É™„Çπ„Éà
        let editingPrizeId = null; // Á∑®ÈõÜ‰∏≠„ÅÆÊôØÂìÅID
        let editingLossId = null; // Á∑®ÈõÜ‰∏≠„ÅÆ„Éè„Ç∫„É¨ID

        // Êï∞Â≠ó„Çí3Ê°Å„Ç´„É≥„ÉûÂå∫Âàá„Çä„Åß„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatNumber(num) {
            if (num === null || num === undefined || num === '') return '0';
            return Number(num).toLocaleString('ja-JP');
        }


        // ÈÄöÁü•„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? 'rgba(52, 199, 89, 0.95)' : type === 'error' ? 'rgba(255, 59, 48, 0.95)' : 'rgba(255, 149, 0, 0.95)'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                font-size: 14px;
                font-weight: 600;
                max-width: 400px;
                white-space: pre-line;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }













        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆ„Ç≠„Éº
        const STORAGE_KEY = 'oripa_simulator_v2';

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            attachEventListeners();
            updateTotalValue();
        });

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function attachEventListeners() {
            // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞„ÅÆ„Åø
            document.getElementById('packPrice').addEventListener('input', updateTotalValue);
            document.getElementById('totalPacks').addEventListener('input', updateTotalValue);
            // ‰ªñ„ÅÆÈ†ÖÁõÆ„ÅØÊâãÂãïË®àÁÆó„Å´Â§âÊõ¥
        }

        // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§„ÅÆÊõ¥Êñ∞Ôºà„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ„Å™„ÅóÔºâ
        function updateTotalValue() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalValue = packPrice * totalPacks;
            document.getElementById('totalValue').textContent = `¬•${formatNumber(totalValue)}`;

            // „Ç®„É©„ÉºÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÂÖ•Âäõ‰∏≠„ÅØ„Ç®„É©„ÉºË°®Á§∫„Åó„Å™„ÅÑÔºâ
            document.getElementById('packPrice').classList.remove('error');
            document.getElementById('totalPacks').classList.remove('error');
        }

        // „Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatPrizeValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // Êï∞Â≠ó‰ª•Â§ñ„ÇíÈô§Âéª
            if (value) {
                value = formatNumber(parseInt(value)); // „Ç´„É≥„ÉûÂå∫Âàá„Çä„Å´Â§âÊèõ
            }
            input.value = value;
        }

        // Âü∫Êú¨Ë®≠ÂÆöÂÄ§„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatBasicValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // Êï∞Â≠ó‰ª•Â§ñ„ÇíÈô§Âéª
            if (value) {
                value = formatNumber(parseInt(value)); // „Ç´„É≥„ÉûÂå∫Âàá„Çä„Å´Â§âÊèõ
            }
            input.value = value;
            // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§„ÅÆ„ÅøÊõ¥Êñ∞
            setTimeout(updateTotalValue, 100);
        }

        // „Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅÆÊï∞Â≠ó„ÇíÊï∞ÂÄ§„Å´Â§âÊèõ
        function parseFormattedNumber(value) {
            return parseFloat(value.replace(/,/g, '')) || 0;
        }

        // ÊôØÂìÅËøΩÂä†
        // „É°„Ç§„É≥Â∞ÇÁî®Ôºö„Éû„Çπ„Çø„Éº„Åã„ÇâÈÅ∏Êäû„Åó„ÅüÊôØÂìÅ„Çí‰∏ÄÊôÇ‰øùÂ≠ò
        let selectedMasterPrizeForMain = null;

        // ÊôØÂìÅ„Çø„Ç§„ÉóÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
        function handlePrizeTypeChange() {
            const prizeType = document.getElementById('prizeType').value;
            const prizeCountInput = document.getElementById('prizeCount');
            const prizeTypeDescription = document.getElementById('prizeTypeDescription');
            const prizeCountDescription = document.getElementById('prizeCountDescription');
            const prizeRankGroup = document.getElementById('prizeRankGroup');

            if (prizeType === 'lastOne') {
                // „É©„Çπ„Éà„ÉØ„É≥Ë≥û„ÅÆÂ†¥Âêà
                prizeCountInput.value = '1';
                prizeCountInput.disabled = true;
                prizeTypeDescription.textContent = 'ÊúÄÂæå„ÅÆ1ÂÄã„ÅåÂºï„Åã„Çå„ÅüÊôÇ„Å´Áç≤Âæó„Åß„Åç„ÇãÁâπÂà•ÊôØÂìÅÔºàÂ∞ÅÂÖ•Êï∞: 1ÂÄãÂõ∫ÂÆöÔºâ';
                prizeCountDescription.textContent = '„É©„Çπ„Éà„ÉØ„É≥Ë≥û„ÅØ1ÂÄãÂõ∫ÂÆö„Åß„Åô';
                prizeCountDescription.style.color = 'var(--sf-blue)';
                prizeRankGroup.style.display = 'none';  // Á≠âÁ¥ö„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûË°®Á§∫
            } else if (prizeType === 'milestone') {
                // „Ç≠„É™Áï™Ë≥û„ÅÆÂ†¥Âêà
                prizeCountInput.disabled = false;
                prizeTypeDescription.textContent = 'ÁâπÂÆö„ÅÆÂõûÊï∞Ôºà‰æã: 100ÂõûÁõÆ„ÄÅ200ÂõûÁõÆÔºâ„ÅßÁç≤Âæó„Åß„Åç„ÇãÁâπÂà•ÊôØÂìÅ';
                prizeCountDescription.textContent = '„Ç≠„É™Áï™„ÅÆÊï∞„Å†„ÅëÂ∞ÅÂÖ•Êï∞„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æã: 100ÂõûÁõÆ„Å®200ÂõûÁõÆ„Å™„Çâ2ÂÄãÔºâ';
                prizeCountDescription.style.color = 'var(--sf-orange)';
                prizeRankGroup.style.display = 'none';  // Á≠âÁ¥ö„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûË°®Á§∫
            } else {
                // ÈÄöÂ∏∏ÊôØÂìÅ„ÅÆÂ†¥Âêà
                prizeCountInput.disabled = false;
                prizeTypeDescription.textContent = 'ÈÄöÂ∏∏„ÅÆ„Ç¨„ÉÅ„É£ÊôØÂìÅ„Å®„Åó„Å¶ÊäΩÈÅ∏„Éó„Éº„É´„Å´ÂÖ•„Çä„Åæ„Åô';
                prizeCountDescription.textContent = '';
                prizeRankGroup.style.display = 'block';  // Á≠âÁ¥ö„Éï„Ç£„Éº„É´„Éâ„ÇíË°®Á§∫
            }
        }

        // „É°„Ç§„É≥Â∞ÇÁî®Ôºö„Éï„Ç©„Éº„É†„Åã„ÇâÊôØÂìÅ„ÇíËøΩÂä†
        function addPrizeFromForm() {
            // Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„ÅØËøΩÂä†„Åó„Å™„ÅÑ
            if (editingMainPrize) {
                alert('Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„Åß„Åô„ÄÇÂÖà„Å´„Äå„Ç≠„É£„É≥„Çª„É´„Äç„Åæ„Åü„ÅØ„ÄåÊôØÂìÅ„ÇíÊõ¥Êñ∞„Äç„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;
            const prizeType = document.getElementById('prizeType').value || 'normal';

            // ÊôØÂìÅÂêç„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÄÅÈÅ∏Êäû„Çí‰øÉ„Åô
            if (!name) {
                alert('ÊôØÂìÅ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n„Äåüìã „Éû„Çπ„Çø„Éº„Åã„ÇâÈÅ∏Êäû„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶ÊôØÂìÅ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            if (value <= 0 || count <= 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Éû„Çπ„Çø„Éº„Åã„ÇâÈÅ∏Êäû„Åï„Çå„ÅüÊôØÂìÅ„ÅåÂøÖË¶Å
            if (!selectedMasterPrizeForMain) {
                alert('„Äåüìã „Éû„Çπ„Çø„Éº„Åã„ÇâÈÅ∏Êäû„Äç„Éú„Çø„É≥„ÅßÊôØÂìÅ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Åã„Çâ‰ªïÂÖ•„Çå‰æ°Ê†º„ÇíÂèñÂæóÔºàÁ∑®ÈõÜÂèØËÉΩÔºâ
            const purchasePriceInput = document.getElementById('prizePurchasePriceInput');
            const inputPurchasePrice = parseFormattedNumber(purchasePriceInput.value) || selectedMasterPrizeForMain.purchasePrice || 0;

            const prize = {
                id: Date.now(),
                name: name,
                rank: rank,
                purchasePrice: inputPurchasePrice,
                value: value,
                count: count,
                image: selectedMasterPrizeForMain.image || null,
                prizeType: prizeType // ÊôØÂìÅ„Çø„Ç§„ÉóÔºànormal, lastOne, milestoneÔºâ
            };

            showNotification(`‚úÖ ÊôØÂìÅ„Äå${name}„Äç„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºà${count}ÂÄãÔºâ`, 'success');

            prizes.push(prize);

            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            clearMainPrizeForm();

            updatePrizeList();
            saveData();

            // „É™„Ç¢„É´„Çø„Ç§„É†Ë®àÁÆó
            calculate();
        }

        // „É°„Ç§„É≥Â∞ÇÁî®Ôºö„Éï„Ç©„Éº„É†„Åã„ÇâÊôØÂìÅ„ÇíÊõ¥Êñ∞
        function updatePrizeFromForm() {
            if (!editingMainPrize) return;

            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;
            const prizeType = document.getElementById('prizeType').value || 'normal';

            // ‰ªïÂÖ•„Çå‰æ°Ê†º„ÇíÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Åã„ÇâÂèñÂæó
            const purchasePriceInput = document.getElementById('prizePurchasePriceInput');
            const purchasePrice = parseFormattedNumber(purchasePriceInput.value) || editingMainPrize.purchasePrice || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÊôØÂìÅÂêç„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇÇÊõ¥Êñ∞
            if (name !== editingMainPrize.name) {
                const masterPrize = prizeMaster.find(p => p.name === editingMainPrize.name);
                if (masterPrize) {
                    masterPrize.name = name;
                    savePrizeMaster();
                    updatePrizeMasterList();
                }
            }

            // „É°„Ç§„É≥„ÅÆÊôØÂìÅ„ÇíÊõ¥Êñ∞
            const prizeIndex = prizes.findIndex(p => p.id === editingMainPrize.id);
            if (prizeIndex !== -1) {
                prizes[prizeIndex] = {
                    ...prizes[prizeIndex],
                    name: name,
                    rank: rank,
                    purchasePrice: purchasePrice,
                    value: value,
                    count: count,
                    prizeType: prizeType
                };
            }

            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            clearMainPrizeForm();

            updatePrizeList();
            saveData();

            // „É™„Ç¢„É´„Çø„Ç§„É†Ë®àÁÆó
            calculate();

            // ÊàêÂäüÈÄöÁü•
            showNotification(`‚úÖ ÊôØÂìÅ„Äå${name}„Äç„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü`, 'success');
        }

        // „É°„Ç§„É≥Â∞ÇÁî®ÔºöÁ∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´
        function cancelEditPrize() {
            clearMainPrizeForm();
        }

        // „É°„Ç§„É≥Â∞ÇÁî®Ôºö„Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
        function clearMainPrizeForm() {
            editingMainPrize = null;
            selectedMasterPrizeForMain = null;

            document.getElementById('prizeName').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';
            document.getElementById('prizeReadonlyInfo').style.display = 'none';
            document.getElementById('prizePurchasePriceInput').value = ''; // ‰ªïÂÖ•„Çå‰æ°Ê†ºÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
            document.getElementById('prizePurchasePriceHint').textContent = ''; // „Éí„É≥„Éà„Çí„ÇØ„É™„Ç¢

            // ÊôØÂìÅ„Çø„Ç§„Éó„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('prizeType').value = 'normal';
            document.getElementById('prizeCount').disabled = false;
            document.getElementById('prizeTypeDescription').textContent = 'ÈÄöÂ∏∏„ÅÆ„Ç¨„ÉÅ„É£ÊôØÂìÅ„Å®„Åó„Å¶ÊäΩÈÅ∏„Éó„Éº„É´„Å´ÂÖ•„Çä„Åæ„Åô';
            document.getElementById('prizeCountDescription').textContent = '';

            // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂÖÉ„Å´Êàª„Åô
            document.getElementById('addPrizeBtn').style.display = 'inline-block';
            document.getElementById('updatePrizeBtn').style.display = 'none';
            document.getElementById('replacePrizeBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // ÊôØÂìÅÂâäÈô§
        function removePrize(id) {
            const prize = prizes.find(p => p.id === id);
            const prizeName = prize ? prize.name : 'ÊôØÂìÅ';

            prizes = prizes.filter(p => p.id !== id);
            updatePrizeList();
            saveData();

            // „É™„Ç¢„É´„Çø„Ç§„É†Ë®àÁÆó
            calculate();

            // ÊàêÂäüÈÄöÁü•
            showNotification(`üóëÔ∏è ÊôØÂìÅ„Äå${prizeName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
        }

        // ÊôØÂìÅÁ∑®ÈõÜ
        // „É°„Ç§„É≥Â∞ÇÁî®ÔºöÊôØÂìÅÁ∑®ÈõÜÊôÇ„ÅÆ‰∏ÄÊôÇ‰øùÂ≠ò
        let editingMainPrize = null;

        function editPrize(id) {
            const prize = prizes.find(p => p.id === id);
            if (!prize) return;

            // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíÊúâÂäπÂåñ
            editingMainPrize = prize;

            // „Éï„Ç©„Éº„É†„Å´ÂÄ§„ÇíË®≠ÂÆö
            document.getElementById('prizeName').value = prize.name;
            document.getElementById('prizeRank').value = prize.rank;
            document.getElementById('prizeValue').value = formatNumber(prize.value);
            document.getElementById('prizeCount').value = prize.count;
            document.getElementById('prizeType').value = prize.prizeType || 'normal';

            // ÊôØÂìÅ„Çø„Ç§„Éó„Å´Âøú„Åò„ÅüUIÊõ¥Êñ∞
            handlePrizeTypeChange();

            // ÁîªÂÉè„Å®‰ªïÂÖ•„Çå‰æ°Ê†º„ÇíË°®Á§∫
            const readonlyInfo = document.getElementById('prizeReadonlyInfo');
            const imageDisplay = document.getElementById('prizeImageDisplay');
            const purchasePriceInput = document.getElementById('prizePurchasePriceInput');
            const purchasePriceHint = document.getElementById('prizePurchasePriceHint');

            if (prize.image) {
                imageDisplay.innerHTML = `<img src="${prize.image}" alt="${prize.name}" style="width: 60px; height: 90px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1);">`;
            } else {
                imageDisplay.innerHTML = `<div style="width: 60px; height: 90px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;">üì¶</div>`;
            }

            purchasePriceInput.value = formatNumber(prize.purchasePrice);
            purchasePriceHint.textContent = '';
            readonlyInfo.style.display = 'block';

            // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
            document.getElementById('addPrizeBtn').style.display = 'none';
            document.getElementById('updatePrizeBtn').style.display = 'inline-block';
            document.getElementById('replacePrizeBtn').style.display = 'inline-block';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // „Éï„Ç©„Éº„É†„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
            document.getElementById('prizeName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ÊôØÂìÅÊõ¥Êñ∞
        async function updatePrize() {
            if (!editingPrizeId) return;

            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const purchasePrice = parseFormattedNumber(document.getElementById('prizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || purchasePrice <= 0 || value <= 0 || count <= 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÊôØÂìÅ„ÇíÊõ¥Êñ∞
            const prizeIndex = prizes.findIndex(p => p.id === editingPrizeId);
            if (prizeIndex !== -1) {
                prizes[prizeIndex] = {
                    id: editingPrizeId,
                    name: name,
                    rank: rank,
                    purchasePrice: purchasePrice,
                    value: value,
                    count: count,
                    image: prizes[prizeIndex].image || selectedPrizeImage || null
                };
            }

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´Âêå„ÅòÂêçÂâç„ÅÆÊôØÂìÅ„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç
            const masterPrize = prizeMaster.find(p => p.name === name);
            if (masterPrize) {
                const message = `ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´„Äå${name}„Äç„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n\n` +
                    `„ÄêÁèæÂú®„ÅÆÊôØÂìÅ„Éû„Çπ„Çø„ÉºÊÉÖÂ†±„Äë\n` +
                    `‰ªïÂÖ•„Çå‰æ°Ê†º: ¬•${formatNumber(masterPrize.purchasePrice)}\n` +
                    `ÈÇÑÂÖÉ‰æ°ÂÄ§: ¬•${formatNumber(masterPrize.value)}\n\n` +
                    `„Äê‰ªäÂõû„ÅÆÁ∑®ÈõÜÂÜÖÂÆπ„Äë\n` +
                    `‰ªïÂÖ•„Çå‰æ°Ê†º: ¬•${formatNumber(purchasePrice)}\n` +
                    `ÈÇÑÂÖÉ‰æ°ÂÄ§: ¬•${formatNumber(value)}\n\n` +
                    `„Å©„ÅÆ„Çà„ÅÜ„Å´Âá¶ÁêÜ„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                    `[1] ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇÇÊõ¥Êñ∞„Åô„ÇãÔºà„Éû„Çπ„Çø„Éº„ÅÆÊÉÖÂ†±„Çí‰ªäÂõû„ÅÆÁ∑®ÈõÜÂÜÖÂÆπ„Åß‰∏äÊõ∏„ÅçÔºâ\n` +
                    `[2] ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´Êñ∞„Åó„ÅèÁôªÈå≤„Åô„ÇãÔºàÂêå„ÅòÂêçÂâç„ÅßÂà•„ÅÆÊôØÂìÅ„Å®„Åó„Å¶ÁôªÈå≤Ôºâ\n` +
                    `[3] ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà„É°„Ç§„É≥„ÅÆÊôØÂìÅ„ÅÆ„ÅøÊõ¥Êñ∞Ôºâ`;

                const choice = prompt(message + '\n\nÊï∞Â≠ó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (1, 2, „Åæ„Åü„ÅØ 3):', '3');

                if (choice === '1') {
                    // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÊõ¥Êñ∞
                    const masterIndex = prizeMaster.findIndex(p => p.id === masterPrize.id);
                    if (masterIndex !== -1) {
                        prizeMaster[masterIndex] = {
                            ...prizeMaster[masterIndex],
                            rank: rank,
                            purchasePrice: purchasePrice,
                            value: value,
                            updatedAt: Date.now()
                        };
                        savePrizeMaster();
                        showNotification('‚úÖ ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇÇÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                    }
                } else if (choice === '2') {
                    // Êñ∞„Åó„ÅèÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ËøΩÂä†
                    prizeMaster.push({
                        id: Date.now() + Math.random(),
                        name: name,
                        rank: rank,
                        purchasePrice: purchasePrice,
                        value: value,
                        count: count,
                        addedAt: Date.now()
                    });
                    savePrizeMaster();
                    showNotification('‚úÖ ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´Êñ∞„Åó„ÅèÁôªÈå≤„Åó„Åæ„Åó„Åü', 'success');
                }
                // choice === '3' „ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            }

            // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíËß£Èô§
            cancelEdit();

            updatePrizeList();
            saveData();

            // ÊàêÂäüÈÄöÁü•
            showNotification(`‚úÖ ÊôØÂìÅ„Äå${name}„Äç„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü`, 'success');
        }

        // Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´
        function cancelEdit() {
            editingPrizeId = null;
            selectedPrizeImage = null; // ÁîªÂÉè„ÇÇ„ÇØ„É™„Ç¢

            // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('prizeName').value = '';
            document.getElementById('prizePurchasePrice').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';

            // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂÖÉ„Å´Êàª„Åô
            document.getElementById('addPrizeBtn').style.display = 'inline-block';
            document.getElementById('updatePrizeBtn').style.display = 'none';
            document.getElementById('replacePrizeBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // ÊôØÂìÅ„Éû„Çπ„Çø„ÉºÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function selectFromPrizeMaster() {
            if (prizeMaster.length === 0) {
                alert('ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅåÁ©∫„Åß„Åô„ÄÇ\n\nÊôØÂìÅ„Éû„Çπ„Çø„Éº„Çø„Éñ„ÅßÊôØÂìÅ„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\nÊâãÈ†ÜÔºö\n1. ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Çø„Éñ„ÇíÈñã„Åè\n2. „Äå‚ûï Êñ∞Ë¶èÊôØÂìÅ„ÇíËøΩÂä†„Äç„ÅßÊôØÂìÅ„ÇíÁôªÈå≤\n3. „É°„Ç§„É≥„Çø„Éñ„ÅßÁôªÈå≤„Åó„ÅüÊôØÂìÅ„ÇíÈÅ∏Êäû');
                return;
            }

            const modal = document.getElementById('selectPrizeMasterModal');
            const listContainer = document.getElementById('prizeMasterSelectList');

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„É™„Çπ„Éà„ÇíË°®Á§∫
            const sortedPrizes = [...prizeMaster].sort((a, b) => a.rank - b.rank);
            listContainer.innerHTML = sortedPrizes.map(prize => {
                return `
                    <div class="prize-master-item" style="cursor: pointer; transition: all 0.2s;" onclick="selectPrizeFromMaster(${prize.id})">
                        <div class="prize-master-header">
                            <div class="prize-master-title">
                                <div class="prize-master-name">${prize.name}</div>
                            </div>
                            <div style="color: var(--sf-blue); font-weight: 600;">ÈÅ∏Êäû ‚Üí</div>
                        </div>
                        <div class="prize-master-info">
                            <div class="prize-master-info-item">
                                <div class="prize-master-info-label">‰ªïÂÖ•„Çå‰æ°Ê†º</div>
                                <div class="prize-master-info-value">¬•${formatNumber(prize.purchasePrice)}</div>
                            </div>
                            <div class="prize-master-info-item">
                                <div class="prize-master-info-label">„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§</div>
                                <div class="prize-master-info-value">¬•${formatNumber(prize.value)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            modal.style.display = 'flex';
        }

        // Á∑®ÈõÜ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÔºà'main' or 'master'Ôºâ
        let editContext = 'master';
        let editingMainPrizeId = null; // „É°„Ç§„É≥„Çø„Éñ„ÅßÁ∑®ÈõÜ‰∏≠„ÅÆÊôØÂìÅID

        // „É°„Ç§„É≥„Çø„Éñ„Åã„ÇâÊñ∞Ë¶èÊôØÂìÅÁôªÈå≤„ÇíÈñã„Åè
        function openAddPrizeForMain() {
            editContext = 'main';
            editingMainPrizeId = null;

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Çø„Éñ„Å´Âàá„ÇäÊõø„Åà„Å¶„Éï„Ç©„Éº„É†„ÇíÈñã„Åè
            showTab('prize-master');

            // Â∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶„Åã„Çâ„Éï„Ç©„Éº„É†„ÇíÈñã„Åè
            setTimeout(() => {
                toggleAddPrizeForm();
            }, 100);
        }

        // „É°„Ç§„É≥„Çø„Éñ„Åã„Çâ„Éû„Çπ„Çø„ÉºÈÅ∏Êäû„ÇíÈñã„Åè
        function selectFromPrizeMasterForMain() {
            if (prizeMaster.length === 0) {
                alert('ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅåÁ©∫„Åß„Åô„ÄÇ\n\n„Åæ„ÅöÊôØÂìÅ„Éû„Çπ„Çø„Éº„Çø„Éñ„ÅßÊôØÂìÅ„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const modal = document.getElementById('selectPrizeMasterModal');

            // „Éï„Ç£„É´„Çø„Éº„Éª‰∏¶„Å≥Êõø„Åà„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('modalSortBy').value = 'price';
            document.getElementById('modalSortOrder').value = 'desc';
            document.getElementById('modalStockFilter').value = 'all';
            document.getElementById('modalTypeFilter').value = 'all';
            document.getElementById('modalWantedFilter').checked = false;
            document.getElementById('modalSearchText').value = '';
            document.getElementById('modalMinPurchasePrice').value = '';
            document.getElementById('modalMaxPurchasePrice').value = '';
            document.getElementById('modalMinRewardValue').value = '';
            document.getElementById('modalMaxRewardValue').value = '';

            // „É™„Çπ„Éà„ÇíÊõ¥Êñ∞
            updatePrizeMasterSelectList();

            modal.style.display = 'flex';
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÊôØÂìÅ„Éû„Çπ„Çø„Éº„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updatePrizeMasterSelectList() {
            const listContainer = document.getElementById('prizeMasterSelectList');

            if (prizeMaster.length === 0) {
                listContainer.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅåÁ©∫„Åß„Åô</p>';
                return;
            }

            // „Éï„Ç£„É´„Çø„Éº„Éª‰∏¶„Å≥Êõø„ÅàË®≠ÂÆö„ÇíÂèñÂæó
            const sortBy = document.getElementById('modalSortBy')?.value || 'price';
            const sortOrder = document.getElementById('modalSortOrder')?.value || 'desc';
            const stockFilter = document.getElementById('modalStockFilter')?.value || 'all';
            const typeFilter = document.getElementById('modalTypeFilter')?.value || 'all';
            const wantedFilter = document.getElementById('modalWantedFilter')?.checked || false;
            const searchText = document.getElementById('modalSearchText')?.value.trim().toLowerCase() || '';

            // „Éï„Ç£„É´„Çø„ÉºÂá¶ÁêÜ
            let filteredPrizes = [...prizeMaster];

            // Âú®Â∫´„Éï„Ç£„É´„Çø„Éº
            if (stockFilter === 'inStock') {
                filteredPrizes = filteredPrizes.filter(prize => prize.count > 0);
            } else if (stockFilter === 'outOfStock') {
                filteredPrizes = filteredPrizes.filter(prize => prize.count === 0);
            }

            // Á®ÆÈ°û„Éï„Ç£„É´„Çø„Éº
            if (typeFilter !== 'all') {
                filteredPrizes = filteredPrizes.filter(prize => (prize.type || 'PSA10') === typeFilter);
            }

            // Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„É™„Çπ„Éà„Éï„Ç£„É´„Çø„Éº
            if (wantedFilter) {
                filteredPrizes = filteredPrizes.filter(prize => prize.isWanted === true);
            }

            // ÂêçÂâçÊ§úÁ¥¢„Éï„Ç£„É´„Çø„Éº
            if (searchText) {
                filteredPrizes = filteredPrizes.filter(prize =>
                    prize.name.toLowerCase().includes(searchText)
                );
            }

            // ÈáëÈ°çÁØÑÂõ≤„Éï„Ç£„É´„Çø„Éº
            const minPurchasePrice = parseFloat(document.getElementById('modalMinPurchasePrice')?.value) || null;
            const maxPurchasePrice = parseFloat(document.getElementById('modalMaxPurchasePrice')?.value) || null;
            const minRewardValue = parseFloat(document.getElementById('modalMinRewardValue')?.value) || null;
            const maxRewardValue = parseFloat(document.getElementById('modalMaxRewardValue')?.value) || null;

            if (minPurchasePrice !== null) {
                filteredPrizes = filteredPrizes.filter(prize => (prize.purchasePrice || 0) >= minPurchasePrice);
            }
            if (maxPurchasePrice !== null) {
                filteredPrizes = filteredPrizes.filter(prize => (prize.purchasePrice || 0) <= maxPurchasePrice);
            }
            if (minRewardValue !== null) {
                filteredPrizes = filteredPrizes.filter(prize => (prize.value || 0) >= minRewardValue);
            }
            if (maxRewardValue !== null) {
                filteredPrizes = filteredPrizes.filter(prize => (prize.value || 0) <= maxRewardValue);
            }

            // „Éï„Ç£„É´„Çø„ÉºÂæå„ÅÆ‰ª∂Êï∞„ÉÅ„Çß„ÉÉ„ÇØ
            if (filteredPrizes.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--sf-gray);">
                        <div style="font-size: 48px; margin-bottom: 12px;">üîç</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Ë©≤ÂΩì„Åô„ÇãÊôØÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div style="font-size: 14px;">„Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂„ÇíÂ§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
                return;
            }

            // „ÇΩ„Éº„ÉàÂá¶ÁêÜ
            let sortedPrizes = [...filteredPrizes];

            // „ÇΩ„Éº„ÉàÂá¶ÁêÜ
            if (sortBy === 'price') {
                sortedPrizes.sort((a, b) => {
                    if (sortOrder === 'desc') {
                        return b.purchasePrice - a.purchasePrice;
                    } else {
                        return a.purchasePrice - b.purchasePrice;
                    }
                });
            } else if (sortBy === 'date') {
                sortedPrizes.sort((a, b) => {
                    if (sortOrder === 'desc') {
                        return b.id - a.id;
                    } else {
                        return a.id - b.id;
                    }
                });
            }

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„É™„Çπ„Éà„ÇíË°®Á§∫
            listContainer.innerHTML = sortedPrizes.map(prize => {
                const imageHtml = prize.image
                    ? `<img src="${prize.image}" alt="${prize.name}" style="width: 50px; height: 75px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); margin-right: 12px;">`
                    : `<div style="width: 50px; height: 75px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px;">üì¶</div>`;

                const typeLabel = prize.type || 'PSA10';
                const isWanted = prize.isWanted || false;
                // „Åô„Åß„Å´ÊôØÂìÅ„Å®„Åó„Å¶Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const isAlreadySet = prizes.some(p => p.name === prize.name);
                const stockBadge = prize.count > 0
                    ? `<span style="display: inline-block; padding: 6px 14px; background: rgba(52, 199, 89, 0.1); color: #34C759; border-radius: 16px; font-size: 13px; font-weight: 600; line-height: 1.4; white-space: nowrap;">${formatNumber(prize.count)}ÂÄã</span>`
                    : `<span style="display: inline-block; padding: 6px 14px; background: rgba(255, 59, 48, 0.1); color: #ff3b30; border-radius: 16px; font-size: 13px; font-weight: 600; line-height: 1.4; white-space: nowrap;">Â£≤„ÇäÂàá„Çå</span>`;

                return `
                    <div class="prize-master-item" style="transition: all 0.2s; display: flex; align-items: center; position: relative;">
                        <div style="flex: 1; cursor: pointer;" onclick="selectPrizeFromMasterForMain(${prize.id})">
                            <div style="display: flex; align-items: center;">
                                ${imageHtml}
                                <div style="flex: 1;">
                                    <div class="prize-master-header">
                                        <div class="prize-master-title">
                                            <div class="prize-master-name">${prize.name}</div>
                                            <div style="display: flex; gap: 6px; margin-top: 6px; align-items: center;">
                                                <span style="display: inline-block; padding: 6px 14px; background: rgba(0, 122, 255, 0.1); color: #007AFF; border-radius: 16px; font-size: 13px; font-weight: 600; line-height: 1.4; white-space: nowrap;">${typeLabel}</span>
                                                <span id="stockBadge_${prize.id}" style="display: inline-block; padding: 6px 14px; background: ${prize.count > 0 ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 59, 48, 0.1)'}; color: ${prize.count > 0 ? '#34C759' : '#ff3b30'}; border-radius: 16px; font-size: 13px; font-weight: 600; line-height: 1.4; white-space: nowrap;">${prize.count > 0 ? prize.count + 'ÂÄã' : 'Â£≤„ÇäÂàá„Çå'}</span>
                                                ${isWanted ? '<span style="font-size: 14px; filter: none;" title="Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„É™„Çπ„Éà">‚ù§Ô∏è</span>' : ''}
                                                ${isAlreadySet ? '<span style="display: inline-block; padding: 6px 14px; background: rgba(142, 142, 147, 0.15); color: #8E8E93; border-radius: 16px; font-size: 13px; font-weight: 600; line-height: 1.4; white-space: nowrap;">„Åô„Åß„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</span>' : ''}
                                            </div>
                                        </div>
                                        <div style="color: var(--sf-blue); font-weight: 600;">ÈÅ∏Êäû ‚Üí</div>
                                    </div>
                                    <div class="prize-master-info">
                                        <div class="prize-master-info-item">
                                            <div class="prize-master-info-label">‰ªïÂÖ•„Çå‰æ°Ê†º</div>
                                            <div class="prize-master-info-value">¬•${formatNumber(prize.purchasePrice)}</div>
                                        </div>
                                        <div class="prize-master-info-item">
                                            <div class="prize-master-info-label">„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§</div>
                                            <div class="prize-master-info-value">¬•${formatNumber(prize.value)}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center; margin-left: 12px;">
                            <div id="stockEditArea_${prize.id}" style="display: none; align-items: center; gap: 8px;">
                                <input type="number" id="stockInput_${prize.id}" min="0" value="${prize.count}"
                                    style="width: 80px; padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.2); font-size: 14px;"
                                    onclick="event.stopPropagation()">
                                <button class="btn btn-danger" onclick="cancelModalStockEdit(${prize.id}); event.stopPropagation();" title="„Ç≠„É£„É≥„Çª„É´" style="padding: 8px 16px; font-size: 13px; white-space: nowrap;">‚úï ‰∏≠Ê≠¢</button>
                                <button class="btn btn-success" onclick="saveModalStock(${prize.id}); event.stopPropagation();" title="‰øùÂ≠ò" style="padding: 8px 16px; font-size: 13px; white-space: nowrap;">‚úì ‰øùÂ≠ò</button>
                            </div>
                            <button id="stockEditBtn_${prize.id}" class="btn btn-primary" onclick="startModalStockEdit(${prize.id}); event.stopPropagation();" title="Âú®Â∫´Á∑®ÈõÜ" style="padding: 8px 16px; font-size: 13px; white-space: nowrap;">
                                üìù Âú®Â∫´Á∑®ÈõÜ
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÂú®Â∫´Á∑®ÈõÜ„ÇíÈñãÂßã
        function startModalStockEdit(prizeId) {
            // Á∑®ÈõÜ„Ç®„É™„Ç¢„ÇíË°®Á§∫„ÄÅÁ∑®ÈõÜ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
            document.getElementById('stockEditArea_' + prizeId).style.display = 'flex';
            document.getElementById('stockEditBtn_' + prizeId).style.display = 'none';

            // ÂÖ•ÂäõÊ¨Ñ„Å´„Éï„Ç©„Éº„Ç´„Çπ
            document.getElementById('stockInput_' + prizeId).focus();
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÂú®Â∫´Á∑®ÈõÜ„Çí„Ç≠„É£„É≥„Çª„É´
        function cancelModalStockEdit(prizeId) {
            const prize = prizeMaster.find(p => p.id === prizeId);
            if (prize) {
                // ÂÖÉ„ÅÆÂÄ§„Å´Êàª„Åô
                document.getElementById('stockInput_' + prizeId).value = prize.count;
            }

            // Á∑®ÈõÜ„Ç®„É™„Ç¢„ÇíÈùûË°®Á§∫„ÄÅÁ∑®ÈõÜ„Éú„Çø„É≥„ÇíË°®Á§∫
            document.getElementById('stockEditArea_' + prizeId).style.display = 'none';
            document.getElementById('stockEditBtn_' + prizeId).style.display = 'inline-block';
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÂú®Â∫´Á∑®ÈõÜ„Çí‰øùÂ≠ò
        function saveModalStock(prizeId) {
            const prize = prizeMaster.find(p => p.id === prizeId);
            if (!prize) {
                alert('ÊôØÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            const newStock = parseInt(document.getElementById('stockInput_' + prizeId).value) || 0;

            if (newStock < 0) {
                alert('Âú®Â∫´Êï∞„ÅØ0‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // Âú®Â∫´Êï∞„ÇíÊõ¥Êñ∞
            prize.count = newStock;

            // ‰øùÂ≠ò
            savePrizeMaster();

            // „Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
            const badge = document.getElementById('stockBadge_' + prizeId);
            if (badge) {
                badge.textContent = newStock > 0 ? newStock + 'ÂÄã' : 'Â£≤„ÇäÂàá„Çå';
                badge.style.padding = '6px 14px';
                badge.style.background = newStock > 0 ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 59, 48, 0.1)';
                badge.style.color = newStock > 0 ? '#34C759' : '#ff3b30';
                badge.style.borderRadius = '16px';
                badge.style.fontSize = '13px';
                badge.style.fontWeight = '600';
                badge.style.lineHeight = '1.4';
                badge.style.whiteSpace = 'nowrap';
            }

            // Á∑®ÈõÜ„Ç®„É™„Ç¢„ÇíÈùûË°®Á§∫„ÄÅÁ∑®ÈõÜ„Éú„Çø„É≥„ÇíË°®Á§∫
            document.getElementById('stockEditArea_' + prizeId).style.display = 'none';
            document.getElementById('stockEditBtn_' + prizeId).style.display = 'inline-block';

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅÆË°®Á§∫„ÇÇÊõ¥Êñ∞Ôºà„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„ÅüÂæå„Å´ÂèçÊò†„Åï„Çå„Çã„Çà„ÅÜ„Å´Ôºâ
            updatePrizeMasterList();

            // Âú®Â∫´Ê∏õÂ∞ë„Çø„Éñ„ÅÆÊú™Áô∫ÈÄÅ„É™„Çπ„Éà„ÇÇÊõ¥Êñ∞ÔºàÂú®Â∫´Áä∂Ê≥Å„ÅåÂ§â„Çè„Çã„Åü„ÇÅÔºâ
            renderPendingOrdersOnly();
        }

        // ÁΩÆ„ÅçÊèõ„Åà„É¢„Éº„Éâ„Éï„É©„Ç∞
        let isReplacingMode = false;

        // „É°„Ç§„É≥„Çø„ÉñÁî®Ôºö„Éû„Çπ„Çø„Éº„Åã„ÇâÊôØÂìÅ„ÇíÈÅ∏Êäû„Åó„Å¶„Éï„Ç©„Éº„É†„Å´ÂèçÊò†
        function selectPrizeFromMasterForMain(prizeId) {
            const prize = prizeMaster.find(p => p.id === prizeId);
            if (!prize) return;

            // ÁΩÆ„ÅçÊèõ„Åà„É¢„Éº„Éâ„ÅÆÂ†¥Âêà
            if (isReplacingMode) {
                replacePrizeFromMaster(prizeId);
                return;
            }

            // ÈÅ∏Êäû„Åó„ÅüÊôØÂìÅ„Çí‰∏ÄÊôÇ‰øùÂ≠ò
            selectedMasterPrizeForMain = prize;

            // „Éï„Ç©„Éº„É†„Å´ÊÉÖÂ†±„ÇíË®≠ÂÆö
            document.getElementById('prizeName').value = prize.name;
            document.getElementById('prizeValue').value = formatNumber(prize.value);
            document.getElementById('prizeCount').value = '1';

            // ÁîªÂÉè„Å®‰ªïÂÖ•„Çå‰æ°Ê†º„ÇíË°®Á§∫
            const readonlyInfo = document.getElementById('prizeReadonlyInfo');
            const imageDisplay = document.getElementById('prizeImageDisplay');
            const purchasePriceInput = document.getElementById('prizePurchasePriceInput');
            const purchasePriceHint = document.getElementById('prizePurchasePriceHint');

            if (prize.image) {
                imageDisplay.innerHTML = `<img src="${prize.image}" alt="${prize.name}" style="width: 60px; height: 90px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1);">`;
            } else {
                imageDisplay.innerHTML = `<div style="width: 60px; height: 90px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;">üì¶</div>`;
            }

            // Âä†ÈáçÂπ≥Âùá‰ªïÂÖ•„ÇåÂÄ§„ÇíË®àÁÆó„Åó„Å¶Ë®≠ÂÆö
            const avgPurchasePrice = calculateAveragePurchasePrice(prize);
            purchasePriceInput.value = formatNumber(avgPurchasePrice);

            // „Éí„É≥„ÉàË°®Á§∫Ôºà‰ªïÂÖ•„ÇåÂ±•Ê≠¥„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
            if (prize.purchasePriceHistory && prize.purchasePriceHistory.length > 0) {
                purchasePriceHint.textContent = `‚ÄªÂπ≥Âùá‰ªïÂÖ•„ÇåÂÄ§Ôºà${prize.purchasePriceHistory.length}Âõû„ÅÆ‰ªïÂÖ•„ÇåÂ±•Ê≠¥„Çà„ÇäÔºâ`;
            } else {
                purchasePriceHint.textContent = '';
            }

            readonlyInfo.style.display = 'block';

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeSelectPrizeMasterModal();
        }

        // ÁΩÆ„ÅçÊèõ„Åà„É¢„Éº„Éâ„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function selectFromPrizeMasterForReplace() {
            if (!editingMainPrize) {
                alert('ÁΩÆ„ÅçÊèõ„Åà„ÇãÊôØÂìÅ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            isReplacingMode = true;
            selectFromPrizeMasterForMain();
        }

        // ÈÅ∏Êäû„Åó„ÅüÊôØÂìÅ„ÅßÁèæÂú®„ÅÆÊôØÂìÅ„ÇíÁΩÆ„ÅçÊèõ„Åà„Çã
        function replacePrizeFromMaster(prizeId) {
            const newPrize = prizeMaster.find(p => p.id === prizeId);
            if (!newPrize || !editingMainPrize) return;

            // ÁèæÂú®„ÅÆ„Éï„Ç©„Éº„É†„ÅÆÂÄ§„Çí‰øùÊåÅ
            const currentRank = parseInt(document.getElementById('prizeRank').value);
            const currentValue = parseFormattedNumber(document.getElementById('prizeValue').value);
            const currentCount = parseInt(document.getElementById('prizeCount').value) || 0;

            // Êñ∞„Åó„ÅÑÊôØÂìÅ„ÅÆÊÉÖÂ†±„Åß„Éï„Ç©„Éº„É†„ÇíÊõ¥Êñ∞
            document.getElementById('prizeName').value = newPrize.name;
            // Á≠âÁ¥ö„ÄÅÈÇÑÂÖÉ‰æ°ÂÄ§„ÄÅÂ∞ÅÂÖ•Êï∞„ÅØÁèæÂú®„ÅÆÂÄ§„ÇíÁ∂≠ÊåÅ
            document.getElementById('prizeRank').value = currentRank;
            document.getElementById('prizeValue').value = formatNumber(currentValue);
            document.getElementById('prizeCount').value = currentCount;

            // ÁîªÂÉè„Å®‰ªïÂÖ•„Çå‰æ°Ê†º„ÇíË°®Á§∫
            const readonlyInfo = document.getElementById('prizeReadonlyInfo');
            const imageDisplay = document.getElementById('prizeImageDisplay');
            const purchasePriceInput = document.getElementById('prizePurchasePriceInput');
            const purchasePriceHint = document.getElementById('prizePurchasePriceHint');

            if (newPrize.image) {
                imageDisplay.innerHTML = `<img src="${newPrize.image}" alt="${newPrize.name}" style="width: 60px; height: 90px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1);">`;
            } else {
                imageDisplay.innerHTML = `<div style="width: 60px; height: 90px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;">üì¶</div>`;
            }

            // Âä†ÈáçÂπ≥Âùá‰ªïÂÖ•„ÇåÂÄ§„ÇíË®àÁÆó„Åó„Å¶Ë®≠ÂÆö
            const avgPurchasePrice = calculateAveragePurchasePrice(newPrize);
            purchasePriceInput.value = formatNumber(avgPurchasePrice);

            // „Éí„É≥„ÉàË°®Á§∫Ôºà‰ªïÂÖ•„ÇåÂ±•Ê≠¥„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
            if (newPrize.purchasePriceHistory && newPrize.purchasePriceHistory.length > 0) {
                purchasePriceHint.textContent = `‚ÄªÂπ≥Âùá‰ªïÂÖ•„ÇåÂÄ§Ôºà${newPrize.purchasePriceHistory.length}Âõû„ÅÆ‰ªïÂÖ•„ÇåÂ±•Ê≠¥„Çà„ÇäÔºâ`;
            } else {
                purchasePriceHint.textContent = '';
            }

            readonlyInfo.style.display = 'block';

            // editingMainPrize„ÇíÊõ¥Êñ∞
            editingMainPrize.name = newPrize.name;
            editingMainPrize.image = newPrize.image;
            editingMainPrize.purchasePrice = avgPurchasePrice;

            // ÁΩÆ„ÅçÊèõ„Åà„É¢„Éº„Éâ„ÇíËß£Èô§
            isReplacingMode = false;

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeSelectPrizeMasterModal();

            alert(`‚úÖ ÊôØÂìÅ„Çí„Äå${newPrize.name}„Äç„Å´ÁΩÆ„ÅçÊèõ„Åà„Åæ„Åó„Åü„ÄÇ\n\n„ÄåÊôØÂìÅ„ÇíÊõ¥Êñ∞„Äç„Éú„Çø„É≥„Åß‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
        }

        // ÊôØÂìÅ„Éû„Çπ„Çø„ÉºÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeSelectPrizeMasterModal() {
            const modal = document.getElementById('selectPrizeMasterModal');
            modal.style.display = 'none';

            // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶„É™„Çπ„ÉàË°®Á§∫„Å´Êàª„Åô
            hideModalNewPrizeForm();

            // ÁΩÆ„ÅçÊèõ„Åà„É¢„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà
            isReplacingMode = false;
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÊñ∞Ë¶èÁôªÈå≤„Éï„Ç©„Éº„É†„ÇíË°®Á§∫
        function showModalNewPrizeForm() {
            // „É™„Çπ„Éà„Å®„Éï„Ç£„É´„Çø„Éº„Ç®„É™„Ç¢„ÇíÈùûË°®Á§∫
            document.getElementById('prizeMasterSelectList').style.display = 'none';
            document.getElementById('modalFilterArea').style.display = 'none';

            // „Éï„Ç©„Éº„É†„ÇíË°®Á§∫
            document.getElementById('modalNewPrizeForm').style.display = 'block';

            // „Éú„Çø„É≥„ÇíÂàá„ÇäÊõø„Åà
            document.getElementById('modalCancelBtn').style.display = 'none';
            document.getElementById('modalNewPrizeBtn').style.display = 'none';
            document.getElementById('modalFormCancelBtn').style.display = 'inline-block';
            document.getElementById('modalFormSaveBtn').style.display = 'inline-block';

            // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('modalPrizeName').value = '';
            document.getElementById('modalPrizeType').value = 'PSA10';
            document.getElementById('modalPurchasePrice').value = '';
            document.getElementById('modalPrizeValue').value = '';
            document.getElementById('modalPrizeCount').value = '0';  // „Éá„Éï„Ç©„É´„Éà„Çí0„Å´Â§âÊõ¥
            document.getElementById('modalPrizeImage').value = '';
            document.getElementById('modalPrizeWanted').checked = false;
            document.getElementById('modalSamePriceAsReward').checked = false;  // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('modalPrizeValue').disabled = false;  // ÈÇÑÂÖÉ‰æ°ÂÄ§„ÅÆÂÖ•Âäõ„ÇíÊúâÂäπÂåñ
            document.getElementById('modalImagePreview').style.display = 'none';
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÊñ∞Ë¶èÁôªÈå≤„Éï„Ç©„Éº„É†„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶„É™„Çπ„ÉàË°®Á§∫„Å´Êàª„Çã
        function hideModalNewPrizeForm() {
            // „Éï„Ç©„Éº„É†„ÇíÈùûË°®Á§∫
            document.getElementById('modalNewPrizeForm').style.display = 'none';

            // „É™„Çπ„Éà„Å®„Éï„Ç£„É´„Çø„Éº„Ç®„É™„Ç¢„ÇíË°®Á§∫
            document.getElementById('prizeMasterSelectList').style.display = 'block';
            document.getElementById('modalFilterArea').style.display = 'block';

            // „Éú„Çø„É≥„ÇíÂàá„ÇäÊõø„Åà
            document.getElementById('modalCancelBtn').style.display = 'inline-block';
            document.getElementById('modalNewPrizeBtn').style.display = 'inline-block';
            document.getElementById('modalFormCancelBtn').style.display = 'none';
            document.getElementById('modalFormSaveBtn').style.display = 'none';
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÁîªÂÉè„Éó„É¨„Éì„É•„Éº
        function previewModalImage(url) {
            const preview = document.getElementById('modalImagePreview');
            const previewImg = document.getElementById('modalImagePreviewImg');

            if (url && url.trim()) {
                previewImg.src = url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // „ÄåÊôØÂìÅ‰æ°Ê†º„Å®ÂêåÈ°ç„Å´„Åô„Çã„Äç„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂá¶ÁêÜ
        function handleSamePriceAsRewardChange() {
            const checkbox = document.getElementById('modalSamePriceAsReward');
            const purchasePrice = document.getElementById('modalPurchasePrice').value;
            const rewardValueInput = document.getElementById('modalPrizeValue');

            if (checkbox.checked && purchasePrice) {
                // „ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ‰ªïÂÖ•„Çå‰æ°Ê†º„ÇíÈÇÑÂÖÉ‰æ°ÂÄ§„Å´„Ç≥„Éî„Éº
                rewardValueInput.value = purchasePrice;
                rewardValueInput.disabled = true;
            } else {
                // „ÉÅ„Çß„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„ÅüÂ†¥Âêà„ÄÅÈÇÑÂÖÉ‰æ°ÂÄ§„ÅÆÂÖ•Âäõ„ÇíÊúâÂäπÂåñ
                rewardValueInput.disabled = false;
            }
        }

        // ‰ªïÂÖ•„Çå‰æ°Ê†º„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÊôÇ„ÄÅ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅåON„Å™„ÇâÈÇÑÂÖÉ‰æ°ÂÄ§„ÇÇÊõ¥Êñ∞
        function updateModalRewardValueIfSame() {
            const checkbox = document.getElementById('modalSamePriceAsReward');
            const purchasePrice = document.getElementById('modalPurchasePrice').value;
            const rewardValueInput = document.getElementById('modalPrizeValue');

            if (checkbox && checkbox.checked) {
                rewardValueInput.value = purchasePrice;
            }
        }

        // „É¢„Éº„ÉÄ„É´„Åã„ÇâÊñ∞Ë¶èÊôØÂìÅ„ÇíÁôªÈå≤
        function saveModalNewPrize() {
            const name = document.getElementById('modalPrizeName').value.trim();
            const type = document.getElementById('modalPrizeType').value;
            const purchasePrice = parseFormattedNumber(document.getElementById('modalPurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('modalPrizeValue').value);
            const count = parseInt(document.getElementById('modalPrizeCount').value) || 0;
            const image = document.getElementById('modalPrizeImage').value.trim();
            const isWanted = document.getElementById('modalPrizeWanted').checked;

            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!name || purchasePrice <= 0 || value <= 0 || isNaN(count) || count < 0) {
                alert('ÂøÖÈ†àÈ†ÖÁõÆ„Çí„Åô„Åπ„Å¶Ê≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ËøΩÂä†
            const newPrize = {
                id: Date.now(),
                name: name,
                type: type,
                purchasePrice: purchasePrice,
                value: value,
                count: count,
                image: image || null,
                isWanted: isWanted
            };

            prizeMaster.push(newPrize);
            savePrizeMaster();
            updatePrizeMasterList();

            // „ÇØ„É©„Ç¶„ÉâÂêåÊúü
            syncPrizeMasterToCloud();

            // ÁôªÈå≤„Åó„ÅüÊôØÂìÅ„Çí„É°„Ç§„É≥„Éï„Ç©„Éº„É†„Å´Ëá™ÂãïÈÅ∏ÊäûÔºà„É¢„Éº„ÉÄ„É´„ÇÇËá™Âãï„ÅßÈñâ„Åò„Çâ„Çå„ÇãÔºâ
            selectPrizeFromMasterForMain(newPrize.id);

            // ÊàêÂäüÈÄöÁü•„ÇíË°®Á§∫
            showNotification(`‚úÖ ÊôØÂìÅ„Äå${name}„Äç„ÇíÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ÁôªÈå≤„Åó„Åæ„Åó„ÅüÔºÅ`, 'success');
        }

        // ÊôØÂìÅ„É™„Çπ„ÉàÊõ¥Êñ∞
        function updatePrizeList() {
            const container = document.getElementById('prizeList');

            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">ÊôØÂìÅ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                return;
            }

            // ÈÇÑÂÖÉ„Éù„Ç§„É≥„ÉàÈ†Ü„Å´„ÇΩ„Éº„ÉàÔºàÈôçÈ†ÜÔºâ
            prizes.sort((a, b) => b.value - a.value);

            container.innerHTML = prizes.map(prize => {
                const imageHtml = prize.image
                    ? `<img src="${prize.image}"
                           alt="${prize.name}"
                           style="width: 60px; height: 90px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); margin-right: 12px;"
                           onerror="this.style.display='none';">`
                    : `<div style="width: 60px; height: 90px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 12px;">üì¶</div>`;

                // Âú®Â∫´Áä∂Ê≥Å„Éê„ÉÉ„Ç∏
                let stockBadge = '';
                const masterPrize = prizeMaster.find(p => p.name === prize.name);
                if (masterPrize) {
                    if (masterPrize.count > 0) {
                        stockBadge = `<span style="display: inline-block; background: rgba(52, 199, 89, 0.15); color: #34C759; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; font-weight: 600;">Âú®Â∫´„ÅÇ„Çä (${masterPrize.count}ÂÄã)</span>`;
                    } else {
                        stockBadge = '<span style="display: inline-block; background: rgba(255, 59, 48, 0.15); color: #FF3B30; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; font-weight: 600;">Âú®Â∫´„Å™„Åó</span>';
                    }
                }

                // ÊôØÂìÅ„Çø„Ç§„Éó„ÅÆ„Éê„ÉÉ„Ç∏
                let prizeTypeBadge = '';
                if (prize.prizeType === 'lastOne') {
                    prizeTypeBadge = '<span style="display: inline-block; background: var(--sf-blue); color: white; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; font-weight: 600;">üéØ „É©„Çπ„Éà„ÉØ„É≥Ë≥û</span>';
                } else if (prize.prizeType === 'milestone') {
                    prizeTypeBadge = '<span style="display: inline-block; background: var(--sf-purple); color: white; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; font-weight: 600;">üéä „Ç≠„É™Áï™Ë≥û</span>';
                }

                return `
                <div class="prize-item" style="display: flex; align-items: flex-start; gap: 12px;">
                    ${imageHtml}
                    <div style="flex: 1; min-width: 0;">
                        <div class="prize-rank rank-${prize.rank}">${prize.rank}Á≠â</div>
                        <div class="prize-content">
                            <div class="prize-name">${prize.name}${stockBadge}${prizeTypeBadge}</div>
                            <div class="prize-info" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                                <span class="prize-purchase">‰ªïÂÖ•¬•${formatNumber(prize.purchasePrice)}</span>
                                <span class="prize-value">ÈÇÑÂÖÉ¬•${formatNumber(prize.value)}</span>
                                <span class="prize-count">${formatNumber(prize.count)}Êûö</span>
                                <div style="display: flex; gap: 8px; margin-left: auto;">
                                    <button class="btn btn-primary btn-sm" onclick="editPrize(${prize.id})">Á∑®ÈõÜ</button>
                                    <button class="btn btn-danger btn-sm" onclick="removePrize(${prize.id})">ÂâäÈô§</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // ========== ÁüõÁõæ„Ç®„É©„ÉºË°®Á§∫Èñ¢Êï∞ ==========

        function showConflictError(errorData) {
            let message = '';
            let suggestions = '';

            if (errorData.type === 'count_overflow') {
                message = `‚ö†Ô∏è ÊûöÊï∞„ÅåÂêà„ÅÑ„Åæ„Åõ„Çì\n\n` +
                    `ÊôØÂìÅÊûöÊï∞Ôºö${formatNumber(errorData.prizesTotalCount)}Êûö\n` +
                    `„Éè„Ç∫„É¨ÊûöÊï∞Ôºö${formatNumber(errorData.manualLossTotalCount)}Êûö\n` +
                    `ÂêàË®àÔºö${formatNumber(errorData.prizesTotalCount + errorData.manualLossTotalCount)}Êûö\n\n` +
                    `Á∑èÂè£Êï∞Ôºö${formatNumber(errorData.totalPacks)}Âè£\n` +
                    `Ë∂ÖÈÅéÊûöÊï∞Ôºö${formatNumber(errorData.excess)}Êûö\n\n`;

                suggestions = `üìã ‰ª£ÊõøÊ°àÔºö\n\n` +
                    `1Ô∏è‚É£ Á∑èÂè£Êï∞„Çí${formatNumber(errorData.prizesTotalCount + errorData.manualLossTotalCount)}Âè£„Å´Â¢ó„ÇÑ„Åô\n\n` +
                    `2Ô∏è‚É£ „Éè„Ç∫„É¨ÊûöÊï∞„Çí${formatNumber(errorData.excess)}ÊûöÊ∏õ„Çâ„Åô\n\n` +
                    `3Ô∏è‚É£ ÊôØÂìÅÊûöÊï∞„Çí${formatNumber(errorData.excess)}ÊûöÊ∏õ„Çâ„Åô`;

            } else if (errorData.type === 'count_shortage') {
                message = `‚ö†Ô∏è ÊûöÊï∞„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô\n\n` +
                    `ÊôØÂìÅÊûöÊï∞Ôºö${formatNumber(errorData.prizesTotalCount)}Êûö\n` +
                    `„Éè„Ç∫„É¨ÊûöÊï∞Ôºö${formatNumber(errorData.manualLossTotalCount)}Êûö\n` +
                    `ÂêàË®àÔºö${formatNumber(errorData.prizesTotalCount + errorData.manualLossTotalCount)}Êûö\n\n` +
                    `Á∑èÂè£Êï∞Ôºö${formatNumber(errorData.totalPacks)}Âè£\n` +
                    `‰∏çË∂≥ÊûöÊï∞Ôºö${formatNumber(errorData.shortage)}Êûö\n\n`;

                suggestions = `üìã ‰ª£ÊõøÊ°àÔºö\n\n` +
                    `1Ô∏è‚É£ Á∑èÂè£Êï∞„Çí${formatNumber(errorData.prizesTotalCount + errorData.manualLossTotalCount)}Âè£„Å´Ê∏õ„Çâ„Åô\n\n` +
                    `2Ô∏è‚É£ „Éè„Ç∫„É¨ÊûöÊï∞„Çí${formatNumber(errorData.shortage)}ÊûöÂ¢ó„ÇÑ„Åô\n\n` +
                    `3Ô∏è‚É£ ÊôØÂìÅÊûöÊï∞„Çí${formatNumber(errorData.shortage)}ÊûöÂ¢ó„ÇÑ„Åô\n\n` +
                    `4Ô∏è‚É£ „Éè„Ç∫„É¨„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Å¶Ëá™ÂãïË®àÁÆó„Å´Âàá„ÇäÊõø„Åà„Çã`;
            }

            alert(message + suggestions);
        }

        // ========== „Éè„Ç∫„É¨ÁÆ°ÁêÜÈñ¢Êï∞ ==========

        // „Éè„Ç∫„É¨ËøΩÂä†
        function addLoss() {
            if (editingLossId) {
                alert('Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„Åß„Åô„ÄÇÂÖà„Å´„Äå„Ç≠„É£„É≥„Çª„É´„Äç„Åæ„Åü„ÅØ„Äå„Éè„Ç∫„É¨„ÇíÊõ¥Êñ∞„Äç„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const name = document.getElementById('lossName').value.trim();
            const value = parseInt(document.getElementById('lossValue').value) || 0;
            const count = parseInt(document.getElementById('lossCount').value) || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const loss = {
                id: Date.now(),
                name: name,
                value: value,
                count: count
            };

            losses.push(loss);

            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('lossName').value = '';
            document.getElementById('lossValue').value = '';
            document.getElementById('lossCount').value = '1';

            updateLossList();
            saveData();

            // „É™„Ç¢„É´„Çø„Ç§„É†Ë®àÁÆó
            calculate();
        }

        // „Éè„Ç∫„É¨ÂâäÈô§
        function removeLoss(id) {
            losses = losses.filter(l => l.id !== id);
            updateLossList();
            saveData();

            // „É™„Ç¢„É´„Çø„Ç§„É†Ë®àÁÆó
            calculate();
        }

        // „Éè„Ç∫„É¨Á∑®ÈõÜ
        function editLoss(id) {
            const loss = losses.find(l => l.id === id);
            if (!loss) return;

            document.getElementById('lossName').value = loss.name;
            document.getElementById('lossValue').value = loss.value;
            document.getElementById('lossCount').value = loss.count;

            editingLossId = id;

            document.getElementById('addLossBtn').style.display = 'none';
            document.getElementById('updateLossBtn').style.display = 'inline-block';
            document.getElementById('cancelEditLossBtn').style.display = 'inline-block';

            document.getElementById('lossName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // „Éè„Ç∫„É¨Êõ¥Êñ∞
        function updateLoss() {
            if (!editingLossId) return;

            const name = document.getElementById('lossName').value.trim();
            const value = parseInt(document.getElementById('lossValue').value) || 0;
            const count = parseInt(document.getElementById('lossCount').value) || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const lossIndex = losses.findIndex(l => l.id === editingLossId);
            if (lossIndex !== -1) {
                losses[lossIndex] = {
                    id: editingLossId,
                    name: name,
                    value: value,
                    count: count
                };
            }

            cancelEditLoss();
            updateLossList();
            saveData();

            // „É™„Ç¢„É´„Çø„Ç§„É†Ë®àÁÆó
            calculate();
        }

        // „Éè„Ç∫„É¨Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´
        function cancelEditLoss() {
            editingLossId = null;

            document.getElementById('lossName').value = '';
            document.getElementById('lossValue').value = '';
            document.getElementById('lossCount').value = '1';

            document.getElementById('addLossBtn').style.display = 'inline-block';
            document.getElementById('updateLossBtn').style.display = 'none';
            document.getElementById('cancelEditLossBtn').style.display = 'none';
        }


        // „Éè„Ç∫„É¨„É™„Çπ„ÉàÊõ¥Êñ∞
        function updateLossList() {
            const container = document.getElementById('lossList');

            if (losses.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">„Éè„Ç∫„É¨„ÇíËøΩÂä†„Åô„Çã„Å®ÊâãÂãïË®≠ÂÆö„Åß„Åç„Åæ„Åô</p>';
                return;
            }

            container.innerHTML = losses.map(loss => `
                <div class="prize-item" style="background: rgba(255, 149, 0, 0.1); border-color: var(--sf-orange);">
                    <div class="prize-content" style="grid-template-columns: 2fr 1fr 1fr auto; margin-top: 8px;">
                        <div class="prize-name">${loss.name}</div>
                        <div class="prize-value">¬•${formatNumber(loss.value)}</div>
                        <div class="prize-count">${formatNumber(loss.count)}Êûö</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="editLoss(${loss.id})">Á∑®ÈõÜ</button>
                            <button class="btn btn-danger" onclick="removeLoss(${loss.id})">ÂâäÈô§</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ÂÄ§„Çí10„ÅÆ‰Ωç„Åß‰∏∏„ÇÅ„ÇãÔºà1Ê°Å„Çí0„Å´„Åô„ÇãÔºâ
        function roundToTens(value) {
            return Math.round(value / 10) * 10;
        }


        // „Ç¨„ÉÅ„É£Èõ£ÊòìÂ∫¶Ë®≠ÂÆö„ÇíÂèñÂæó
        function getDifficultySettings(difficulty) {
            switch(difficulty) {
                case 'easy':
                    return {
                        name: 'ÊØîËºÉÁöÑÂΩì„Åü„Çä„ÇÑ„Åô„ÅÑ',
                        description: '„Éè„Ç∫„É¨„ÅÆ‰æ°ÂÄ§„ÅåÈ´ò„ÇÅ„Åß„ÄÅ„É¶„Éº„Ç∂„Éº„Éï„É¨„É≥„Éâ„É™„Éº„Å™Ë®≠Ë®à',
                        lossDistribution: [0.4, 0.35, 0.25], // È´òÈÇÑÂÖÉÈáçË¶ñ
                        maxValueCap: 0.8 // „Éë„ÉÉ„ÇØÂçò‰æ°„ÅÆ80%„Åæ„Åß
                    };
                case 'hard':
                    return {
                        name: 'ÂΩì„Åü„Çä„Å´„Åè„ÅÑ',
                        description: '„Éè„Ç∫„É¨„ÅÆ‰æ°ÂÄ§„Åå‰Ωé„ÇÅ„Åß„ÄÅÂ§ßÂΩì„Åü„ÇäÈáçË¶ñ„ÅÆË®≠Ë®à',
                        lossDistribution: [0.15, 0.35, 0.5], // ‰ΩéÈÇÑÂÖÉÈáçË¶ñ
                        maxValueCap: 0.5 // „Éë„ÉÉ„ÇØÂçò‰æ°„ÅÆ50%„Åæ„Åß
                    };
                default: // normal
                    return {
                        name: 'ÊôÆÈÄö',
                        description: '„Éê„É©„É≥„Çπ„ÅÆËâØ„ÅÑÊ®ôÊ∫ñÁöÑ„Å™Ë®≠Ë®à',
                        lossDistribution: [0.2, 0.5, 0.3], // „Éê„É©„É≥„ÇπÈáçË¶ñ
                        maxValueCap: 0.7 // „Éë„ÉÉ„ÇØÂçò‰æ°„ÅÆ70%„Åæ„Åß
                    };
            }
        }

        // ÂÖ®Ë®≠ÂÆö„Çí„ÇØ„É™„Ç¢„Åó„Å¶Êñ∞Ë¶è„Ç™„É™„Éë‰ΩúÊàê„ÇíÈñãÂßã
        function clearAllSettings() {
            // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
            const confirmed = confirm('ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂÖ®„Å¶„ÇØ„É™„Ç¢„Åó„Å¶„ÄÅÊñ∞„Åó„ÅÑ„Ç™„É™„Éë„ÅÆ‰ΩúÊàê„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºü\n\n‰ª•‰∏ã„ÅÆÈ†ÖÁõÆ„Åå„ÇØ„É™„Ç¢„Åï„Çå„Åæ„ÅôÔºö\n‚Ä¢ „Ç™„É™„ÉëÂêç\n‚Ä¢ „Éë„ÉÉ„ÇØÂçò‰æ°„ÉªÁ∑èÂè£Êï∞\n‚Ä¢ „É°„É¢\n‚Ä¢ ÊôØÂìÅ„É™„Çπ„Éà\n‚Ä¢ „Éè„Ç∫„É¨„É™„Çπ„Éà\n‚Ä¢ Ë®àÁÆóÁµêÊûú\n\n‚Äª„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠òÊ∏à„Åø„ÅÆ„Éá„Éº„Çø„ÅØÂâäÈô§„Åï„Çå„Åæ„Åõ„Çì');

            if (!confirmed) {
                return;
            }

            // Âü∫Êú¨Ë®≠ÂÆö„Çí„ÇØ„É™„Ç¢
            document.getElementById('cloudConfigName').value = '';
            document.getElementById('packPrice').value = '40000';
            document.getElementById('totalPacks').value = '100';
            document.getElementById('configMemo').value = '';
            document.getElementById('minGuaranteeValue').value = '1';
            document.getElementById('enableMinGuaranteeAuto').checked = false;

            // ÊôØÂìÅ„É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
            prizes = [];
            updatePrizeList();

            // „Éè„Ç∫„É¨„É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
            losses = [];
            updateLossList();

            // Ë®àÁÆóÁµêÊûú„Çí„ÇØ„É™„Ç¢
            document.getElementById('totalValue').textContent = '¬•0';
            document.getElementById('summaryTotalReturn').textContent = '0.0%';
            document.getElementById('summaryRealReturn').textContent = '0.0%';
            document.getElementById('summaryWinnerCount').textContent = '0‰∫∫';
            document.getElementById('summaryTotalPurchase').textContent = '¬•0';
            document.getElementById('summaryPrizeTotalReward').textContent = '¬•0';
            document.getElementById('summaryLossTotalReward').textContent = '¬•0';
            document.getElementById('prizeDetails').innerHTML = '<p style="color: var(--sf-gray); text-align: center;">ÊôØÂìÅ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
            document.getElementById('lossDetails').innerHTML = '<p style="color: var(--sf-gray); text-align: center;">„Éè„Ç∫„É¨„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';

            // ÊúüÂæÖÂÄ§„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢
            const simulationResults = document.getElementById('simulationResults');
            if (simulationResults) {
                simulationResults.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">Ë®àÁÆó„ÇíÂÆüË°å„Åô„Çã„Å®Ë°®Á§∫„Åï„Çå„Åæ„Åô</p>';
            }

            // „Ç∞„É©„Éï„Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
            const canvas = document.getElementById('expectationCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            // ÂÖ±Êúâ„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            updateShareButtonState();

            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
            saveData();

            // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§„ÇíÊõ¥Êñ∞
            updateTotalValue();

            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            alert('‚úÖ ÂÖ®„Å¶„ÅÆË®≠ÂÆö„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ\nÊñ∞„Åó„ÅÑ„Ç™„É™„Éë„ÅÆ‰ΩúÊàê„ÇíÈñãÂßã„Åß„Åç„Åæ„ÅôÔºÅ');
        }

        // „É°„Ç§„É≥Ë®àÁÆó
        function calculate() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;

            if (packPrice <= 0 || totalPacks <= 0) {
                return;
            }

            // Âü∫Êú¨Ë®àÁÆó
            const totalValue = packPrice * totalPacks;

            // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§Ë°®Á§∫
            document.getElementById('totalValue').textContent = `¬•${formatNumber(totalValue)}`;

            // ÈÄöÂ∏∏ÊôØÂìÅ„Å®ÁâπÂà•ÊôØÂìÅÔºà„É©„Çπ„Éà„ÉØ„É≥Ë≥û„ÄÅ„Ç≠„É™Áï™Ë≥ûÔºâ„ÇíÂàÜÈõ¢
            const normalPrizes = prizes.filter(p => !p.prizeType || p.prizeType === 'normal');
            const specialPrizes = prizes.filter(p => p.prizeType === 'lastOne' || p.prizeType === 'milestone');

            // ÊôØÂìÅÁ∑è‰æ°ÂÄ§Ë®àÁÆóÔºà„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§Ôºâ- ÂÖ®„Å¶„ÅÆÊôØÂìÅ„ÇíÂê´„ÇÄ
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);

            // ÊôØÂìÅÁ∑èÊï∞Ë®àÁÆóÔºàÊäΩÈÅ∏„Éó„Éº„É´„Å´ÂÖ•„ÇãÈÄöÂ∏∏ÊôØÂìÅ„ÅÆ„ÅøÔºâ
            const prizesTotalCount = normalPrizes.reduce((sum, prize) => sum + prize.count, 0);

            // ÊôØÂìÅÁ∑è‰ªïÂÖ•„Çå‰æ°Ê†ºË®àÁÆóÔºàÂÖ®„Å¶„ÅÆÊôØÂìÅ„ÇíÂê´„ÇÄÔºöÈÄöÂ∏∏ÊôØÂìÅ + ÁâπÂà•ÊôØÂìÅÔºâ
            const prizesTotalPurchasePrice = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);

            // ÁâπÂà•ÊôØÂìÅ„ÅÆÊÉÖÂ†±Ôºà„É©„Çπ„Éà„ÉØ„É≥Ë≥û„ÄÅ„Ç≠„É™Áï™Ë≥ûÔºâ
            const specialPrizesTotalValue = specialPrizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const specialPrizesTotalPurchasePrice = specialPrizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);
            const specialPrizesCount = specialPrizes.reduce((sum, prize) => sum + prize.count, 0);

            // ÂÆüË≥™ÈÇÑÂÖÉÁéáË®àÁÆóÔºà‰ªïÂÖ•„Çå‰æ°Ê†º„Éô„Éº„ÇπÔºâ
            const realReturnRate = totalValue > 0 ? (prizesTotalPurchasePrice / totalValue) * 100 : 0;

            // „Éè„Ç∫„É¨Ë®àÁÆóÔºàÊâãÂãïË®≠ÂÆö or Ëá™ÂãïË®àÁÆóÔºâ
            const remainingSlots = totalPacks - prizesTotalCount;
            let lossTypes = [];
            const enableMinGuaranteeAuto = document.getElementById('enableMinGuaranteeAuto')?.checked || false;

            // ÊâãÂãï„Åß„Éè„Ç∫„É¨„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
            if (losses.length > 0) {
                const manualLossTotalCount = losses.reduce((sum, loss) => sum + loss.count, 0);

                // ÊúÄ‰Ωé‰øùË®ºËá™ÂãïË®àÁÆó„ÅåON„ÅÆÂ†¥Âêà
                if (enableMinGuaranteeAuto) {
                    // ÁüõÁõæ„ÉÅ„Çß„ÉÉ„ÇØ: ÊôØÂìÅÊûöÊï∞ + ÊâãÂãï„Éè„Ç∫„É¨ÊûöÊï∞ > Á∑èÂè£Êï∞
                    if (prizesTotalCount + manualLossTotalCount > totalPacks) {
                        showConflictError({
                            type: 'count_overflow',
                            prizesTotalCount,
                            manualLossTotalCount,
                            totalPacks,
                            excess: (prizesTotalCount + manualLossTotalCount) - totalPacks
                        });
                        return;
                    }

                    // ÊâãÂãï„Éè„Ç∫„É¨„ÇílossTypes„Å´ËøΩÂä†
                    lossTypes = losses.map(loss => ({
                        name: loss.name,
                        value: loss.value,
                        count: loss.count,
                        type: 'manual'
                    }));

                    // ÊÆã„Çä„ÅÆÂè£Êï∞„ÇíÊúÄ‰Ωé‰øùË®º„ÅßÂüã„ÇÅ„Çã
                    const autoLossCount = totalPacks - prizesTotalCount - manualLossTotalCount;
                    if (autoLossCount > 0) {
                        const adjustedMinValue = Math.max(1, Math.round(minGuaranteeValue));
                        lossTypes.push({
                            name: `„Éè„Ç∫„É¨ÔºàÊúÄ‰Ωé‰øùË®ºÔºâ`,
                            value: adjustedMinValue,
                            count: autoLossCount,
                            type: 'auto'
                        });
                    }

                } else {
                    // ÊúÄ‰Ωé‰øùË®ºËá™ÂãïË®àÁÆó„ÅåOFF„ÅÆÂ†¥Âêà„ÅØ„ÄÅÂæìÊù•ÈÄö„Çä„ÅÆÂãï‰Ωú
                    // ÁüõÁõæ„ÉÅ„Çß„ÉÉ„ÇØ1: ÊôØÂìÅÊûöÊï∞ + ÊâãÂãï„Éè„Ç∫„É¨ÊûöÊï∞ > Á∑èÂè£Êï∞
                    if (prizesTotalCount + manualLossTotalCount > totalPacks) {
                        showConflictError({
                            type: 'count_overflow',
                            prizesTotalCount,
                            manualLossTotalCount,
                            totalPacks,
                            excess: (prizesTotalCount + manualLossTotalCount) - totalPacks
                        });
                        return;
                    }

                    // ÁüõÁõæ„ÉÅ„Çß„ÉÉ„ÇØ2: ÊôØÂìÅÊûöÊï∞ + ÊâãÂãï„Éè„Ç∫„É¨ÊûöÊï∞ < Á∑èÂè£Êï∞
                    if (prizesTotalCount + manualLossTotalCount < totalPacks) {
                        showConflictError({
                            type: 'count_shortage',
                            prizesTotalCount,
                            manualLossTotalCount,
                            totalPacks,
                            shortage: totalPacks - (prizesTotalCount + manualLossTotalCount)
                        });
                        return;
                    }

                    // ÊâãÂãï„Éè„Ç∫„É¨„ÇílossTypes„Å´Â§âÊèõ
                    lossTypes = losses.map(loss => ({
                        name: loss.name,
                        value: loss.value,
                        count: loss.count,
                        type: 'manual'
                    }));
                }

            } else {
                // Ëá™ÂãïË®àÁÆó„É¢„Éº„Éâ
                if (remainingSlots <= 0) {
                    if (!validateSettings()) {
                        return;
                    }
                }

                if (remainingSlots > 0) {
                    // ÊúÄ‰Ωé‰øùË®º‰æ°ÂÄ§„ÅßËá™ÂãïË®àÁÆó
                    const adjustedMinValue = Math.max(1, Math.round(minGuaranteeValue));

                    lossTypes.push({
                        name: `„Éè„Ç∫„É¨ÔºàÊúÄ‰Ωé‰øùË®ºÔºâ`,
                        value: adjustedMinValue,
                        count: remainingSlots,
                        type: 'auto'
                    });
                }
            }

            // ÊúüÂæÖÂÄ§Ë®àÁÆóÔºàÊäΩÈÅ∏„Éó„Éº„É´„ÅÆÈÄöÂ∏∏ÊôØÂìÅ„ÅÆ„ÅøÔºâ
            let expectedValue = normalPrizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (prize.value * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                expectedValue += loss.value * probability;
            });

            // Ê®ôÊ∫ñÂÅèÂ∑ÆË®àÁÆóÔºàÊäΩÈÅ∏„Éó„Éº„É´„ÅÆÈÄöÂ∏∏ÊôØÂìÅ„ÅÆ„ÅøÔºâ
            let variance = normalPrizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (Math.pow(prize.value - expectedValue, 2) * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                variance += Math.pow(loss.value - expectedValue, 2) * probability;
            });

            const stdDev = Math.sqrt(variance);

            // Á∑èÈÇÑÂÖÉÁéá„ÇíË®àÁÆóÔºàÊôØÂìÅ + „Éè„Ç∫„É¨„ÅÆÂêàË®à„Åã„ÇâÁÆóÂá∫Ôºâ
            const lossTotalValue = lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0);
            const actualTotalReturnValue = prizesTotalValue + lossTotalValue;
            const totalReturnRatePercent = totalValue > 0 ? (actualTotalReturnValue / totalValue) * 100 : 0;

            // „Éè„Ç∫„É¨„ÅÆÁ∑èÊï∞„ÇíË®àÁÆó
            const lossCount = lossTypes.reduce((sum, loss) => sum + loss.count, 0);

            // ÁµêÊûúË°®Á§∫Êõ¥Êñ∞
            updateResults({
                totalReturnRatePercent,
                realReturnRate,
                expectedValue,
                stdDev,
                lossTypes,
                lossCount,
                totalPacks,
                packPrice
            });
        }

        // Ë≠¶ÂëäË°®Á§∫Ê∏à„Åø„Éï„É©„Ç∞
        let lastWarningRealReturnRate = 0;

        // ÁµêÊûúË°®Á§∫Êõ¥Êñ∞
        function updateResults(data) {
            document.getElementById('summaryTotalReturn').textContent = `${data.totalReturnRatePercent.toFixed(1)}%`;
            document.getElementById('summaryRealReturn').textContent = `${data.realReturnRate.toFixed(1)}%`;

            // ÂÆüË≥™ÈÇÑÂÖÉÁéáÔºàÂ£≤‰∏äÂéü‰æ°ÁéáÔºâ„Åå50ÔºÖ„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÅÆË≠¶Âëä
            // ÂÄ§„ÅåÂ§â„Çè„Å£„ÅüÂ†¥Âêà„ÅÆ„ÅøË≠¶Âëä„ÇíË°®Á§∫Ôºà0.1%‰ª•‰∏ä„ÅÆÂ§âÂåñ„ÅßË≠¶ÂëäÔºâ
            if (data.realReturnRate > 50 && Math.abs(data.realReturnRate - lastWarningRealReturnRate) > 0.1) {
                lastWarningRealReturnRate = data.realReturnRate;
                showCustomAlert(
                    `ÁèæÂú®„ÅÆÂÆüË≥™ÈÇÑÂÖÉÁéáÔºàÂ£≤‰∏äÂéü‰æ°ÁéáÔºâ: ${data.realReturnRate.toFixed(1)}%\n\nÂ£≤‰∏äÂéü‰æ°Áéá„Åå50ÔºÖ„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n„Åì„ÅÆ„Åæ„Åæ„Åß„ÅØÂà©ÁõäÁéá„Åå‰Ωé„Åè„ÄÅ„Éì„Ç∏„Éç„Çπ„Å®„Åó„Å¶ÊàêÁ´ã„Åó„Å´„Åè„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n\nÊé®Â•®ÂØæÂøúÔºö\n‚Ä¢ ÊôØÂìÅ„ÅÆ‰ªïÂÖ•„Çå‰æ°Ê†º„ÇíË¶ãÁõ¥„Åô\n‚Ä¢ „Éë„ÉÉ„ÇØÂçò‰æ°„Çí‰∏ä„Åí„Çã\n‚Ä¢ È´òÈ°çÊôØÂìÅ„ÅÆÊûöÊï∞„ÇíÊ∏õ„Çâ„Åô`,
                    'Ë≠¶ÂëäÔºöÂ£≤‰∏äÂéü‰æ°Áéá„ÅåÈ´ò„Åô„Åé„Åæ„Åô',
                    '‚ö†Ô∏è'
                );
            } else if (data.realReturnRate <= 50) {
                // 50ÔºÖ‰ª•‰∏ã„Å´„Å™„Å£„Åü„Çâ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                lastWarningRealReturnRate = 0;
            }

            // Á∑èÂΩìÈÅ∏ËÄÖÊï∞„ÇíË°®Á§∫
            const totalWinners = prizes.reduce((sum, prize) => sum + prize.count, 0);
            document.getElementById('summaryWinnerCount').textContent = `${totalWinners}‰∫∫`;

            // Á∑è‰ªïÂÖ•„ÇåÈ°ç„ÇíË°®Á§∫
            const totalPurchaseAmount = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);
            document.getElementById('summaryTotalPurchase').textContent = `¬•${formatNumber(totalPurchaseAmount)}`;

            // ÂΩì„Åü„ÇäÊôØÂìÅÈÇÑÂÖÉÁ∑èÈ°ç„ÇíË°®Á§∫
            const prizeTotalReward = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            document.getElementById('summaryPrizeTotalReward').textContent = `¬•${formatNumber(prizeTotalReward)}`;

            // „Éè„Ç∫„É¨ÈÇÑÂÖÉÁ∑èÈ°ç„ÇíË°®Á§∫
            const lossTotalReward = data.lossTypes ? data.lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0) : 0;
            document.getElementById('summaryLossTotalReward').textContent = `¬•${formatNumber(lossTotalReward)}`;

            // ÊôØÂìÅË©≥Á¥∞Êõ¥Êñ∞
            updatePrizeDetails();

            // „Éè„Ç∫„É¨Ë©≥Á¥∞Êõ¥Êñ∞
            updateLossDetails(data.lossTypes, data.lossCount);
            
            // „Éè„Ç∫„É¨ÂàÜÂ∏É„ÉÅ„É£„Éº„ÉàÊõ¥Êñ∞
            drawLossDistributionChart(data.lossTypes);

            // Ë≠¶ÂëäË°®Á§∫„ÅÆÊõ¥Êñ∞
            updateWarnings(data);
        }

        // ÊôØÂìÅË©≥Á¥∞Êõ¥Êñ∞
        function updatePrizeDetails() {
            const container = document.getElementById('prizeDetails');

            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">ÊôØÂìÅ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                return;
            }

            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;

            // ÈÇÑÂÖÉ„Éù„Ç§„É≥„ÉàÈ†Ü„Å´„ÇΩ„Éº„ÉàÔºàÈôçÈ†ÜÔºâ
            const sortedPrizes = [...prizes].sort((a, b) => b.value - a.value);

            container.innerHTML = sortedPrizes.map(prize => {
                const probability = totalPacks > 0 ? (prize.count / totalPacks * 100).toFixed(2) : '0.00';
                const imageHtml = prize.image
                    ? `<img src="${prize.image}" alt="${prize.name}" style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.1); margin-right: 10px;" onerror="this.style.display='none';">`
                    : `<div style="width: 40px; height: 60px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.1); display: inline-flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 10px; vertical-align: middle;">üì¶</div>`;

                // ÊôØÂìÅ„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶„É©„Éô„É´„ÇíÂ§âÊõ¥
                let prizeLabel = '';
                if (prize.prizeType === 'lastOne') {
                    prizeLabel = '„É©„Çπ„Éà„ÉØ„É≥Ë≥û';
                } else if (prize.prizeType === 'milestone') {
                    prizeLabel = '„Ç≠„É™Áï™Ë≥û';
                } else {
                    prizeLabel = `${prize.rank}Á≠â`;
                }

                return `
                    <div class="result-row" style="display: flex; align-items: center;">
                        ${imageHtml}
                        <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                            <span class="result-label">${prizeLabel} ${prize.name}</span>
                            <span class="result-value">${formatNumber(prize.count)}Êûö / ${probability}% (‰ªïÂÖ•¬•${formatNumber(prize.purchasePrice)} / ÈÇÑÂÖÉ¬•${formatNumber(prize.value)})</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // „Éè„Ç∫„É¨Ë©≥Á¥∞Êõ¥Êñ∞
        function updateLossDetails(lossTypes, lossCount) {
            const container = document.getElementById('lossDetailsContainer');
            
            if (!lossTypes || lossTypes.length === 0) {
                container.innerHTML = '<div class="result-row"><span class="result-label">„Éè„Ç∫„É¨„Å™„Åó</span><span class="result-value">-</span></div>';
                document.getElementById('totalLossCount').textContent = '0Êûö';
                return;
            }

            container.innerHTML = lossTypes.map(loss => {
                const probability = lossCount > 0 ? ((loss.count / lossCount) * 100).toFixed(1) : '0.0';
                return `
                    <div class="result-row">
                        <span class="result-label">${loss.name}</span>
                        <span class="result-value">¬•${formatNumber(loss.value)} √ó ${formatNumber(loss.count)}Êûö (${probability}%)</span>
                    </div>
                `;
            }).join('');

            document.getElementById('totalLossCount').textContent = `${formatNumber(lossCount)}Êûö`;
        }



        // „Éè„Ç∫„É¨ÂΩìÈÅ∏ËÄÖÂàÜÂ∏É„ÉÅ„É£„Éº„ÉàÊèèÁîª
        function drawLossDistributionChart(lossTypes) {
            const canvas = document.getElementById('lossDistributionChart');
            const ctx = canvas.getContext('2d');
            
            // „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!lossTypes || lossTypes.length === 0) {
                ctx.fillStyle = '#8E8E93';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('„Éè„Ç∫„É¨„Å™„Åó', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const padding = 40;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF'];
            const total = lossTypes.reduce((sum, loss) => sum + loss.count, 0);
            
            if (total === 0) return;
            
            // Ê£í„Ç∞„É©„Éï„Å®„Åó„Å¶ÊèèÁîª
            const barWidth = width / lossTypes.length * 0.8;
            const barSpacing = width / lossTypes.length * 0.2;
            const maxCount = Math.max(...lossTypes.map(loss => loss.count));
            
            lossTypes.forEach((loss, index) => {
                const x = padding + index * (barWidth + barSpacing) + barSpacing / 2;
                const barHeight = (loss.count / maxCount) * height;
                const y = canvas.height - padding - barHeight;
                
                // Ê£í„ÇíÊèèÁîª
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // ÊûöÊï∞„ÇíË°®Á§∫
                ctx.fillStyle = '#000000';
                ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(loss.count + 'Êûö', x + barWidth / 2, y - 5);
                
                // ÂêçÂâç„ÇíË°®Á§∫
                ctx.fillText(loss.name, x + barWidth / 2, canvas.height - 10);
                
                // Ââ≤Âêà„ÇíË°®Á§∫
                const percentage = ((loss.count / total) * 100).toFixed(1);
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(percentage + '%', x + barWidth / 2, y + barHeight / 2);
            });
            
            // „ÉÅ„É£„Éº„Éà„Çø„Ç§„Éà„É´
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('„Éè„Ç∫„É¨ÂΩìÈÅ∏ËÄÖÂàÜÂ∏É', canvas.width / 2, 20);
        }

        // Ë®≠ÂÆöÊ§úË®º„Å®„Ç®„É©„ÉºË°®Á§∫
        function validateSettings() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // „Ç®„É©„ÉºÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('totalPacks').classList.remove('error');

            let hasError = false;
            let errorMessages = [];

            // ÊôØÂìÅÊûöÊï∞„ÅåÁ∑èÂè£Êï∞„ÇíË∂Ö„Åà„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (prizesTotalCount > totalPacks) {
                document.getElementById('totalPacks').classList.add('error');
                hasError = true;
                errorMessages.push(`ÊôØÂìÅ„ÅÆÁ∑èÊûöÊï∞Ôºà${formatNumber(prizesTotalCount)}ÊûöÔºâ„ÅåÁ∑èÂè£Êï∞Ôºà${formatNumber(totalPacks)}Âè£Ôºâ„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ`);
            }

            if (hasError) {
                showErrorPopup(errorMessages);
                return false;
            }

            return true;
        }

        // „Ç®„É©„Éº„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
        function showErrorPopup(messages) {
            const errorMessage = messages.join('\n\n');
            alert(`‚ö†Ô∏è Ë®≠ÂÆö„Å´„Ç®„É©„Éº„Åå„ÅÇ„Çä„Åæ„Åô\n\n${errorMessage}`);
        }

        // Ë≠¶ÂëäË°®Á§∫Êõ¥Êñ∞ÔºàËªΩÂæÆ„Å™Ë≠¶ÂëäÁî®Ôºâ
        function updateWarnings(data) {
            const warningsContainer = document.getElementById('warnings');
            const warnings = [];

            // ÂøÖË¶Å„Å´Âøú„Åò„Å¶Ë≠¶Âëä„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô

            warningsContainer.innerHTML = warnings.join('');
        }



        // „Éá„Éº„Çø‰øùÂ≠òÔºàÊôØÂìÅ„Å®„Éè„Ç∫„É¨Ôºâ
        function saveData() {
            const data = {
                prizes: prizes,
                losses: losses,
                settings: {
                    packPrice: document.getElementById('packPrice').value,
                    totalPacks: document.getElementById('totalPacks').value,
                    minGuaranteeValue: document.getElementById('minGuaranteeValue').value
                }
            };

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÔºàÊôØÂìÅ„Å®„Éè„Ç∫„É¨Ôºâ
        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);

                    if (data.prizes) {
                        prizes = data.prizes;
                        updatePrizeList();
                    }

                    if (data.losses) {
                        losses = data.losses;
                        updateLossList();
                    }

                    if (data.settings) {
                        document.getElementById('packPrice').value = data.settings.packPrice || '40000';
                        document.getElementById('totalPacks').value = data.settings.totalPacks || '100';
                        document.getElementById('minGuaranteeValue').value = data.settings.minGuaranteeValue || '1';
                    }
                }
            } catch (e) {
                console.error('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        // „Ç¨„ÉÅ„É£‰ΩìÈ®ìÊ©üËÉΩ
        let gachaDrawHistory = [];
        let gachaPool = [];

        // „Ç¨„ÉÅ„É£„Éó„Éº„É´ÁîüÊàê
        function generateGachaPool() {
            gachaPool = [];

            // Á∑èÂè£Êï∞„ÅÆ‰∏äÈôê„ÉÅ„Çß„ÉÉ„ÇØÔºà„É°„É¢„É™‰øùË≠∑Ôºâ
            const MAX_POOL_SIZE = 100000;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            if (totalPacks > MAX_POOL_SIZE) {
                console.warn(`‚ö†Ô∏è Á∑èÂè£Êï∞(${totalPacks})„Åå‰∏äÈôê(${MAX_POOL_SIZE})„ÇíË∂Ö„Åà„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ„Ç¨„ÉÅ„É£„Éó„Éº„É´„ÅÆÁîüÊàê„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô`);
                return;
            }

            // ÈÄöÂ∏∏ÊôØÂìÅ„ÅÆ„Åø„ÇíËøΩÂä†Ôºà„É©„Çπ„Éà„ÉØ„É≥Ë≥û„Å®„Ç≠„É™Áï™Ë≥û„ÅØÈô§Â§ñÔºâ
            const normalPrizes = prizes.filter(p => !p.prizeType || p.prizeType === 'normal');

            // ÊôØÂìÅÁ∑èÊï∞„ÉÅ„Çß„ÉÉ„ÇØÔºà„É°„É¢„É™‰øùË≠∑Ôºâ
            const prizesTotalCountCheck = normalPrizes.reduce((sum, prize) => sum + (prize.count || 0), 0);
            if (prizesTotalCountCheck > MAX_POOL_SIZE) {
                console.warn(`‚ö†Ô∏è ÊôØÂìÅÁ∑èÊï∞(${prizesTotalCountCheck})„Åå‰∏äÈôê(${MAX_POOL_SIZE})„ÇíË∂Ö„Åà„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ„Ç¨„ÉÅ„É£„Éó„Éº„É´„ÅÆÁîüÊàê„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô`);
                return;
            }

            normalPrizes.forEach(prize => {
                // ÂÄãÂà•„ÅÆÊôØÂìÅÊï∞„ÉÅ„Çß„ÉÉ„ÇØ
                const safeCount = Math.min(Math.max(0, prize.count || 0), MAX_POOL_SIZE);
                for (let i = 0; i < safeCount; i++) {
                    gachaPool.push({
                        type: 'prize',
                        item: prize
                    });
                }
            });

            // ÁèæÂú®„ÅÆË®≠ÂÆö„Åß„Éè„Ç∫„É¨„ÇíË®àÁÆóÔºàÊó¢„Å´totalPacks„ÅØ‰∏ä„ÅßÂÆöÁæ©Ê∏à„ÅøÔºâ
            const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;

            if (totalPacks > 0) {
                const prizesTotalCount = normalPrizes.reduce((sum, prize) => sum + prize.count, 0);
                let remainingSlots = totalPacks - prizesTotalCount;

                console.log('„Ç¨„ÉÅ„É£„Éó„Éº„É´ÁîüÊàê„Éá„Éê„ÉÉ„Ç∞:', {
                    totalPacks: totalPacks,
                    prizesTotalCount: prizesTotalCount,
                    remainingSlots
                });

                // ÊâãÂãï„Éè„Ç∫„É¨„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
                if (losses.length > 0) {
                    const manualLossCount = losses.reduce((sum, loss) => sum + (loss.count || 0), 0);
                    console.log('ÊâãÂãï„Éè„Ç∫„É¨ËøΩÂä†:', { count: manualLossCount });

                    losses.forEach(loss => {
                        // ÂÆâÂÖ®„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„Åç„Åß„É´„Éº„Éó
                        const safeLossCount = Math.min(Math.max(0, loss.count || 0), MAX_POOL_SIZE);
                        console.log(`${loss.name} ÁîüÊàê:`, { count: safeLossCount, value: loss.value });
                        for (let j = 0; j < safeLossCount; j++) {
                            gachaPool.push({
                                type: 'loss',
                                item: {
                                    name: loss.name,
                                    value: loss.value,
                                    rank: 'loss'
                                }
                            });
                        }
                    });

                    // ÊâãÂãï„Éè„Ç∫„É¨„ÇíËøΩÂä†„Åó„ÅüÂæå„ÅÆÊÆã„Çä„Çπ„É≠„ÉÉ„ÉàÊï∞„ÇíÂÜçË®àÁÆó
                    remainingSlots = remainingSlots - manualLossCount;
                    console.log('ÊâãÂãï„Éè„Ç∫„É¨ËøΩÂä†Âæå„ÅÆÊÆã„Çä„Çπ„É≠„ÉÉ„Éà:', remainingSlots);
                }

                // ÊÆã„Çä„Çπ„É≠„ÉÉ„Éà„ÇíÊúÄ‰Ωé‰øùË®º„ÅßÂüã„ÇÅ„Çã
                // Êù°‰ª∂: (1) ÊâãÂãï„Éè„Ç∫„É¨„Åå„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØ (2) „ÄåÊâãÂãï„Éè„Ç∫„É¨„Å®ÊúÄ‰Ωé‰øùË®º„Çí‰ΩµÁî®„Äç„ÅåON
                const enableMinGuaranteeAuto = document.getElementById('enableMinGuaranteeAuto')?.checked || false;
                const shouldFillWithMinGuarantee = (losses.length === 0) || enableMinGuaranteeAuto;

                if (remainingSlots > 0 && shouldFillWithMinGuarantee) {
                    const adjustedMinValue = Math.max(1, Math.round(minGuaranteeValue));
                    // ÂÆâÂÖ®„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„Åç„Åß„É´„Éº„Éó
                    const safeRemainingSlots = Math.min(Math.max(0, remainingSlots), MAX_POOL_SIZE);
                    console.log(`ÊúÄ‰Ωé‰øùË®º„Åß„Éè„Ç∫„É¨„ÇíËá™ÂãïÁîüÊàê: ${safeRemainingSlots}ÂÄã (‰æ°ÂÄ§: ${adjustedMinValue}ÂÜÜ)`);

                    for (let j = 0; j < safeRemainingSlots; j++) {
                        gachaPool.push({
                            type: 'loss',
                            item: {
                                name: '„Éè„Ç∫„É¨ÔºàÊúÄ‰Ωé‰øùË®ºÔºâ',
                                value: adjustedMinValue,
                                rank: 'loss'
                            }
                        });
                    }
                } else if (remainingSlots > 0) {
                    console.warn(`‚ö†Ô∏è ÊÆã„Çä${remainingSlots}„Çπ„É≠„ÉÉ„Éà„ÅåÊú™Ââ≤„ÇäÂΩì„Å¶„Åß„Åô„ÄÇ„Äåüí° ÊâãÂãï„Éè„Ç∫„É¨„Å®ÊúÄ‰Ωé‰øùË®º„Çí‰ΩµÁî®„Åô„Çã„Äç„ÇíON„Å´„Åô„Çã„Åì„Å®„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ`);
                } else if (remainingSlots < 0) {
                    console.error(`‚ùå „Ç®„É©„Éº: ÊôØÂìÅ„Å®„Éè„Ç∫„É¨„ÅÆÂêàË®à„ÅåÁ∑èÂè£Êï∞„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„ÅôÔºàË∂ÖÈÅéÊï∞: ${Math.abs(remainingSlots)}Ôºâ`);
                }
            }
            
            // „Éó„Éº„É´„Çí„Ç∑„É£„ÉÉ„Éï„É´
            for (let i = gachaPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gachaPool[i], gachaPool[j]] = [gachaPool[j], gachaPool[i]];
            }
            
            console.log('„Ç¨„ÉÅ„É£„Éó„Éº„É´ÁîüÊàêÂÆå‰∫Ü:', {
                totalItems: gachaPool.length,
                prizes: gachaPool.filter(item => item.type === 'prize').length,
                losses: gachaPool.filter(item => item.type === 'loss').length,
                expectedTotal: totalPacks
            });

            // ÊúÄÁµÇÁöÑ„Å™„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ
            if (gachaPool.length !== totalPacks) {
                console.error('„Ç¨„ÉÅ„É£„Éó„Éº„É´„Çµ„Ç§„Ç∫„Ç®„É©„Éº:', {
                    expected: totalPacks,
                    actual: gachaPool.length,
                    difference: gachaPool.length - totalPacks
                });
            }
        }

        // „Ç¨„ÉÅ„É£„ÇíÂºï„Åè
        function drawGacha(count) {
            if (gachaPool.length === 0) {
                alert('ÂÖà„Å´„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å„Çí„Åó„Å¶„Ç¨„ÉÅ„É£„ÅÆË®≠ÂÆö„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „Ç¨„ÉÅ„É£„Éó„Éº„É´„ÅÆ„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            if (gachaPool.length !== totalPacks) {
                console.warn('„Ç¨„ÉÅ„É£„Éó„Éº„É´„Çµ„Ç§„Ç∫„ÅåË®≠ÂÆö„Å®Áï∞„Å™„Çä„Åæ„Åô:', {
                    expected: totalPacks,
                    actual: gachaPool.length
                });
            }
            
            if (gachaPool.length < count) {
                alert(`ÊÆã„Çä${formatNumber(gachaPool.length)}Êûö„Åó„Åã„ÅÇ„Çä„Åæ„Åõ„Çì`);
                count = gachaPool.length;
            }
            
            const draws = [];
            for (let i = 0; i < count; i++) {
                if (gachaPool.length > 0) {
                    const drawnItem = gachaPool.shift();
                    console.log('„Ç¨„ÉÅ„É£ÁµêÊûú:', drawnItem);
                    draws.push(drawnItem);
                    gachaDrawHistory.push(drawnItem);
                }
            }
            
            updateGachaResults();
            
            // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÇíË°®Á§∫
            document.getElementById('resetGachaBtn').style.display = 'block';
            document.getElementById('gachaResults').style.display = 'block';
        }

        // „Ç¨„ÉÅ„É£ÁµêÊûú„ÇíÊõ¥Êñ∞
        function updateGachaResults() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            
            // Áµ±Ë®àË®àÁÆó
            const totalDraws = gachaDrawHistory.length;
            const prizeCount = gachaDrawHistory.filter(draw => draw.type === 'prize').length;
            const totalValue = gachaDrawHistory.reduce((sum, draw) => sum + draw.item.value, 0);
            const totalCost = totalDraws * packPrice;
            const profit = totalValue - totalCost;
            
            // Áµ±Ë®àË°®Á§∫
            document.getElementById('gachaStats').innerHTML = `
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${totalDraws}</div>
                    <div class="gacha-stat-label">Á∑èÂºï„ÅçÂõûÊï∞</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${prizeCount}</div>
                    <div class="gacha-stat-label">ÂΩìÈÅ∏ÂõûÊï∞</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">¬•${formatNumber(totalValue)}</div>
                    <div class="gacha-stat-label">Á∑èÈÇÑÂÖÉ‰æ°ÂÄ§</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value" style="color: ${profit >= 0 ? 'var(--sf-green)' : 'var(--sf-red)'}">
                        ${profit >= 0 ? '+' : ''}¬•${formatNumber(profit)}
                    </div>
                    <div class="gacha-stat-label">ÂèéÊîØ</div>
                </div>
            `;

            // Â±•Ê≠¥Ë°®Á§∫ÔºàÊúÄÊñ∞10‰ª∂Ôºâ
            const recentDraws = gachaDrawHistory.slice(-10).reverse();
            document.getElementById('gachaHistory').innerHTML = `
                <h5 style="margin-bottom: 10px;">ÊúÄÊñ∞„ÅÆÂºï„ÅçÁµêÊûú</h5>
                ${recentDraws.map(draw => `
                    <div class="gacha-draw-item ${draw.type === 'prize' ? 'gacha-draw-prize' : 'gacha-draw-loss'}">
                        <span>${draw.item.name}</span>
                        <span>¬•${formatNumber(draw.item.value)}</span>
                    </div>
                `).join('')}
            `;
        }

        // „Ç¨„ÉÅ„É£„É™„Çª„ÉÉ„Éà
        function resetGacha() {
            if (confirm('„Ç¨„ÉÅ„É£ÁµêÊûú„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                gachaDrawHistory = [];
                generateGachaPool();
                document.getElementById('resetGachaBtn').style.display = 'none';
                document.getElementById('gachaResults').style.display = 'none';
            }
        }

        // „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°åÊôÇ„Å´„Ç¨„ÉÅ„É£„Éó„Éº„É´„ÇÇÁîüÊàê
        const originalCalculate = calculate;
        calculate = function() {
            originalCalculate();
            generateGachaPool();
        };

        // ==================== „Çø„ÉñÊ©üËÉΩ ====================
        let currentTab = 'main';

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchTab(tabName, event) {
            currentTab = tabName;

            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„Å®„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ active „ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„ÅÆ„Éú„Çø„É≥„Å®„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Å´ active „ÇØ„É©„Çπ„ÇíËøΩÂä†
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // event„Åå„Å™„ÅÑÂ†¥ÂêàÔºà„Éó„É≠„Ç∞„É©„É†„Åã„ÇâÂëº„Å∞„Çå„ÅüÂ†¥ÂêàÔºâ„ÄÅÂØæÂøú„Åô„Çã„Éú„Çø„É≥„ÇíÊé¢„Åó„Å¶active„Å´„Åô„Çã
                const buttons = document.querySelectorAll('.tab-button');
                const tabNames = ['main', 'prize-list', 'temporary-prize-list', 'inventory-adjustment'];
                const index = tabNames.indexOf(tabName);
                if (index >= 0 && buttons[index]) {
                    buttons[index].classList.add('active');
                }
            }
            document.getElementById('tab-' + tabName).classList.add('active');

            // ÊôØÂìÅ‰∏ÄË¶ß„Çø„Éñ„ÅåË°®Á§∫„Åï„Çå„ÅüÊôÇ„ÅØÊôØÂìÅ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
            if (tabName === 'prize-list') {
                updatePrizeMasterList();
                // FirebaseË™çË®º„ÇíÈñãÂßãÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
                initializeAuth();
            }

            // Âú®Â∫´Ë™øÊï¥„Çø„Éñ„ÅåË°®Á§∫„Åï„Çå„ÅüÊôÇ
            if (tabName === 'inventory-adjustment') {
                // ‰ªïÂÖ•„ÇåÂ±•Ê≠¥„ÇíÂÜçÊèèÁîªÔºà„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂæ©ÂÖÉÔºâ
                const savedHistory = localStorage.getItem('procurementHistory');
                if (savedHistory) {
                    try {
                        procurementHistory = JSON.parse(savedHistory);
                        renderProcurementHistory();
                    } catch (e) {
                        console.error('‰ªïÂÖ•„ÇåÂ±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', e);
                    }
                }
            }
        }

        // ==================== ÊôØÂìÅ‰∏ÄË¶ßÊ©üËÉΩ ====================
        let editingMasterPrizeId = null; // Á∑®ÈõÜ‰∏≠„ÅÆÊôØÂìÅIDÔºàÊôØÂìÅ‰∏ÄË¶ßÁî®Ôºâ
        let prizeMaster = []; // ÊôØÂìÅ„Éû„Çπ„Çø„ÉºÔºà„ÇØ„É©„Ç¶„Éâ„Åã„ÇâÂèñÂæó„Åó„ÅüÂÖ®ÊôØÂìÅÔºâ
        const PRIZE_MASTER_STORAGE_KEY = 'oripa_prize_master_v1';

        // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíË™≠„ÅøËæº„Åø
        function loadPrizeMaster() {
            try {
                const savedData = localStorage.getItem(PRIZE_MASTER_STORAGE_KEY);
                if (savedData) {
                    prizeMaster = JSON.parse(savedData);
                }
            } catch (e) {
                console.error('ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Çí‰øùÂ≠òÔºàlocalStorage„Å®Firebase„ÅÆ‰∏°ÊñπÔºâ
        function savePrizeMaster() {
            try {
                // localStorage„Å´‰øùÂ≠òÔºà„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºâ
                localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));

                // Firebase„Å´‰øùÂ≠òÔºà„ÇØ„É©„Ç¶„ÉâÂÖ±ÊúâÔºâ
                savePrizeMasterToCloud();
            } catch (e) {
                console.error('ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíFirebase„Å´‰øùÂ≠ò
        function savePrizeMasterToCloud() {
            // „Åæ„ÅölocalStorage„Å´‰øùÂ≠òÔºàÂ∏∏„Å´ÂÆüË°åÔºâ
            try {
                localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));
                console.log('üíæ ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇílocalStorage„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            } catch (e) {
                console.error('‚ùå localStorage„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', e);
            }

            // Firebase„Å∏„ÅÆ‰øùÂ≠ò„ÇíË©¶Ë°å
            if (typeof database === 'undefined') {
                console.warn('‚ö†Ô∏è Firebase„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºàlocalStorage„ÅÆ„Åø‰øùÂ≠òÔºâ');
                updateSyncStatus('üíæ „É≠„Éº„Ç´„É´‰øùÂ≠òÊ∏à„Åø');
                return;
            }

            // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
            if (!isAuthReady) {
                console.log('‚è≥ FirebaseË™çË®º„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...');
                updateSyncStatus('‚è≥ Ë™çË®ºÂæÖ„Å°');
                waitForAuth(() => savePrizeMasterToCloud());
                return;
            }

            try {
                const data = {
                    prizes: prizeMaster,
                    updatedAt: Date.now(),
                    version: '1.0'
                };

                database.ref('prizeMaster').set(data).then(() => {
                    console.log('‚úÖ ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                    updateSyncStatus('‚úÖ „ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠òÊ∏à„Åø');
                }).catch((error) => {
                    console.error('‚ùå Firebase„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error.code || error.message);

                    if (error.code === 'PERMISSION_DENIED') {
                        console.warn('‚ö†Ô∏è „ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„ÅÆÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºàlocalStorage„Å´„ÅØ‰øùÂ≠òÊ∏à„ÅøÔºâ');
                        console.info('üí° Firebase Console„Åß„Éá„Éº„Çø„Éô„Éº„Çπ„É´„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                        console.info('„É´„Éº„É´‰æã: { "rules": { ".read": "auth != null", ".write": "auth != null" } }');
                        updateSyncStatus('üíæ „É≠„Éº„Ç´„É´‰øùÂ≠òÊ∏à„Åø');
                    } else {
                        updateSyncStatus('‚ùå ‰øùÂ≠òÂ§±Êïó');
                    }
                });
            } catch (e) {
                console.error('‚ùå „ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„Ç®„É©„Éº:', e);
                updateSyncStatus('‚ùå ‰øùÂ≠ò„Ç®„É©„Éº');
            }
        }

        // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíFirebase„Åã„ÇâË™≠„ÅøËæº„ÅøÔºàÂàùÂõûÂ∞ÇÁî®Ôºâ
        let isFirstLoadDone = false;
        function loadPrizeMasterFromCloudOnce() {
            if (isFirstLoadDone) return;
            isFirstLoadDone = true;

            updateSyncStatus('üîÑ „Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠... (75%)');

            database.ref('prizeMaster').once('value').then((snapshot) => {
                const data = snapshot.val();

                if (data && data.prizes) {
                    prizeMaster = data.prizes;

                    // localStorage„Å´„ÇÇ‰øùÂ≠òÔºà„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºâ
                    try {
                        localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));
                    } catch (e) {
                        console.error('localStorage„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', e);
                    }

                    updatePrizeMasterList();

                    const updateDate = new Date(data.updatedAt);
                    console.log(`„ÇØ„É©„Ç¶„Éâ„Åã„ÇâÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü (${prizeMaster.length}‰ª∂, Êõ¥Êñ∞Êó•ÊôÇ: ${updateDate.toLocaleString('ja-JP')})`);
                    updateSyncStatus('üîÑ „É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúüÈñãÂßã‰∏≠... (90%)');

                    // „É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„ÇíÈñãÂßã
                    startRealtimeSyncOnce();
                } else {
                    console.log('„ÇØ„É©„Ç¶„Éâ„Å´ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    loadPrizeMaster(); // localStorage„Åã„ÇâË™≠„ÅøËæº„Åø
                    updateSyncStatus('‚úÖ Ê∫ñÂÇôÂÆå‰∫Ü (100%)');

                    // „É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„ÇíÈñãÂßã
                    startRealtimeSyncOnce();
                }
            }).catch((error) => {
                console.error('Firebase„Åã„Çâ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);

                let errorMsg = '‚ùå ÂêåÊúüÂ§±Êïó';
                if (error.code === 'PERMISSION_DENIED') {
                    errorMsg = '‚ùå Ë™≠„ÅøËæº„ÅøÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    console.error('‚ö†Ô∏è Firebase Console„Åß„Éá„Éº„Çø„Éô„Éº„Çπ„É´„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    console.error('„É´„Éº„É´‰æã: { "rules": { "prizeMaster": { ".read": "auth != null", ".write": "auth != null" } } }');
                }
                updateSyncStatus(errorMsg);

                loadPrizeMaster(); // localStorage„Åã„ÇâË™≠„ÅøËæº„Åø
            });
        }

        // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíFirebase„Åã„ÇâË™≠„ÅøËæº„ÅøÔºàÊâãÂãïÂêåÊúüÁî®Ôºâ
        function loadPrizeMasterFromCloud() {
            if (typeof database === 'undefined') {
                console.warn('Firebase„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                loadPrizeMaster(); // localStorage„Åã„ÇâË™≠„ÅøËæº„Åø
                return;
            }

            // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
            if (!isAuthReady) {
                waitForAuth(() => loadPrizeMasterFromCloud());
                return;
            }

            updateSyncStatus('üîÑ ÂêåÊúü‰∏≠...');

            database.ref('prizeMaster').once('value').then((snapshot) => {
                const data = snapshot.val();

                if (data && data.prizes) {
                    prizeMaster = data.prizes;

                    // localStorage„Å´„ÇÇ‰øùÂ≠òÔºà„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºâ
                    try {
                        localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));
                    } catch (e) {
                        console.error('localStorage„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', e);
                    }

                    updatePrizeMasterList();

                    const updateDate = new Date(data.updatedAt);
                    console.log(`„ÇØ„É©„Ç¶„Éâ„Åã„ÇâÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü (${prizeMaster.length}‰ª∂, Êõ¥Êñ∞Êó•ÊôÇ: ${updateDate.toLocaleString('ja-JP')})`);
                    updateSyncStatus(`‚úÖ ÂêåÊúüÂÆå‰∫Ü (${prizeMaster.length}‰ª∂)`);
                } else {
                    console.log('„ÇØ„É©„Ç¶„Éâ„Å´ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    loadPrizeMaster(); // localStorage„Åã„ÇâË™≠„ÅøËæº„Åø
                    updateSyncStatus('üì≠ „ÇØ„É©„Ç¶„Éâ„ÅØÁ©∫„Åß„Åô');
                }
            }).catch((error) => {
                console.error('Firebase„Åã„Çâ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);

                let errorMsg = '‚ùå ÂêåÊúüÂ§±Êïó';
                if (error.code === 'PERMISSION_DENIED') {
                    errorMsg = '‚ùå Ë™≠„ÅøËæº„ÅøÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    console.error('‚ö†Ô∏è Firebase Console„Åß„Éá„Éº„Çø„Éô„Éº„Çπ„É´„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                }
                updateSyncStatus(errorMsg);

                loadPrizeMaster(); // localStorage„Åã„ÇâË™≠„ÅøËæº„Åø
            });
        }

        // ÂêåÊúü„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
        function updateSyncStatus(message) {
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.opacity = '1';

                // 5ÁßíÂæå„Å´„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
                setTimeout(() => {
                    statusElement.style.opacity = '0.5';
                }, 5000);
            }
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„ÇíÈñãÂßãÔºàÂàùÂõûÂ∞ÇÁî®Ôºâ
        let isRealtimeSyncStarted = false;
        function startRealtimeSyncOnce() {
            if (isRealtimeSyncStarted) return;
            isRealtimeSyncStarted = true;

            // Firebase„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            database.ref('prizeMaster').on('value', (snapshot) => {
                const data = snapshot.val();

                if (data && data.prizes) {
                    const remoteUpdateTime = data.updatedAt;
                    const localUpdateTime = localStorage.getItem('prizeMaster_lastUpdate');

                    // „É™„É¢„Éº„Éà„ÅÆÊñπ„ÅåÊñ∞„Åó„ÅÑÂ†¥Âêà„ÅÆ„ÅøÊõ¥Êñ∞
                    if (!localUpdateTime || remoteUpdateTime > parseInt(localUpdateTime)) {
                        prizeMaster = data.prizes;

                        // localStorage„Å´„ÇÇ‰øùÂ≠ò
                        try {
                            localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));
                            localStorage.setItem('prizeMaster_lastUpdate', remoteUpdateTime.toString());
                        } catch (e) {
                            console.error('localStorage„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', e);
                        }

                        updatePrizeMasterList();
                        console.log('„ÇØ„É©„Ç¶„Éâ„Åã„ÇâÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü');
                        updateSyncStatus(`‚úÖ ÂêåÊúüÂÆå‰∫Ü (${prizeMaster.length}‰ª∂)`);
                    }
                }
            });

            console.log('„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü');
            updateSyncStatus(`‚úÖ „É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü‰∏≠ (${prizeMaster.length}‰ª∂)`);
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„ÇíÈñãÂßãÔºàÂæìÊù•„ÅÆÈñ¢Êï∞„ÄÅ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        function startRealtimeSync() {
            if (typeof database === 'undefined') {
                console.warn('Firebase„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
            if (!isAuthReady) {
                waitForAuth(() => startRealtimeSync());
                return;
            }

            startRealtimeSyncOnce();
        }


        // ÊâãÂãï„ÅßÂêåÊúü
        function manualSyncPrizeMaster() {
            if (typeof database === 'undefined') {
                alert('Firebase„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\n„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            updateSyncStatus('üîÑ ÂêåÊúü‰∏≠...');

            database.ref('prizeMaster').once('value').then((snapshot) => {
                const data = snapshot.val();

                if (data && data.prizes) {
                    prizeMaster = data.prizes;

                    // localStorage„Å´„ÇÇ‰øùÂ≠ò
                    try {
                        localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));
                        localStorage.setItem('prizeMaster_lastUpdate', data.updatedAt.toString());
                    } catch (e) {
                        console.error('localStorage„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', e);
                    }

                    updatePrizeMasterList();

                    const updateDate = new Date(data.updatedAt);
                    alert(`‚úÖ „ÇØ„É©„Ç¶„Éâ„Åã„ÇâÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü„ÄÇ\n\nÊôØÂìÅÊï∞: ${prizeMaster.length}‰ª∂\nÊúÄÁµÇÊõ¥Êñ∞: ${updateDate.toLocaleString('ja-JP')}`);
                    updateSyncStatus(`‚úÖ ÂêåÊúüÂÆå‰∫Ü (${prizeMaster.length}‰ª∂)`);
                } else {
                    alert('„ÇØ„É©„Ç¶„Éâ„Å´ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                    updateSyncStatus('üì≠ „ÇØ„É©„Ç¶„Éâ„ÅØÁ©∫„Åß„Åô');
                }
            }).catch((error) => {
                console.error('ÂêåÊúü„Ç®„É©„Éº:', error);

                let errorMsg = '‚ùå ÂêåÊúüÂ§±Êïó';
                let alertMsg = `‚ùå ÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Ç®„É©„Éº: ${error.message}`;

                if (error.code === 'PERMISSION_DENIED') {
                    errorMsg = '‚ùå Ë™≠„ÅøËæº„ÅøÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    alertMsg = '‚ùå „ÇØ„É©„Ç¶„ÉâÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n' +
                        'Firebase Realtime Database„ÅÆÊ®©ÈôêË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n' +
                        'ÊâãÈ†ÜÔºö\n' +
                        '1. Firebase Console „ÇíÈñã„Åè\n' +
                        '2. Realtime Database > „É´„Éº„É´\n' +
                        '3. ‰ª•‰∏ã„ÅÆ„É´„Éº„É´„ÇíË®≠ÂÆö:\n' +
                        '{\n' +
                        '  "rules": {\n' +
                        '    "prizeMaster": {\n' +
                        '      ".read": "auth != null",\n' +
                        '      ".write": "auth != null"\n' +
                        '    }\n' +
                        '  }\n' +
                        '}';
                    console.error('‚ö†Ô∏è Firebase Console„Åß„Éá„Éº„Çø„Éô„Éº„Çπ„É´„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                }

                alert(alertMsg);
                updateSyncStatus(errorMsg);
            });
        }

        // ========== „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉªÂæ©ÂÖÉÊ©üËÉΩ ==========

        // JSON„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportPrizeMasterJson() {
            const exportData = {
                exportedAt: new Date().toISOString(),
                version: '1.0',
                prizeMasterCount: prizeMaster.length,
                prizeMaster: prizeMaster
            };

            const jsonStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const dateStr = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
            const filename = `prizeMaster_backup_${dateStr}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`‚úÖ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü\n\n„Éï„Ç°„Ç§„É´Âêç: ${filename}\nÊôØÂìÅÊï∞: ${prizeMaster.length}‰ª∂`);
        }

        // JSON„Ç§„É≥„Éù„Éº„Éà
        function importPrizeMasterJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                    if (!data.prizeMaster || !Array.isArray(data.prizeMaster)) {
                        throw new Error('ÁÑ°Âäπ„Å™„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Åß„Åô');
                    }

                    const exportedAt = data.exportedAt ? new Date(data.exportedAt).toLocaleString('ja-JP') : '‰∏çÊòé';
                    const count = data.prizeMaster.length;

                    if (!confirm(`‚ö†Ô∏è ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                        `„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊó•ÊôÇ: ${exportedAt}\n` +
                        `ÊôØÂìÅÊï∞: ${count}‰ª∂\n\n` +
                        `ÁèæÂú®„ÅÆÊôØÂìÅ„Éû„Çπ„Çø„ÉºÔºà${prizeMaster.length}‰ª∂Ôºâ„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ\n` +
                        `„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
                        return;
                    }

                    // ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí„É≠„Éº„Ç´„É´„Å´ÈÄÄÈÅø
                    try {
                        localStorage.setItem('prizeMaster_beforeRestore', JSON.stringify(prizeMaster));
                    } catch (err) {
                        console.warn('ÈÄÄÈÅøÁî®„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', err);
                    }

                    // Âæ©ÂÖÉ
                    prizeMaster = data.prizeMaster;
                    savePrizeMaster();
                    savePrizeMasterToCloud();
                    updatePrizeMasterList();

                    alert(`‚úÖ Âæ©ÂÖÉ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü\n\nÊôØÂìÅÊï∞: ${prizeMaster.length}‰ª∂`);
                } catch (err) {
                    console.error('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', err);
                    alert(`‚ùå „Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n${err.message}`);
                }
            };

            reader.onerror = function() {
                alert('‚ùå „Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            };

            reader.readAsText(file);
            event.target.value = ''; // „É™„Çª„ÉÉ„Éà
        }

        // „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openCloudBackupModal() {
            document.getElementById('cloudBackupModal').style.display = 'flex';
            loadCloudBackups();
        }

        // „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeCloudBackupModal() {
            document.getElementById('cloudBackupModal').style.display = 'none';
        }

        // „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÇÄ
        function loadCloudBackups() {
            const listContainer = document.getElementById('cloudBackupList');
            const countSpan = document.getElementById('backupCount');

            if (typeof database === 'undefined' || !isAuthReady) {
                listContainer.innerHTML = '<p style="color: var(--sf-red); text-align: center; padding: 20px;">Firebase„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }

            listContainer.innerHTML = '<p style="color: var(--sf-gray); text-align: center; padding: 20px;">Ë™≠„ÅøËæº„Åø‰∏≠...</p>';

            database.ref('prizeMasterBackups').orderByChild('createdAt').limitToLast(20).once('value').then(snapshot => {
                const data = snapshot.val();

                if (!data) {
                    listContainer.innerHTML = '<p style="color: var(--sf-gray); text-align: center; padding: 40px 0;">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                    countSpan.textContent = '(0‰ª∂)';
                    return;
                }

                const backups = Object.entries(data).map(([key, value]) => ({
                    id: key,
                    ...value
                })).sort((a, b) => b.createdAt - a.createdAt);

                countSpan.textContent = `(${backups.length}‰ª∂)`;

                listContainer.innerHTML = backups.map(backup => {
                    const date = new Date(backup.createdAt);
                    const dateStr = date.toLocaleString('ja-JP');
                    const count = backup.prizeMasterCount || '?';

                    return `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; margin-bottom: 8px; background: rgba(0,0,0,0.02); border-radius: 8px; border: 1px solid rgba(0,0,0,0.05);">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: var(--sf-black);">üìÖ ${dateStr}</div>
                                <div style="font-size: 12px; color: var(--sf-gray); margin-top: 2px;">ÊôØÂìÅÊï∞: ${count}‰ª∂</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="restoreCloudBackup('${backup.id}')" style="padding: 6px 12px; background: var(--sf-green); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                    Âæ©ÂÖÉ
                                </button>
                                <button onclick="deleteCloudBackup('${backup.id}')" style="padding: 6px 12px; background: var(--sf-red); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                    ÂâäÈô§
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }).catch(err => {
                console.error('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', err);
                listContainer.innerHTML = '<p style="color: var(--sf-red); text-align: center; padding: 20px;">Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
            });
        }

        // „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê
        function createCloudBackup() {
            if (typeof database === 'undefined' || !isAuthReady) {
                alert('Firebase„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            const backupData = {
                createdAt: Date.now(),
                prizeMasterCount: prizeMaster.length,
                prizeMaster: prizeMaster
            };

            database.ref('prizeMasterBackups').push(backupData).then(() => {
                alert(`‚úÖ „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü\n\nÊôØÂìÅÊï∞: ${prizeMaster.length}‰ª∂`);
                loadCloudBackups();
            }).catch(err => {
                console.error('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê„Ç®„É©„Éº:', err);
                alert(`‚ùå „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n${err.message}`);
            });
        }

        // „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åã„ÇâÂæ©ÂÖÉ
        function restoreCloudBackup(backupId) {
            if (typeof database === 'undefined' || !isAuthReady) {
                alert('Firebase„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            database.ref('prizeMasterBackups/' + backupId).once('value').then(snapshot => {
                const data = snapshot.val();

                if (!data || !data.prizeMaster) {
                    alert('‚ùå „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }

                const date = new Date(data.createdAt).toLocaleString('ja-JP');
                const count = data.prizeMaster.length;

                if (!confirm(`‚ö†Ô∏è „Åì„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åã„ÇâÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                    `„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊó•ÊôÇ: ${date}\n` +
                    `ÊôØÂìÅÊï∞: ${count}‰ª∂\n\n` +
                    `ÁèæÂú®„ÅÆÊôØÂìÅ„Éû„Çπ„Çø„ÉºÔºà${prizeMaster.length}‰ª∂Ôºâ„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ`)) {
                    return;
                }

                // ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí„É≠„Éº„Ç´„É´„Å´ÈÄÄÈÅø
                try {
                    localStorage.setItem('prizeMaster_beforeRestore', JSON.stringify(prizeMaster));
                } catch (err) {
                    console.warn('ÈÄÄÈÅøÁî®„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', err);
                }

                // Âæ©ÂÖÉ
                prizeMaster = data.prizeMaster;
                savePrizeMaster();
                savePrizeMasterToCloud();
                updatePrizeMasterList();

                alert(`‚úÖ Âæ©ÂÖÉ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü\n\nÊôØÂìÅÊï∞: ${prizeMaster.length}‰ª∂`);
                closeCloudBackupModal();
            }).catch(err => {
                console.error('Âæ©ÂÖÉ„Ç®„É©„Éº:', err);
                alert(`‚ùå Âæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n${err.message}`);
            });
        }

        // „ÇØ„É©„Ç¶„Éâ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂâäÈô§
        function deleteCloudBackup(backupId) {
            if (!confirm('„Åì„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                return;
            }

            database.ref('prizeMasterBackups/' + backupId).remove().then(() => {
                alert('‚úÖ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                loadCloudBackups();
            }).catch(err => {
                console.error('ÂâäÈô§„Ç®„É©„Éº:', err);
                alert(`‚ùå ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n${err.message}`);
            });
        }

        // HTML„Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, (m) => map[m]);
        }

        // Âú®Â∫´„Çµ„Éû„É™„Éº„ÇíÊõ¥Êñ∞
        function updateInventorySummary() {
            // Âú®Â∫´„ÅÇ„Çä„ÅÆ„Ç´„Éº„Éâ„ÅÆ„Åø„ÇíÂØæË±°„Å´„Åô„Çã
            const inStockPrizes = prizeMaster.filter(prize => prize.count > 0);

            // Âú®Â∫´Êï∞ÔºàÂêÑ„Ç´„Éº„Éâ„ÅÆcountÂêàË®àÔºâ
            const totalStockCount = inStockPrizes.reduce((sum, prize) => sum + (prize.count || 0), 0);

            // ‰ªïÂÖ•„ÇåÁ∑è‰æ°Ê†ºÔºàÂêÑ„Ç´„Éº„Éâ„ÅÆ‰ªïÂÖ•„Çå‰æ°Ê†º √ó Âú®Â∫´Êï∞„ÅÆÂêàË®àÔºâ
            const totalPurchasePrice = inStockPrizes.reduce((sum, prize) => {
                return sum + ((prize.purchasePrice || 0) * (prize.count || 0));
            }, 0);

            // ÈÇÑÂÖÉ„Éù„Ç§„É≥„ÉàÁ∑è‰æ°Ê†ºÔºàÂêÑ„Ç´„Éº„Éâ„ÅÆÈÇÑÂÖÉ„Éù„Ç§„É≥„Éà‰æ°ÂÄ§ √ó Âú®Â∫´Êï∞„ÅÆÂêàË®àÔºâ
            const totalRewardValue = inStockPrizes.reduce((sum, prize) => {
                return sum + ((prize.value || 0) * (prize.count || 0));
            }, 0);

            // ÈÇÑÂÖÉ„Éù„Ç§„É≥„Éà‰æ°Ê†ºÂ∏ØÂà•ÊûöÊï∞ÔºàÂú®Â∫´Êï∞„Çí„Ç´„Ç¶„É≥„ÉàÔºâ
            // „Äú1000, 1001„Äú5000, 5001„Äú10000, 10001„Äú20000, 20001„Äú50000, 50001„Äú100000, 100001„Äú200000, 200001„Äú
            const ranges = [0, 0, 0, 0, 0, 0, 0, 0];
            inStockPrizes.forEach(prize => {
                const value = prize.value || 0;
                const count = prize.count || 0;
                if (value <= 1000) {
                    ranges[0] += count;
                } else if (value <= 5000) {
                    ranges[1] += count;
                } else if (value <= 10000) {
                    ranges[2] += count;
                } else if (value <= 20000) {
                    ranges[3] += count;
                } else if (value <= 50000) {
                    ranges[4] += count;
                } else if (value <= 100000) {
                    ranges[5] += count;
                } else if (value <= 200000) {
                    ranges[6] += count;
                } else {
                    ranges[7] += count;
                }
            });

            // Á®ÆÈ°ûÂà•ÊûöÊï∞ÔºàÂú®Â∫´Êï∞„Çí„Ç´„Ç¶„É≥„ÉàÔºâ
            const typeCounts = {
                'PSA10': 0,
                'ÁæéÂìÅ': 0,
                '„Éë„ÉÉ„ÇØ': 0,
                '„Éú„ÉÉ„ÇØ„Çπ': 0,
                '„Åù„ÅÆ‰ªñ': 0
            };
            inStockPrizes.forEach(prize => {
                const type = prize.type || 'PSA10';
                const count = prize.count || 0;
                if (typeCounts.hasOwnProperty(type)) {
                    typeCounts[type] += count;
                } else {
                    typeCounts['„Åù„ÅÆ‰ªñ'] += count;
                }
            });

            // DOM„ÇíÊõ¥Êñ∞
            const stockCountEl = document.getElementById('summaryStockCount');
            const purchasePriceEl = document.getElementById('summaryTotalPurchasePrice');
            const rewardValueEl = document.getElementById('summaryTotalRewardValue');

            if (stockCountEl) stockCountEl.textContent = formatNumber(totalStockCount) + ' Êûö';
            if (purchasePriceEl) purchasePriceEl.textContent = '¬•' + formatNumber(totalPurchasePrice);
            if (rewardValueEl) rewardValueEl.textContent = '¬•' + formatNumber(totalRewardValue);

            for (let i = 0; i < 8; i++) {
                const rangeEl = document.getElementById('summaryRange' + i);
                if (rangeEl) rangeEl.textContent = formatNumber(ranges[i]) + 'Êûö';
            }

            // Á®ÆÈ°ûÂà•ÊûöÊï∞„ÇíÊõ¥Êñ∞
            const typeUnits = {
                'PSA10': 'Êûö',
                'ÁæéÂìÅ': 'Êûö',
                '„Éë„ÉÉ„ÇØ': 'ÂÄã',
                '„Éú„ÉÉ„ÇØ„Çπ': 'ÂÄã',
                '„Åù„ÅÆ‰ªñ': 'Êûö'
            };
            Object.keys(typeCounts).forEach(type => {
                const typeEl = document.getElementById('summaryType' + type);
                if (typeEl) typeEl.textContent = formatNumber(typeCounts[type]) + typeUnits[type];
            });
        }

        // ÊôØÂìÅ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞ÔºàÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíË°®Á§∫Ôºâ
        function updatePrizeMasterList() {
            // Âú®Â∫´„Çµ„Éû„É™„Éº„ÇíÊõ¥Êñ∞
            updateInventorySummary();

            const listContainer = document.getElementById('prizeMasterList');

            if (prizeMaster.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéÅ</div>
                        <div class="empty-state-text">ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅåÁ©∫„Åß„Åô</div>
                        <div class="empty-state-subtext">„Äå‚ûï Êñ∞Ë¶èÊôØÂìÅ„ÇíËøΩÂä†„Äç„Åæ„Åü„ÅØ„Äåüì• JSON„Éï„Ç°„Ç§„É´„Åã„ÇâÊôØÂìÅ„ÇíËøΩÂä†„Äç„ÅßÊôØÂìÅ„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
                return;
            }

            // „ÇΩ„Éº„Éà„Éª„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö„ÇíÂèñÂæó
            const sortBy = document.getElementById('prizeMasterSortBy')?.value || 'price';
            const sortOrder = document.getElementById('prizeMasterSortOrder')?.value || 'desc';
            const filterBy = document.getElementById('prizeMasterFilter')?.value || 'all';
            const typeFilter = document.getElementById('prizeMasterTypeFilter')?.value || 'all';
            const wantedFilter = document.getElementById('prizeMasterWantedFilter')?.checked || false;
            const salesFilter = document.getElementById('prizeMasterSalesFilter')?.value || 'all';
            const searchText = document.getElementById('prizeMasterSearchText')?.value.trim().toLowerCase() || '';

            // Ë®≠ÂÆö„ÇílocalStorage„Å´‰øùÂ≠ò
            try {
                localStorage.setItem('prizeMasterSortBy', sortBy);
                localStorage.setItem('prizeMasterSortOrder', sortOrder);
                localStorage.setItem('prizeMasterFilter', filterBy);
                localStorage.setItem('prizeMasterTypeFilter', typeFilter);
                localStorage.setItem('prizeMasterWantedFilter', wantedFilter);
                localStorage.setItem('prizeMasterSalesFilter', salesFilter);
                localStorage.setItem('prizeMasterSearchText', searchText);
            } catch (e) {
                console.error('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', e);
            }

            // „Éï„Ç£„É´„Çø„ÉºÂá¶ÁêÜ
            let filteredPrizes = [...prizeMaster];

            // Âú®Â∫´„Éï„Ç£„É´„Çø„Éº
            if (filterBy === 'inStock') {
                filteredPrizes = filteredPrizes.filter(prize => prize.count > 0);
            } else if (filterBy === 'outOfStock') {
                filteredPrizes = filteredPrizes.filter(prize => prize.count === 0);
            }

            // Á®ÆÈ°û„Éï„Ç£„É´„Çø„Éº
            if (typeFilter !== 'all') {
                filteredPrizes = filteredPrizes.filter(prize => (prize.type || 'PSA10') === typeFilter);
            }

            // Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„É™„Çπ„Éà„Éï„Ç£„É´„Çø„Éº
            if (wantedFilter) {
                filteredPrizes = filteredPrizes.filter(prize => prize.isWanted === true);
            }


            // ÂêçÂâçÊ§úÁ¥¢„Éï„Ç£„É´„Çø„Éº
            if (searchText) {
                filteredPrizes = filteredPrizes.filter(prize =>
                    prize.name.toLowerCase().includes(searchText)
                );
            }

            // ÈáëÈ°çÁØÑÂõ≤„Éï„Ç£„É´„Çø„Éº
            const minPurchasePrice = parseFloat(document.getElementById('prizeMasterMinPurchasePrice')?.value) || null;
            const maxPurchasePrice = parseFloat(document.getElementById('prizeMasterMaxPurchasePrice')?.value) || null;
            const minRewardValue = parseFloat(document.getElementById('prizeMasterMinRewardValue')?.value) || null;
            const maxRewardValue = parseFloat(document.getElementById('prizeMasterMaxRewardValue')?.value) || null;

            if (minPurchasePrice !== null) {
                filteredPrizes = filteredPrizes.filter(prize => (prize.purchasePrice || 0) >= minPurchasePrice);
            }
            if (maxPurchasePrice !== null) {
                filteredPrizes = filteredPrizes.filter(prize => (prize.purchasePrice || 0) <= maxPurchasePrice);
            }
            if (minRewardValue !== null) {
                filteredPrizes = filteredPrizes.filter(prize => (prize.value || 0) >= minRewardValue);
            }
            if (maxRewardValue !== null) {
                filteredPrizes = filteredPrizes.filter(prize => (prize.value || 0) <= maxRewardValue);
            }

            // „Éï„Ç£„É´„Çø„ÉºÂæå„ÅÆ‰ª∂Êï∞„ÉÅ„Çß„ÉÉ„ÇØ
            if (filteredPrizes.length === 0) {
                const filterLabels = [];
                if (filterBy !== 'all') filterLabels.push(filterBy === 'inStock' ? 'Âú®Â∫´„ÅÇ„Çä' : 'Âú®Â∫´„Å™„Åó');
                if (typeFilter !== 'all') filterLabels.push(`Á®ÆÈ°û: ${typeFilter}`);
                if (wantedFilter) filterLabels.push('Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„É™„Çπ„Éà');
                if (salesFilter === 'inSale') filterLabels.push('„Ç™„É™„Éë„ÅßË≤©Â£≤‰∏≠');
                if (salesFilter === 'notInSale') filterLabels.push('Êú™Ë≤©Â£≤');
                if (searchText) filterLabels.push(`Ê§úÁ¥¢: "${searchText}"`);
                if (minPurchasePrice !== null || maxPurchasePrice !== null) {
                    filterLabels.push(`‰ªïÂÖ•„Çå‰æ°Ê†º: ${minPurchasePrice || 'ÊúÄÂ∞è'}„Äú${maxPurchasePrice || 'ÊúÄÂ§ß'}`);
                }
                if (minRewardValue !== null || maxRewardValue !== null) {
                    filterLabels.push(`ÈÇÑÂÖÉ‰æ°ÂÄ§: ${minRewardValue || 'ÊúÄÂ∞è'}„Äú${maxRewardValue || 'ÊúÄÂ§ß'}`);
                }

                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">Ë©≤ÂΩì„Åô„ÇãÊôØÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div class="empty-state-subtext">„Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂„Äå${filterLabels.join(', ')}„Äç„Å´‰∏ÄËá¥„Åô„ÇãÊôØÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>
                    </div>
                `;
                return;
            }

            // „ÇΩ„Éº„ÉàÂá¶ÁêÜ
            let sortedPrizes = [...filteredPrizes];

            if (sortBy === 'price') {
                // ‰ªïÂÖ•„Çå‰æ°Ê†ºÈ†Ü
                sortedPrizes.sort((a, b) => {
                    if (sortOrder === 'desc') {
                        return b.purchasePrice - a.purchasePrice; // È´ò„ÅÑÈ†Ü
                    } else {
                        return a.purchasePrice - b.purchasePrice; // ÂÆâ„ÅÑÈ†Ü
                    }
                });
            } else if (sortBy === 'date') {
                // ÁôªÈå≤Êó•ÊôÇÈ†Ü
                sortedPrizes.sort((a, b) => {
                    const dateA = a.addedAt || a.id || 0;
                    const dateB = b.addedAt || b.id || 0;
                    if (sortOrder === 'desc') {
                        return dateB - dateA; // Êñ∞„Åó„ÅÑÈ†Ü
                    } else {
                        return dateA - dateB; // Âè§„ÅÑÈ†Ü
                    }
                });
            }

            listContainer.innerHTML = sortedPrizes.map(prize => {
                // ÁîªÂÉèURL„ÅØÁõ¥Êé•‰ΩøÁî®ÔºàHTML„Ç®„Çπ„Ç±„Éº„Éó„Åô„Çã„Å®URL„ÅåÂ£ä„Çå„ÇãÔºâ
                // „Ç´„Éº„Éâ„ÅØÁ∏¶Èï∑„Å™„ÅÆ„Åß„ÄÅÁ∏¶Ê®™ÊØî„Çí2:3„Å´Ë®≠ÂÆöÔºàÂπÖ70px √ó È´ò„Åï105pxÔºâ
                const imageHtml = prize.image
                    ? `<img src="${prize.image}"
                           alt="${escapeHtml(prize.name)}"
                           onclick="openImageViewModal('${prize.image.replace(/'/g, "\\'")}', '${prize.name.replace(/'/g, "\\'")}'); event.stopPropagation();"
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                           style="width: 70px; height: 105px; object-fit: cover; border-radius: var(--radius-md); border: 2px solid rgba(0, 0, 0, 0.1); cursor: pointer; transition: transform 0.2s;"
                           onmouseover="this.style.transform='scale(1.05)'"
                           onmouseout="this.style.transform='scale(1)'">
                       <div style="display: none; width: 70px; height: 105px; background: rgba(255, 0, 0, 0.1); border-radius: var(--radius-md); border: 2px solid rgba(255, 0, 0, 0.3); align-items: center; justify-content: center; font-size: 10px; color: red; text-align: center; padding: 4px;">ÁîªÂÉè<br>Ë™≠Ëæº<br>Â§±Êïó</div>`
                    : `<div style="width: 70px; height: 105px; background: rgba(0, 0, 0, 0.05); border-radius: var(--radius-md); border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 32px;">üì¶</div>`;

                const typeLabel = prize.type || 'PSA10';
                const isWanted = prize.isWanted || false;

                return `
                    <div class="prize-master-item">
                        <div class="prize-master-header">
                            <div style="display: flex; gap: 16px; align-items: center; flex: 1;">
                                ${imageHtml}
                                <div class="prize-master-title" style="flex: 1;">
                                    <div class="prize-master-name">${prize.name}</div>
                                    <div style="display: flex; gap: 8px; margin-top: 6px; align-items: center; flex-wrap: wrap;">
                                        <span style="display: inline-block; padding: 6px 14px; background: rgba(0, 122, 255, 0.1); color: #007AFF; border-radius: 16px; font-size: 13px; font-weight: 600; line-height: 1.4; white-space: nowrap;">${typeLabel}</span>
                                        <button onclick="event.stopPropagation(); togglePrizeWanted(${prize.id})" style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 14px; background: ${isWanted ? 'rgba(255, 192, 203, 0.3)' : 'rgba(0, 0, 0, 0.05)'}; border: 1.5px solid ${isWanted ? 'rgba(255, 105, 180, 0.6)' : 'rgba(0, 0, 0, 0.1)'}; border-radius: 16px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: ${isWanted ? '#ff1493' : '#999'}; filter: ${isWanted ? 'none' : 'grayscale(100%)'}; line-height: 1.4; white-space: nowrap;" title="Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„É™„Çπ„Éà„Å´${isWanted ? 'ËøΩÂä†Ê∏à„Åø' : 'ËøΩÂä†'}">‚ù§Ô∏è${isWanted ? ' Ê¨≤„Åó„ÅÑ' : ''}</button>
                                    </div>
                                </div>
                            </div>
                            <div class="prize-master-actions">
                                <button type="button" class="btn btn-primary btn-icon" onclick="event.stopPropagation(); event.preventDefault(); openEditPrizeModal(${prize.id})" title="Á∑®ÈõÜ">
                                    ‚úèÔ∏è
                                </button>
                                <button type="button" class="btn btn-danger btn-icon" onclick="event.stopPropagation(); event.preventDefault(); deletePrizeFromMaster(${prize.id})" title="ÂâäÈô§">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <div class="prize-master-info">
                            <div class="prize-master-info-item">
                                <div class="prize-master-info-label">‰ªïÂÖ•„Çå‰æ°Ê†º${prize.purchasePriceHistory && prize.purchasePriceHistory.length > 0 ? ' (Âπ≥Âùá)' : ''}</div>
                                <div class="prize-master-info-value">¬•${formatNumber(prize.purchasePrice)}</div>
                            </div>
                            <div class="prize-master-info-item">
                                <div class="prize-master-info-label">„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§</div>
                                <div class="prize-master-info-value">¬•${formatNumber(prize.value)}</div>
                            </div>
                            <div class="prize-master-info-item">
                                <div class="prize-master-info-label">Âú®Â∫´Êï∞</div>
                                <div class="prize-master-info-value" style="color: ${prize.count === 0 ? 'var(--sf-red)' : 'inherit'}; font-weight: ${prize.count === 0 ? '600' : 'inherit'};">
                                    ${formatNumber(prize.count)}ÂÄã${prize.count === 0 ? ' (Â£≤„ÇäÂàá„Çå)' : ''}
                                </div>
                            </div>
                        </div>
                        ${prize.purchasePriceHistory && prize.purchasePriceHistory.length > 0 ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.05);">
                            <details style="cursor: pointer;">
                                <summary style="font-size: 12px; color: var(--sf-gray); font-weight: 600; user-select: none;">
                                    üìä ‰ªïÂÖ•„ÇåÂ±•Ê≠¥Ôºà${prize.purchasePriceHistory.length}‰ª∂Ôºâ
                                </summary>
                                <div style="margin-top: 8px; max-height: 150px; overflow-y: auto;">
                                    ${prize.purchasePriceHistory.slice().reverse().map(entry => {
                                        const date = new Date(entry.date);
                                        const dateStr = date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' });
                                        return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: rgba(0,0,0,0.02); border-radius: 4px; margin-bottom: 4px; font-size: 12px;">
                                            <span style="color: var(--sf-gray);">${dateStr}</span>
                                            <span><strong>¬•${formatNumber(entry.price)}</strong> √ó ${entry.quantity}ÂÄã</span>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </details>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„Éê„ÉÉ„Ç∏„Çí„Éà„Ç∞„É´
        function togglePrizeWanted(prizeId) {
            const prizeIndex = prizeMaster.findIndex(p => p.id === prizeId);
            if (prizeIndex !== -1) {
                prizeMaster[prizeIndex].isWanted = !prizeMaster[prizeIndex].isWanted;
                savePrizeMaster();
                updatePrizeMasterList();
            }
        }

        // ÈáëÈ°çÁØÑÂõ≤„Éï„Ç£„É´„Çø„Éº„Çí„ÇØ„É™„Ç¢
        function clearPriceRangeFilters(context) {
            if (context === 'master') {
                // ÊôØÂìÅ„Éû„Çπ„Çø„ÉºÁîªÈù¢„ÅÆ„Éï„Ç£„É´„Çø„Éº„Çí„ÇØ„É™„Ç¢
                document.getElementById('prizeMasterMinPurchasePrice').value = '';
                document.getElementById('prizeMasterMaxPurchasePrice').value = '';
                document.getElementById('prizeMasterMinRewardValue').value = '';
                document.getElementById('prizeMasterMaxRewardValue').value = '';
                updatePrizeMasterList();
            } else if (context === 'modal') {
                // „É¢„Éº„ÉÄ„É´„ÅÆ„Éï„Ç£„É´„Çø„Éº„Çí„ÇØ„É™„Ç¢
                document.getElementById('modalMinPurchasePrice').value = '';
                document.getElementById('modalMaxPurchasePrice').value = '';
                document.getElementById('modalMinRewardValue').value = '';
                document.getElementById('modalMaxRewardValue').value = '';
                updatePrizeMasterSelectList();
            }
        }

        // ÁîªÂÉèURL„Åã„Çâ„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫
        function previewImageFromUrl(url, imgId, previewId) {
            const img = document.getElementById(imgId);
            const preview = document.getElementById(previewId);

            if (url && url.trim()) {
                img.src = url;
                img.style.border = '2px solid rgba(0, 0, 0, 0.1)';
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // ÊôØÂìÅÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÔºàÊôØÂìÅ„Éû„Çπ„Çø„ÉºÁî®Ôºâ
        function openEditPrizeModal(prizeId, tempPrize = null) {
            // tempPrize„ÅåÊ∏°„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÊ§úÁ¥¢
            const prize = tempPrize || prizeMaster.find(p => p.id === prizeId);
            if (!prize) return;

            editingMasterPrizeId = prizeId;

            // „É¢„Éº„ÉÄ„É´„ÅÆ„Éï„Ç©„Éº„É†„Å´ÂÄ§„ÇíË®≠ÂÆö
            document.getElementById('editPrizeName').value = prize.name;
            document.getElementById('editPrizePurchasePrice').value = formatNumber(prize.purchasePrice);
            document.getElementById('editPrizeValue').value = formatNumber(prize.value);
            document.getElementById('editPrizeCount').value = prize.count;
            document.getElementById('editPrizeType').value = prize.type || 'PSA10';
            document.getElementById('editPrizeIsWanted').checked = prize.isWanted || false;

            // Êó¢Â≠ò„ÅÆÁîªÂÉèURL„ÇíË®≠ÂÆö
            const imageUrl = prize.image || '';
            document.getElementById('editPrizeImageUrl').value = imageUrl;

            // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
            const imagePreview = document.getElementById('editPrizeImagePreview');
            const imagePreviewImg = document.getElementById('editPrizeImagePreviewImg');
            if (imageUrl) {
                imagePreviewImg.src = imageUrl;
                imagePreviewImg.style.border = '2px solid rgba(0, 0, 0, 0.1)';
                imagePreview.style.display = 'block';
            } else {
                imagePreview.style.display = 'none';
            }

            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            document.getElementById('editPrizeModal').classList.add('active');
        }

        // ÊôØÂìÅÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeEditPrizeModal() {
            editingMasterPrizeId = null;
            editingMainPrizeId = null;
            editContext = 'master'; // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„É™„Çª„ÉÉ„Éà

            document.getElementById('editPrizeModal').classList.remove('active');

            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            document.getElementById('editPrizeName').value = '';
            document.getElementById('editPrizePurchasePrice').value = '';
            document.getElementById('editPrizeValue').value = '';
            document.getElementById('editPrizeCount').value = '1';
            document.getElementById('editPrizeImageUrl').value = '';
            document.getElementById('editPrizeImagePreview').style.display = 'none';
        }

        // Á∑®ÈõÜ„Åó„ÅüÊôØÂìÅ„Çí‰øùÂ≠òÔºàÊôØÂìÅ„Éû„Çπ„Çø„ÉºÁî® / „É°„Ç§„É≥Áî®ÂÖ±ÈÄöÔºâ
        function saveEditedPrize() {
            if (!editingMasterPrizeId) return;

            const name = document.getElementById('editPrizeName').value.trim();
            const purchasePrice = parseFormattedNumber(document.getElementById('editPrizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('editPrizeValue').value);
            const count = parseInt(document.getElementById('editPrizeCount').value);
            const type = document.getElementById('editPrizeType').value;
            const isWanted = document.getElementById('editPrizeIsWanted').checked;
            const imageUrl = document.getElementById('editPrizeImageUrl').value.trim();

            if (!name || purchasePrice <= 0 || value <= 0 || isNaN(count) || count < 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÂú®Â∫´Êï∞„ÅØ0‰ª•‰∏äÔºâ');
                return;
            }

            // ÁîªÂÉèURL„ÇíË®≠ÂÆöÔºàÁ©∫„ÅÆÂ†¥Âêà„ÅØnullÔºâ
            const imageData = imageUrl || null;

            // „É°„Ç§„É≥„Åã„ÇâÂëº„Å∞„Çå„ÅüÂ†¥Âêà
            if (editContext === 'main' && editingMainPrizeId) {
                // „É°„Ç§„É≥„ÅÆÊôØÂìÅ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
                const mainPrizeIndex = prizes.findIndex(p => p.id === editingMainPrizeId);
                if (mainPrizeIndex !== -1) {
                    prizes[mainPrizeIndex] = {
                        ...prizes[mainPrizeIndex],
                        name: name,
                        purchasePrice: purchasePrice,
                        value: value,
                        count: count,
                        image: imageData
                    };
                }

                // „É°„Ç§„É≥„ÅÆÊôØÂìÅ„ÇíÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´„ÇÇÂèçÊò†„Åô„Çã„ÅãÁ¢∫Ë™ç
                const existingMasterPrize = prizeMaster.find(p => p.name === name);
                if (existingMasterPrize) {
                    // ÂêåÂêç„ÅÆÊôØÂìÅ„Åå„Éû„Çπ„Çø„Éº„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà„ÄÅÊõ¥Êñ∞„Åô„Çã„ÅãÁ¢∫Ë™ç
                    if (confirm(`ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ÂêåÂêç„ÅÆ„Äå${name}„Äç„ÅåÂ≠òÂú®„Åó„Åæ„Åô„ÄÇ\n\nÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇÇÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü`)) {
                        const masterIndex = prizeMaster.findIndex(p => p.name === name);
                        prizeMaster[masterIndex] = {
                            ...prizeMaster[masterIndex],
                            purchasePrice: purchasePrice,
                            value: value,
                            image: imageData
                        };
                        savePrizeMaster();
                        updatePrizeMasterList();
                    }
                }

                updatePrizeList();
                saveData();

                // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„É™„Çª„ÉÉ„Éà
                editContext = 'master';
                editingMainPrizeId = null;

                // „É°„Ç§„É≥„Çø„Éñ„Å´Êàª„Çã
                showTab('main');
            } else {
                // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÊõ¥Êñ∞
                const prizeIndex = prizeMaster.findIndex(p => p.id === editingMasterPrizeId);
                if (prizeIndex !== -1) {
                    prizeMaster[prizeIndex] = {
                        ...prizeMaster[prizeIndex],
                        name: name,
                        purchasePrice: purchasePrice,
                        value: value,
                        count: count,
                        type: type,
                        isWanted: isWanted,
                        image: imageData
                    };
                }
            }

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Çí‰øùÂ≠ò
            savePrizeMaster();

            // ÊôØÂìÅ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
            updatePrizeMasterList();

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeEditPrizeModal();
        }

        // ÂâäÈô§Á¢∫Ë™ç„ÅÆ„Åü„ÇÅ„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let pendingDeletePrizeId = null;

        // ÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openDeleteConfirmModal(prizeId) {
            console.log('ÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè - prizeId:', prizeId);

            const prize = prizeMaster.find(p => p.id === prizeId);
            if (!prize) {
                console.error('ÊôØÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                alert('ÊôØÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            pendingDeletePrizeId = prizeId;
            document.getElementById('deleteConfirmMessage').textContent = `„Äå${prize.name}„Äç„ÇíÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`;
            document.getElementById('deleteConfirmModal').style.display = 'flex';
        }

        // ÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeDeleteConfirmModal(confirmed) {
            console.log('ÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã - confirmed:', confirmed);
            document.getElementById('deleteConfirmModal').style.display = 'none';

            if (confirmed && pendingDeletePrizeId !== null) {
                executeDeletePrize(pendingDeletePrizeId);
            }

            pendingDeletePrizeId = null;
        }

        // ÂÆüÈöõ„ÅÆÂâäÈô§Âá¶ÁêÜ
        function executeDeletePrize(prizeId) {
            console.log('ÂâäÈô§Âá¶ÁêÜ„ÇíÂÆüË°å - prizeId:', prizeId);

            const prize = prizeMaster.find(p => p.id === prizeId);
            if (!prize) {
                console.error('ÊôØÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            const prizeName = prize.name;
            const beforeCount = prizeMaster.length;

            prizeMaster = prizeMaster.filter(p => p.id !== prizeId);

            const afterCount = prizeMaster.length;
            console.log(`ÂâäÈô§Ââç: ${beforeCount}‰ª∂, ÂâäÈô§Âæå: ${afterCount}‰ª∂`);

            savePrizeMaster();
            updatePrizeMasterList();

            console.log('ÂâäÈô§ÂÆå‰∫Ü');
            showNotification(`üóëÔ∏è ÊôØÂìÅ„Äå${prizeName}„Äç„ÇíÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
        }

        // ÊôØÂìÅ„ÇíÂâäÈô§ÔºàÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÔºâ
        function deletePrizeFromMaster(prizeId) {
            openDeleteConfirmModal(prizeId);
        }

        // ÁîªÂÉèÊã°Â§ßË°®Á§∫„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openImageViewModal(imageSrc, prizeName) {
            document.getElementById('imageViewImg').src = imageSrc;
            document.getElementById('imageViewImg').alt = prizeName;
            document.getElementById('imageViewModal').classList.add('active');
        }

        // ÁîªÂÉèÊã°Â§ßË°®Á§∫„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeImageViewModal() {
            document.getElementById('imageViewModal').classList.remove('active');
        }

        // Êñ∞Ë¶èÊôØÂìÅÁôªÈå≤„Éï„Ç©„Éº„É†„ÅÆË°®Á§∫/ÈùûË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleAddPrizeForm() {
            const container = document.getElementById('addPrizeFormContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                clearAddPrizeForm();
            }
        }

        // Êñ∞Ë¶èÊôØÂìÅÁôªÈå≤„Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
        function clearAddPrizeForm() {
            document.getElementById('newPrizeName').value = '';
            document.getElementById('newPrizePurchasePrice').value = '';
            document.getElementById('newPrizeValue').value = '';
            document.getElementById('newPrizeCount').value = '1';
            document.getElementById('newPrizeType').value = 'PSA10';
            document.getElementById('newPrizeIsWanted').checked = false;
            document.getElementById('newPrizeImageUrl').value = '';
            document.getElementById('prizeImagePreview').style.display = 'none';
        }

        // ÊôØÂìÅÁîªÂÉè„ÅÆ„Éó„É¨„Éì„É•„Éº
        function previewPrizeImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà2MBÔºâ
                if (file.size > 2 * 1024 * 1024) {
                    alert('ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô„ÄÇ2MB‰ª•‰∏ã„ÅÆÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('prizeImagePreviewImg').src = e.target.result;
                    document.getElementById('prizeImagePreview').style.display = 'block';
                    document.getElementById('newPrizeImageDropZone').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // „Éö„Éº„Çπ„Éà„Éª„Éâ„É≠„ÉÉ„Éó„Åï„Çå„ÅüÁîªÂÉè„Éï„Ç°„Ç§„É´„Çí‰∏ÄÊôÇ‰øùÂ≠ò
        let tempPastedFile = {
            newPrize: null,
            editPrize: null
        };

        // ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÂá¶ÁêÜ„Åô„ÇãÂÖ±ÈÄöÈñ¢Êï∞
        function handleImageFile(file, inputId, previewImgId, previewContainerId, dropZoneId) {
            if (!file || !file.type.startsWith('image/')) {
                alert('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                alert('ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô„ÄÇ2MB‰ª•‰∏ã„ÅÆÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            // Â∏∏„Å´‰∏ÄÊôÇ‰øùÂ≠òÔºà„Éö„Éº„Çπ„Éà/„Éâ„É≠„ÉÉ„Éó„ÅÆÂ†¥Âêà„Å´Á¢∫ÂÆü„Å´‰øùÂ≠òÔºâ
            if (inputId === 'newPrizeImage') {
                tempPastedFile.newPrize = file;
                console.log('Êñ∞Ë¶èÊôØÂìÅ„ÅÆÁîªÂÉè„Çí‰∏ÄÊôÇ‰øùÂ≠ò:', file.name, file.size);
            } else if (inputId === 'editPrizeImage') {
                tempPastedFile.editPrize = file;
                console.log('Á∑®ÈõÜÊôØÂìÅ„ÅÆÁîªÂÉè„Çí‰∏ÄÊôÇ‰øùÂ≠ò:', file.name, file.size);
            }

            // DataTransfer„ÇÇË©¶„Åø„ÇãÔºà„Éï„Ç°„Ç§„É´ÈÅ∏Êäû„ÉÄ„Ç§„Ç¢„É≠„Ç∞„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
            try {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById(inputId).files = dataTransfer.files;
            } catch (e) {
                // DataTransfer„ÅåÂ§±Êïó„Åó„Å¶„ÇÇtempPastedFile„Åå„ÅÇ„Çã„ÅÆ„ÅßÂïèÈ°å„Å™„Åó
                console.log('DataTransferÂ§±ÊïóÔºàtempPastedFile„Çí‰ΩøÁî®Ôºâ');
            }

            // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(previewImgId).src = e.target.result;
                document.getElementById(previewContainerId).style.display = 'block';
                if (dropZoneId) {
                    document.getElementById(dropZoneId).style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        }

        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
        function setupDragAndDrop(dropZoneId, inputId, previewImgId, previewContainerId) {
            const dropZone = document.getElementById(dropZoneId);

            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = 'rgba(0, 122, 255, 0.8)';
                this.style.background = 'rgba(0, 122, 255, 0.1)';
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = 'rgba(0, 122, 255, 0.3)';
                this.style.background = 'rgba(0, 122, 255, 0.03)';
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = 'rgba(0, 122, 255, 0.3)';
                this.style.background = 'rgba(0, 122, 255, 0.03)';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageFile(files[0], inputId, previewImgId, previewContainerId, dropZoneId);
                }
            });
        }

        // „Éö„Éº„Çπ„Éà„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
        function setupPaste(containerId, inputId, previewImgId, previewContainerId, dropZoneId) {
            const container = document.getElementById(containerId);

            container.addEventListener('paste', function(e) {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        handleImageFile(file, inputId, previewImgId, previewContainerId, dropZoneId);
                        e.preventDefault();
                        break;
                    }
                }
            });
        }

        // ÊôØÂìÅÁîªÂÉè„ÇíÂâäÈô§
        function removePrizeImage() {
            document.getElementById('newPrizeImage').value = '';
            document.getElementById('prizeImagePreview').style.display = 'none';
            document.getElementById('newPrizeImageDropZone').style.display = 'block';
            tempPastedFile.newPrize = null; // ‰∏ÄÊôÇ‰øùÂ≠ò„ÇÇ„ÇØ„É™„Ç¢
        }

        // Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´Áî®ÔºöÊôØÂìÅÁîªÂÉè„ÅÆ„Éó„É¨„Éì„É•„Éº
        function previewEditPrizeImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà2MBÔºâ
                if (file.size > 2 * 1024 * 1024) {
                    alert('ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô„ÄÇ2MB‰ª•‰∏ã„ÅÆÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editPrizeImagePreviewImg').src = e.target.result;
                    document.getElementById('editPrizeImagePreview').style.display = 'block';
                    document.getElementById('editPrizeImageDropZone').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´Áî®ÔºöÊôØÂìÅÁîªÂÉè„ÇíÂâäÈô§
        function removeEditPrizeImage() {
            document.getElementById('editPrizeImage').value = '';
            document.getElementById('editPrizeImagePreview').style.display = 'none';
            document.getElementById('editPrizeImageDropZone').style.display = 'block';
            // ÁîªÂÉèÂâäÈô§„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
            document.getElementById('editPrizeImagePreviewImg').setAttribute('data-removed', 'true');
            tempPastedFile.editPrize = null; // ‰∏ÄÊôÇ‰øùÂ≠ò„ÇÇ„ÇØ„É™„Ç¢
        }

        // Êñ∞Ë¶èÊôØÂìÅ„ÇíÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ËøΩÂä†
        function addNewPrizeToMaster() {
            const name = document.getElementById('newPrizeName').value.trim();
            const purchasePrice = parseFormattedNumber(document.getElementById('newPrizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('newPrizeValue').value);
            const count = parseInt(document.getElementById('newPrizeCount').value);
            const type = document.getElementById('newPrizeType').value;
            const isWanted = document.getElementById('newPrizeIsWanted').checked;
            const imageUrl = document.getElementById('newPrizeImageUrl').value.trim();

            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!name || purchasePrice <= 0 || value <= 0 || isNaN(count) || count < 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÂøÖÈ†àÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÂú®Â∫´Êï∞„ÅØ0‰ª•‰∏äÔºâ');
                return;
            }

            // ÁîªÂÉèURL„ÇíË®≠ÂÆöÔºàÁ©∫„ÅÆÂ†¥Âêà„ÅØnullÔºâ
            const imageData = imageUrl || null;

            // ÊôØÂìÅ„ÇíËøΩÂä†
            const newPrize = {
                id: Date.now() + Math.random(),
                name: name,
                purchasePrice: purchasePrice,
                value: value,
                count: count,
                type: type,
                isWanted: isWanted,
                image: imageData,
                addedAt: Date.now()
            };

            prizeMaster.push(newPrize);

            // „É°„Ç§„É≥„Åã„ÇâÂëº„Å∞„Çå„ÅüÂ†¥Âêà„ÄÅ„É°„Ç§„É≥„ÅÆÊôØÂìÅ„É™„Çπ„Éà„Å´„ÇÇËøΩÂä†„Åô„Çã„ÅãÁ¢∫Ë™ç
            if (editContext === 'main') {
                if (confirm(`ÊôØÂìÅ„Äå${name}„Äç„ÇíÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ÁôªÈå≤„Åó„Åæ„Åó„Åü„ÄÇ\n\n„É°„Ç§„É≥„Çø„Éñ„ÅÆÊôØÂìÅÁÆ°ÁêÜ„Å´„ÇÇËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü`)) {
                    // Á≠âÁ¥ö„ÇíÈÅ∏Êäû„Åï„Åõ„Çã
                    const rank = prompt('Á≠âÁ¥ö„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà1-5Ôºâ', '1');
                    if (rank && parseInt(rank) >= 1 && parseInt(rank) <= 5) {
                        const mainPrize = {
                            id: Date.now(),
                            name: name,
                            rank: parseInt(rank),
                            purchasePrice: purchasePrice,
                            value: value,
                            count: 1,
                            image: imageData
                        };
                        prizes.push(mainPrize);
                        updatePrizeList();
                        saveData();
                    }
                }

                // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„É™„Çª„ÉÉ„Éà
                editContext = 'master';

                // „É°„Ç§„É≥„Çø„Éñ„Å´Êàª„Çã
                showTab('main');
            }

            // ‰øùÂ≠ò„Å®Êõ¥Êñ∞
            savePrizeMaster();
            updatePrizeMasterList();

            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢„Åó„Å¶Èñâ„Åò„Çã
            clearAddPrizeForm();
            document.getElementById('addPrizeFormContainer').style.display = 'none';

            // ÊàêÂäüÈÄöÁü•
            showNotification(`‚úÖ ÊôØÂìÅ„Äå${name}„Äç„ÇíÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ËøΩÂä†„Åó„Åæ„Åó„ÅüÔºàÂú®Â∫´${count}ÂÄãÔºâ`, 'success');
        }

        // Êñ∞Ë¶èÊôØÂìÅÁôªÈå≤„Çí„Ç≠„É£„É≥„Çª„É´
        function cancelAddPrize() {
            clearAddPrizeForm();
            document.getElementById('addPrizeFormContainer').style.display = 'none';
        }

        // „É¢„Éº„ÉÄ„É´„ÅÆÂ§ñÂÅ¥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈñâ„Åò„Çã
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('editPrizeModal');
            if (event.target === modal) {
                closeEditPrizeModal();
            }
        });

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇílocalStorage„Åã„ÇâË™≠„ÅøËæº„ÇÄ
        document.addEventListener('DOMContentLoaded', function() {
            // „Åæ„ÅölocalStorage„Åã„ÇâË™≠„ÅøËæº„ÅøÔºàÂç≥Â∫ß„Å´Ë°®Á§∫Ôºâ
            loadPrizeMaster();

            // FirebaseË™çË®º„ÇíÊó©Êúü„Å´ÈñãÂßãÔºà„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÈò≤Ê≠¢Ôºâ
            setTimeout(() => {
                initializeAuth();
                loadInventoryAdjustmentData(); // Âú®Â∫´Ë™øÊï¥„Éá„Éº„Çø„ÇÇË™≠„ÅøËæº„Åø
            }, 500);

            // „ÇΩ„Éº„Éà„Éª„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö„ÇíÂæ©ÂÖÉ
            try {
                const savedSortBy = localStorage.getItem('prizeMasterSortBy');
                const savedSortOrder = localStorage.getItem('prizeMasterSortOrder');
                const savedFilter = localStorage.getItem('prizeMasterFilter');
                const savedTypeFilter = localStorage.getItem('prizeMasterTypeFilter');
                const savedWantedFilter = localStorage.getItem('prizeMasterWantedFilter');
                const savedSalesFilter = localStorage.getItem('prizeMasterSalesFilter');
                const savedSearchText = localStorage.getItem('prizeMasterSearchText');

                if (savedSortBy) {
                    const sortBySelect = document.getElementById('prizeMasterSortBy');
                    if (sortBySelect) sortBySelect.value = savedSortBy;
                }

                if (savedSortOrder) {
                    const sortOrderSelect = document.getElementById('prizeMasterSortOrder');
                    if (sortOrderSelect) sortOrderSelect.value = savedSortOrder;
                }

                if (savedFilter) {
                    const filterSelect = document.getElementById('prizeMasterFilter');
                    if (filterSelect) filterSelect.value = savedFilter;
                }

                if (savedTypeFilter) {
                    const typeFilterSelect = document.getElementById('prizeMasterTypeFilter');
                    if (typeFilterSelect) typeFilterSelect.value = savedTypeFilter;
                }

                if (savedWantedFilter) {
                    const wantedFilterCheckbox = document.getElementById('prizeMasterWantedFilter');
                    if (wantedFilterCheckbox) wantedFilterCheckbox.checked = savedWantedFilter === 'true';
                }

                if (savedSalesFilter) {
                    const salesFilterSelect = document.getElementById('prizeMasterSalesFilter');
                    if (salesFilterSelect) salesFilterSelect.value = savedSalesFilter;
                }

                if (savedSearchText) {
                    const searchTextInput = document.getElementById('prizeMasterSearchText');
                    if (searchTextInput) searchTextInput.value = savedSearchText;
                }
            } catch (e) {
                console.error('Ë®≠ÂÆö„ÅÆÂæ©ÂÖÉ„Å´Â§±Êïó:', e);
            }

            // ÁîªÂÉèURL„É¢„Éº„Éâ„Å´Â§âÊõ¥„Åó„Åü„Åü„ÇÅ„ÄÅ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅØ‰∏çË¶Å

            // FirebaseË™çË®º„ÇíÈñãÂßã
            console.log('üîê FirebaseË™çË®º„ÇíÈñãÂßã„Åó„Åæ„Åô...');
            initializeAuth();

            // FirebaseÊé•Á∂öÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            setTimeout(() => {
                console.log('=== FirebaseÊé•Á∂öÁä∂ÊÖã ===');
                console.log('database:', typeof database);
                console.log('auth:', typeof auth);
                console.log('isAuthReady:', isAuthReady);
                console.log('auth.currentUser:', auth.currentUser ? 'Ë™çË®ºÊ∏à„Åø' : 'Êú™Ë™çË®º');
                console.log('========================');
            }, 2000);
        });

        // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöFirebase„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
        window.debugFirebase = function() {
            console.log('=== Firebase „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± ===');
            console.log('FirebaseÂàùÊúüÂåñ:', typeof firebase !== 'undefined' ? 'OK' : 'NG');
            console.log('Database:', typeof database !== 'undefined' ? 'OK' : 'NG');
            console.log('Auth:', typeof auth !== 'undefined' ? 'OK' : 'NG');
            console.log('Ë™çË®ºÁä∂ÊÖã:', isAuthReady ? 'Ë™çË®ºÊ∏à„Åø' : 'Êú™Ë™çË®º');
            console.log('ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº:', auth.currentUser ? auth.currentUser.uid : '„Å™„Åó');

            // „ÇØ„É©„Ç¶„Éâ„Åã„Çâ„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç
            if (typeof database !== 'undefined' && isAuthReady) {

                // Ë®≠ÂÆö„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç
                console.log('\n--- Ë®≠ÂÆö„Éá„Éº„Çø(/configs) ---');
                database.ref('configs').once('value').then((snapshot) => {
                    const configs = snapshot.val();
                    console.log('„ÇØ„É©„Ç¶„Éâ„ÅÆË®≠ÂÆö:', configs ? '„ÅÇ„Çä' : '„Å™„Åó');
                    if (configs) {
                        const keys = Object.keys(configs);
                        console.log('Ë®≠ÂÆö‰ª∂Êï∞:', keys.length, '‰ª∂');
                        if (keys.length > 0) {
                            console.log('Ë®≠ÂÆö‰∏ÄË¶ß:');
                            keys.slice(0, 10).forEach((key, i) => {
                                const cfg = configs[key];
                                const date = cfg.updatedAt ? new Date(cfg.updatedAt).toLocaleString('ja-JP') : '‰∏çÊòé';
                                console.log(`  [${i}] ${key} (Êõ¥Êñ∞: ${date})`);
                            });
                            if (keys.length > 10) {
                                console.log(`  ... ‰ªñ${keys.length - 10}‰ª∂`);
                            }
                        }
                    }
                }).catch((error) => {
                    console.error('Ë®≠ÂÆö„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç„Å´Â§±Êïó:', error);
                });
            }
            console.log('===========================');
        };

        // „Éö„Éº„Ç∏„Å´FirebaseÁä∂ÊÖã„ÇíË°®Á§∫ÔºàÈñãÁô∫Áî®Ôºâ
        console.log('%cüí° „Éá„Éê„ÉÉ„Ç∞TIP', 'color: #34C759; font-weight: bold; font-size: 14px;');
        console.log('„Ç≥„É≥„ÇΩ„Éº„É´„Åß debugFirebase() „ÇíÂÆüË°å„Åô„Çã„Å®„ÄÅFirebase„ÅÆÊé•Á∂öÁä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô');

        // ==================================================
        // Âú®Â∫´Ë™øÊï¥Ê©üËÉΩÔºàÊñ∞ÁâàÔºâ
        // ==================================================

        // Âú®Â∫´Ë™øÊï¥„Éá„Éº„Çø
        let shippingCsvData = [];  // CSV„Åã„ÇâË™≠„ÅøËæº„Çì„Å†Áô∫ÈÄÅ„Éá„Éº„ÇøÔºàÂÖ®„Éá„Éº„ÇøÔºâ
        let filteredShippingData = []; // ÈÅ∏Êäû„Åï„Çå„ÅüÊ≥®Êñá„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø
        let pendingOrders = [];    // Êú™Áô∫ÈÄÅÊ≥®Êñá„É™„Çπ„Éà
        let shippedOrderIds = new Set(); // Áô∫ÈÄÅÊ∏à„ÅøÊ≥®ÊñáID„Çª„ÉÉ„ÉàÔºàÈáçË§áÈò≤Ê≠¢Áî®Ôºâ
        let inventoryHistory = []; // Âú®Â∫´Â¢óÊ∏õÂ±•Ê≠¥
        let randomPackCount = 0;   // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅÆÊï∞
        let randomPackSelections = {}; // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØÈÅ∏ÊäûÁä∂ÊÖã
        let csvOrdersList = [];    // CSV„Åã„ÇâË™≠„ÅøËæº„Çì„Å†Ê≥®Êñá„É™„Çπ„ÉàÔºàÊ≥®ÊñáIDÂçò‰ΩçÔºâ
        let selectedOrderIds = new Set(); // ÈÅ∏Êäû„Åï„Çå„ÅüÊ≥®ÊñáID

        // ÊôØÂìÅÂêç„ÅÆÊ≠£Ë¶èÂåñÔºà„Éû„ÉÉ„ÉÅ„É≥„Ç∞Áî®Ôºâ
        // _ „Å® - „ÇíÁµ±‰∏Ä„ÄÅ() „Å® [] „ÇíÁµ±‰∏Ä
        function normalizePrizeName(name) {
            if (!name) return '';
            return name
                .replace(/_/g, '-')      // _ „Çí - „Å´Áµ±‰∏Ä
                .replace(/\[/g, '(')     // [ „Çí ( „Å´Áµ±‰∏Ä
                .replace(/\]/g, ')')     // ] „Çí ) „Å´Áµ±‰∏Ä
                .trim();
        }

        // Ê≠£Ë¶èÂåñ„Åó„ÅüÂêçÂâç„ÅßÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÊ§úÁ¥¢
        function findPrizeByNormalizedName(prizeName) {
            const normalizedSearch = normalizePrizeName(prizeName);
            // „Åæ„ÅöÂÆåÂÖ®‰∏ÄËá¥„ÇíË©¶„Åô
            let found = prizeMaster.find(p => p.name === prizeName);
            if (found) return found;
            // Ê≠£Ë¶èÂåñ„Åó„ÅüÂêçÂâç„ÅßÊ§úÁ¥¢
            return prizeMaster.find(p => normalizePrizeName(p.name) === normalizedSearch);
        }

        // „Çµ„Éñ„Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchInventorySubTab(tabName, btn) {
            // „Åô„Åπ„Å¶„ÅÆ„Çµ„Éñ„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.inv-subtab-content').forEach(el => {
                el.style.display = 'none';
            });
            // „Åô„Åπ„Å¶„ÅÆ„Éú„Çø„É≥„ÇíÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
            document.querySelectorAll('.inv-subtab-btn').forEach(el => {
                el.style.background = 'rgba(0, 0, 0, 0.05)';
                el.style.color = 'var(--sf-gray)';
            });
            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„ÇíË°®Á§∫
            document.getElementById('inv-subtab-' + tabName).style.display = 'block';
            // „Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
            btn.style.background = 'var(--sf-blue)';
            btn.style.color = 'white';

            // Â±•Ê≠¥„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØ‰ªäÊó•„ÅÆÊó•‰ªò„Çí„Çª„ÉÉ„Éà
            if (tabName === 'history') {
                setHistoryDateToday();
            }

            // Âú®Â∫´ÁôªÈå≤„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØË¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
            if (tabName === 'register') {
                renderNeedRestockList();
            }
        }

        // ========== Âú®Â∫´Ê∏õÂ∞ëÊ©üËÉΩ ==========

        // CSV„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄ
        function loadShippingCsv(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('shippingCsvFileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const arrayBuffer = e.target.result;

                    // Shift-JIS „Åß„Éá„Ç≥„Éº„Éâ„ÇíË©¶„Åø„Çã
                    let csvText;
                    try {
                        const decoder = new TextDecoder('shift_jis');
                        csvText = decoder.decode(arrayBuffer);
                    } catch (decodeError) {
                        // Shift-JIS „Åß„Éá„Ç≥„Éº„Éâ„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØ UTF-8 „ÅßË©¶„Åô
                        const decoder = new TextDecoder('utf-8');
                        csvText = decoder.decode(arrayBuffer);
                    }

                    // ÂçäËßí„Ç´„Çø„Ç´„Éä„ÇíÂÖ®Ëßí„Å´Â§âÊèõ
                    csvText = convertHalfWidthKatakana(csvText);

                    parseShippingCsv(csvText);
                } catch (error) {
                    console.error('CSV„ÅÆËß£Êûê„Å´Â§±Êïó:', error);
                    document.getElementById('shippingCsvStatus').innerHTML =
                        '<span style="color: var(--sf-red);">CSV„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message + '</span>';
                }
            };
            reader.readAsArrayBuffer(file); // ArrayBuffer„Å®„Åó„Å¶Ë™≠„ÅøËæº„Åø
        }

        // ÂçäËßí„Ç´„Çø„Ç´„Éä„ÇíÂÖ®Ëßí„Ç´„Çø„Ç´„Éä„Å´Â§âÊèõ
        function convertHalfWidthKatakana(str) {
            // ÂçäËßí„Ç´„Çø„Ç´„Éä ‚Üí ÂÖ®Ëßí„Ç´„Çø„Ç´„ÉäÂ§âÊèõ„Éû„ÉÉ„Éó
            const kanaMap = {
                'ÔΩ∂Ôæû': '„Ç¨', 'ÔΩ∑Ôæû': '„ÇÆ', 'ÔΩ∏Ôæû': '„Ç∞', 'ÔΩπÔæû': '„Ç≤', 'ÔΩ∫Ôæû': '„Ç¥',
                'ÔΩªÔæû': '„Ç∂', 'ÔΩºÔæû': '„Ç∏', 'ÔΩΩÔæû': '„Ç∫', 'ÔΩæÔæû': '„Çº', 'ÔΩøÔæû': '„Çæ',
                'ÔæÄÔæû': '„ÉÄ', 'ÔæÅÔæû': '„ÉÇ', 'ÔæÇÔæû': '„ÉÖ', 'ÔæÉÔæû': '„Éá', 'ÔæÑÔæû': '„Éâ',
                'ÔæäÔæû': '„Éê', 'ÔæãÔæû': '„Éì', 'ÔæåÔæû': '„Éñ', 'ÔæçÔæû': '„Éô', 'ÔæéÔæû': '„Éú',
                'ÔæäÔæü': '„Éë', 'ÔæãÔæü': '„Éî', 'ÔæåÔæü': '„Éó', 'ÔæçÔæü': '„Éö', 'ÔæéÔæü': '„Éù',
                'ÔΩ≥Ôæû': '„É¥',
                'ÔΩ±': '„Ç¢', 'ÔΩ≤': '„Ç§', 'ÔΩ≥': '„Ç¶', 'ÔΩ¥': '„Ç®', 'ÔΩµ': '„Ç™',
                'ÔΩ∂': '„Ç´', 'ÔΩ∑': '„Ç≠', 'ÔΩ∏': '„ÇØ', 'ÔΩπ': '„Ç±', 'ÔΩ∫': '„Ç≥',
                'ÔΩª': '„Çµ', 'ÔΩº': '„Ç∑', 'ÔΩΩ': '„Çπ', 'ÔΩæ': '„Çª', 'ÔΩø': '„ÇΩ',
                'ÔæÄ': '„Çø', 'ÔæÅ': '„ÉÅ', 'ÔæÇ': '„ÉÑ', 'ÔæÉ': '„ÉÜ', 'ÔæÑ': '„Éà',
                'ÔæÖ': '„Éä', 'ÔæÜ': '„Éã', 'Ôæá': '„Éå', 'Ôæà': '„Éç', 'Ôæâ': '„Éé',
                'Ôæä': '„Éè', 'Ôæã': '„Éí', 'Ôæå': '„Éï', 'Ôæç': '„Éò', 'Ôæé': '„Éõ',
                'Ôæè': '„Éû', 'Ôæê': '„Éü', 'Ôæë': '„É†', 'Ôæí': '„É°', 'Ôæì': '„É¢',
                'Ôæî': '„É§', 'Ôæï': '„É¶', 'Ôæñ': '„É®',
                'Ôæó': '„É©', 'Ôæò': '„É™', 'Ôæô': '„É´', 'Ôæö': '„É¨', 'Ôæõ': '„É≠',
                'Ôæú': '„ÉØ', 'ÔΩ¶': '„É≤', 'Ôæù': '„É≥',
                'ÔΩß': '„Ç°', 'ÔΩ®': '„Ç£', 'ÔΩ©': '„Ç•', 'ÔΩ™': '„Çß', 'ÔΩ´': '„Ç©',
                'ÔΩØ': '„ÉÉ', 'ÔΩ¨': '„É£', 'ÔΩ≠': '„É•', 'ÔΩÆ': '„Éß',
                'ÔΩ∞': '„Éº', 'ÔΩ°': '„ÄÇ', 'ÔΩ¢': '„Äå', 'ÔΩ£': '„Äç', 'ÔΩ§': '„ÄÅ', 'ÔΩ•': '„Éª'
            };

            // ÊøÅÁÇπ„ÉªÂçäÊøÅÁÇπ„ÇíÂÖà„Å´Âá¶ÁêÜÔºà2ÊñáÂ≠ó„ÅÆÁµÑ„ÅøÂêà„Çè„ÅõÔºâ
            let result = str;
            for (const [half, full] of Object.entries(kanaMap)) {
                if (half.length === 2) {
                    result = result.split(half).join(full);
                }
            }
            // ÂçòÁã¨„ÅÆÊñáÂ≠ó„ÇíÂá¶ÁêÜ
            for (const [half, full] of Object.entries(kanaMap)) {
                if (half.length === 1) {
                    result = result.split(half).join(full);
                }
            }

            // ÊÆã„Å£„ÅüÊøÅÁÇπ„ÉªÂçäÊøÅÁÇπ„ÅÆÂá¶ÁêÜÔºàÂà•„ÅÆÂΩ¢Âºè„Åß‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
            // U+FF9E (Ôæû) ÊøÅÁÇπ, U+FF9F (Ôæü) ÂçäÊøÅÁÇπ
            // U+3099 („Çô) ÁµêÂêàÊøÅÁÇπ, U+309A („Çö) ÁµêÂêàÂçäÊøÅÁÇπ
            const dakutenMap = {
                '„Ç´': '„Ç¨', '„Ç≠': '„ÇÆ', '„ÇØ': '„Ç∞', '„Ç±': '„Ç≤', '„Ç≥': '„Ç¥',
                '„Çµ': '„Ç∂', '„Ç∑': '„Ç∏', '„Çπ': '„Ç∫', '„Çª': '„Çº', '„ÇΩ': '„Çæ',
                '„Çø': '„ÉÄ', '„ÉÅ': '„ÉÇ', '„ÉÑ': '„ÉÖ', '„ÉÜ': '„Éá', '„Éà': '„Éâ',
                '„Éè': '„Éê', '„Éí': '„Éì', '„Éï': '„Éñ', '„Éò': '„Éô', '„Éõ': '„Éú',
                '„Ç¶': '„É¥'
            };
            const handakutenMap = {
                '„Éè': '„Éë', '„Éí': '„Éî', '„Éï': '„Éó', '„Éò': '„Éö', '„Éõ': '„Éù'
            };

            // Êó¢Áü•„ÅÆÊñáÂ≠óÂåñ„Åë„Éë„Çø„Éº„É≥„ÇíÁõ¥Êé•‰øÆÊ≠£ÔºàÊ≠£Ë¶èË°®Áèæ„Çí‰Ωø„Çè„Å™„ÅÑÂçòÁ¥îÁΩÆÊèõ„ÇíÂÖà„Å´ÂÆüË°åÔºâ
            const knownFixes = [
                // „Çà„Åè‰Ωø„Çè„Çå„ÇãÂïÜÂìÅÂêç„Éë„Çø„Éº„É≥
                ['„É°„Ç´?„Éà?„É™„Éº„É†', '„É°„Ç¨„Éâ„É™„Éº„É†'],
                ['„Éè?„ÉÉ„ÇØ', '„Éë„ÉÉ„ÇØ'],
                ['„Éõ?„ÉÉ„ÇØ„Çπ', '„Éú„ÉÉ„ÇØ„Çπ'],
                ['„Éí?„Ç´„ÉÅ„É•„Ç¶', '„Éî„Ç´„ÉÅ„É•„Ç¶'],
                ['„É™„Çµ?„Éº„Éà?„É≥', '„É™„Ç∂„Éº„Éâ„É≥'],
                ['„É™„Çµ?„Éº„Éà?', '„É™„Ç∂„Éº„Éâ'],
                ['„Éï?„É©„ÉÉ„Ç≠„Éº', '„Éñ„É©„ÉÉ„Ç≠„Éº'],
                ['„Çµ„É≥„Çø?„Éº„Çπ', '„Çµ„É≥„ÉÄ„Éº„Çπ'],
                ['„Ç∑„É£„ÉØ„Éº„Çπ?', '„Ç∑„É£„ÉØ„Éº„Ç∫'],
                ['„ÇØ?„É¨„Ç§„Ç∑„Ç¢', '„Ç∞„É¨„Ç§„Ç∑„Ç¢'],
                ['„É¨„ÉÉ„Éà?„ÅÆ', '„É¨„ÉÉ„Éâ„ÅÆ'],
                ['„ÉÜ?„É≥„Ç∑?„É•', '„Éá„É≥„Ç∏„É•'],
                ['„Éä„É≥„Ç∑?„É£„É¢', '„Éä„É≥„Ç∏„É£„É¢'],
                ['„Ç´?„Ç§„É™„É•„Éº', '„Ç´„Ç§„É™„É•„Éº'], // „Åì„Çå„ÅØÊøÅÁÇπ„Åß„ÅØ„Å™„ÅÑ
                ['„É°„Ç´?„Ç´„Ç§„É™„É•„Éº', '„É°„Ç¨„Ç´„Ç§„É™„É•„Éº'],
                ['„ÉÜ?„Ç£„É≥„ÇØ?', '„Éá„Ç£„É≥„ÇØ'],
                ['„Éí?„Éº„Éà?„É≠„É≥', '„Éì„Éº„Éâ„É≠„É≥'],
                ['„Éõ?„Çπ„Ç≥?„É©', '„Éú„Çπ„Ç¥„Éâ„É©'],
                ['„Éè?„Éº„Éä„Éº', '„Éê„Éº„Éä„Éº'],
                ['„Çπ?„Éõ?„Éü„Éº', '„Ç∫„Éú„Éü„Éº'],
                ['„Éà?„É©„Ç≥?„É≥', '„Éâ„É©„Ç¥„É≥'],
                ['„Éà?„É™„Éº„É†', '„Éâ„É™„Éº„É†'],
                ['„Ç´?„É´„Éº„É©', '„Ç¨„É´„Éº„É©'],
                ['„Ç≥?„Ç¶„Ç´?„Çµ?„É´', '„Ç¥„Ç¶„Ç´„Ç∂„É´'],
                ['„Éï?„Éº„Éè?„Éº', '„Éñ„Éº„Éê„Éº'],
                ['„Ç±?„É≥„Ç´?„Éº', '„Ç≤„É≥„Ç¨„Éº'],
                ['„Ç®„É¨„Ç≠„Éï?„É´', '„Ç®„É¨„Ç≠„Éñ„É´'],
                ['„É™„Éº„É™„Ç®„ÅÆÊ±∫ÂøÉ', '„É™„Éº„É™„Ç®„ÅÆÊ±∫ÂøÉ'], // „Åì„Çå„ÅØOK
            ];

            for (const [broken, fixed] of knownFixes) {
                result = result.split(broken).join(fixed);
            }

            // ÊøÅÁÇπ„ÅÆÂá¶ÁêÜÔºàÊßò„ÄÖ„Å™ÂΩ¢Âºè„Å´ÂØæÂøú: ÁµêÂêàÊøÅÁÇπ, ÂçäËßíÊøÅÁÇπ, ?„Éû„Éº„ÇØÔºâ
            // „ÉèË°å„ÅØÈô§Â§ñÔºà„ÉëË°å„Å®„ÅÆÂå∫Âà•„Åå„Å§„Åã„Å™„ÅÑ„Åü„ÇÅ„ÄÅ‰∏ä„ÅÆknownFixes„ÅßÂÄãÂà•ÂØæÂøúÔºâ
            result = result.replace(/([„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Ç¶])[\u3099\uFF9E?]/g, (match, char) => {
                return dakutenMap[char] || match;
            });

            // ÂçäÊøÅÁÇπ„ÅÆÂá¶ÁêÜÔºàÊßò„ÄÖ„Å™ÂΩ¢Âºè„Å´ÂØæÂøú: ÁµêÂêàÂçäÊøÅÁÇπ, ÂçäËßíÂçäÊøÅÁÇπÔºâ
            result = result.replace(/([„Éè„Éí„Éï„Éò„Éõ])[\u309A\uFF9F]/g, (match, char) => {
                return handakutenMap[char] || match;
            });

            return result;
        }

        // Èô§Â§ñ„É¶„Éº„Ç∂„ÉºIDÔºà„ÉÜ„Çπ„Éà„ÉªÈÅãÂñ∂„Ç¢„Ç´„Ç¶„É≥„ÉàÔºâ
        const EXCLUDED_USER_IDS = [545, 117, 549, 793, 1874, 2075, 2265];

        // Èô§Â§ñ„Ç¢„Ç§„ÉÜ„É†„Éë„Çø„Éº„É≥
        const EXCLUDED_ITEM_PATTERNS = ['„Ç≥„Ç§„É≥', '„ÉÅ„Ç±„ÉÉ„Éà', '„Éó„É¨„Çº„É≥„Éà'];

        // „Ç¢„Ç§„ÉÜ„É†„ÅåÈô§Â§ñÂØæË±°„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isExcludedItem(name) {
            // „Äå„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„Äç„ÅØÈô§Â§ñ„Åó„Å™„ÅÑÔºà„Ç≥„Ç§„É≥Ë°®Ë®ò„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å¶„ÇÇÔºâ
            if (name.includes('„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ')) {
                return false;
            }
            return EXCLUDED_ITEM_PATTERNS.some(pattern => name.includes(pattern));
        }

        // CSV„Çí„Éë„Éº„ÇπÔºàÊ≥®Êñá‰∏ÄË¶ßCSVÂΩ¢ÂºèÂØæÂøúÔºâ
        function parseShippingCsv(csvText) {
            // Ë§áÊï∞Ë°å„Éï„Ç£„Éº„É´„Éâ„ÇíÂê´„ÇÄCSV„Çí„Éë„Éº„Çπ
            const records = parseCSVWithMultiline(csvText);

            if (records.length < 3) { // „Éò„ÉÉ„ÉÄ„Éº2Ë°å + „Éá„Éº„Çø1Ë°å‰ª•‰∏ä
                document.getElementById('shippingCsvStatus').innerHTML =
                    '<span style="color: var(--sf-red);">CSV„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span>';
                return;
            }

            // ÊúÄÂàù„ÅÆË°å„Åå„Ç´„É©„É†ÂêçÔºàËã±Ë™ûÔºâ
            const headers = records[0];
            console.log('CSV„Éò„ÉÉ„ÉÄ„Éº:', headers);

            // 2Ë°åÁõÆ„ÅØÊó•Êú¨Ë™û„Éò„ÉÉ„ÉÄ„Éº„Å™„ÅÆ„Åß„Çπ„Ç≠„ÉÉ„Éó

            // „Ç´„É©„É†„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÁâπÂÆö
            const idIdx = headers.indexOf('id');  // Áô∫ÈÄÅID
            const orderIdIdx = headers.indexOf('order_id');
            const itemNamesIdx = headers.indexOf('item_names');
            const userIdIdx = headers.indexOf('user_id');
            const statusIdx = headers.indexOf('status');
            const createdAtIdx = headers.indexOf('created_at');
            const lastNameIdx = headers.indexOf('last_name');
            const firstNameIdx = headers.indexOf('first_name');

            if (orderIdIdx === -1 || itemNamesIdx === -1 || statusIdx === -1) {
                document.getElementById('shippingCsvStatus').innerHTML =
                    '<span style="color: var(--sf-red);">CSV„ÅÆÂΩ¢Âºè„Åå‰∏çÊ≠£„Åß„Åô„ÄÇorder_id, item_names, status „Ç´„É©„É†„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ</span>';
                return;
            }

            // „Éá„Éº„ÇøË°å„ÇíËß£ÊûêÔºà3Ë°åÁõÆ„Åã„ÇâÔºâ
            shippingCsvData = [];
            filteredShippingData = [];
            csvOrdersList = [];
            selectedOrderIds = new Set();
            let shippedCount = 0;
            let pendingCount = 0;
            let randomPackTotal = 0;
            let excludedCount = 0;

            for (let i = 2; i < records.length; i++) {
                const row = records[i];
                if (row.length <= Math.max(orderIdIdx, itemNamesIdx, statusIdx)) continue;

                const id = row[idIdx] || '';  // Áô∫ÈÄÅID
                const orderId = row[orderIdIdx] || '';
                const itemNamesRaw = row[itemNamesIdx] || '';
                const userId = parseInt(row[userIdIdx]) || 0;
                const status = row[statusIdx] || '';
                const createdAt = row[createdAtIdx] || '';
                const customerName = (row[lastNameIdx] || '') + ' ' + (row[firstNameIdx] || '');

                // Èô§Â§ñ„É¶„Éº„Ç∂„Éº„Çí„Çπ„Ç≠„ÉÉ„Éó
                if (EXCLUDED_USER_IDS.includes(userId)) {
                    excludedCount++;
                    continue;
                }

                if (!orderId || !itemNamesRaw) continue;

                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂà§ÂÆö
                const isShipped = status === 'Áô∫ÈÄÅÊ∏à„Åø' || status === 'shipped';
                const isPending = status === 'Áô∫ÈÄÅÂæÖ„Å°' || status === 'shipping_pending' || status === 'pending';

                if (!isShipped && !isPending) continue;

                // item_names „ÇíÊîπË°å„ÅßÂàÜÂâ≤„Åó„Å¶ÂêÑ„Ç¢„Ç§„ÉÜ„É†„ÇíÂá¶ÁêÜ
                const items = itemNamesRaw.split('\n').map(s => s.trim()).filter(s => s.length > 0);

                console.log(`Ê≥®Êñá ${orderId} (ID:${id}): item_namesÁîüÂÄ§=`, JSON.stringify(itemNamesRaw));
                console.log(`  ‚Üí ÂàÜÂâ≤Âæå: ${items.length}‰ª∂`, items);

                items.forEach(prizeName => {
                    // Èô§Â§ñ„Ç¢„Ç§„ÉÜ„É†„Çí„Çπ„Ç≠„ÉÉ„Éó
                    if (isExcludedItem(prizeName)) {
                        console.log(`  Èô§Â§ñ: ${prizeName}`);
                        return;
                    }

                    const isRandomPack = prizeName.includes('„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ');
                    if (isRandomPack) {
                        console.log(`  „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØÊ§úÂá∫: ${prizeName}`);
                    }

                    // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅÆÊûöÊï∞„ÇíÊäΩÂá∫Ôºà‰æã: "„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ6Êûö„Çª„ÉÉ„Éà" ‚Üí 6Ôºâ
                    let randomPackQty = 1;
                    if (isRandomPack) {
                        const packMatch = prizeName.match(/„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ(\d+)Êûö/);
                        if (packMatch) {
                            randomPackQty = parseInt(packMatch[1]) || 1;
                        }
                    }

                    // Âêå„ÅòID + ÊôØÂìÅÂêç„ÅÆÊó¢Â≠ò„Ç¢„Ç§„ÉÜ„É†„ÇíÊ§úÁ¥¢ÔºàÂêå‰∏ÄË°åÂÜÖ„ÅßÈáçË§á„Åô„ÇãÂ†¥Âêà„Å´Áµ±ÂêàÔºâ
                    const existingItem = shippingCsvData.find(item =>
                        item.id === id &&
                        item.orderId === orderId &&
                        item.prizeName === prizeName &&
                        item.status === (isShipped ? 'shipped' : 'pending')
                    );

                    if (existingItem) {
                        // Êó¢Â≠ò„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„Çå„Å∞Êï∞Èáè„ÇíÂ¢ó„ÇÑ„Åô
                        existingItem.quantity = (existingItem.quantity || 1) + 1;
                        if (isRandomPack) {
                            existingItem.randomPackQty = (existingItem.randomPackQty || 0) + randomPackQty;
                        }
                        console.log(`  üì¶ ÈáçË§áÊôØÂìÅ„ÇíÁµ±Âêà: ${prizeName} ‚Üí ${existingItem.quantity}ÂÄã`);
                    } else {
                        // Êñ∞Ë¶è„Ç¢„Ç§„ÉÜ„É†„Å®„Åó„Å¶ËøΩÂä†
                        shippingCsvData.push({
                            id: id,  // Áô∫ÈÄÅID
                            orderId: orderId,
                            prizeName: prizeName,
                            status: isShipped ? 'shipped' : 'pending',
                            quantity: 1,
                            isRandomPack: isRandomPack,
                            randomPackQty: randomPackQty,  // „Éë„ÉÉ„ÇØ„ÅÆÊûöÊï∞
                            userId: userId,
                            createdAt: createdAt,
                            customerName: customerName.trim()
                        });
                    }

                    if (isShipped) {
                        shippedCount++;
                        if (isRandomPack) {
                            randomPackTotal += randomPackQty;  // ÊûöÊï∞ÂàÜ„ÇíÂä†ÁÆó
                        }
                    } else {
                        pendingCount++;
                    }
                });
            }

            randomPackCount = randomPackTotal;

            // Ê≥®ÊñáID„Åß„Ç∞„É´„Éº„ÉóÂåñ„Åó„Å¶„É™„Çπ„Éà„Çí‰ΩúÊàê
            const orderMap = {};
            shippingCsvData.forEach(item => {
                if (!orderMap[item.orderId]) {
                    orderMap[item.orderId] = {
                        orderId: item.orderId,
                        ids: [],  // Áô∫ÈÄÅID„É™„Çπ„Éà
                        status: item.status,
                        customerName: item.customerName || '',
                        createdAt: item.createdAt || '',
                        items: [],
                        itemCount: 0,
                        randomPackQty: 0  // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØÊûöÊï∞
                    };
                }
                // Áô∫ÈÄÅID„ÇíËøΩÂä†ÔºàÈáçË§á„ÇíÈÅø„Åë„ÇãÔºâ
                if (item.id && !orderMap[item.orderId].ids.includes(item.id)) {
                    orderMap[item.orderId].ids.push(item.id);
                }
                orderMap[item.orderId].items.push(item.prizeName);
                orderMap[item.orderId].itemCount++;
                // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØÊûöÊï∞„ÇíÂä†ÁÆó
                if (item.isRandomPack) {
                    orderMap[item.orderId].randomPackQty += (item.randomPackQty || 1);
                }
            });

            console.log('Ê≥®Êñá„Ç∞„É´„Éº„Éó:', Object.values(orderMap).map(o => ({
                orderId: o.orderId,
                itemCount: o.itemCount,
                randomPackQty: o.randomPackQty,
                items: o.items
            })));
            csvOrdersList = Object.values(orderMap);

            // ÂÖ®Ê≥®Êñá„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
            selectedOrderIds.clear();
            csvOrdersList.forEach(order => selectedOrderIds.add(order.orderId));

            // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
            document.getElementById('shippingCsvStatus').innerHTML =
                `<span style="color: var(--sf-green);">CSVË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÔºÅÔºà${csvOrdersList.length}‰ª∂„ÅÆÊ≥®Êñá„ÄÅÈô§Â§ñ: ${excludedCount}‰ª∂Ôºâ</span>`;

            // Ê≥®ÊñáÈÅ∏Êäû„Çπ„ÉÜ„ÉÉ„Éó„ÇíË°®Á§∫
            document.getElementById('orderSelectionStep').style.display = 'block';
            document.getElementById('shippingCsvSummary').style.display = 'none';
            document.getElementById('shippedOrdersList').style.display = 'none';
            document.getElementById('pendingOrdersList').style.display = 'none';

            // Ê≥®ÊñáÈÅ∏Êäû„É™„Çπ„Éà„ÇíÊèèÁîª
            renderOrderSelectionList();

            console.log('CSVËß£ÊûêÁµêÊûú:', shippingCsvData, 'Ê≥®Êñá„É™„Çπ„Éà:', csvOrdersList);
        }

        // Ë§áÊï∞Ë°å„Éï„Ç£„Éº„É´„Éâ„ÇíÂê´„ÇÄCSV„Çí„Éë„Éº„Çπ
        function parseCSVWithMultiline(csvText) {
            const records = [];
            let currentRecord = [];
            let currentField = '';
            let inQuotes = false;

            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // „Ç®„Çπ„Ç±„Éº„Éó„Åï„Çå„ÅüÂºïÁî®Á¨¶
                        currentField += '"';
                        i++;
                    } else {
                        // ÂºïÁî®Á¨¶„ÅÆÈñãÂßã/ÁµÇ‰∫Ü
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRecord.push(currentField);
                    currentField = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    // Ë°åÊú´
                    if (char === '\r' && nextChar === '\n') {
                        i++; // CRLF„Çí„Çπ„Ç≠„ÉÉ„Éó
                    }
                    currentRecord.push(currentField);
                    if (currentRecord.some(f => f.length > 0)) {
                        records.push(currentRecord);
                    }
                    currentRecord = [];
                    currentField = '';
                } else {
                    currentField += char;
                }
            }

            // ÊúÄÂæå„ÅÆ„É¨„Ç≥„Éº„Éâ
            if (currentField.length > 0 || currentRecord.length > 0) {
                currentRecord.push(currentField);
                if (currentRecord.some(f => f.length > 0)) {
                    records.push(currentRecord);
                }
            }

            return records;
        }

        // ÊóßparseCSVLineÈñ¢Êï∞Ôºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // ========== Ê≥®ÊñáÈÅ∏ÊäûÊ©üËÉΩ ==========

        // Ê≥®ÊñáÈÅ∏Êäû„É™„Çπ„Éà„ÇíÊèèÁîª
        function renderOrderSelectionList() {
            const container = document.getElementById('orderSelectionContainer');
            if (!container) return;

            // Áô∫ÈÄÅIDÈ†Ü„Åß„ÇΩ„Éº„ÉàÔºàÊï∞ÂÄ§„Å®„Åó„Å¶ÊØîËºÉ„ÄÅÊúÄÂ∞è„ÅÆID„Çí‰ΩøÁî®Ôºâ
            const sortedOrders = [...csvOrdersList].sort((a, b) => {
                const idA = a.ids.length > 0 ? parseInt(a.ids[0]) || 0 : 0;
                const idB = b.ids.length > 0 ? parseInt(b.ids[0]) || 0 : 0;
                return idA - idB;
            });

            container.innerHTML = sortedOrders.map(order => {
                const isSelected = selectedOrderIds.has(order.orderId);
                const isShipped = order.status === 'shipped';
                const statusColor = isShipped ? 'var(--sf-green)' : 'var(--sf-orange)';
                const statusText = isShipped ? 'Áô∫ÈÄÅÊ∏à„Åø' : 'Êú™Áô∫ÈÄÅ';
                // Áô∫ÈÄÅID„ÅÆË°®Á§∫ÔºàË§áÊï∞„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ
                const idDisplay = order.ids.length > 0 ? order.ids.join(', ') : '‰∏çÊòé';
                // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅÆÊûöÊï∞„ÇíË®àÁÆó
                const randomPackQtyTotal = order.randomPackQty || 0;

                // ÂÖ®„Ç¢„Ç§„ÉÜ„É†„ÇíË°®Á§∫ÔºàÂêå„Åò„Ç¢„Ç§„ÉÜ„É†„ÅØÂÄãÊï∞„Çí„Åæ„Å®„ÇÅ„ÇãÔºâ
                const itemCounts = {};
                order.items.forEach(item => {
                    itemCounts[item] = (itemCounts[item] || 0) + 1;
                });
                const itemsList = Object.entries(itemCounts).map(([name, count]) =>
                    count > 1 ? `${name} √ó${count}` : name
                ).join(' / ');

                return `
                    <div onclick="toggleOrderSelection('${order.orderId}')" style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: ${isSelected ? 'white' : 'rgba(0,0,0,0.03)'}; border-radius: 8px; border: 1px solid ${isSelected ? 'var(--sf-blue)' : 'rgba(0,0,0,0.05)'}; cursor: pointer; opacity: ${isSelected ? '1' : '0.6'}; transition: all 0.2s;">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleOrderSelection('${order.orderId}')" style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--sf-blue); margin-top: 2px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span style="font-weight: 700; font-size: 15px; color: var(--sf-blue);">ID: ${idDisplay}</span>
                                <span style="font-size: 12px; color: var(--sf-gray);">Ê≥®Êñá#${order.orderId}</span>
                                <span style="padding: 2px 8px; background: ${isShipped ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 149, 0, 0.1)'}; color: ${statusColor}; border-radius: 10px; font-size: 11px; font-weight: 600;">${statusText}</span>
                                <span style="font-size: 12px; color: var(--sf-gray);">${order.itemCount}ÁÇπ</span>
                                ${randomPackQtyTotal > 0 ? `<span style="padding: 2px 8px; background: rgba(175, 82, 222, 0.1); color: var(--sf-purple); border-radius: 10px; font-size: 11px; font-weight: 600;">„Éë„ÉÉ„ÇØ${randomPackQtyTotal}Êûö</span>` : ''}
                            </div>
                            <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px; word-break: break-all;">
                                ${escapeHtml(itemsList)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateOrderSelectedCount();
        }

        // Ê≥®Êñá„ÅÆÈÅ∏Êäû„Çí„Éà„Ç∞„É´
        function toggleOrderSelection(orderId) {
            if (selectedOrderIds.has(orderId)) {
                selectedOrderIds.delete(orderId);
            } else {
                selectedOrderIds.add(orderId);
            }
            renderOrderSelectionList();
        }

        // ÂÖ®Ê≥®Êñá„ÇíÈÅ∏Êäû
        function selectAllOrders() {
            csvOrdersList.forEach(order => selectedOrderIds.add(order.orderId));
            renderOrderSelectionList();
        }

        // ÂÖ®Ê≥®Êñá„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
        function deselectAllOrders() {
            selectedOrderIds.clear();
            renderOrderSelectionList();
        }

        // ÈÅ∏ÊäûÊï∞„ÇíÊõ¥Êñ∞
        function updateOrderSelectedCount() {
            const countSpan = document.getElementById('orderSelectedCount');
            if (countSpan) {
                const shippedSelected = csvOrdersList.filter(o => o.status === 'shipped' && selectedOrderIds.has(o.orderId)).length;
                const pendingSelected = csvOrdersList.filter(o => o.status === 'pending' && selectedOrderIds.has(o.orderId)).length;
                countSpan.textContent = `${selectedOrderIds.size}/${csvOrdersList.length}‰ª∂ÈÅ∏Êäû‰∏≠ÔºàÁô∫ÈÄÅÊ∏à„Åø: ${shippedSelected}, Êú™Áô∫ÈÄÅ: ${pendingSelected}Ôºâ`;
            }
        }

        // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÁî®„ÅÆÁä∂ÊÖã
        let duplicateOrderIdsFound = [];
        let duplicateHandleMode = null;

        // Ê≥®ÊñáÈÅ∏Êäû„ÇíÁ¢∫ÂÆö„Åó„Å¶Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å∏
        function confirmOrderSelection() {
            if (selectedOrderIds.size === 0) {
                alert('Â∞ë„Å™„Åè„Å®„ÇÇ1„Å§„ÅÆÊ≥®Êñá„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÈÅ∏Êäû„Åï„Çå„ÅüÊ≥®Êñá„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø„Çí„Éï„Ç£„É´„Çø„Éº
            filteredShippingData = shippingCsvData.filter(d => selectedOrderIds.has(d.orderId));

            // Êó¢Â≠ò„ÅÆpendingOrders„Å®ÈáçË§á„Åô„ÇãID„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const csvPendingIds = new Set();
            filteredShippingData.filter(d => d.status === 'pending').forEach(d => {
                csvPendingIds.add(String(d.id));
            });

            const existingIds = new Set();
            pendingOrders.forEach(p => {
                existingIds.add(String(p.id));
            });

            // ÈáçË§áID„ÇíÊ§úÂá∫
            duplicateOrderIdsFound = [...csvPendingIds].filter(id => existingIds.has(id));

            if (duplicateOrderIdsFound.length > 0) {
                // ÈáçË§á„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                document.getElementById('duplicateOrderIds').innerHTML = duplicateOrderIdsFound
                    .map(id => `<span style="display: inline-block; background: rgba(255,149,0,0.2); padding: 2px 8px; border-radius: 4px; margin: 2px;">ID: ${id}</span>`)
                    .join(' ');
                document.getElementById('duplicateOrderModal').style.display = 'flex';
                return;
            }

            // ÈáçË§á„Åå„Å™„Åë„Çå„Å∞„Åù„ÅÆ„Åæ„ÅæÈÄ≤„ÇÄ
            proceedWithOrderConfirmation();
        }

        // ÈáçË§á„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeDuplicateOrderModal() {
            document.getElementById('duplicateOrderModal').style.display = 'none';
            duplicateOrderIdsFound = [];
        }

        // ÈáçË§á„ÅÆÂá¶ÁêÜÊñπÊ≥ï„ÇíÈÅ∏Êäû
        function handleDuplicateOrders(mode) {
            duplicateHandleMode = mode;
            closeDuplicateOrderModal();

            if (mode === 'overwrite') {
                // Êó¢Â≠ò„ÅÆÈáçË§áID„ÇíÂâäÈô§
                pendingOrders = pendingOrders.filter(p => !duplicateOrderIdsFound.includes(String(p.id)));
                savePendingOrdersToCloud();
                console.log(`üîÑ ÈáçË§áID ${duplicateOrderIdsFound.length}‰ª∂„Çí‰∏äÊõ∏„Åç„É¢„Éº„Éâ„ÅßÂâäÈô§`);
            } else if (mode === 'exclude') {
                // CSV„Åã„ÇâÈáçË§áID„ÇíÈô§Â§ñ
                filteredShippingData = filteredShippingData.filter(d =>
                    d.status !== 'pending' || !duplicateOrderIdsFound.includes(String(d.id))
                );
                console.log(`‚è≠Ô∏è ÈáçË§áID ${duplicateOrderIdsFound.length}‰ª∂„ÇíÈô§Â§ñ`);
            }

            proceedWithOrderConfirmation();
        }

        // Á¢∫Ë™çÂá¶ÁêÜ„ÇíÁ∂öË°å
        function proceedWithOrderConfirmation() {
            // „Çµ„Éû„É™„Éº„ÇíË®àÁÆó
            const shippedCount = filteredShippingData.filter(d => d.status === 'shipped' && !d.isRandomPack).length;
            const pendingCount = filteredShippingData.filter(d => d.status === 'pending').length;
            // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅØÊûöÊï∞ÔºàrandomPackQtyÔºâ„ÇíÂêàË®à„Åô„Çã
            const randomPackTotal = filteredShippingData
                .filter(d => d.status === 'shipped' && d.isRandomPack)
                .reduce((sum, d) => sum + (d.randomPackQty || 1), 0);

            document.getElementById('csvSummaryShipped').textContent = shippedCount + ' ‰ª∂';
            document.getElementById('csvSummaryPending').textContent = pendingCount + ' ‰ª∂';
            document.getElementById('csvSummaryRandomPack').textContent = randomPackTotal + ' Êûö';

            randomPackCount = randomPackTotal;

            // UI„ÇíÂàá„ÇäÊõø„Åà
            document.getElementById('orderSelectionStep').style.display = 'none';
            document.getElementById('shippingCsvSummary').style.display = 'block';

            // ÊôØÂìÅ„É™„Çπ„Éà„ÇíÊèèÁîª
            renderShippingOrders();
        }

        // Ê≥®ÊñáÈÅ∏Êäû„Å´Êàª„Çã
        function backToOrderSelection() {
            document.getElementById('shippingCsvSummary').style.display = 'none';
            document.getElementById('shippedOrdersList').style.display = 'none';
            document.getElementById('pendingOrdersList').style.display = 'none';
            document.getElementById('orderSelectionStep').style.display = 'block';
            renderOrderSelectionList();
        }

        // Ê≥®ÊñáÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
        function resetOrderSelection() {
            csvOrdersList.forEach(order => selectedOrderIds.add(order.orderId));
            renderOrderSelectionList();
        }

        // „Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åß„Åç„Å™„Åã„Å£„ÅüÊôØÂìÅ„Çí‰øùÊåÅ
        let unmatchedCsvItems = [];

        // Áô∫ÈÄÅÊ≥®Êñá„É™„Çπ„Éà„ÇíÊèèÁîªÔºàÈÅ∏Êäû„Åï„Çå„ÅüÊ≥®Êñá„ÅÆ„ÅøÔºâ
        function renderShippingOrders() {
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éá„Éº„Çø„Çí‰ΩøÁî®
            const shippedItems = filteredShippingData.filter(d => d.status === 'shipped' && !d.isRandomPack);
            const shippedGrouped = {};
            unmatchedCsvItems = []; // „É™„Çª„ÉÉ„Éà

            shippedItems.forEach(item => {
                if (!shippedGrouped[item.prizeName]) {
                    shippedGrouped[item.prizeName] = { count: 0, orders: [] };
                }
                shippedGrouped[item.prizeName].count += item.quantity;
                shippedGrouped[item.prizeName].orders.push(item.orderId);

                // „Éû„ÉÉ„ÉÅ„É≥„Ç∞Á¢∫Ë™çÔºàÊ≠£Ë¶èÂåñ„Åó„Å¶Ê§úÁ¥¢Ôºâ
                const masterItem = findPrizeByNormalizedName(item.prizeName);
                if (!masterItem && !unmatchedCsvItems.find(u => u.csvName === item.prizeName)) {
                    unmatchedCsvItems.push({
                        csvName: item.prizeName,
                        count: 0
                    });
                }
                if (!masterItem) {
                    const unmatched = unmatchedCsvItems.find(u => u.csvName === item.prizeName);
                    if (unmatched) unmatched.count += item.quantity;
                }
            });

            // „Éû„ÉÉ„ÉÅ„É≥„Ç∞„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
            updateMatchingStatus();

            const shippedContainer = document.getElementById('shippedOrdersContainer');
            const shippedGroupedArray = Object.entries(shippedGrouped).sort((a, b) => b[1].count - a[1].count);

            if (shippedGroupedArray.length > 0) {
                document.getElementById('shippedOrdersList').style.display = 'block';
                document.getElementById('shippedOrdersCount').textContent = `(${shippedItems.length}‰ª∂ / ${shippedGroupedArray.length}Á®ÆÈ°û)`;

                shippedContainer.innerHTML = shippedGroupedArray.map(([prizeName, data]) => {
                    // Ê≠£Ë¶èÂåñ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Çí‰ΩøÁî®
                    const isMatched = !!findPrizeByNormalizedName(prizeName);
                    return `
                    <div style="background: white; padding: 12px 16px; border-radius: var(--radius-md); border-left: 4px solid ${isMatched ? 'var(--sf-green)' : 'var(--sf-red)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: var(--sf-black);">${escapeHtml(prizeName)}</div>
                                ${!isMatched ? '<div style="font-size: 11px; color: var(--sf-red); margin-top: 2px;">‚ö†Ô∏è „Éû„Çπ„Çø„ÉºÊú™ÁôªÈå≤</div>' : ''}
                            </div>
                            <span style="background: ${isMatched ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 59, 48, 0.1)'}; color: ${isMatched ? 'var(--sf-green)' : 'var(--sf-red)'}; padding: 4px 12px; border-radius: var(--radius-full); font-size: 13px; font-weight: 700;">
                                ${data.count}ÂÄã
                            </span>
                        </div>
                        <div style="font-size: 11px; color: var(--sf-gray); margin-top: 4px;">
                            Ê≥®Êñá: ${data.orders.slice(0, 3).join(', ')}${data.orders.length > 3 ? ` ‰ªñ${data.orders.length - 3}‰ª∂` : ''}
                        </div>
                    </div>
                    `;
                }).join('');
            } else {
                document.getElementById('shippedOrdersList').style.display = 'none';
            }

            // ÈÅ∏Êäû„Åï„Çå„ÅüCSV„Åã„ÇâÊú™Áô∫ÈÄÅ„ÇíÂèñÂæóÔºà„Åæ„Å†‰øùÂ≠ò„Åó„Å™„ÅÑÔºâ
            const newPendingFromCsv = filteredShippingData.filter(d => d.status === 'pending');

            // IDÂà•„Å´Ë°®Á§∫
            renderPendingOrdersById(newPendingFromCsv);
        }

        // Êú™Áô∫ÈÄÅ„ÇíIDÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ„Åó„Å¶ÊèèÁîª
        function renderPendingOrdersById(pendingItems) {
            const pendingContainer = document.getElementById('pendingOrdersContainer');

            // ID„Åß„Ç∞„É´„Éº„ÉóÂåñ
            const groupedById = {};
            pendingItems.forEach(item => {
                const itemId = item.id || item.orderId || 'unknown';
                if (!groupedById[itemId]) {
                    groupedById[itemId] = {
                        id: itemId,
                        items: [],
                        orderId: item.orderId,
                        customerName: item.customerName
                    };
                }
                groupedById[itemId].items.push(item);
            });

            // IDÈ†Ü„Å´„ÇΩ„Éº„ÉàÔºàÊï∞ÂÄ§„Å®„Åó„Å¶Ôºâ
            const sortedGroups = Object.values(groupedById).sort((a, b) => {
                const idA = parseInt(a.id) || 0;
                const idB = parseInt(b.id) || 0;
                return idA - idB;
            });

            if (sortedGroups.length > 0) {
                document.getElementById('pendingOrdersList').style.display = 'block';
                const totalItems = pendingItems.length;
                const totalQty = pendingItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
                document.getElementById('pendingOrdersCount').textContent = `(${sortedGroups.length}‰ª∂ / ${totalQty}ÂÄã)`;

                pendingContainer.innerHTML = sortedGroups.map(group => {
                    // „Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆÂÖ®ÊôØÂìÅ„ÅÆÂú®Â∫´Áä∂Ê≥Å„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    let hasStockIssue = false;
                    let hasRandomPack = false;
                    const alreadyShipped = isAlreadyShipped(group.id);

                    const itemsHtml = group.items.map(item => {
                        // Á¥ê‰ªò„Åë„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆID„ÅßÊ§úÁ¥¢
                        let masterItem = null;
                        if (item.linkedPrizeId) {
                            masterItem = prizeMaster.find(p => String(p.id) === String(item.linkedPrizeId));
                        }
                        if (!masterItem) {
                            masterItem = findPrizeByNormalizedName(item.prizeName);
                        }
                        const currentStock = masterItem ? (masterItem.stock || masterItem.count || 0) : 0;
                        const neededQty = item.quantity || 1;
                        const needToPurchase = neededQty > currentStock;
                        const isRandomPack = item.prizeName.includes('„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ');

                        if (needToPurchase) hasStockIssue = true;
                        if (isRandomPack) hasRandomPack = true;

                        const statusColor = needToPurchase ? 'var(--sf-red)' : 'var(--sf-green)';
                        const statusText = needToPurchase ? '‰∏çË∂≥' : 'OK';
                        const stockInfo = masterItem ? `Âú®Â∫´${currentStock}` : 'Êú™ÁôªÈå≤';
                        const displayName = item.linkedPrizeName || item.prizeName;
                        const isLinked = item.linkedPrizeName && item.linkedPrizeName !== item.prizeName;

                        return `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.05);">
                            <div style="flex: 1; min-width: 0;">
                                <span style="font-size: 13px; color: var(--sf-black);">${escapeHtml(displayName)}</span>
                                ${isLinked ? '<span style="font-size: 10px; background: var(--sf-blue); color: white; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">üîó</span>' : ''}
                                ${isRandomPack ? '<span style="font-size: 10px; background: var(--sf-purple); color: white; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">„Éë„ÉÉ„ÇØ</span>' : ''}
                            </div>
                            <span style="font-size: 11px; color: var(--sf-gray);">${neededQty}ÂÄã</span>
                            <span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: ${needToPurchase ? 'rgba(255,59,48,0.1)' : 'rgba(52,199,89,0.1)'}; color: ${statusColor};">${stockInfo} ${statusText}</span>
                        </div>
                        `;
                    }).join('');

                    const borderColor = hasStockIssue ? 'var(--sf-red)' : 'var(--sf-orange)';
                    const canShip = !hasStockIssue || hasRandomPack;

                    const idBadgeColor = alreadyShipped ? 'var(--sf-red)' : 'var(--sf-blue)';
                    const buttonColor = alreadyShipped ? 'var(--sf-gray)' : (hasStockIssue ? 'var(--sf-orange)' : 'var(--sf-green)');

                    return `
                    <div style="background: white; padding: 14px 16px; border-radius: var(--radius-md); border-left: 4px solid ${borderColor}; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); ${alreadyShipped ? 'opacity: 0.7;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: ${idBadgeColor}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 13px; font-weight: 700;">ID: ${group.id}</span>
                                ${alreadyShipped ? '<span style="font-size: 10px; background: rgba(255,59,48,0.15); color: var(--sf-red); padding: 2px 6px; border-radius: 4px; font-weight: 600;">‚ö†Ô∏è Áô∫ÈÄÅÊ∏à„Åø</span>' : ''}
                                <span style="font-size: 12px; color: var(--sf-gray);">${group.items.length}ÁÇπ</span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="deleteIdGroup('${group.id}')" style="background: rgba(255,59,48,0.1); color: var(--sf-red); border: 1px solid var(--sf-red); border-radius: 6px; padding: 8px 12px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                    üóëÔ∏è ÂâäÈô§
                                </button>
                                <button onclick="markIdGroupAsShipped('${group.id}')" style="background: ${buttonColor}; color: white; border: none; border-radius: 6px; padding: 8px 14px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                    üì¶ Áô∫ÈÄÅÊ∏à„Åø„Å´„Åô„Çã
                                </button>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.02); border-radius: 6px; padding: 8px 10px;">
                            ${itemsHtml}
                        </div>
                        ${alreadyShipped ? '<div style="font-size: 11px; color: var(--sf-red); margin-top: 8px;">‚ö†Ô∏è „Åì„ÅÆID„ÅØÊó¢„Å´Áô∫ÈÄÅÊ∏à„Åø„Å®„Åó„Å¶Ë®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</div>' : ''}
                        ${hasStockIssue && !hasRandomPack && !alreadyShipped ? '<div style="font-size: 11px; color: var(--sf-red); margin-top: 8px;">‚ö†Ô∏è Âú®Â∫´‰∏çË∂≥„ÅÆÊôØÂìÅ„Åå„ÅÇ„Çä„Åæ„Åô</div>' : ''}
                        ${hasRandomPack ? '<div style="font-size: 11px; color: var(--sf-purple); margin-top: 8px;">üéÅ „Éë„ÉÉ„ÇØÈÅ∏Êäû„ÅåÂøÖË¶Å„Åß„Åô</div>' : ''}
                    </div>
                    `;
                }).join('');
            } else {
                document.getElementById('pendingOrdersList').style.display = 'none';
            }
        }

        // Êú™Áô∫ÈÄÅ„Åã„Çâ„ÅÆ„Éë„ÉÉ„ÇØÈÅ∏ÊäûÁî®„ÅÆÁä∂ÊÖã
        let pendingRandomPackContext = null;

        // ID„Ç∞„É´„Éº„ÉóÂçò‰Ωç„ÅßÁô∫ÈÄÅÊ∏à„Åø„Å´Â§âÊõ¥
        function markIdGroupAsShipped(groupId) {
            console.log('markIdGroupAsShipped called:', groupId);

            // Êó¢„Å´Áô∫ÈÄÅÊ∏à„Åø„ÅÆID„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (isAlreadyShipped(groupId)) {
                if (!confirm(`‚ö†Ô∏è „Åì„ÅÆID (${groupId}) „ÅØÊó¢„Å´Áô∫ÈÄÅÊ∏à„Åø„Å®„Åó„Å¶Âá¶ÁêÜ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n\nÊú¨ÂΩì„Å´„ÇÇ„ÅÜ‰∏ÄÂ∫¶Áô∫ÈÄÅÂá¶ÁêÜ„ÇíË°å„ÅÑ„Åæ„Åô„ÅãÔºü\nÔºàÂú®Â∫´„Åå‰∫åÈáç„Å´Ê∏õÂ∞ë„Åó„Åæ„ÅôÔºâ`)) {
                    return;
                }
            }

            // CSV„Éá„Éº„Çø„Å®pendingOrders‰∏°Êñπ„Åã„ÇâË©≤ÂΩìID„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÂèéÈõÜ
            const itemsInGroup = [];

            // CSV„Éá„Éº„Çø„Åã„ÇâÊ§úÁ¥¢
            (filteredShippingData || []).forEach(d => {
                if (d.status === 'pending' && String(d.id) === String(groupId)) {
                    itemsInGroup.push({ ...d, source: 'csv' });
                }
            });

            // pendingOrders„Åã„ÇâÊ§úÁ¥¢ÔºàÈáçË§á„ÇíÈÅø„Åë„ÇãÔºâ
            pendingOrders.forEach(p => {
                if (String(p.id) === String(groupId)) {
                    const exists = itemsInGroup.some(existing =>
                        existing.orderId === p.orderId && existing.prizeName === p.prizeName
                    );
                    if (!exists) {
                        itemsInGroup.push({ ...p, source: 'pending' });
                    }
                }
            });

            if (itemsInGroup.length === 0) {
                alert('Ë©≤ÂΩì„Åô„ÇãÊú™Áô∫ÈÄÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºàID: ' + groupId + 'Ôºâ');
                return;
            }

            // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const randomPackItems = itemsInGroup.filter(item => item.prizeName.includes('„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ'));
            const normalItems = itemsInGroup.filter(item => !item.prizeName.includes('„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ'));

            // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂÖà„Å´„Éë„ÉÉ„ÇØÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            if (randomPackItems.length > 0) {
                const totalPackQty = randomPackItems.reduce((sum, item) => sum + (item.randomPackQty || 1), 0);
                pendingRandomPackContext = {
                    prizeName: '„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ',
                    items: randomPackItems,
                    totalPackQty: totalPackQty,
                    groupId: groupId,
                    normalItems: normalItems // „Éë„ÉÉ„ÇØ‰ª•Â§ñ„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇÇ‰øùÊåÅ
                };
                openPendingRandomPackModal(totalPackQty);
                return;
            }

            // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„Çí‰ΩúÊàê
            let confirmMsg = `ID: ${groupId} „ÅÆÊ≥®Êñá„ÇíÁô∫ÈÄÅÊ∏à„Åø„Å´„Åó„Åæ„Åô„ÅãÔºü\n\n„ÄêÂÜÖÂÆπ„Äë\n`;
            const historyEntries = [];
            let hasUnregistered = false;

            normalItems.forEach(item => {
                // Á¥ê‰ªò„Åë„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆID„ÅßÊ§úÁ¥¢
                let masterItem = null;
                if (item.linkedPrizeId) {
                    masterItem = prizeMaster.find(p => String(p.id) === String(item.linkedPrizeId));
                }
                if (!masterItem) {
                    masterItem = findPrizeByNormalizedName(item.prizeName);
                }
                const qty = item.quantity || 1;
                if (masterItem) {
                    const stockKey = 'stock' in masterItem ? 'stock' : 'count';
                    const currentStock = masterItem[stockKey] || 0;
                    const displayName = item.linkedPrizeName || item.prizeName;
                    confirmMsg += `„Éª${displayName}: ${qty}ÂÄã (${currentStock} ‚Üí ${Math.max(0, currentStock - qty)})\n`;
                } else {
                    confirmMsg += `„Éª${item.prizeName}: ${qty}ÂÄã (‚ö†Ô∏èÊú™ÁôªÈå≤)\n`;
                    hasUnregistered = true;
                }
            });

            if (hasUnregistered) {
                confirmMsg += '\n‚Äª Êú™ÁôªÈå≤„ÅÆÊôØÂìÅ„ÅØÂú®Â∫´Ê∏õÂ∞ë„Åó„Åæ„Åõ„Çì';
            }

            if (!confirm(confirmMsg)) {
                return;
            }

            // Âú®Â∫´„ÇíÊ∏õÂ∞ë
            normalItems.forEach(item => {
                // Á¥ê‰ªò„Åë„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆID„ÅßÊ§úÁ¥¢
                let masterItem = null;
                if (item.linkedPrizeId) {
                    masterItem = prizeMaster.find(p => String(p.id) === String(item.linkedPrizeId));
                }
                if (!masterItem) {
                    masterItem = findPrizeByNormalizedName(item.prizeName);
                }
                if (masterItem) {
                    const stockKey = 'stock' in masterItem ? 'stock' : 'count';
                    const oldStock = masterItem[stockKey] || 0;
                    const qty = item.quantity || 1;
                    masterItem[stockKey] = Math.max(0, oldStock - qty);

                    historyEntries.push({
                        type: 'decrease',
                        prizeName: masterItem.name,
                        quantity: qty,
                        oldStock: oldStock,
                        newStock: masterItem[stockKey],
                        reason: `Áô∫ÈÄÅÔºàID:${groupId}Ôºâ`,
                        timestamp: new Date().toISOString()
                    });
                }
            });

            if (historyEntries.length > 0) {
                savePrizeMaster();
                updatePrizeMasterList();
                saveInventoryHistoryEntries(historyEntries);
            }

            // CSV„Éá„Éº„Çø„Åã„ÇâÂâäÈô§
            if (filteredShippingData) {
                filteredShippingData = filteredShippingData.filter(d =>
                    !(d.status === 'pending' && String(d.id) === String(groupId))
                );
            }

            // pendingOrders„Åã„Çâ„ÇÇÂâäÈô§
            const originalCount = pendingOrders.length;
            pendingOrders = pendingOrders.filter(p => String(p.id) !== String(groupId));
            if (pendingOrders.length < originalCount) {
                savePendingOrdersToCloud();
            }

            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            refreshPendingOrdersDisplay();

            // Áô∫ÈÄÅÊ∏à„ÅøID„Å®„Åó„Å¶Ë®òÈå≤ÔºàÈáçË§áÁô∫ÈÄÅÈò≤Ê≠¢Ôºâ
            recordShippedOrderId(groupId);

            alert(`ID: ${groupId} „ÇíÁô∫ÈÄÅÊ∏à„Åø„Å´„Åó„Åæ„Åó„ÅüÔºà${normalItems.length}ÁÇπÔºâ`);
        }

        // ID„Ç∞„É´„Éº„Éó„ÇíÂâäÈô§ÔºàÂú®Â∫´„ÅØÊ∏õÂ∞ë„Åó„Å™„ÅÑÔºâ
        function deleteIdGroup(groupId) {
            // CSV„Éá„Éº„Çø„Å®pendingOrders‰∏°Êñπ„Åã„ÇâË©≤ÂΩìID„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÂèéÈõÜ
            const itemsInGroup = [];

            // CSV„Éá„Éº„Çø„Åã„ÇâÊ§úÁ¥¢
            (filteredShippingData || []).forEach(d => {
                if (d.status === 'pending' && String(d.id) === String(groupId)) {
                    itemsInGroup.push(d);
                }
            });

            // pendingOrders„Åã„ÇâÊ§úÁ¥¢
            pendingOrders.forEach(p => {
                if (String(p.id) === String(groupId)) {
                    const exists = itemsInGroup.some(existing =>
                        existing.orderId === p.orderId && existing.prizeName === p.prizeName
                    );
                    if (!exists) {
                        itemsInGroup.push(p);
                    }
                }
            });

            if (itemsInGroup.length === 0) {
                alert('Ë©≤ÂΩì„Åô„ÇãÊú™Áô∫ÈÄÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºàID: ' + groupId + 'Ôºâ');
                return;
            }

            // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
            let confirmMsg = `ID: ${groupId} „ÅÆÊ≥®Êñá„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n`;
            confirmMsg += `„ÄêÂÜÖÂÆπ„ÄëÔºà${itemsInGroup.length}ÁÇπÔºâ\n`;
            itemsInGroup.forEach(item => {
                const qty = item.quantity || 1;
                confirmMsg += `„Éª${item.prizeName}: ${qty}ÂÄã\n`;
            });
            confirmMsg += '\n‚ö†Ô∏è Âú®Â∫´„ÅØÂ§âÊõ¥„Åï„Çå„Åæ„Åõ„ÇìÔºàÁô∫ÈÄÅ‰∏çË¶Å„ÅÆÂ†¥Âêà„ÅÆ„Åø‰ΩøÁî®Ôºâ';

            if (!confirm(confirmMsg)) {
                return;
            }

            // CSV„Éá„Éº„Çø„Åã„ÇâÂâäÈô§
            if (filteredShippingData) {
                filteredShippingData = filteredShippingData.filter(d =>
                    !(d.status === 'pending' && String(d.id) === String(groupId))
                );
            }

            // pendingOrders„Åã„Çâ„ÇÇÂâäÈô§
            const originalCount = pendingOrders.length;
            pendingOrders = pendingOrders.filter(p => String(p.id) !== String(groupId));
            if (pendingOrders.length < originalCount) {
                savePendingOrdersToCloud();
            }

            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            refreshPendingOrdersDisplay();
            renderNeedRestockList();

            alert(`ID: ${groupId} „ÇíÂâäÈô§„Åó„Åæ„Åó„ÅüÔºà${itemsInGroup.length}ÁÇπÔºâ\n‚ÄªÂú®Â∫´„ÅØÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì`);
        }

        // ÊóßÈñ¢Êï∞Ôºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        function markSinglePendingAsShipped(itemId) {
            markIdGroupAsShipped(itemId);
        }

        // „Ç∞„É´„Éº„ÉóÂåñ„Åï„Çå„ÅüÊú™Áô∫ÈÄÅ„ÇíÁô∫ÈÄÅÊ∏à„Åø„Å´Â§âÊõ¥ÔºàÊóß„Éê„Éº„Ç∏„Éß„É≥„ÄÅ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        function markGroupedPendingAsShipped(prizeName) {
            console.log('markGroupedPendingAsShipped called:', prizeName);
            console.log('pendingOrders:', pendingOrders);

            // Ë©≤ÂΩì„Åô„ÇãÂÖ®„Å¶„ÅÆÊú™Áô∫ÈÄÅ„ÇíÊ§úÁ¥¢Ôºà‰øùÂ≠òÊ∏à„Åø + CSV„Åã„ÇâË™≠„ÅøËæº„Çì„Å†„ÇÇ„ÅÆÔºâ
            let itemsToShip = pendingOrders.filter(p => p.prizeName === prizeName);

            // CSV„Åã„ÇâË™≠„ÅøËæº„Çì„Å†Êú™Áô∫ÈÄÅ„ÇÇÊ§úÁ¥¢Ôºà„Åæ„Å†‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÇÇ„ÅÆÔºâ
            const csvPendingItems = (filteredShippingData || []).filter(d => d.status === 'pending' && d.prizeName === prizeName);
            csvPendingItems.forEach(csvItem => {
                const exists = itemsToShip.some(existing =>
                    existing.orderId === csvItem.orderId && existing.prizeName === csvItem.prizeName
                );
                if (!exists) {
                    itemsToShip.push(csvItem);
                }
            });

            console.log('itemsToShip:', itemsToShip);

            if (itemsToShip.length === 0) {
                alert('Ë©≤ÂΩì„Åô„ÇãÊú™Áô∫ÈÄÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅÆÂ†¥Âêà„ÅØÁâπÂà•Âá¶ÁêÜ
            if (prizeName.includes('„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ')) {
                console.log('„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ detected, opening modal');
                // ÂêàË®àÊûöÊï∞„ÇíË®àÁÆóÔºàrandomPackQty„Çí‰ΩøÁî®Ôºâ
                const totalPackQty = itemsToShip.reduce((sum, item) => sum + (item.randomPackQty || 1), 0);
                console.log('totalPackQty:', totalPackQty);
                pendingRandomPackContext = {
                    prizeName: prizeName,
                    items: itemsToShip,
                    totalPackQty: totalPackQty
                };
                openPendingRandomPackModal(totalPackQty);
                return;
            }

            const totalQty = itemsToShip.reduce((sum, item) => sum + (item.quantity || 1), 0);

            if (!confirm(`„Äå${prizeName}„Äç${totalQty}ÂÄã„ÇíÁô∫ÈÄÅÊ∏à„Åø„Å´„Åó„Åæ„Åô„ÅãÔºü\nÂú®Â∫´„Åã„ÇâÊ∏õÂ∞ë„Åó„Åæ„Åô„ÄÇ`)) {
                return;
            }

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÊ§úÁ¥¢„Åó„Å¶Âú®Â∫´„ÇíÊ∏õÂ∞ëÔºàÊ≠£Ë¶èÂåñ„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ôºâ
            const masterItem = findPrizeByNormalizedName(prizeName);
            if (masterItem) {
                const stockKey = 'stock' in masterItem ? 'stock' : 'count';
                const oldStock = masterItem[stockKey] ?? 0;
                const newStock = Math.max(0, oldStock - totalQty);
                masterItem[stockKey] = newStock;

                // Â±•Ê≠¥„Å´ËøΩÂä†
                saveInventoryHistoryEntries([{
                    type: 'decrease',
                    prizeName: masterItem.name,
                    quantity: totalQty,
                    oldStock: oldStock,
                    newStock: newStock,
                    reason: 'Áô∫ÈÄÅÔºàÊú™Áô∫ÈÄÅ„Åã„Çâ‰∏ÄÊã¨Ôºâ',
                    timestamp: new Date().toISOString()
                }]);

                savePrizeMaster();
                updatePrizeMasterList();

                alert(`${prizeName} ${totalQty}ÂÄã„ÇíÁô∫ÈÄÅÊ∏à„Åø„Å´„Åó„Åæ„Åó„Åü\nÂú®Â∫´: ${oldStock} ‚Üí ${newStock}`);
            } else {
                alert('ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÂú®Â∫´„ÅØÂ§âÊõ¥„Åï„Çå„Åæ„Åõ„Çì\nÊú™Áô∫ÈÄÅ„É™„Çπ„Éà„Åã„Çâ„ÅØÂâäÈô§„Åó„Åæ„Åô');
            }

            // pendingOrders„Åã„ÇâË©≤ÂΩì„Ç¢„Ç§„ÉÜ„É†„ÇíÂâäÈô§
            pendingOrders = pendingOrders.filter(p => p.prizeName !== prizeName);
            savePendingOrdersToCloud();

            // CSV„Éá„Éº„Çø„Åã„Çâ„ÇÇÂâäÈô§ÔºàË°®Á§∫Áî®Ôºâ
            if (filteredShippingData) {
                filteredShippingData = filteredShippingData.filter(d => !(d.status === 'pending' && d.prizeName === prizeName));
            }

            refreshPendingOrdersDisplay();
        }

        // Êú™Áô∫ÈÄÅ„É™„Çπ„Éà„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞ÔºàIDÂà•Ë°®Á§∫Ôºâ
        function refreshPendingOrdersDisplay() {
            // ‰øùÂ≠òÊ∏à„Åø + CSV„Åã„ÇâË™≠„ÅøËæº„Çì„Å†Êú™Áô∫ÈÄÅ„ÇíÁµ±Âêà
            const displayPendingOrders = [...pendingOrders];
            if (filteredShippingData) {
                const csvPendingItems = filteredShippingData.filter(d => d.status === 'pending');
                csvPendingItems.forEach(csvItem => {
                    const exists = displayPendingOrders.some(existing =>
                        existing.orderId === csvItem.orderId && existing.prizeName === csvItem.prizeName
                    );
                    if (!exists) {
                        displayPendingOrders.push(csvItem);
                    }
                });
            }

            // IDÂà•Ë°®Á§∫„Å´Â§âÊõ¥
            renderPendingOrdersById(displayPendingOrders);
        }

        // Êú™Áô∫ÈÄÅ„ÅÆ„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openPendingRandomPackModal(totalPackQty) {
            document.getElementById('randomPackCount').textContent = totalPackQty;

            // „Éë„ÉÉ„ÇØ„Éª„Éú„ÉÉ„ÇØ„ÇπÁ≥ª„ÅÆÊôØÂìÅ„Çí‰∏ÄË¶ßË°®Á§∫ÔºàÂú®Â∫´„Åå„ÅÇ„Çã„ÇÇ„ÅÆÔºâ
            const packPrizes = prizeMaster.filter(p => {
                const stock = p.stock ?? p.count ?? 0;
                if (stock <= 0) return false;
                const type = p.type || '';
                return type === '„Éë„ÉÉ„ÇØ' || type === '„Éú„ÉÉ„ÇØ„Çπ' ||
                       p.name.includes('„Éë„ÉÉ„ÇØ') || p.name.includes('„Éú„ÉÉ„ÇØ„Çπ');
            });

            packPrizes.sort((a, b) => (b.stock ?? b.count ?? 0) - (a.stock ?? a.count ?? 0));

            // ÂêàË®àÂú®Â∫´„ÇíË®àÁÆó
            const totalAvailableStock = packPrizes.reduce((sum, p) => sum + (p.stock ?? p.count ?? 0), 0);

            // Âú®Â∫´‰∏çË∂≥„ÅÆË≠¶Âëä„ÇíË°®Á§∫
            const stockInfoEl = document.getElementById('randomPackStockInfo');
            const stockCountEl = document.getElementById('randomPackTotalStock');
            if (totalAvailableStock < totalPackQty) {
                stockInfoEl.style.display = 'block';
                stockCountEl.textContent = totalAvailableStock;
            } else {
                stockInfoEl.style.display = 'none';
            }

            randomPackSelections = {};

            const container = document.getElementById('randomPackPrizeList');

            if (packPrizes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--sf-gray);">
                        <div style="font-size: 48px; margin-bottom: 12px;">üì¶</div>
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">„Éë„ÉÉ„ÇØ„Éª„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂú®Â∫´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                    </div>
                `;
            } else {
                container.innerHTML = packPrizes.map(p => {
                    const stock = p.stock ?? p.count ?? 0;
                    const typeLabel = p.type || '‰∏çÊòé';
                    const imageHtml = p.image
                        ? `<img src="${p.image}" alt="" style="width: 50px; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;">`
                        : `<div style="width: 50px; height: 70px; background: rgba(0,0,0,0.05); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;">üì¶</div>`;

                    return `
                    <div style="display: flex; align-items: center; gap: 16px; padding: 16px; border-bottom: 1px solid rgba(0, 0, 0, 0.08); background: white;">
                        ${imageHtml}
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 15px; color: var(--sf-black); word-break: break-all;">${escapeHtml(p.name)}</div>
                            <div style="display: flex; gap: 8px; margin-top: 6px;">
                                <span style="padding: 3px 10px; background: rgba(175, 82, 222, 0.1); color: var(--sf-purple); border-radius: 12px; font-size: 12px; font-weight: 600;">${typeLabel}</span>
                                <span style="padding: 3px 10px; background: rgba(52, 199, 89, 0.1); color: var(--sf-green); border-radius: 12px; font-size: 12px; font-weight: 600;">Âú®Â∫´: ${stock}ÂÄã</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button onclick="adjustRandomPackQty('${p.id}', -1)" style="width: 44px; height: 44px; border: 2px solid rgba(0,0,0,0.15); border-radius: 10px; background: white; cursor: pointer; font-size: 24px; font-weight: 600; color: var(--sf-blue); display: flex; align-items: center; justify-content: center;">‚àí</button>
                            <span id="randompack-qty-${p.id}" style="min-width: 50px; text-align: center; font-weight: 700; font-size: 20px; color: var(--sf-black);">0</span>
                            <button onclick="adjustRandomPackQty('${p.id}', 1)" style="width: 44px; height: 44px; border: 2px solid rgba(0,0,0,0.15); border-radius: 10px; background: white; cursor: pointer; font-size: 24px; font-weight: 600; color: var(--sf-blue); display: flex; align-items: center; justify-content: center;">+</button>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            // randomPackCount„ÇíÊõ¥Êñ∞Ôºà„É¢„Éº„ÉÄ„É´ÂÖ±Êúâ„ÅÆ„Åü„ÇÅÔºâ
            randomPackCount = totalPackQty;

            document.getElementById('randomPackModal').style.display = 'flex';
        }

        // Êú™Áô∫ÈÄÅ„ÇíÁô∫ÈÄÅÊ∏à„Åø„Å´Â§âÊõ¥ÔºàCSVË™≠ËæºÊôÇÁî®Ôºâ
        function markAsShipped(idx) {
            if (pendingOrders[idx]) {
                const item = pendingOrders[idx];

                // ÂÖÉ„ÅÆCSV„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
                const csvItem = shippingCsvData.find(d =>
                    d.orderId === item.orderId && d.prizeName === item.prizeName
                );
                if (csvItem) csvItem.status = 'shipped';

                // pendingOrders„Åã„ÇâÂâäÈô§
                pendingOrders.splice(idx, 1);

                // „ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò
                savePendingOrdersToCloud();

                // Áô∫ÈÄÅÊ∏à„Åø„É™„Çπ„Éà„ÇíÂÜçÊèèÁîª
                renderShippingOrders();
                renderPendingOrdersOnly();
                updateCsvSummary();
            }
        }

        // „Çµ„Éû„É™„Éº„ÇíÊõ¥Êñ∞
        function updateCsvSummary() {
            const shippedCount = filteredShippingData.filter(d => d.status === 'shipped' && !d.isRandomPack).reduce((sum, d) => sum + d.quantity, 0);
            const pendingCount = filteredShippingData.filter(d => d.status === 'pending').reduce((sum, d) => sum + d.quantity, 0);
            // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅØÊûöÊï∞ÔºàrandomPackQtyÔºâ„ÇíÂêàË®à„Åô„Çã
            const randomPackTotal = filteredShippingData
                .filter(d => d.status === 'shipped' && d.isRandomPack)
                .reduce((sum, d) => sum + (d.randomPackQty || 1), 0);

            document.getElementById('csvSummaryShipped').textContent = shippedCount + ' ‰ª∂';
            document.getElementById('csvSummaryPending').textContent = pendingCount + ' ‰ª∂';
            document.getElementById('csvSummaryRandomPack').textContent = randomPackTotal + ' Êûö';

            randomPackCount = randomPackTotal;
        }

        // „Éû„ÉÉ„ÉÅ„É≥„Ç∞„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
        function updateMatchingStatus() {
            const matchingStatusEl = document.getElementById('matchingStatus');
            const unmatchedListEl = document.getElementById('unmatchedItemsList');

            if (unmatchedCsvItems.length > 0) {
                matchingStatusEl.style.display = 'block';
                unmatchedListEl.innerHTML = unmatchedCsvItems.map(item =>
                    `<div style="padding: 4px 0;">„Éª${escapeHtml(item.csvName)} (${item.count}ÂÄã)</div>`
                ).join('');
            } else {
                matchingStatusEl.style.display = 'none';
            }
        }

        // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂØæË±°
        let selectedUnmatchedIndex = null;

        // ÊâãÂãï„Éû„ÉÉ„ÉÅ„É≥„Ç∞„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openManualMatchModal() {
            if (unmatchedCsvItems.length === 0) {
                alert('„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åß„Åç„Å™„Åã„Å£„ÅüÊôØÂìÅ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            selectedUnmatchedIndex = null;
            const modal = document.getElementById('manualMatchModal');

            // Ê§úÁ¥¢„Å®„Éï„Ç£„É´„Çø„Éº„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('manualMatchSearchText').value = '';
            document.getElementById('manualMatchTypeFilter').value = 'all';
            document.getElementById('manualMatchStockFilter').value = 'all';

            // Â∑¶ÂÅ¥„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åß„Åç„Å™„Åã„Å£„ÅüÊôØÂìÅ„É™„Çπ„Éà„ÇíË°®Á§∫
            updateManualMatchUnmatchedList();

            // Âè≥ÂÅ¥„ÅÆÊôØÂìÅ„Éû„Çπ„Çø„Éº„É™„Çπ„Éà„ÇíË°®Á§∫
            updateManualMatchPrizeList();

            modal.style.display = 'flex';
        }

        // Â∑¶ÂÅ¥Ôºö„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åß„Åç„Å™„Åã„Å£„ÅüÊôØÂìÅ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateManualMatchUnmatchedList() {
            const container = document.getElementById('manualMatchList');

            if (unmatchedCsvItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--sf-green);">
                        <div style="font-size: 48px; margin-bottom: 12px;">‚úÖ</div>
                        <div style="font-size: 14px; font-weight: 600;">„Åô„Åπ„Å¶„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÆå‰∫Ü</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = unmatchedCsvItems.map((item, idx) => `
                <div onclick="selectUnmatchedItem(${idx})" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); transition: all 0.15s; ${selectedUnmatchedIndex === idx ? 'background: rgba(255, 149, 0, 0.15); border-left: 3px solid var(--sf-orange);' : 'background: transparent;'}" onmouseover="this.style.background='${selectedUnmatchedIndex === idx ? 'rgba(255, 149, 0, 0.15)' : 'rgba(0,0,0,0.03)'}'" onmouseout="this.style.background='${selectedUnmatchedIndex === idx ? 'rgba(255, 149, 0, 0.15)' : 'transparent'}'">
                    <div style="font-weight: 600; font-size: 13px; color: var(--sf-black); word-break: break-all;">
                        ${escapeHtml(item.csvName)}
                    </div>
                    <div style="font-size: 12px; color: var(--sf-orange); margin-top: 4px;">
                        ${item.count}ÂÄã
                    </div>
                </div>
            `).join('');
        }

        // „Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åß„Åç„Å™„Åã„Å£„ÅüÊôØÂìÅ„ÇíÈÅ∏Êäû
        function selectUnmatchedItem(idx) {
            selectedUnmatchedIndex = idx;
            updateManualMatchUnmatchedList();

            // ÈÅ∏Êäû„Åó„ÅüÊôØÂìÅÂêç„ÅßËá™ÂãïÊ§úÁ¥¢
            const item = unmatchedCsvItems[idx];
            if (item) {
                // ÊôØÂìÅÂêç„Åã„ÇâÊ§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊäΩÂá∫ÔºàÊúÄÂàù„ÅÆÊï∞ÊñáÂ≠óÔºâ
                const searchKeyword = item.csvName.replace(/[?Ôºü]/g, '').slice(0, 5);
                document.getElementById('manualMatchSearchText').value = searchKeyword;
                updateManualMatchPrizeList();
            }
        }

        // Âè≥ÂÅ¥ÔºöÊôØÂìÅ„Éû„Çπ„Çø„Éº„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateManualMatchPrizeList() {
            const container = document.getElementById('manualMatchPrizeList');
            const searchText = document.getElementById('manualMatchSearchText')?.value.trim().toLowerCase() || '';
            const typeFilter = document.getElementById('manualMatchTypeFilter')?.value || 'all';
            const stockFilter = document.getElementById('manualMatchStockFilter')?.value || 'all';

            // „Éï„Ç£„É´„Çø„ÉºÂá¶ÁêÜ
            let filteredPrizes = [...prizeMaster];

            // Á®ÆÈ°û„Éï„Ç£„É´„Çø„Éº
            if (typeFilter !== 'all') {
                filteredPrizes = filteredPrizes.filter(p => (p.type || 'PSA10') === typeFilter);
            }

            // Âú®Â∫´„Éï„Ç£„É´„Çø„Éº
            if (stockFilter === 'inStock') {
                filteredPrizes = filteredPrizes.filter(p => (p.stock || p.count || 0) > 0);
            }

            // ÂêçÂâçÊ§úÁ¥¢
            if (searchText) {
                filteredPrizes = filteredPrizes.filter(p =>
                    p.name.toLowerCase().includes(searchText)
                );
            }

            // Âú®Â∫´Â§ö„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
            filteredPrizes.sort((a, b) => (b.stock || b.count || 0) - (a.stock || a.count || 0));

            if (filteredPrizes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--sf-gray);">
                        <div style="font-size: 48px; margin-bottom: 12px;">üîç</div>
                        <div style="font-size: 14px;">Ë©≤ÂΩì„Åô„ÇãÊôØÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredPrizes.map(prize => {
                const stock = prize.stock || prize.count || 0;
                const typeLabel = prize.type || 'PSA10';
                const imageHtml = prize.image
                    ? `<img src="${prize.image}" alt="" style="width: 40px; height: 56px; object-fit: cover; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;">`
                    : `<div style="width: 40px; height: 56px; background: rgba(0,0,0,0.05); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">üì¶</div>`;

                return `
                <div onclick="applyManualMatchFromPrize('${prize.id}')" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); transition: all 0.15s; background: white;" onmouseover="this.style.background='rgba(0, 122, 255, 0.08)'" onmouseout="this.style.background='white'">
                    ${imageHtml}
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 13px; color: var(--sf-black); word-break: break-all;">
                            ${escapeHtml(prize.name)}
                        </div>
                        <div style="display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap;">
                            <span style="padding: 2px 8px; background: rgba(0, 122, 255, 0.1); color: var(--sf-blue); border-radius: 10px; font-size: 11px;">${typeLabel}</span>
                            <span style="padding: 2px 8px; background: ${stock > 0 ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 59, 48, 0.1)'}; color: ${stock > 0 ? 'var(--sf-green)' : 'var(--sf-red)'}; border-radius: 10px; font-size: 11px;">${stock > 0 ? stock + 'ÂÄã' : 'Âú®Â∫´„Å™„Åó'}</span>
                        </div>
                    </div>
                    <div style="color: var(--sf-blue); font-size: 12px; font-weight: 600; white-space: nowrap;">
                        ÈÅ∏Êäû ‚Üí
                    </div>
                </div>
                `;
            }).join('');
        }

        // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÈÅ∏Êäû„Åó„Å¶„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÇíÈÅ©Áî®
        function applyManualMatchFromPrize(prizeId) {
            if (selectedUnmatchedIndex === null) {
                alert('Â∑¶ÂÅ¥„ÅÆ„É™„Çπ„Éà„Åã„Çâ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åó„Åü„ÅÑÊôØÂìÅ„ÇíÂÖà„Å´ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const unmatchedItem = unmatchedCsvItems[selectedUnmatchedIndex];
            // ID„ÅÆÂûã„ÇíÁµ±‰∏Ä„Åó„Å¶ÊØîËºÉÔºàÊñáÂ≠óÂàó„Å®Êï∞ÂÄ§„ÅÆ‰∏°Êñπ„Å´ÂØæÂøúÔºâ
            const selectedPrize = prizeMaster.find(p => String(p.id) === String(prizeId));

            if (!unmatchedItem || !selectedPrize) {
                console.error('„Éû„ÉÉ„ÉÅ„É≥„Ç∞Â§±Êïó:', { prizeId, unmatchedItem, found: !!selectedPrize });
                return;
            }

            // CSV„Éá„Éº„Çø„ÅÆÊôØÂìÅÂêç„ÇíÊõ¥Êñ∞
            const oldName = unmatchedItem.csvName;
            const newName = selectedPrize.name;

            shippingCsvData.forEach(d => {
                if (d.prizeName === oldName) {
                    d.prizeName = newName;
                }
            });

            // unmatchedCsvItems„Åã„ÇâÂâäÈô§
            unmatchedCsvItems.splice(selectedUnmatchedIndex, 1);
            selectedUnmatchedIndex = null;

            // ÂÜçÊèèÁîª
            renderShippingOrders();
            updateCsvSummary();

            // „É¢„Éº„ÉÄ„É´„ÇíÊõ¥Êñ∞
            if (unmatchedCsvItems.length === 0) {
                closeManualMatchModal();
                alert('ÂÖ®„Å¶„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
            } else {
                // Ê§úÁ¥¢„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶Êõ¥Êñ∞
                document.getElementById('manualMatchSearchText').value = '';
                updateManualMatchUnmatchedList();
                updateManualMatchPrizeList();
            }
        }

        // ÊâãÂãï„Éû„ÉÉ„ÉÅ„É≥„Ç∞„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeManualMatchModal() {
            document.getElementById('manualMatchModal').style.display = 'none';
            selectedUnmatchedIndex = null;
        }

        // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫„Åó„Å¶„Åã„ÇâÂú®Â∫´Ê∏õÂ∞ë„ÇíÂÆüË°å
        function confirmAndApplyShippedDecrease() {
            // ÈÅ∏Êäû„Åï„Çå„ÅüÊ≥®Êñá„ÅÆÁô∫ÈÄÅÊ∏à„Åø„Ç¢„Ç§„ÉÜ„É†„ÇíÂèñÂæó
            const shippedItems = filteredShippingData.filter(d => d.status === 'shipped' && !d.isRandomPack);
            const pendingItems = filteredShippingData.filter(d => d.status === 'pending');

            if (shippedItems.length === 0 && pendingItems.length === 0) {
                alert('Âèñ„ÇäËæº„ÇÄÊ≥®Êñá„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            // Áô∫ÈÄÅÊ∏à„Åø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊú™Áô∫ÈÄÅ„ÅÆ„Åø‰øùÂ≠ò
            if (shippedItems.length === 0) {
                if (confirm(`Êú™Áô∫ÈÄÅ ${pendingItems.length}‰ª∂„ÇíÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü`)) {
                    savePendingFromCsv();
                }
                return;
            }

            // ÊôØÂìÅÂêç„Åß„Ç∞„É´„Éº„ÉóÂåñ„Åó„Å¶ÈõÜË®à
            const grouped = {};
            const unmatchedItems = [];

            shippedItems.forEach(item => {
                // Ê≠£Ë¶èÂåñ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅßÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÊ§úÁ¥¢
                const masterItem = findPrizeByNormalizedName(item.prizeName);
                if (!grouped[item.prizeName]) {
                    // stock „Åæ„Åü„ÅØ count „ÅÆ„Å©„Å°„Çâ„Åã„Çí‰ΩøÁî®
                    const currentStock = masterItem ? (masterItem.stock ?? masterItem.count ?? 0) : 0;
                    grouped[item.prizeName] = {
                        count: 0,
                        matched: !!masterItem,
                        currentStock: currentStock,
                        masterName: masterItem ? masterItem.name : null
                    };
                }
                grouped[item.prizeName].count += item.quantity;
                if (!masterItem && !unmatchedItems.includes(item.prizeName)) {
                    unmatchedItems.push(item.prizeName);
                }
            });

            // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩúÊàê
            let confirmMessage = '‰ª•‰∏ã„ÅÆÂú®Â∫´„ÇíÊ∏õÂ∞ë„Åï„Åõ„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\n\n';
            confirmMessage += '„ÄêÊ∏õÂ∞ëÂØæË±°„Äë\n';

            const matchedEntries = Object.entries(grouped).filter(([, data]) => data.matched);
            matchedEntries.sort((a, b) => b[1].count - a[1].count);

            matchedEntries.forEach(([prizeName, data]) => {
                confirmMessage += `„Éª${prizeName}: ${data.count}ÂÄã (ÁèæÂú®Â∫´: ${data.currentStock}ÂÄã ‚Üí ${Math.max(0, data.currentStock - data.count)}ÂÄã)\n`;
            });

            const totalMatched = matchedEntries.reduce((sum, [, data]) => sum + data.count, 0);
            confirmMessage += `\nÂêàË®à: ${totalMatched}‰ª∂\n`;

            if (unmatchedItems.length > 0) {
                confirmMessage += `\n‚ö†Ô∏è Êú™ÁôªÈå≤ÔºàÂá¶ÁêÜ„Åï„Çå„Å™„ÅÑÔºâ: ${unmatchedItems.length}Á®ÆÈ°û\n`;
                unmatchedItems.slice(0, 5).forEach(name => {
                    confirmMessage += `„Éª${name}\n`;
                });
                if (unmatchedItems.length > 5) {
                    confirmMessage += `...‰ªñ ${unmatchedItems.length - 5}‰ª∂\n`;
                }
            }

            // Êú™Áô∫ÈÄÅ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆÊó®„ÇÇË°®Á§∫
            if (pendingItems.length > 0) {
                confirmMessage += `\nüìã Êú™Áô∫ÈÄÅ ${pendingItems.length}‰ª∂„ÇÇÁôªÈå≤„Åï„Çå„Åæ„Åô\n`;
            }

            if (confirm(confirmMessage)) {
                applyShippedInventoryDecrease();
            }
        }

        // Áô∫ÈÄÅÊ∏à„Åø„ÇíÂú®Â∫´„Åã„ÇâÊ∏õÂ∞ë
        function applyShippedInventoryDecrease() {
            // ÈÅ∏Êäû„Åï„Çå„ÅüÊ≥®Êñá„ÅÆÁô∫ÈÄÅÊ∏à„Åø„Ç¢„Ç§„ÉÜ„É†„ÇíÂèñÂæó
            const shippedItems = filteredShippingData.filter(d => d.status === 'shipped' && !d.isRandomPack);

            if (shippedItems.length === 0) {
                alert('Áô∫ÈÄÅÊ∏à„Åø„ÅÆÊôØÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            let successCount = 0;
            let failCount = 0;
            const historyEntries = [];

            shippedItems.forEach(item => {
                // masterId„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞Ê≠£Ë¶èÂåñ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅßÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÊ§úÁ¥¢
                let masterItem = null;
                if (item.masterId) {
                    masterItem = prizeMaster.find(p => p.id === item.masterId);
                    if (masterItem) {
                        console.log(`‚úÖ masterId ${item.masterId} „ÅßÊôØÂìÅ„ÇíÁâπÂÆö: ${masterItem.name}`);
                    }
                }
                if (!masterItem) {
                    masterItem = findPrizeByNormalizedName(item.prizeName);
                    if (masterItem) {
                        console.log(`üìù ÊôØÂìÅÂêç„Éû„ÉÉ„ÉÅ„É≥„Ç∞: ${item.prizeName} ‚Üí ${masterItem.name} (ID: ${masterItem.id})`);
                    }
                }

                if (masterItem) {
                    // stock „Åæ„Åü„ÅØ count „ÅÆ„Å©„Å°„Çâ„Åã„Çí‰ΩøÁî®
                    const stockKey = 'stock' in masterItem ? 'stock' : 'count';
                    const oldStock = masterItem[stockKey] ?? 0;
                    const newStock = Math.max(0, oldStock - item.quantity);
                    masterItem[stockKey] = newStock;
                    successCount += item.quantity;

                    historyEntries.push({
                        type: 'decrease',
                        prizeName: masterItem.name,
                        quantity: item.quantity,
                        oldStock: oldStock,
                        newStock: newStock,
                        reason: 'Áô∫ÈÄÅ',
                        timestamp: new Date().toISOString()
                    });

                    console.log(`üì¶ Âú®Â∫´Ê∏õÂ∞ë: ${masterItem.name} ${oldStock} ‚Üí ${newStock}`);
                } else {
                    failCount += item.quantity;
                    console.warn('ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', item.prizeName);
                }
            });

            // Áô∫ÈÄÅÊ∏à„Åø„ÅÆÊ≥®ÊñáID„ÇíË®òÈå≤ÔºàÈáçË§áÂá¶ÁêÜÈò≤Ê≠¢Ôºâ
            const processedOrderIds = new Set();
            shippedItems.forEach(item => {
                if (item.orderId) {
                    processedOrderIds.add(String(item.orderId));
                }
            });
            processedOrderIds.forEach(orderId => {
                shippedOrderIds.add(orderId);
            });
            saveShippedOrderIds();
            console.log(`üìã Áô∫ÈÄÅÊ∏à„ÅøID ${processedOrderIds.size}‰ª∂„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü`);

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Çí‰øùÂ≠ò
            savePrizeMaster();
            updatePrizeMasterList();

            // Â±•Ê≠¥„Çí‰øùÂ≠ò
            saveInventoryHistoryEntries(historyEntries);

            // CSV„Åã„ÇâË™≠„ÅøËæº„Çì„Å†Êú™Áô∫ÈÄÅ„ÇípendingOrders„Å´„Éû„Éº„Ç∏„Åó„Å¶‰øùÂ≠ò
            const newPendingFromCsv = filteredShippingData.filter(d => d.status === 'pending');
            let pendingAddedCount = 0;
            newPendingFromCsv.forEach(newItem => {
                // masterId„Åå„Å™„Åë„Çå„Å∞ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÊ§úÁ¥¢„Åó„Å¶ËøΩÂä†
                if (!newItem.masterId) {
                    const masterItem = findPrizeByNormalizedName(newItem.prizeName);
                    if (masterItem) {
                        newItem.masterId = masterItem.id;
                        console.log(`üìù Êú™Áô∫ÈÄÅ„Å´ÊôØÂìÅ„Éû„Çπ„Çø„ÉºID„ÇíÁ¥ê‰ªò„Åë: ${newItem.prizeName} ‚Üí ${masterItem.id}`);
                    }
                }

                // Âêå„ÅòID + orderId + prizeName „ÅÆÊó¢Â≠ò„Ç¢„Ç§„ÉÜ„É†„ÇíÊ§úÁ¥¢
                const existingItem = pendingOrders.find(existing =>
                    existing.id === newItem.id &&
                    existing.orderId === newItem.orderId &&
                    existing.prizeName === newItem.prizeName
                );
                if (existingItem) {
                    // Êó¢Â≠ò„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„Çå„Å∞Êï∞Èáè„ÇíÂ¢ó„ÇÑ„Åô
                    existingItem.quantity = (existingItem.quantity || 1) + (newItem.quantity || 1);
                    // masterId„ÇÇÊõ¥Êñ∞ÔºàÊú™Ë®≠ÂÆö„ÅÆÂ†¥ÂêàÔºâ
                    if (!existingItem.masterId && newItem.masterId) {
                        existingItem.masterId = newItem.masterId;
                    }
                    console.log(`üì¶ Êó¢Â≠ò„Ç¢„Ç§„ÉÜ„É†„ÅÆÊï∞Èáè„ÇíÂ¢óÂä†: ${newItem.prizeName} ‚Üí ${existingItem.quantity}ÂÄã`);
                } else {
                    // Êñ∞Ë¶è„Ç¢„Ç§„ÉÜ„É†„Å®„Åó„Å¶ËøΩÂä†
                    pendingOrders.push(newItem);
                    pendingAddedCount++;
                }
            });
            if (pendingAddedCount > 0) {
                savePendingOrdersToCloud();
                console.log(`üìã Êú™Áô∫ÈÄÅ ${pendingAddedCount}‰ª∂„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò`);
                // Êú™Áô∫ÈÄÅ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
                renderPendingOrdersOnly();
            }

            // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            if (randomPackCount > 0) {
                openRandomPackModal();
            }

            alert(`Âú®Â∫´Ê∏õÂ∞ëÂÆå‰∫Ü\nÊàêÂäü: ${successCount}‰ª∂\nÊú™ÁôªÈå≤: ${failCount}‰ª∂${pendingAddedCount > 0 ? `\n\nÊú™Áô∫ÈÄÅ: ${pendingAddedCount}‰ª∂„ÇíÁôªÈå≤` : ''}`);
        }

        // CSV„Åã„ÇâË™≠„ÅøËæº„Çì„Å†Êú™Áô∫ÈÄÅ„ÅÆ„Åø„Çí‰øùÂ≠òÔºàÁô∫ÈÄÅÊ∏à„Åø„Åå„Å™„ÅÑÂ†¥ÂêàÁî®Ôºâ
        function savePendingFromCsv() {
            const newPendingFromCsv = filteredShippingData.filter(d => d.status === 'pending');
            let pendingAddedCount = 0;

            newPendingFromCsv.forEach(newItem => {
                // masterId„Åå„Å™„Åë„Çå„Å∞ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÊ§úÁ¥¢„Åó„Å¶ËøΩÂä†
                if (!newItem.masterId) {
                    const masterItem = findPrizeByNormalizedName(newItem.prizeName);
                    if (masterItem) {
                        newItem.masterId = masterItem.id;
                        console.log(`üìù Êú™Áô∫ÈÄÅ„Å´ÊôØÂìÅ„Éû„Çπ„Çø„ÉºID„ÇíÁ¥ê‰ªò„Åë: ${newItem.prizeName} ‚Üí ${masterItem.id}`);
                    }
                }

                // Âêå„ÅòID + orderId + prizeName „ÅÆÊó¢Â≠ò„Ç¢„Ç§„ÉÜ„É†„ÇíÊ§úÁ¥¢
                const existingItem = pendingOrders.find(existing =>
                    existing.id === newItem.id &&
                    existing.orderId === newItem.orderId &&
                    existing.prizeName === newItem.prizeName
                );
                if (existingItem) {
                    // Êó¢Â≠ò„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„Çå„Å∞Êï∞Èáè„ÇíÂ¢ó„ÇÑ„Åô
                    existingItem.quantity = (existingItem.quantity || 1) + (newItem.quantity || 1);
                    // masterId„ÇÇÊõ¥Êñ∞ÔºàÊú™Ë®≠ÂÆö„ÅÆÂ†¥ÂêàÔºâ
                    if (!existingItem.masterId && newItem.masterId) {
                        existingItem.masterId = newItem.masterId;
                    }
                } else {
                    // Êñ∞Ë¶è„Ç¢„Ç§„ÉÜ„É†„Å®„Åó„Å¶ËøΩÂä†
                    pendingOrders.push(newItem);
                    pendingAddedCount++;
                }
            });

            if (pendingAddedCount > 0) {
                savePendingOrdersToCloud();
                alert(`Êú™Áô∫ÈÄÅ ${pendingAddedCount}‰ª∂„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü`);
            } else {
                alert('Êñ∞Ë¶è„ÅÆÊú™Áô∫ÈÄÅ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„ÅüÔºàÊó¢„Å´ÁôªÈå≤Ê∏à„ÅøÔºâ');
            }

            // Êú™Áô∫ÈÄÅ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
            renderPendingOrdersOnly();
        }

        // ========== „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ ==========

        function openRandomPackModal() {
            // filteredShippingData„Åã„ÇâÊúÄÊñ∞„ÅÆÊûöÊï∞„ÇíÂÜçË®àÁÆó
            const recalculatedTotal = (filteredShippingData || [])
                .filter(d => d.status === 'shipped' && d.isRandomPack)
                .reduce((sum, d) => sum + (d.randomPackQty || 1), 0);
            randomPackCount = recalculatedTotal;

            document.getElementById('randomPackCount').textContent = randomPackCount;

            // „Éë„ÉÉ„ÇØ„Éª„Éú„ÉÉ„ÇØ„ÇπÁ≥ª„ÅÆÊôØÂìÅ„Çí‰∏ÄË¶ßË°®Á§∫ÔºàÂú®Â∫´„Åå„ÅÇ„Çã„ÇÇ„ÅÆÔºâ
            // type „Åå„Äå„Éë„ÉÉ„ÇØ„Äç„Åæ„Åü„ÅØ„Äå„Éú„ÉÉ„ÇØ„Çπ„Äç„ÄÅ„Åæ„Åü„ÅØÂêçÂâç„Å´Âê´„ÇÄ„ÇÇ„ÅÆ
            const packPrizes = prizeMaster.filter(p => {
                const stock = p.stock ?? p.count ?? 0;
                if (stock <= 0) return false;
                const type = p.type || '';
                // type„Åå„Äå„Éë„ÉÉ„ÇØ„Äç„Äå„Éú„ÉÉ„ÇØ„Çπ„Äç„ÅÆÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØÂêçÂâç„Å´Âê´„ÇÄÂ†¥Âêà
                return type === '„Éë„ÉÉ„ÇØ' || type === '„Éú„ÉÉ„ÇØ„Çπ' ||
                       p.name.includes('„Éë„ÉÉ„ÇØ') || p.name.includes('„Éú„ÉÉ„ÇØ„Çπ');
            });

            // Âú®Â∫´„ÅåÂ§ö„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
            packPrizes.sort((a, b) => (b.stock ?? b.count ?? 0) - (a.stock ?? a.count ?? 0));

            // ÂêàË®àÂú®Â∫´„ÇíË®àÁÆó
            const totalAvailableStock = packPrizes.reduce((sum, p) => sum + (p.stock ?? p.count ?? 0), 0);

            // Âú®Â∫´‰∏çË∂≥„ÅÆË≠¶Âëä„ÇíË°®Á§∫
            const stockInfoEl = document.getElementById('randomPackStockInfo');
            const stockCountEl = document.getElementById('randomPackTotalStock');
            if (totalAvailableStock < randomPackCount) {
                stockInfoEl.style.display = 'block';
                stockCountEl.textContent = totalAvailableStock;
            } else {
                stockInfoEl.style.display = 'none';
            }

            randomPackSelections = {};

            const container = document.getElementById('randomPackPrizeList');

            if (packPrizes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--sf-gray);">
                        <div style="font-size: 48px; margin-bottom: 12px;">üì¶</div>
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">„Éë„ÉÉ„ÇØ„Éª„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂú®Â∫´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div style="font-size: 13px;">ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅßÁ®ÆÈ°û„Çí„Äå„Éë„ÉÉ„ÇØ„Äç„Åæ„Åü„ÅØ„Äå„Éú„ÉÉ„ÇØ„Çπ„Äç„Å´Ë®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
            } else {
                container.innerHTML = packPrizes.map(p => {
                    const stock = p.stock ?? p.count ?? 0;
                    const typeLabel = p.type || '‰∏çÊòé';
                    const imageHtml = p.image
                        ? `<img src="${p.image}" alt="" style="width: 50px; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;">`
                        : `<div style="width: 50px; height: 70px; background: rgba(0,0,0,0.05); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;">üì¶</div>`;

                    return `
                    <div style="display: flex; align-items: center; gap: 16px; padding: 16px; border-bottom: 1px solid rgba(0, 0, 0, 0.08); background: white;">
                        ${imageHtml}
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 15px; color: var(--sf-black); word-break: break-all;">${escapeHtml(p.name)}</div>
                            <div style="display: flex; gap: 8px; margin-top: 6px;">
                                <span style="padding: 3px 10px; background: rgba(175, 82, 222, 0.1); color: var(--sf-purple); border-radius: 12px; font-size: 12px; font-weight: 600;">${typeLabel}</span>
                                <span style="padding: 3px 10px; background: rgba(52, 199, 89, 0.1); color: var(--sf-green); border-radius: 12px; font-size: 12px; font-weight: 600;">Âú®Â∫´: ${stock}ÂÄã</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button onclick="adjustRandomPackQty('${p.id}', -1)" style="width: 44px; height: 44px; border: 2px solid rgba(0,0,0,0.15); border-radius: 10px; background: white; cursor: pointer; font-size: 24px; font-weight: 600; color: var(--sf-blue); display: flex; align-items: center; justify-content: center; transition: all 0.15s;" onmouseover="this.style.background='rgba(0,122,255,0.1)'" onmouseout="this.style.background='white'">‚àí</button>
                            <span id="randompack-qty-${p.id}" style="min-width: 50px; text-align: center; font-weight: 700; font-size: 20px; color: var(--sf-black);">0</span>
                            <button onclick="adjustRandomPackQty('${p.id}', 1)" style="width: 44px; height: 44px; border: 2px solid rgba(0,0,0,0.15); border-radius: 10px; background: white; cursor: pointer; font-size: 24px; font-weight: 600; color: var(--sf-blue); display: flex; align-items: center; justify-content: center; transition: all 0.15s;" onmouseover="this.style.background='rgba(0,122,255,0.1)'" onmouseout="this.style.background='white'">+</button>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            document.getElementById('randomPackModal').style.display = 'flex';
        }

        function adjustRandomPackQty(prizeId, delta) {
            // ID„ÅÆÂûã„ÇíÁµ±‰∏Ä„Åó„Å¶ÊØîËºÉ
            const prize = prizeMaster.find(p => String(p.id) === String(prizeId));
            if (!prize) return;

            const stock = prize.stock ?? prize.count ?? 0;
            const currentQty = randomPackSelections[prizeId] || 0;
            const newQty = Math.max(0, Math.min(stock, currentQty + delta));
            randomPackSelections[prizeId] = newQty;

            document.getElementById('randompack-qty-' + prizeId).textContent = newQty;
            updateRandomPackTotal();
        }

        // ÈÅ∏ÊäûÂêàË®à„ÇíÊõ¥Êñ∞
        function updateRandomPackTotal() {
            const totalSelected = Object.values(randomPackSelections).reduce((sum, qty) => sum + qty, 0);
            const countEl = document.getElementById('randomPackCount');
            if (countEl) {
                countEl.innerHTML = `${randomPackCount} <span style="color: ${totalSelected === randomPackCount ? 'var(--sf-green)' : 'var(--sf-orange)'}; font-weight: 600;">(ÈÅ∏Êäû‰∏≠: ${totalSelected})</span>`;
            }
        }

        function closeRandomPackModal() {
            document.getElementById('randomPackModal').style.display = 'none';
            // Êú™Áô∫ÈÄÅ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„É™„Çª„ÉÉ„Éà
            pendingRandomPackContext = null;
        }

        function confirmRandomPackSelection() {
            const totalSelected = Object.values(randomPackSelections).reduce((sum, qty) => sum + qty, 0);

            if (totalSelected === 0) {
                alert('„Éë„ÉÉ„ÇØ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÈÅ∏ÊäûÊï∞„ÅåÂøÖË¶ÅÊï∞„Å®Áï∞„Å™„ÇãÂ†¥Âêà„ÅØÁ¢∫Ë™ç
            if (totalSelected !== randomPackCount) {
                const shortage = randomPackCount - totalSelected;
                if (!confirm(`ÈÅ∏ÊäûÊï∞„ÅåÂøÖË¶ÅÊï∞„Å®Áï∞„Å™„Çä„Åæ„Åô„ÄÇ\n\nÂøÖË¶Å: ${randomPackCount}Êûö\nÈÅ∏Êäû: ${totalSelected}Êûö\n‰∏çË∂≥: ${shortage}Êûö\n\n${totalSelected}ÊûöÂàÜ„Å†„ÅëÂá¶ÁêÜ„Åó„Åæ„Åô„ÅãÔºü\nÔºàÊÆã„Çä${shortage}Êûö„ÅØÂæå„ÅßÂá¶ÁêÜ„Åß„Åç„Åæ„ÅôÔºâ`)) {
                    return;
                }
            }

            const historyEntries = [];
            const isPendingContext = pendingRandomPackContext !== null;
            const reason = isPendingContext ? '„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØÁô∫ÈÄÅÔºàÊú™Áô∫ÈÄÅ„Åã„ÇâÔºâ' : '„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØÁô∫ÈÄÅ';

            // ÈÅ∏Êäû„Åó„ÅüÂàÜ„Å†„ÅëÂú®Â∫´„ÇíÊ∏õÂ∞ë
            Object.entries(randomPackSelections).forEach(([prizeId, qty]) => {
                if (qty > 0) {
                    // ID„ÅÆÂûã„ÇíÁµ±‰∏Ä„Åó„Å¶ÊØîËºÉ
                    const prize = prizeMaster.find(p => String(p.id) === String(prizeId));
                    if (prize) {
                        // stock „Åæ„Åü„ÅØ count „ÅÆ„Å©„Å°„Çâ„Åã„Çí‰ΩøÁî®
                        const stockKey = 'stock' in prize ? 'stock' : 'count';
                        const oldStock = prize[stockKey] ?? 0;
                        prize[stockKey] = Math.max(0, oldStock - qty);

                        historyEntries.push({
                            type: 'decrease',
                            prizeName: prize.name,
                            quantity: qty,
                            oldStock: oldStock,
                            newStock: prize[stockKey],
                            reason: reason,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            });

            savePrizeMaster();
            updatePrizeMasterList();
            saveInventoryHistoryEntries(historyEntries);

            // Êú™Áô∫ÈÄÅ„Åã„Çâ„ÅÆÂ†¥Âêà„ÅØ„ÄÅpendingOrders„Åã„ÇâË©≤ÂΩì„Ç¢„Ç§„ÉÜ„É†„ÇíÂâäÈô§
            if (isPendingContext) {
                const groupId = pendingRandomPackContext.groupId;
                const normalItems = pendingRandomPackContext.normalItems || [];

                // ID„Ç∞„É´„Éº„ÉóÊåáÂÆö„ÅÆÂ†¥Âêà
                if (groupId) {
                    // ÈÄöÂ∏∏„Ç¢„Ç§„ÉÜ„É†„ÇÇÂá¶ÁêÜ
                    if (normalItems.length > 0) {
                        normalItems.forEach(item => {
                            // Á¥ê‰ªò„Åë„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆID„ÅßÊ§úÁ¥¢
                            let masterItem = null;
                            if (item.linkedPrizeId) {
                                masterItem = prizeMaster.find(p => String(p.id) === String(item.linkedPrizeId));
                            }
                            if (!masterItem) {
                                masterItem = findPrizeByNormalizedName(item.prizeName);
                            }
                            if (masterItem) {
                                const stockKey = 'stock' in masterItem ? 'stock' : 'count';
                                const oldStock = masterItem[stockKey] || 0;
                                const qty = item.quantity || 1;
                                masterItem[stockKey] = Math.max(0, oldStock - qty);

                                historyEntries.push({
                                    type: 'decrease',
                                    prizeName: masterItem.name,
                                    quantity: qty,
                                    oldStock: oldStock,
                                    newStock: masterItem[stockKey],
                                    reason: `Áô∫ÈÄÅÔºàID:${groupId}Ôºâ`,
                                    timestamp: new Date().toISOString()
                                });
                            }
                        });

                        // ËøΩÂä†„ÅÆÂ±•Ê≠¥„Çí‰øùÂ≠ò
                        savePrizeMaster();
                        updatePrizeMasterList();
                        saveInventoryHistoryEntries(historyEntries.slice(-normalItems.length));
                    }

                    // ID„Ç∞„É´„Éº„ÉóÂÖ®‰Ωì„ÇíÂâäÈô§
                    pendingOrders = pendingOrders.filter(p => String(p.id) !== String(groupId));
                    if (filteredShippingData) {
                        filteredShippingData = filteredShippingData.filter(d =>
                            !(d.status === 'pending' && String(d.id) === String(groupId))
                        );
                    }
                } else {
                    // ÊóßÊñπÂºèÔºàÊôØÂìÅÂêç„Éô„Éº„ÇπÔºâ
                    const prizeName = pendingRandomPackContext.prizeName;
                    const singleItemId = pendingRandomPackContext.singleItemId;

                    if (singleItemId) {
                        pendingOrders = pendingOrders.filter(p => !(p.prizeName === prizeName && String(p.id) === String(singleItemId)));
                        if (filteredShippingData) {
                            filteredShippingData = filteredShippingData.filter(d => !(d.status === 'pending' && String(d.id) === String(singleItemId)));
                        }
                    } else {
                        pendingOrders = pendingOrders.filter(p => p.prizeName !== prizeName);
                        if (filteredShippingData) {
                            filteredShippingData = filteredShippingData.filter(d => !(d.status === 'pending' && d.prizeName === prizeName));
                        }
                    }
                }

                savePendingOrdersToCloud();
                refreshPendingOrdersDisplay();

                const alertGroupId = groupId;
                pendingRandomPackContext = null;
                closeRandomPackModal();

                if (alertGroupId) {
                    // Áô∫ÈÄÅÊ∏à„ÅøID„Å®„Åó„Å¶Ë®òÈå≤ÔºàÈáçË§áÁô∫ÈÄÅÈò≤Ê≠¢Ôºâ
                    recordShippedOrderId(alertGroupId);
                    alert(`ID: ${alertGroupId} „ÇíÁô∫ÈÄÅÊ∏à„Åø„Å´„Åó„Åæ„Åó„Åü`);
                } else {
                    alert('„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅÆÂú®Â∫´Ê∏õÂ∞ë„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
                }
                return;
            }

            closeRandomPackModal();
            alert('„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅÆÂú®Â∫´Ê∏õÂ∞ë„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
        }

        // ========== Âú®Â∫´ÁôªÈå≤Ê©üËÉΩ ==========

        // Ë¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„ÇíË°®Á§∫ÔºàÊú™Áô∫ÈÄÅ„ÅßÂú®Â∫´0„ÅÆÊôØÂìÅÔºâ
        function renderNeedRestockList() {
            const section = document.getElementById('needRestockSection');
            const container = document.getElementById('needRestockContainer');
            const countSpan = document.getElementById('needRestockCount');

            if (!section || !container) return;

            // Êú™Áô∫ÈÄÅÊ≥®Êñá„ÇíÊôØÂìÅÂêç„Åß„Ç∞„É´„Éº„ÉóÂåñÔºà„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅØÈô§Â§ñÔºâ
            const pendingByPrize = {};
            pendingOrders.forEach(order => {
                // „Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ„ÅØË¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„Å´Ë°®Á§∫„Åó„Å™„ÅÑ
                if (order.prizeName.includes('„Å™„Å´„Åã„ÅÆ„Éë„ÉÉ„ÇØ')) {
                    return;
                }
                if (!pendingByPrize[order.prizeName]) {
                    pendingByPrize[order.prizeName] = {
                        prizeName: order.prizeName,
                        linkedPrizeId: order.linkedPrizeId,
                        linkedPrizeName: order.linkedPrizeName,
                        totalQty: 0,
                        orders: []
                    };
                }
                // Á¥ê‰ªò„ÅëÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞Êõ¥Êñ∞
                if (order.linkedPrizeId && !pendingByPrize[order.prizeName].linkedPrizeId) {
                    pendingByPrize[order.prizeName].linkedPrizeId = order.linkedPrizeId;
                    pendingByPrize[order.prizeName].linkedPrizeName = order.linkedPrizeName;
                }
                pendingByPrize[order.prizeName].totalQty += (order.quantity || 1);
                pendingByPrize[order.prizeName].orders.push(order);
            });

            // Âú®Â∫´0„ÅÆ„ÇÇ„ÅÆ„Å†„ÅëÊäΩÂá∫
            const needRestock = [];
            Object.values(pendingByPrize).forEach(item => {
                // Á¥ê‰ªò„Åë„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆID„ÅßÊ§úÁ¥¢„ÄÅ„Å™„Åë„Çå„Å∞Ê≠£Ë¶èÂåñ„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                let masterItem;
                if (item.linkedPrizeId) {
                    masterItem = prizeMaster.find(p => String(p.id) === String(item.linkedPrizeId));
                }
                if (!masterItem) {
                    masterItem = findPrizeByNormalizedName(item.prizeName);
                }
                const currentStock = masterItem ? (masterItem.stock ?? masterItem.count ?? 0) : 0;

                if (currentStock === 0) {
                    needRestock.push({
                        ...item,
                        masterItem: masterItem,
                        currentStock: currentStock
                    });
                }
            });

            // ÂøÖË¶ÅÊï∞Èáè„ÅÆÂ§ö„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
            needRestock.sort((a, b) => b.totalQty - a.totalQty);

            if (needRestock.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            const registeredCount = needRestock.filter(i => i.masterItem).length;
            const unregisteredCount = needRestock.filter(i => !i.masterItem).length;
            countSpan.textContent = `(${needRestock.length}‰ª∂${unregisteredCount > 0 ? ` / Êú™ÁôªÈå≤${unregisteredCount}‰ª∂` : ''})`;

            container.innerHTML = needRestock.map(item => {
                const imageUrl = item.masterItem?.image || item.masterItem?.imageUrl || '';
                const prizeId = item.masterItem?.id || '';
                const escapedName = escapeHtml(item.prizeName).replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const isUnregistered = !item.masterItem;

                if (isUnregistered) {
                    // Êú™ÁôªÈå≤ÊôØÂìÅ„ÅÆÂ†¥Âêà
                    return `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid var(--sf-orange);">
                        <div style="width: 50px; height: 50px; background: rgba(255, 149, 0, 0.1); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--sf-orange); font-size: 20px;">‚ö†Ô∏è</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(item.prizeName)}</div>
                            <div style="font-size: 12px; color: var(--sf-orange); margin-top: 2px;">
                                ‚ö†Ô∏è „Éû„Çπ„Çø„ÉºÊú™ÁôªÈå≤ ‚Üí ÂøÖË¶Å: ${item.totalQty}ÂÄã
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button onclick="openUnregisteredPrizeModal('${escapedName}', ${item.totalQty})" style="background: var(--sf-orange); color: white; border: none; border-radius: 6px; padding: 8px 16px; font-size: 13px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                üîß ÁôªÈå≤/ÂèÇÁÖß
                            </button>
                        </div>
                    </div>
                    `;
                } else {
                    // ÁôªÈå≤Ê∏à„ÅøÊôØÂìÅ„ÅÆÂ†¥Âêà
                    const isLinked = item.linkedPrizeId && item.linkedPrizeName && item.linkedPrizeName !== item.prizeName;
                    const displayName = isLinked ? item.linkedPrizeName : item.prizeName;
                    return `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid var(--sf-red);">
                        ${imageUrl ? `<img src="${imageUrl}" style="width: 50px; height: 50px; object-fit: contain; border-radius: 4px; background: #f5f5f5;" onerror="this.style.display='none'">` : '<div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 20px;">üì¶</div>'}
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(displayName)}</div>
                            ${isLinked ? `<div style="font-size: 11px; color: var(--sf-blue); margin-top: 1px;">üîó ${escapeHtml(item.prizeName)}</div>` : ''}
                            <div style="font-size: 12px; color: var(--sf-red); margin-top: 2px;">
                                Âú®Â∫´: 0ÂÄã ‚Üí ÂøÖË¶Å: ${item.totalQty}ÂÄã
                            </div>
                            ${item.masterItem?.purchasePrice ? `<div style="font-size: 11px; color: var(--sf-gray); margin-top: 1px;">ÁèæÂú®„ÅÆÂπ≥Âùá‰ªïÂÖ•„ÇåÂÄ§: ¬•${item.masterItem.purchasePrice.toLocaleString()}</div>` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-end;">
                            <div style="display: flex; gap: 6px; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 2px;">
                                    <span style="font-size: 11px; color: var(--sf-gray);">Êï∞Èáè</span>
                                    <input type="number" id="restockQty_${prizeId}" value="${item.totalQty}" min="1" style="width: 50px; padding: 6px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); text-align: center; font-size: 13px;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 2px;">
                                    <span style="font-size: 11px; color: var(--sf-gray);">Âçò‰æ°¬•</span>
                                    <input type="number" id="restockPrice_${prizeId}" value="${item.masterItem?.purchasePrice || ''}" min="0" placeholder="0" style="width: 70px; padding: 6px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); text-align: right; font-size: 13px;">
                                </div>
                            </div>
                            <button onclick="quickAddToRegister('${prizeId}', '${escapedName}')" style="background: var(--sf-green); color: white; border: none; border-radius: 6px; padding: 8px 16px; font-size: 13px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                üì• ÂÖ•Â∫´
                            </button>
                        </div>
                    </div>
                    `;
                }
            }).join('');
        }

        // Ë¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„Åã„ÇâÁõ¥Êé•Âú®Â∫´„ÇíÂ¢ó„ÇÑ„Åô
        function quickAddToRegister(prizeId, prizeName) {
            const qtyInput = document.getElementById('restockQty_' + prizeId);
            const priceInput = document.getElementById('restockPrice_' + prizeId);
            const quantity = parseInt(qtyInput?.value) || 1;
            const unitPrice = parseInt(priceInput?.value) || 0;

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÊ§úÁ¥¢
            let masterItem = prizeMaster.find(p => String(p.id) === String(prizeId));

            // ID„ÅßË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÊ≠£Ë¶èÂåñ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅßÊ§úÁ¥¢
            if (!masterItem) {
                masterItem = findPrizeByNormalizedName(prizeName);
            }

            if (!masterItem) {
                alert('ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // ‰ªïÂÖ•„Çå‰æ°Ê†º„Åå0„ÅÆÂ†¥Âêà„ÅØÁ¢∫Ë™ç
            if (unitPrice <= 0) {
                if (!confirm('‰ªïÂÖ•„Çå‰æ°Ê†º„Åå0ÂÜÜ„Åß„Åô„ÄÇ„Åì„ÅÆ„Åæ„ÅæÂÖ•Â∫´„Åó„Åæ„Åô„ÅãÔºü')) {
                    return;
                }
            }

            // Áõ¥Êé•Âú®Â∫´„ÇíÂ¢ó„ÇÑ„Åô
            const stockKey = 'stock' in masterItem ? 'stock' : 'count';
            const oldStock = masterItem[stockKey] || 0;
            masterItem[stockKey] = oldStock + quantity;

            // ‰ªïÂÖ•„ÇåÂ±•Ê≠¥„Å´ËøΩÂä†
            if (!masterItem.purchasePriceHistory) {
                masterItem.purchasePriceHistory = [];
            }
            masterItem.purchasePriceHistory.push({
                price: unitPrice,
                quantity: quantity,
                date: new Date().toISOString(),
                reason: 'ÂÖ•Â∫´ÔºàË¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„Åã„ÇâÔºâ'
            });

            // Âä†ÈáçÂπ≥Âùá‰ªïÂÖ•„ÇåÂÄ§„ÇíÂÜçË®àÁÆó
            const newAvgPrice = calculateAveragePurchasePrice(masterItem);
            const oldPurchasePrice = masterItem.purchasePrice || 0;
            masterItem.purchasePrice = newAvgPrice;

            // Â±•Ê≠¥„Å´ËøΩÂä†
            const historyEntry = {
                type: 'increase',
                prizeName: masterItem.name,
                quantity: quantity,
                oldStock: oldStock,
                newStock: masterItem[stockKey],
                unitPrice: unitPrice,
                reason: 'ÂÖ•Â∫´ÔºàË¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„Åã„ÇâÔºâ',
                timestamp: new Date().toISOString()
            };

            savePrizeMaster();
            updatePrizeMasterList();
            saveInventoryHistoryEntries([historyEntry]);
            renderNeedRestockList();

            // Âú®Â∫´Ê∏õÂ∞ë„Çø„Éñ„ÅÆÊú™Áô∫ÈÄÅ„É™„Çπ„Éà„ÇÇÊõ¥Êñ∞ÔºàÂú®Â∫´Áä∂Ê≥Å„ÅåÂ§â„Çè„Çã„Åü„ÇÅÔºâ
            renderPendingOrdersOnly();

            let message = `${masterItem.name} ${quantity}ÂÄã„ÇíÂÖ•Â∫´„Åó„Åæ„Åó„Åü\n`;
            message += `Âú®Â∫´: ${oldStock} ‚Üí ${masterItem[stockKey]}\n`;
            message += `‰ªïÂÖ•„ÇåÂçò‰æ°: ¬•${unitPrice.toLocaleString()}\n`;
            if (oldPurchasePrice !== newAvgPrice) {
                message += `Âπ≥Âùá‰ªïÂÖ•„ÇåÂÄ§: ¬•${oldPurchasePrice.toLocaleString()} ‚Üí ¬•${newAvgPrice.toLocaleString()}`;
            }
            alert(message);
        }

        // ========== Êú™ÁôªÈå≤ÊôØÂìÅ„É¢„Éº„ÉÄ„É´Ê©üËÉΩ ==========

        let unregCurrentPrizeName = '';
        let unregCurrentNeededQty = 0;

        function openUnregisteredPrizeModal(prizeName, neededQty) {
            unregCurrentPrizeName = prizeName;
            unregCurrentNeededQty = neededQty;

            document.getElementById('unregPrizeName').textContent = prizeName;
            document.getElementById('unregNeededQty').textContent = neededQty;
            document.getElementById('unregNewName').value = prizeName;
            document.getElementById('unregNewImage').value = '';

            // „Çø„Éñ„Çí„ÄåÊñ∞Ë¶èÁôªÈå≤„Äç„Å´„É™„Çª„ÉÉ„Éà
            switchUnregTab('new');

            // Êó¢Â≠òÊ§úÁ¥¢„Çí„ÇØ„É™„Ç¢
            document.getElementById('unregSearchExisting').value = '';
            document.getElementById('unregExistingList').innerHTML = '<p style="padding: 20px; color: var(--sf-gray); text-align: center; font-size: 13px;">‰∏ä„ÅÆÊ§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ„ÅßÊôØÂìÅ„ÇíÊ§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';

            document.getElementById('unregisteredPrizeModal').style.display = 'flex';
        }

        function closeUnregisteredPrizeModal() {
            document.getElementById('unregisteredPrizeModal').style.display = 'none';
            unregCurrentPrizeName = '';
            unregCurrentNeededQty = 0;
        }

        function switchUnregTab(tabName) {
            const tabNew = document.getElementById('unregTabNew');
            const tabExisting = document.getElementById('unregTabExisting');
            const contentNew = document.getElementById('unregContentNew');
            const contentExisting = document.getElementById('unregContentExisting');

            if (tabName === 'new') {
                tabNew.style.background = 'var(--sf-blue)';
                tabNew.style.color = 'white';
                tabExisting.style.background = 'white';
                tabExisting.style.color = 'var(--sf-blue)';
                contentNew.style.display = 'block';
                contentExisting.style.display = 'none';
            } else {
                tabNew.style.background = 'white';
                tabNew.style.color = 'var(--sf-blue)';
                tabExisting.style.background = 'var(--sf-blue)';
                tabExisting.style.color = 'white';
                contentNew.style.display = 'none';
                contentExisting.style.display = 'block';

                // Êó¢Â≠ò„Çø„Éñ„ÇíÈñã„ÅÑ„ÅüÊôÇ„Å´Ê§úÁ¥¢ÁµêÊûú„ÇíË°®Á§∫
                searchExistingPrizesForUnreg();
            }
        }

        function searchExistingPrizesForUnreg() {
            const searchText = document.getElementById('unregSearchExisting').value.toLowerCase().trim();
            const container = document.getElementById('unregExistingList');

            // Ê§úÁ¥¢„ÉÜ„Ç≠„Çπ„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®‰ª∂Ë°®Á§∫ÔºàÊúÄÂ§ß30‰ª∂Ôºâ
            let matches;
            if (searchText.length === 0) {
                matches = prizeMaster.slice(0, 30);
            } else {
                matches = prizeMaster.filter(p =>
                    p.name.toLowerCase().includes(searchText)
                ).slice(0, 30);
            }

            if (matches.length === 0) {
                container.innerHTML = '<p style="padding: 20px; color: var(--sf-gray); text-align: center; font-size: 13px;">Ë©≤ÂΩì„Åô„ÇãÊôØÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            container.innerHTML = matches.map(p => {
                const stock = p.stock ?? p.count ?? 0;
                const typeLabel = p.type || '‰∏çÊòé';
                const imageHtml = p.image
                    ? `<img src="${p.image}" style="width: 40px; height: 40px; object-fit: contain; border-radius: 4px; background: #f5f5f5;" onerror="this.style.display='none'">`
                    : `<div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 16px;">üì¶</div>`;

                return `
                <div onclick="linkToExistingPrize('${p.id}')" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-bottom: 1px solid rgba(0,0,0,0.06); cursor: pointer; transition: background 0.15s;" onmouseover="this.style.background='rgba(0, 122, 255, 0.05)'" onmouseout="this.style.background='transparent'">
                    ${imageHtml}
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(p.name)}</div>
                        <div style="display: flex; gap: 6px; margin-top: 3px;">
                            <span style="font-size: 10px; padding: 2px 6px; background: rgba(175, 82, 222, 0.1); color: var(--sf-purple); border-radius: 4px;">${typeLabel}</span>
                            <span style="font-size: 10px; padding: 2px 6px; background: ${stock > 0 ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 59, 48, 0.1)'}; color: ${stock > 0 ? 'var(--sf-green)' : 'var(--sf-red)'}; border-radius: 4px;">Âú®Â∫´: ${stock}</span>
                        </div>
                    </div>
                    <div style="color: var(--sf-blue); font-size: 18px;">‚Üí</div>
                </div>
                `;
            }).join('');
        }

        function registerNewPrizeFromModal() {
            const name = document.getElementById('unregNewName').value.trim();
            const type = document.getElementById('unregNewType').value;
            const image = document.getElementById('unregNewImage').value.trim();

            if (!name) {
                alert('ÊôØÂìÅÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // Êó¢„Å´ÂêåÂêç„ÅÆÊôØÂìÅ„Åå„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const existingPrize = findPrizeByNormalizedName(name);
            if (existingPrize) {
                if (!confirm(`„Äå${existingPrize.name}„Äç„Å®„ÅÑ„ÅÜÈ°û‰ºº„ÅÆÊôØÂìÅ„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ\nÊñ∞Ë¶èÁôªÈå≤„ÇíÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü`)) {
                    return;
                }
            }

            // Êñ∞„Åó„ÅÑÊôØÂìÅ„Çí‰ΩúÊàêÔºàÂú®Â∫´0„ÅßÁôªÈå≤Ôºâ
            const newId = Date.now().toString();
            const newPrize = {
                id: newId,
                name: name,
                type: type,
                stock: 0,
                value: 0,
                purchasePrice: 0
            };

            if (image) {
                newPrize.image = image;
            }

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ËøΩÂä†
            prizeMaster.push(newPrize);
            savePrizeMaster();
            updatePrizeMasterList();

            // Ë¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„ÇíÊõ¥Êñ∞Ôºà„Éû„Çπ„Çø„ÉºÁôªÈå≤Ê∏à„Åø„Å®„Åó„Å¶Ë°®Á§∫„Åï„Çå„ÇãÔºâ
            renderNeedRestockList();

            closeUnregisteredPrizeModal();
            alert(`„Äå${name}„Äç„ÇíÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ÁôªÈå≤„Åó„Åæ„Åó„Åü\n\nË¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„Åã„ÇâÂÖ•Â∫´„Éú„Çø„É≥„ÅßÂú®Â∫´„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô`);
        }

        function linkToExistingPrize(prizeId) {
            const prize = prizeMaster.find(p => String(p.id) === String(prizeId));
            if (!prize) {
                alert('ÊôØÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            const currentStock = prize.stock ?? prize.count ?? 0;

            if (!confirm(`„Äå${unregCurrentPrizeName}„Äç„Çí\n„Äå${prize.name}„Äç„Å®„Åó„Å¶Á¥ê‰ªò„Åë„Åæ„Åô„ÅãÔºü\n\nÁèæÂú®„ÅÆÂú®Â∫´: ${currentStock}ÂÄã\nÔºàÂú®Â∫´„ÅØÂ§âÊõ¥„Åï„Çå„Åæ„Åõ„ÇìÔºâ`)) {
                return;
            }

            // pendingOrders„ÅÆË©≤ÂΩì„Ç¢„Ç§„ÉÜ„É†„ÅÆÊôØÂìÅÂêç„ÇíÊõ¥Êñ∞ÔºàÊ≠£Ë¶èÂåñ„Éû„ÉÉ„ÉÅ„É≥„Ç∞Áî®Ôºâ
            pendingOrders.forEach(order => {
                if (order.prizeName === unregCurrentPrizeName) {
                    order.linkedPrizeName = prize.name;
                    order.linkedPrizeId = prize.id;
                }
            });
            savePendingOrdersToCloud();

            // Ë¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„ÇíÊõ¥Êñ∞ÔºàÁ¥ê‰ªò„Åë„Çâ„Çå„Åü„ÅÆ„ÅßÁôªÈå≤Ê∏à„Åø„Å®„Åó„Å¶Ë°®Á§∫„Åï„Çå„ÇãÔºâ
            renderNeedRestockList();

            closeUnregisteredPrizeModal();
            alert(`„Äå${unregCurrentPrizeName}„Äç„Çí„Äå${prize.name}„Äç„Å´Á¥ê‰ªò„Åë„Åæ„Åó„Åü\n\nË¶ÅÂÖ•Ëç∑„É™„Çπ„Éà„Åã„ÇâÂÖ•Â∫´„Éú„Çø„É≥„ÅßÂú®Â∫´„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô`);
        }

        function searchPrizesForRegister() {
            const searchText = document.getElementById('registerPrizeSearch').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('registerPrizeResults');

            if (searchText.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            const matches = prizeMaster.filter(p =>
                p.name.toLowerCase().includes(searchText)
            ).slice(0, 20);

            if (matches.length === 0) {
                resultsContainer.innerHTML = '<p style="padding: 16px; color: var(--sf-gray); text-align: center;">Ë©≤ÂΩì„Åô„ÇãÊôØÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            } else {
                resultsContainer.innerHTML = matches.map(p => {
                    const stock = p.stock ?? p.count ?? 0;
                    const typeLabel = p.type || 'PSA10';
                    const imageHtml = p.image
                        ? `<img src="${p.image}" alt="" style="width: 50px; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;">`
                        : `<div style="width: 50px; height: 70px; background: rgba(0,0,0,0.05); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">üì¶</div>`;

                    return `
                    <div onclick="addToRegisterList('${p.id}')" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; transition: background 0.2s; background: white;" onmouseover="this.style.background='rgba(0,122,255,0.05)'" onmouseout="this.style.background='white'">
                        ${imageHtml}
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 14px; color: var(--sf-black);">${escapeHtml(p.name)}</div>
                            <div style="display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap;">
                                <span style="padding: 2px 8px; background: rgba(0, 122, 255, 0.1); color: var(--sf-blue); border-radius: 10px; font-size: 11px; font-weight: 600;">${typeLabel}</span>
                                <span style="padding: 2px 8px; background: ${stock > 0 ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 59, 48, 0.1)'}; color: ${stock > 0 ? 'var(--sf-green)' : 'var(--sf-red)'}; border-radius: 10px; font-size: 11px; font-weight: 600;">Âú®Â∫´: ${stock}ÂÄã</span>
                                <span style="padding: 2px 8px; background: rgba(0, 0, 0, 0.05); color: var(--sf-gray); border-radius: 10px; font-size: 11px;">¬•${(p.purchasePrice || 0).toLocaleString()}</span>
                            </div>
                        </div>
                        <div style="color: var(--sf-blue); font-size: 12px; font-weight: 600; white-space: nowrap;">+ ËøΩÂä†</div>
                    </div>
                    `;
                }).join('');
            }

            resultsContainer.style.display = 'block';
        }

        // Âä†ÈáçÂπ≥Âùá‰ªïÂÖ•„ÇåÂÄ§„ÇíË®àÁÆó
        function calculateAveragePurchasePrice(prize) {
            if (!prize.purchasePriceHistory || prize.purchasePriceHistory.length === 0) {
                return prize.purchasePrice || 0;
            }

            let totalValue = 0;
            let totalQuantity = 0;

            prize.purchasePriceHistory.forEach(entry => {
                totalValue += entry.price * entry.quantity;
                totalQuantity += entry.quantity;
            });

            if (totalQuantity === 0) return prize.purchasePrice || 0;
            return Math.round(totalValue / totalQuantity);
        }

        // ========== Âú®Â∫´Â¢óÊ∏õÂ±•Ê≠¥Ê©üËÉΩ ==========

        function setHistoryDateToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('historyDatePicker').value = today;
            loadInventoryHistory();
        }

        function setHistoryDateYesterday() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('historyDatePicker').value = yesterday.toISOString().split('T')[0];
            loadInventoryHistory();
        }

        function loadInventoryHistory() {
            const dateStr = document.getElementById('historyDatePicker').value;
            if (!dateStr) return;

            document.getElementById('historyDateLabel').textContent = dateStr;

            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„ÅÆË™≠„ÅøËæº„ÅøÈñ¢Êï∞
            const loadFromLocalStorage = () => {
                const saved = localStorage.getItem('inventoryHistory_' + dateStr);
                inventoryHistory = saved ? JSON.parse(saved) : [];
                console.log('üìÇ „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø:', dateStr, inventoryHistory.length + '‰ª∂');
                renderInventoryHistory();
            };

            // Firebase„Åã„ÇâÂ±•Ê≠¥„ÇíÂèñÂæó
            if (typeof database !== 'undefined' && isAuthReady) {
                database.ref('inventoryHistory/' + dateStr).once('value').then(snapshot => {
                    const data = snapshot.val();
                    if (data) {
                        // Firebase„Ç≠„Éº„Çí‰øùÊåÅ„Åó„Å¶ÈÖçÂàó„Å´Â§âÊèõ
                        inventoryHistory = Object.entries(data).map(([key, value]) => ({
                            ...value,
                            _firebaseKey: key
                        }));
                        console.log('‚òÅÔ∏è Firebase„Åã„ÇâÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø:', dateStr, inventoryHistory.length + '‰ª∂');
                    } else {
                        // Firebase„Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇíÁ¢∫Ë™ç
                        loadFromLocalStorage();
                        return;
                    }
                    renderInventoryHistory();
                }).catch(err => {
                    console.warn('Firebase„Åã„ÇâÂ±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„ÄÅ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Çí‰ΩøÁî®:', err.message);
                    // FirebaseÂ§±ÊïóÊôÇ„ÅØ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø
                    loadFromLocalStorage();
                });
            } else {
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂèñÂæó
                loadFromLocalStorage();
            }
        }

        function renderInventoryHistory() {
            const container = document.getElementById('historyListContainer');

            // „Çµ„Éû„É™„ÉºË®àÁÆó
            let totalDecrease = 0;
            let totalIncrease = 0;

            inventoryHistory.forEach(entry => {
                if (entry.type === 'decrease') {
                    totalDecrease += entry.quantity;
                } else if (entry.type === 'increase') {
                    totalIncrease += entry.quantity;
                }
            });

            document.getElementById('historyTotalDecrease').textContent = totalDecrease + ' ÁÇπ';
            document.getElementById('historyTotalIncrease').textContent = totalIncrease + ' ÁÇπ';
            document.getElementById('historyNetChange').textContent = (totalIncrease - totalDecrease) + ' ÁÇπ';

            // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
            const resetBtn = document.getElementById('resetDayButton');
            console.log('Â±•Ê≠¥‰ª∂Êï∞:', inventoryHistory.length, '„Éú„Çø„É≥Ë¶ÅÁ¥†:', resetBtn);
            if (resetBtn) {
                if (inventoryHistory.length > 0) {
                    resetBtn.style.cssText = 'padding: 12px 24px; background: #ff3b30; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; display: inline-block !important;';
                } else {
                    resetBtn.style.cssText = 'display: none !important;';
                }
            }

            if (inventoryHistory.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; padding: 40px 0;">„Åì„ÅÆÊó•„ÅÆÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            // ÊôØÂìÅ„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const groupedByPrize = {};
            inventoryHistory.forEach(entry => {
                if (!groupedByPrize[entry.prizeName]) {
                    groupedByPrize[entry.prizeName] = {
                        prizeName: entry.prizeName,
                        totalIncrease: 0,
                        totalDecrease: 0,
                        entries: []
                    };
                }
                groupedByPrize[entry.prizeName].entries.push(entry);
                if (entry.type === 'decrease') {
                    groupedByPrize[entry.prizeName].totalDecrease += entry.quantity;
                } else if (entry.type === 'increase') {
                    groupedByPrize[entry.prizeName].totalIncrease += entry.quantity;
                }
            });

            // Â§âÂãïÊï∞Èáè„ÅÆÂ§ö„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
            const sortedGroups = Object.values(groupedByPrize).sort((a, b) => {
                const aTotal = a.totalIncrease + a.totalDecrease;
                const bTotal = b.totalIncrease + b.totalDecrease;
                return bTotal - aTotal;
            });

            container.innerHTML = sortedGroups.map(group => {
                // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Åã„ÇâÁîªÂÉè„ÇíÂèñÂæóÔºàÊ≠£Ë¶èÂåñ„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ôºâ
                const masterItem = findPrizeByNormalizedName(group.prizeName);
                const imageUrl = masterItem?.image || masterItem?.imageUrl || '';
                const currentStock = masterItem ? (masterItem.stock ?? masterItem.count ?? 0) : '?';

                const netChange = group.totalIncrease - group.totalDecrease;
                const netColor = netChange > 0 ? 'var(--sf-green)' : netChange < 0 ? 'var(--sf-red)' : 'var(--sf-gray)';
                const netSign = netChange > 0 ? '+' : '';

                // Â±•Ê≠¥„ÅÆË©≥Á¥∞ÔºàÊôÇÈñìÈ†ÜÔºâ
                const sortedEntries = [...group.entries].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                const detailsHtml = sortedEntries.map((entry, idx) => {
                    const time = new Date(entry.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                    const isDecrease = entry.type === 'decrease';
                    const color = isDecrease ? 'var(--sf-red)' : 'var(--sf-green)';
                    const sign = isDecrease ? '-' : '+';
                    const entryId = (entry._firebaseKey || entry.timestamp || '').replace(/'/g, "\\'");
                    const escapedPrizeName = escapeHtml(entry.prizeName).replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    return `
                        <span style="display: inline-flex; align-items: center; margin-right: 8px; margin-bottom: 4px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 6px;">
                            <span style="color: ${color}; font-size: 11px;">${time} ${sign}${entry.quantity} (${entry.reason || ''})</span>
                            <button onclick="cancelSingleHistoryEntry('${entryId}', '${escapedPrizeName}', '${entry.type}', ${entry.quantity})"
                                style="margin-left: 6px; background: rgba(255,59,48,0.1); border: none; color: var(--sf-red); cursor: pointer; font-size: 10px; padding: 2px 6px; border-radius: 4px;"
                                title="„Åì„ÅÆÂ§âÂãï„ÇíÂèñ„ÇäÊ∂à„Åó">ÂèñÊ∂à</button>
                        </span>`;
                }).join('');

                return `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; margin-bottom: 8px; background: white; border-radius: 8px; border-left: 4px solid ${netColor};">
                        ${imageUrl ? `<img src="${imageUrl}" style="width: 50px; height: 50px; object-fit: contain; border-radius: 4px; background: #f5f5f5;" onerror="this.style.display='none'">` : '<div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 20px;">üì¶</div>'}
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(group.prizeName)}</div>
                            <div style="font-size: 12px; color: var(--sf-gray); margin-top: 2px;">
                                ÁèæÂú®Â∫´: ${currentStock}ÂÄã
                                ${group.totalDecrease > 0 ? `<span style="color: var(--sf-red); margin-left: 8px;">Âá∫Â∫´ -${group.totalDecrease}</span>` : ''}
                                ${group.totalIncrease > 0 ? `<span style="color: var(--sf-green); margin-left: 8px;">ÂÖ•Â∫´ +${group.totalIncrease}</span>` : ''}
                            </div>
                            <div style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">${detailsHtml}</div>
                        </div>
                        <div style="text-align: right; flex-shrink: 0;">
                            <div style="font-weight: 700; font-size: 18px; color: ${netColor};">${netSign}${netChange}</div>
                            <div style="font-size: 11px; color: var(--sf-gray);">${group.entries.length}‰ª∂</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // „Åì„ÅÆÊó•„ÅÆÂú®Â∫´Â§âÂãï„Çí„É™„Çª„ÉÉ„ÉàÔºàÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞‰ªò„ÅçÔºâ
        function confirmResetDayChanges() {
            const dateStr = document.getElementById('historyDatePicker').value;
            if (!dateStr || inventoryHistory.length === 0) {
                alert('„É™„Çª„ÉÉ„Éà„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            // Â§âÂãïÂÜÖÂÆπ„Çí„Åæ„Å®„ÇÅ„Çã
            const changes = {};
            inventoryHistory.forEach(entry => {
                if (!changes[entry.prizeName]) {
                    changes[entry.prizeName] = { increase: 0, decrease: 0 };
                }
                if (entry.type === 'decrease') {
                    changes[entry.prizeName].decrease += entry.quantity;
                } else if (entry.type === 'increase') {
                    changes[entry.prizeName].increase += entry.quantity;
                }
            });

            // Á¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàê
            let message = `${dateStr} „ÅÆÂú®Â∫´Â§âÂãï„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\n\n`;
            message += '„Äê„É™„Çª„ÉÉ„ÉàÂÜÖÂÆπ„Äë\n';

            Object.entries(changes).forEach(([name, data]) => {
                const net = data.increase - data.decrease;
                if (net !== 0) {
                    // ÈÄÜ„Å´„Åô„ÇãÔºöÊ∏õ„Å£„ÅüÂàÜ„ÅØÊàª„Åô„ÄÅÂ¢ó„Åà„ÅüÂàÜ„ÅØÊ∏õ„Çâ„Åô
                    const action = net > 0 ? `${net}ÂÄã Ê∏õÂ∞ë` : `${Math.abs(net)}ÂÄã Â¢óÂä†`;
                    message += `„Éª${name}: ${action}\n`;
                }
            });

            message += '\n‚Äª„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì';

            if (confirm(message)) {
                resetDayInventoryChanges(dateStr, changes);
            }
        }

        // Âú®Â∫´Â§âÂãï„Çí„É™„Çª„ÉÉ„ÉàÂÆüË°å
        function resetDayInventoryChanges(dateStr, changes) {
            let resetCount = 0;
            const resetEntries = [];

            // Âú®Â∫´„ÇíÈÄÜÊñπÂêë„Å´Ë™øÊï¥
            Object.entries(changes).forEach(([prizeName, data]) => {
                const net = data.increase - data.decrease;
                if (net === 0) return;

                // Ê≠£Ë¶èÂåñ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅßÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÊ§úÁ¥¢
                const prize = findPrizeByNormalizedName(prizeName);
                if (prize) {
                    const stockKey = 'stock' in prize ? 'stock' : 'count';
                    const oldStock = prize[stockKey] ?? 0;

                    // ÈÄÜÊñπÂêë„Å´Ë™øÊï¥ÔºàÂ¢ó„Åà„ÅüÂàÜ„ÅØÊ∏õ„Çâ„Åô„ÄÅÊ∏õ„Å£„ÅüÂàÜ„ÅØÊàª„ÅôÔºâ
                    const newStock = Math.max(0, oldStock - net);
                    prize[stockKey] = newStock;
                    resetCount++;

                    resetEntries.push({
                        type: net > 0 ? 'decrease' : 'increase',
                        prizeName: prizeName,
                        quantity: Math.abs(net),
                        oldStock: oldStock,
                        newStock: newStock,
                        reason: `${dateStr}„ÅÆ„É™„Çª„ÉÉ„Éà`,
                        timestamp: new Date().toISOString()
                    });
                }
            });

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Çí‰øùÂ≠ò
            savePrizeMaster();
            updatePrizeMasterList();

            // Â±•Ê≠¥„ÇíÂâäÈô§ÔºàFirebase„Å®„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏Ôºâ
            clearDayHistory(dateStr);

            // „É™„Çª„ÉÉ„ÉàÊìç‰ΩúËá™‰Ωì„ÅØÂ±•Ê≠¥„Å´ÊÆã„Åï„Å™„ÅÑÔºà„É¶„Éº„Ç∂„Éº„ÅåÊ∑∑‰π±„Åô„Çã„Åü„ÇÅÔºâ
            // ‰ª£„Çè„Çä„Å´„Ç≥„É≥„ÇΩ„Éº„É´„Å´„É≠„Ç∞„ÇíÂá∫Âäõ
            if (resetEntries.length > 0) {
                console.log('üîÑ „É™„Çª„ÉÉ„ÉàÊìç‰Ωú:', resetEntries);
            }

            // Ë°®Á§∫„Çí„É™„Éï„É¨„ÉÉ„Ç∑„É•
            inventoryHistory = [];
            renderInventoryHistory();

            // Âú®Â∫´Ê∏õÂ∞ë„Çø„Éñ„ÅÆÊú™Áô∫ÈÄÅ„É™„Çπ„Éà„ÇÇÊõ¥Êñ∞ÔºàÂú®Â∫´Áä∂Ê≥Å„ÅåÂ§â„Çè„Çã„Åü„ÇÅÔºâ
            renderPendingOrdersOnly();

            alert(`${dateStr} „ÅÆÂú®Â∫´Â§âÂãï„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü\n${resetCount}‰ª∂„ÅÆÊôØÂìÅ„ÅÆÂú®Â∫´„ÇíË™øÊï¥„Åó„Åæ„Åó„Åü`);
        }

        // ÊåáÂÆöÊó•„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§
        function clearDayHistory(dateStr) {
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂâäÈô§
            localStorage.removeItem('inventoryHistory_' + dateStr);

            // Firebase„Åã„ÇâÂâäÈô§
            if (typeof database !== 'undefined' && isAuthReady) {
                database.ref('inventoryHistory/' + dateStr).remove().then(() => {
                    console.log('üóëÔ∏è Â±•Ê≠¥„ÇíÂâäÈô§:', dateStr);
                }).catch(err => {
                    console.error('Â±•Ê≠¥„ÅÆÂâäÈô§„Å´Â§±Êïó:', err);
                });
            }
        }

        // ÂÄãÂà•„ÅÆÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíÂèñ„ÇäÊ∂à„Åó
        function cancelSingleHistoryEntry(entryId, prizeName, type, quantity) {
            if (!confirm(`„Åì„ÅÆÂ§âÂãï„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºü\n\n${prizeName}\n${type === 'decrease' ? 'Âá∫Â∫´' : 'ÂÖ•Â∫´'}: ${quantity}ÂÄã\n\n‚ÄªÂú®Â∫´„Åå${type === 'decrease' ? 'Â¢óÂä†' : 'Ê∏õÂ∞ë'}„Åó„Åæ„Åô`)) {
                return;
            }

            const dateStr = document.getElementById('historyDatePicker').value;

            // ÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÅÆÂú®Â∫´„ÇíÈÄÜÊñπÂêë„Å´Ë™øÊï¥
            const prize = findPrizeByNormalizedName(prizeName);
            if (prize) {
                const stockKey = 'stock' in prize ? 'stock' : 'count';
                const oldStock = prize[stockKey] ?? 0;

                if (type === 'decrease') {
                    // Âá∫Â∫´„ÇíÂèñ„ÇäÊ∂à„Åó ‚Üí Âú®Â∫´„ÇíÂ¢ó„ÇÑ„Åô
                    prize[stockKey] = oldStock + quantity;
                } else {
                    // ÂÖ•Â∫´„ÇíÂèñ„ÇäÊ∂à„Åó ‚Üí Âú®Â∫´„ÇíÊ∏õ„Çâ„Åô
                    prize[stockKey] = Math.max(0, oldStock - quantity);
                }

                savePrizeMaster();
                updatePrizeMasterList();
                console.log(`üîÑ Âú®Â∫´Ë™øÊï¥: ${prizeName} ${oldStock} ‚Üí ${prize[stockKey]}`);
            }

            // Firebase„Åã„ÇâË©≤ÂΩì„Ç®„É≥„Éà„É™„ÇíÂâäÈô§
            if (typeof database !== 'undefined' && isAuthReady && entryId && !entryId.includes('T')) {
                // entryId„ÅåFirebase„Ç≠„Éº„ÅÆÂ†¥ÂêàÔºà„Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÂΩ¢Âºè„Åß„Å™„ÅÑÂ†¥ÂêàÔºâ
                database.ref('inventoryHistory/' + dateStr + '/' + entryId).remove().then(() => {
                    console.log('üóëÔ∏è Â±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíÂâäÈô§:', entryId);
                }).catch(err => {
                    console.error('Â±•Ê≠¥„Ç®„É≥„Éà„É™„ÅÆÂâäÈô§„Å´Â§±Êïó:', err);
                });
            }

            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„ÇÇÂâäÈô§
            const localKey = 'inventoryHistory_' + dateStr;
            const localHistory = JSON.parse(localStorage.getItem(localKey) || '[]');
            const updatedLocalHistory = localHistory.filter(entry => {
                // timestamp„Åæ„Åü„ÅØ_firebaseKey„Åß‰∏ÄËá¥„Åô„Çã„ÇÇ„ÅÆ„ÇíÈô§Â§ñ
                return entry.timestamp !== entryId && entry._firebaseKey !== entryId;
            });
            localStorage.setItem(localKey, JSON.stringify(updatedLocalHistory));

            // „É°„É¢„É™‰∏ä„ÅÆÂ±•Ê≠¥„Åã„Çâ„ÇÇÂâäÈô§
            inventoryHistory = inventoryHistory.filter(entry => {
                return entry.timestamp !== entryId && entry._firebaseKey !== entryId;
            });

            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            renderInventoryHistory();

            // Âú®Â∫´Ê∏õÂ∞ë„Çø„Éñ„ÅÆÊú™Áô∫ÈÄÅ„É™„Çπ„Éà„ÇÇÊõ¥Êñ∞ÔºàÂú®Â∫´Áä∂Ê≥Å„ÅåÂ§â„Çè„Çã„Åü„ÇÅÔºâ
            renderPendingOrdersOnly();

            alert(`Â§âÂãï„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü\n${prizeName}: ${type === 'decrease' ? '+' : '-'}${quantity}ÂÄã`);
        }

        function saveInventoryHistoryEntries(entries) {
            if (entries.length === 0) return;

            const dateStr = new Date().toISOString().split('T')[0];

            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´„ÇÇ‰øùÂ≠òÔºà„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºâ
            const key = 'inventoryHistory_' + dateStr;
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            localStorage.setItem(key, JSON.stringify([...existing, ...entries]));

            // Firebase„Å´‰øùÂ≠òÔºàË™çË®ºÂæÖ„Å°ÂØæÂøúÔºâ
            const saveToCloud = () => {
                entries.forEach(entry => {
                    database.ref('inventoryHistory/' + dateStr).push(entry);
                });
                console.log('üì§ Â±•Ê≠¥„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò:', entries.length + '‰ª∂');
            };

            if (typeof database !== 'undefined' && isAuthReady) {
                saveToCloud();
            } else {
                waitForAuth(saveToCloud);
            }
        }

        // ========== Áô∫ÈÄÅÂæÖ„Å°„É™„Çπ„Éà„ÅÆ„ÇØ„É©„Ç¶„ÉâÁÆ°ÁêÜ ==========

        function savePendingOrdersToCloud() {
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠òÔºà„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºâ
            localStorage.setItem('pendingShipments', JSON.stringify(pendingOrders));
            console.log('üì§ Áô∫ÈÄÅÂæÖ„Å°„É™„Çπ„Éà„Çí„É≠„Éº„Ç´„É´„Å´‰øùÂ≠ò:', pendingOrders.length + '‰ª∂');

            // Firebase„Å´‰øùÂ≠òÔºàË™çË®ºÂæÖ„Å°ÂØæÂøúÔºâ
            const saveToFirebase = () => {
                if (typeof database === 'undefined') {
                    console.warn('‚ö†Ô∏è Firebase„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºàlocalStorage„ÅÆ„Åø‰øùÂ≠òÔºâ');
                    return;
                }

                const data = {
                    orders: pendingOrders,
                    updatedAt: Date.now()
                };

                database.ref('pendingShipments').set(data).then(() => {
                    console.log('‚úÖ Áô∫ÈÄÅÂæÖ„Å°„É™„Çπ„Éà„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', pendingOrders.length + '‰ª∂');
                }).catch((error) => {
                    console.error('‚ùå Áô∫ÈÄÅÂæÖ„Å°„É™„Çπ„Éà„ÅÆ„ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„Å´Â§±Êïó:', error.code || error.message);
                });
            };

            if (typeof database !== 'undefined' && isAuthReady) {
                saveToFirebase();
            } else {
                waitForAuth(saveToFirebase);
            }
        }

        function loadPendingOrdersFromCloud() {
            // Firebase„Åã„ÇâË™≠„ÅøËæº„ÅøÔºàË™çË®ºÂæÖ„Å°ÂØæÂøúÔºâ
            const loadFromFirebase = () => {
                if (typeof database === 'undefined') {
                    console.warn('‚ö†Ô∏è Firebase„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºàlocalStorage„Åã„ÇâË™≠ËæºÔºâ');
                    loadFromLocalStorage();
                    return;
                }

                database.ref('pendingShipments').once('value').then(snapshot => {
                    const data = snapshot.val();
                    if (data && Array.isArray(data.orders)) {
                        pendingOrders = data.orders;
                        renderPendingOrdersOnly();
                        renderNeedRestockList();
                        console.log('‚òÅÔ∏è Áô∫ÈÄÅÂæÖ„Å°„É™„Çπ„Éà„Çí„ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠Ëæº:', pendingOrders.length + '‰ª∂');

                        // localStorage„Å´„ÇÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
                        localStorage.setItem('pendingShipments', JSON.stringify(pendingOrders));

                        // Êó¢Â≠ò„Éá„Éº„Çø„Å´Á¥ê‰ªò„Åë„Åå„Å™„ÅÑÂ†¥Âêà„ÅØËá™ÂãïÁ¥ê‰ªò„Åë
                        setTimeout(() => autoLinkMasterIds(), 500);
                    } else {
                        // Firebase„Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø
                        loadFromLocalStorage();
                    }
                }).catch((error) => {
                    console.error('‚ùå Áô∫ÈÄÅÂæÖ„Å°„É™„Çπ„Éà„ÅÆ„ÇØ„É©„Ç¶„ÉâË™≠Ëæº„Å´Â§±Êïó:', error);
                    loadFromLocalStorage();
                });
            };

            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„ÇÄÈñ¢Êï∞
            const loadFromLocalStorage = () => {
                const localData = localStorage.getItem('pendingShipments');
                if (localData) {
                    try {
                        const data = JSON.parse(localData);
                        if (Array.isArray(data)) {
                            pendingOrders = data;
                            renderPendingOrdersOnly();
                            renderNeedRestockList();
                            console.log('üì• Áô∫ÈÄÅÂæÖ„Å°„É™„Çπ„Éà„Çí„É≠„Éº„Ç´„É´„Åã„ÇâË™≠Ëæº:', pendingOrders.length + '‰ª∂');

                            // Êó¢Â≠ò„Éá„Éº„Çø„Å´Á¥ê‰ªò„Åë„Åå„Å™„ÅÑÂ†¥Âêà„ÅØËá™ÂãïÁ¥ê‰ªò„Åë
                            setTimeout(() => autoLinkMasterIds(), 500);
                        }
                    } catch (e) {
                        console.error('Áô∫ÈÄÅÂæÖ„Å°„É™„Çπ„Éà„ÅÆËß£Êûê„Å´Â§±Êïó:', e);
                    }
                }
            };

            if (typeof database !== 'undefined' && isAuthReady) {
                loadFromFirebase();
            } else {
                waitForAuth(loadFromFirebase);
            }
        }

        // ========== Áô∫ÈÄÅÊ∏à„ÅøID„ÅÆÁÆ°ÁêÜÔºàÈáçË§áÁô∫ÈÄÅÈò≤Ê≠¢Ôºâ ==========

        function saveShippedOrderIds() {
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠òÔºà„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºâ
            localStorage.setItem('shippedOrderIds', JSON.stringify([...shippedOrderIds]));
            console.log('üì§ Áô∫ÈÄÅÊ∏à„ÅøID„Çí„É≠„Éº„Ç´„É´„Å´‰øùÂ≠ò:', shippedOrderIds.size + '‰ª∂');

            // Firebase„Å´‰øùÂ≠òÔºàË™çË®ºÂæÖ„Å°ÂØæÂøúÔºâ
            const saveToFirebase = () => {
                if (typeof database === 'undefined') {
                    console.warn('‚ö†Ô∏è Firebase„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºàlocalStorage„ÅÆ„Åø‰øùÂ≠òÔºâ');
                    return;
                }

                const data = {
                    ids: [...shippedOrderIds],
                    updatedAt: Date.now()
                };

                database.ref('shippedOrderIds').set(data).then(() => {
                    console.log('‚úÖ Áô∫ÈÄÅÊ∏à„ÅøID„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', shippedOrderIds.size + '‰ª∂');
                }).catch((error) => {
                    console.error('‚ùå Áô∫ÈÄÅÊ∏à„ÅøID„ÅÆ„ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò„Å´Â§±Êïó:', error.code || error.message);
                });
            };

            if (typeof database !== 'undefined' && isAuthReady) {
                saveToFirebase();
            } else {
                waitForAuth(saveToFirebase);
            }
        }

        function loadShippedOrderIds() {
            // Firebase„Åã„ÇâË™≠„ÅøËæº„ÅøÔºàË™çË®ºÂæÖ„Å°ÂØæÂøúÔºâ
            const loadFromFirebase = () => {
                if (typeof database === 'undefined') {
                    console.warn('‚ö†Ô∏è Firebase„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºàlocalStorage„Åã„ÇâË™≠ËæºÔºâ');
                    loadFromLocalStorage();
                    return;
                }

                database.ref('shippedOrderIds').once('value').then(snapshot => {
                    const data = snapshot.val();
                    if (data && Array.isArray(data.ids)) {
                        shippedOrderIds = new Set(data.ids.map(id => String(id)));
                        console.log('‚òÅÔ∏è Áô∫ÈÄÅÊ∏à„ÅøID„Çí„ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠Ëæº:', shippedOrderIds.size + '‰ª∂');

                        // localStorage„Å´„ÇÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
                        localStorage.setItem('shippedOrderIds', JSON.stringify([...shippedOrderIds]));
                    } else {
                        // Firebase„Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø
                        loadFromLocalStorage();
                    }
                }).catch((error) => {
                    console.error('‚ùå Áô∫ÈÄÅÊ∏à„ÅøID„ÅÆ„ÇØ„É©„Ç¶„ÉâË™≠Ëæº„Å´Â§±Êïó:', error);
                    loadFromLocalStorage();
                });
            };

            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„ÇÄÈñ¢Êï∞
            const loadFromLocalStorage = () => {
                const localData = localStorage.getItem('shippedOrderIds');
                if (localData) {
                    try {
                        const ids = JSON.parse(localData);
                        if (Array.isArray(ids)) {
                            shippedOrderIds = new Set(ids.map(id => String(id)));
                            console.log('üì• Áô∫ÈÄÅÊ∏à„ÅøID„Çí„É≠„Éº„Ç´„É´„Åã„ÇâË™≠Ëæº:', shippedOrderIds.size + '‰ª∂');
                        }
                    } catch (e) {
                        console.error('Áô∫ÈÄÅÊ∏à„ÅøID„ÅÆËß£Êûê„Å´Â§±Êïó:', e);
                    }
                }
            };

            if (typeof database !== 'undefined' && isAuthReady) {
                loadFromFirebase();
            } else {
                waitForAuth(loadFromFirebase);
            }
        }

        // Áô∫ÈÄÅÊ∏à„ÅøID„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function isAlreadyShipped(orderId) {
            return shippedOrderIds.has(String(orderId));
        }

        // Áô∫ÈÄÅÊ∏à„ÅøID„ÇíË®òÈå≤
        function recordShippedOrderId(orderId) {
            shippedOrderIds.add(String(orderId));
            saveShippedOrderIds();
        }

        function renderPendingOrdersOnly() {
            // IDÂà•„Ç∞„É´„Éº„ÉóË°®Á§∫„Çí‰ΩøÁî®
            renderPendingOrdersById(pendingOrders);
        }

        // Áô∫ÈÄÅÂæÖ„Å°„ÇíÁô∫ÈÄÅÊ∏à„Åø„Å´Â§âÊõ¥Ôºà„ÇØ„É©„Ç¶„ÉâÂØæÂøúÔºâ
        function markPendingAsShipped(idx) {
            if (!pendingOrders[idx]) return;

            const item = pendingOrders[idx];

            // masterId„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞Ê≠£Ë¶èÂåñ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅßÊôØÂìÅ„Éû„Çπ„Çø„Éº„ÇíÊ§úÁ¥¢
            let masterItem = null;
            if (item.masterId) {
                masterItem = prizeMaster.find(p => p.id === item.masterId);
                if (masterItem) {
                    console.log(`‚úÖ masterId ${item.masterId} „ÅßÊôØÂìÅ„ÇíÁâπÂÆö: ${masterItem.name}`);
                }
            }
            if (!masterItem) {
                masterItem = findPrizeByNormalizedName(item.prizeName);
                if (masterItem) {
                    console.log(`üìù ÊôØÂìÅÂêç„Éû„ÉÉ„ÉÅ„É≥„Ç∞: ${item.prizeName} ‚Üí ${masterItem.name} (ID: ${masterItem.id})`);
                    // Á¥ê‰ªò„Åë„Çí‰øùÂ≠òÔºàÊ¨°Âõû„ÅÆ„Åü„ÇÅ„Å´Ôºâ
                    item.masterId = masterItem.id;
                }
            }

            if (masterItem) {
                // stock „Åæ„Åü„ÅØ count „Éó„É≠„Éë„ÉÜ„Ç£„ÇíÊ§úÂá∫
                const stockKey = 'stock' in masterItem ? 'stock' : 'count';
                const oldStock = masterItem[stockKey] ?? 0;
                const newStock = Math.max(0, oldStock - item.quantity);
                masterItem[stockKey] = newStock;

                // Â±•Ê≠¥„Å´ËøΩÂä†
                saveInventoryHistoryEntries([{
                    type: 'decrease',
                    prizeName: masterItem.name,
                    quantity: item.quantity,
                    oldStock: oldStock,
                    newStock: newStock,
                    reason: 'Áô∫ÈÄÅÔºàÁô∫ÈÄÅÂæÖ„Å°„Åã„ÇâÔºâ',
                    timestamp: new Date().toISOString()
                }]);

                savePrizeMaster();
                updatePrizeMasterList();

                alert(`${item.prizeName} „ÇíÁô∫ÈÄÅÊ∏à„Åø„Å´„Åó„Åæ„Åó„Åü\nÂú®Â∫´: ${oldStock} ‚Üí ${newStock}`);
            } else {
                alert('ÊôØÂìÅ„Éû„Çπ„Çø„Éº„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÂú®Â∫´„ÅØÂ§âÊõ¥„Åï„Çå„Åæ„Åõ„Çì');
            }

            // Áô∫ÈÄÅÊ∏à„ÅøID„ÇíË®òÈå≤ÔºàÈáçË§áÂá¶ÁêÜÈò≤Ê≠¢Ôºâ
            if (item.orderId) {
                shippedOrderIds.add(String(item.orderId));
                saveShippedOrderIds();
                console.log(`üìã Áô∫ÈÄÅÊ∏à„ÅøID„ÇíË®òÈå≤: ${item.orderId}`);
            }

            // „É™„Çπ„Éà„Åã„ÇâÂâäÈô§
            pendingOrders.splice(idx, 1);
            savePendingOrdersToCloud();
            renderPendingOrdersOnly();
        }

        // Áô∫ÈÄÅÂæÖ„Å°„ÇíÂâäÈô§
        function removePendingOrder(idx) {
            if (!pendingOrders[idx]) return;

            if (confirm(`„Äå${pendingOrders[idx].prizeName}„Äç„ÇíÁô∫ÈÄÅÂæÖ„Å°„É™„Çπ„Éà„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n‚ÄªÂú®Â∫´„ÅØÂ§âÊõ¥„Åï„Çå„Åæ„Åõ„Çì`)) {
                pendingOrders.splice(idx, 1);
                savePendingOrdersToCloud();
                renderPendingOrdersOnly();
            }
        }

        // Âú®Â∫´Ë™øÊï¥„Éá„Éº„Çø„ÅÆÂàùÊúüË™≠„ÅøËæº„Åø
        function loadInventoryAdjustmentData() {
            loadPendingOrdersFromCloud();
            loadShippedOrderIds();
        }

        // Êó¢Â≠ò„ÅÆpendingOrders„Å´ÂØæ„Åó„Å¶masterId„ÇíËá™ÂãïÁ¥ê‰ªò„Åë
        function autoLinkMasterIds() {
            let updated = false;
            pendingOrders.forEach(item => {
                if (!item.masterId) {
                    const masterItem = findPrizeByNormalizedName(item.prizeName);
                    if (masterItem) {
                        item.masterId = masterItem.id;
                        console.log(`üîó Êó¢Â≠ò„Éá„Éº„Çø„Å´Á¥ê‰ªò„ÅëËøΩÂä†: ${item.prizeName} ‚Üí ${masterItem.id}`);
                        updated = true;
                    }
                }
            });

            if (updated) {
                savePendingOrdersToCloud();
                console.log('‚úÖ Êó¢Â≠ò„Éá„Éº„Çø„ÅÆÁ¥ê‰ªò„Åë„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            }
        }

        // HTML„Ç®„Çπ„Ç±„Éº„Éó
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebase„ÅÆË®≠ÂÆöÔºà„Åì„Åì„Å´ÂèñÂæó„Åó„ÅüË®≠ÂÆö„ÇíË≤º„Çä‰ªò„ÅëÔºâ
const firebaseConfig = {
  apiKey: "AIzaSyAe9gDljx8sz-amXm_BWyPJgskR_V1S3Oo",
  authDomain: "oripa-simulator.firebaseapp.com",
  databaseURL: "https://oripa-simulator-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "oripa-simulator",
  storageBucket: "oripa-simulator.firebasestorage.app",
  messagingSenderId: "546810114337",
  appId: "1:546810114337:web:14a0657fd25998bef50e60"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// ÂåøÂêçË™çË®º„Åß„Çµ„Ç§„É≥„Ç§„É≥
let isAuthReady = false;
let authCallbacks = []; // Ë™çË®ºÂÆå‰∫ÜÂæå„Å´ÂÆüË°å„Åô„Çã„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
let authInitialized = false; // ÂàùÊúüÂåñÊ∏à„Åø„Éï„É©„Ç∞

// FirebaseÊé•Á∂öÁä∂ÊÖã„ÅÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊõ¥Êñ∞Ôºà„Çπ„Çø„ÉñÈñ¢Êï∞Ôºâ
function updateFirebaseStatusIndicator() {
    // ÁèæÂú®„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÂ∞ÜÊù•ÁöÑ„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº„Å™„Å©„Å´Ë°®Á§∫ÂèØËÉΩÔºâ
    console.log('FirebaseË™çË®ºÁä∂ÊÖã:', isAuthReady ? 'Ë™çË®ºÊ∏à„Åø' : 'Êú™Ë™çË®º');
}

// Ë™çË®ºÁä∂ÊÖã„ÅÆÂ§âÂåñ„ÇíÁõ£Ë¶ñ
auth.onAuthStateChanged((user) => {
    if (user) {
        console.log('üîê Ë™çË®ºÁä∂ÊÖãÂ§âÂåñ: „É≠„Ç∞„Ç§„É≥‰∏≠', user.uid);
        if (!isAuthReady) {
            isAuthReady = true;

            // DOM„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„Åã„ÇâÂÆüË°å
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    updateFirebaseStatusIndicator();
                });
            } else {
                updateFirebaseStatusIndicator();
            }

            // „Åô„Åπ„Å¶„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂÆüË°å
            authCallbacks.forEach(item => {
                clearTimeout(item.timeoutId);
                item.callback();
            });
            authCallbacks = [];
        }
    } else {
        console.log('üîê Ë™çË®ºÁä∂ÊÖãÂ§âÂåñ: „É≠„Ç∞„Ç¢„Ç¶„Éà');
        isAuthReady = false;

        // DOM„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„Åã„ÇâÂÆüË°å
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                updateFirebaseStatusIndicator();
            });
        } else {
            updateFirebaseStatusIndicator();
        }
    }
});

// Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§Èñ¢Êï∞
function waitForAuth(callback, timeoutMs = 60000) {
    if (isAuthReady) {
        callback();
        return;
    }

    const timeoutId = setTimeout(() => {
        console.error('‚ö†Ô∏è FirebaseË™çË®º„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„ÅüÔºà60ÁßíÔºâ');
        console.error('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        updateSyncStatus('‚ö†Ô∏è Ë™çË®º„Çø„Ç§„É†„Ç¢„Ç¶„Éà - „Äå‰ªä„Åô„ÅêÂêåÊúü„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

        // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„ÅüÂ†¥Âêà„ÇÇ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂÆüË°åÔºàlocalStorage„Çí‰ΩøÁî®Ôºâ
        console.log('‚ö†Ô∏è localStorage„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®„Åó„Åæ„Åô');

        // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„É™„Çπ„Éà„Åã„ÇâÂâäÈô§
        const index = authCallbacks.findIndex(item => item.timeoutId === timeoutId);
        if (index >= 0) {
            authCallbacks.splice(index, 1);
        }
    }, timeoutMs);

    authCallbacks.push({
        callback: callback,
        timeoutId: timeoutId
    });
}

// Ë™çË®º„ÇíÂÆüË°å
function initializeAuth() {
    if (authInitialized) {
        console.log('‚ö†Ô∏è Ë™çË®º„ÅØÊó¢„Å´ÂàùÊúüÂåñÊ∏à„Åø„Åß„Åô');
        return;
    }
    authInitialized = true;

    // Êó¢„Å´Ë™çË®ºÊ∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàonAuthStateChanged„ÅßÂá¶ÁêÜ„Åï„Çå„ÇãÔºâ
    if (auth.currentUser) {
        console.log('‚úÖ Êó¢„Å´FirebaseË™çË®ºÊ∏à„Åø„Åß„Åô');
        // onAuthStateChanged„ÅßÂá¶ÁêÜ„Åï„Çå„Çã„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        loadPrizeMasterFromCloudOnce();
        return;
    }

    console.log('üîê FirebaseÂåøÂêçË™çË®º„ÇíÈñãÂßã„Åó„Åæ„Åô...');
    updateSyncStatus('üîÑ Ë™çË®º‰∏≠... (0%)');

    auth.signInAnonymously()
        .then(() => {
            console.log('‚úÖ FirebaseÂåøÂêçË™çË®º„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü');
            updateSyncStatus('üîÑ ÂàùÊúüÂåñ‰∏≠... (50%)');
            // isAuthReady„ÅÆË®≠ÂÆö„Å®„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å„ÅØonAuthStateChanged„ÅßÂá¶ÁêÜ„Åï„Çå„Çã

            // Ë™çË®ºÂÆå‰∫ÜÂæå„Å´„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ
            loadPrizeMasterFromCloudOnce();
        })
        .catch((error) => {
            console.error('‚ùå FirebaseË™çË®º„Ç®„É©„Éº:', error);
            console.error('„Ç®„É©„Éº„Ç≥„Éº„Éâ:', error.code);
            console.error('„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏:', error.message);

            // „É¶„Éº„Ç∂„Éº„Å´„Çè„Åã„Çä„ÇÑ„Åô„ÅÑ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
            let userMessage = '‚ùå Ë™çË®ºÂ§±Êïó';
            if (error.code === 'auth/admin-restricted-operation') {
                userMessage = '‚ùå ÂåøÂêçË™çË®º„ÅåÁÑ°Âäπ„Åß„Åô';
                console.error('‚ö†Ô∏è Firebase Console„ÅßÂåøÂêçË™çË®º„ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                console.error('ÊâãÈ†Ü: Authentication > Sign-in method > ÂåøÂêç „ÇíÊúâÂäπÂåñ');
                showNotification('‚ùå ÂåøÂêçË™çË®º„ÅåÁÑ°Âäπ„Åß„Åô\nFirebase Console„ÅßÂåøÂêçË™çË®º„ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
            } else {
                showNotification(`‚ùå Ë™çË®º„Ç®„É©„Éº: ${error.message}`, 'error');
            }
            updateSyncStatus(userMessage);
            updateFirebaseStatusIndicator(); // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞

            // „Åô„Åπ„Å¶„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„Çí„ÇØ„É™„Ç¢
            authCallbacks.forEach(item => {
                clearTimeout(item.timeoutId);
            });
            authCallbacks = [];

            // localStorage„Åã„ÇâË™≠„ÅøËæº„Åø„ÇíË©¶„Åø„Çã
            loadPrizeMaster();
        });
}

// ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
function getCurrentConfig() {
  const minGuaranteeValue = document.getElementById('minGuaranteeValue')?.value;
  const enableMinGuaranteeAuto = document.getElementById('enableMinGuaranteeAuto')?.checked || false;
  const memoValue = document.getElementById('configMemo')?.value || '';

  console.log('üí∞ ÊúÄ‰Ωé‰øùË®º‰æ°ÂÄ§„ÇíÂèñÂæó:', minGuaranteeValue);
  console.log('‚úÖ ÊúÄ‰Ωé‰øùË®ºËá™Âãï‰ΩµÁî®„ÇíÂèñÂæó:', enableMinGuaranteeAuto);
  console.log('üìù „É°„É¢„ÇíÂèñÂæó:', memoValue);

  const config = {
    packPrice: document.getElementById('packPrice').value,
    totalPacks: document.getElementById('totalPacks').value,
    minGuaranteeValue: minGuaranteeValue,
    enableMinGuaranteeAuto: enableMinGuaranteeAuto,
    memo: memoValue,
    prizes: [...prizes],
    losses: [...losses]
  };

  console.log('üíæ ‰øùÂ≠ò„Åô„ÇãË®≠ÂÆö:', config);
  return config;
}

// Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄÈñ¢Êï∞
function loadConfig(config) {
  console.log('üì• loadConfig ÈñãÂßã:', config);

  document.getElementById('packPrice').value = config.packPrice || '40000';
  document.getElementById('totalPacks').value = config.totalPacks || '100';

  // ÊúÄ‰Ωé‰øùË®º‰æ°ÂÄ§„ÇíÂæ©ÂÖÉ
  const minGuaranteeValue = config.minGuaranteeValue || '1';
  document.getElementById('minGuaranteeValue').value = minGuaranteeValue;
  console.log('üí∞ ÊúÄ‰Ωé‰øùË®º‰æ°ÂÄ§„ÇíÂæ©ÂÖÉ:', minGuaranteeValue);

  // „É°„É¢„ÇíÂæ©ÂÖÉ
  if (document.getElementById('configMemo')) {
    const memoValue = config.memo || '';
    document.getElementById('configMemo').value = memoValue;
    console.log('üìù „É°„É¢„ÇíÂæ©ÂÖÉ:', memoValue);
  }

  // ÊúÄ‰Ωé‰øùË®ºËá™Âãï‰ΩµÁî®„ÇíÂæ©ÂÖÉ
  if (document.getElementById('enableMinGuaranteeAuto')) {
    const enableMinGuaranteeAuto = config.enableMinGuaranteeAuto || false;
    document.getElementById('enableMinGuaranteeAuto').checked = enableMinGuaranteeAuto;
    console.log('‚úÖ ÊúÄ‰Ωé‰øùË®ºËá™Âãï‰ΩµÁî®„ÇíÂæ©ÂÖÉ:', enableMinGuaranteeAuto);
  }

  if (config.prizes) {
    prizes = [...config.prizes];
  } else {
    prizes = [];
  }
  updatePrizeList();

  if (config.losses) {
    losses = [...config.losses];
  } else {
    losses = [];
  }
  updateLossList();

  updateTotalValue();
}

// „ÇØ„É©„Ç¶„Éâ‰øùÂ≠òÊ©üËÉΩ
function saveToCloud(configName) {
  // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
  if (!isAuthReady) {
    alert('‚è≥ FirebaseË™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...');
    waitForAuth(() => saveToCloud(configName));
    return;
  }

  const config = getCurrentConfig();
  const configId = configName || prompt('Ë®≠ÂÆöÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
  if (!configId) return;

  database.ref('configs/' + configId).set({
    data: config,
    updatedAt: Date.now()
  }).then(() => {
    alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü: ' + configId);
    loadConfigList();
  }).catch((error) => {
    alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// „ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠„ÅøËæº„Åø
function loadFromCloud(configId) {
  // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
  if (!isAuthReady) {
    alert('‚è≥ FirebaseË™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...');
    waitForAuth(() => loadFromCloud(configId));
    return;
  }

  database.ref('configs/' + configId).once('value').then((snapshot) => {
    const data = snapshot.val();
    if (data) {
      loadConfig(data.data);
      alert('Ë™≠„ÅøËæº„Åø„Åæ„Åó„Åü: ' + configId);
    } else {
      alert('Ë®≠ÂÆö„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
    }
  }).catch((error) => {
    alert('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Åß„ÇØ„É©„Ç¶„ÉâË®≠ÂÆö„ÇíÁÆ°ÁêÜ
let cloudConfigs = {};
let currentCloudConfigId = null;

// Ë®≠ÂÆö‰∏ÄË¶ßË°®Á§∫
function loadConfigList() {
  // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
  if (!isAuthReady) {
    console.log('‚è≥ FirebaseË™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...');
    waitForAuth(() => loadConfigList());
    return;
  }

  database.ref('configs').once('value').then((snapshot) => {
    const configs = snapshot.val();
    console.log('‰øùÂ≠òÊ∏à„ÅøË®≠ÂÆö:', Object.keys(configs || {}));
    // ÂøÖË¶Å„Å´Âøú„Åò„Å¶UIË°®Á§∫
  }).catch((error) => {
    console.warn('Ë®≠ÂÆö‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error.message);
  });
}

// „ÇØ„É©„Ç¶„ÉâË®≠ÂÆö‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
function refreshCloudConfigList() {
  // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
  if (!isAuthReady) {
    updateCloudStatus('‚è≥ Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...');
    waitForAuth(() => refreshCloudConfigList());
    return;
  }

  updateCloudStatus('Ë®≠ÂÆö‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø‰∏≠...');

  database.ref('configs').once('value').then((snapshot) => {
    cloudConfigs = snapshot.val() || {};
    updateCloudConfigSelectBox();
    updateCloudStatus(`${Object.keys(cloudConfigs).length}‰ª∂„ÅÆË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
  }).catch((error) => {
    updateCloudStatus('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// „ÇØ„É©„Ç¶„ÉâË®≠ÂÆö„ÅÆ„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞
function updateCloudConfigSelectBox() {
  const selectBox = document.getElementById('cloudConfigList');
  selectBox.innerHTML = '<option value="">Ë®≠ÂÆö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';

  // ÊúÄÁµÇ‰øùÂ≠òÊó•„ÅÆÊñ∞„Åó„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
  const sortedConfigIds = Object.keys(cloudConfigs).sort((a, b) => {
    const dateA = cloudConfigs[a].updatedAt || 0;
    const dateB = cloudConfigs[b].updatedAt || 0;
    return dateB - dateA; // ÈôçÈ†ÜÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
  });

  sortedConfigIds.forEach(configId => {
    const config = cloudConfigs[configId];
    const date = new Date(config.updatedAt).toLocaleString('ja-JP');
    const option = document.createElement('option');
    option.value = configId;

    // Ë°®Á§∫Âêç„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞ÂÜÖÈÉ®ID„ÇíË°®Á§∫
    const displayName = config.displayName || configId;

    // „É°„É¢„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Éó„É¨„Éì„É•„Éº„ÇíËøΩÂä†
    let optionText = `${displayName} (${date})`;
    if (config.data && config.data.memo) {
      const memoPreview = config.data.memo.length > 30
        ? config.data.memo.substring(0, 30) + '...'
        : config.data.memo;
      optionText = `${displayName} - üìù ${memoPreview} (${date})`;
    }

    option.textContent = optionText;
    selectBox.appendChild(option);
  });

  // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆË®≠ÂÆö„Åå„ÅÇ„Çå„Å∞ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÁ∂≠ÊåÅ
  if (currentCloudConfigId && cloudConfigs[currentCloudConfigId]) {
    selectBox.value = currentCloudConfigId;
    document.getElementById('updateCloudBtn').disabled = false;
  } else {
    document.getElementById('updateCloudBtn').disabled = true;
  }
}

// „ÇØ„É©„Ç¶„Éâ„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„ÇíÊõ¥Êñ∞
function updateCloudStatus(message) {
  document.getElementById('cloudStatus').textContent = message;
  setTimeout(() => {
    document.getElementById('cloudStatus').textContent = '';
  }, 3000);
}

// Firebase „Éë„ÇπÂêç„Çí„Çµ„Éã„Çø„Ç§„Ç∫„Åô„ÇãÈñ¢Êï∞
function sanitizeFirebasePath(name) {
  if (!name) return '';

  // Firebase„Åß‰ΩøÁî®„Åß„Åç„Å™„ÅÑÊñáÂ≠ó„ÇíÈô§Âéª„Åæ„Åü„ÅØÁΩÆÊèõ
  // . # $ [ ] / „ÅØ‰ΩøÁî®‰∏çÂèØ
  let sanitized = name
    .replace(/\./g, '_')  // „Éâ„ÉÉ„Éà„Çí„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„Å´ÁΩÆÊèõ
    .replace(/\#/g, '_')  // „Éè„ÉÉ„Ç∑„É•„Çí„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„Å´ÁΩÆÊèõ
    .replace(/\$/g, '_')  // „Éâ„É´Ë®òÂè∑„Çí„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„Å´ÁΩÆÊèõ
    .replace(/\[/g, '(')  // Èñã„ÅçËßíÊã¨Âºß„ÇíÈñã„Åç‰∏∏Êã¨Âºß„Å´ÁΩÆÊèõ
    .replace(/\]/g, ')')  // Èñâ„ÅòËßíÊã¨Âºß„ÇíÈñâ„Åò‰∏∏Êã¨Âºß„Å´ÁΩÆÊèõ
    .replace(/\//g, '_')  // „Çπ„É©„ÉÉ„Ç∑„É•„Çí„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„Å´ÁΩÆÊèõ
    .trim();

  // Á©∫ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÂêç„Çí‰ΩøÁî®
  if (!sanitized) {
    sanitized = 'config_' + Date.now();
  }

  return sanitized;
}

// ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†„Çµ„Éã„Çø„Ç§„Ç∫ÔºàË≠¶Âëä„ÅÆ„Åø„ÄÅËá™ÂãïÂ§âÊèõ„Åó„Å™„ÅÑÔºâ
function sanitizeConfigNameInput(input) {
  const originalValue = input.value;
  const sanitizedValue = sanitizeFirebasePath(originalValue);

  // ÂÄ§„ÅåÂ§âÊõ¥„Åï„Çå„ÇãÂ†¥Âêà„ÅØË≠¶Âëä„ÇíË°®Á§∫Ôºà„Åü„Å†„ÅóÂÖ•ÂäõÂÄ§„ÅØÂ§âÊõ¥„Åó„Å™„ÅÑÔºâ
  const warning = document.getElementById('configNameWarning');
  if (warning) {
    if (originalValue !== sanitizedValue && originalValue.length > 0) {
      warning.style.display = 'block';
      warning.textContent = 'üí° ‰øùÂ≠òÊôÇ„Å´‰ΩøÁî®„Åß„Åç„Å™„ÅÑÊñáÂ≠ó„ÅØÂÜÖÈÉ®ÁöÑ„Å´Â§âÊèõ„Åï„Çå„Åæ„Åô„Åå„ÄÅË°®Á§∫Âêç„ÅØ„Åù„ÅÆ„Åæ„Åæ‰øùÊåÅ„Åï„Çå„Åæ„Åô';
    } else {
      warning.style.display = 'none';
    }
  }
}

// Êñ∞Ë¶è„ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò
function saveToCloudWithName() {
  const displayName = document.getElementById('cloudConfigName').value.trim();
  if (!displayName) {
    alert('‚ùå Ë®≠ÂÆöÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  // ÂÜÖÈÉ®IDÔºàFirebase„ÅÆ„Ç≠„ÉºÔºâ„Çí„Çµ„Éã„Çø„Ç§„Ç∫
  const internalId = sanitizeFirebasePath(displayName);

  // Ë®≠ÂÆöÂêç„ÅåÁ©∫„ÅÆÂ†¥ÂêàÔºà„Çµ„Éã„Çø„Ç§„Ç∫Âæå„Å´Á©∫„Å´„Å™„Å£„ÅüÂ†¥ÂêàÔºâ
  if (!internalId) {
    alert('‚ùå ÊúâÂäπ„Å™Ë®≠ÂÆöÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
  if (!isAuthReady) {
    updateCloudStatus('‚è≥ Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...');
    waitForAuth(() => saveToCloudWithName());
    return;
  }

  // ÂêåÂêç„ÅÆË®≠ÂÆö„ÅåÊó¢„Å´Â≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  if (cloudConfigs[internalId]) {
    if (!confirm(`„Äå${displayName}„Äç„Å®„ÅÑ„ÅÜË®≠ÂÆö„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü`)) {
      return;
    }
  }

  const config = getCurrentConfig();
  updateCloudStatus('‰øùÂ≠ò‰∏≠...');

  const saveData = {
    data: config,
    displayName: displayName,  // „É¶„Éº„Ç∂„Éº„ÅåÂÖ•Âäõ„Åó„ÅüÂÖÉ„ÅÆÂêçÂâçÔºà. / Âê´„ÇÄÔºâ
    internalId: internalId,    // „Çµ„Éã„Çø„Ç§„Ç∫„Åï„Çå„ÅüÂÜÖÈÉ®ID
    updatedAt: Date.now(),
    createdBy: 'user',
    version: '1.0'
  };

  console.log('üî• Firebase„Å´‰øùÂ≠ò„Åô„Çã„Éá„Éº„Çø:', saveData);

  // Ë°®Á§∫Âêç„Å®ÂÜÖÈÉ®ID„Çí‰∏°Êñπ‰øùÂ≠ò
  database.ref('configs/' + internalId).set(saveData).then(() => {
    currentCloudConfigId = internalId;
    document.getElementById('updateCloudBtn').disabled = false;
    updateCloudStatus(`„Äå${displayName}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
    console.log(`‚úÖ ‰øùÂ≠òÂÆå‰∫Ü:`, {
      displayName: displayName,
      internalId: internalId,
      path: 'configs/' + internalId,
      memo: config.memo
    });
    refreshCloudConfigList();
    document.getElementById('cloudConfigName').value = '';
    // ÈõÜË®à„ÇíËá™ÂãïÊõ¥Êñ∞
    setTimeout(() => refreshWeeklyStats(), 500);
  }).catch((error) => {
    updateCloudStatus('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
    console.error('‚ùå ‰øùÂ≠ò„Ç®„É©„Éº:', error);
  });
}

// ÁèæÂú®„ÅÆË®≠ÂÆö„Çí‰∏äÊõ∏„ÅçÊõ¥Êñ∞
function updateCloudConfig() {
  if (!currentCloudConfigId) {
    alert('Êõ¥Êñ∞„Åô„ÇãË®≠ÂÆö„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
    return;
  }

  // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
  if (!isAuthReady) {
    updateCloudStatus('‚è≥ Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...');
    waitForAuth(() => updateCloudConfig());
    return;
  }

  // ÂÖ•ÂäõÊ¨Ñ„ÅÆ„Ç™„É™„ÉëÂêç„ÇíÂèñÂæóÔºàÂ§âÊõ¥ÂèØËÉΩÔºâ
  const inputName = document.getElementById('cloudConfigName').value.trim();
  const configData = cloudConfigs[currentCloudConfigId];
  const oldDisplayName = configData?.displayName || currentCloudConfigId;

  // ÂÖ•ÂäõÊ¨Ñ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÊó¢Â≠ò„ÅÆÂêçÂâç„Çí‰ΩøÁî®
  const newDisplayName = inputName || oldDisplayName;

  // ÂêçÂâç„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Åã„Å©„ÅÜ„Åã
  const nameChanged = newDisplayName !== oldDisplayName;

  let confirmMessage = `„Äå${oldDisplayName}„Äç„ÇíÁèæÂú®„ÅÆË®≠ÂÆö„Åß‰∏äÊõ∏„ÅçÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü`;
  if (nameChanged) {
    confirmMessage = `„Äå${oldDisplayName}„Äç„Çí„Äå${newDisplayName}„Äç„Å´ÂêçÂâç„ÇíÂ§âÊõ¥„Åó„Å¶‰∏äÊõ∏„ÅçÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü`;
  }

  if (!confirm(confirmMessage)) {
    return;
  }

  const config = getCurrentConfig();
  updateCloudStatus('Êõ¥Êñ∞‰∏≠...');

  const updateData = {
    data: config,
    displayName: newDisplayName,  // „Ç™„É™„ÉëÂêç„ÇÇÊõ¥Êñ∞
    updatedAt: Date.now()
  };

  console.log('üî• Firebase„ÇíÊõ¥Êñ∞„Åô„Çã„Éá„Éº„Çø:', updateData);

  database.ref('configs/' + currentCloudConfigId).update(updateData).then(() => {
    // „É≠„Éº„Ç´„É´„ÅÆcloudConfigs„ÇÇÊõ¥Êñ∞
    if (cloudConfigs[currentCloudConfigId]) {
      cloudConfigs[currentCloudConfigId].displayName = newDisplayName;
    }

    const statusMsg = nameChanged
      ? `„Äå${newDisplayName}„Äç„Å´ÂêçÂâç„ÇíÂ§âÊõ¥„Åó„Å¶Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`
      : `„Äå${newDisplayName}„Äç„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü`;
    updateCloudStatus(statusMsg);
    console.log(`‚úÖ Êõ¥Êñ∞ÂÆå‰∫Ü:`, {
      oldDisplayName: oldDisplayName,
      newDisplayName: newDisplayName,
      nameChanged: nameChanged,
      internalId: currentCloudConfigId,
      memo: config.memo
    });
    refreshCloudConfigList();
    // ÈõÜË®à„ÇíËá™ÂãïÊõ¥Êñ∞
    setTimeout(() => refreshWeeklyStats(), 500);
  }).catch((error) => {
    updateCloudStatus('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// ÈÅ∏Êäû„Åï„Çå„Åü„ÇØ„É©„Ç¶„ÉâË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
function loadSelectedCloudConfig() {
  const selectedConfigId = document.getElementById('cloudConfigList').value;
  if (!selectedConfigId) {
    alert('Ë™≠„ÅøËæº„ÇÄË®≠ÂÆö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
  if (!isAuthReady) {
    updateCloudStatus('‚è≥ Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...');
    waitForAuth(() => loadSelectedCloudConfig());
    return;
  }

  updateCloudStatus('Ë™≠„ÅøËæº„Åø‰∏≠...');

  database.ref('configs/' + selectedConfigId).once('value').then((snapshot) => {
    const configData = snapshot.val();
    console.log('üî• Firebase„Åã„ÇâÂèñÂæó„Åó„Åü„Éá„Éº„Çø:', configData);

    if (configData && configData.data) {
      console.log('üìã Ë™≠„ÅøËæº„ÇÄË®≠ÂÆö„Éá„Éº„Çø:', configData.data);
      console.log('üìù Ë™≠„ÅøËæº„ÇÄ„É°„É¢:', configData.data.memo);
      loadConfig(configData.data);
      currentCloudConfigId = selectedConfigId;
      document.getElementById('updateCloudBtn').disabled = false;

      // Ë°®Á§∫Âêç„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞ÂÜÖÈÉ®ID„Çí‰ΩøÁî®
      const displayName = configData.displayName || selectedConfigId;
      document.getElementById('cloudConfigName').value = displayName;
      updateCloudStatus(`„Äå${displayName}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
      console.log(`‚úÖ Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${displayName}`);
    } else {
      updateCloudStatus('Ë®≠ÂÆö„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
    }
  }).catch((error) => {
    updateCloudStatus('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// ÈÅ∏Êäû„Åï„Çå„Åü„ÇØ„É©„Ç¶„ÉâË®≠ÂÆö„ÇíÂâäÈô§
function deleteSelectedCloudConfig() {
  const selectedConfigId = document.getElementById('cloudConfigList').value;
  if (!selectedConfigId) {
    alert('ÂâäÈô§„Åô„ÇãË®≠ÂÆö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  // Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å§
  if (!isAuthReady) {
    updateCloudStatus('‚è≥ Ë™çË®ºÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...');
    waitForAuth(() => deleteSelectedCloudConfig());
    return;
  }

  // Ë°®Á§∫Âêç„ÇíÂèñÂæó
  const configData = cloudConfigs[selectedConfigId];
  const displayName = configData?.displayName || selectedConfigId;

  if (!confirm(`„Äå${displayName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
    return;
  }

  updateCloudStatus('ÂâäÈô§‰∏≠...');

  database.ref('configs/' + selectedConfigId).remove().then(() => {
    if (currentCloudConfigId === selectedConfigId) {
      currentCloudConfigId = null;
      document.getElementById('updateCloudBtn').disabled = true;
      document.getElementById('cloudConfigName').value = '';
    }
    updateCloudStatus(`„Äå${displayName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
    refreshCloudConfigList();
  }).catch((error) => {
    updateCloudStatus('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// URL„Éë„É©„É°„Éº„Çø„Åã„ÇâË®≠ÂÆöID„ÇíÂèñÂæó
function getConfigIdFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('config');
}

// URL„Éë„É©„É°„Éº„Çø„ÅßÊåáÂÆö„Åï„Çå„ÅüË®≠ÂÆö„ÇíËá™ÂãïË™≠„ÅøËæº„Åø
function loadConfigFromURL() {
  const configId = getConfigIdFromURL();
  if (!configId) return;

  updateCloudStatus(`ÂÖ±ÊúâË®≠ÂÆö„Äå${configId}„Äç„ÇíË™≠„ÅøËæº„Åø‰∏≠...`);

  database.ref('configs/' + configId).once('value').then((snapshot) => {
    const configData = snapshot.val();
    if (configData && configData.data) {
      loadConfig(configData.data);
      currentCloudConfigId = configId;

      // UI„ÇíÊõ¥Êñ∞
      const updateBtn = document.getElementById('updateCloudBtn');
      if (updateBtn) updateBtn.disabled = false;

      const nameInput = document.getElementById('cloudConfigName');
      if (nameInput) nameInput.value = configId;

      // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇÇÊõ¥Êñ∞
      const selectBox = document.getElementById('cloudConfigList');
      if (selectBox) {
        selectBox.value = configId;
      }

      updateCloudStatus(`ÂÖ±ÊúâË®≠ÂÆö„Äå${configId}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);

      // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
      setTimeout(() => {
        alert(`üîó ÂÖ±Êúâ„Åï„Çå„ÅüË®≠ÂÆö„Äå${configId}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ\n\nË®≠ÂÆö„ÇíÁ∑®ÈõÜ„Åó„Å¶„Äå‰∏äÊõ∏„ÅçÊõ¥Êñ∞„Äç„Åô„Çã„Å®„ÄÅÂÖÉ„ÅÆË®≠ÂÆö„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ\n„ÄåÂà•Âêç‰øùÂ≠ò„Äç„ÅßÊñ∞„Åó„ÅÑË®≠ÂÆö„Å®„Åó„Å¶‰øùÂ≠ò„Åô„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ`);
      }, 500);
    } else {
      updateCloudStatus(`ÂÖ±ÊúâË®≠ÂÆö„Äå${configId}„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü`);
      alert(`‚ùå ÂÖ±ÊúâË®≠ÂÆö„Äå${configId}„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\nË®≠ÂÆö„ÅåÂâäÈô§„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÄÅË®≠ÂÆöÂêç„ÅåÊ≠£„Åó„Åè„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ`);
    }
  }).catch((error) => {
    updateCloudStatus('ÂÖ±ÊúâË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
    alert(`‚ùå ÂÖ±ÊúâË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Ç®„É©„Éº: ${error.message}`);
  });
}

// ÂÖ±Êúâ„É™„É≥„ÇØ„ÇíÁîüÊàê„Åó„Å¶„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
function generateShareLink() {
  if (!currentCloudConfigId) {
    alert('ÂÖ±Êúâ„Åô„ÇãË®≠ÂÆö„ÇíÈÅ∏Êäû„Åæ„Åü„ÅØ‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  const baseUrl = window.location.origin + window.location.pathname;
  const shareUrl = `${baseUrl}?config=${encodeURIComponent(currentCloudConfigId)}`;

  // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
  navigator.clipboard.writeText(shareUrl).then(() => {
    updateShareStatus('‚úÖ „É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');

    // ÊàêÂäü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
    showCopySuccessPopup(shareUrl);
  }).catch(() => {
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „É¢„Éº„ÉÄ„É´Ë°®Á§∫
    showShareLinkModal(shareUrl);
  });
}

// „Ç≥„Éî„ÉºÊàêÂäü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
function showCopySuccessPopup(shareUrl) {
  // Êó¢Â≠ò„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
  const existingPopup = document.getElementById('copySuccessPopup');
  if (existingPopup) {
    document.body.removeChild(existingPopup);
  }

  const popup = document.createElement('div');
  popup.id = 'copySuccessPopup';
  popup.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #34C759, #30D158);
    color: white;
    padding: 20px 24px;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(52, 199, 89, 0.3);
    z-index: 10000;
    transform: translateX(400px);
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    max-width: 350px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    backdrop-filter: blur(20px);
  `;

  popup.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
      <div style="font-size: 24px;">‚úÖ</div>
      <div style="font-size: 16px; font-weight: 600;">„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ</div>
    </div>
    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">
      „Äå${currentCloudConfigId}„Äç„ÅÆÂÖ±Êúâ„É™„É≥„ÇØ„Åå„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åï„Çå„Åæ„Åó„Åü
    </div>
    <div style="font-size: 11px; opacity: 0.8; word-break: break-all; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px;">
      ${shareUrl}
    </div>
    <div style="position: absolute; top: 8px; right: 8px; cursor: pointer; font-size: 18px; opacity: 0.7; hover: opacity: 1;" onclick="document.body.removeChild(this.parentElement)">
      √ó
    </div>
  `;

  document.body.appendChild(popup);

  // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥: „Çπ„É©„Ç§„Éâ„Ç§„É≥
  setTimeout(() => {
    popup.style.transform = 'translateX(0)';
  }, 50);

  // 4ÁßíÂæå„Å´Ëá™Âãï„ÅßÈùûË°®Á§∫
  setTimeout(() => {
    if (popup.parentElement) {
      popup.style.transform = 'translateX(400px)';
      setTimeout(() => {
        if (popup.parentElement) {
          document.body.removeChild(popup);
        }
      }, 300);
    }
  }, 4000);

  // „ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
  popup.onclick = (e) => {
    if (e.target.tagName !== 'DIV') return;
    popup.style.transform = 'translateX(400px)';
    setTimeout(() => {
      if (popup.parentElement) {
        document.body.removeChild(popup);
      }
    }, 300);
  };
}

// ÂÖ±Êúâ„É™„É≥„ÇØ„É¢„Éº„ÉÄ„É´Ë°®Á§∫Ôºà„ÇØ„É™„ÉÉ„Éó„Éú„Éº„ÉâAPI„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥ÂêàÔºâ
function showShareLinkModal(shareUrl) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

  modal.innerHTML = `
    <div style="background: white; padding: 32px; border-radius: 16px; max-width: 500px; width: 90%;">
      <h3 style="margin: 0 0 16px 0;">üîó ÂÖ±Êúâ„É™„É≥„ÇØ</h3>
      <p style="margin: 0 0 16px 0; color: #666;">‰ª•‰∏ã„ÅÆ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Å¶ÂÖ±Êúâ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
      <input type="text" value="${shareUrl}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 16px;" readonly onclick="this.select()">
      <div style="display: flex; gap: 12px;">
        <button onclick="document.body.removeChild(this.closest('div[style*=\"fixed\"]'))" style="flex: 1; padding: 12px; background: #8E8E93; color: white; border: none; border-radius: 8px; cursor: pointer;">
          Èñâ„Åò„Çã
        </button>
        <button onclick="copyFromModal('${shareUrl}', this)" style="flex: 1; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer;">
          üìã „Ç≥„Éî„Éº
        </button>
      </div>
    </div>
  `;

  modal.onclick = (e) => {
    if (e.target === modal) document.body.removeChild(modal);
  };

  document.body.appendChild(modal);
}

// ÁèæÂú®„ÅÆË®≠ÂÆö„Åã„ÇâÂÖ±Êúâ„É™„É≥„ÇØ„ÇíÁîüÊàê
function generateShareLinkFromCurrent() {
  // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèñÂæó
  const config = getCurrentConfig();

  // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Éô„Éº„Çπ„ÅÆ„É¶„Éã„Éº„ÇØ„Å™ID„ÇíÁîüÊàê
  const configId = 'config_' + Date.now();

  updateShareStatus('‚è≥ ÂÖ±Êúâ„É™„É≥„ÇØ„ÇíÁîüÊàê‰∏≠...');

  // Firebase„Å´‰øùÂ≠ò
  database.ref('configs/' + configId).set({
    data: config,
    updatedAt: Date.now(),
    createdBy: 'user'
  }).then(() => {
    // ÂÖ±Êúâ„É™„É≥„ÇØ„ÇíÁîüÊàê
    const baseUrl = window.location.origin + window.location.pathname;
    const shareUrl = `${baseUrl}?config=${encodeURIComponent(configId)}`;

    // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
    navigator.clipboard.writeText(shareUrl).then(() => {
      updateShareStatus('‚úÖ „É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');

      // ÊàêÂäü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫ÔºàÁ∞°ÊòìÁâàÔºâ
      const popup = document.createElement('div');
      popup.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #34C759, #30D158);
        color: white;
        padding: 20px 24px;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(52, 199, 89, 0.3);
        z-index: 10000;
        max-width: 350px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      `;

      popup.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <div style="font-size: 24px;">‚úÖ</div>
          <div style="font-size: 16px; font-weight: 600;">„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ</div>
        </div>
        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">
          „Åì„ÅÆË®≠ÂÆö„ÅÆÂÖ±Êúâ„É™„É≥„ÇØ„Åå„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åï„Çå„Åæ„Åó„Åü
        </div>
        <div style="font-size: 11px; opacity: 0.8; word-break: break-all; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px;">
          ${shareUrl}
        </div>
      `;

      document.body.appendChild(popup);

      // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÊ∂à„Åà„Çã
      setTimeout(() => {
        popup.style.opacity = '0';
        popup.style.transform = 'translateX(400px)';
        setTimeout(() => {
          if (popup.parentElement) {
            document.body.removeChild(popup);
          }
        }, 300);
      }, 3000);

    }).catch(() => {
      updateShareStatus('‚ùå „Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „É¢„Éº„ÉÄ„É´Ë°®Á§∫
      alert(`ÂÖ±Êúâ„É™„É≥„ÇØ:\n${shareUrl}\n\nÊâãÂãï„Åß„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
    });

  }).catch((error) => {
    console.error('‚ùå ÂÖ±Êúâ„É™„É≥„ÇØ„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
    updateShareStatus('‚ùå ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    alert(`‚ùå ÂÖ±Êúâ„É™„É≥„ÇØ„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Ç®„É©„Éº: ${error.message}`);
  });
}

// „É¢„Éº„ÉÄ„É´„Åã„Çâ„ÅÆ„Ç≥„Éî„ÉºÂá¶ÁêÜ
function copyFromModal(shareUrl, buttonElement) {
  navigator.clipboard.writeText(shareUrl).then(() => {
    // „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí‰∏ÄÊôÇÁöÑ„Å´Â§âÊõ¥
    const originalText = buttonElement.textContent;
    buttonElement.textContent = '‚úÖ „Ç≥„Éî„ÉºÊ∏à„Åø';
    buttonElement.style.background = '#34C759';

    setTimeout(() => {
      // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
      const modal = buttonElement.closest('div[style*="fixed"]');
      if (modal) {
        document.body.removeChild(modal);
      }

      // ÊàêÂäü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
      showCopySuccessPopup(shareUrl);
    }, 800);
  }).catch(() => {
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „ÉÜ„Ç≠„Çπ„Éà„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
    const input = buttonElement.closest('div').previousElementSibling;
    input.select();
    input.setSelectionRange(0, 99999);

    buttonElement.textContent = '‚ö†Ô∏è ÊâãÂãï„Åß„Ç≥„Éî„Éº';
    setTimeout(() => {
      buttonElement.textContent = 'üìã „Ç≥„Éî„Éº';
    }, 2000);
  });
}

// ÂÖ±Êúâ„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„ÇíÊõ¥Êñ∞
function updateShareStatus(message) {
  document.getElementById('shareStatus').textContent = message;
  setTimeout(() => {
    document.getElementById('shareStatus').textContent = '';
  }, 3000);
}

// ÂÖ±Êúâ„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
function updateShareButtonState() {
  const shareBtn = document.getElementById('shareBtn');
  if (!shareBtn) return;

  if (currentCloudConfigId) {
    shareBtn.disabled = false;
    shareBtn.textContent = `üìã „Äå${currentCloudConfigId}„Äç„ÅÆ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº`;
  } else {
    shareBtn.disabled = true;
    shareBtn.textContent = 'üìã ÂÖ±Êúâ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº';
  }
}

// Êó¢Â≠ò„ÅÆÈñ¢Êï∞„ÇíÊã°ÂºµÔºöË®≠ÂÆö‰øùÂ≠ò„ÉªË™≠„ÅøËæº„ÅøÊôÇ„Å´ÂÖ±Êúâ„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
const originalSaveToCloudWithName = saveToCloudWithName;
saveToCloudWithName = function() {
  const result = originalSaveToCloudWithName.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

const originalLoadSelectedCloudConfig = loadSelectedCloudConfig;
loadSelectedCloudConfig = function() {
  const result = originalLoadSelectedCloudConfig.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

const originalLoadConfigFromURL = loadConfigFromURL;
loadConfigFromURL = function() {
  const result = originalLoadConfigFromURL.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

// ========== ÈÅéÂéª7Êó•Èñì„ÅÆÈõÜË®àÊ©üËÉΩ ==========

// ÈÅéÂéª7Êó•Èñì„ÅÆÈõÜË®à„ÇíÊõ¥Êñ∞
function refreshWeeklyStats() {
  const container = document.getElementById('weeklyStatsContainer');

  // „Ç≥„É≥„ÉÜ„Éä„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
  if (!container) {
    console.warn('weeklyStatsContainer „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
    return;
  }

  container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">ÈõÜË®à‰∏≠...</p>';

  // 7Êó•Ââç„ÅÆ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÇíÂèñÂæó
  const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

  database.ref('configs').once('value').then((snapshot) => {
    const allConfigs = snapshot.val() || {};

    // ÈÅéÂéª7Êó•Èñì„ÅÆ„Éá„Éº„Çø„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
    const recentConfigs = Object.entries(allConfigs).filter(([configId, configData]) => {
      return configData.updatedAt && configData.updatedAt >= sevenDaysAgo;
    });

    if (recentConfigs.length === 0) {
      container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">ÈÅéÂéª7Êó•Èñì„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
      return;
    }

    // ÈõÜË®àÂá¶ÁêÜ
    const stats = calculateWeeklyStats(recentConfigs);

    // ÁµêÊûú„ÇíË°®Á§∫
    displayWeeklyStats(stats);
  }).catch((error) => {
    container.innerHTML = `<p style="color: var(--sf-red); text-align: center;">ÈõÜË®à„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</p>`;
  });
}

// ÈÅéÂéª7Êó•Èñì„ÅÆ„Éá„Éº„Çø„Åã„ÇâÁµ±Ë®à„ÇíË®àÁÆó
function calculateWeeklyStats(recentConfigs) {
  let totalOripaCount = recentConfigs.length;
  let totalValue = 0;
  let totalPurchase = 0;
  let totalPacks = 0;
  let totalWinners = 0;
  let totalPrizeCount = 0;
  let totalLossCount = 0;
  let totalReturnRates = [];
  let totalRealReturnRates = [];

  recentConfigs.forEach(([configId, configData]) => {
    const config = configData.data;
    if (!config) return;

    const packPrice = parseFloat(config.packPrice) || 0;
    const packs = parseInt(config.totalPacks) || 0;
    const prizes = config.prizes || [];
    const losses = config.losses || [];

    // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§
    const oripaValue = packPrice * packs;
    totalValue += oripaValue;

    // Á∑èÂè£Êï∞
    totalPacks += packs;

    // ÊôØÂìÅ„ÅÆÈõÜË®à
    let prizeTotalValue = 0;
    let prizeTotalPurchase = 0;
    let prizeCount = 0;

    prizes.forEach(prize => {
      prizeCount += prize.count || 0;
      prizeTotalValue += (prize.value || 0) * (prize.count || 0);
      prizeTotalPurchase += (prize.purchasePrice || 0) * (prize.count || 0);
    });

    totalWinners += prizeCount;
    totalPrizeCount += prizeCount;
    totalPurchase += prizeTotalPurchase;

    // „Éè„Ç∫„É¨„ÅÆÈõÜË®à
    let lossTotalValue = 0;
    let lossCount = 0;

    if (losses.length > 0) {
      losses.forEach(loss => {
        lossCount += loss.count || 0;
        lossTotalValue += (loss.value || 0) * (loss.count || 0);
      });
    } else {
      // Ëá™ÂãïË®àÁÆó„ÅÆÂ†¥Âêà
      const minGuaranteeValue = parseFloat(config.minGuaranteeValue) || 1;
      const remainingSlots = packs - prizeCount;
      if (remainingSlots > 0) {
        lossCount = remainingSlots;
        lossTotalValue = minGuaranteeValue * remainingSlots;
      }
    }

    totalLossCount += lossCount;

    // Á∑èÈÇÑÂÖÉÁéá
    const actualTotalReturnValue = prizeTotalValue + lossTotalValue;
    const totalReturnRate = oripaValue > 0 ? (actualTotalReturnValue / oripaValue) * 100 : 0;
    totalReturnRates.push(totalReturnRate);

    // ÂÆüË≥™ÈÇÑÂÖÉÁéáÔºàÂ£≤‰∏äÂéü‰æ°ÁéáÔºâ
    const realReturnRate = oripaValue > 0 ? (prizeTotalPurchase / oripaValue) * 100 : 0;
    totalRealReturnRates.push(realReturnRate);
  });

  // Âπ≥Âùá„ÇíË®àÁÆó
  const avgValue = totalOripaCount > 0 ? totalValue / totalOripaCount : 0;
  const avgPurchase = totalOripaCount > 0 ? totalPurchase / totalOripaCount : 0;
  const avgReturnRate = totalReturnRates.length > 0 ? totalReturnRates.reduce((a, b) => a + b, 0) / totalReturnRates.length : 0;
  const avgRealReturnRate = totalRealReturnRates.length > 0 ? totalRealReturnRates.reduce((a, b) => a + b, 0) / totalRealReturnRates.length : 0;
  const avgPacks = totalOripaCount > 0 ? totalPacks / totalOripaCount : 0;

  return {
    totalOripaCount,
    totalValue,
    avgValue,
    totalPurchase,
    avgPurchase,
    totalPacks,
    avgPacks,
    totalWinners,
    totalPrizeCount,
    totalLossCount,
    avgReturnRate,
    avgRealReturnRate,
    totalReturnRates,
    totalRealReturnRates
  };
}

// ÈõÜË®àÁµêÊûú„ÇíË°®Á§∫
function displayWeeklyStats(stats) {
  const container = document.getElementById('weeklyStatsContainer');

  container.innerHTML = `
    <div style="margin-bottom: 16px; padding: 12px; background: rgba(175, 82, 222, 0.1); border-radius: 8px; text-align: center;">
      <div style="font-size: 24px; font-weight: 700; color: var(--sf-purple);">${stats.totalOripaCount}</div>
      <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;">„Ç™„É™„ÉëË®≠ÂÆöÊï∞</div>
    </div>

    <div style="display: grid; gap: 8px;">
      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">Êèê‰æõ‰æ°ÂÄ§ÂêàË®à</span>
        <span style="font-weight: 600;">¬•${formatNumber(stats.totalValue)}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">Êèê‰æõ‰æ°ÂÄ§Âπ≥Âùá</span>
        <span style="font-weight: 600;">¬•${formatNumber(Math.round(stats.avgValue))}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">‰ªïÂÖ•„ÇåÂêàË®à</span>
        <span style="font-weight: 600; color: var(--sf-orange);">¬•${formatNumber(stats.totalPurchase)}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">‰ªïÂÖ•„ÇåÂπ≥Âùá</span>
        <span style="font-weight: 600; color: var(--sf-orange);">¬•${formatNumber(Math.round(stats.avgPurchase))}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">Á∑èÈÇÑÂÖÉÁéáÂπ≥Âùá</span>
        <span style="font-weight: 600; color: var(--sf-blue);">${stats.avgReturnRate.toFixed(1)}%</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">ÂÆüË≥™ÈÇÑÂÖÉÁéáÂπ≥Âùá</span>
        <span style="font-weight: 600; color: var(--sf-green);">${stats.avgRealReturnRate.toFixed(1)}%</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">Á∑èÂè£Êï∞ÂêàË®à</span>
        <span style="font-weight: 600;">${formatNumber(stats.totalPacks)}Âè£</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">Âπ≥ÂùáÂè£Êï∞</span>
        <span style="font-weight: 600;">${formatNumber(Math.round(stats.avgPacks))}Âè£</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">ÂΩìÈÅ∏ËÄÖÁ∑èÊï∞</span>
        <span style="font-weight: 600; color: var(--sf-purple);">${formatNumber(stats.totalWinners)}‰∫∫</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">ÊôØÂìÅÁ∑èÊûöÊï∞</span>
        <span style="font-weight: 600;">${formatNumber(stats.totalPrizeCount)}Êûö</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span style="color: var(--sf-gray);">„Éè„Ç∫„É¨Á∑èÊûöÊï∞</span>
        <span style="font-weight: 600;">${formatNumber(stats.totalLossCount)}Êûö</span>
      </div>
    </div>

    <div style="margin-top: 12px; padding: 8px; background: rgba(0, 122, 255, 0.05); border-radius: 6px; font-size: 11px; color: var(--sf-gray); text-align: center;">
      ÈÅéÂéª7Êó•Èñì„ÅÆ„Éá„Éº„ÇøÔºà${new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toLocaleDateString('ja-JP')} „Äú ${new Date().toLocaleDateString('ja-JP')}Ôºâ
    </div>
  `;
}

document.addEventListener('DOMContentLoaded', function() {
  // „ÇØ„É©„Ç¶„ÉâË®≠ÂÆö‰∏ÄË¶ß„ÇíËá™ÂãïÊõ¥Êñ∞
  refreshCloudConfigList();

  // URL„Éë„É©„É°„Éº„Çø„ÅßË®≠ÂÆö„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØËá™ÂãïË™≠„ÅøËæº„Åø
  setTimeout(() => {
    loadConfigFromURL();
    // ÂÖ±Êúâ„Éú„Çø„É≥„ÅÆÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
    updateShareButtonState();
  }, 500);
});

</script>

</body>
</html>
