<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オリパ設計シミュレーター v2.0</title>
    <style>
        :root {
            --sf-blue: #007AFF;
            --sf-orange: #FF9500;
            --sf-green: #34C759;
            --sf-red: #FF3B30;
            --sf-purple: #AF52DE;
            --sf-gray: #8E8E93;
            --sf-gray-2: #AEAEB2;
            --sf-gray-3: #C7C7CC;
            --sf-gray-4: #D1D1D6;
            --sf-gray-5: #E5E5EA;
            --sf-gray-6: #F2F2F7;
            --sf-white: #FFFFFF;
            --sf-black: #000000;
            --shadow-light: 0 2px 20px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.15);
            --border-radius: 16px;
            --border-radius-small: 12px;
            --transition: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #F2F2F7 0%, #FFFFFF 100%);
            min-height: 100vh;
            letter-spacing: -0.01em;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            color: var(--sf-black);
            text-align: center;
            margin-bottom: 32px;
            font-size: 2.2em;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .version-badge {
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 16px;
            vertical-align: middle;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 32px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--sf-gray-5);
            box-shadow: var(--shadow-light);
            transition: all 0.3s var(--transition);
        }

        .panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .panel h2 {
            margin: 0 0 20px 0;
            color: var(--sf-black);
            border-bottom: 2px solid var(--sf-blue);
            padding-bottom: 12px;
            font-size: 1.3em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--sf-black);
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            font-size: 15px;
            font-weight: 400;
            background: var(--sf-white);
            transition: all 0.3s var(--transition);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--sf-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .calculated-value {
            background: rgba(52, 199, 89, 0.1);
            color: var(--sf-green);
            padding: 12px 16px;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(52, 199, 89, 0.3);
        }

        .prize-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .prize-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            padding: 16px;
            position: relative;
            transition: all 0.3s var(--transition);
        }

        .prize-item:hover {
            border-color: var(--sf-blue);
            transform: translateY(-1px);
        }

        .prize-rank {
            position: absolute;
            top: -8px;
            left: 12px;
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .prize-rank.rank-1 { background: #FFD700; color: var(--sf-black); }
        .prize-rank.rank-2 { background: #C0C0C0; color: var(--sf-black); }
        .prize-rank.rank-3 { background: #CD7F32; color: var(--sf-white); }
        .prize-rank.rank-4 { background: var(--sf-green); }
        .prize-rank.rank-5 { background: var(--sf-purple); }

        .prize-content {
            margin-top: 8px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .prize-name {
            font-weight: 500;
            color: var(--sf-black);
        }

        .prize-value, .prize-count, .prize-purchase {
            font-size: 12px;
            color: var(--sf-gray);
            text-align: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius-small);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--transition);
        }

        .btn-primary {
            background: var(--sf-blue);
            color: var(--sf-white);
        }

        .btn-primary:hover {
            background: #0051D5;
            transform: scale(1.05);
        }

        .btn-danger {
            background: var(--sf-red);
            color: var(--sf-white);
        }

        .btn-danger:hover {
            background: #E6342A;
            transform: scale(1.05);
        }

        .btn-success {
            background: var(--sf-green);
            color: var(--sf-white);
            width: 100%;
            padding: 12px;
            font-size: 14px;
            margin-top: 16px;
        }

        .btn-success:hover {
            background: #248A3D;
        }

        .add-prize-form {
            background: rgba(0, 122, 255, 0.05);
            border: 1px dashed var(--sf-blue);
            border-radius: var(--border-radius-small);
            padding: 20px;
            margin-top: 16px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .result-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--sf-gray-5);
            box-shadow: var(--shadow-light);
            transition: all 0.3s var(--transition);
        }

        .result-panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .result-panel h3 {
            margin: 0 0 16px 0;
            color: var(--sf-black);
            border-bottom: 2px solid var(--sf-green);
            padding-bottom: 8px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--sf-gray-5);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: var(--sf-black);
        }

        .result-value {
            color: var(--sf-gray);
            font-weight: 600;
        }

        .highlight {
            background: rgba(255, 149, 0, 0.15);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 149, 0, 0.3);
            color: var(--sf-orange);
            font-weight: 600;
        }

        .loss-panel {
            background: rgba(255, 149, 0, 0.08);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        .loss-panel h3 {
            border-bottom-color: var(--sf-orange);
        }

        .expected-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .ev-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 8px;
            font-size: 12px;
        }

        .ev-count {
            font-weight: 600;
            color: var(--sf-blue);
        }

        .ev-value {
            color: var(--sf-gray);
            font-size: 11px;
        }

        .history-panel {
            background: rgba(175, 82, 222, 0.08);
            border: 1px solid rgba(175, 82, 222, 0.2);
        }

        .history-panel h2 {
            border-bottom-color: var(--sf-purple);
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s var(--transition);
        }

        .history-item:hover {
            background: rgba(175, 82, 222, 0.1);
            transform: translateX(4px);
        }

        .history-name {
            font-weight: 500;
            color: var(--sf-black);
        }

        .history-meta {
            font-size: 12px;
            color: var(--sf-gray);
        }

        .warning {
            background: rgba(255, 59, 48, 0.1);
            color: var(--sf-red);
            padding: 16px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 59, 48, 0.2);
            margin-top: 24px;
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--sf-white);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 500px;
            width: 90%;
        }

        .modal h3 {
            margin: 0 0 20px 0;
            color: var(--sf-black);
        }

        .close-btn {
            background: var(--sf-gray-4);
            color: var(--sf-black);
        }

        .close-btn:hover {
            background: var(--sf-gray-3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>オリパ設計シミュレーター <span class="version-badge">v2.0</span></h1>
        
        <div class="main-grid">
            <div class="left-panel">
                <!-- 基本設定 -->
                <div class="panel">
                    <h2>基本設定</h2>
                    <div class="form-group">
                        <label>パック単価 (円)</label>
                        <input type="text" id="packPrice" value="40,000" oninput="formatBasicValue(this)">
                    </div>
                    <div class="form-group">
                        <label>総口数</label>
                        <input type="text" id="totalPacks" value="100" oninput="formatBasicValue(this)">
                    </div>
                    <div class="form-group">
                        <label>総還元率 (%)</label>
                        <input type="number" id="totalReturnRate" value="98" min="0" max="100" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>オリパ提供価値</label>
                        <div class="calculated-value" id="totalValue">¥0</div>
                    </div>
                </div>

                <!-- ハズレ設計 -->
                <div class="panel">
                    <h2>ハズレ設計</h2>
                    <div class="form-group">
                        <label>ガチャ難易度</label>
                        <select id="gachaDifficulty" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);" onchange="calculate()">
                            <option value="easy">😊 比較的当たりやすい</option>
                            <option value="normal" selected>😐 普通</option>
                            <option value="hard">😤 当たりにくい</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ハズレの種類数</label>
                        <select id="lossTypeCount" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);" onchange="calculate()">
                            <option value="2">2種類</option>
                            <option value="3">3種類</option>
                            <option value="4">4種類</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>最低保証価値 (円)</label>
                        <input type="text" id="minGuaranteeValue" value="1,000" oninput="formatBasicValue(this)">
                    </div>
                    <div class="difficulty-info" id="difficultyInfo" style="background: rgba(0, 122, 255, 0.1); padding: 12px; border-radius: 8px; font-size: 13px; margin-top: 12px;">
                        <!-- 難易度説明がここに表示されます -->
                    </div>
                </div>

                <!-- 景品管理 -->
                <div class="panel">
                    <h2>景品管理</h2>
                    <div class="prize-list" id="prizeList">
                        <!-- 景品リストがここに表示されます -->
                    </div>
                    
                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>景品名</label>
                            <input type="text" id="prizeName" placeholder="例: レアカード">
                        </div>
                        <div class="form-group">
                            <label>等級</label>
                            <select id="prizeRank" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                                <option value="1">1等</option>
                                <option value="2">2等</option>
                                <option value="3">3等</option>
                                <option value="4">4等</option>
                                <option value="5">5等</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>仕入れ価格</label>
                                <input type="text" id="prizePurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this)">
                            </div>
                            <div class="form-group">
                                <label>ポイント還元価値</label>
                                <input type="text" id="prizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>在庫数</label>
                            <input type="number" id="prizeCount" min="1" value="1">
                        </div>
                        <button class="btn btn-success" onclick="addPrize()">景品を追加</button>
                    </div>
                </div>

                <!-- 履歴管理 -->
                <div class="panel history-panel">
                    <h2>シミュレーション履歴</h2>
                    <div class="form-group">
                        <input type="text" id="historyName" placeholder="設定名を入力 (例: 新商品A案)">
                        <button class="btn btn-primary" onclick="saveToHistory()" style="width: 100%; margin-top: 8px;">現在の設定を保存</button>
                    </div>
                    <div class="history-list" id="historyList">
                        <!-- 履歴がここに表示されます -->
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;">
                        <button class="btn btn-success" onclick="exportSettings()" style="padding: 8px 12px; font-size: 12px;">
                            💾 設定をエクスポート
                        </button>
                        <button class="btn btn-primary" onclick="importSettings()" style="padding: 8px 12px; font-size: 12px;">
                            📂 設定をインポート
                        </button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
                </div>
            </div>

            <div class="results-grid">
                <!-- サマリー -->
                <div class="result-panel">
                    <h3>サマリー</h3>
                    <div class="result-row">
                        <span class="result-label">総還元率</span>
                        <span class="result-value" id="summaryTotalReturn">98.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">実質還元率</span>
                        <span class="result-value highlight" id="summaryRealReturn">0.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">理論期待値</span>
                        <span class="result-value" id="summaryExpectedValue">¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">標準偏差</span>
                        <span class="result-value" id="summaryStdDev">¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">総当選者数</span>
                        <span class="result-value" id="summaryWinnerCount">0人</span>
                    </div>
                </div>

                <!-- 景品詳細 -->
                <div class="result-panel">
                    <h3>景品詳細</h3>
                    <div id="prizeDetails">
                        <p style="color: var(--sf-gray); text-align: center;">景品を追加してください</p>
                    </div>
                </div>

                <!-- ハズレ詳細 -->
                <div class="result-panel loss-panel">
                    <h3>ハズレ詳細（自動計算）</h3>
                    <div id="lossDetailsContainer">
                        <!-- ハズレ詳細がここに動的に表示されます -->
                    </div>
                    <div class="result-row">
                        <span class="result-label">ハズレ総枚数</span>
                        <span class="result-value" id="totalLossCount">0枚</span>
                    </div>
                </div>

                <!-- ハズレ当選者分布 -->
                <div class="result-panel">
                    <h3>ハズレ当選者分布</h3>
                    <div class="chart-container">
                        <canvas id="lossDistributionChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- 理論期待値 -->
                <div class="result-panel">
                    <h3>理論期待値（1〜20回）</h3>
                    <div class="expected-values" id="expectedValues">
                        <!-- 期待値がここに表示されます -->
                    </div>
                    <div style="margin-top: 20px;">
                        <canvas id="expectedValueChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- ハズレ当選者分布 -->
                <div class="result-panel">
                    <h3>ハズレ当選者分布</h3>
                    <div style="margin-top: 16px;">
                        <canvas id="lossWinnersChart" width="400" height="250"></canvas>
                    </div>
                    <div id="lossWinnersLegend" style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; justify-content: center; font-size: 12px;">
                        <!-- 凡例がここに表示されます -->
                    </div>
                </div>

                <!-- 期待値シミュレーション -->
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <h3>期待値シミュレーション</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- 収支確率 -->
                        <div>
                            <h4 style="margin: 0 0 12px 0; color: var(--sf-black); font-size: 1.1em;">収支確率</h4>
                            <div id="profitLossTable" style="font-size: 13px;">
                                <!-- 収支確率テーブルがここに表示されます -->
                            </div>
                        </div>
                        <!-- 倍率確率 -->
                        <div>
                            <h4 style="margin: 0 0 12px 0; color: var(--sf-black); font-size: 1.1em;">倍率確率</h4>
                            <div id="multiplierTable" style="font-size: 13px;">
                                <!-- 倍率確率テーブルがここに表示されます -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="warnings"></div>
    </div>

    <!-- モーダル -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <h3>設定名を入力</h3>
            <div class="form-group">
                <input type="text" id="modalHistoryName" placeholder="設定名を入力してください">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmSaveHistory()">保存</button>
                <button class="btn close-btn" onclick="closeModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let prizes = [];
        let history = [];

        // ローカルストレージのキー
        const STORAGE_KEY = 'oripa_simulator_v2';

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            attachEventListeners();
            calculate();
        });

        // イベントリスナー設定
        function attachEventListeners() {
            document.getElementById('packPrice').addEventListener('input', calculate);
            document.getElementById('totalPacks').addEventListener('input', calculate);
            document.getElementById('totalReturnRate').addEventListener('input', calculate);
        }

        // ポイント還元価値のフォーマット
        function formatPrizeValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // 数字以外を除去
            if (value) {
                value = parseInt(value).toLocaleString(); // カンマ区切りに変換
            }
            input.value = value;
        }

        // 基本設定値のフォーマット
        function formatBasicValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // 数字以外を除去
            if (value) {
                value = parseInt(value).toLocaleString(); // カンマ区切りに変換
            }
            input.value = value;
            // 基本設定が変更されたら再計算
            setTimeout(calculate, 100);
        }

        // カンマ区切りの数字を数値に変換
        function parseFormattedNumber(value) {
            return parseFloat(value.replace(/,/g, '')) || 0;
        }

        // 景品追加
        function addPrize() {
            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const purchasePrice = parseFormattedNumber(document.getElementById('prizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || purchasePrice <= 0 || value <= 0 || count <= 0) {
                alert('すべての項目を正しく入力してください');
                return;
            }

            const prize = {
                id: Date.now(),
                name: name,
                rank: rank,
                purchasePrice: purchasePrice,
                value: value,
                count: count
            };

            prizes.push(prize);
            
            // フォームリセット
            document.getElementById('prizeName').value = '';
            document.getElementById('prizePurchasePrice').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';

            updatePrizeList();
            calculate();
            saveData();
        }

        // 景品削除
        function removePrize(id) {
            prizes = prizes.filter(p => p.id !== id);
            updatePrizeList();
            calculate();
            saveData();
        }

        // 景品リスト更新
        function updatePrizeList() {
            const container = document.getElementById('prizeList');
            
            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">景品を追加してください</p>';
                return;
            }

            // 等級順にソート
            prizes.sort((a, b) => a.rank - b.rank);

            container.innerHTML = prizes.map(prize => `
                <div class="prize-item">
                    <div class="prize-rank rank-${prize.rank}">${prize.rank}等</div>
                    <div class="prize-content">
                        <div class="prize-name">${prize.name}</div>
                        <div class="prize-purchase">仕入¥${prize.purchasePrice.toLocaleString()}</div>
                        <div class="prize-value">還元¥${prize.value.toLocaleString()}</div>
                        <div class="prize-count">${prize.count}枚</div>
                        <button class="btn btn-danger" onclick="removePrize(${prize.id})">削除</button>
                    </div>
                </div>
            `).join('');
        }

        // 値を10の位で丸める（1桁を0にする）
        function roundToTens(value) {
            return Math.round(value / 10) * 10;
        }

        // ガチャ難易度設定を取得
        function getDifficultySettings(difficulty) {
            switch(difficulty) {
                case 'easy':
                    return {
                        name: '比較的当たりやすい',
                        description: 'ハズレの価値が高めで、ユーザーフレンドリーな設計',
                        lossDistribution: [0.4, 0.35, 0.25], // 高還元重視
                        minValueMultiplier: 1.2, // 最低保証を20%アップ
                        maxValueCap: 0.8 // パック単価の80%まで
                    };
                case 'hard':
                    return {
                        name: '当たりにくい',
                        description: 'ハズレの価値が低めで、大当たり重視の設計',
                        lossDistribution: [0.15, 0.35, 0.5], // 低還元重視
                        minValueMultiplier: 0.8, // 最低保証を20%ダウン
                        maxValueCap: 0.5 // パック単価の50%まで
                    };
                default: // normal
                    return {
                        name: '普通',
                        description: 'バランスの良い標準的な設計',
                        lossDistribution: [0.2, 0.5, 0.3], // バランス重視
                        minValueMultiplier: 1.0, // 標準
                        maxValueCap: 0.7 // パック単価の70%まで
                    };
            }
        }

        // メイン計算
        function calculate() {
            const packPrice = parseFormattedNumber(document.getElementById('packPrice').value);
            const totalPacks = parseFormattedNumber(document.getElementById('totalPacks').value);
            const totalReturnRatePercent = parseFloat(document.getElementById('totalReturnRate').value) || 0;
            const totalReturnRate = totalReturnRatePercent / 100;
            const lossTypeCount = parseInt(document.getElementById('lossTypeCount').value) || 2;
            const minGuaranteeValue = parseFormattedNumber(document.getElementById('minGuaranteeValue').value);
            const difficulty = document.getElementById('gachaDifficulty').value;

            if (packPrice <= 0 || totalPacks <= 0 || totalReturnRate <= 0) {
                return;
            }

            // 難易度設定を取得
            const difficultySettings = getDifficultySettings(difficulty);
            
            // 難易度情報を表示
            document.getElementById('difficultyInfo').innerHTML = `
                <strong>${difficultySettings.name}</strong><br>
                ${difficultySettings.description}
            `;

            // 基本計算
            const totalValue = packPrice * totalPacks;
            const targetReturnValue = totalValue * totalReturnRate;

            // オリパ提供価値表示
            document.getElementById('totalValue').textContent = `¥${totalValue.toLocaleString()}`;

            // 景品総価値計算（ポイント還元価値）
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // 景品総仕入れ価格計算
            const prizesTotalPurchasePrice = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);

            // 実質還元率計算（仕入れ価格ベース）
            const realReturnRate = totalValue > 0 ? (prizesTotalPurchasePrice / totalValue) * 100 : 0;

            // ハズレ計算（難易度に応じた配分）
            const lossCount = totalPacks - prizesTotalCount;
            const lossValue = targetReturnValue - prizesTotalValue;

            const lossTypes = [];

            if (lossCount > 0 && lossValue > 0) {
                // 難易度に応じた配分比率を使用
                const distribution = difficultySettings.lossDistribution;
                
                // 各ハズレタイプの枚数を計算
                const lossCounts = [];
                let allocated = 0;
                
                // 各タイプの基本配分を計算
                for (let i = 0; i < lossTypeCount; i++) {
                    const ratio = distribution[i] || distribution[distribution.length - 1];
                    const count = Math.floor(lossCount * ratio);
                    lossCounts.push(count);
                    allocated += count;
                }
                
                // 残り枚数を均等に配分
                let remaining = lossCount - allocated;
                let index = 0;
                while (remaining > 0) {
                    lossCounts[index % lossTypeCount]++;
                    remaining--;
                    index++;
                }

                // 最低保証価値（難易度補正）
                const adjustedMinValue = roundToTens(minGuaranteeValue * difficultySettings.minValueMultiplier);

                // 最低保証の総価値
                const minTotalValue = adjustedMinValue * lossCounts[lossTypeCount - 1];

                // 残りの価値を他のハズレに配分
                const remainingValue = lossValue - minTotalValue;
                const remainingTypes = lossTypeCount - 1;

                for (let i = 0; i < remainingTypes; i++) {
                    const count = lossCounts[i];
                    if (count > 0) {
                        // 難易度に応じた価値配分
                        let valueRatio;
                        if (difficulty === 'easy') {
                            // 易しい：高還元ハズレを多めに
                            valueRatio = (remainingTypes - i + 2) / (remainingTypes + 2);
                        } else if (difficulty === 'hard') {
                            // 厳しい：高還元ハズレを少なめに
                            valueRatio = Math.pow((remainingTypes - i) / remainingTypes, 2);
                        } else {
                            // 普通：標準的な配分
                            valueRatio = (remainingTypes - i) / remainingTypes;
                        }
                        
                        let value = remainingValue * valueRatio / count;
                        
                        // 難易度に応じた最大値制限
                        const maxValue = packPrice * difficultySettings.maxValueCap;
                        value = Math.min(value, maxValue);
                        
                        // キリの良い数に丸める
                        value = roundToTens(value);
                        
                        lossTypes.push({
                            name: `ハズレ${String.fromCharCode(65 + i)}`,
                            value: value,
                            count: count,
                            type: 'normal'
                        });
                    }
                }

                // 最低保証を追加
                lossTypes.push({
                    name: `ハズレ${String.fromCharCode(65 + remainingTypes)}（最低保証）`,
                    value: adjustedMinValue,
                    count: lossCounts[lossTypeCount - 1],
                    type: 'min'
                });
            }

            // 期待値計算
            let expectedValue = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (prize.value * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                expectedValue += loss.value * probability;
            });

            // 標準偏差計算
            let variance = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (Math.pow(prize.value - expectedValue, 2) * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                variance += Math.pow(loss.value - expectedValue, 2) * probability;
            });
            
            const stdDev = Math.sqrt(variance);

            // 結果表示更新
            updateResults({
                totalReturnRatePercent,
                realReturnRate,
                expectedValue,
                stdDev,
                lossTypes,
                lossCount,
                totalPacks,
                packPrice
            });
        }

        // 結果表示更新
        function updateResults(data) {
            document.getElementById('summaryTotalReturn').textContent = `${data.totalReturnRatePercent.toFixed(1)}%`;
            document.getElementById('summaryRealReturn').textContent = `${data.realReturnRate.toFixed(1)}%`;
            document.getElementById('summaryExpectedValue').textContent = `¥${data.expectedValue.toLocaleString()}`;
            document.getElementById('summaryStdDev').textContent = `¥${data.stdDev.toLocaleString()}`;
            
            // 総当選者数を表示
            const totalWinners = prizes.reduce((sum, prize) => sum + prize.count, 0);
            document.getElementById('summaryWinnerCount').textContent = `${totalWinners}人`;

            // 景品詳細更新
            updatePrizeDetails();

            // ハズレ詳細更新
            updateLossDetails(data.lossTypes, data.lossCount);
            
            // ハズレ分布チャート更新
            drawLossDistributionChart(data.lossTypes);

            // 理論期待値（1-20回）更新
            updateExpectedValues(data.expectedValue, data.stdDev);
            
            // 期待値シミュレーション更新
            updateSimulationTables(data.expectedValue, data.stdDev, data.packPrice);
        }

        // 景品詳細更新
        function updatePrizeDetails() {
            const container = document.getElementById('prizeDetails');
            
            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">景品を追加してください</p>';
                return;
            }

            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            
            container.innerHTML = prizes.map(prize => {
                const probability = totalPacks > 0 ? (prize.count / totalPacks * 100).toFixed(2) : '0.00';
                return `
                    <div class="result-row">
                        <span class="result-label">${prize.rank}等 ${prize.name}</span>
                        <span class="result-value">${probability}% (仕入¥${prize.purchasePrice.toLocaleString()} / 還元¥${prize.value.toLocaleString()})</span>
                    </div>
                `;
            }).join('');
        }

        // ハズレ詳細更新
        function updateLossDetails(lossTypes, lossCount) {
            const container = document.getElementById('lossDetailsContainer');
            
            if (!lossTypes || lossTypes.length === 0) {
                container.innerHTML = '<div class="result-row"><span class="result-label">ハズレなし</span><span class="result-value">-</span></div>';
                document.getElementById('totalLossCount').textContent = '0枚';
                return;
            }

            container.innerHTML = lossTypes.map(loss => {
                const probability = lossCount > 0 ? ((loss.count / lossCount) * 100).toFixed(1) : '0.0';
                return `
                    <div class="result-row">
                        <span class="result-label">${loss.name}</span>
                        <span class="result-value">¥${loss.value.toLocaleString()} × ${loss.count}枚 (${probability}%)</span>
                    </div>
                `;
            }).join('');

            document.getElementById('totalLossCount').textContent = `${lossCount}枚`;
        }

        // 理論期待値更新
        function updateExpectedValues(expectedValue, stdDev) {
            const container = document.getElementById('expectedValues');
            
            let html = '';
            const chartData = [];
            for (let i = 1; i <= 20; i++) {
                const ev = expectedValue * i;
                const risk = stdDev * Math.sqrt(i);
                chartData.push({ count: i, value: ev, risk: risk });
                html += `
                    <div class="ev-item">
                        <div class="ev-count">${i}回</div>
                        <div class="ev-value">¥${ev.toLocaleString()}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // チャートを描画
            drawExpectedValueChart(chartData);
        }

        // 理論期待値チャート描画
        function drawExpectedValueChart(data) {
            const canvas = document.getElementById('expectedValueChart');
            const ctx = canvas.getContext('2d');
            
            // キャンバスをクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (data.length === 0) return;
            
            const padding = 40;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            // データの最大値を取得
            const maxValue = Math.max(...data.map(d => d.value));
            const maxCount = Math.max(...data.map(d => d.count));
            
            // スケール計算
            const xScale = width / (maxCount - 1);
            const yScale = height / maxValue;
            
            // グリッド線を描画
            ctx.strokeStyle = '#E5E5EA';
            ctx.lineWidth = 1;
            
            // 縦のグリッド線
            for (let i = 0; i < 21; i += 5) {
                const x = padding + (i - 1) * xScale;
                if (x >= padding && x <= canvas.width - padding) {
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, canvas.height - padding);
                    ctx.stroke();
                }
            }
            
            // 横のグリッド線
            for (let i = 0; i <= 5; i++) {
                const y = canvas.height - padding - (maxValue / 5 * i) * yScale;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }
            
            // 期待値ライン（ブルー）
            ctx.strokeStyle = '#007AFF';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            data.forEach((point, index) => {
                const x = padding + (point.count - 1) * xScale;
                const y = canvas.height - padding - point.value * yScale;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // データポイントを描画
            ctx.fillStyle = '#007AFF';
            data.forEach(point => {
                const x = padding + (point.count - 1) * xScale;
                const y = canvas.height - padding - point.value * yScale;
                
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // ラベルを描画
            ctx.fillStyle = '#8E8E93';
            ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            
            // X軸ラベル（回数）
            for (let i = 1; i <= 20; i += 5) {
                const x = padding + (i - 1) * xScale;
                ctx.fillText(i + '回', x, canvas.height - 5);
            }
            
            // Y軸ラベル（金額）
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = maxValue / 5 * i;
                const y = canvas.height - padding - value * yScale;
                ctx.fillText('¥' + value.toLocaleString(), padding - 10, y + 4);
            }
            
            // チャートタイトル
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('回数別理論期待値', canvas.width / 2, 20);
        }

        // ハズレ当選者分布チャート描画
        function drawLossDistributionChart(lossTypes) {
            const canvas = document.getElementById('lossDistributionChart');
            const ctx = canvas.getContext('2d');
            
            // キャンバスをクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!lossTypes || lossTypes.length === 0) {
                ctx.fillStyle = '#8E8E93';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ハズレなし', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const padding = 40;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF'];
            const total = lossTypes.reduce((sum, loss) => sum + loss.count, 0);
            
            if (total === 0) return;
            
            // 棒グラフとして描画
            const barWidth = width / lossTypes.length * 0.8;
            const barSpacing = width / lossTypes.length * 0.2;
            const maxCount = Math.max(...lossTypes.map(loss => loss.count));
            
            lossTypes.forEach((loss, index) => {
                const x = padding + index * (barWidth + barSpacing) + barSpacing / 2;
                const barHeight = (loss.count / maxCount) * height;
                const y = canvas.height - padding - barHeight;
                
                // 棒を描画
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // 枚数を表示
                ctx.fillStyle = '#000000';
                ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(loss.count + '枚', x + barWidth / 2, y - 5);
                
                // 名前を表示
                ctx.fillText(loss.name, x + barWidth / 2, canvas.height - 10);
                
                // 割合を表示
                const percentage = ((loss.count / total) * 100).toFixed(1);
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(percentage + '%', x + barWidth / 2, y + barHeight / 2);
            });
            
            // チャートタイトル
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ハズレ当選者分布', canvas.width / 2, 20);
        }

        // 正規分布の累積分布関数（近似）
        function normalCDF(x, mean, stdDev) {
            const z = (x - mean) / stdDev;
            const a1 = 0.254829592;
            const a2 = -0.284496736;
            const a3 = 1.421413741;
            const a4 = -1.453152027;
            const a5 = 1.061405429;
            const p = 0.3275911;
            
            const sign = z < 0 ? -1 : 1;
            const absZ = Math.abs(z);
            const t = 1.0 / (1.0 + p * absZ);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-absZ * absZ);
            
            return 0.5 * (1.0 + sign * y);
        }

        // 期待値シミュレーションテーブル更新
        function updateSimulationTables(expectedValue, stdDev, packPrice) {
            updateProfitLossTable(expectedValue, stdDev, packPrice);
            updateMultiplierTable(expectedValue, stdDev, packPrice);
        }

        // 収支確率テーブル更新
        function updateProfitLossTable(expectedValue, stdDev, packPrice) {
            const container = document.getElementById('profitLossTable');
            
            let html = `
                <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 8px; align-items: center; font-weight: 500; border-bottom: 2px solid var(--sf-gray-5); padding-bottom: 8px; margin-bottom: 12px;">
                    <span>回数</span>
                    <span style="color: var(--sf-green);">プラス確率</span>
                    <span style="color: var(--sf-red);">マイナス確率</span>
                </div>
            `;

            for (let n = 1; n <= 20; n++) {
                const investment = packPrice * n;
                const expectedReturn = expectedValue * n;
                const stdDevN = stdDev * Math.sqrt(n);
                
                // プラス確率（回収額 > 投入額）
                const profitProb = 1 - normalCDF(investment, expectedReturn, stdDevN);
                // マイナス確率（回収額 < 投入額）
                const lossProb = normalCDF(investment, expectedReturn, stdDevN);
                
                html += `
                    <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 8px; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--sf-gray-6);">
                        <span style="font-weight: 600;">${n}回</span>
                        <span style="color: var(--sf-green); font-weight: 600;">${(profitProb * 100).toFixed(1)}%</span>
                        <span style="color: var(--sf-red); font-weight: 600;">${(lossProb * 100).toFixed(1)}%</span>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // 倍率確率テーブル更新
        function updateMultiplierTable(expectedValue, stdDev, packPrice) {
            const container = document.getElementById('multiplierTable');
            
            let html = `
                <div style="display: grid; grid-template-columns: auto 1fr 1fr 1fr 1fr; gap: 8px; align-items: center; font-weight: 500; border-bottom: 2px solid var(--sf-gray-5); padding-bottom: 8px; margin-bottom: 12px;">
                    <span>回数</span>
                    <span style="color: var(--sf-purple);">5倍以上</span>
                    <span style="color: var(--sf-blue);">3倍以上</span>
                    <span style="color: var(--sf-orange);">2倍以上</span>
                    <span style="color: var(--sf-green);">1倍以上</span>
                </div>
            `;

            for (let n = 1; n <= 20; n++) {
                const investment = packPrice * n;
                const expectedReturn = expectedValue * n;
                const stdDevN = stdDev * Math.sqrt(n);
                
                // 各倍率以上になる確率
                const prob5x = 1 - normalCDF(investment * 5, expectedReturn, stdDevN);
                const prob3x = 1 - normalCDF(investment * 3, expectedReturn, stdDevN);
                const prob2x = 1 - normalCDF(investment * 2, expectedReturn, stdDevN);
                const prob1x = 1 - normalCDF(investment * 1, expectedReturn, stdDevN);
                
                html += `
                    <div style="display: grid; grid-template-columns: auto 1fr 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--sf-gray-6);">
                        <span style="font-weight: 600;">${n}回</span>
                        <span style="color: var(--sf-purple); font-weight: 600;">${(prob5x * 100).toFixed(1)}%</span>
                        <span style="color: var(--sf-blue); font-weight: 600;">${(prob3x * 100).toFixed(1)}%</span>
                        <span style="color: var(--sf-orange); font-weight: 600;">${(prob2x * 100).toFixed(1)}%</span>
                        <span style="color: var(--sf-green); font-weight: 600;">${(prob1x * 100).toFixed(1)}%</span>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // 履歴保存
        function saveToHistory() {
            const name = document.getElementById('historyName').value.trim();
            
            if (!name) {
                alert('設定名を入力してください');
                return;
            }

            const settings = {
                id: Date.now(),
                name: name,
                date: new Date().toLocaleString('ja-JP'),
                packPrice: document.getElementById('packPrice').value,
                totalPacks: document.getElementById('totalPacks').value,
                totalReturnRate: document.getElementById('totalReturnRate').value,
                lossTypeCount: document.getElementById('lossTypeCount').value,
                minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
                gachaDifficulty: document.getElementById('gachaDifficulty').value,
                prizes: [...prizes]
            };

            history.unshift(settings);
            document.getElementById('historyName').value = '';
            
            updateHistoryList();
            saveData();
        }

        // 履歴から読み込み
        function loadFromHistory(id) {
            const settings = history.find(h => h.id === id);
            if (!settings) return;

            document.getElementById('packPrice').value = settings.packPrice;
            document.getElementById('totalPacks').value = settings.totalPacks;
            document.getElementById('totalReturnRate').value = settings.totalReturnRate;
            if (settings.lossTypeCount) document.getElementById('lossTypeCount').value = settings.lossTypeCount;
            if (settings.minGuaranteeValue) document.getElementById('minGuaranteeValue').value = settings.minGuaranteeValue;
            if (settings.gachaDifficulty) document.getElementById('gachaDifficulty').value = settings.gachaDifficulty;
            prizes = [...settings.prizes];

            updatePrizeList();
            calculate();
        }

        // 履歴削除
        function removeFromHistory(id) {
            if (confirm('この履歴を削除しますか？')) {
                history = history.filter(h => h.id !== id);
                updateHistoryList();
                saveData();
            }
        }

        // 履歴リスト更新
        function updateHistoryList() {
            const container = document.getElementById('historyList');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; padding: 20px 0;">保存済みの設定はありません</p>';
                return;
            }

            container.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadFromHistory(${item.id})">
                    <div class="history-name">${item.name}</div>
                    <div class="history-meta">${item.date}</div>
                    <button class="btn btn-danger" onclick="event.stopPropagation(); removeFromHistory(${item.id})" style="float: right; margin-top: -30px;">削除</button>
                </div>
            `).join('');
        }

        // データ保存
        function saveData() {
            const data = {
                prizes: prizes,
                history: history,
                settings: {
                    packPrice: document.getElementById('packPrice').value,
                    totalPacks: document.getElementById('totalPacks').value,
                    totalReturnRate: document.getElementById('totalReturnRate').value,
                    lossTypeCount: document.getElementById('lossTypeCount').value,
                    minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
                    gachaDifficulty: document.getElementById('gachaDifficulty').value
                }
            };

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('保存に失敗しました:', e);
            }
        }

        // データ読み込み
        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.prizes) {
                        prizes = data.prizes;
                        updatePrizeList();
                    }
                    
                    if (data.history) {
                        history = data.history;
                        updateHistoryList();
                    }

                    if (data.settings) {
                        document.getElementById('packPrice').value = data.settings.packPrice || '40,000';
                        document.getElementById('totalPacks').value = data.settings.totalPacks || '100';
                        document.getElementById('totalReturnRate').value = data.settings.totalReturnRate || 98;
                        document.getElementById('lossTypeCount').value = data.settings.lossTypeCount || 2;
                        document.getElementById('minGuaranteeValue').value = data.settings.minGuaranteeValue || '1,000';
                        document.getElementById('gachaDifficulty').value = data.settings.gachaDifficulty || 'normal';
                    }
                }
            } catch (e) {
                console.error('データの読み込みに失敗しました:', e);
            }
        }

        // モーダル関連
        function showModal() {
            document.getElementById('historyModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('historyModal').classList.remove('show');
        }

        function confirmSaveHistory() {
            const name = document.getElementById('modalHistoryName').value.trim();
            if (name) {
                document.getElementById('historyName').value = name;
                saveToHistory();
                closeModal();
                document.getElementById('modalHistoryName').value = '';
            }
        }

        // 設定エクスポート
        function exportSettings() {
            const exportData = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                currentSettings: {
                    packPrice: document.getElementById('packPrice').value,
                    totalPacks: document.getElementById('totalPacks').value,
                    totalReturnRate: document.getElementById('totalReturnRate').value,
                    lossTypeCount: document.getElementById('lossTypeCount').value,
                    minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
                    gachaDifficulty: document.getElementById('gachaDifficulty').value,
                    prizes: [...prizes]
                },
                history: [...history]
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            const now = new Date();
            const dateTime = now.toISOString().slice(0, 19).replace(/:/g, '-');
            link.download = `oripa-settings-${dateTime}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('設定をエクスポートしました！\nダウンロードしたJSONファイルを他のブラウザでインポートできます。');
        }

        // 設定インポート
        function importSettings() {
            document.getElementById('importFile').click();
        }

        // ファイルインポート処理
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/json') {
                alert('JSONファイルを選択してください');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // バージョンチェック
                    if (!importData.version) {
                        alert('古いバージョンの設定ファイルです。インポートできません。');
                        return;
                    }

                    // 確認ダイアログ
                    const confirmMessage = `設定をインポートしますか？\n\n` +
                        `- エクスポート日時: ${new Date(importData.exportDate).toLocaleString('ja-JP')}\n` +
                        `- 履歴件数: ${importData.history ? importData.history.length : 0}件\n` +
                        `- 景品数: ${importData.currentSettings.prizes ? importData.currentSettings.prizes.length : 0}個\n\n` +
                        `※ 現在の設定と履歴は上書きされます`;

                    if (!confirm(confirmMessage)) {
                        return;
                    }

                    // 現在の設定を復元
                    if (importData.currentSettings) {
                        const settings = importData.currentSettings;
                        document.getElementById('packPrice').value = settings.packPrice || '40,000';
                        document.getElementById('totalPacks').value = settings.totalPacks || '100';
                        document.getElementById('totalReturnRate').value = settings.totalReturnRate || 98;
                        if (settings.lossTypeCount) document.getElementById('lossTypeCount').value = settings.lossTypeCount;
                        if (settings.minGuaranteeValue) document.getElementById('minGuaranteeValue').value = settings.minGuaranteeValue;
                        if (settings.gachaDifficulty) document.getElementById('gachaDifficulty').value = settings.gachaDifficulty;
                        
                        // 景品データを復元
                        if (settings.prizes) {
                            prizes = [...settings.prizes];
                            updatePrizeList();
                        }
                    }

                    // 履歴を復元
                    if (importData.history) {
                        history = [...importData.history];
                        updateHistoryList();
                    }

                    // データを保存
                    saveData();
                    
                    // 再計算
                    calculate();

                    alert('設定を正常にインポートしました！');

                } catch (error) {
                    console.error('インポートエラー:', error);
                    alert('設定ファイルの読み込みに失敗しました。\nファイルが破損している可能性があります。');
                }
            };

            reader.readAsText(file);
            
            // ファイル選択をリセット
            event.target.value = '';
        }

        // キーボードイベント
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
