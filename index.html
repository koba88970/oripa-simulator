<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オリパ設計シミュレーター v3.0</title>
    <style>
        :root {
            --sf-blue: #007AFF;
            --sf-orange: #FF9500;
            --sf-green: #34C759;
            --sf-red: #FF3B30;
            --sf-purple: #AF52DE;
            --sf-gray: #8E8E93;
            --sf-gray-2: #AEAEB2;
            --sf-gray-3: #C7C7CC;
            --sf-gray-4: #D1D1D6;
            --sf-gray-5: #E5E5EA;
            --sf-gray-6: #F2F2F7;
            --sf-white: #FFFFFF;
            --sf-black: #000000;
            --shadow-light: 0 2px 20px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.15);
            --border-radius: 16px;
            --border-radius-small: 12px;
            --transition: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #F2F2F7 0%, #FFFFFF 100%);
            min-height: 100vh;
            letter-spacing: -0.01em;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            color: var(--sf-black);
            text-align: center;
            margin-bottom: 32px;
            font-size: 2.2em;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .version-badge {
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 16px;
            vertical-align: middle;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 32px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--sf-gray-5);
            box-shadow: var(--shadow-light);
            transition: all 0.3s var(--transition);
        }

        .panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .panel h2 {
            margin: 0 0 20px 0;
            color: var(--sf-black);
            border-bottom: 2px solid var(--sf-blue);
            padding-bottom: 12px;
            font-size: 1.3em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--sf-black);
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            font-size: 15px;
            font-weight: 400;
            background: var(--sf-white);
            transition: all 0.3s var(--transition);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--sf-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-group input.error {
            border-color: var(--sf-red);
            background-color: rgba(255, 59, 48, 0.05);
        }

        .form-group input.error:focus {
            border-color: var(--sf-red);
            box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.1);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .calculated-value {
            background: rgba(52, 199, 89, 0.1);
            color: var(--sf-green);
            padding: 12px 16px;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(52, 199, 89, 0.3);
        }

        .prize-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .prize-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            padding: 16px;
            position: relative;
            transition: all 0.3s var(--transition);
        }

        .prize-item:hover {
            border-color: var(--sf-blue);
            transform: translateY(-1px);
        }

        .prize-rank {
            position: absolute;
            top: -8px;
            left: 12px;
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .prize-rank.rank-1 { background: #FFD700; color: var(--sf-black); }
        .prize-rank.rank-2 { background: #C0C0C0; color: var(--sf-black); }
        .prize-rank.rank-3 { background: #CD7F32; color: var(--sf-white); }
        .prize-rank.rank-4 { background: var(--sf-green); }
        .prize-rank.rank-5 { background: var(--sf-purple); }

        .prize-content {
            margin-top: 8px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .prize-name {
            font-weight: 500;
            color: var(--sf-black);
        }

        .prize-value, .prize-count, .prize-purchase {
            font-size: 12px;
            color: var(--sf-gray);
            text-align: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius-small);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--transition);
        }

        .btn-primary {
            background: var(--sf-blue);
            color: var(--sf-white);
        }

        .btn-primary:hover {
            background: #0051D5;
            transform: scale(1.05);
        }

        .btn-danger {
            background: var(--sf-red);
            color: var(--sf-white);
        }

        .btn-danger:hover {
            background: #E6342A;
            transform: scale(1.05);
        }

        .btn-success {
            background: var(--sf-green);
            color: var(--sf-white);
            width: 100%;
            padding: 12px;
            font-size: 14px;
            margin-top: 16px;
        }

        .btn-success:hover {
            background: #248A3D;
        }
        .btn-accent {
            background: var(--sf-orange);
            color: var(--sf-white);
        }
        .btn-accent:hover {
            background: #E6742A;
            transform: scale(1.05);
        }
        
        /* ガチャ体験スタイル */
        .gacha-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .gacha-btn {
            flex: 1;
            min-width: 120px;
            font-weight: 600;
        }
        .gacha-results {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            padding: 20px;
            margin-top: 20px;
        }
        .gacha-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .gacha-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 8px;
        }
        .gacha-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--sf-blue);
        }
        .gacha-stat-label {
            font-size: 0.9em;
            color: var(--sf-gray);
        }
        .gacha-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .gacha-draw-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        .gacha-draw-prize {
            background: linear-gradient(135deg, #34C759, #30D158);
            color: white;
        }
        .gacha-draw-loss {
            background: linear-gradient(135deg, #FF9500, #FF9F0A);
            color: white;
        }

        .add-prize-form {
            background: rgba(0, 122, 255, 0.05);
            border: 1px dashed var(--sf-blue);
            border-radius: var(--border-radius-small);
            padding: 20px;
            margin-top: 16px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .result-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--sf-gray-5);
            box-shadow: var(--shadow-light);
            transition: all 0.3s var(--transition);
        }

        .result-panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .result-panel h3 {
            margin: 0 0 16px 0;
            color: var(--sf-black);
            border-bottom: 2px solid var(--sf-green);
            padding-bottom: 8px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--sf-gray-5);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: var(--sf-black);
        }

        .result-value {
            color: var(--sf-gray);
            font-weight: 600;
        }

        .highlight {
            background: rgba(255, 149, 0, 0.15);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 149, 0, 0.3);
            color: var(--sf-orange);
            font-weight: 600;
        }

        .loss-panel {
            background: rgba(255, 149, 0, 0.08);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        .loss-panel h3 {
            border-bottom-color: var(--sf-orange);
        }

        .expected-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .ev-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 8px;
            font-size: 12px;
        }

        .ev-count {
            font-weight: 600;
            color: var(--sf-blue);
        }

        .ev-value {
            color: var(--sf-gray);
            font-size: 11px;
        }

        .history-panel {
            background: rgba(175, 82, 222, 0.08);
            border: 1px solid rgba(175, 82, 222, 0.2);
        }

        .history-panel h2 {
            border-bottom-color: var(--sf-purple);
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s var(--transition);
        }

        .history-item:hover {
            background: rgba(175, 82, 222, 0.1);
            transform: translateX(4px);
        }

        .history-name {
            font-weight: 500;
            color: var(--sf-black);
        }

        .history-meta {
            font-size: 12px;
            color: var(--sf-gray);
        }

        .warning {
            background: rgba(255, 59, 48, 0.1);
            color: var(--sf-red);
            padding: 16px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 59, 48, 0.2);
            margin-top: 24px;
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--sf-white);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 500px;
            width: 90%;
        }

        .modal h3 {
            margin: 0 0 20px 0;
            color: var(--sf-black);
        }

        .close-btn {
            background: var(--sf-gray-4);
            color: var(--sf-black);
        }

        .close-btn:hover {
            background: var(--sf-gray-3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>オリパ設計シミュレーター <span class="version-badge">v2.0</span></h1>
        
        <div class="main-grid">
            <div class="left-panel">
                <!-- 基本設定 -->
                <div class="panel">
                    <h2>基本設定</h2>
                    <div class="form-group">
                        <label>パック単価 (円)</label>
                        <input type="number" id="packPrice" value="40000">
                    </div>
                    <div class="form-group">
                        <label>総口数</label>
                        <input type="number" id="totalPacks" value="100">
                    </div>
                    <div class="form-group">
                        <label>総還元率 (%)</label>
                        <input type="number" id="totalReturnRate" value="98" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>オリパ提供価値</label>
                        <div class="calculated-value" id="totalValue">¥0</div>
                    </div>
                    <button class="btn btn-success" onclick="calculate()" style="width: 100%; margin-top: 16px; font-size: 16px; padding: 14px;">
                        🧮 計算する
                    </button>
                </div>

                <!-- ハズレ設計 -->
                <div class="panel">
                    <h2>ハズレ設計</h2>
                    <div class="form-group">
                        <label>ガチャ難易度</label>
                        <select id="gachaDifficulty" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                            <option value="easy">😊 比較的当たりやすい</option>
                            <option value="normal" selected>😐 普通</option>
                            <option value="hard">😤 当たりにくい</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ハズレの種類数</label>
                        <select id="lossTypeCount" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                            <option value="2">2種類</option>
                            <option value="3">3種類</option>
                            <option value="4">4種類</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>最低保証価値 (円)</label>
                        <input type="number" id="minGuaranteeValue" value="1000">
                    </div>
                    <div class="difficulty-info" id="difficultyInfo" style="background: rgba(0, 122, 255, 0.1); padding: 12px; border-radius: 8px; font-size: 13px; margin-top: 12px;">
                        <!-- 難易度説明がここに表示されます -->
                    </div>
                </div>

                <!-- 景品管理 -->
                <div class="panel">
                    <h2>景品管理</h2>
                    <div class="prize-list" id="prizeList">
                        <!-- 景品リストがここに表示されます -->
                    </div>
                    
                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>景品名</label>
                            <input type="text" id="prizeName" placeholder="例: レアカード">
                        </div>
                        <div class="form-group">
                            <label>等級</label>
                            <select id="prizeRank" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                                <option value="1">1等</option>
                                <option value="2">2等</option>
                                <option value="3">3等</option>
                                <option value="4">4等</option>
                                <option value="5">5等</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>仕入れ価格</label>
                                <input type="text" id="prizePurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this)">
                            </div>
                            <div class="form-group">
                                <label>ポイント還元価値</label>
                                <input type="text" id="prizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>在庫数</label>
                            <input type="number" id="prizeCount" min="1" value="1">
                        </div>
                        <button class="btn btn-success" onclick="addPrize()">景品を追加</button>
                    </div>
                </div>

                <!-- 履歴管理 -->
                <div class="panel history-panel">
                    <h2>シミュレーション履歴</h2>
                    <div class="form-group">
                        <input type="text" id="historyName" placeholder="設定名を入力 (例: 新商品A案)">
                        <button class="btn btn-primary" onclick="saveToHistory()" style="width: 100%; margin-top: 8px;">現在の設定を保存</button>
                    </div>
                    <div class="history-list" id="historyList">
                        <!-- 履歴がここに表示されます -->
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;">
                        <button class="btn btn-success" onclick="exportSettings()" style="padding: 8px 12px; font-size: 12px;">
                            💾 設定をエクスポート
                        </button>
                        <button class="btn btn-primary" onclick="importSettings()" style="padding: 8px 12px; font-size: 12px;">
                            📂 設定をインポート
                        </button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
                </div>
            </div>

            <div class="results-grid">
                <!-- サマリー -->
                <div class="result-panel">
                    <h3>サマリー</h3>
                    <div class="result-row">
                        <span class="result-label">総還元率</span>
                        <span class="result-value" id="summaryTotalReturn">98.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">実質還元率</span>
                        <span class="result-value highlight" id="summaryRealReturn">0.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">理論期待値</span>
                        <span class="result-value" id="summaryExpectedValue">¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">標準偏差</span>
                        <span class="result-value" id="summaryStdDev">¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">総当選者数</span>
                        <span class="result-value" id="summaryWinnerCount">0人</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">総仕入れ額</span>
                        <span class="result-value" id="summaryTotalPurchase">¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">当たり景品還元総額</span>
                        <span class="result-value" id="summaryPrizeTotalReward">¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ハズレ還元総額</span>
                        <span class="result-value" id="summaryLossTotalReward">¥0</span>
                    </div>
                </div>

                <!-- 景品詳細 -->
                <div class="result-panel">
                    <h3>景品詳細</h3>
                    <div id="prizeDetails">
                        <p style="color: var(--sf-gray); text-align: center;">景品を追加してください</p>
                    </div>
                </div>

                <!-- ハズレ詳細 -->
                <div class="result-panel loss-panel">
                    <h3>ハズレ詳細（自動計算）</h3>
                    <div id="lossDetailsContainer">
                        <!-- ハズレ詳細がここに動的に表示されます -->
                    </div>
                    <div class="result-row">
                        <span class="result-label">ハズレ総枚数</span>
                        <span class="result-value" id="totalLossCount">0枚</span>
                    </div>
                </div>

                <!-- ハズレ当選者分布 -->
                <div class="result-panel">
                    <h3>ハズレ当選者分布</h3>
                    <div class="chart-container">
                        <canvas id="lossDistributionChart" width="400" height="200"></canvas>
                    </div>
                </div>




                <!-- ガチャ体験 -->
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <h3>🎮 ガチャ体験</h3>
                    <p style="color: var(--sf-gray); font-size: 14px; margin-bottom: 20px;">
                        実際にオリパを引いて、設計したガチャの体験を確認できます
                    </p>
                    
                    <!-- ガチャボタン -->
                    <div class="gacha-controls">
                        <button class="btn btn-primary gacha-btn" onclick="drawGacha(1)">
                            🎲 1回引く
                        </button>
                        <button class="btn btn-secondary gacha-btn" onclick="drawGacha(10)">
                            🎲 10回引く
                        </button>
                        <button class="btn btn-accent gacha-btn" onclick="drawGacha(100)">
                            🎲 100回引く
                        </button>
                        <button class="btn btn-danger gacha-btn" onclick="resetGacha()" id="resetGachaBtn" style="display: none;">
                            🔄 リセット
                        </button>
                    </div>
                    
                    <!-- ガチャ結果 -->
                    <div id="gachaResults" class="gacha-results" style="display: none;">
                        <h4>ガチャ結果</h4>
                        <div id="gachaStats" class="gacha-stats"></div>
                        <div id="gachaHistory" class="gacha-history"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="warnings"></div>
    </div>

    <!-- モーダル -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <h3>設定名を入力</h3>
            <div class="form-group">
                <input type="text" id="modalHistoryName" placeholder="設定名を入力してください">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmSaveHistory()">保存</button>
                <button class="btn close-btn" onclick="closeModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let prizes = [];
        let history = [];

        // ローカルストレージのキー
        const STORAGE_KEY = 'oripa_simulator_v2';

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            attachEventListeners();
            updateTotalValue();
        });

        // イベントリスナー設定
        function attachEventListeners() {
            // オリパ提供価値のリアルタイム更新のみ
            document.getElementById('packPrice').addEventListener('input', updateTotalValue);
            document.getElementById('totalPacks').addEventListener('input', updateTotalValue);
            // 他の項目は手動計算に変更
        }

        // オリパ提供価値の更新（エラーチェックなし）
        function updateTotalValue() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalValue = packPrice * totalPacks;
            document.getElementById('totalValue').textContent = `¥${totalValue.toLocaleString()}`;

            // エラー状態をリセット（入力中はエラー表示しない）
            document.getElementById('packPrice').classList.remove('error');
            document.getElementById('totalPacks').classList.remove('error');
            document.getElementById('totalReturnRate').classList.remove('error');
        }

        // ポイント還元価値のフォーマット
        function formatPrizeValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // 数字以外を除去
            if (value) {
                value = parseInt(value).toLocaleString(); // カンマ区切りに変換
            }
            input.value = value;
        }

        // 基本設定値のフォーマット
        function formatBasicValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // 数字以外を除去
            if (value) {
                value = parseInt(value).toLocaleString(); // カンマ区切りに変換
            }
            input.value = value;
            // オリパ提供価値のみ更新
            setTimeout(updateTotalValue, 100);
        }

        // カンマ区切りの数字を数値に変換
        function parseFormattedNumber(value) {
            return parseFloat(value.replace(/,/g, '')) || 0;
        }

        // 景品追加
        function addPrize() {
            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const purchasePrice = parseFormattedNumber(document.getElementById('prizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || purchasePrice <= 0 || value <= 0 || count <= 0) {
                alert('すべての項目を正しく入力してください');
                return;
            }

            const prize = {
                id: Date.now(),
                name: name,
                rank: rank,
                purchasePrice: purchasePrice,
                value: value,
                count: count
            };

            prizes.push(prize);

            // フォームリセット
            document.getElementById('prizeName').value = '';
            document.getElementById('prizePurchasePrice').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';

            updatePrizeList();
            saveData();
        }

        // 景品削除
        function removePrize(id) {
            prizes = prizes.filter(p => p.id !== id);
            updatePrizeList();
            saveData();
        }

        // 景品リスト更新
        function updatePrizeList() {
            const container = document.getElementById('prizeList');
            
            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">景品を追加してください</p>';
                return;
            }

            // 等級順にソート
            prizes.sort((a, b) => a.rank - b.rank);

            container.innerHTML = prizes.map(prize => `
                <div class="prize-item">
                    <div class="prize-rank rank-${prize.rank}">${prize.rank}等</div>
                    <div class="prize-content">
                        <div class="prize-name">${prize.name}</div>
                        <div class="prize-purchase">仕入¥${prize.purchasePrice.toLocaleString()}</div>
                        <div class="prize-value">還元¥${prize.value.toLocaleString()}</div>
                        <div class="prize-count">${prize.count}枚</div>
                        <button class="btn btn-danger" onclick="removePrize(${prize.id})">削除</button>
                    </div>
                </div>
            `).join('');
        }

        // 値を10の位で丸める（1桁を0にする）
        function roundToTens(value) {
            return Math.round(value / 10) * 10;
        }

        // ガチャ難易度設定を取得
        function getDifficultySettings(difficulty) {
            switch(difficulty) {
                case 'easy':
                    return {
                        name: '比較的当たりやすい',
                        description: 'ハズレの価値が高めで、ユーザーフレンドリーな設計',
                        lossDistribution: [0.4, 0.35, 0.25], // 高還元重視
                        maxValueCap: 0.8 // パック単価の80%まで
                    };
                case 'hard':
                    return {
                        name: '当たりにくい',
                        description: 'ハズレの価値が低めで、大当たり重視の設計',
                        lossDistribution: [0.15, 0.35, 0.5], // 低還元重視
                        maxValueCap: 0.5 // パック単価の50%まで
                    };
                default: // normal
                    return {
                        name: '普通',
                        description: 'バランスの良い標準的な設計',
                        lossDistribution: [0.2, 0.5, 0.3], // バランス重視
                        maxValueCap: 0.7 // パック単価の70%まで
                    };
            }
        }

        // メイン計算
        function calculate() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalReturnRatePercent = parseFloat(document.getElementById('totalReturnRate').value) || 0;
            const totalReturnRate = totalReturnRatePercent / 100;
            const lossTypeCount = parseInt(document.getElementById('lossTypeCount').value) || 2;
            const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;
            const difficulty = document.getElementById('gachaDifficulty').value;

            if (packPrice <= 0 || totalPacks <= 0 || totalReturnRate <= 0) {
                return;
            }

            // 設定を検証し、エラーがある場合は処理を停止
            if (!validateSettings()) {
                return;
            }

            // 難易度設定を取得
            const difficultySettings = getDifficultySettings(difficulty);
            
            // 難易度情報を表示
            document.getElementById('difficultyInfo').innerHTML = `
                <strong>${difficultySettings.name}</strong><br>
                ${difficultySettings.description}
            `;

            // 基本計算
            const totalValue = packPrice * totalPacks;
            const targetReturnValue = totalValue * totalReturnRate;

            // オリパ提供価値表示
            document.getElementById('totalValue').textContent = `¥${totalValue.toLocaleString()}`;

            // 景品総価値計算（ポイント還元価値）
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // 景品総仕入れ価格計算
            const prizesTotalPurchasePrice = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);

            // 実質還元率計算（仕入れ価格ベース）
            const realReturnRate = totalValue > 0 ? (prizesTotalPurchasePrice / totalValue) * 100 : 0;

            // ハズレ計算（難易度に応じた配分）
            const lossCount = totalPacks - prizesTotalCount;
            const lossValue = targetReturnValue - prizesTotalValue;

            const lossTypes = [];

            if (lossCount > 0) {
                if (lossValue <= 0) {
                    // lossValueが0以下の場合、段階的な価値でハズレを生成
                    console.log('lossValueが0以下のため、段階的価値でハズレを生成');

                    // 難易度に応じた配分比率を使用
                    const distribution = difficultySettings.lossDistribution;

                    // 各ハズレタイプの枚数を計算
                    const lossCounts = [];
                    let allocated = 0;

                    for (let i = 0; i < lossTypeCount; i++) {
                        const ratio = distribution[i] || distribution[distribution.length - 1];
                        const count = Math.floor(lossCount * ratio);
                        lossCounts.push(count);
                        allocated += count;
                    }

                    let remaining = lossCount - allocated;
                    let index = 0;
                    while (remaining > 0) {
                        lossCounts[index % lossTypeCount]++;
                        remaining--;
                        index++;
                    }

                    // 最低保証価値（ユーザー入力値をそのまま使用）
                    const adjustedMinValue = roundToTens(minGuaranteeValue);

                    // 各ハズレタイプに異なる価値を設定（最低保証より高く）
                    for (let i = 0; i < lossTypeCount; i++) {
                        const count = lossCounts[i];
                        if (count > 0) {
                            let value;
                            if (i === lossTypeCount - 1) {
                                // 最後のタイプは最低保証価値
                                value = adjustedMinValue;
                            } else {
                                // 他のタイプは最低保証より高く、段階的に設定
                                value = adjustedMinValue + (lossTypeCount - 1 - i) * 10;
                            }

                            lossTypes.push({
                                name: i === lossTypeCount - 1 ?
                                    `ハズレ${String.fromCharCode(65 + i)}（最低保証）` :
                                    `ハズレ${String.fromCharCode(65 + i)}`,
                                value: value,
                                count: count,
                                type: i === lossTypeCount - 1 ? 'min' : 'normal'
                            });
                        }
                    }
                } else {
                // 難易度に応じた配分比率を使用
                const distribution = difficultySettings.lossDistribution;
                
                // 各ハズレタイプの枚数を計算
                const lossCounts = [];
                let allocated = 0;
                
                // 各タイプの基本配分を計算
                for (let i = 0; i < lossTypeCount; i++) {
                    const ratio = distribution[i] || distribution[distribution.length - 1];
                    const count = Math.floor(lossCount * ratio);
                    lossCounts.push(count);
                    allocated += count;
                }
                
                // 残り枚数を均等に配分
                let remaining = lossCount - allocated;
                let index = 0;
                while (remaining > 0) {
                    lossCounts[index % lossTypeCount]++;
                    remaining--;
                    index++;
                }

                // 最低保証価値（ユーザー入力値をそのまま使用）
                const adjustedMinValue = roundToTens(minGuaranteeValue);

                // 最低保証の総価値
                const minTotalValue = adjustedMinValue * lossCounts[lossTypeCount - 1];

                // 残りの価値を他のハズレに配分
                const remainingValue = lossValue - minTotalValue;
                const remainingTypes = lossTypeCount - 1;

                // 各ハズレタイプの価値を計算（最低保証より必ず高く、かつ異なる価格に）
                const lossValues = [];
                for (let i = 0; i < remainingTypes; i++) {
                    const count = lossCounts[i];
                    if (count > 0) {
                        // 難易度に応じた価値配分
                        let valueRatio;
                        if (difficulty === 'easy') {
                            // 易しい：高還元ハズレを多めに
                            valueRatio = (remainingTypes - i + 2) / (remainingTypes + 2);
                        } else if (difficulty === 'hard') {
                            // 厳しい：高還元ハズレを少なめに
                            valueRatio = Math.pow((remainingTypes - i) / remainingTypes, 2);
                        } else {
                            // 普通：標準的な配分
                            valueRatio = (remainingTypes - i) / remainingTypes;
                        }

                        let value = remainingValue * valueRatio / count;

                        // 難易度に応じた最大値制限
                        const maxValue = packPrice * difficultySettings.maxValueCap;
                        value = Math.min(value, maxValue);

                        // 最低保証価値より必ず高くする（最低+10円）
                        value = Math.max(adjustedMinValue + 10, value);

                        // キリの良い数に丸める
                        value = roundToTens(value);

                        lossValues.push({ index: i, value: value, count: count });
                    }
                }

                // 価格の重複を避けるために調整
                lossValues.sort((a, b) => b.value - a.value); // 高い順にソート
                for (let i = 1; i < lossValues.length; i++) {
                    // 前の価格と同じ場合は少し下げる（ただし最低保証より上を維持）
                    if (lossValues[i].value >= lossValues[i-1].value) {
                        lossValues[i].value = Math.max(
                            adjustedMinValue + 10,
                            lossValues[i-1].value - 10
                        );
                    }
                    // さらに重複がある場合の調整
                    while (i > 0 && lossValues[i].value >= lossValues[i-1].value && lossValues[i].value > adjustedMinValue + 10) {
                        lossValues[i].value -= 10;
                    }
                }

                // ハズレタイプを追加
                lossValues.forEach(loss => {
                    lossTypes.push({
                        name: `ハズレ${String.fromCharCode(65 + loss.index)}`,
                        value: loss.value,
                        count: loss.count,
                        type: 'normal'
                    });
                });

                // 最低保証を追加
                lossTypes.push({
                    name: `ハズレ${String.fromCharCode(65 + remainingTypes)}（最低保証）`,
                    value: adjustedMinValue,
                    count: lossCounts[lossTypeCount - 1],
                    type: 'min'
                });
                }
            }

            // 期待値計算
            let expectedValue = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (prize.value * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                expectedValue += loss.value * probability;
            });

            // 標準偏差計算
            let variance = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (Math.pow(prize.value - expectedValue, 2) * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                variance += Math.pow(loss.value - expectedValue, 2) * probability;
            });
            
            const stdDev = Math.sqrt(variance);

            // 結果表示更新
            updateResults({
                totalReturnRatePercent,
                realReturnRate,
                expectedValue,
                stdDev,
                lossTypes,
                lossCount,
                totalPacks,
                packPrice
            });
        }

        // 結果表示更新
        function updateResults(data) {
            document.getElementById('summaryTotalReturn').textContent = `${data.totalReturnRatePercent.toFixed(1)}%`;
            document.getElementById('summaryRealReturn').textContent = `${data.realReturnRate.toFixed(1)}%`;
            document.getElementById('summaryExpectedValue').textContent = `¥${data.expectedValue.toLocaleString()}`;
            document.getElementById('summaryStdDev').textContent = `¥${data.stdDev.toLocaleString()}`;
            
            // 総当選者数を表示
            const totalWinners = prizes.reduce((sum, prize) => sum + prize.count, 0);
            document.getElementById('summaryWinnerCount').textContent = `${totalWinners}人`;

            // 総仕入れ額を表示
            const totalPurchaseAmount = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);
            document.getElementById('summaryTotalPurchase').textContent = `¥${totalPurchaseAmount.toLocaleString()}`;

            // 当たり景品還元総額を表示
            const prizeTotalReward = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            document.getElementById('summaryPrizeTotalReward').textContent = `¥${prizeTotalReward.toLocaleString()}`;

            // ハズレ還元総額を表示
            const lossTotalReward = data.lossTypes ? data.lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0) : 0;
            document.getElementById('summaryLossTotalReward').textContent = `¥${lossTotalReward.toLocaleString()}`;

            // 景品詳細更新
            updatePrizeDetails();

            // ハズレ詳細更新
            updateLossDetails(data.lossTypes, data.lossCount);
            
            // ハズレ分布チャート更新
            drawLossDistributionChart(data.lossTypes);

            // 警告表示の更新
            updateWarnings(data);
        }

        // 景品詳細更新
        function updatePrizeDetails() {
            const container = document.getElementById('prizeDetails');
            
            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">景品を追加してください</p>';
                return;
            }

            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            
            container.innerHTML = prizes.map(prize => {
                const probability = totalPacks > 0 ? (prize.count / totalPacks * 100).toFixed(2) : '0.00';
                return `
                    <div class="result-row">
                        <span class="result-label">${prize.rank}等 ${prize.name}</span>
                        <span class="result-value">${probability}% (仕入¥${prize.purchasePrice.toLocaleString()} / 還元¥${prize.value.toLocaleString()})</span>
                    </div>
                `;
            }).join('');
        }

        // ハズレ詳細更新
        function updateLossDetails(lossTypes, lossCount) {
            const container = document.getElementById('lossDetailsContainer');
            
            if (!lossTypes || lossTypes.length === 0) {
                container.innerHTML = '<div class="result-row"><span class="result-label">ハズレなし</span><span class="result-value">-</span></div>';
                document.getElementById('totalLossCount').textContent = '0枚';
                return;
            }

            container.innerHTML = lossTypes.map(loss => {
                const probability = lossCount > 0 ? ((loss.count / lossCount) * 100).toFixed(1) : '0.0';
                return `
                    <div class="result-row">
                        <span class="result-label">${loss.name}</span>
                        <span class="result-value">¥${loss.value.toLocaleString()} × ${loss.count}枚 (${probability}%)</span>
                    </div>
                `;
            }).join('');

            document.getElementById('totalLossCount').textContent = `${lossCount}枚`;
        }



        // ハズレ当選者分布チャート描画
        function drawLossDistributionChart(lossTypes) {
            const canvas = document.getElementById('lossDistributionChart');
            const ctx = canvas.getContext('2d');
            
            // キャンバスをクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!lossTypes || lossTypes.length === 0) {
                ctx.fillStyle = '#8E8E93';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ハズレなし', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const padding = 40;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF'];
            const total = lossTypes.reduce((sum, loss) => sum + loss.count, 0);
            
            if (total === 0) return;
            
            // 棒グラフとして描画
            const barWidth = width / lossTypes.length * 0.8;
            const barSpacing = width / lossTypes.length * 0.2;
            const maxCount = Math.max(...lossTypes.map(loss => loss.count));
            
            lossTypes.forEach((loss, index) => {
                const x = padding + index * (barWidth + barSpacing) + barSpacing / 2;
                const barHeight = (loss.count / maxCount) * height;
                const y = canvas.height - padding - barHeight;
                
                // 棒を描画
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // 枚数を表示
                ctx.fillStyle = '#000000';
                ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(loss.count + '枚', x + barWidth / 2, y - 5);
                
                // 名前を表示
                ctx.fillText(loss.name, x + barWidth / 2, canvas.height - 10);
                
                // 割合を表示
                const percentage = ((loss.count / total) * 100).toFixed(1);
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(percentage + '%', x + barWidth / 2, y + barHeight / 2);
            });
            
            // チャートタイトル
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ハズレ当選者分布', canvas.width / 2, 20);
        }

        // 設定検証とエラー表示
        function validateSettings() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalReturnRatePercent = parseFloat(document.getElementById('totalReturnRate').value) || 0;
            const targetReturnValue = packPrice * totalPacks * (totalReturnRatePercent / 100);
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // エラー状態をリセット
            document.getElementById('totalReturnRate').classList.remove('error');
            document.getElementById('totalPacks').classList.remove('error');

            let hasError = false;
            let errorMessages = [];

            // 景品枚数が総口数を超えているかチェック
            if (prizesTotalCount > totalPacks) {
                document.getElementById('totalPacks').classList.add('error');
                hasError = true;
                errorMessages.push(`景品の総枚数（${prizesTotalCount}枚）が総口数（${totalPacks}口）を超えています。`);
            }

            // 景品価値が目標還元価値を超えているかチェック
            if (prizesTotalValue > targetReturnValue) {
                document.getElementById('totalReturnRate').classList.add('error');
                hasError = true;
                const requiredReturnRate = Math.ceil((prizesTotalValue / (packPrice * totalPacks)) * 100);
                errorMessages.push(`景品の還元価値合計（¥${prizesTotalValue.toLocaleString()}）が目標還元価値（¥${targetReturnValue.toLocaleString()}）を超えています。総還元率を${requiredReturnRate}%以上に設定するか、景品価値を調整してください。`);
            }

            if (hasError) {
                showErrorPopup(errorMessages);
                return false;
            }

            return true;
        }

        // エラーポップアップ表示
        function showErrorPopup(messages) {
            const errorMessage = messages.join('\n\n');
            alert(`⚠️ 設定にエラーがあります\n\n${errorMessage}`);
        }

        // 警告表示更新（軽微な警告用）
        function updateWarnings(data) {
            const warningsContainer = document.getElementById('warnings');
            const warnings = [];

            // 実際の総還元率と設定還元率の軽微な乖離を警告
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalReturnRatePercent = parseFloat(document.getElementById('totalReturnRate').value) || 0;
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const lossTotalValue = data.lossTypes ? data.lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0) : 0;
            const actualTotalReturnValue = prizesTotalValue + lossTotalValue;
            const actualReturnRate = (actualTotalReturnValue / (packPrice * totalPacks)) * 100;
            const returnRateDiff = Math.abs(actualReturnRate - totalReturnRatePercent);

            // エラーレベルでない軽微な乖離のみ警告表示
            if (returnRateDiff > 1 && returnRateDiff <= 5) {
                warnings.push(`
                    <div class="warning">
                        ℹ️ <strong>還元率に軽微な乖離があります</strong><br>
                        設定還元率: ${totalReturnRatePercent}% / 実際の還元率: ${actualReturnRate.toFixed(1)}%<br>
                        差: ${returnRateDiff.toFixed(1)}%
                    </div>
                `);
            }

            warningsContainer.innerHTML = warnings.join('');
        }


        // 履歴保存
        function saveToHistory() {
            const name = document.getElementById('historyName').value.trim();
            
            if (!name) {
                alert('設定名を入力してください');
                return;
            }

            const settings = {
                id: Date.now(),
                name: name,
                date: new Date().toLocaleString('ja-JP'),
                packPrice: document.getElementById('packPrice').value,
                totalPacks: document.getElementById('totalPacks').value,
                totalReturnRate: document.getElementById('totalReturnRate').value,
                lossTypeCount: document.getElementById('lossTypeCount').value,
                minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
                gachaDifficulty: document.getElementById('gachaDifficulty').value,
                prizes: [...prizes]
            };

            history.unshift(settings);
            document.getElementById('historyName').value = '';
            
            updateHistoryList();
            saveData();
        }

        // 履歴から読み込み
        function loadFromHistory(id) {
            const settings = history.find(h => h.id === id);
            if (!settings) return;

            document.getElementById('packPrice').value = settings.packPrice;
            document.getElementById('totalPacks').value = settings.totalPacks;
            document.getElementById('totalReturnRate').value = settings.totalReturnRate;
            if (settings.lossTypeCount) document.getElementById('lossTypeCount').value = settings.lossTypeCount;
            if (settings.minGuaranteeValue) document.getElementById('minGuaranteeValue').value = settings.minGuaranteeValue;
            if (settings.gachaDifficulty) document.getElementById('gachaDifficulty').value = settings.gachaDifficulty;
            prizes = [...settings.prizes];

            updatePrizeList();
            updateTotalValue();
        }

        // 履歴削除
        function removeFromHistory(id) {
            if (confirm('この履歴を削除しますか？')) {
                history = history.filter(h => h.id !== id);
                updateHistoryList();
                saveData();
            }
        }

        // 履歴リスト更新
        function updateHistoryList() {
            const container = document.getElementById('historyList');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; padding: 20px 0;">保存済みの設定はありません</p>';
                return;
            }

            container.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadFromHistory(${item.id})">
                    <div class="history-name">${item.name}</div>
                    <div class="history-meta">${item.date}</div>
                    <button class="btn btn-danger" onclick="event.stopPropagation(); removeFromHistory(${item.id})" style="float: right; margin-top: -30px;">削除</button>
                </div>
            `).join('');
        }

        // データ保存
        function saveData() {
            const data = {
                prizes: prizes,
                history: history,
                settings: {
                    packPrice: document.getElementById('packPrice').value,
                    totalPacks: document.getElementById('totalPacks').value,
                    totalReturnRate: document.getElementById('totalReturnRate').value,
                    lossTypeCount: document.getElementById('lossTypeCount').value,
                    minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
                    gachaDifficulty: document.getElementById('gachaDifficulty').value
                }
            };

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('保存に失敗しました:', e);
            }
        }

        // データ読み込み
        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.prizes) {
                        prizes = data.prizes;
                        updatePrizeList();
                    }
                    
                    if (data.history) {
                        history = data.history;
                        updateHistoryList();
                    }

                    if (data.settings) {
                        document.getElementById('packPrice').value = data.settings.packPrice || '40000';
                        document.getElementById('totalPacks').value = data.settings.totalPacks || '100';
                        document.getElementById('totalReturnRate').value = data.settings.totalReturnRate || 98;
                        document.getElementById('lossTypeCount').value = data.settings.lossTypeCount || 2;
                        document.getElementById('minGuaranteeValue').value = data.settings.minGuaranteeValue || '1000';
                        document.getElementById('gachaDifficulty').value = data.settings.gachaDifficulty || 'normal';
                    }
                }
            } catch (e) {
                console.error('データの読み込みに失敗しました:', e);
            }
        }

        // モーダル関連
        function showModal() {
            document.getElementById('historyModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('historyModal').classList.remove('show');
        }

        function confirmSaveHistory() {
            const name = document.getElementById('modalHistoryName').value.trim();
            if (name) {
                document.getElementById('historyName').value = name;
                saveToHistory();
                closeModal();
                document.getElementById('modalHistoryName').value = '';
            }
        }

        // 設定エクスポート
        function exportSettings() {
            const exportData = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                currentSettings: {
                    packPrice: document.getElementById('packPrice').value,
                    totalPacks: document.getElementById('totalPacks').value,
                    totalReturnRate: document.getElementById('totalReturnRate').value,
                    lossTypeCount: document.getElementById('lossTypeCount').value,
                    minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
                    gachaDifficulty: document.getElementById('gachaDifficulty').value,
                    prizes: [...prizes]
                },
                history: [...history]
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            const now = new Date();
            const dateTime = now.toISOString().slice(0, 19).replace(/:/g, '-');
            link.download = `oripa-settings-${dateTime}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('設定をエクスポートしました！\nダウンロードしたJSONファイルを他のブラウザでインポートできます。');
        }

        // 設定インポート
        function importSettings() {
            document.getElementById('importFile').click();
        }

        // ファイルインポート処理
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/json') {
                alert('JSONファイルを選択してください');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // バージョンチェック
                    if (!importData.version) {
                        alert('古いバージョンの設定ファイルです。インポートできません。');
                        return;
                    }

                    // 確認ダイアログ
                    const confirmMessage = `設定をインポートしますか？\n\n` +
                        `- エクスポート日時: ${new Date(importData.exportDate).toLocaleString('ja-JP')}\n` +
                        `- 履歴件数: ${importData.history ? importData.history.length : 0}件\n` +
                        `- 景品数: ${importData.currentSettings.prizes ? importData.currentSettings.prizes.length : 0}個\n\n` +
                        `※ 現在の設定と履歴は上書きされます`;

                    if (!confirm(confirmMessage)) {
                        return;
                    }

                    // 現在の設定を復元
                    if (importData.currentSettings) {
                        const settings = importData.currentSettings;
                        document.getElementById('packPrice').value = settings.packPrice || '40000';
                        document.getElementById('totalPacks').value = settings.totalPacks || '100';
                        document.getElementById('totalReturnRate').value = settings.totalReturnRate || 98;
                        if (settings.lossTypeCount) document.getElementById('lossTypeCount').value = settings.lossTypeCount;
                        if (settings.minGuaranteeValue) document.getElementById('minGuaranteeValue').value = settings.minGuaranteeValue;
                        if (settings.gachaDifficulty) document.getElementById('gachaDifficulty').value = settings.gachaDifficulty;
                        
                        // 景品データを復元
                        if (settings.prizes) {
                            prizes = [...settings.prizes];
                            updatePrizeList();
                        }
                    }

                    // 履歴を復元
                    if (importData.history) {
                        history = [...importData.history];
                        updateHistoryList();
                    }

                    // データを保存
                    saveData();

                    // オリパ提供価値のみ更新
                    updateTotalValue();

                    alert('設定を正常にインポートしました！');

                } catch (error) {
                    console.error('インポートエラー:', error);
                    alert('設定ファイルの読み込みに失敗しました。\nファイルが破損している可能性があります。');
                }
            };

            reader.readAsText(file);
            
            // ファイル選択をリセット
            event.target.value = '';
        }

        // キーボードイベント
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // ガチャ体験機能
        let gachaDrawHistory = [];
        let gachaPool = [];

        // ガチャプール生成
        function generateGachaPool() {
            gachaPool = [];
            
            // 景品を追加
            prizes.forEach(prize => {
                for (let i = 0; i < prize.count; i++) {
                    gachaPool.push({
                        type: 'prize',
                        item: prize
                    });
                }
            });
            
            // 現在の設定でハズレを計算
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalReturnRatePercent = parseFloat(document.getElementById('totalReturnRate').value) || 95.0;

            if (packPrice > 0 && totalPacks > 0) {
                const totalValue = packPrice * totalPacks;
                const targetReturnValue = totalValue * (totalReturnRatePercent / 100);

                // 難易度設定を取得
                const difficulty = document.getElementById('gachaDifficulty').value;
                const difficultySettings = getDifficultySettings(difficulty);
                const lossTypeCount = parseInt(document.getElementById('lossTypeCount').value) || 2;
                const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;
                
                const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
                const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

                const lossCount = totalPacks - prizesTotalCount;
                const lossValue = targetReturnValue - prizesTotalValue;
                
                console.log('ガチャプール生成デバッグ:', {
                    totalPacks: totalPacks,
                    prizesTotalCount: prizesTotalCount,
                    lossCount,
                    targetReturnValue: targetReturnValue,
                    prizesTotalValue,
                    lossValue
                });
                
                if (lossCount > 0) {
                    // メイン計算と同じロジックでハズレタイプを生成
                    const lossTypes = [];

                    if (lossValue <= 0) {
                        // lossValueが0以下の場合、段階的な価値でハズレを生成
                        console.log('lossValueが0以下のため、段階的価値でハズレを生成');

                        // 難易度に応じた配分比率を使用
                        const distribution = difficultySettings.lossDistribution;

                        // 各ハズレタイプの枚数を計算
                        const lossCounts = [];
                        let allocated = 0;

                        for (let i = 0; i < lossTypeCount; i++) {
                            const ratio = distribution[i] || distribution[distribution.length - 1];
                            const count = Math.floor(lossCount * ratio);
                            lossCounts.push(count);
                            allocated += count;
                        }

                        let remaining = lossCount - allocated;
                        let index = 0;
                        while (remaining > 0) {
                            lossCounts[index % lossTypeCount]++;
                            remaining--;
                            index++;
                        }

                        // 最低保証価値（ユーザー入力値をそのまま使用）
                        const adjustedMinValue = Math.max(10, Math.round(minGuaranteeValue / 10) * 10);

                        // 各ハズレタイプに異なる価値を設定（最低保証より高く）
                        for (let i = 0; i < lossTypeCount; i++) {
                            const count = lossCounts[i];
                            if (count > 0) {
                                let value;
                                if (i === lossTypeCount - 1) {
                                    // 最後のタイプは最低保証価値
                                    value = adjustedMinValue;
                                } else {
                                    // 他のタイプは最低保証より高く、段階的に設定
                                    value = adjustedMinValue + (lossTypeCount - 1 - i) * 10;
                                }

                                lossTypes.push({
                                    name: i === lossTypeCount - 1 ?
                                        `ハズレ${String.fromCharCode(65 + i)}（最低保証）` :
                                        `ハズレ${String.fromCharCode(65 + i)}`,
                                    value: value,
                                    count: count,
                                    type: i === lossTypeCount - 1 ? 'min' : 'normal'
                                });
                            }
                        }
                    } else {
                        // 正常なハズレ価値配分処理（メイン計算と同じロジック）
                        const distribution = difficultySettings.lossDistribution;

                        // 各ハズレタイプの枚数を計算
                        const lossCounts = [];
                        let allocated = 0;

                        for (let i = 0; i < lossTypeCount; i++) {
                            const ratio = distribution[i] || distribution[distribution.length - 1];
                            const count = Math.floor(lossCount * ratio);
                            lossCounts.push(count);
                            allocated += count;
                        }

                        let remaining = lossCount - allocated;
                        let index = 0;
                        while (remaining > 0) {
                            lossCounts[index % lossTypeCount]++;
                            remaining--;
                            index++;
                        }

                        // 最低保証価値（ユーザー入力値をそのまま使用）
                        const adjustedMinValue = Math.max(10, Math.round(minGuaranteeValue / 10) * 10);

                        // 最低保証の総価値
                        const minTotalValue = adjustedMinValue * lossCounts[lossTypeCount - 1];

                        // 残りの価値を他のハズレに配分
                        const remainingValue = lossValue - minTotalValue;
                        const remainingTypes = lossTypeCount - 1;

                        // 各ハズレタイプの価値を計算（最低保証より必ず高く、かつ異なる価格に）
                        const lossValues = [];
                        for (let i = 0; i < remainingTypes; i++) {
                            const count = lossCounts[i];
                            if (count > 0) {
                                // 難易度に応じた価値配分
                                let valueRatio;
                                if (difficulty === 'easy') {
                                    // 易しい：高還元ハズレを多めに
                                    valueRatio = (remainingTypes - i + 2) / (remainingTypes + 2);
                                } else if (difficulty === 'hard') {
                                    // 厳しい：高還元ハズレを少なめに
                                    valueRatio = Math.pow((remainingTypes - i) / remainingTypes, 2);
                                } else {
                                    // 普通：標準的な配分
                                    valueRatio = (remainingTypes - i) / remainingTypes;
                                }

                                let value = remainingValue * valueRatio / count;

                                // 難易度に応じた最大値制限
                                const maxValue = packPrice * difficultySettings.maxValueCap;
                                value = Math.min(value, maxValue);

                                // 最低保証価値より必ず高くする（最低+10円）
                                value = Math.max(adjustedMinValue + 10, value);

                                // キリの良い数に丸める
                                value = Math.max(10, Math.round(value / 10) * 10);

                                lossValues.push({ index: i, value: value, count: count });
                            }
                        }

                        // 価格の重複を避けるために調整
                        lossValues.sort((a, b) => b.value - a.value); // 高い順にソート
                        for (let i = 1; i < lossValues.length; i++) {
                            // 前の価格と同じ場合は少し下げる（ただし最低保証より上を維持）
                            if (lossValues[i].value >= lossValues[i-1].value) {
                                lossValues[i].value = Math.max(
                                    adjustedMinValue + 10,
                                    lossValues[i-1].value - 10
                                );
                            }
                            // さらに重複がある場合の調整
                            while (i > 0 && lossValues[i].value >= lossValues[i-1].value && lossValues[i].value > adjustedMinValue + 10) {
                                lossValues[i].value -= 10;
                            }
                        }

                        // ハズレタイプを追加
                        lossValues.forEach(loss => {
                            lossTypes.push({
                                name: `ハズレ${String.fromCharCode(65 + loss.index)}`,
                                value: loss.value,
                                count: loss.count,
                                type: 'normal'
                            });
                        });

                        // 最低保証を追加
                        lossTypes.push({
                            name: `ハズレ${String.fromCharCode(65 + remainingTypes)}（最低保証）`,
                            value: adjustedMinValue,
                            count: lossCounts[lossTypeCount - 1],
                            type: 'min'
                        });
                    }

                    // ガチャプールにハズレを追加
                    lossTypes.forEach(lossType => {
                        console.log(`${lossType.name} 生成:`, { count: lossType.count, value: lossType.value });
                        for (let j = 0; j < lossType.count; j++) {
                            gachaPool.push({
                                type: 'loss',
                                item: {
                                    name: lossType.name,
                                    value: lossType.value,
                                    rank: 'loss'
                                }
                            });
                        }
                    });
                } else {
                    console.log('ハズレ生成スキップ:', { lossCount, reason: 'lossCount <= 0' });
                }
            }
            
            // プールをシャッフル
            for (let i = gachaPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gachaPool[i], gachaPool[j]] = [gachaPool[j], gachaPool[i]];
            }
            
            console.log('ガチャプール生成完了:', {
                totalItems: gachaPool.length,
                prizes: gachaPool.filter(item => item.type === 'prize').length,
                losses: gachaPool.filter(item => item.type === 'loss').length,
                expectedTotal: totalPacks
            });

            // 最終的なサイズチェック
            if (gachaPool.length !== totalPacks) {
                console.error('ガチャプールサイズエラー:', {
                    expected: totalPacks,
                    actual: gachaPool.length,
                    difference: gachaPool.length - totalPacks
                });
            }
        }

        // ガチャを引く
        function drawGacha(count) {
            if (gachaPool.length === 0) {
                alert('先にシミュレーション実行をしてガチャの設定を完了してください');
                return;
            }
            
            // ガチャプールのサイズチェック
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            if (gachaPool.length !== totalPacks) {
                console.warn('ガチャプールサイズが設定と異なります:', {
                    expected: totalPacks,
                    actual: gachaPool.length
                });
            }
            
            if (gachaPool.length < count) {
                alert(`残り${gachaPool.length}枚しかありません`);
                count = gachaPool.length;
            }
            
            const draws = [];
            for (let i = 0; i < count; i++) {
                if (gachaPool.length > 0) {
                    const drawnItem = gachaPool.shift();
                    console.log('ガチャ結果:', drawnItem);
                    draws.push(drawnItem);
                    gachaDrawHistory.push(drawnItem);
                }
            }
            
            updateGachaResults();
            
            // リセットボタンを表示
            document.getElementById('resetGachaBtn').style.display = 'block';
            document.getElementById('gachaResults').style.display = 'block';
        }

        // ガチャ結果を更新
        function updateGachaResults() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            
            // 統計計算
            const totalDraws = gachaDrawHistory.length;
            const prizeCount = gachaDrawHistory.filter(draw => draw.type === 'prize').length;
            const totalValue = gachaDrawHistory.reduce((sum, draw) => sum + draw.item.value, 0);
            const totalCost = totalDraws * packPrice;
            const profit = totalValue - totalCost;
            
            // 統計表示
            document.getElementById('gachaStats').innerHTML = `
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${totalDraws}</div>
                    <div class="gacha-stat-label">総引き回数</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${prizeCount}</div>
                    <div class="gacha-stat-label">当選回数</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">¥${totalValue.toLocaleString()}</div>
                    <div class="gacha-stat-label">総還元価値</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value" style="color: ${profit >= 0 ? 'var(--sf-green)' : 'var(--sf-red)'}">
                        ${profit >= 0 ? '+' : ''}¥${profit.toLocaleString()}
                    </div>
                    <div class="gacha-stat-label">収支</div>
                </div>
            `;
            
            // 履歴表示（最新10件）
            const recentDraws = gachaDrawHistory.slice(-10).reverse();
            document.getElementById('gachaHistory').innerHTML = `
                <h5 style="margin-bottom: 10px;">最新の引き結果</h5>
                ${recentDraws.map(draw => `
                    <div class="gacha-draw-item ${draw.type === 'prize' ? 'gacha-draw-prize' : 'gacha-draw-loss'}">
                        <span>${draw.item.name}</span>
                        <span>¥${draw.item.value.toLocaleString()}</span>
                    </div>
                `).join('')}
            `;
        }

        // ガチャリセット
        function resetGacha() {
            if (confirm('ガチャ結果をリセットしますか？')) {
                gachaDrawHistory = [];
                generateGachaPool();
                document.getElementById('resetGachaBtn').style.display = 'none';
                document.getElementById('gachaResults').style.display = 'none';
            }
        }

        // シミュレーション実行時にガチャプールも生成
        const originalCalculate = calculate;
        calculate = function() {
            originalCalculate();
            generateGachaPool();
        };
    </script>
</body>
</html>
