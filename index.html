<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ªãƒªãƒ‘è¨­è¨ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v3.0</title>
    <style>
        :root {
            --sf-blue: #007AFF;
            --sf-orange: #FF9500;
            --sf-green: #34C759;
            --sf-red: #FF3B30;
            --sf-purple: #AF52DE;
            --sf-gray: #8E8E93;
            --sf-gray-2: #AEAEB2;
            --sf-gray-3: #C7C7CC;
            --sf-gray-4: #D1D1D6;
            --sf-gray-5: #E5E5EA;
            --sf-gray-6: #F2F2F7;
            --sf-white: #FFFFFF;
            --sf-black: #000000;
            --shadow-light: 0 2px 20px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.15);
            --border-radius: 16px;
            --border-radius-small: 12px;
            --transition: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #F2F2F7 0%, #FFFFFF 100%);
            min-height: 100vh;
            letter-spacing: -0.01em;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            color: var(--sf-black);
            text-align: center;
            margin-bottom: 32px;
            font-size: 2.2em;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .version-badge {
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 16px;
            vertical-align: middle;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 32px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--sf-gray-5);
            box-shadow: var(--shadow-light);
            transition: all 0.3s var(--transition);
        }

        .panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .panel h2 {
            margin: 0 0 20px 0;
            color: var(--sf-black);
            border-bottom: 2px solid var(--sf-blue);
            padding-bottom: 12px;
            font-size: 1.3em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--sf-black);
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            font-size: 15px;
            font-weight: 400;
            background: var(--sf-white);
            transition: all 0.3s var(--transition);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--sf-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-group input.error {
            border-color: var(--sf-red);
            background-color: rgba(255, 59, 48, 0.05);
        }

        .form-group input.error:focus {
            border-color: var(--sf-red);
            box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.1);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .calculated-value {
            background: rgba(52, 199, 89, 0.1);
            color: var(--sf-green);
            padding: 12px 16px;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(52, 199, 89, 0.3);
        }

        .prize-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .prize-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            padding: 16px;
            position: relative;
            transition: all 0.3s var(--transition);
        }

        .prize-item:hover {
            border-color: var(--sf-blue);
            transform: translateY(-1px);
        }

        .prize-rank {
            position: absolute;
            top: -8px;
            left: 12px;
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .prize-rank.rank-1 { background: #FFD700; color: var(--sf-black); }
        .prize-rank.rank-2 { background: #C0C0C0; color: var(--sf-black); }
        .prize-rank.rank-3 { background: #CD7F32; color: var(--sf-white); }
        .prize-rank.rank-4 { background: var(--sf-green); }
        .prize-rank.rank-5 { background: var(--sf-purple); }

        .prize-content {
            margin-top: 8px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .prize-name {
            font-weight: 500;
            color: var(--sf-black);
        }

        .prize-value, .prize-count, .prize-purchase {
            font-size: 12px;
            color: var(--sf-gray);
            text-align: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius-small);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--transition);
        }

        .btn-primary {
            background: var(--sf-blue);
            color: var(--sf-white);
        }

        .btn-primary:hover {
            background: #0051D5;
            transform: scale(1.05);
        }

        .btn-danger {
            background: var(--sf-red);
            color: var(--sf-white);
        }

        .btn-danger:hover {
            background: #E6342A;
            transform: scale(1.05);
        }

        .btn-success {
            background: var(--sf-green);
            color: var(--sf-white);
            width: 100%;
            padding: 12px;
            font-size: 14px;
            margin-top: 16px;
        }

        .btn-success:hover {
            background: #248A3D;
        }
        .btn-accent {
            background: var(--sf-orange);
            color: var(--sf-white);
        }
        .btn-accent:hover {
            background: #E6742A;
            transform: scale(1.05);
        }
        
        /* ã‚¬ãƒãƒ£ä½“é¨“ã‚¹ã‚¿ã‚¤ãƒ« */
        .gacha-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .gacha-btn {
            flex: 1;
            min-width: 120px;
            font-weight: 600;
        }
        .gacha-results {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            padding: 20px;
            margin-top: 20px;
        }
        .gacha-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .gacha-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 8px;
        }
        .gacha-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--sf-blue);
        }
        .gacha-stat-label {
            font-size: 0.9em;
            color: var(--sf-gray);
        }
        .gacha-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .gacha-draw-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        .gacha-draw-prize {
            background: linear-gradient(135deg, #34C759, #30D158);
            color: white;
        }
        .gacha-draw-loss {
            background: linear-gradient(135deg, #FF9500, #FF9F0A);
            color: white;
        }

        .add-prize-form {
            background: rgba(0, 122, 255, 0.05);
            border: 1px dashed var(--sf-blue);
            border-radius: var(--border-radius-small);
            padding: 20px;
            margin-top: 16px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .result-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--sf-gray-5);
            box-shadow: var(--shadow-light);
            transition: all 0.3s var(--transition);
        }

        .result-panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .result-panel h3 {
            margin: 0 0 16px 0;
            color: var(--sf-black);
            border-bottom: 2px solid var(--sf-green);
            padding-bottom: 8px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--sf-gray-5);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: var(--sf-black);
        }

        .result-value {
            color: var(--sf-gray);
            font-weight: 600;
        }

        .highlight {
            background: rgba(255, 149, 0, 0.15);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 149, 0, 0.3);
            color: var(--sf-orange);
            font-weight: 600;
        }

        .loss-panel {
            background: rgba(255, 149, 0, 0.08);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        .loss-panel h3 {
            border-bottom-color: var(--sf-orange);
        }

        .expected-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .ev-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 8px;
            font-size: 12px;
        }

        .ev-count {
            font-weight: 600;
            color: var(--sf-blue);
        }

        .ev-value {
            color: var(--sf-gray);
            font-size: 11px;
        }

        .history-panel {
            background: rgba(175, 82, 222, 0.08);
            border: 1px solid rgba(175, 82, 222, 0.2);
        }

        .history-panel h2 {
            border-bottom-color: var(--sf-purple);
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s var(--transition);
        }

        .history-item:hover {
            background: rgba(175, 82, 222, 0.1);
            transform: translateX(4px);
        }

        .history-name {
            font-weight: 500;
            color: var(--sf-black);
        }

        .history-meta {
            font-size: 12px;
            color: var(--sf-gray);
        }

        .warning {
            background: rgba(255, 59, 48, 0.1);
            color: var(--sf-red);
            padding: 16px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 59, 48, 0.2);
            margin-top: 24px;
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--sf-white);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 500px;
            width: 90%;
        }

        .modal h3 {
            margin: 0 0 20px 0;
            color: var(--sf-black);
        }

        .close-btn {
            background: var(--sf-gray-4);
            color: var(--sf-black);
        }

        .close-btn:hover {
            background: var(--sf-gray-3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ã‚ªãƒªãƒ‘è¨­è¨ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ <span class="version-badge">v2.0</span></h1>
        
        <div class="main-grid">
            <div class="left-panel">
                <!-- åŸºæœ¬è¨­å®š -->
                <div class="panel">
                    <h2>åŸºæœ¬è¨­å®š</h2>
                    <div class="form-group">
                        <label>ãƒ‘ãƒƒã‚¯å˜ä¾¡ (å††)</label>
                        <input type="number" id="packPrice" value="40000">
                    </div>
                    <div class="form-group">
                        <label>ç·å£æ•°</label>
                        <input type="number" id="totalPacks" value="100">
                    </div>
                    <div class="form-group">
                        <label>ç·é‚„å…ƒç‡ (%)</label>
                        <input type="number" id="totalReturnRate" value="98" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤</label>
                        <div class="calculated-value" id="totalValue">Â¥0</div>
                    </div>
                    <button class="btn btn-success" onclick="calculate()" style="width: 100%; margin-top: 16px; font-size: 16px; padding: 14px;">
                        ğŸ§® è¨ˆç®—ã™ã‚‹
                    </button>
                </div>

                <!-- ãƒã‚ºãƒ¬è¨­è¨ˆ -->
                <div class="panel">
                    <h2>ãƒã‚ºãƒ¬è¨­è¨ˆ</h2>
                    <div class="form-group">
                        <label>ã‚¬ãƒãƒ£é›£æ˜“åº¦</label>
                        <select id="gachaDifficulty" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                            <option value="easy">ğŸ˜Š æ¯”è¼ƒçš„å½“ãŸã‚Šã‚„ã™ã„</option>
                            <option value="normal" selected>ğŸ˜ æ™®é€š</option>
                            <option value="hard">ğŸ˜¤ å½“ãŸã‚Šã«ãã„</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ãƒã‚ºãƒ¬ã®ç¨®é¡æ•°</label>
                        <select id="lossTypeCount" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                            <option value="2">2ç¨®é¡</option>
                            <option value="3">3ç¨®é¡</option>
                            <option value="4">4ç¨®é¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æœ€ä½ä¿è¨¼ä¾¡å€¤ (å††)</label>
                        <input type="number" id="minGuaranteeValue" value="1000">
                    </div>
                    <div class="difficulty-info" id="difficultyInfo" style="background: rgba(0, 122, 255, 0.1); padding: 12px; border-radius: 8px; font-size: 13px; margin-top: 12px;">
                        <!-- é›£æ˜“åº¦èª¬æ˜ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>

                <!-- æ™¯å“ç®¡ç† -->
                <div class="panel">
                    <h2>æ™¯å“ç®¡ç†</h2>
                    <div class="prize-list" id="prizeList">
                        <!-- æ™¯å“ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                    
                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>æ™¯å“å</label>
                            <input type="text" id="prizeName" placeholder="ä¾‹: ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰">
                        </div>
                        <div class="form-group">
                            <label>ç­‰ç´š</label>
                            <select id="prizeRank" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                                <option value="1">1ç­‰</option>
                                <option value="2">2ç­‰</option>
                                <option value="3">3ç­‰</option>
                                <option value="4">4ç­‰</option>
                                <option value="5">5ç­‰</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ä»•å…¥ã‚Œä¾¡æ ¼</label>
                                <input type="text" id="prizePurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this)">
                            </div>
                            <div class="form-group">
                                <label>ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒä¾¡å€¤</label>
                                <input type="text" id="prizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>åœ¨åº«æ•°</label>
                            <input type="number" id="prizeCount" min="1" value="1">
                        </div>
                        <button class="btn btn-success" onclick="addPrize()">æ™¯å“ã‚’è¿½åŠ </button>
                    </div>
                </div>

                <!-- å±¥æ­´ç®¡ç† -->
                <div class="panel history-panel">
                    <h2>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´</h2>
                    <div class="form-group">
                        <input type="text" id="historyName" placeholder="è¨­å®šåã‚’å…¥åŠ› (ä¾‹: æ–°å•†å“Aæ¡ˆ)">
                        <button class="btn btn-primary" onclick="saveToHistory()" style="width: 100%; margin-top: 8px;">ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜</button>
                    </div>
                    <div class="history-list" id="historyList">
                        <!-- å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;">
                        <button class="btn btn-success" onclick="exportSettings()" style="padding: 8px 12px; font-size: 12px;">
                            ğŸ’¾ è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <button class="btn btn-primary" onclick="importSettings()" style="padding: 8px 12px; font-size: 12px;">
                            ğŸ“‚ è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
                </div>
            </div>

            <div class="results-grid">
                <!-- ã‚µãƒãƒªãƒ¼ -->
                <div class="result-panel">
                    <h3>ã‚µãƒãƒªãƒ¼</h3>
                    <div class="result-row">
                        <span class="result-label">ç·é‚„å…ƒç‡</span>
                        <span class="result-value" id="summaryTotalReturn">98.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">å®Ÿè³ªé‚„å…ƒç‡</span>
                        <span class="result-value highlight" id="summaryRealReturn">0.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ç†è«–æœŸå¾…å€¤</span>
                        <span class="result-value" id="summaryExpectedValue">Â¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">æ¨™æº–åå·®</span>
                        <span class="result-value" id="summaryStdDev">Â¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ç·å½“é¸è€…æ•°</span>
                        <span class="result-value" id="summaryWinnerCount">0äºº</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ç·ä»•å…¥ã‚Œé¡</span>
                        <span class="result-value" id="summaryTotalPurchase">Â¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">å½“ãŸã‚Šæ™¯å“é‚„å…ƒç·é¡</span>
                        <span class="result-value" id="summaryPrizeTotalReward">Â¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ãƒã‚ºãƒ¬é‚„å…ƒç·é¡</span>
                        <span class="result-value" id="summaryLossTotalReward">Â¥0</span>
                    </div>
                </div>

                <!-- æ™¯å“è©³ç´° -->
                <div class="result-panel">
                    <h3>æ™¯å“è©³ç´°</h3>
                    <div id="prizeDetails">
                        <p style="color: var(--sf-gray); text-align: center;">æ™¯å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>

                <!-- ãƒã‚ºãƒ¬è©³ç´° -->
                <div class="result-panel loss-panel">
                    <h3>ãƒã‚ºãƒ¬è©³ç´°ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</h3>
                    <div id="lossDetailsContainer">
                        <!-- ãƒã‚ºãƒ¬è©³ç´°ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                    <div class="result-row">
                        <span class="result-label">ãƒã‚ºãƒ¬ç·æšæ•°</span>
                        <span class="result-value" id="totalLossCount">0æš</span>
                    </div>
                </div>

                <!-- ãƒã‚ºãƒ¬å½“é¸è€…åˆ†å¸ƒ -->
                <div class="result-panel">
                    <h3>ãƒã‚ºãƒ¬å½“é¸è€…åˆ†å¸ƒ</h3>
                    <div class="chart-container">
                        <canvas id="lossDistributionChart" width="400" height="200"></canvas>
                    </div>
                </div>




                <!-- ã‚¬ãƒãƒ£ä½“é¨“ -->
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <h3>ğŸ® ã‚¬ãƒãƒ£ä½“é¨“</h3>
                    <p style="color: var(--sf-gray); font-size: 14px; margin-bottom: 20px;">
                        å®Ÿéš›ã«ã‚ªãƒªãƒ‘ã‚’å¼•ã„ã¦ã€è¨­è¨ˆã—ãŸã‚¬ãƒãƒ£ã®ä½“é¨“ã‚’ç¢ºèªã§ãã¾ã™
                    </p>
                    
                    <!-- ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³ -->
                    <div class="gacha-controls">
                        <button class="btn btn-primary gacha-btn" onclick="drawGacha(1)">
                            ğŸ² 1å›å¼•ã
                        </button>
                        <button class="btn btn-secondary gacha-btn" onclick="drawGacha(10)">
                            ğŸ² 10å›å¼•ã
                        </button>
                        <button class="btn btn-accent gacha-btn" onclick="drawGacha(100)">
                            ğŸ² 100å›å¼•ã
                        </button>
                        <button class="btn btn-danger gacha-btn" onclick="resetGacha()" id="resetGachaBtn" style="display: none;">
                            ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
                        </button>
                    </div>
                    
                    <!-- ã‚¬ãƒãƒ£çµæœ -->
                    <div id="gachaResults" class="gacha-results" style="display: none;">
                        <h4>ã‚¬ãƒãƒ£çµæœ</h4>
                        <div id="gachaStats" class="gacha-stats"></div>
                        <div id="gachaHistory" class="gacha-history"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="warnings"></div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <h3>è¨­å®šåã‚’å…¥åŠ›</h3>
            <div class="form-group">
                <input type="text" id="modalHistoryName" placeholder="è¨­å®šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmSaveHistory()">ä¿å­˜</button>
                <button class="btn close-btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let prizes = [];
        let history = [];

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
        const STORAGE_KEY = 'oripa_simulator_v2';

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            attachEventListeners();
            updateTotalValue();
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function attachEventListeners() {
            // ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ã¿
            document.getElementById('packPrice').addEventListener('input', updateTotalValue);
            document.getElementById('totalPacks').addEventListener('input', updateTotalValue);
            // ä»–ã®é …ç›®ã¯æ‰‹å‹•è¨ˆç®—ã«å¤‰æ›´
        }

        // ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤ã®æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ãªã—ï¼‰
        function updateTotalValue() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalValue = packPrice * totalPacks;
            document.getElementById('totalValue').textContent = `Â¥${totalValue.toLocaleString()}`;

            // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå…¥åŠ›ä¸­ã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã—ãªã„ï¼‰
            document.getElementById('packPrice').classList.remove('error');
            document.getElementById('totalPacks').classList.remove('error');
            document.getElementById('totalReturnRate').classList.remove('error');
        }

        // ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒä¾¡å€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatPrizeValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // æ•°å­—ä»¥å¤–ã‚’é™¤å»
            if (value) {
                value = parseInt(value).toLocaleString(); // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«å¤‰æ›
            }
            input.value = value;
        }

        // åŸºæœ¬è¨­å®šå€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatBasicValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // æ•°å­—ä»¥å¤–ã‚’é™¤å»
            if (value) {
                value = parseInt(value).toLocaleString(); // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«å¤‰æ›
            }
            input.value = value;
            // ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤ã®ã¿æ›´æ–°
            setTimeout(updateTotalValue, 100);
        }

        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ•°å­—ã‚’æ•°å€¤ã«å¤‰æ›
        function parseFormattedNumber(value) {
            return parseFloat(value.replace(/,/g, '')) || 0;
        }

        // æ™¯å“è¿½åŠ 
        function addPrize() {
            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const purchasePrice = parseFormattedNumber(document.getElementById('prizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || purchasePrice <= 0 || value <= 0 || count <= 0) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const prize = {
                id: Date.now(),
                name: name,
                rank: rank,
                purchasePrice: purchasePrice,
                value: value,
                count: count
            };

            prizes.push(prize);

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('prizeName').value = '';
            document.getElementById('prizePurchasePrice').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';

            updatePrizeList();
            saveData();
        }

        // æ™¯å“å‰Šé™¤
        function removePrize(id) {
            prizes = prizes.filter(p => p.id !== id);
            updatePrizeList();
            saveData();
        }

        // æ™¯å“ãƒªã‚¹ãƒˆæ›´æ–°
        function updatePrizeList() {
            const container = document.getElementById('prizeList');
            
            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">æ™¯å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }

            // ç­‰ç´šé †ã«ã‚½ãƒ¼ãƒˆ
            prizes.sort((a, b) => a.rank - b.rank);

            container.innerHTML = prizes.map(prize => `
                <div class="prize-item">
                    <div class="prize-rank rank-${prize.rank}">${prize.rank}ç­‰</div>
                    <div class="prize-content">
                        <div class="prize-name">${prize.name}</div>
                        <div class="prize-purchase">ä»•å…¥Â¥${prize.purchasePrice.toLocaleString()}</div>
                        <div class="prize-value">é‚„å…ƒÂ¥${prize.value.toLocaleString()}</div>
                        <div class="prize-count">${prize.count}æš</div>
                        <button class="btn btn-danger" onclick="removePrize(${prize.id})">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // å€¤ã‚’10ã®ä½ã§ä¸¸ã‚ã‚‹ï¼ˆ1æ¡ã‚’0ã«ã™ã‚‹ï¼‰
        function roundToTens(value) {
            return Math.round(value / 10) * 10;
        }

        // ã‚¬ãƒãƒ£é›£æ˜“åº¦è¨­å®šã‚’å–å¾—
        function getDifficultySettings(difficulty) {
            switch(difficulty) {
                case 'easy':
                    return {
                        name: 'æ¯”è¼ƒçš„å½“ãŸã‚Šã‚„ã™ã„',
                        description: 'ãƒã‚ºãƒ¬ã®ä¾¡å€¤ãŒé«˜ã‚ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªè¨­è¨ˆ',
                        lossDistribution: [0.4, 0.35, 0.25], // é«˜é‚„å…ƒé‡è¦–
                        maxValueCap: 0.8 // ãƒ‘ãƒƒã‚¯å˜ä¾¡ã®80%ã¾ã§
                    };
                case 'hard':
                    return {
                        name: 'å½“ãŸã‚Šã«ãã„',
                        description: 'ãƒã‚ºãƒ¬ã®ä¾¡å€¤ãŒä½ã‚ã§ã€å¤§å½“ãŸã‚Šé‡è¦–ã®è¨­è¨ˆ',
                        lossDistribution: [0.15, 0.35, 0.5], // ä½é‚„å…ƒé‡è¦–
                        maxValueCap: 0.5 // ãƒ‘ãƒƒã‚¯å˜ä¾¡ã®50%ã¾ã§
                    };
                default: // normal
                    return {
                        name: 'æ™®é€š',
                        description: 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„æ¨™æº–çš„ãªè¨­è¨ˆ',
                        lossDistribution: [0.2, 0.5, 0.3], // ãƒãƒ©ãƒ³ã‚¹é‡è¦–
                        maxValueCap: 0.7 // ãƒ‘ãƒƒã‚¯å˜ä¾¡ã®70%ã¾ã§
                    };
            }
        }

        // ãƒ¡ã‚¤ãƒ³è¨ˆç®—
        function calculate() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalReturnRatePercent = parseFloat(document.getElementById('totalReturnRate').value) || 0;
            const totalReturnRate = totalReturnRatePercent / 100;
            const lossTypeCount = parseInt(document.getElementById('lossTypeCount').value) || 2;
            const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;
            const difficulty = document.getElementById('gachaDifficulty').value;

            if (packPrice <= 0 || totalPacks <= 0 || totalReturnRate <= 0) {
                return;
            }

            // è¨­å®šã‚’æ¤œè¨¼ã—ã€ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯å‡¦ç†ã‚’åœæ­¢
            if (!validateSettings()) {
                return;
            }

            // é›£æ˜“åº¦è¨­å®šã‚’å–å¾—
            const difficultySettings = getDifficultySettings(difficulty);
            
            // é›£æ˜“åº¦æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('difficultyInfo').innerHTML = `
                <strong>${difficultySettings.name}</strong><br>
                ${difficultySettings.description}
            `;

            // åŸºæœ¬è¨ˆç®—
            const totalValue = packPrice * totalPacks;
            const targetReturnValue = totalValue * totalReturnRate;

            // ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤è¡¨ç¤º
            document.getElementById('totalValue').textContent = `Â¥${totalValue.toLocaleString()}`;

            // æ™¯å“ç·ä¾¡å€¤è¨ˆç®—ï¼ˆãƒã‚¤ãƒ³ãƒˆé‚„å…ƒä¾¡å€¤ï¼‰
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // æ™¯å“ç·ä»•å…¥ã‚Œä¾¡æ ¼è¨ˆç®—
            const prizesTotalPurchasePrice = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);

            // å®Ÿè³ªé‚„å…ƒç‡è¨ˆç®—ï¼ˆä»•å…¥ã‚Œä¾¡æ ¼ãƒ™ãƒ¼ã‚¹ï¼‰
            const realReturnRate = totalValue > 0 ? (prizesTotalPurchasePrice / totalValue) * 100 : 0;

            // ãƒã‚ºãƒ¬è¨ˆç®—ï¼ˆé›£æ˜“åº¦ã«å¿œã˜ãŸé…åˆ†ï¼‰
            const lossCount = totalPacks - prizesTotalCount;
            const lossValue = targetReturnValue - prizesTotalValue;

            const lossTypes = [];

            if (lossCount > 0) {
                if (lossValue <= 0) {
                    // lossValueãŒ0ä»¥ä¸‹ã®å ´åˆã€æ®µéšçš„ãªä¾¡å€¤ã§ãƒã‚ºãƒ¬ã‚’ç”Ÿæˆ
                    console.log('lossValueãŒ0ä»¥ä¸‹ã®ãŸã‚ã€æ®µéšçš„ä¾¡å€¤ã§ãƒã‚ºãƒ¬ã‚’ç”Ÿæˆ');

                    // é›£æ˜“åº¦ã«å¿œã˜ãŸé…åˆ†æ¯”ç‡ã‚’ä½¿ç”¨
                    const distribution = difficultySettings.lossDistribution;

                    // å„ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã®æšæ•°ã‚’è¨ˆç®—
                    const lossCounts = [];
                    let allocated = 0;

                    for (let i = 0; i < lossTypeCount; i++) {
                        const ratio = distribution[i] || distribution[distribution.length - 1];
                        const count = Math.floor(lossCount * ratio);
                        lossCounts.push(count);
                        allocated += count;
                    }

                    let remaining = lossCount - allocated;
                    let index = 0;
                    while (remaining > 0) {
                        lossCounts[index % lossTypeCount]++;
                        remaining--;
                        index++;
                    }

                    // æœ€ä½ä¿è¨¼ä¾¡å€¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
                    const adjustedMinValue = roundToTens(minGuaranteeValue);

                    // å„ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã«ç•°ãªã‚‹ä¾¡å€¤ã‚’è¨­å®šï¼ˆæœ€ä½ä¿è¨¼ã‚ˆã‚Šé«˜ãï¼‰
                    for (let i = 0; i < lossTypeCount; i++) {
                        const count = lossCounts[i];
                        if (count > 0) {
                            let value;
                            if (i === lossTypeCount - 1) {
                                // æœ€å¾Œã®ã‚¿ã‚¤ãƒ—ã¯æœ€ä½ä¿è¨¼ä¾¡å€¤
                                value = adjustedMinValue;
                            } else {
                                // ä»–ã®ã‚¿ã‚¤ãƒ—ã¯æœ€ä½ä¿è¨¼ã‚ˆã‚Šé«˜ãã€æ®µéšçš„ã«è¨­å®š
                                value = adjustedMinValue + (lossTypeCount - 1 - i) * 10;
                            }

                            lossTypes.push({
                                name: i === lossTypeCount - 1 ?
                                    `ãƒã‚ºãƒ¬${String.fromCharCode(65 + i)}ï¼ˆæœ€ä½ä¿è¨¼ï¼‰` :
                                    `ãƒã‚ºãƒ¬${String.fromCharCode(65 + i)}`,
                                value: value,
                                count: count,
                                type: i === lossTypeCount - 1 ? 'min' : 'normal'
                            });
                        }
                    }
                } else {
                // é›£æ˜“åº¦ã«å¿œã˜ãŸé…åˆ†æ¯”ç‡ã‚’ä½¿ç”¨
                const distribution = difficultySettings.lossDistribution;
                
                // å„ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã®æšæ•°ã‚’è¨ˆç®—
                const lossCounts = [];
                let allocated = 0;
                
                // å„ã‚¿ã‚¤ãƒ—ã®åŸºæœ¬é…åˆ†ã‚’è¨ˆç®—
                for (let i = 0; i < lossTypeCount; i++) {
                    const ratio = distribution[i] || distribution[distribution.length - 1];
                    const count = Math.floor(lossCount * ratio);
                    lossCounts.push(count);
                    allocated += count;
                }
                
                // æ®‹ã‚Šæšæ•°ã‚’å‡ç­‰ã«é…åˆ†
                let remaining = lossCount - allocated;
                let index = 0;
                while (remaining > 0) {
                    lossCounts[index % lossTypeCount]++;
                    remaining--;
                    index++;
                }

                // æœ€ä½ä¿è¨¼ä¾¡å€¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
                const adjustedMinValue = roundToTens(minGuaranteeValue);

                // æœ€ä½ä¿è¨¼ã®ç·ä¾¡å€¤
                const minTotalValue = adjustedMinValue * lossCounts[lossTypeCount - 1];

                // æ®‹ã‚Šã®ä¾¡å€¤ã‚’ä»–ã®ãƒã‚ºãƒ¬ã«é…åˆ†
                const remainingValue = lossValue - minTotalValue;
                const remainingTypes = lossTypeCount - 1;

                // å„ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã®ä¾¡å€¤ã‚’è¨ˆç®—ï¼ˆæœ€ä½ä¿è¨¼ã‚ˆã‚Šå¿…ãšé«˜ãã€ã‹ã¤ç•°ãªã‚‹ä¾¡æ ¼ã«ï¼‰
                const lossValues = [];
                for (let i = 0; i < remainingTypes; i++) {
                    const count = lossCounts[i];
                    if (count > 0) {
                        // é›£æ˜“åº¦ã«å¿œã˜ãŸä¾¡å€¤é…åˆ†
                        let valueRatio;
                        if (difficulty === 'easy') {
                            // æ˜“ã—ã„ï¼šé«˜é‚„å…ƒãƒã‚ºãƒ¬ã‚’å¤šã‚ã«
                            valueRatio = (remainingTypes - i + 2) / (remainingTypes + 2);
                        } else if (difficulty === 'hard') {
                            // å³ã—ã„ï¼šé«˜é‚„å…ƒãƒã‚ºãƒ¬ã‚’å°‘ãªã‚ã«
                            valueRatio = Math.pow((remainingTypes - i) / remainingTypes, 2);
                        } else {
                            // æ™®é€šï¼šæ¨™æº–çš„ãªé…åˆ†
                            valueRatio = (remainingTypes - i) / remainingTypes;
                        }

                        let value = remainingValue * valueRatio / count;

                        // é›£æ˜“åº¦ã«å¿œã˜ãŸæœ€å¤§å€¤åˆ¶é™
                        const maxValue = packPrice * difficultySettings.maxValueCap;
                        value = Math.min(value, maxValue);

                        // æœ€ä½ä¿è¨¼ä¾¡å€¤ã‚ˆã‚Šå¿…ãšé«˜ãã™ã‚‹ï¼ˆæœ€ä½+10å††ï¼‰
                        value = Math.max(adjustedMinValue + 10, value);

                        // ã‚­ãƒªã®è‰¯ã„æ•°ã«ä¸¸ã‚ã‚‹
                        value = roundToTens(value);

                        lossValues.push({ index: i, value: value, count: count });
                    }
                }

                // ä¾¡æ ¼ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã«èª¿æ•´
                lossValues.sort((a, b) => b.value - a.value); // é«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
                for (let i = 1; i < lossValues.length; i++) {
                    // å‰ã®ä¾¡æ ¼ã¨åŒã˜å ´åˆã¯å°‘ã—ä¸‹ã’ã‚‹ï¼ˆãŸã ã—æœ€ä½ä¿è¨¼ã‚ˆã‚Šä¸Šã‚’ç¶­æŒï¼‰
                    if (lossValues[i].value >= lossValues[i-1].value) {
                        lossValues[i].value = Math.max(
                            adjustedMinValue + 10,
                            lossValues[i-1].value - 10
                        );
                    }
                    // ã•ã‚‰ã«é‡è¤‡ãŒã‚ã‚‹å ´åˆã®èª¿æ•´
                    while (i > 0 && lossValues[i].value >= lossValues[i-1].value && lossValues[i].value > adjustedMinValue + 10) {
                        lossValues[i].value -= 10;
                    }
                }

                // ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ 
                lossValues.forEach(loss => {
                    lossTypes.push({
                        name: `ãƒã‚ºãƒ¬${String.fromCharCode(65 + loss.index)}`,
                        value: loss.value,
                        count: loss.count,
                        type: 'normal'
                    });
                });

                // æœ€ä½ä¿è¨¼ã‚’è¿½åŠ 
                lossTypes.push({
                    name: `ãƒã‚ºãƒ¬${String.fromCharCode(65 + remainingTypes)}ï¼ˆæœ€ä½ä¿è¨¼ï¼‰`,
                    value: adjustedMinValue,
                    count: lossCounts[lossTypeCount - 1],
                    type: 'min'
                });
                }
            }

            // æœŸå¾…å€¤è¨ˆç®—
            let expectedValue = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (prize.value * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                expectedValue += loss.value * probability;
            });

            // æ¨™æº–åå·®è¨ˆç®—
            let variance = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (Math.pow(prize.value - expectedValue, 2) * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                variance += Math.pow(loss.value - expectedValue, 2) * probability;
            });
            
            const stdDev = Math.sqrt(variance);

            // çµæœè¡¨ç¤ºæ›´æ–°
            updateResults({
                totalReturnRatePercent,
                realReturnRate,
                expectedValue,
                stdDev,
                lossTypes,
                lossCount,
                totalPacks,
                packPrice
            });
        }

        // çµæœè¡¨ç¤ºæ›´æ–°
        function updateResults(data) {
            document.getElementById('summaryTotalReturn').textContent = `${data.totalReturnRatePercent.toFixed(1)}%`;
            document.getElementById('summaryRealReturn').textContent = `${data.realReturnRate.toFixed(1)}%`;
            document.getElementById('summaryExpectedValue').textContent = `Â¥${data.expectedValue.toLocaleString()}`;
            document.getElementById('summaryStdDev').textContent = `Â¥${data.stdDev.toLocaleString()}`;
            
            // ç·å½“é¸è€…æ•°ã‚’è¡¨ç¤º
            const totalWinners = prizes.reduce((sum, prize) => sum + prize.count, 0);
            document.getElementById('summaryWinnerCount').textContent = `${totalWinners}äºº`;

            // ç·ä»•å…¥ã‚Œé¡ã‚’è¡¨ç¤º
            const totalPurchaseAmount = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);
            document.getElementById('summaryTotalPurchase').textContent = `Â¥${totalPurchaseAmount.toLocaleString()}`;

            // å½“ãŸã‚Šæ™¯å“é‚„å…ƒç·é¡ã‚’è¡¨ç¤º
            const prizeTotalReward = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            document.getElementById('summaryPrizeTotalReward').textContent = `Â¥${prizeTotalReward.toLocaleString()}`;

            // ãƒã‚ºãƒ¬é‚„å…ƒç·é¡ã‚’è¡¨ç¤º
            const lossTotalReward = data.lossTypes ? data.lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0) : 0;
            document.getElementById('summaryLossTotalReward').textContent = `Â¥${lossTotalReward.toLocaleString()}`;

            // æ™¯å“è©³ç´°æ›´æ–°
            updatePrizeDetails();

            // ãƒã‚ºãƒ¬è©³ç´°æ›´æ–°
            updateLossDetails(data.lossTypes, data.lossCount);
            
            // ãƒã‚ºãƒ¬åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            drawLossDistributionChart(data.lossTypes);

            // è­¦å‘Šè¡¨ç¤ºã®æ›´æ–°
            updateWarnings(data);
        }

        // æ™¯å“è©³ç´°æ›´æ–°
        function updatePrizeDetails() {
            const container = document.getElementById('prizeDetails');
            
            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">æ™¯å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }

            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            
            container.innerHTML = prizes.map(prize => {
                const probability = totalPacks > 0 ? (prize.count / totalPacks * 100).toFixed(2) : '0.00';
                return `
                    <div class="result-row">
                        <span class="result-label">${prize.rank}ç­‰ ${prize.name}</span>
                        <span class="result-value">${probability}% (ä»•å…¥Â¥${prize.purchasePrice.toLocaleString()} / é‚„å…ƒÂ¥${prize.value.toLocaleString()})</span>
                    </div>
                `;
            }).join('');
        }

        // ãƒã‚ºãƒ¬è©³ç´°æ›´æ–°
        function updateLossDetails(lossTypes, lossCount) {
            const container = document.getElementById('lossDetailsContainer');
            
            if (!lossTypes || lossTypes.length === 0) {
                container.innerHTML = '<div class="result-row"><span class="result-label">ãƒã‚ºãƒ¬ãªã—</span><span class="result-value">-</span></div>';
                document.getElementById('totalLossCount').textContent = '0æš';
                return;
            }

            container.innerHTML = lossTypes.map(loss => {
                const probability = lossCount > 0 ? ((loss.count / lossCount) * 100).toFixed(1) : '0.0';
                return `
                    <div class="result-row">
                        <span class="result-label">${loss.name}</span>
                        <span class="result-value">Â¥${loss.value.toLocaleString()} Ã— ${loss.count}æš (${probability}%)</span>
                    </div>
                `;
            }).join('');

            document.getElementById('totalLossCount').textContent = `${lossCount}æš`;
        }



        // ãƒã‚ºãƒ¬å½“é¸è€…åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆæç”»
        function drawLossDistributionChart(lossTypes) {
            const canvas = document.getElementById('lossDistributionChart');
            const ctx = canvas.getContext('2d');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!lossTypes || lossTypes.length === 0) {
                ctx.fillStyle = '#8E8E93';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ãƒã‚ºãƒ¬ãªã—', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const padding = 40;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF'];
            const total = lossTypes.reduce((sum, loss) => sum + loss.count, 0);
            
            if (total === 0) return;
            
            // æ£’ã‚°ãƒ©ãƒ•ã¨ã—ã¦æç”»
            const barWidth = width / lossTypes.length * 0.8;
            const barSpacing = width / lossTypes.length * 0.2;
            const maxCount = Math.max(...lossTypes.map(loss => loss.count));
            
            lossTypes.forEach((loss, index) => {
                const x = padding + index * (barWidth + barSpacing) + barSpacing / 2;
                const barHeight = (loss.count / maxCount) * height;
                const y = canvas.height - padding - barHeight;
                
                // æ£’ã‚’æç”»
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // æšæ•°ã‚’è¡¨ç¤º
                ctx.fillStyle = '#000000';
                ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(loss.count + 'æš', x + barWidth / 2, y - 5);
                
                // åå‰ã‚’è¡¨ç¤º
                ctx.fillText(loss.name, x + barWidth / 2, canvas.height - 10);
                
                // å‰²åˆã‚’è¡¨ç¤º
                const percentage = ((loss.count / total) * 100).toFixed(1);
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(percentage + '%', x + barWidth / 2, y + barHeight / 2);
            });
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ãƒã‚ºãƒ¬å½“é¸è€…åˆ†å¸ƒ', canvas.width / 2, 20);
        }

        // è¨­å®šæ¤œè¨¼ã¨ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function validateSettings() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalReturnRatePercent = parseFloat(document.getElementById('totalReturnRate').value) || 0;
            const targetReturnValue = packPrice * totalPacks * (totalReturnRatePercent / 100);
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('totalReturnRate').classList.remove('error');
            document.getElementById('totalPacks').classList.remove('error');

            let hasError = false;
            let errorMessages = [];

            // æ™¯å“æšæ•°ãŒç·å£æ•°ã‚’è¶…ãˆã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (prizesTotalCount > totalPacks) {
                document.getElementById('totalPacks').classList.add('error');
                hasError = true;
                errorMessages.push(`æ™¯å“ã®ç·æšæ•°ï¼ˆ${prizesTotalCount}æšï¼‰ãŒç·å£æ•°ï¼ˆ${totalPacks}å£ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
            }

            // æ™¯å“ä¾¡å€¤ãŒç›®æ¨™é‚„å…ƒä¾¡å€¤ã‚’è¶…ãˆã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (prizesTotalValue > targetReturnValue) {
                document.getElementById('totalReturnRate').classList.add('error');
                hasError = true;
                const requiredReturnRate = Math.ceil((prizesTotalValue / (packPrice * totalPacks)) * 100);
                errorMessages.push(`æ™¯å“ã®é‚„å…ƒä¾¡å€¤åˆè¨ˆï¼ˆÂ¥${prizesTotalValue.toLocaleString()}ï¼‰ãŒç›®æ¨™é‚„å…ƒä¾¡å€¤ï¼ˆÂ¥${targetReturnValue.toLocaleString()}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ç·é‚„å…ƒç‡ã‚’${requiredReturnRate}%ä»¥ä¸Šã«è¨­å®šã™ã‚‹ã‹ã€æ™¯å“ä¾¡å€¤ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚`);
            }

            if (hasError) {
                showErrorPopup(errorMessages);
                return false;
            }

            return true;
        }

        // ã‚¨ãƒ©ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        function showErrorPopup(messages) {
            const errorMessage = messages.join('\n\n');
            alert(`âš ï¸ è¨­å®šã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™\n\n${errorMessage}`);
        }

        // è­¦å‘Šè¡¨ç¤ºæ›´æ–°ï¼ˆè»½å¾®ãªè­¦å‘Šç”¨ï¼‰
        function updateWarnings(data) {
            const warningsContainer = document.getElementById('warnings');
            const warnings = [];

            // å®Ÿéš›ã®ç·é‚„å…ƒç‡ã¨è¨­å®šé‚„å…ƒç‡ã®è»½å¾®ãªä¹–é›¢ã‚’è­¦å‘Š
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalReturnRatePercent = parseFloat(document.getElementById('totalReturnRate').value) || 0;
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const lossTotalValue = data.lossTypes ? data.lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0) : 0;
            const actualTotalReturnValue = prizesTotalValue + lossTotalValue;
            const actualReturnRate = (actualTotalReturnValue / (packPrice * totalPacks)) * 100;
            const returnRateDiff = Math.abs(actualReturnRate - totalReturnRatePercent);

            // ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«ã§ãªã„è»½å¾®ãªä¹–é›¢ã®ã¿è­¦å‘Šè¡¨ç¤º
            if (returnRateDiff > 1 && returnRateDiff <= 5) {
                warnings.push(`
                    <div class="warning">
                        â„¹ï¸ <strong>é‚„å…ƒç‡ã«è»½å¾®ãªä¹–é›¢ãŒã‚ã‚Šã¾ã™</strong><br>
                        è¨­å®šé‚„å…ƒç‡: ${totalReturnRatePercent}% / å®Ÿéš›ã®é‚„å…ƒç‡: ${actualReturnRate.toFixed(1)}%<br>
                        å·®: ${returnRateDiff.toFixed(1)}%
                    </div>
                `);
            }

            warningsContainer.innerHTML = warnings.join('');
        }


        // å±¥æ­´ä¿å­˜
        function saveToHistory() {
            const name = document.getElementById('historyName').value.trim();
            
            if (!name) {
                alert('è¨­å®šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const settings = {
                id: Date.now(),
                name: name,
                date: new Date().toLocaleString('ja-JP'),
                packPrice: document.getElementById('packPrice').value,
                totalPacks: document.getElementById('totalPacks').value,
                totalReturnRate: document.getElementById('totalReturnRate').value,
                lossTypeCount: document.getElementById('lossTypeCount').value,
                minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
                gachaDifficulty: document.getElementById('gachaDifficulty').value,
                prizes: [...prizes]
            };

            history.unshift(settings);
            document.getElementById('historyName').value = '';
            
            updateHistoryList();
            saveData();
        }

        // å±¥æ­´ã‹ã‚‰èª­ã¿è¾¼ã¿
        function loadFromHistory(id) {
            const settings = history.find(h => h.id === id);
            if (!settings) return;

            document.getElementById('packPrice').value = settings.packPrice;
            document.getElementById('totalPacks').value = settings.totalPacks;
            document.getElementById('totalReturnRate').value = settings.totalReturnRate;
            if (settings.lossTypeCount) document.getElementById('lossTypeCount').value = settings.lossTypeCount;
            if (settings.minGuaranteeValue) document.getElementById('minGuaranteeValue').value = settings.minGuaranteeValue;
            if (settings.gachaDifficulty) document.getElementById('gachaDifficulty').value = settings.gachaDifficulty;
            prizes = [...settings.prizes];

            updatePrizeList();
            updateTotalValue();
        }

        // å±¥æ­´å‰Šé™¤
        function removeFromHistory(id) {
            if (confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                history = history.filter(h => h.id !== id);
                updateHistoryList();
                saveData();
            }
        }

        // å±¥æ­´ãƒªã‚¹ãƒˆæ›´æ–°
        function updateHistoryList() {
            const container = document.getElementById('historyList');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; padding: 20px 0;">ä¿å­˜æ¸ˆã¿ã®è¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadFromHistory(${item.id})">
                    <div class="history-name">${item.name}</div>
                    <div class="history-meta">${item.date}</div>
                    <button class="btn btn-danger" onclick="event.stopPropagation(); removeFromHistory(${item.id})" style="float: right; margin-top: -30px;">å‰Šé™¤</button>
                </div>
            `).join('');
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveData() {
            const data = {
                prizes: prizes,
                history: history,
                settings: {
                    packPrice: document.getElementById('packPrice').value,
                    totalPacks: document.getElementById('totalPacks').value,
                    totalReturnRate: document.getElementById('totalReturnRate').value,
                    lossTypeCount: document.getElementById('lossTypeCount').value,
                    minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
                    gachaDifficulty: document.getElementById('gachaDifficulty').value
                }
            };

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.prizes) {
                        prizes = data.prizes;
                        updatePrizeList();
                    }
                    
                    if (data.history) {
                        history = data.history;
                        updateHistoryList();
                    }

                    if (data.settings) {
                        document.getElementById('packPrice').value = data.settings.packPrice || '40000';
                        document.getElementById('totalPacks').value = data.settings.totalPacks || '100';
                        document.getElementById('totalReturnRate').value = data.settings.totalReturnRate || 98;
                        document.getElementById('lossTypeCount').value = data.settings.lossTypeCount || 2;
                        document.getElementById('minGuaranteeValue').value = data.settings.minGuaranteeValue || '1000';
                        document.getElementById('gachaDifficulty').value = data.settings.gachaDifficulty || 'normal';
                    }
                }
            } catch (e) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function showModal() {
            document.getElementById('historyModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('historyModal').classList.remove('show');
        }

        function confirmSaveHistory() {
            const name = document.getElementById('modalHistoryName').value.trim();
            if (name) {
                document.getElementById('historyName').value = name;
                saveToHistory();
                closeModal();
                document.getElementById('modalHistoryName').value = '';
            }
        }

        // è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportSettings() {
            const exportData = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                currentSettings: {
                    packPrice: document.getElementById('packPrice').value,
                    totalPacks: document.getElementById('totalPacks').value,
                    totalReturnRate: document.getElementById('totalReturnRate').value,
                    lossTypeCount: document.getElementById('lossTypeCount').value,
                    minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
                    gachaDifficulty: document.getElementById('gachaDifficulty').value,
                    prizes: [...prizes]
                },
                history: [...history]
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            const now = new Date();
            const dateTime = now.toISOString().slice(0, 19).replace(/:/g, '-');
            link.download = `oripa-settings-${dateTime}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼\nãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™ã€‚');
        }

        // è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importSettings() {
            document.getElementById('importFile').click();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/json') {
                alert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
                    if (!importData.version) {
                        alert('å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã›ã‚“ã€‚');
                        return;
                    }

                    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                    const confirmMessage = `è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                        `- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ—¥æ™‚: ${new Date(importData.exportDate).toLocaleString('ja-JP')}\n` +
                        `- å±¥æ­´ä»¶æ•°: ${importData.history ? importData.history.length : 0}ä»¶\n` +
                        `- æ™¯å“æ•°: ${importData.currentSettings.prizes ? importData.currentSettings.prizes.length : 0}å€‹\n\n` +
                        `â€» ç¾åœ¨ã®è¨­å®šã¨å±¥æ­´ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™`;

                    if (!confirm(confirmMessage)) {
                        return;
                    }

                    // ç¾åœ¨ã®è¨­å®šã‚’å¾©å…ƒ
                    if (importData.currentSettings) {
                        const settings = importData.currentSettings;
                        document.getElementById('packPrice').value = settings.packPrice || '40000';
                        document.getElementById('totalPacks').value = settings.totalPacks || '100';
                        document.getElementById('totalReturnRate').value = settings.totalReturnRate || 98;
                        if (settings.lossTypeCount) document.getElementById('lossTypeCount').value = settings.lossTypeCount;
                        if (settings.minGuaranteeValue) document.getElementById('minGuaranteeValue').value = settings.minGuaranteeValue;
                        if (settings.gachaDifficulty) document.getElementById('gachaDifficulty').value = settings.gachaDifficulty;
                        
                        // æ™¯å“ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                        if (settings.prizes) {
                            prizes = [...settings.prizes];
                            updatePrizeList();
                        }
                    }

                    // å±¥æ­´ã‚’å¾©å…ƒ
                    if (importData.history) {
                        history = [...importData.history];
                        updateHistoryList();
                    }

                    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    saveData();

                    // ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤ã®ã¿æ›´æ–°
                    updateTotalValue();

                    alert('è¨­å®šã‚’æ­£å¸¸ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');

                } catch (error) {
                    console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                }
            };

            reader.readAsText(file);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            event.target.value = '';
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // ã‚¬ãƒãƒ£ä½“é¨“æ©Ÿèƒ½
        let gachaDrawHistory = [];
        let gachaPool = [];

        // ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆ
        function generateGachaPool() {
            gachaPool = [];
            
            // æ™¯å“ã‚’è¿½åŠ 
            prizes.forEach(prize => {
                for (let i = 0; i < prize.count; i++) {
                    gachaPool.push({
                        type: 'prize',
                        item: prize
                    });
                }
            });
            
            // ç¾åœ¨ã®è¨­å®šã§ãƒã‚ºãƒ¬ã‚’è¨ˆç®—
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalReturnRatePercent = parseFloat(document.getElementById('totalReturnRate').value) || 95.0;

            if (packPrice > 0 && totalPacks > 0) {
                const totalValue = packPrice * totalPacks;
                const targetReturnValue = totalValue * (totalReturnRatePercent / 100);

                // é›£æ˜“åº¦è¨­å®šã‚’å–å¾—
                const difficulty = document.getElementById('gachaDifficulty').value;
                const difficultySettings = getDifficultySettings(difficulty);
                const lossTypeCount = parseInt(document.getElementById('lossTypeCount').value) || 2;
                const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;
                
                const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
                const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

                const lossCount = totalPacks - prizesTotalCount;
                const lossValue = targetReturnValue - prizesTotalValue;
                
                console.log('ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆãƒ‡ãƒãƒƒã‚°:', {
                    totalPacks: totalPacks,
                    prizesTotalCount: prizesTotalCount,
                    lossCount,
                    targetReturnValue: targetReturnValue,
                    prizesTotalValue,
                    lossValue
                });
                
                if (lossCount > 0) {
                    // ãƒ¡ã‚¤ãƒ³è¨ˆç®—ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã‚’ç”Ÿæˆ
                    const lossTypes = [];

                    if (lossValue <= 0) {
                        // lossValueãŒ0ä»¥ä¸‹ã®å ´åˆã€æ®µéšçš„ãªä¾¡å€¤ã§ãƒã‚ºãƒ¬ã‚’ç”Ÿæˆ
                        console.log('lossValueãŒ0ä»¥ä¸‹ã®ãŸã‚ã€æ®µéšçš„ä¾¡å€¤ã§ãƒã‚ºãƒ¬ã‚’ç”Ÿæˆ');

                        // é›£æ˜“åº¦ã«å¿œã˜ãŸé…åˆ†æ¯”ç‡ã‚’ä½¿ç”¨
                        const distribution = difficultySettings.lossDistribution;

                        // å„ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã®æšæ•°ã‚’è¨ˆç®—
                        const lossCounts = [];
                        let allocated = 0;

                        for (let i = 0; i < lossTypeCount; i++) {
                            const ratio = distribution[i] || distribution[distribution.length - 1];
                            const count = Math.floor(lossCount * ratio);
                            lossCounts.push(count);
                            allocated += count;
                        }

                        let remaining = lossCount - allocated;
                        let index = 0;
                        while (remaining > 0) {
                            lossCounts[index % lossTypeCount]++;
                            remaining--;
                            index++;
                        }

                        // æœ€ä½ä¿è¨¼ä¾¡å€¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
                        const adjustedMinValue = Math.max(10, Math.round(minGuaranteeValue / 10) * 10);

                        // å„ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã«ç•°ãªã‚‹ä¾¡å€¤ã‚’è¨­å®šï¼ˆæœ€ä½ä¿è¨¼ã‚ˆã‚Šé«˜ãï¼‰
                        for (let i = 0; i < lossTypeCount; i++) {
                            const count = lossCounts[i];
                            if (count > 0) {
                                let value;
                                if (i === lossTypeCount - 1) {
                                    // æœ€å¾Œã®ã‚¿ã‚¤ãƒ—ã¯æœ€ä½ä¿è¨¼ä¾¡å€¤
                                    value = adjustedMinValue;
                                } else {
                                    // ä»–ã®ã‚¿ã‚¤ãƒ—ã¯æœ€ä½ä¿è¨¼ã‚ˆã‚Šé«˜ãã€æ®µéšçš„ã«è¨­å®š
                                    value = adjustedMinValue + (lossTypeCount - 1 - i) * 10;
                                }

                                lossTypes.push({
                                    name: i === lossTypeCount - 1 ?
                                        `ãƒã‚ºãƒ¬${String.fromCharCode(65 + i)}ï¼ˆæœ€ä½ä¿è¨¼ï¼‰` :
                                        `ãƒã‚ºãƒ¬${String.fromCharCode(65 + i)}`,
                                    value: value,
                                    count: count,
                                    type: i === lossTypeCount - 1 ? 'min' : 'normal'
                                });
                            }
                        }
                    } else {
                        // æ­£å¸¸ãªãƒã‚ºãƒ¬ä¾¡å€¤é…åˆ†å‡¦ç†ï¼ˆãƒ¡ã‚¤ãƒ³è¨ˆç®—ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                        const distribution = difficultySettings.lossDistribution;

                        // å„ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã®æšæ•°ã‚’è¨ˆç®—
                        const lossCounts = [];
                        let allocated = 0;

                        for (let i = 0; i < lossTypeCount; i++) {
                            const ratio = distribution[i] || distribution[distribution.length - 1];
                            const count = Math.floor(lossCount * ratio);
                            lossCounts.push(count);
                            allocated += count;
                        }

                        let remaining = lossCount - allocated;
                        let index = 0;
                        while (remaining > 0) {
                            lossCounts[index % lossTypeCount]++;
                            remaining--;
                            index++;
                        }

                        // æœ€ä½ä¿è¨¼ä¾¡å€¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
                        const adjustedMinValue = Math.max(10, Math.round(minGuaranteeValue / 10) * 10);

                        // æœ€ä½ä¿è¨¼ã®ç·ä¾¡å€¤
                        const minTotalValue = adjustedMinValue * lossCounts[lossTypeCount - 1];

                        // æ®‹ã‚Šã®ä¾¡å€¤ã‚’ä»–ã®ãƒã‚ºãƒ¬ã«é…åˆ†
                        const remainingValue = lossValue - minTotalValue;
                        const remainingTypes = lossTypeCount - 1;

                        // å„ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã®ä¾¡å€¤ã‚’è¨ˆç®—ï¼ˆæœ€ä½ä¿è¨¼ã‚ˆã‚Šå¿…ãšé«˜ãã€ã‹ã¤ç•°ãªã‚‹ä¾¡æ ¼ã«ï¼‰
                        const lossValues = [];
                        for (let i = 0; i < remainingTypes; i++) {
                            const count = lossCounts[i];
                            if (count > 0) {
                                // é›£æ˜“åº¦ã«å¿œã˜ãŸä¾¡å€¤é…åˆ†
                                let valueRatio;
                                if (difficulty === 'easy') {
                                    // æ˜“ã—ã„ï¼šé«˜é‚„å…ƒãƒã‚ºãƒ¬ã‚’å¤šã‚ã«
                                    valueRatio = (remainingTypes - i + 2) / (remainingTypes + 2);
                                } else if (difficulty === 'hard') {
                                    // å³ã—ã„ï¼šé«˜é‚„å…ƒãƒã‚ºãƒ¬ã‚’å°‘ãªã‚ã«
                                    valueRatio = Math.pow((remainingTypes - i) / remainingTypes, 2);
                                } else {
                                    // æ™®é€šï¼šæ¨™æº–çš„ãªé…åˆ†
                                    valueRatio = (remainingTypes - i) / remainingTypes;
                                }

                                let value = remainingValue * valueRatio / count;

                                // é›£æ˜“åº¦ã«å¿œã˜ãŸæœ€å¤§å€¤åˆ¶é™
                                const maxValue = packPrice * difficultySettings.maxValueCap;
                                value = Math.min(value, maxValue);

                                // æœ€ä½ä¿è¨¼ä¾¡å€¤ã‚ˆã‚Šå¿…ãšé«˜ãã™ã‚‹ï¼ˆæœ€ä½+10å††ï¼‰
                                value = Math.max(adjustedMinValue + 10, value);

                                // ã‚­ãƒªã®è‰¯ã„æ•°ã«ä¸¸ã‚ã‚‹
                                value = Math.max(10, Math.round(value / 10) * 10);

                                lossValues.push({ index: i, value: value, count: count });
                            }
                        }

                        // ä¾¡æ ¼ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã«èª¿æ•´
                        lossValues.sort((a, b) => b.value - a.value); // é«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
                        for (let i = 1; i < lossValues.length; i++) {
                            // å‰ã®ä¾¡æ ¼ã¨åŒã˜å ´åˆã¯å°‘ã—ä¸‹ã’ã‚‹ï¼ˆãŸã ã—æœ€ä½ä¿è¨¼ã‚ˆã‚Šä¸Šã‚’ç¶­æŒï¼‰
                            if (lossValues[i].value >= lossValues[i-1].value) {
                                lossValues[i].value = Math.max(
                                    adjustedMinValue + 10,
                                    lossValues[i-1].value - 10
                                );
                            }
                            // ã•ã‚‰ã«é‡è¤‡ãŒã‚ã‚‹å ´åˆã®èª¿æ•´
                            while (i > 0 && lossValues[i].value >= lossValues[i-1].value && lossValues[i].value > adjustedMinValue + 10) {
                                lossValues[i].value -= 10;
                            }
                        }

                        // ãƒã‚ºãƒ¬ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ 
                        lossValues.forEach(loss => {
                            lossTypes.push({
                                name: `ãƒã‚ºãƒ¬${String.fromCharCode(65 + loss.index)}`,
                                value: loss.value,
                                count: loss.count,
                                type: 'normal'
                            });
                        });

                        // æœ€ä½ä¿è¨¼ã‚’è¿½åŠ 
                        lossTypes.push({
                            name: `ãƒã‚ºãƒ¬${String.fromCharCode(65 + remainingTypes)}ï¼ˆæœ€ä½ä¿è¨¼ï¼‰`,
                            value: adjustedMinValue,
                            count: lossCounts[lossTypeCount - 1],
                            type: 'min'
                        });
                    }

                    // ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ã«ãƒã‚ºãƒ¬ã‚’è¿½åŠ 
                    lossTypes.forEach(lossType => {
                        console.log(`${lossType.name} ç”Ÿæˆ:`, { count: lossType.count, value: lossType.value });
                        for (let j = 0; j < lossType.count; j++) {
                            gachaPool.push({
                                type: 'loss',
                                item: {
                                    name: lossType.name,
                                    value: lossType.value,
                                    rank: 'loss'
                                }
                            });
                        }
                    });
                } else {
                    console.log('ãƒã‚ºãƒ¬ç”Ÿæˆã‚¹ã‚­ãƒƒãƒ—:', { lossCount, reason: 'lossCount <= 0' });
                }
            }
            
            // ãƒ—ãƒ¼ãƒ«ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            for (let i = gachaPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gachaPool[i], gachaPool[j]] = [gachaPool[j], gachaPool[i]];
            }
            
            console.log('ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆå®Œäº†:', {
                totalItems: gachaPool.length,
                prizes: gachaPool.filter(item => item.type === 'prize').length,
                losses: gachaPool.filter(item => item.type === 'loss').length,
                expectedTotal: totalPacks
            });

            // æœ€çµ‚çš„ãªã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
            if (gachaPool.length !== totalPacks) {
                console.error('ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼:', {
                    expected: totalPacks,
                    actual: gachaPool.length,
                    difference: gachaPool.length - totalPacks
                });
            }
        }

        // ã‚¬ãƒãƒ£ã‚’å¼•ã
        function drawGacha(count) {
            if (gachaPool.length === 0) {
                alert('å…ˆã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚’ã—ã¦ã‚¬ãƒãƒ£ã®è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ã®ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            if (gachaPool.length !== totalPacks) {
                console.warn('ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚ºãŒè¨­å®šã¨ç•°ãªã‚Šã¾ã™:', {
                    expected: totalPacks,
                    actual: gachaPool.length
                });
            }
            
            if (gachaPool.length < count) {
                alert(`æ®‹ã‚Š${gachaPool.length}æšã—ã‹ã‚ã‚Šã¾ã›ã‚“`);
                count = gachaPool.length;
            }
            
            const draws = [];
            for (let i = 0; i < count; i++) {
                if (gachaPool.length > 0) {
                    const drawnItem = gachaPool.shift();
                    console.log('ã‚¬ãƒãƒ£çµæœ:', drawnItem);
                    draws.push(drawnItem);
                    gachaDrawHistory.push(drawnItem);
                }
            }
            
            updateGachaResults();
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('resetGachaBtn').style.display = 'block';
            document.getElementById('gachaResults').style.display = 'block';
        }

        // ã‚¬ãƒãƒ£çµæœã‚’æ›´æ–°
        function updateGachaResults() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            
            // çµ±è¨ˆè¨ˆç®—
            const totalDraws = gachaDrawHistory.length;
            const prizeCount = gachaDrawHistory.filter(draw => draw.type === 'prize').length;
            const totalValue = gachaDrawHistory.reduce((sum, draw) => sum + draw.item.value, 0);
            const totalCost = totalDraws * packPrice;
            const profit = totalValue - totalCost;
            
            // çµ±è¨ˆè¡¨ç¤º
            document.getElementById('gachaStats').innerHTML = `
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${totalDraws}</div>
                    <div class="gacha-stat-label">ç·å¼•ãå›æ•°</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${prizeCount}</div>
                    <div class="gacha-stat-label">å½“é¸å›æ•°</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">Â¥${totalValue.toLocaleString()}</div>
                    <div class="gacha-stat-label">ç·é‚„å…ƒä¾¡å€¤</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value" style="color: ${profit >= 0 ? 'var(--sf-green)' : 'var(--sf-red)'}">
                        ${profit >= 0 ? '+' : ''}Â¥${profit.toLocaleString()}
                    </div>
                    <div class="gacha-stat-label">åæ”¯</div>
                </div>
            `;
            
            // å±¥æ­´è¡¨ç¤ºï¼ˆæœ€æ–°10ä»¶ï¼‰
            const recentDraws = gachaDrawHistory.slice(-10).reverse();
            document.getElementById('gachaHistory').innerHTML = `
                <h5 style="margin-bottom: 10px;">æœ€æ–°ã®å¼•ãçµæœ</h5>
                ${recentDraws.map(draw => `
                    <div class="gacha-draw-item ${draw.type === 'prize' ? 'gacha-draw-prize' : 'gacha-draw-loss'}">
                        <span>${draw.item.name}</span>
                        <span>Â¥${draw.item.value.toLocaleString()}</span>
                    </div>
                `).join('')}
            `;
        }

        // ã‚¬ãƒãƒ£ãƒªã‚»ãƒƒãƒˆ
        function resetGacha() {
            if (confirm('ã‚¬ãƒãƒ£çµæœã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                gachaDrawHistory = [];
                generateGachaPool();
                document.getElementById('resetGachaBtn').style.display = 'none';
                document.getElementById('gachaResults').style.display = 'none';
            }
        }

        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ã‚‚ç”Ÿæˆ
        const originalCalculate = calculate;
        calculate = function() {
            originalCalculate();
            generateGachaPool();
        };
    </script>
</body>
</html>
