<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç™„É™„ÉëË®≠Ë®à„Ç∑„Éü„É•„É¨„Éº„Çø„Éº„Ç™„É≥„É©„Ç§„É≥ v2.4</title>
    <style>
        :root {
            /* ÊúÄÊñ∞„ÅÆiOSÈ¢®„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà */
            --sf-blue: #007AFF;
            --sf-indigo: #5856D6;
            --sf-orange: #FF9500;
            --sf-green: #34C759;
            --sf-teal: #5AC8FA;
            --sf-red: #FF3B30;
            --sf-purple: #AF52DE;
            --sf-pink: #FF2D55;
            --sf-yellow: #FFCC00;
            --sf-gray: #8E8E93;
            --sf-gray-2: #AEAEB2;
            --sf-gray-3: #C7C7CC;
            --sf-gray-4: #D1D1D6;
            --sf-gray-5: #E5E5EA;
            --sf-gray-6: #F2F2F7;
            --sf-white: #FFFFFF;
            --sf-black: #000000;

            /* Âº∑Âåñ„Åï„Çå„Åü„Ç∑„É£„Éâ„Ç¶ */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.16);
            --shadow-2xl: 0 24px 64px rgba(0, 0, 0, 0.20);

            /* „Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É†Áî®„Ç∑„É£„Éâ„Ç¶ */
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);

            /* „Çà„ÇäÂ§ß„Åç„Å™border-radius */
            --radius-xs: 8px;
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;

            /* „Çπ„É†„Éº„Ç∫„Å™„Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥ */
            --transition-fast: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* ÂãïÁöÑ„Å™„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ËÉåÊôØ */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(
                135deg,
                #e8eef3 0%,
                #dce4ec 25%,
                #e0e7ed 50%,
                #dde5ee 75%,
                #e5ebf1 100%
            );
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            min-height: 100vh;
            letter-spacing: -0.02em;
            line-height: 1.6;
            color: rgba(0, 0, 0, 0.9);
            position: relative;
            overflow-x: hidden;
        }

        /* „Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É†ËÉåÊôØ„É¨„Ç§„É§„Éº */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(
                circle at 30% 50%,
                rgba(0, 122, 255, 0.03) 0%,
                transparent 50%
            ),
            radial-gradient(
                circle at 70% 80%,
                rgba(100, 126, 234, 0.04) 0%,
                transparent 50%
            );
            animation: float 25s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            33% {
                transform: translate(30px, -50px) rotate(120deg);
            }
            66% {
                transform: translate(-20px, 20px) rotate(240deg);
            }
        }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä - „Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É† */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(80px) saturate(200%);
            -webkit-backdrop-filter: blur(80px) saturate(200%);
            padding: 40px;
            border-radius: var(--radius-2xl);
            box-shadow:
                0 30px 90px rgba(0, 0, 0, 0.1),
                0 12px 40px rgba(0, 0, 0, 0.06),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 2px 8px rgba(255, 255, 255, 0.7) inset;
            border: 0.5px solid rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 1;
            animation: containerFadeIn 0.8s var(--transition-smooth);
        }

        @keyframes containerFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* „Çø„Ç§„Éà„É´ */
        h1 {
            color: rgba(0, 0, 0, 0.9);
            text-align: center;
            margin: 0 0 40px 0;
            font-size: 3em;
            font-weight: 700;
            letter-spacing: -0.03em;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            animation: titleSlideIn 1s var(--transition-smooth);
        }

        @keyframes titleSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* „Éê„Éº„Ç∏„Éß„É≥„Éê„ÉÉ„Ç∏ */
        .version-badge {
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 6px 16px;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 700;
            margin-left: 16px;
            vertical-align: middle;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
        }

        /* „Ç∞„É™„ÉÉ„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà */
        .main-grid {
            display: grid;
            grid-template-columns: 460px 1fr;
            gap: 32px;
            animation: gridFadeIn 1s var(--transition-smooth) 0.2s both;
        }

        @keyframes gridFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* left-panel„ÅÆË°®Á§∫È†Ü„ÇíÂà∂Âæ° */
        .left-panel > .panel:nth-child(1) { order: 1; } /* Âü∫Êú¨Ë®≠ÂÆö */
        .left-panel > .panel:nth-child(2) { order: 4; } /* „Éè„Ç∫„É¨ÁÆ°ÁêÜ ‚Üí 4Áï™ÁõÆ„Å∏ */
        .left-panel > .panel:nth-child(3) { order: 3; } /* ÊôØÂìÅÁÆ°ÁêÜ */
        .left-panel > .panel:nth-child(4) { order: 2; } /* „ÇØ„É©„Ç¶„ÉâË®≠ÂÆö ‚Üí 2Áï™ÁõÆ„Å∏ */
        .left-panel > .panel:nth-child(5) { order: 5; } /* ÈÅéÂéª7Êó•Èñì„ÅÆÈõÜË®à */

        /* „Éë„Éç„É´ - Âº∑Âåñ„Åï„Çå„Åü„Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É† */
        .panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            padding: 28px;
            border-radius: var(--radius-xl);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 16px 50px rgba(0, 0, 0, 0.07),
                0 6px 20px rgba(0, 0, 0, 0.04),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 1px 4px rgba(255, 255, 255, 0.7) inset;
            transition: all 0.4s var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        /* „Éë„Éç„É´„ÅÆ„Éõ„Éê„ÉºÂäπÊûú */
        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                135deg,
                rgba(0, 122, 255, 0.03) 0%,
                transparent 100%
            );
            opacity: 0;
            transition: opacity 0.4s var(--transition-smooth);
            pointer-events: none;
        }

        .panel:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
                        0 0 0 1px rgba(255, 255, 255, 0.7) inset;
            border-color: rgba(255, 255, 255, 0.8);
        }

        .panel:hover::before {
            opacity: 1;
        }

        /* „Éë„Éç„É´„Éò„ÉÉ„ÉÄ„Éº */
        .panel h2 {
            margin: 0 0 24px 0;
            color: rgba(0, 0, 0, 0.9);
            padding-bottom: 16px;
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: -0.02em;
            position: relative;
        }

        .panel h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--sf-blue);
            border-radius: var(--radius-full);
            transition: width 0.3s var(--transition-smooth);
        }

        .panel:hover h2::after {
            width: 120px;
        }

        /* „Éï„Ç©„Éº„É†„Ç∞„É´„Éº„Éó */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
            font-size: 14px;
            letter-spacing: -0.01em;
            transition: color 0.3s var(--transition-smooth);
        }

        .form-group:focus-within label {
            color: var(--sf-blue);
        }

        /* „Ç§„É≥„Éó„ÉÉ„Éà */
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 18px;
            border: 1.5px solid rgba(0, 0, 0, 0.12);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.04),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset;
            transition: all 0.3s var(--transition-smooth);
            color: rgba(0, 0, 0, 0.9);
        }

        .form-group input:hover,
        .form-group select:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.15);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.06),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--sf-blue);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            box-shadow:
                0 0 0 4px rgba(0, 122, 255, 0.12),
                0 4px 16px rgba(0, 0, 0, 0.08),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset;
            transform: translateY(-1px);
        }

        /* „Ç®„É©„ÉºÁä∂ÊÖã */
        .form-group input.error {
            border-color: var(--sf-red);
            background-color: rgba(255, 59, 48, 0.08);
            animation: shakeError 0.4s var(--transition-smooth);
        }

        @keyframes shakeError {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .form-group input.error:focus {
            border-color: var(--sf-red);
            box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.15);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .calculated-value {
            background: rgba(52, 199, 89, 0.1);
            color: var(--sf-green);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-weight: 600;
            text-align: center;
            border: 2px solid rgba(52, 199, 89, 0.3);
        }

        .prize-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .prize-item {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: var(--radius-md);
            padding: 16px;
            position: relative;
            transition: all 0.3s var(--transition-smooth);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .prize-item:hover {
            border-color: var(--sf-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .prize-rank {
            position: absolute;
            top: -8px;
            left: 12px;
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .prize-rank.rank-1 { background: #FFD700; color: var(--sf-black); }
        .prize-rank.rank-2 { background: #C0C0C0; color: var(--sf-black); }
        .prize-rank.rank-3 { background: #CD7F32; color: var(--sf-white); }
        .prize-rank.rank-4 { background: var(--sf-green); }
        .prize-rank.rank-5 { background: var(--sf-blue); }

        .prize-content {
            margin-top: 8px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .prize-name {
            font-weight: 500;
            color: var(--sf-black);
        }

        .prize-value, .prize-count, .prize-purchase {
            font-size: 12px;
            color: var(--sf-gray);
            text-align: center;
        }

        /* „Éú„Çø„É≥ - „Ç∑„É≥„Éó„É´„Å™iOSÈ¢® */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            letter-spacing: -0.01em;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: rgba(0, 122, 255, 0.85);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 6px 20px rgba(0, 122, 255, 0.35),
                0 2px 10px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset,
                0 1px 4px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-primary:hover {
            background: rgba(0, 102, 221, 0.9);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(0, 122, 255, 0.45),
                0 4px 15px rgba(0, 122, 255, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset,
                0 2px 6px rgba(255, 255, 255, 0.7) inset;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
            background: rgba(0, 81, 213, 0.95);
            box-shadow:
                0 3px 12px rgba(0, 122, 255, 0.35),
                0 1px 6px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-danger {
            background: rgba(255, 59, 48, 0.8);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.75);
            box-shadow:
                0 6px 20px rgba(255, 59, 48, 0.35),
                0 2px 10px rgba(255, 59, 48, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset,
                0 1px 4px rgba(255, 255, 255, 0.5) inset;
        }

        .btn-danger:hover {
            background: rgba(230, 52, 42, 0.85);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(255, 59, 48, 0.45),
                0 4px 15px rgba(255, 59, 48, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.5) inset,
                0 2px 6px rgba(255, 255, 255, 0.4) inset;
        }

        .btn-danger:active {
            transform: translateY(0) scale(0.98);
            background: rgba(204, 46, 36, 0.8);
            box-shadow:
                0 3px 12px rgba(255, 59, 48, 0.35),
                0 1px 6px rgba(255, 59, 48, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.3) inset;
        }

        .btn-success {
            background: rgba(52, 199, 89, 0.8);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            width: 100%;
            padding: 16px;
            font-size: 15px;
            margin-top: 16px;
            border: 0.5px solid rgba(255, 255, 255, 0.75);
            box-shadow:
                0 6px 20px rgba(52, 199, 89, 0.35),
                0 2px 10px rgba(52, 199, 89, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset,
                0 1px 4px rgba(255, 255, 255, 0.5) inset;
        }

        .btn-success:hover {
            background: rgba(47, 179, 80, 0.85);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(52, 199, 89, 0.45),
                0 4px 15px rgba(52, 199, 89, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset,
                0 2px 6px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-success:active {
            transform: translateY(0) scale(0.98);
            background: rgba(40, 167, 69, 0.9);
            box-shadow:
                0 3px 12px rgba(52, 199, 89, 0.35),
                0 1px 6px rgba(52, 199, 89, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.5) inset;
        }

        /* btn-accent„Çíbtn-primary„Å®Áµ±‰∏Ä */
        .btn-accent {
            background: rgba(0, 122, 255, 0.85);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 6px 20px rgba(0, 122, 255, 0.35),
                0 2px 10px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset,
                0 1px 4px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-accent:hover {
            background: rgba(0, 102, 221, 0.9);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(0, 122, 255, 0.45),
                0 4px 15px rgba(0, 122, 255, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset,
                0 2px 6px rgba(255, 255, 255, 0.7) inset;
        }

        .btn-accent:active {
            transform: translateY(0) scale(0.98);
            background: rgba(0, 81, 213, 0.95);
            box-shadow:
                0 3px 12px rgba(0, 122, 255, 0.35),
                0 1px 6px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset;
        }
        
        /* „Ç¨„ÉÅ„É£‰ΩìÈ®ì„Çπ„Çø„Ç§„É´ */
        .gacha-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .gacha-btn {
            flex: 1;
            min-width: 120px;
            font-weight: 600;
        }
        .gacha-results {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 0.5px solid rgba(255, 255, 255, 0.85);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 20px;
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.06),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset;
        }
        .gacha-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .gacha-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(52, 199, 89, 0.08);
            border-radius: 8px;
        }
        .gacha-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--sf-green);
        }
        .gacha-stat-label {
            font-size: 0.9em;
            color: var(--sf-gray);
        }
        .gacha-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .gacha-draw-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        .gacha-draw-prize {
            background: var(--sf-green);
            color: white;
        }
        .gacha-draw-loss {
            background: var(--sf-orange);
            color: white;
        }

        .add-prize-form {
            background: rgba(0, 122, 255, 0.03);
            border: 2px dashed rgba(0, 122, 255, 0.3);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 16px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 24px;
        }

        /* ÁµêÊûú„Éë„Éç„É´ */
        .result-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            padding: 28px;
            border-radius: var(--radius-xl);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 16px 50px rgba(0, 0, 0, 0.07),
                0 6px 20px rgba(0, 0, 0, 0.04),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 1px 4px rgba(255, 255, 255, 0.7) inset;
            transition: all 0.4s var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .result-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                135deg,
                rgba(52, 199, 89, 0.03) 0%,
                transparent 100%
            );
            opacity: 0;
            transition: opacity 0.4s var(--transition-smooth);
            pointer-events: none;
        }

        .result-panel:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
                        0 0 0 1px rgba(255, 255, 255, 0.7) inset;
            border-color: rgba(255, 255, 255, 0.8);
        }

        .result-panel:hover::before {
            opacity: 1;
        }

        .result-panel h3 {
            margin: 0 0 20px 0;
            color: rgba(0, 0, 0, 0.9);
            padding-bottom: 16px;
            font-size: 1.4em;
            font-weight: 700;
            letter-spacing: -0.02em;
            position: relative;
        }

        .result-panel h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--sf-blue);
            border-radius: var(--radius-full);
            transition: width 0.3s var(--transition-smooth);
        }

        .result-panel:hover h3::after {
            width: 100px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--sf-gray-5);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: var(--sf-black);
        }

        .result-value {
            color: var(--sf-gray);
            font-weight: 600;
        }

        .highlight {
            background: rgba(255, 149, 0, 0.12);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 149, 0, 0.3);
            color: var(--sf-orange);
            font-weight: 600;
        }

        .loss-panel {
            background: rgba(255, 149, 0, 0.05);
            border: 1px solid rgba(255, 149, 0, 0.15);
        }

        .loss-panel h3::after {
            background: var(--sf-orange);
        }

        .expected-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .ev-item {
            text-align: center;
            padding: 8px;
            background: rgba(52, 199, 89, 0.08);
            border-radius: 8px;
            font-size: 12px;
        }

        .ev-count {
            font-weight: 600;
            color: var(--sf-green);
        }

        .ev-value {
            color: var(--sf-gray);
            font-size: 11px;
        }

        .warning {
            background: rgba(255, 59, 48, 0.1);
            color: var(--sf-red);
            padding: 16px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 59, 48, 0.2);
            margin-top: 24px;
            font-size: 14px;
        }

        /* „Éó„É™„Çª„ÉÉ„Éà„Ç™„É™„Éë„ÅÆ„Çπ„Çø„Ç§„É´ */
        .preset-section label {
            transition: all 0.2s var(--transition-smooth);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
        }

        .preset-section label:hover {
            background: rgba(0, 122, 255, 0.05);
            border-color: rgba(0, 122, 255, 0.2);
        }

        .preset-section input[type="radio"]:checked + span {
            color: var(--sf-blue);
            font-weight: 600;
        }

        .preset-section input[type="radio"]:checked {
            accent-color: var(--sf-blue);
        }

        /* „É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„Çø„Ç§„É´ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s var(--transition-smooth);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            border: 0.5px solid rgba(255, 255, 255, 0.9);
            border-radius: var(--radius-xl);
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 2px 8px rgba(255, 255, 255, 0.6) inset;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s var(--transition-smooth);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--sf-gray-5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 600;
            color: var(--sf-black);
        }

        .modal-close {
            font-size: 32px;
            color: var(--sf-gray);
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s var(--transition);
        }

        .modal-close:hover {
            color: var(--sf-red);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--sf-gray-5);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-footer .btn {
            min-width: 100px;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥ - Âº∑Âåñ */
        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 420px 1fr;
                gap: 28px;
            }
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 400px 1fr;
                gap: 24px;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        @media (max-width: 1024px) {
            body {
                padding: 16px;
            }

            .container {
                padding: 28px;
                border-radius: var(--radius-xl);
            }

            h1 {
                font-size: 2.2em;
                margin-bottom: 32px;
            }

            .main-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 20px;
                border-radius: var(--radius-lg);
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 24px;
            }

            .version-badge {
                display: block;
                margin: 12px auto 0;
                width: fit-content;
            }

            .panel, .result-panel {
                padding: 20px;
                border-radius: var(--radius-lg);
            }

            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 16px;
                border-radius: var(--radius-md);
            }

            h1 {
                font-size: 1.5em;
            }

            .panel, .result-panel {
                padding: 16px;
            }
        }

        /* „Çπ„É†„Éº„Ç∫„Çπ„ÇØ„É≠„Éº„É´ */
        html {
            scroll-behavior: smooth;
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-full);
            transition: background 0.3s var(--transition-smooth);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* „Çª„É¨„ÇØ„Ç∑„Éß„É≥ */
        ::selection {
            background: rgba(0, 122, 255, 0.3);
            color: var(--sf-white);
        }

        /* „Éï„Ç©„Éº„Ç´„ÇπË°®Á§∫„ÅÆÊîπÂñÑ */
        *:focus-visible {
            outline: 2px solid var(--sf-blue);
            outline-offset: 2px;
        }

        /* ========== „Çπ„Ç≥„Ç¢Ë©ï‰æ°„É¢„Éº„ÉÄ„É´ ========== */
        #scoreModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            z-index: 10000;
            animation: fadeIn 0.3s var(--transition-smooth);
            overflow: visible;
        }

        #scoreModal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }

        .score-modal-content {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.85), rgba(248, 249, 250, 0.85));
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            border: 0.5px solid rgba(255, 255, 255, 0.9);
            border-radius: var(--radius-2xl);
            box-shadow:
                0 30px 80px rgba(0, 0, 0, 0.15),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 2px 8px rgba(255, 255, 255, 0.6) inset;
            width: 90%;
            max-width: 600px;
            padding: 60px 48px;
            text-align: center;
            position: relative;
            animation: slideUp 0.4s var(--transition-smooth);
            overflow: visible;
        }

        .score-close {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: all 0.2s var(--transition-smooth);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.03);
        }

        .score-close:hover {
            background: rgba(0, 0, 0, 0.08);
            color: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }

        .score-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 48px;
            color: rgba(0, 0, 0, 0.85);
            letter-spacing: -0.02em;
        }

        /* „Çπ„É≠„ÉÉ„Éà„Ç≥„É≥„ÉÜ„Éä */
        .score-gauge-container {
            position: relative;
            width: 100%;
            margin: 0 auto 48px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* „É©„É≥„ÇØË°®Á§∫ - È´òÁ¥öÊÑü„ÅÆ„ÅÇ„Çã„Çπ„É≠„ÉÉ„Éà */
        .score-rank {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.8), rgba(248, 249, 250, 0.8));
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: 50%;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.08),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 0 60px rgba(0, 0, 0, 0.03);
            border: 3px solid rgba(255, 255, 255, 0.95);
        }

        .score-rank-container {
            font-size: 6em;
            font-weight: 800;
            letter-spacing: -0.03em;
        }

        .score-rank-item {
            display: inline-block;
        }

        /* „Çπ„É©„Ç§„Éâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50px);
            }
        }

        @keyframes confirmPop {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            70% {
                transform: scale(0.95);
            }
            100% {
                transform: scale(1);
            }
        }

        .score-rank-item.slide-in {
            animation: slideIn 0.1s ease-out forwards;
        }

        .score-rank-item.slide-out {
            animation: slideOut 0.1s ease-in forwards;
        }

        .score-rank-item.confirm {
            animation: confirmPop 0.4s ease-out forwards;
        }

        /* „É©„É≥„ÇØÂà•„Ç´„É©„Éº - ËêΩ„Å°ÁùÄ„ÅÑ„ÅüÈÖçËâ≤ */
        .score-rank.rank-S {
            background: linear-gradient(145deg, rgba(255, 223, 0, 0.15), rgba(255, 240, 100, 0.15));
            border-color: rgba(255, 215, 0, 0.4);
        }

        .score-rank.rank-S .score-rank-container {
            color: #D4AF37;
            text-shadow: 0 2px 20px rgba(212, 175, 55, 0.3);
        }

        .score-rank.rank-A {
            background: linear-gradient(145deg, rgba(0, 122, 255, 0.08), rgba(0, 122, 255, 0.12));
            border-color: rgba(0, 122, 255, 0.3);
        }

        .score-rank.rank-A .score-rank-container {
            color: #007AFF;
            text-shadow: 0 2px 20px rgba(0, 122, 255, 0.2);
        }

        .score-rank.rank-B {
            background: linear-gradient(145deg, rgba(52, 199, 89, 0.08), rgba(52, 199, 89, 0.12));
            border-color: rgba(52, 199, 89, 0.3);
        }

        .score-rank.rank-B .score-rank-container {
            color: #34C759;
            text-shadow: 0 2px 20px rgba(52, 199, 89, 0.2);
        }

        .score-rank.rank-C {
            background: linear-gradient(145deg, rgba(255, 149, 0, 0.08), rgba(255, 149, 0, 0.12));
            border-color: rgba(255, 149, 0, 0.3);
        }

        .score-rank.rank-C .score-rank-container {
            color: #FF9500;
            text-shadow: 0 2px 20px rgba(255, 149, 0, 0.2);
        }

        .score-rank.rank-D {
            background: linear-gradient(145deg, rgba(255, 59, 48, 0.08), rgba(255, 59, 48, 0.12));
            border-color: rgba(255, 59, 48, 0.3);
        }

        .score-rank.rank-D .score-rank-container {
            color: #FF3B30;
            text-shadow: 0 2px 20px rgba(255, 59, 48, 0.2);
        }

        .score-rank.rank-E {
            background: linear-gradient(145deg, rgba(142, 142, 147, 0.08), rgba(142, 142, 147, 0.12));
            border-color: rgba(142, 142, 147, 0.3);
        }

        .score-rank.rank-E .score-rank-container {
            color: #8E8E93;
            text-shadow: 0 2px 20px rgba(142, 142, 147, 0.2);
        }

        /* „Çπ„Ç≥„Ç¢Ë©≥Á¥∞ - È´òÁ¥öÊÑü„ÅÆ„ÅÇ„Çã„Éá„Ç∂„Ç§„É≥ */
        .score-details {
            margin-top: 40px;
            text-align: left;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.75), rgba(248, 249, 250, 0.75));
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            padding: 28px;
            border-radius: var(--radius-lg);
            font-size: 14px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        }

        .score-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        }

        .score-detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .score-detail-label {
            color: rgba(0, 0, 0, 0.6);
            font-weight: 500;
            font-size: 14px;
            letter-spacing: -0.01em;
        }

        .score-detail-value {
            color: rgba(0, 0, 0, 0.9);
            font-weight: 700;
            font-size: 15px;
            letter-spacing: -0.01em;
        }

        /* „ÇØ„É©„ÉÉ„Ç´„Éº„Ç®„Éï„Çß„ÇØ„Éà */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFD700;
            border-radius: 50%;
            z-index: 1000;
            pointer-events: none;
        }

        /* Ëá™ÁÑ∂„Å™Êï£„Çâ„Å∞„Çä„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes confettiBurst {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(0.1);
                opacity: 0;
            }
        }

        .confetti {
            animation: confettiBurst var(--duration) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>„Ç™„É™„ÉëË®≠Ë®à„Ç∑„Éü„É•„É¨„Éº„Çø„Éº„Ç™„É≥„É©„Ç§„É≥ <span class="version-badge">v2.4</span></h1>
        
        <div class="main-grid">
            <div class="left-panel" style="display: grid; gap: 24px;">
                <!-- Âü∫Êú¨Ë®≠ÂÆö -->
                <div class="panel">
                    <h2>Âü∫Êú¨Ë®≠ÂÆö</h2>
                    <div class="form-group">
                        <label>„Éë„ÉÉ„ÇØÂçò‰æ° (ÂÜÜ)</label>
                        <input type="number" id="packPrice" value="40000">
                    </div>
                    <div class="form-group">
                        <label>Á∑èÂè£Êï∞</label>
                        <input type="number" id="totalPacks" value="100">
                    </div>
                    <div class="form-group">
                        <label>ÂÖ¨ÈñãÊó•</label>
                        <input type="date" id="releaseDate" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label>„Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§</label>
                        <div class="calculated-value" id="totalValue">¬•0</div>
                    </div>

                    <!-- „Éó„É™„Çª„ÉÉ„ÉàË®≠ÂÆö -->
                    <div class="preset-section" style="margin-top: 20px; padding: 16px; background: rgba(0, 122, 255, 0.05); border: 1px solid var(--sf-blue); border-radius: var(--border-radius-small);">
                        <label style="display: block; font-weight: 600; color: var(--sf-black); margin-bottom: 12px; font-size: 14px;">
                            ‚ö° „Éó„É™„Çª„ÉÉ„Éà„Ç™„É™„Éë
                        </label>
                        <div id="presetList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                            <!-- „Éó„É™„Çª„ÉÉ„Éà‰∏ÄË¶ß„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
                        </div>
                        <button class="btn btn-success" onclick="openAddPresetModal()" style="width: 100%; font-size: 12px; padding: 8px; margin-bottom: 8px;">
                            ‚ûï Êñ∞Ë¶è„Éó„É™„Çª„ÉÉ„ÉàËøΩÂä†
                        </button>
                        <button class="btn btn-primary" onclick="applyPreset()" style="width: 100%; font-size: 13px; padding: 10px;">
                            ‚ö° „Éó„É™„Çª„ÉÉ„Éà„Åã„ÇâË®àÁÆó
                        </button>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <button class="btn btn-success" onclick="calculate()" style="flex: 1; font-size: 16px; padding: 14px;">
                            üßÆ Ë®àÁÆó„Åô„Çã
                        </button>
                        <button class="btn btn-primary" onclick="showScoreEvaluation()" style="flex: 1; font-size: 16px; padding: 14px;">
                            ‚≠ê „Çπ„Ç≥„Ç¢Ë©ï‰æ°
                        </button>
                    </div>
                </div>

                <!-- „Éè„Ç∫„É¨ÁÆ°ÁêÜ -->
                <div class="panel">
                    <h2>„Éè„Ç∫„É¨ÁÆ°ÁêÜ</h2>
                    <p style="color: var(--sf-gray); font-size: 13px; margin-bottom: 16px;">
                        „Éè„Ç∫„É¨„ÇíÊâãÂãï„ÅßË®≠ÂÆö„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅÊúÄ‰Ωé‰øùË®º‰æ°ÂÄ§„ÅßËá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åô
                    </p>
                    <div class="form-group">
                        <label>Ëá™ÂãïË®àÁÆóÁî®ÔºöÊúÄ‰Ωé‰øùË®º‰æ°ÂÄ§ (ÂÜÜ)</label>
                        <input type="number" id="minGuaranteeValue" value="1" min="1" step="1">
                    </div>

                    <div class="prize-list" id="lossList" style="margin-top: 16px;">
                        <!-- „Éè„Ç∫„É¨„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>

                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>„Éè„Ç∫„É¨Âêç</label>
                            <input type="text" id="lossName" placeholder="‰æã: „Éè„Ç∫„É¨A">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‰æ°ÂÄ§ (ÂÜÜ)</label>
                                <input type="number" id="lossValue" placeholder="100" min="1">
                            </div>
                            <div class="form-group">
                                <label>ÊûöÊï∞</label>
                                <input type="number" id="lossCount" min="1" value="1">
                            </div>
                        </div>
                        <button class="btn btn-success" id="addLossBtn" onclick="addLoss()">„Éè„Ç∫„É¨„ÇíËøΩÂä†</button>
                        <button class="btn btn-success" id="updateLossBtn" onclick="updateLoss()" style="display: none;">„Éè„Ç∫„É¨„ÇíÊõ¥Êñ∞</button>
                        <button class="btn btn-danger" id="cancelEditLossBtn" onclick="cancelEditLoss()" style="display: none; margin-top: 8px;">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </div>

                <!-- ÊôØÂìÅÁÆ°ÁêÜ -->
                <div class="panel">
                    <h2>ÊôØÂìÅÁÆ°ÁêÜ</h2>
                    <div class="prize-list" id="prizeList">
                        <!-- ÊôØÂìÅ„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>
                    
                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>ÊôØÂìÅÂêç</label>
                            <input type="text" id="prizeName" placeholder="‰æã: „É¨„Ç¢„Ç´„Éº„Éâ">
                        </div>
                        <div class="form-group">
                            <label>Á≠âÁ¥ö</label>
                            <select id="prizeRank" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                                <option value="1">1Á≠â</option>
                                <option value="2">2Á≠â</option>
                                <option value="3">3Á≠â</option>
                                <option value="4">4Á≠â</option>
                                <option value="5">5Á≠â</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‰ªïÂÖ•„Çå‰æ°Ê†º</label>
                                <input type="text" id="prizePurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this)">
                            </div>
                            <div class="form-group">
                                <label>„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§</label>
                                <input type="text" id="prizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Âú®Â∫´Êï∞</label>
                            <input type="number" id="prizeCount" min="1" value="1">
                        </div>
                        <button class="btn btn-success" id="addPrizeBtn" onclick="addPrize()">ÊôØÂìÅ„ÇíËøΩÂä†</button>
                        <button class="btn btn-success" id="updatePrizeBtn" onclick="updatePrize()" style="display: none;">ÊôØÂìÅ„ÇíÊõ¥Êñ∞</button>
                        <button class="btn btn-danger" id="cancelEditBtn" onclick="cancelEdit()" style="display: none; margin-top: 8px;">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </div>

                <!-- „ÇØ„É©„Ç¶„ÉâË®≠ÂÆöÁÆ°ÁêÜ -->
                <div class="panel" style="background: rgba(0, 122, 255, 0.05); border-color: var(--sf-blue);">
                    <h2 style="border-bottom-color: var(--sf-blue);">‚òÅÔ∏è „ÇØ„É©„Ç¶„ÉâË®≠ÂÆöÂÖ±Êúâ</h2>

                    <!-- ‰øùÂ≠ò„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <div class="form-group">
                        <label>Ë®≠ÂÆöÂêç</label>
                        <input type="text" id="cloudConfigName" placeholder="Ë®≠ÂÆöÂêç„ÇíÂÖ•ÂäõÔºà‰æã: „Éù„Ç±„É¢„É≥„Ç™„É™„ÉëAÊ°àÔºâ">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="saveToCloudWithName()" style="font-size: 12px;">
                            üíæ Êñ∞Ë¶è‰øùÂ≠ò
                        </button>
                        <button class="btn btn-accent" onclick="updateCloudConfig()" style="font-size: 12px;" id="updateCloudBtn" disabled>
                            üîÑ ‰∏äÊõ∏„ÅçÊõ¥Êñ∞
                        </button>
                    </div>

                    <!-- Ë™≠„ÅøËæº„Åø„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <div class="form-group">
                        <label>„ÇØ„É©„Ç¶„ÉâË®≠ÂÆö‰∏ÄË¶ß</label>
                        <select id="cloudConfigList" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                            <option value="">Ë®≠ÂÆö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-success" onclick="loadSelectedCloudConfig()" style="font-size: 12px;">
                            üìÇ Ë™≠„ÅøËæº„Åø
                        </button>
                        <button class="btn btn-danger" onclick="deleteSelectedCloudConfig()" style="font-size: 12px;">
                            üóëÔ∏è ÂâäÈô§
                        </button>
                    </div>

                    <button class="btn btn-primary" onclick="refreshCloudConfigList()" style="width: 100%; font-size: 12px;">
                        üîÑ ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                    </button>

                    <!-- ÂÖ±Êúâ„É™„É≥„ÇØÁîüÊàê„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--sf-gray-5);">
                        <label style="display: block; font-weight: 500; color: var(--sf-black); margin-bottom: 8px; font-size: 14px;">
                            üîó „É™„É≥„ÇØÂÖ±Êúâ
                        </label>
                        <button class="btn btn-accent" onclick="generateShareLink()" style="width: 100%; font-size: 12px;" id="shareBtn" disabled>
                            üìã ÂÖ±Êúâ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº
                        </button>
                        <div id="shareStatus" style="margin-top: 8px; font-size: 11px; color: var(--sf-gray); text-align: center;"></div>
                    </div>

                    <div id="cloudStatus" style="margin-top: 12px; font-size: 12px; color: var(--sf-gray);"></div>
                </div>

                <!-- ÈÅéÂéª7Êó•Èñì„ÅÆÈõÜË®à -->
                <div class="panel" style="background: rgba(175, 82, 222, 0.05); border-color: var(--sf-purple);">
                    <h2 style="border-bottom-color: var(--sf-purple);">üìä ÈÅéÂéª7Êó•Èñì„ÅÆÈõÜË®à</h2>

                    <button class="btn btn-primary" onclick="refreshWeeklyStats()" style="width: 100%; margin-bottom: 16px;">
                        üîÑ ÈõÜË®à„ÇíÊõ¥Êñ∞
                    </button>

                    <div id="weeklyStatsContainer" style="font-size: 13px;">
                        <p style="color: var(--sf-gray); text-align: center;">„ÄåÈõÜË®à„ÇíÊõ¥Êñ∞„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                </div>
            </div>

            <div class="results-grid">
                <!-- „Çµ„Éû„É™„Éº -->
                <div class="result-panel">
                    <h3>„Çµ„Éû„É™„Éº</h3>
                    <div class="result-row">
                        <span class="result-label">Á∑èÈÇÑÂÖÉÁéá</span>
                        <span class="result-value" id="summaryTotalReturn">98.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ÂÆüË≥™ÈÇÑÂÖÉÁéáÔºàÂ£≤‰∏äÂéü‰æ°ÁéáÔºâ</span>
                        <span class="result-value highlight" id="summaryRealReturn">0.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Á∑èÂΩìÈÅ∏ËÄÖÊï∞</span>
                        <span class="result-value" id="summaryWinnerCount">0‰∫∫</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Á∑è‰ªïÂÖ•„ÇåÈ°ç</span>
                        <span class="result-value" id="summaryTotalPurchase">¬•0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ÂΩì„Åü„ÇäÊôØÂìÅÈÇÑÂÖÉÁ∑èÈ°ç</span>
                        <span class="result-value" id="summaryPrizeTotalReward">¬•0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">„Éè„Ç∫„É¨ÈÇÑÂÖÉÁ∑èÈ°ç</span>
                        <span class="result-value" id="summaryLossTotalReward">¬•0</span>
                    </div>
                </div>

                <!-- ÊôØÂìÅË©≥Á¥∞ -->
                <div class="result-panel">
                    <h3>ÊôØÂìÅË©≥Á¥∞</h3>
                    <div id="prizeDetails">
                        <p style="color: var(--sf-gray); text-align: center;">ÊôØÂìÅ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                </div>

                <!-- „Éè„Ç∫„É¨Ë©≥Á¥∞ + ÂàÜÂ∏É -->
                <div class="result-panel loss-panel">
                    <h3>„Éè„Ç∫„É¨Ë©≥Á¥∞ÔºàËá™ÂãïË®àÁÆóÔºâ</h3>
                    <div id="lossDetailsContainer">
                        <!-- „Éè„Ç∫„É¨Ë©≥Á¥∞„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>
                    <div class="result-row">
                        <span class="result-label">„Éè„Ç∫„É¨Á∑èÊûöÊï∞</span>
                        <span class="result-value" id="totalLossCount">0Êûö</span>
                    </div>

                    <!-- „Éè„Ç∫„É¨ÂΩìÈÅ∏ËÄÖÂàÜÂ∏É -->
                    <div style="margin-top: 24px; padding-top: 24px; border-top: 1.5px solid rgba(255, 255, 255, 0.4);">
                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--sf-black);">„Éè„Ç∫„É¨ÂΩìÈÅ∏ËÄÖÂàÜÂ∏É</h4>
                        <div class="chart-container">
                            <canvas id="lossDistributionChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>




                <!-- „Ç¨„ÉÅ„É£‰ΩìÈ®ì -->
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <h3>üéÆ „Ç¨„ÉÅ„É£‰ΩìÈ®ì</h3>
                    <p style="color: var(--sf-gray); font-size: 14px; margin-bottom: 20px;">
                        ÂÆüÈöõ„Å´„Ç™„É™„Éë„ÇíÂºï„ÅÑ„Å¶„ÄÅË®≠Ë®à„Åó„Åü„Ç¨„ÉÅ„É£„ÅÆ‰ΩìÈ®ì„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô
                    </p>
                    
                    <!-- „Ç¨„ÉÅ„É£„Éú„Çø„É≥ -->
                    <div class="gacha-controls">
                        <button class="btn btn-primary gacha-btn" onclick="drawGacha(1)">
                            üé≤ 1ÂõûÂºï„Åè
                        </button>
                        <button class="btn btn-secondary gacha-btn" onclick="drawGacha(10)">
                            üé≤ 10ÂõûÂºï„Åè
                        </button>
                        <button class="btn btn-accent gacha-btn" onclick="drawGacha(100)">
                            üé≤ 100ÂõûÂºï„Åè
                        </button>
                        <button class="btn btn-danger gacha-btn" onclick="resetGacha()" id="resetGachaBtn" style="display: none;">
                            üîÑ „É™„Çª„ÉÉ„Éà
                        </button>
                    </div>
                    
                    <!-- „Ç¨„ÉÅ„É£ÁµêÊûú -->
                    <div id="gachaResults" class="gacha-results" style="display: none;">
                        <h4>„Ç¨„ÉÅ„É£ÁµêÊûú</h4>
                        <div id="gachaStats" class="gacha-stats"></div>
                        <div id="gachaHistory" class="gacha-history"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="warnings"></div>
    </div>

    <!-- „Éó„É™„Çª„ÉÉ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="presetModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">„Éó„É™„Çª„ÉÉ„Éà„ÇíÁ∑®ÈõÜ</h2>
                <span class="modal-close" onclick="closePresetModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>„Éó„É™„Çª„ÉÉ„ÉàÂêç</label>
                    <input type="text" id="modalPresetName" placeholder="‰æã: „Ç´„Çπ„Çø„É†500">
                </div>
                <div class="form-group">
                    <label>ÂÄçÁéáÔºà‰ΩïÂàÜ„ÅÆ1„ÅßÂΩì„Åü„Çã„ÅãÔºâ</label>
                    <input type="number" id="modalMultiplier" placeholder="‰æã: 500" min="1">
                </div>
                <div class="form-group">
                    <label>„Éë„ÉÉ„ÇØÂçò‰æ°Ôºà„Éá„Éï„Ç©„É´„ÉàÂÄ§Ôºâ</label>
                    <input type="number" id="modalPackPrice" placeholder="‰æã: 10" min="1">
                </div>
                <div class="form-group">
                    <label>„Éè„Ç∫„É¨‰æ°ÂÄ§Ôºà„Éá„Éï„Ç©„É´„ÉàÂÄ§Ôºâ</label>
                    <input type="number" id="modalMinGuarantee" placeholder="‰æã: 1" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="savePreset()">‰øùÂ≠ò</button>
                <button class="btn btn-danger" onclick="closePresetModal()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let prizes = [];
        let losses = []; // „Éè„Ç∫„É¨„É™„Çπ„Éà
        let editingPrizeId = null; // Á∑®ÈõÜ‰∏≠„ÅÆÊôØÂìÅID
        let editingLossId = null; // Á∑®ÈõÜ‰∏≠„ÅÆ„Éè„Ç∫„É¨ID

        // „Éó„É™„Çª„ÉÉ„ÉàÁÆ°ÁêÜ
        let presets = [];
        let editingPresetId = null; // Á∑®ÈõÜ‰∏≠„ÅÆ„Éó„É™„Çª„ÉÉ„ÉàID

        // ÂàùÊúü„Éó„É™„Çª„ÉÉ„ÉàÔºàÂàùÂõû„ÅÆ„Åø‰ΩøÁî®Ôºâ
        const INITIAL_PRESETS = [
            {
                id: 'preset_319',
                name: '319',
                multiplier: 319,
                packPrice: 13,
                minGuaranteeValue: 1
            },
            {
                id: 'preset_198',
                name: '198',
                multiplier: 198,
                packPrice: 39,
                minGuaranteeValue: 1
            },
            {
                id: 'preset_nibuchi',
                name: '„Éã„Éñ„Ç§„ÉÅ',
                multiplier: 2,
                packPrice: 350,
                minGuaranteeValue: 1
            }
        ];

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆ„Ç≠„Éº
        const STORAGE_KEY = 'oripa_simulator_v2';
        const PRESETS_STORAGE_KEY = 'oripa_presets_v1';

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadPresetsFromStorage(); // „Éó„É™„Çª„ÉÉ„Éà„ÇíË™≠„ÅøËæº„Åø
            attachEventListeners();
            updateTotalValue();
        });

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function attachEventListeners() {
            // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞„ÅÆ„Åø
            document.getElementById('packPrice').addEventListener('input', updateTotalValue);
            document.getElementById('totalPacks').addEventListener('input', updateTotalValue);
            // ‰ªñ„ÅÆÈ†ÖÁõÆ„ÅØÊâãÂãïË®àÁÆó„Å´Â§âÊõ¥
        }

        // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§„ÅÆÊõ¥Êñ∞Ôºà„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ„Å™„ÅóÔºâ
        function updateTotalValue() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalValue = packPrice * totalPacks;
            document.getElementById('totalValue').textContent = `¬•${totalValue.toLocaleString()}`;

            // „Ç®„É©„ÉºÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÂÖ•Âäõ‰∏≠„ÅØ„Ç®„É©„ÉºË°®Á§∫„Åó„Å™„ÅÑÔºâ
            document.getElementById('packPrice').classList.remove('error');
            document.getElementById('totalPacks').classList.remove('error');
        }

        // „Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatPrizeValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // Êï∞Â≠ó‰ª•Â§ñ„ÇíÈô§Âéª
            if (value) {
                value = parseInt(value).toLocaleString(); // „Ç´„É≥„ÉûÂå∫Âàá„Çä„Å´Â§âÊèõ
            }
            input.value = value;
        }

        // Âü∫Êú¨Ë®≠ÂÆöÂÄ§„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatBasicValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // Êï∞Â≠ó‰ª•Â§ñ„ÇíÈô§Âéª
            if (value) {
                value = parseInt(value).toLocaleString(); // „Ç´„É≥„ÉûÂå∫Âàá„Çä„Å´Â§âÊèõ
            }
            input.value = value;
            // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§„ÅÆ„ÅøÊõ¥Êñ∞
            setTimeout(updateTotalValue, 100);
        }

        // „Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅÆÊï∞Â≠ó„ÇíÊï∞ÂÄ§„Å´Â§âÊèõ
        function parseFormattedNumber(value) {
            return parseFloat(value.replace(/,/g, '')) || 0;
        }

        // ÊôØÂìÅËøΩÂä†
        function addPrize() {
            // Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„ÅØËøΩÂä†„Åó„Å™„ÅÑ
            if (editingPrizeId) {
                alert('Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„Åß„Åô„ÄÇÂÖà„Å´„Äå„Ç≠„É£„É≥„Çª„É´„Äç„Åæ„Åü„ÅØ„ÄåÊôØÂìÅ„ÇíÊõ¥Êñ∞„Äç„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const purchasePrice = parseFormattedNumber(document.getElementById('prizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || purchasePrice <= 0 || value <= 0 || count <= 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const prize = {
                id: Date.now(),
                name: name,
                rank: rank,
                purchasePrice: purchasePrice,
                value: value,
                count: count
            };

            prizes.push(prize);

            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('prizeName').value = '';
            document.getElementById('prizePurchasePrice').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';

            updatePrizeList();
            saveData();
        }

        // ÊôØÂìÅÂâäÈô§
        function removePrize(id) {
            prizes = prizes.filter(p => p.id !== id);
            updatePrizeList();
            saveData();
        }

        // ÊôØÂìÅÁ∑®ÈõÜ
        function editPrize(id) {
            const prize = prizes.find(p => p.id === id);
            if (!prize) return;

            // „Éï„Ç©„Éº„É†„Å´ÂÄ§„ÇíË®≠ÂÆö
            document.getElementById('prizeName').value = prize.name;
            document.getElementById('prizeRank').value = prize.rank;
            document.getElementById('prizePurchasePrice').value = prize.purchasePrice.toLocaleString();
            document.getElementById('prizeValue').value = prize.value.toLocaleString();
            document.getElementById('prizeCount').value = prize.count;

            // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíÊúâÂäπÂåñ
            editingPrizeId = id;

            // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
            document.getElementById('addPrizeBtn').style.display = 'none';
            document.getElementById('updatePrizeBtn').style.display = 'inline-block';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // „Éï„Ç©„Éº„É†„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
            document.getElementById('prizeName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ÊôØÂìÅÊõ¥Êñ∞
        function updatePrize() {
            if (!editingPrizeId) return;

            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const purchasePrice = parseFormattedNumber(document.getElementById('prizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || purchasePrice <= 0 || value <= 0 || count <= 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÊôØÂìÅ„ÇíÊõ¥Êñ∞
            const prizeIndex = prizes.findIndex(p => p.id === editingPrizeId);
            if (prizeIndex !== -1) {
                prizes[prizeIndex] = {
                    id: editingPrizeId,
                    name: name,
                    rank: rank,
                    purchasePrice: purchasePrice,
                    value: value,
                    count: count
                };
            }

            // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíËß£Èô§
            cancelEdit();

            updatePrizeList();
            saveData();
        }

        // Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´
        function cancelEdit() {
            editingPrizeId = null;

            // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('prizeName').value = '';
            document.getElementById('prizePurchasePrice').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';

            // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂÖÉ„Å´Êàª„Åô
            document.getElementById('addPrizeBtn').style.display = 'inline-block';
            document.getElementById('updatePrizeBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // ÊôØÂìÅ„É™„Çπ„ÉàÊõ¥Êñ∞
        function updatePrizeList() {
            const container = document.getElementById('prizeList');

            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">ÊôØÂìÅ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                return;
            }

            // Á≠âÁ¥öÈ†Ü„Å´„ÇΩ„Éº„Éà
            prizes.sort((a, b) => a.rank - b.rank);

            container.innerHTML = prizes.map(prize => `
                <div class="prize-item">
                    <div class="prize-rank rank-${prize.rank}">${prize.rank}Á≠â</div>
                    <div class="prize-content">
                        <div class="prize-name">${prize.name}</div>
                        <div class="prize-purchase">‰ªïÂÖ•¬•${prize.purchasePrice.toLocaleString()}</div>
                        <div class="prize-value">ÈÇÑÂÖÉ¬•${prize.value.toLocaleString()}</div>
                        <div class="prize-count">${prize.count}Êûö</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="editPrize(${prize.id})">Á∑®ÈõÜ</button>
                            <button class="btn btn-danger" onclick="removePrize(${prize.id})">ÂâäÈô§</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ========== ÁüõÁõæ„Ç®„É©„ÉºË°®Á§∫Èñ¢Êï∞ ==========

        function showConflictError(errorData) {
            let message = '';
            let suggestions = '';

            if (errorData.type === 'count_overflow') {
                message = `‚ö†Ô∏è ÊûöÊï∞„ÅåÂêà„ÅÑ„Åæ„Åõ„Çì\n\n` +
                    `ÊôØÂìÅÊûöÊï∞Ôºö${errorData.prizesTotalCount}Êûö\n` +
                    `„Éè„Ç∫„É¨ÊûöÊï∞Ôºö${errorData.manualLossTotalCount}Êûö\n` +
                    `ÂêàË®àÔºö${errorData.prizesTotalCount + errorData.manualLossTotalCount}Êûö\n\n` +
                    `Á∑èÂè£Êï∞Ôºö${errorData.totalPacks}Âè£\n` +
                    `Ë∂ÖÈÅéÊûöÊï∞Ôºö${errorData.excess}Êûö\n\n`;

                suggestions = `üìã ‰ª£ÊõøÊ°àÔºö\n\n` +
                    `1Ô∏è‚É£ Á∑èÂè£Êï∞„Çí${errorData.prizesTotalCount + errorData.manualLossTotalCount}Âè£„Å´Â¢ó„ÇÑ„Åô\n\n` +
                    `2Ô∏è‚É£ „Éè„Ç∫„É¨ÊûöÊï∞„Çí${errorData.excess}ÊûöÊ∏õ„Çâ„Åô\n\n` +
                    `3Ô∏è‚É£ ÊôØÂìÅÊûöÊï∞„Çí${errorData.excess}ÊûöÊ∏õ„Çâ„Åô`;

            } else if (errorData.type === 'count_shortage') {
                message = `‚ö†Ô∏è ÊûöÊï∞„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô\n\n` +
                    `ÊôØÂìÅÊûöÊï∞Ôºö${errorData.prizesTotalCount}Êûö\n` +
                    `„Éè„Ç∫„É¨ÊûöÊï∞Ôºö${errorData.manualLossTotalCount}Êûö\n` +
                    `ÂêàË®àÔºö${errorData.prizesTotalCount + errorData.manualLossTotalCount}Êûö\n\n` +
                    `Á∑èÂè£Êï∞Ôºö${errorData.totalPacks}Âè£\n` +
                    `‰∏çË∂≥ÊûöÊï∞Ôºö${errorData.shortage}Êûö\n\n`;

                suggestions = `üìã ‰ª£ÊõøÊ°àÔºö\n\n` +
                    `1Ô∏è‚É£ Á∑èÂè£Êï∞„Çí${errorData.prizesTotalCount + errorData.manualLossTotalCount}Âè£„Å´Ê∏õ„Çâ„Åô\n\n` +
                    `2Ô∏è‚É£ „Éè„Ç∫„É¨ÊûöÊï∞„Çí${errorData.shortage}ÊûöÂ¢ó„ÇÑ„Åô\n\n` +
                    `3Ô∏è‚É£ ÊôØÂìÅÊûöÊï∞„Çí${errorData.shortage}ÊûöÂ¢ó„ÇÑ„Åô\n\n` +
                    `4Ô∏è‚É£ „Éè„Ç∫„É¨„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Å¶Ëá™ÂãïË®àÁÆó„Å´Âàá„ÇäÊõø„Åà„Çã`;
            }

            alert(message + suggestions);
        }

        // ========== „Éè„Ç∫„É¨ÁÆ°ÁêÜÈñ¢Êï∞ ==========

        // „Éè„Ç∫„É¨ËøΩÂä†
        function addLoss() {
            if (editingLossId) {
                alert('Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„Åß„Åô„ÄÇÂÖà„Å´„Äå„Ç≠„É£„É≥„Çª„É´„Äç„Åæ„Åü„ÅØ„Äå„Éè„Ç∫„É¨„ÇíÊõ¥Êñ∞„Äç„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const name = document.getElementById('lossName').value.trim();
            const value = parseInt(document.getElementById('lossValue').value) || 0;
            const count = parseInt(document.getElementById('lossCount').value) || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const loss = {
                id: Date.now(),
                name: name,
                value: value,
                count: count
            };

            losses.push(loss);

            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('lossName').value = '';
            document.getElementById('lossValue').value = '';
            document.getElementById('lossCount').value = '1';

            updateLossList();
            saveData();
        }

        // „Éè„Ç∫„É¨ÂâäÈô§
        function removeLoss(id) {
            losses = losses.filter(l => l.id !== id);
            updateLossList();
            saveData();
        }

        // „Éè„Ç∫„É¨Á∑®ÈõÜ
        function editLoss(id) {
            const loss = losses.find(l => l.id === id);
            if (!loss) return;

            document.getElementById('lossName').value = loss.name;
            document.getElementById('lossValue').value = loss.value;
            document.getElementById('lossCount').value = loss.count;

            editingLossId = id;

            document.getElementById('addLossBtn').style.display = 'none';
            document.getElementById('updateLossBtn').style.display = 'inline-block';
            document.getElementById('cancelEditLossBtn').style.display = 'inline-block';

            document.getElementById('lossName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // „Éè„Ç∫„É¨Êõ¥Êñ∞
        function updateLoss() {
            if (!editingLossId) return;

            const name = document.getElementById('lossName').value.trim();
            const value = parseInt(document.getElementById('lossValue').value) || 0;
            const count = parseInt(document.getElementById('lossCount').value) || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const lossIndex = losses.findIndex(l => l.id === editingLossId);
            if (lossIndex !== -1) {
                losses[lossIndex] = {
                    id: editingLossId,
                    name: name,
                    value: value,
                    count: count
                };
            }

            cancelEditLoss();
            updateLossList();
            saveData();
        }

        // „Éè„Ç∫„É¨Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´
        function cancelEditLoss() {
            editingLossId = null;

            document.getElementById('lossName').value = '';
            document.getElementById('lossValue').value = '';
            document.getElementById('lossCount').value = '1';

            document.getElementById('addLossBtn').style.display = 'inline-block';
            document.getElementById('updateLossBtn').style.display = 'none';
            document.getElementById('cancelEditLossBtn').style.display = 'none';
        }

        // ========== „Éó„É™„Çª„ÉÉ„ÉàÁÆ°ÁêÜÊ©üËÉΩ ==========

        // „Éó„É™„Çª„ÉÉ„Éà‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
        function updatePresetList() {
            const container = document.getElementById('presetList');

            if (presets.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 12px 0; font-size: 13px;">„Éó„É™„Çª„ÉÉ„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                return;
            }

            container.innerHTML = presets.map(preset => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 8px; border: 1px solid var(--sf-gray-4);">
                    <label style="flex: 1; cursor: pointer; margin: 0; display: flex; align-items: center;">
                        <input type="radio" name="preset" value="${preset.id}" style="margin-right: 8px;">
                        <span style="font-size: 13px; font-weight: 500;">${preset.name}</span>
                        <span style="font-size: 11px; color: var(--sf-gray); margin-left: 8px;">(${preset.multiplier}ÂàÜ„ÅÆ1)</span>
                    </label>
                    <button class="btn btn-primary" onclick="openEditPresetModal('${preset.id}')" style="font-size: 11px; padding: 4px 8px;">Á∑®ÈõÜ</button>
                    <button class="btn btn-danger" onclick="deletePreset('${preset.id}')" style="font-size: 11px; padding: 4px 8px;">ÂâäÈô§</button>
                </div>
            `).join('');
        }

        // „Éó„É™„Çª„ÉÉ„ÉàËøΩÂä†„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openAddPresetModal() {
            editingPresetId = null;
            document.getElementById('modalTitle').textContent = 'Êñ∞Ë¶è„Éó„É™„Çª„ÉÉ„ÉàËøΩÂä†';
            document.getElementById('modalPresetName').value = '';
            document.getElementById('modalMultiplier').value = '';
            document.getElementById('modalPackPrice').value = '';
            document.getElementById('modalMinGuarantee').value = '1';
            document.getElementById('presetModal').style.display = 'flex';
        }

        // „Éó„É™„Çª„ÉÉ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openEditPresetModal(presetId) {
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;

            editingPresetId = presetId;
            document.getElementById('modalTitle').textContent = '„Éó„É™„Çª„ÉÉ„Éà„ÇíÁ∑®ÈõÜ';
            document.getElementById('modalPresetName').value = preset.name;
            document.getElementById('modalMultiplier').value = preset.multiplier;
            document.getElementById('modalPackPrice').value = preset.packPrice;
            document.getElementById('modalMinGuarantee').value = preset.minGuaranteeValue;
            document.getElementById('presetModal').style.display = 'flex';
        }

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closePresetModal() {
            document.getElementById('presetModal').style.display = 'none';
            editingPresetId = null;
        }

        // „Éó„É™„Çª„ÉÉ„Éà„Çí‰øùÂ≠ò
        function savePreset() {
            const name = document.getElementById('modalPresetName').value.trim();
            const multiplier = parseInt(document.getElementById('modalMultiplier').value) || 0;
            const packPrice = parseInt(document.getElementById('modalPackPrice').value) || 0;
            const minGuaranteeValue = parseInt(document.getElementById('modalMinGuarantee').value) || 1;

            if (!name || multiplier <= 0 || packPrice <= 0 || minGuaranteeValue <= 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (editingPresetId) {
                // Á∑®ÈõÜ„É¢„Éº„Éâ
                const presetIndex = presets.findIndex(p => p.id === editingPresetId);
                if (presetIndex !== -1) {
                    presets[presetIndex] = {
                        id: editingPresetId,
                        name: name,
                        multiplier: multiplier,
                        packPrice: packPrice,
                        minGuaranteeValue: minGuaranteeValue
                    };
                }
            } else {
                // Êñ∞Ë¶èËøΩÂä†„É¢„Éº„Éâ
                const newPreset = {
                    id: 'preset_' + Date.now(),
                    name: name,
                    multiplier: multiplier,
                    packPrice: packPrice,
                    minGuaranteeValue: minGuaranteeValue
                };
                presets.push(newPreset);
            }

            savePresetsToStorage();
            savePresetsToFirebase();
            updatePresetList();
            closePresetModal();
        }

        // „Éó„É™„Çª„ÉÉ„Éà„ÇíÂâäÈô§
        function deletePreset(presetId) {
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;

            if (!confirm(`„Éó„É™„Çª„ÉÉ„Éà„Äå${preset.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                return;
            }

            presets = presets.filter(p => p.id !== presetId);
            savePresetsToStorage();
            savePresetsToFirebase();
            updatePresetList();
        }

        // „Éó„É™„Çª„ÉÉ„Éà„ÇíLocalStorage„Å´‰øùÂ≠ò
        function savePresetsToStorage() {
            try {
                localStorage.setItem(PRESETS_STORAGE_KEY, JSON.stringify(presets));
            } catch (e) {
                console.error('„Éó„É™„Çª„ÉÉ„Éà„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        // „Éó„É™„Çª„ÉÉ„Éà„ÇíLocalStorage„Åã„ÇâË™≠„ÅøËæº„Åø
        function loadPresetsFromStorage() {
            try {
                const savedPresets = localStorage.getItem(PRESETS_STORAGE_KEY);
                if (savedPresets) {
                    presets = JSON.parse(savedPresets);
                } else {
                    // ÂàùÂõûËµ∑ÂãïÊôÇ„ÅØÂàùÊúü„Éó„É™„Çª„ÉÉ„Éà„Çí‰ΩøÁî®
                    presets = [...INITIAL_PRESETS];
                    savePresetsToStorage();
                }
                updatePresetList();
            } catch (e) {
                console.error('„Éó„É™„Çª„ÉÉ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                presets = [...INITIAL_PRESETS];
                updatePresetList();
            }
        }

        // „Éó„É™„Çª„ÉÉ„Éà„ÇíFirebase„Å´‰øùÂ≠ò
        function savePresetsToFirebase() {
            database.ref('presets').set({
                data: presets,
                updatedAt: Date.now()
            }).then(() => {
                console.log('„Éó„É™„Çª„ÉÉ„Éà„ÇíFirebase„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            }).catch((error) => {
                console.error('Firebase„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
            });
        }

        // „Éó„É™„Çª„ÉÉ„Éà„ÇíFirebase„Åã„ÇâË™≠„ÅøËæº„Åø
        function loadPresetsFromFirebase() {
            database.ref('presets').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data && data.data) {
                    presets = data.data;
                    savePresetsToStorage();
                    updatePresetList();
                    console.log('Firebase„Åã„Çâ„Éó„É™„Çª„ÉÉ„Éà„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                }
            }).catch((error) => {
                console.error('Firebase„Åã„Çâ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
            });
        }

        // „Éè„Ç∫„É¨„É™„Çπ„ÉàÊõ¥Êñ∞
        function updateLossList() {
            const container = document.getElementById('lossList');

            if (losses.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">„Éè„Ç∫„É¨„ÇíËøΩÂä†„Åô„Çã„Å®ÊâãÂãïË®≠ÂÆö„Åß„Åç„Åæ„Åô</p>';
                return;
            }

            container.innerHTML = losses.map(loss => `
                <div class="prize-item" style="background: rgba(255, 149, 0, 0.1); border-color: var(--sf-orange);">
                    <div class="prize-content" style="grid-template-columns: 2fr 1fr 1fr auto; margin-top: 8px;">
                        <div class="prize-name">${loss.name}</div>
                        <div class="prize-value">¬•${loss.value.toLocaleString()}</div>
                        <div class="prize-count">${loss.count}Êûö</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="editLoss(${loss.id})">Á∑®ÈõÜ</button>
                            <button class="btn btn-danger" onclick="removeLoss(${loss.id})">ÂâäÈô§</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ÂÄ§„Çí10„ÅÆ‰Ωç„Åß‰∏∏„ÇÅ„ÇãÔºà1Ê°Å„Çí0„Å´„Åô„ÇãÔºâ
        function roundToTens(value) {
            return Math.round(value / 10) * 10;
        }

        // „Éó„É™„Çª„ÉÉ„Éà„Ç™„É™„Éë„ÇíÈÅ©Áî®
        function applyPreset() {
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É™„Çª„ÉÉ„Éà„ÇíÂèñÂæó
            const selectedPresetRadio = document.querySelector('input[name="preset"]:checked');

            if (!selectedPresetRadio) {
                alert('„Éó„É™„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÊôØÂìÅ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (prizes.length === 0) {
                alert('ÂÖà„Å´ÊôØÂìÅ„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const presetId = selectedPresetRadio.value;

            // „Éó„É™„Çª„ÉÉ„Éà„ÇíÊ§úÁ¥¢
            const preset = presets.find(p => p.id === presetId);
            if (!preset) {
                alert('„Éó„É™„Çª„ÉÉ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                return;
            }

            // ÊôØÂìÅ„ÅÆÁ∑èÊûöÊï∞„ÇíË®àÁÆó
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // Á∑èÂè£Êï∞„ÇíË®àÁÆó
            const totalPacks = prizesTotalCount * preset.multiplier;

            // „Éï„Ç©„Éº„É†„Å´ÂÄ§„ÇíË®≠ÂÆö
            document.getElementById('packPrice').value = preset.packPrice;
            document.getElementById('totalPacks').value = totalPacks;
            document.getElementById('minGuaranteeValue').value = preset.minGuaranteeValue;

            // „Éè„Ç∫„É¨„Çí„ÇØ„É™„Ç¢ÔºàËá™ÂãïË®àÁÆó„É¢„Éº„Éâ„Å´„Åô„ÇãÔºâ
            losses = [];
            updateLossList();

            // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§„ÇíÊõ¥Êñ∞
            updateTotalValue();

            // „Éá„Éº„Çø„Çí‰øùÂ≠ò
            saveData();

            // Ëá™Âãï„ÅßË®àÁÆó„ÇíÂÆüË°å
            calculate();

            // Á¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            const lossCount = totalPacks - prizesTotalCount;
            alert(`„Éó„É™„Çª„ÉÉ„Éà„Äå${preset.name}„Äç„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü\n\nÁ∑èÂè£Êï∞: ${totalPacks}Âè£\n„Éë„ÉÉ„ÇØÂçò‰æ°: ¬•${preset.packPrice.toLocaleString()}\nÊôØÂìÅÊûöÊï∞: ${prizesTotalCount}Êûö\n„Éè„Ç∫„É¨ÊûöÊï∞: ${lossCount}Êûö\n\nÂÄ§„ÇíÁ∑®ÈõÜ„Åó„Å¶ÂÜçË®àÁÆó„Åô„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ`);
        }

        // „Ç¨„ÉÅ„É£Èõ£ÊòìÂ∫¶Ë®≠ÂÆö„ÇíÂèñÂæó
        function getDifficultySettings(difficulty) {
            switch(difficulty) {
                case 'easy':
                    return {
                        name: 'ÊØîËºÉÁöÑÂΩì„Åü„Çä„ÇÑ„Åô„ÅÑ',
                        description: '„Éè„Ç∫„É¨„ÅÆ‰æ°ÂÄ§„ÅåÈ´ò„ÇÅ„Åß„ÄÅ„É¶„Éº„Ç∂„Éº„Éï„É¨„É≥„Éâ„É™„Éº„Å™Ë®≠Ë®à',
                        lossDistribution: [0.4, 0.35, 0.25], // È´òÈÇÑÂÖÉÈáçË¶ñ
                        maxValueCap: 0.8 // „Éë„ÉÉ„ÇØÂçò‰æ°„ÅÆ80%„Åæ„Åß
                    };
                case 'hard':
                    return {
                        name: 'ÂΩì„Åü„Çä„Å´„Åè„ÅÑ',
                        description: '„Éè„Ç∫„É¨„ÅÆ‰æ°ÂÄ§„Åå‰Ωé„ÇÅ„Åß„ÄÅÂ§ßÂΩì„Åü„ÇäÈáçË¶ñ„ÅÆË®≠Ë®à',
                        lossDistribution: [0.15, 0.35, 0.5], // ‰ΩéÈÇÑÂÖÉÈáçË¶ñ
                        maxValueCap: 0.5 // „Éë„ÉÉ„ÇØÂçò‰æ°„ÅÆ50%„Åæ„Åß
                    };
                default: // normal
                    return {
                        name: 'ÊôÆÈÄö',
                        description: '„Éê„É©„É≥„Çπ„ÅÆËâØ„ÅÑÊ®ôÊ∫ñÁöÑ„Å™Ë®≠Ë®à',
                        lossDistribution: [0.2, 0.5, 0.3], // „Éê„É©„É≥„ÇπÈáçË¶ñ
                        maxValueCap: 0.7 // „Éë„ÉÉ„ÇØÂçò‰æ°„ÅÆ70%„Åæ„Åß
                    };
            }
        }

        // „É°„Ç§„É≥Ë®àÁÆó
        function calculate() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;

            if (packPrice <= 0 || totalPacks <= 0) {
                return;
            }

            // Âü∫Êú¨Ë®àÁÆó
            const totalValue = packPrice * totalPacks;

            // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§Ë°®Á§∫
            document.getElementById('totalValue').textContent = `¬•${totalValue.toLocaleString()}`;

            // ÊôØÂìÅÁ∑è‰æ°ÂÄ§Ë®àÁÆóÔºà„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§Ôºâ
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // ÊôØÂìÅÁ∑è‰ªïÂÖ•„Çå‰æ°Ê†ºË®àÁÆó
            const prizesTotalPurchasePrice = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);

            // ÂÆüË≥™ÈÇÑÂÖÉÁéáË®àÁÆóÔºà‰ªïÂÖ•„Çå‰æ°Ê†º„Éô„Éº„ÇπÔºâ
            const realReturnRate = totalValue > 0 ? (prizesTotalPurchasePrice / totalValue) * 100 : 0;

            // „Éè„Ç∫„É¨Ë®àÁÆóÔºàÊâãÂãïË®≠ÂÆö or Ëá™ÂãïË®àÁÆóÔºâ
            const remainingSlots = totalPacks - prizesTotalCount;
            let lossTypes = [];

            // ÊâãÂãï„Åß„Éè„Ç∫„É¨„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
            if (losses.length > 0) {
                const manualLossTotalCount = losses.reduce((sum, loss) => sum + loss.count, 0);

                // ÁüõÁõæ„ÉÅ„Çß„ÉÉ„ÇØ1: ÊôØÂìÅÊûöÊï∞ + ÊâãÂãï„Éè„Ç∫„É¨ÊûöÊï∞ > Á∑èÂè£Êï∞
                if (prizesTotalCount + manualLossTotalCount > totalPacks) {
                    showConflictError({
                        type: 'count_overflow',
                        prizesTotalCount,
                        manualLossTotalCount,
                        totalPacks,
                        excess: (prizesTotalCount + manualLossTotalCount) - totalPacks
                    });
                    return;
                }

                // ÁüõÁõæ„ÉÅ„Çß„ÉÉ„ÇØ2: ÊôØÂìÅÊûöÊï∞ + ÊâãÂãï„Éè„Ç∫„É¨ÊûöÊï∞ < Á∑èÂè£Êï∞
                if (prizesTotalCount + manualLossTotalCount < totalPacks) {
                    showConflictError({
                        type: 'count_shortage',
                        prizesTotalCount,
                        manualLossTotalCount,
                        totalPacks,
                        shortage: totalPacks - (prizesTotalCount + manualLossTotalCount)
                    });
                    return;
                }

                // ÊâãÂãï„Éè„Ç∫„É¨„ÇílossTypes„Å´Â§âÊèõ
                lossTypes = losses.map(loss => ({
                    name: loss.name,
                    value: loss.value,
                    count: loss.count,
                    type: 'manual'
                }));

            } else {
                // Ëá™ÂãïË®àÁÆó„É¢„Éº„Éâ
                if (remainingSlots <= 0) {
                    if (!validateSettings()) {
                        return;
                    }
                }

                if (remainingSlots > 0) {
                    // ÊúÄ‰Ωé‰øùË®º‰æ°ÂÄ§„ÅßËá™ÂãïË®àÁÆó
                    const adjustedMinValue = Math.max(1, Math.round(minGuaranteeValue));

                    lossTypes.push({
                        name: `„Éè„Ç∫„É¨ÔºàÊúÄ‰Ωé‰øùË®ºÔºâ`,
                        value: adjustedMinValue,
                        count: remainingSlots,
                        type: 'auto'
                    });
                }
            }

            // ÊúüÂæÖÂÄ§Ë®àÁÆó
            let expectedValue = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (prize.value * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                expectedValue += loss.value * probability;
            });

            // Ê®ôÊ∫ñÂÅèÂ∑ÆË®àÁÆó
            let variance = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (Math.pow(prize.value - expectedValue, 2) * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                variance += Math.pow(loss.value - expectedValue, 2) * probability;
            });

            const stdDev = Math.sqrt(variance);

            // Á∑èÈÇÑÂÖÉÁéá„ÇíË®àÁÆóÔºàÊôØÂìÅ + „Éè„Ç∫„É¨„ÅÆÂêàË®à„Åã„ÇâÁÆóÂá∫Ôºâ
            const lossTotalValue = lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0);
            const actualTotalReturnValue = prizesTotalValue + lossTotalValue;
            const totalReturnRatePercent = totalValue > 0 ? (actualTotalReturnValue / totalValue) * 100 : 0;

            // ÁµêÊûúË°®Á§∫Êõ¥Êñ∞
            updateResults({
                totalReturnRatePercent,
                realReturnRate,
                expectedValue,
                stdDev,
                lossTypes,
                lossCount,
                totalPacks,
                packPrice
            });
        }

        // ÁµêÊûúË°®Á§∫Êõ¥Êñ∞
        function updateResults(data) {
            document.getElementById('summaryTotalReturn').textContent = `${data.totalReturnRatePercent.toFixed(1)}%`;
            document.getElementById('summaryRealReturn').textContent = `${data.realReturnRate.toFixed(1)}%`;

            // ÂÆüË≥™ÈÇÑÂÖÉÁéáÔºàÂ£≤‰∏äÂéü‰æ°ÁéáÔºâ„Åå50ÔºÖ„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÅÆË≠¶Âëä
            if (data.realReturnRate > 50) {
                setTimeout(() => {
                    alert(`‚ö†Ô∏è Ë≠¶ÂëäÔºöÂ£≤‰∏äÂéü‰æ°Áéá„ÅåÈ´ò„Åô„Åé„Åæ„Åô\n\nÁèæÂú®„ÅÆÂÆüË≥™ÈÇÑÂÖÉÁéáÔºàÂ£≤‰∏äÂéü‰æ°ÁéáÔºâ: ${data.realReturnRate.toFixed(1)}%\n\nÂ£≤‰∏äÂéü‰æ°Áéá„Åå50ÔºÖ„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n„Åì„ÅÆ„Åæ„Åæ„Åß„ÅØÂà©ÁõäÁéá„Åå‰Ωé„Åè„ÄÅ„Éì„Ç∏„Éç„Çπ„Å®„Åó„Å¶ÊàêÁ´ã„Åó„Å´„Åè„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n\nÊé®Â•®ÂØæÂøúÔºö\n‚Ä¢ ÊôØÂìÅ„ÅÆ‰ªïÂÖ•„Çå‰æ°Ê†º„ÇíË¶ãÁõ¥„Åô\n‚Ä¢ „Éë„ÉÉ„ÇØÂçò‰æ°„Çí‰∏ä„Åí„Çã\n‚Ä¢ È´òÈ°çÊôØÂìÅ„ÅÆÊûöÊï∞„ÇíÊ∏õ„Çâ„Åô`);
                }, 300);
            }

            // Á∑èÂΩìÈÅ∏ËÄÖÊï∞„ÇíË°®Á§∫
            const totalWinners = prizes.reduce((sum, prize) => sum + prize.count, 0);
            document.getElementById('summaryWinnerCount').textContent = `${totalWinners}‰∫∫`;

            // Á∑è‰ªïÂÖ•„ÇåÈ°ç„ÇíË°®Á§∫
            const totalPurchaseAmount = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);
            document.getElementById('summaryTotalPurchase').textContent = `¬•${totalPurchaseAmount.toLocaleString()}`;

            // ÂΩì„Åü„ÇäÊôØÂìÅÈÇÑÂÖÉÁ∑èÈ°ç„ÇíË°®Á§∫
            const prizeTotalReward = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            document.getElementById('summaryPrizeTotalReward').textContent = `¬•${prizeTotalReward.toLocaleString()}`;

            // „Éè„Ç∫„É¨ÈÇÑÂÖÉÁ∑èÈ°ç„ÇíË°®Á§∫
            const lossTotalReward = data.lossTypes ? data.lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0) : 0;
            document.getElementById('summaryLossTotalReward').textContent = `¬•${lossTotalReward.toLocaleString()}`;

            // ÊôØÂìÅË©≥Á¥∞Êõ¥Êñ∞
            updatePrizeDetails();

            // „Éè„Ç∫„É¨Ë©≥Á¥∞Êõ¥Êñ∞
            updateLossDetails(data.lossTypes, data.lossCount);
            
            // „Éè„Ç∫„É¨ÂàÜÂ∏É„ÉÅ„É£„Éº„ÉàÊõ¥Êñ∞
            drawLossDistributionChart(data.lossTypes);

            // Ë≠¶ÂëäË°®Á§∫„ÅÆÊõ¥Êñ∞
            updateWarnings(data);
        }

        // ÊôØÂìÅË©≥Á¥∞Êõ¥Êñ∞
        function updatePrizeDetails() {
            const container = document.getElementById('prizeDetails');
            
            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">ÊôØÂìÅ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                return;
            }

            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            
            container.innerHTML = prizes.map(prize => {
                const probability = totalPacks > 0 ? (prize.count / totalPacks * 100).toFixed(2) : '0.00';
                return `
                    <div class="result-row">
                        <span class="result-label">${prize.rank}Á≠â ${prize.name}</span>
                        <span class="result-value">${prize.count}Êûö / ${probability}% (‰ªïÂÖ•¬•${prize.purchasePrice.toLocaleString()} / ÈÇÑÂÖÉ¬•${prize.value.toLocaleString()})</span>
                    </div>
                `;
            }).join('');
        }

        // „Éè„Ç∫„É¨Ë©≥Á¥∞Êõ¥Êñ∞
        function updateLossDetails(lossTypes, lossCount) {
            const container = document.getElementById('lossDetailsContainer');
            
            if (!lossTypes || lossTypes.length === 0) {
                container.innerHTML = '<div class="result-row"><span class="result-label">„Éè„Ç∫„É¨„Å™„Åó</span><span class="result-value">-</span></div>';
                document.getElementById('totalLossCount').textContent = '0Êûö';
                return;
            }

            container.innerHTML = lossTypes.map(loss => {
                const probability = lossCount > 0 ? ((loss.count / lossCount) * 100).toFixed(1) : '0.0';
                return `
                    <div class="result-row">
                        <span class="result-label">${loss.name}</span>
                        <span class="result-value">¬•${loss.value.toLocaleString()} √ó ${loss.count}Êûö (${probability}%)</span>
                    </div>
                `;
            }).join('');

            document.getElementById('totalLossCount').textContent = `${lossCount}Êûö`;
        }



        // „Éè„Ç∫„É¨ÂΩìÈÅ∏ËÄÖÂàÜÂ∏É„ÉÅ„É£„Éº„ÉàÊèèÁîª
        function drawLossDistributionChart(lossTypes) {
            const canvas = document.getElementById('lossDistributionChart');
            const ctx = canvas.getContext('2d');
            
            // „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!lossTypes || lossTypes.length === 0) {
                ctx.fillStyle = '#8E8E93';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('„Éè„Ç∫„É¨„Å™„Åó', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const padding = 40;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF'];
            const total = lossTypes.reduce((sum, loss) => sum + loss.count, 0);
            
            if (total === 0) return;
            
            // Ê£í„Ç∞„É©„Éï„Å®„Åó„Å¶ÊèèÁîª
            const barWidth = width / lossTypes.length * 0.8;
            const barSpacing = width / lossTypes.length * 0.2;
            const maxCount = Math.max(...lossTypes.map(loss => loss.count));
            
            lossTypes.forEach((loss, index) => {
                const x = padding + index * (barWidth + barSpacing) + barSpacing / 2;
                const barHeight = (loss.count / maxCount) * height;
                const y = canvas.height - padding - barHeight;
                
                // Ê£í„ÇíÊèèÁîª
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // ÊûöÊï∞„ÇíË°®Á§∫
                ctx.fillStyle = '#000000';
                ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(loss.count + 'Êûö', x + barWidth / 2, y - 5);
                
                // ÂêçÂâç„ÇíË°®Á§∫
                ctx.fillText(loss.name, x + barWidth / 2, canvas.height - 10);
                
                // Ââ≤Âêà„ÇíË°®Á§∫
                const percentage = ((loss.count / total) * 100).toFixed(1);
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(percentage + '%', x + barWidth / 2, y + barHeight / 2);
            });
            
            // „ÉÅ„É£„Éº„Éà„Çø„Ç§„Éà„É´
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('„Éè„Ç∫„É¨ÂΩìÈÅ∏ËÄÖÂàÜÂ∏É', canvas.width / 2, 20);
        }

        // Ë®≠ÂÆöÊ§úË®º„Å®„Ç®„É©„ÉºË°®Á§∫
        function validateSettings() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // „Ç®„É©„ÉºÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('totalPacks').classList.remove('error');

            let hasError = false;
            let errorMessages = [];

            // ÊôØÂìÅÊûöÊï∞„ÅåÁ∑èÂè£Êï∞„ÇíË∂Ö„Åà„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (prizesTotalCount > totalPacks) {
                document.getElementById('totalPacks').classList.add('error');
                hasError = true;
                errorMessages.push(`ÊôØÂìÅ„ÅÆÁ∑èÊûöÊï∞Ôºà${prizesTotalCount}ÊûöÔºâ„ÅåÁ∑èÂè£Êï∞Ôºà${totalPacks}Âè£Ôºâ„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ`);
            }

            if (hasError) {
                showErrorPopup(errorMessages);
                return false;
            }

            return true;
        }

        // „Ç®„É©„Éº„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
        function showErrorPopup(messages) {
            const errorMessage = messages.join('\n\n');
            alert(`‚ö†Ô∏è Ë®≠ÂÆö„Å´„Ç®„É©„Éº„Åå„ÅÇ„Çä„Åæ„Åô\n\n${errorMessage}`);
        }

        // Ë≠¶ÂëäË°®Á§∫Êõ¥Êñ∞ÔºàËªΩÂæÆ„Å™Ë≠¶ÂëäÁî®Ôºâ
        function updateWarnings(data) {
            const warningsContainer = document.getElementById('warnings');
            const warnings = [];

            // ÂøÖË¶Å„Å´Âøú„Åò„Å¶Ë≠¶Âëä„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô

            warningsContainer.innerHTML = warnings.join('');
        }



        // „Éá„Éº„Çø‰øùÂ≠òÔºàÊôØÂìÅ„Å®„Éè„Ç∫„É¨Ôºâ
        function saveData() {
            const data = {
                prizes: prizes,
                losses: losses,
                settings: {
                    packPrice: document.getElementById('packPrice').value,
                    totalPacks: document.getElementById('totalPacks').value,
                    minGuaranteeValue: document.getElementById('minGuaranteeValue').value
                }
            };

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÔºàÊôØÂìÅ„Å®„Éè„Ç∫„É¨Ôºâ
        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);

                    if (data.prizes) {
                        prizes = data.prizes;
                        updatePrizeList();
                    }

                    if (data.losses) {
                        losses = data.losses;
                        updateLossList();
                    }

                    if (data.settings) {
                        document.getElementById('packPrice').value = data.settings.packPrice || '40000';
                        document.getElementById('totalPacks').value = data.settings.totalPacks || '100';
                        document.getElementById('minGuaranteeValue').value = data.settings.minGuaranteeValue || '1';
                    }
                }
            } catch (e) {
                console.error('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        // „Ç¨„ÉÅ„É£‰ΩìÈ®ìÊ©üËÉΩ
        let gachaDrawHistory = [];
        let gachaPool = [];

        // „Ç¨„ÉÅ„É£„Éó„Éº„É´ÁîüÊàê
        function generateGachaPool() {
            gachaPool = [];
            
            // ÊôØÂìÅ„ÇíËøΩÂä†
            prizes.forEach(prize => {
                for (let i = 0; i < prize.count; i++) {
                    gachaPool.push({
                        type: 'prize',
                        item: prize
                    });
                }
            });
            
            // ÁèæÂú®„ÅÆË®≠ÂÆö„Åß„Éè„Ç∫„É¨„ÇíË®àÁÆó
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;

            if (totalPacks > 0) {
                const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);
                const remainingSlots = totalPacks - prizesTotalCount;

                console.log('„Ç¨„ÉÅ„É£„Éó„Éº„É´ÁîüÊàê„Éá„Éê„ÉÉ„Ç∞:', {
                    totalPacks: totalPacks,
                    prizesTotalCount: prizesTotalCount,
                    remainingSlots
                });

                // ÊâãÂãï„Éè„Ç∫„É¨„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
                if (losses.length > 0) {
                    losses.forEach(loss => {
                        console.log(`${loss.name} ÁîüÊàê:`, { count: loss.count, value: loss.value });
                        for (let j = 0; j < loss.count; j++) {
                            gachaPool.push({
                                type: 'loss',
                                item: {
                                    name: loss.name,
                                    value: loss.value,
                                    rank: 'loss'
                                }
                            });
                        }
                    });
                } else if (remainingSlots > 0) {
                    // Ëá™ÂãïË®àÁÆó„É¢„Éº„Éâ
                    const adjustedMinValue = Math.max(1, Math.round(minGuaranteeValue));

                    for (let j = 0; j < remainingSlots; j++) {
                        gachaPool.push({
                            type: 'loss',
                            item: {
                                name: '„Éè„Ç∫„É¨ÔºàÊúÄ‰Ωé‰øùË®ºÔºâ',
                                value: adjustedMinValue,
                                rank: 'loss'
                            }
                        });
                    }
                } else {
                    console.log('„Éè„Ç∫„É¨ÁîüÊàê„Çπ„Ç≠„ÉÉ„Éó:', { remainingSlots, reason: 'remainingSlots <= 0' });
                }
            }
            
            // „Éó„Éº„É´„Çí„Ç∑„É£„ÉÉ„Éï„É´
            for (let i = gachaPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gachaPool[i], gachaPool[j]] = [gachaPool[j], gachaPool[i]];
            }
            
            console.log('„Ç¨„ÉÅ„É£„Éó„Éº„É´ÁîüÊàêÂÆå‰∫Ü:', {
                totalItems: gachaPool.length,
                prizes: gachaPool.filter(item => item.type === 'prize').length,
                losses: gachaPool.filter(item => item.type === 'loss').length,
                expectedTotal: totalPacks
            });

            // ÊúÄÁµÇÁöÑ„Å™„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ
            if (gachaPool.length !== totalPacks) {
                console.error('„Ç¨„ÉÅ„É£„Éó„Éº„É´„Çµ„Ç§„Ç∫„Ç®„É©„Éº:', {
                    expected: totalPacks,
                    actual: gachaPool.length,
                    difference: gachaPool.length - totalPacks
                });
            }
        }

        // „Ç¨„ÉÅ„É£„ÇíÂºï„Åè
        function drawGacha(count) {
            if (gachaPool.length === 0) {
                alert('ÂÖà„Å´„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å„Çí„Åó„Å¶„Ç¨„ÉÅ„É£„ÅÆË®≠ÂÆö„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „Ç¨„ÉÅ„É£„Éó„Éº„É´„ÅÆ„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            if (gachaPool.length !== totalPacks) {
                console.warn('„Ç¨„ÉÅ„É£„Éó„Éº„É´„Çµ„Ç§„Ç∫„ÅåË®≠ÂÆö„Å®Áï∞„Å™„Çä„Åæ„Åô:', {
                    expected: totalPacks,
                    actual: gachaPool.length
                });
            }
            
            if (gachaPool.length < count) {
                alert(`ÊÆã„Çä${gachaPool.length}Êûö„Åó„Åã„ÅÇ„Çä„Åæ„Åõ„Çì`);
                count = gachaPool.length;
            }
            
            const draws = [];
            for (let i = 0; i < count; i++) {
                if (gachaPool.length > 0) {
                    const drawnItem = gachaPool.shift();
                    console.log('„Ç¨„ÉÅ„É£ÁµêÊûú:', drawnItem);
                    draws.push(drawnItem);
                    gachaDrawHistory.push(drawnItem);
                }
            }
            
            updateGachaResults();
            
            // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÇíË°®Á§∫
            document.getElementById('resetGachaBtn').style.display = 'block';
            document.getElementById('gachaResults').style.display = 'block';
        }

        // „Ç¨„ÉÅ„É£ÁµêÊûú„ÇíÊõ¥Êñ∞
        function updateGachaResults() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            
            // Áµ±Ë®àË®àÁÆó
            const totalDraws = gachaDrawHistory.length;
            const prizeCount = gachaDrawHistory.filter(draw => draw.type === 'prize').length;
            const totalValue = gachaDrawHistory.reduce((sum, draw) => sum + draw.item.value, 0);
            const totalCost = totalDraws * packPrice;
            const profit = totalValue - totalCost;
            
            // Áµ±Ë®àË°®Á§∫
            document.getElementById('gachaStats').innerHTML = `
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${totalDraws}</div>
                    <div class="gacha-stat-label">Á∑èÂºï„ÅçÂõûÊï∞</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${prizeCount}</div>
                    <div class="gacha-stat-label">ÂΩìÈÅ∏ÂõûÊï∞</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">¬•${totalValue.toLocaleString()}</div>
                    <div class="gacha-stat-label">Á∑èÈÇÑÂÖÉ‰æ°ÂÄ§</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value" style="color: ${profit >= 0 ? 'var(--sf-green)' : 'var(--sf-red)'}">
                        ${profit >= 0 ? '+' : ''}¬•${profit.toLocaleString()}
                    </div>
                    <div class="gacha-stat-label">ÂèéÊîØ</div>
                </div>
            `;
            
            // Â±•Ê≠¥Ë°®Á§∫ÔºàÊúÄÊñ∞10‰ª∂Ôºâ
            const recentDraws = gachaDrawHistory.slice(-10).reverse();
            document.getElementById('gachaHistory').innerHTML = `
                <h5 style="margin-bottom: 10px;">ÊúÄÊñ∞„ÅÆÂºï„ÅçÁµêÊûú</h5>
                ${recentDraws.map(draw => `
                    <div class="gacha-draw-item ${draw.type === 'prize' ? 'gacha-draw-prize' : 'gacha-draw-loss'}">
                        <span>${draw.item.name}</span>
                        <span>¬•${draw.item.value.toLocaleString()}</span>
                    </div>
                `).join('')}
            `;
        }

        // „Ç¨„ÉÅ„É£„É™„Çª„ÉÉ„Éà
        function resetGacha() {
            if (confirm('„Ç¨„ÉÅ„É£ÁµêÊûú„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                gachaDrawHistory = [];
                generateGachaPool();
                document.getElementById('resetGachaBtn').style.display = 'none';
                document.getElementById('gachaResults').style.display = 'none';
            }
        }

        // „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°åÊôÇ„Å´„Ç¨„ÉÅ„É£„Éó„Éº„É´„ÇÇÁîüÊàê
        const originalCalculate = calculate;
        calculate = function() {
            originalCalculate();
            generateGachaPool();
        };
    </script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebase„ÅÆË®≠ÂÆöÔºà„Åì„Åì„Å´ÂèñÂæó„Åó„ÅüË®≠ÂÆö„ÇíË≤º„Çä‰ªò„ÅëÔºâ
const firebaseConfig = {
  apiKey: "AIzaSyAe9gDljx8sz-amXm_BWyPJgskR_V1S3Oo",
  authDomain: "oripa-simulator.firebaseapp.com",
  databaseURL: "https://oripa-simulator-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "oripa-simulator",
  storageBucket: "oripa-simulator.firebasestorage.app",
  messagingSenderId: "546810114337",
  appId: "1:546810114337:web:14a0657fd25998bef50e60"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
function getCurrentConfig() {
  return {
    packPrice: document.getElementById('packPrice').value,
    totalPacks: document.getElementById('totalPacks').value,
    releaseDate: document.getElementById('releaseDate').value,
    minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
    prizes: [...prizes],
    losses: [...losses]
  };
}

// Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄÈñ¢Êï∞
function loadConfig(config) {
  document.getElementById('packPrice').value = config.packPrice || '40000';
  document.getElementById('totalPacks').value = config.totalPacks || '100';
  document.getElementById('releaseDate').value = config.releaseDate || '';
  document.getElementById('minGuaranteeValue').value = config.minGuaranteeValue || '1';

  if (config.prizes) {
    prizes = [...config.prizes];
    updatePrizeList();
  }

  if (config.losses) {
    losses = [...config.losses];
    updateLossList();
  }

  updateTotalValue();
}

// „ÇØ„É©„Ç¶„Éâ‰øùÂ≠òÊ©üËÉΩ
function saveToCloud(configName) {
  const config = getCurrentConfig();
  const configId = configName || prompt('Ë®≠ÂÆöÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
  if (!configId) return;

  database.ref('configs/' + configId).set({
    data: config,
    updatedAt: Date.now()
  }).then(() => {
    alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü: ' + configId);
    loadConfigList();
  }).catch((error) => {
    alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// „ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠„ÅøËæº„Åø
function loadFromCloud(configId) {
  database.ref('configs/' + configId).once('value').then((snapshot) => {
    const data = snapshot.val();
    if (data) {
      loadConfig(data.data);
      alert('Ë™≠„ÅøËæº„Åø„Åæ„Åó„Åü: ' + configId);
    } else {
      alert('Ë®≠ÂÆö„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
    }
  }).catch((error) => {
    alert('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Åß„ÇØ„É©„Ç¶„ÉâË®≠ÂÆö„ÇíÁÆ°ÁêÜ
let cloudConfigs = {};
let currentCloudConfigId = null;

// Ë®≠ÂÆö‰∏ÄË¶ßË°®Á§∫
function loadConfigList() {
  database.ref('configs').once('value').then((snapshot) => {
    const configs = snapshot.val();
    console.log('‰øùÂ≠òÊ∏à„ÅøË®≠ÂÆö:', Object.keys(configs || {}));
    // ÂøÖË¶Å„Å´Âøú„Åò„Å¶UIË°®Á§∫
  });
}

// „ÇØ„É©„Ç¶„ÉâË®≠ÂÆö‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
function refreshCloudConfigList() {
  updateCloudStatus('Ë®≠ÂÆö‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø‰∏≠...');

  database.ref('configs').once('value').then((snapshot) => {
    cloudConfigs = snapshot.val() || {};
    updateCloudConfigSelectBox();
    updateCloudStatus(`${Object.keys(cloudConfigs).length}‰ª∂„ÅÆË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
  }).catch((error) => {
    updateCloudStatus('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// „ÇØ„É©„Ç¶„ÉâË®≠ÂÆö„ÅÆ„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞
function updateCloudConfigSelectBox() {
  const selectBox = document.getElementById('cloudConfigList');
  selectBox.innerHTML = '<option value="">Ë®≠ÂÆö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';

  // ÊúÄÁµÇ‰øùÂ≠òÊó•„ÅÆÊñ∞„Åó„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
  const sortedConfigIds = Object.keys(cloudConfigs).sort((a, b) => {
    const dateA = cloudConfigs[a].updatedAt || 0;
    const dateB = cloudConfigs[b].updatedAt || 0;
    return dateB - dateA; // ÈôçÈ†ÜÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
  });

  sortedConfigIds.forEach(configId => {
    const config = cloudConfigs[configId];
    const date = new Date(config.updatedAt).toLocaleString('ja-JP');
    const option = document.createElement('option');
    option.value = configId;
    option.textContent = `${configId} (${date})`;
    selectBox.appendChild(option);
  });

  // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆË®≠ÂÆö„Åå„ÅÇ„Çå„Å∞ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÁ∂≠ÊåÅ
  if (currentCloudConfigId && cloudConfigs[currentCloudConfigId]) {
    selectBox.value = currentCloudConfigId;
    document.getElementById('updateCloudBtn').disabled = false;
  } else {
    document.getElementById('updateCloudBtn').disabled = true;
  }
}

// „ÇØ„É©„Ç¶„Éâ„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„ÇíÊõ¥Êñ∞
function updateCloudStatus(message) {
  document.getElementById('cloudStatus').textContent = message;
  setTimeout(() => {
    document.getElementById('cloudStatus').textContent = '';
  }, 3000);
}

// Êñ∞Ë¶è„ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò
function saveToCloudWithName() {
  const configName = document.getElementById('cloudConfigName').value.trim();
  if (!configName) {
    alert('Ë®≠ÂÆöÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  // ÂêåÂêç„ÅÆË®≠ÂÆö„ÅåÊó¢„Å´Â≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  if (cloudConfigs[configName]) {
    if (!confirm(`„Äå${configName}„Äç„Å®„ÅÑ„ÅÜË®≠ÂÆö„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü`)) {
      return;
    }
  }

  const config = getCurrentConfig();
  updateCloudStatus('‰øùÂ≠ò‰∏≠...');

  database.ref('configs/' + configName).set({
    data: config,
    updatedAt: Date.now(),
    createdBy: 'user', // Â∞ÜÊù•ÁöÑ„Å´„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„ÇíËøΩÂä†„Åô„ÇãÂ†¥Âêà
    version: '1.0'
  }).then(() => {
    currentCloudConfigId = configName;
    document.getElementById('updateCloudBtn').disabled = false;
    updateCloudStatus(`„Äå${configName}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
    refreshCloudConfigList();
    document.getElementById('cloudConfigName').value = '';
    // ÈõÜË®à„ÇíËá™ÂãïÊõ¥Êñ∞
    setTimeout(() => refreshWeeklyStats(), 500);
  }).catch((error) => {
    updateCloudStatus('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// ÁèæÂú®„ÅÆË®≠ÂÆö„Çí‰∏äÊõ∏„ÅçÊõ¥Êñ∞
function updateCloudConfig() {
  if (!currentCloudConfigId) {
    alert('Êõ¥Êñ∞„Åô„ÇãË®≠ÂÆö„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
    return;
  }

  if (!confirm(`„Äå${currentCloudConfigId}„Äç„ÇíÁèæÂú®„ÅÆË®≠ÂÆö„Åß‰∏äÊõ∏„ÅçÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü`)) {
    return;
  }

  const config = getCurrentConfig();
  updateCloudStatus('Êõ¥Êñ∞‰∏≠...');

  database.ref('configs/' + currentCloudConfigId).update({
    data: config,
    updatedAt: Date.now()
  }).then(() => {
    updateCloudStatus(`„Äå${currentCloudConfigId}„Äç„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü`);
    refreshCloudConfigList();
    // ÈõÜË®à„ÇíËá™ÂãïÊõ¥Êñ∞
    setTimeout(() => refreshWeeklyStats(), 500);
  }).catch((error) => {
    updateCloudStatus('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// ÈÅ∏Êäû„Åï„Çå„Åü„ÇØ„É©„Ç¶„ÉâË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
function loadSelectedCloudConfig() {
  const selectedConfigId = document.getElementById('cloudConfigList').value;
  if (!selectedConfigId) {
    alert('Ë™≠„ÅøËæº„ÇÄË®≠ÂÆö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  updateCloudStatus('Ë™≠„ÅøËæº„Åø‰∏≠...');

  database.ref('configs/' + selectedConfigId).once('value').then((snapshot) => {
    const configData = snapshot.val();
    if (configData && configData.data) {
      loadConfig(configData.data);
      currentCloudConfigId = selectedConfigId;
      document.getElementById('updateCloudBtn').disabled = false;
      document.getElementById('cloudConfigName').value = selectedConfigId;
      updateCloudStatus(`„Äå${selectedConfigId}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
    } else {
      updateCloudStatus('Ë®≠ÂÆö„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
    }
  }).catch((error) => {
    updateCloudStatus('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// ÈÅ∏Êäû„Åï„Çå„Åü„ÇØ„É©„Ç¶„ÉâË®≠ÂÆö„ÇíÂâäÈô§
function deleteSelectedCloudConfig() {
  const selectedConfigId = document.getElementById('cloudConfigList').value;
  if (!selectedConfigId) {
    alert('ÂâäÈô§„Åô„ÇãË®≠ÂÆö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  if (!confirm(`„Äå${selectedConfigId}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
    return;
  }

  updateCloudStatus('ÂâäÈô§‰∏≠...');

  database.ref('configs/' + selectedConfigId).remove().then(() => {
    if (currentCloudConfigId === selectedConfigId) {
      currentCloudConfigId = null;
      document.getElementById('updateCloudBtn').disabled = true;
      document.getElementById('cloudConfigName').value = '';
    }
    updateCloudStatus(`„Äå${selectedConfigId}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
    refreshCloudConfigList();
  }).catch((error) => {
    updateCloudStatus('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
  });
}

// URL„Éë„É©„É°„Éº„Çø„Åã„ÇâË®≠ÂÆöID„ÇíÂèñÂæó
function getConfigIdFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('config');
}

// URL„Éë„É©„É°„Éº„Çø„ÅßÊåáÂÆö„Åï„Çå„ÅüË®≠ÂÆö„ÇíËá™ÂãïË™≠„ÅøËæº„Åø
function loadConfigFromURL() {
  const configId = getConfigIdFromURL();
  if (!configId) return;

  updateCloudStatus(`ÂÖ±ÊúâË®≠ÂÆö„Äå${configId}„Äç„ÇíË™≠„ÅøËæº„Åø‰∏≠...`);

  database.ref('configs/' + configId).once('value').then((snapshot) => {
    const configData = snapshot.val();
    if (configData && configData.data) {
      loadConfig(configData.data);
      currentCloudConfigId = configId;
      document.getElementById('updateCloudBtn').disabled = false;
      document.getElementById('cloudConfigName').value = configId;

      // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇÇÊõ¥Êñ∞
      const selectBox = document.getElementById('cloudConfigList');
      if (selectBox) {
        selectBox.value = configId;
      }

      updateCloudStatus(`ÂÖ±ÊúâË®≠ÂÆö„Äå${configId}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);

      // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
      setTimeout(() => {
        alert(`üîó ÂÖ±Êúâ„Åï„Çå„ÅüË®≠ÂÆö„Äå${configId}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ\n\nË®≠ÂÆö„ÇíÁ∑®ÈõÜ„Åó„Å¶„Äå‰∏äÊõ∏„ÅçÊõ¥Êñ∞„Äç„Åô„Çã„Å®„ÄÅÂÖÉ„ÅÆË®≠ÂÆö„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ\n„ÄåÂà•Âêç‰øùÂ≠ò„Äç„ÅßÊñ∞„Åó„ÅÑË®≠ÂÆö„Å®„Åó„Å¶‰øùÂ≠ò„Åô„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ`);
      }, 500);
    } else {
      updateCloudStatus(`ÂÖ±ÊúâË®≠ÂÆö„Äå${configId}„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü`);
      alert(`‚ùå ÂÖ±ÊúâË®≠ÂÆö„Äå${configId}„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\nË®≠ÂÆö„ÅåÂâäÈô§„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÄÅË®≠ÂÆöÂêç„ÅåÊ≠£„Åó„Åè„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ`);
    }
  }).catch((error) => {
    updateCloudStatus('ÂÖ±ÊúâË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
    alert(`‚ùå ÂÖ±ÊúâË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Ç®„É©„Éº: ${error.message}`);
  });
}

// ÂÖ±Êúâ„É™„É≥„ÇØ„ÇíÁîüÊàê„Åó„Å¶„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
function generateShareLink() {
  if (!currentCloudConfigId) {
    alert('ÂÖ±Êúâ„Åô„ÇãË®≠ÂÆö„ÇíÈÅ∏Êäû„Åæ„Åü„ÅØ‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  const baseUrl = window.location.origin + window.location.pathname;
  const shareUrl = `${baseUrl}?config=${encodeURIComponent(currentCloudConfigId)}`;

  // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
  navigator.clipboard.writeText(shareUrl).then(() => {
    updateShareStatus('‚úÖ „É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');

    // ÊàêÂäü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
    showCopySuccessPopup(shareUrl);
  }).catch(() => {
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „É¢„Éº„ÉÄ„É´Ë°®Á§∫
    showShareLinkModal(shareUrl);
  });
}

// „Ç≥„Éî„ÉºÊàêÂäü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
function showCopySuccessPopup(shareUrl) {
  // Êó¢Â≠ò„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
  const existingPopup = document.getElementById('copySuccessPopup');
  if (existingPopup) {
    document.body.removeChild(existingPopup);
  }

  const popup = document.createElement('div');
  popup.id = 'copySuccessPopup';
  popup.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #34C759, #30D158);
    color: white;
    padding: 20px 24px;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(52, 199, 89, 0.3);
    z-index: 10000;
    transform: translateX(400px);
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    max-width: 350px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    backdrop-filter: blur(20px);
  `;

  popup.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
      <div style="font-size: 24px;">‚úÖ</div>
      <div style="font-size: 16px; font-weight: 600;">„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ</div>
    </div>
    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">
      „Äå${currentCloudConfigId}„Äç„ÅÆÂÖ±Êúâ„É™„É≥„ÇØ„Åå„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åï„Çå„Åæ„Åó„Åü
    </div>
    <div style="font-size: 11px; opacity: 0.8; word-break: break-all; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px;">
      ${shareUrl}
    </div>
    <div style="position: absolute; top: 8px; right: 8px; cursor: pointer; font-size: 18px; opacity: 0.7; hover: opacity: 1;" onclick="document.body.removeChild(this.parentElement)">
      √ó
    </div>
  `;

  document.body.appendChild(popup);

  // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥: „Çπ„É©„Ç§„Éâ„Ç§„É≥
  setTimeout(() => {
    popup.style.transform = 'translateX(0)';
  }, 50);

  // 4ÁßíÂæå„Å´Ëá™Âãï„ÅßÈùûË°®Á§∫
  setTimeout(() => {
    if (popup.parentElement) {
      popup.style.transform = 'translateX(400px)';
      setTimeout(() => {
        if (popup.parentElement) {
          document.body.removeChild(popup);
        }
      }, 300);
    }
  }, 4000);

  // „ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
  popup.onclick = (e) => {
    if (e.target.tagName !== 'DIV') return;
    popup.style.transform = 'translateX(400px)';
    setTimeout(() => {
      if (popup.parentElement) {
        document.body.removeChild(popup);
      }
    }, 300);
  };
}

// ÂÖ±Êúâ„É™„É≥„ÇØ„É¢„Éº„ÉÄ„É´Ë°®Á§∫Ôºà„ÇØ„É™„ÉÉ„Éó„Éú„Éº„ÉâAPI„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥ÂêàÔºâ
function showShareLinkModal(shareUrl) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

  modal.innerHTML = `
    <div style="background: white; padding: 32px; border-radius: 16px; max-width: 500px; width: 90%;">
      <h3 style="margin: 0 0 16px 0;">üîó ÂÖ±Êúâ„É™„É≥„ÇØ</h3>
      <p style="margin: 0 0 16px 0; color: #666;">‰ª•‰∏ã„ÅÆ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Å¶ÂÖ±Êúâ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
      <input type="text" value="${shareUrl}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 16px;" readonly onclick="this.select()">
      <div style="display: flex; gap: 12px;">
        <button onclick="copyFromModal('${shareUrl}', this)" style="flex: 1; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer;">
          üìã „Ç≥„Éî„Éº
        </button>
        <button onclick="document.body.removeChild(this.closest('div[style*=\"fixed\"]'))" style="flex: 1; padding: 12px; background: #8E8E93; color: white; border: none; border-radius: 8px; cursor: pointer;">
          Èñâ„Åò„Çã
        </button>
      </div>
    </div>
  `;

  modal.onclick = (e) => {
    if (e.target === modal) document.body.removeChild(modal);
  };

  document.body.appendChild(modal);
}

// „É¢„Éº„ÉÄ„É´„Åã„Çâ„ÅÆ„Ç≥„Éî„ÉºÂá¶ÁêÜ
function copyFromModal(shareUrl, buttonElement) {
  navigator.clipboard.writeText(shareUrl).then(() => {
    // „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí‰∏ÄÊôÇÁöÑ„Å´Â§âÊõ¥
    const originalText = buttonElement.textContent;
    buttonElement.textContent = '‚úÖ „Ç≥„Éî„ÉºÊ∏à„Åø';
    buttonElement.style.background = '#34C759';

    setTimeout(() => {
      // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
      const modal = buttonElement.closest('div[style*="fixed"]');
      if (modal) {
        document.body.removeChild(modal);
      }

      // ÊàêÂäü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
      showCopySuccessPopup(shareUrl);
    }, 800);
  }).catch(() => {
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „ÉÜ„Ç≠„Çπ„Éà„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
    const input = buttonElement.closest('div').previousElementSibling;
    input.select();
    input.setSelectionRange(0, 99999);

    buttonElement.textContent = '‚ö†Ô∏è ÊâãÂãï„Åß„Ç≥„Éî„Éº';
    setTimeout(() => {
      buttonElement.textContent = 'üìã „Ç≥„Éî„Éº';
    }, 2000);
  });
}

// ÂÖ±Êúâ„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„ÇíÊõ¥Êñ∞
function updateShareStatus(message) {
  document.getElementById('shareStatus').textContent = message;
  setTimeout(() => {
    document.getElementById('shareStatus').textContent = '';
  }, 3000);
}

// ÂÖ±Êúâ„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
function updateShareButtonState() {
  const shareBtn = document.getElementById('shareBtn');
  if (currentCloudConfigId) {
    shareBtn.disabled = false;
    shareBtn.textContent = `üìã „Äå${currentCloudConfigId}„Äç„ÅÆ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº`;
  } else {
    shareBtn.disabled = true;
    shareBtn.textContent = 'üìã ÂÖ±Êúâ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº';
  }
}

// Êó¢Â≠ò„ÅÆÈñ¢Êï∞„ÇíÊã°ÂºµÔºöË®≠ÂÆö‰øùÂ≠ò„ÉªË™≠„ÅøËæº„ÅøÊôÇ„Å´ÂÖ±Êúâ„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
const originalSaveToCloudWithName = saveToCloudWithName;
saveToCloudWithName = function() {
  const result = originalSaveToCloudWithName.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

const originalLoadSelectedCloudConfig = loadSelectedCloudConfig;
loadSelectedCloudConfig = function() {
  const result = originalLoadSelectedCloudConfig.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

const originalLoadConfigFromURL = loadConfigFromURL;
loadConfigFromURL = function() {
  const result = originalLoadConfigFromURL.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

// ========== ÈÅéÂéª7Êó•Èñì„ÅÆÈõÜË®àÊ©üËÉΩ ==========

// ÈÅéÂéª7Êó•Èñì„ÅÆÈõÜË®à„ÇíÊõ¥Êñ∞
function refreshWeeklyStats() {
  const container = document.getElementById('weeklyStatsContainer');
  container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">ÈõÜË®à‰∏≠...</p>';

  // 7Êó•Ââç„ÅÆ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÇíÂèñÂæó
  const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

  database.ref('configs').once('value').then((snapshot) => {
    const allConfigs = snapshot.val() || {};

    // ÈÅéÂéª7Êó•Èñì„ÅÆ„Éá„Éº„Çø„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
    const recentConfigs = Object.entries(allConfigs).filter(([configId, configData]) => {
      return configData.updatedAt && configData.updatedAt >= sevenDaysAgo;
    });

    if (recentConfigs.length === 0) {
      container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">ÈÅéÂéª7Êó•Èñì„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
      return;
    }

    // ÈõÜË®àÂá¶ÁêÜ
    const stats = calculateWeeklyStats(recentConfigs);

    // ÁµêÊûú„ÇíË°®Á§∫
    displayWeeklyStats(stats);
  }).catch((error) => {
    container.innerHTML = `<p style="color: var(--sf-red); text-align: center;">ÈõÜË®à„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</p>`;
  });
}

// ÈÅéÂéª7Êó•Èñì„ÅÆ„Éá„Éº„Çø„Åã„ÇâÁµ±Ë®à„ÇíË®àÁÆó
function calculateWeeklyStats(recentConfigs) {
  let totalOripaCount = recentConfigs.length;
  let totalValue = 0;
  let totalPurchase = 0;
  let totalPacks = 0;
  let totalWinners = 0;
  let totalPrizeCount = 0;
  let totalLossCount = 0;
  let totalReturnRates = [];
  let totalRealReturnRates = [];

  recentConfigs.forEach(([configId, configData]) => {
    const config = configData.data;
    if (!config) return;

    const packPrice = parseFloat(config.packPrice) || 0;
    const packs = parseInt(config.totalPacks) || 0;
    const prizes = config.prizes || [];
    const losses = config.losses || [];

    // „Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§
    const oripaValue = packPrice * packs;
    totalValue += oripaValue;

    // Á∑èÂè£Êï∞
    totalPacks += packs;

    // ÊôØÂìÅ„ÅÆÈõÜË®à
    let prizeTotalValue = 0;
    let prizeTotalPurchase = 0;
    let prizeCount = 0;

    prizes.forEach(prize => {
      prizeCount += prize.count || 0;
      prizeTotalValue += (prize.value || 0) * (prize.count || 0);
      prizeTotalPurchase += (prize.purchasePrice || 0) * (prize.count || 0);
    });

    totalWinners += prizeCount;
    totalPrizeCount += prizeCount;
    totalPurchase += prizeTotalPurchase;

    // „Éè„Ç∫„É¨„ÅÆÈõÜË®à
    let lossTotalValue = 0;
    let lossCount = 0;

    if (losses.length > 0) {
      losses.forEach(loss => {
        lossCount += loss.count || 0;
        lossTotalValue += (loss.value || 0) * (loss.count || 0);
      });
    } else {
      // Ëá™ÂãïË®àÁÆó„ÅÆÂ†¥Âêà
      const minGuaranteeValue = parseFloat(config.minGuaranteeValue) || 1;
      const remainingSlots = packs - prizeCount;
      if (remainingSlots > 0) {
        lossCount = remainingSlots;
        lossTotalValue = minGuaranteeValue * remainingSlots;
      }
    }

    totalLossCount += lossCount;

    // Á∑èÈÇÑÂÖÉÁéá
    const actualTotalReturnValue = prizeTotalValue + lossTotalValue;
    const totalReturnRate = oripaValue > 0 ? (actualTotalReturnValue / oripaValue) * 100 : 0;
    totalReturnRates.push(totalReturnRate);

    // ÂÆüË≥™ÈÇÑÂÖÉÁéáÔºàÂ£≤‰∏äÂéü‰æ°ÁéáÔºâ
    const realReturnRate = oripaValue > 0 ? (prizeTotalPurchase / oripaValue) * 100 : 0;
    totalRealReturnRates.push(realReturnRate);
  });

  // Âπ≥Âùá„ÇíË®àÁÆó
  const avgValue = totalOripaCount > 0 ? totalValue / totalOripaCount : 0;
  const avgPurchase = totalOripaCount > 0 ? totalPurchase / totalOripaCount : 0;
  const avgReturnRate = totalReturnRates.length > 0 ? totalReturnRates.reduce((a, b) => a + b, 0) / totalReturnRates.length : 0;
  const avgRealReturnRate = totalRealReturnRates.length > 0 ? totalRealReturnRates.reduce((a, b) => a + b, 0) / totalRealReturnRates.length : 0;
  const avgPacks = totalOripaCount > 0 ? totalPacks / totalOripaCount : 0;

  return {
    totalOripaCount,
    totalValue,
    avgValue,
    totalPurchase,
    avgPurchase,
    totalPacks,
    avgPacks,
    totalWinners,
    totalPrizeCount,
    totalLossCount,
    avgReturnRate,
    avgRealReturnRate,
    totalReturnRates,
    totalRealReturnRates
  };
}

// ÈõÜË®àÁµêÊûú„ÇíË°®Á§∫
function displayWeeklyStats(stats) {
  const container = document.getElementById('weeklyStatsContainer');

  container.innerHTML = `
    <div style="margin-bottom: 16px; padding: 12px; background: rgba(175, 82, 222, 0.1); border-radius: 8px; text-align: center;">
      <div style="font-size: 24px; font-weight: 700; color: var(--sf-purple);">${stats.totalOripaCount}</div>
      <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;">„Ç™„É™„ÉëË®≠ÂÆöÊï∞</div>
    </div>

    <div style="display: grid; gap: 8px;">
      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">Êèê‰æõ‰æ°ÂÄ§ÂêàË®à</span>
        <span style="font-weight: 600;">¬•${stats.totalValue.toLocaleString()}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">Êèê‰æõ‰æ°ÂÄ§Âπ≥Âùá</span>
        <span style="font-weight: 600;">¬•${Math.round(stats.avgValue).toLocaleString()}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">‰ªïÂÖ•„ÇåÂêàË®à</span>
        <span style="font-weight: 600; color: var(--sf-orange);">¬•${stats.totalPurchase.toLocaleString()}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">‰ªïÂÖ•„ÇåÂπ≥Âùá</span>
        <span style="font-weight: 600; color: var(--sf-orange);">¬•${Math.round(stats.avgPurchase).toLocaleString()}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">Á∑èÈÇÑÂÖÉÁéáÂπ≥Âùá</span>
        <span style="font-weight: 600; color: var(--sf-blue);">${stats.avgReturnRate.toFixed(1)}%</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">ÂÆüË≥™ÈÇÑÂÖÉÁéáÂπ≥Âùá</span>
        <span style="font-weight: 600; color: var(--sf-green);">${stats.avgRealReturnRate.toFixed(1)}%</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">Á∑èÂè£Êï∞ÂêàË®à</span>
        <span style="font-weight: 600;">${stats.totalPacks.toLocaleString()}Âè£</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">Âπ≥ÂùáÂè£Êï∞</span>
        <span style="font-weight: 600;">${Math.round(stats.avgPacks).toLocaleString()}Âè£</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">ÂΩìÈÅ∏ËÄÖÁ∑èÊï∞</span>
        <span style="font-weight: 600; color: var(--sf-purple);">${stats.totalWinners.toLocaleString()}‰∫∫</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">ÊôØÂìÅÁ∑èÊûöÊï∞</span>
        <span style="font-weight: 600;">${stats.totalPrizeCount.toLocaleString()}Êûö</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span style="color: var(--sf-gray);">„Éè„Ç∫„É¨Á∑èÊûöÊï∞</span>
        <span style="font-weight: 600;">${stats.totalLossCount.toLocaleString()}Êûö</span>
      </div>
    </div>

    <div style="margin-top: 12px; padding: 8px; background: rgba(0, 122, 255, 0.05); border-radius: 6px; font-size: 11px; color: var(--sf-gray); text-align: center;">
      ÈÅéÂéª7Êó•Èñì„ÅÆ„Éá„Éº„ÇøÔºà${new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toLocaleDateString('ja-JP')} „Äú ${new Date().toLocaleDateString('ja-JP')}Ôºâ
    </div>
  `;
}

// ÂàùÊúüÂåñÊôÇ„Å´„ÇØ„É©„Ç¶„ÉâË®≠ÂÆö‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø
document.addEventListener('DOMContentLoaded', function() {
  // Êó¢Â≠ò„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ„ÅÆÂæå„Å´ËøΩÂä†
  setTimeout(() => {
    refreshCloudConfigList();
    // URL„Éë„É©„É°„Éº„Çø„ÅßË®≠ÂÆö„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØËá™ÂãïË™≠„ÅøËæº„Åø
    loadConfigFromURL();
    // ÂÖ±Êúâ„Éú„Çø„É≥„ÅÆÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
    updateShareButtonState();
    // ÈÅéÂéª7Êó•Èñì„ÅÆÈõÜË®à„ÇíËá™ÂãïË™≠„ÅøËæº„Åø
    refreshWeeklyStats();
  }, 1000); // Firebase„ÅÆÂàùÊúüÂåñ„ÇíÂæÖ„Å§
});

// ========== „Ç™„É™„Éë„Çπ„Ç≥„Ç¢Ë©ï‰æ°Ê©üËÉΩ ==========

// „Çπ„Ç≥„Ç¢Ë®àÁÆóÈñ¢Êï∞
function calculateOripaScore() {
    const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
    const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
    const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;

    if (totalPacks === 0 || packPrice === 0) {
        alert('Âü∫Êú¨Ë®≠ÂÆö„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return null;
    }

    if (prizes.length === 0) {
        alert('ÊôØÂìÅ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return null;
    }

    // Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ
    const totalValue = packPrice * totalPacks;

    // ÊôØÂìÅÁ∑è‰æ°ÂÄ§Ë®àÁÆóÔºà„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ‰æ°ÂÄ§Ôºâ
    const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
    const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

    // ÊôØÂìÅÁ∑è‰ªïÂÖ•„Çå‰æ°Ê†ºË®àÁÆó
    const prizesTotalPurchasePrice = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);

    // ÂÆüË≥™ÈÇÑÂÖÉÁéáË®àÁÆóÔºà‰ªïÂÖ•„Çå‰æ°Ê†º„Éô„Éº„ÇπÔºâ
    const realReturnRate = totalValue > 0 ? (prizesTotalPurchasePrice / totalValue) * 100 : 0;

    // „Éè„Ç∫„É¨Ë®àÁÆó
    const remainingSlots = totalPacks - prizesTotalCount;
    let lossTypes = [];

    if (losses.length > 0) {
        lossTypes = losses.map(loss => ({
            name: loss.name,
            value: loss.value,
            count: loss.count
        }));
    } else {
        if (remainingSlots > 0) {
            lossTypes = [{
                name: '„Éè„Ç∫„É¨ÔºàËá™ÂãïÔºâ',
                value: minGuaranteeValue,
                count: remainingSlots
            }];
        }
    }

    // Á∑èÈÇÑÂÖÉÁéáË®àÁÆó
    const lossTotalValue = lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0);
    const actualTotalReturnValue = prizesTotalValue + lossTotalValue;
    const totalReturnRatePercent = totalValue > 0 ? (actualTotalReturnValue / totalValue) * 100 : 0;

    const prizeCount = prizesTotalCount;

    // „Çπ„Ç≥„Ç¢Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØÔºàÂÆüË≥™ÈÇÑÂÖÉÁéá„ÅÆ„Åø„ÅßË©ï‰æ°Ôºö100ÁÇπÊ∫ÄÁÇπÔºâ
    let score = 0;

    // ÂÆüË≥™ÈÇÑÂÖÉÁéá„Çπ„Ç≥„Ç¢Ôºà100ÁÇπÊ∫ÄÁÇπÔºâ
    // ÂÆüË≥™ÈÇÑÂÖÉÁéá„Åå‰Ωé„ÅÑ„Åª„Å©Âà©ÁõäÁéá„ÅåÈ´ò„Åè„ÄÅËâØ„ÅÑË©ï‰æ°
    if (realReturnRate <= 20) {
        score = 100; // SË©ï‰æ°ÔºöÈùûÂ∏∏„Å´ÂÑ™„Çå„ÅüÂà©ÁõäÁéá
    } else if (realReturnRate <= 30) {
        score = 85; // AË©ï‰æ°ÔºöÂÑ™„Çå„ÅüÂà©ÁõäÁéá
    } else if (realReturnRate <= 40) {
        score = 70; // BË©ï‰æ°ÔºöËâØÂ•Ω„Å™Âà©ÁõäÁéá
    } else if (realReturnRate <= 50) {
        score = 55; // CË©ï‰æ°Ôºö„Åæ„ÅÇ„Åæ„ÅÇ„ÅÆÂà©ÁõäÁéá
    } else if (realReturnRate <= 60) {
        score = 40; // DË©ï‰æ°Ôºö„ÇÑ„ÇÑÂé≥„Åó„ÅÑÂà©ÁõäÁéá
    } else {
        score = 20; // EË©ï‰æ°ÔºöÂé≥„Åó„ÅÑÂà©ÁõäÁéá
    }

    // „É©„É≥„ÇØÂà§ÂÆö
    let rank = 'E';
    if (score >= 90) rank = 'S';
    else if (score >= 75) rank = 'A';
    else if (score >= 60) rank = 'B';
    else if (score >= 45) rank = 'C';
    else if (score >= 30) rank = 'D';

    return {
        score: score,
        rank: rank,
        realReturnRate: realReturnRate,
        totalReturnRate: totalReturnRatePercent,
        prizeCount: prizeCount,
        totalValue: totalValue,
        totalPacks: totalPacks
    };
}

// „Çπ„Ç≥„Ç¢Ë©ï‰æ°„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
function showScoreEvaluation() {
    const scoreData = calculateOripaScore();

    if (!scoreData) {
        return;
    }

    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    const modal = document.getElementById('scoreModal');
    modal.classList.add('show');

    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
    animateScore(scoreData);
}

// „Çπ„Ç≥„Ç¢Ë©ï‰æ°„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
function closeScoreModal() {
    const modal = document.getElementById('scoreModal');
    modal.classList.remove('show');
}

// „Çπ„Ç≥„Ç¢Ë°®Á§∫Ôºà„Çπ„É©„Ç§„Éâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºâ
function animateScore(scoreData) {
    const rankElement = document.getElementById('scoreRank');
    const rankContainer = document.getElementById('scoreRankContainer');

    // „É©„É≥„ÇØ„ÅÆÈÖçÂàóÔºàE ‚Üí D ‚Üí C ‚Üí B ‚Üí A ‚Üí S „ÅÆÈ†ÜÔºâ
    const ranks = ['E', 'D', 'C', 'B', 'A', 'S'];
    const targetRankIndex = ranks.indexOf(scoreData.rank);

    // E„Åã„ÇâÁõÆÊ®ô„É©„É≥„ÇØ„Åæ„Åß„ÅÆÈÖçÂàó„Çí‰ΩúÊàêÔºà‰Ωé„ÅÑÊñπ„Åã„ÇâÈ†ÜÁï™„Å´‰∏ä„Åå„ÇãÔºâ
    const ranksToShow = ranks.slice(0, targetRankIndex + 1);

    let currentIndex = 0;
    const slideInDuration = 100; // „Çπ„É©„Ç§„Éâ„Ç§„É≥„ÅÆÊôÇÈñìÔºàË∂ÖÈ´òÈÄüÔºâ
    const displayDuration = 100; // Ë°®Á§∫ÊôÇÈñìÔºàË∂ÖÈ´òÈÄüÔºâ
    const transitionDelay = 50; // Ê¨°„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Åæ„Åß„ÅÆÈÅÖÂª∂ÔºàÈÄ£Á∂öÁöÑ„Å´Ë¶ã„Åà„Çã„Çà„ÅÜ„Å´Áü≠„ÅèÔºâ

    function showNextRank() {
        if (currentIndex >= ranksToShow.length) return;

        const currentRank = ranksToShow[currentIndex];
        const isLastRank = currentIndex === ranksToShow.length - 1;

        // „É©„É≥„ÇØË¶ÅÁ¥†„Çí‰ΩúÊàê„Åó„Å¶„Çπ„É©„Ç§„Éâ„Ç§„É≥
        rankContainer.innerHTML = `<span class="score-rank-item slide-in">${currentRank}</span>`;
        rankElement.className = `score-rank rank-${currentRank}`;

        if (isLastRank) {
            // ÊúÄÁµÇ„É©„É≥„ÇØÔºöÁ¢∫ÂÆö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            setTimeout(() => {
                const item = rankContainer.querySelector('.score-rank-item');
                item.className = 'score-rank-item confirm';

                // „Çπ„Ç≥„Ç¢Ë©≥Á¥∞„ÇíË°®Á§∫
                setTimeout(() => {
                    displayScoreDetails(scoreData);
                }, 300);
            }, slideInDuration);
        } else {
            // ‰∏≠Èñì„É©„É≥„ÇØÔºöË°®Á§∫Âæå„Åô„Åê„Å´„Çπ„É©„Ç§„Éâ„Ç¢„Ç¶„Éà„Åó„ÄÅÈÄ£Á∂öÁöÑ„Å´Ê¨°„ÇíË°®Á§∫
            setTimeout(() => {
                const item = rankContainer.querySelector('.score-rank-item');
                item.className = 'score-rank-item slide-out';

                // „Çπ„É©„Ç§„Éâ„Ç¢„Ç¶„Éà„ÅåÂßã„Åæ„Å£„Åü„Çâ„Åô„Åê„Å´Ê¨°„ÅÆ„É©„É≥„ÇØ„ÇíÊ∫ñÂÇôÔºàÈÄ£Á∂öÁöÑ„Å™Âãï„ÅçÔºâ
                setTimeout(() => {
                    currentIndex++;
                    showNextRank();
                }, transitionDelay);
            }, slideInDuration + displayDuration);
        }
    }

    showNextRank();
}

// „Çπ„Ç≥„Ç¢Ë©≥Á¥∞„ÇíË°®Á§∫
function displayScoreDetails(scoreData) {
    const detailsElement = document.getElementById('scoreDetails');

    detailsElement.innerHTML = `
        <div class="score-detail-item">
            <span class="score-detail-label">Á∑èÂêà„Çπ„Ç≥„Ç¢</span>
            <span class="score-detail-value">${scoreData.score.toFixed(1)}ÁÇπ / 100ÁÇπ</span>
        </div>
        <div class="score-detail-item">
            <span class="score-detail-label">ÂÆüË≥™ÈÇÑÂÖÉÁéáÔºàÂ£≤‰∏äÂéü‰æ°ÁéáÔºâ</span>
            <span class="score-detail-value">${scoreData.realReturnRate.toFixed(1)}%</span>
        </div>
        <div class="score-detail-item">
            <span class="score-detail-label">ÊôØÂìÅÂΩìÈÅ∏ËÄÖÊï∞</span>
            <span class="score-detail-value">${scoreData.prizeCount}‰∫∫</span>
        </div>
        <div class="score-detail-item">
            <span class="score-detail-label">„Ç™„É™„ÉëÊèê‰æõ‰æ°ÂÄ§</span>
            <span class="score-detail-value">¬•${scoreData.totalValue.toLocaleString()}</span>
        </div>
        <div class="score-detail-item">
            <span class="score-detail-label">Á∑èÂè£Êï∞</span>
            <span class="score-detail-value">${scoreData.totalPacks}Âè£</span>
        </div>
    `;
}

// „ÇØ„É©„ÉÉ„Ç´„Éº„Ç®„Éï„Çß„ÇØ„Éà - Ëá™ÁÑ∂„Å™Êï£„Çâ„Å∞„Çä
function showConfetti() {
    const modal = document.querySelector('.score-modal-content');
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#FF1493', '#00CED1', '#FFD700', '#FF69B4'];

    // Â∑¶ÂÅ¥„Åã„Çâ40ÂÄã„ÄÅÂè≥ÂÅ¥„Åã„Çâ40ÂÄã„ÅÆÁ¥ôÂêπÈõ™
    const totalConfetti = 80;

    for (let i = 0; i < totalConfetti; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';

            const isLeft = i < totalConfetti / 2;

            // Áô∫Â∞Ñ‰ΩçÁΩÆ„ÅÆË®≠ÂÆö
            if (isLeft) {
                confetti.style.left = '10px';
            } else {
                confetti.style.right = '10px';
            }

            // ÂûÇÁõ¥‰ΩçÁΩÆÔºà‰∏≠Â§Æ‰ªòËøë„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´Ôºâ
            confetti.style.top = (40 + Math.random() * 20) + '%';

            // „É©„É≥„ÉÄ„É†„Å™ÁßªÂãïË∑ùÈõ¢„Å®ËßíÂ∫¶„ÇíË®àÁÆó
            const angle = isLeft
                ? (Math.random() * 80 - 10) // Â∑¶„Åã„Çâ: -10Â∫¶„Äú70Â∫¶
                : (Math.random() * 80 + 110); // Âè≥„Åã„Çâ: 110Â∫¶„Äú190Â∫¶

            const distance = 150 + Math.random() * 200; // 150px„Äú350px
            const angleRad = (angle * Math.PI) / 180;

            const tx = Math.cos(angleRad) * distance;
            const ty = Math.sin(angleRad) * distance;

            // CSSÂ§âÊï∞„Å´ÂÄ§„ÇíË®≠ÂÆö
            confetti.style.setProperty('--tx', `${tx}px`);
            confetti.style.setProperty('--ty', `${ty}px`);
            confetti.style.setProperty('--rot', `${Math.random() * 720 - 360}deg`); // -360„Äú360Â∫¶
            confetti.style.setProperty('--duration', `${0.8 + Math.random() * 0.8}s`); // 0.8„Äú1.6Áßí

            // „É©„É≥„ÉÄ„É†„Å™Ëâ≤
            confetti.style.background = colors[Math.floor(Math.random() * colors.length)];

            // „É©„É≥„ÉÄ„É†„Å™ÈÅÖÂª∂
            confetti.style.animationDelay = Math.random() * 0.15 + 's';

            modal.appendChild(confetti);

            setTimeout(() => {
                confetti.remove();
            }, 2000);
        }, i * 12);
    }
}

</script>

<!-- „Çπ„Ç≥„Ç¢Ë©ï‰æ°„É¢„Éº„ÉÄ„É´ -->
<div id="scoreModal" onclick="event.target === this && closeScoreModal()">
    <div class="score-modal-content">
        <span class="score-close" onclick="closeScoreModal()">&times;</span>
        <h2 class="score-title">üéØ „Ç™„É™„Éë„Çπ„Ç≥„Ç¢Ê∏¨ÂÆö</h2>

        <div class="score-gauge-container">
            <div class="score-rank" id="scoreRank">
                <div class="score-rank-container" id="scoreRankContainer">
                    <!-- „Çπ„Ç≥„Ç¢„É©„É≥„ÇØ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                </div>
            </div>
        </div>

        <div class="score-details" id="scoreDetails">
            <!-- „Çπ„Ç≥„Ç¢Ë©≥Á¥∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
        </div>
    </div>
</div>

</body>
</html>
