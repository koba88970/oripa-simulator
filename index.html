<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ªãƒªãƒ‘è¨­è¨ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ v1.0</title>
    <style>
        :root {
            --sf-blue: #007AFF;
            --sf-orange: #FF9500;
            --sf-green: #34C759;
            --sf-red: #FF3B30;
            --sf-purple: #AF52DE;
            --sf-gray: #8E8E93;
            --sf-gray-2: #AEAEB2;
            --sf-gray-3: #C7C7CC;
            --sf-gray-4: #D1D1D6;
            --sf-gray-5: #E5E5EA;
            --sf-gray-6: #F2F2F7;
            --sf-white: #FFFFFF;
            --sf-black: #000000;
            --shadow-light: 0 2px 20px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.15);
            --border-radius: 16px;
            --border-radius-small: 12px;
            --transition: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #F2F2F7 0%, #FFFFFF 100%);
            min-height: 100vh;
            letter-spacing: -0.01em;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            color: var(--sf-black);
            text-align: center;
            margin-bottom: 32px;
            font-size: 2.2em;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .version-badge {
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 16px;
            vertical-align: middle;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 32px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--sf-gray-5);
            box-shadow: var(--shadow-light);
            transition: all 0.3s var(--transition);
        }

        .panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .panel h2 {
            margin: 0 0 20px 0;
            color: var(--sf-black);
            border-bottom: 2px solid var(--sf-blue);
            padding-bottom: 12px;
            font-size: 1.3em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--sf-black);
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            font-size: 15px;
            font-weight: 400;
            background: var(--sf-white);
            transition: all 0.3s var(--transition);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--sf-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-group input.error {
            border-color: var(--sf-red);
            background-color: rgba(255, 59, 48, 0.05);
        }

        .form-group input.error:focus {
            border-color: var(--sf-red);
            box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.1);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .calculated-value {
            background: rgba(52, 199, 89, 0.1);
            color: var(--sf-green);
            padding: 12px 16px;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(52, 199, 89, 0.3);
        }

        .prize-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .prize-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            padding: 16px;
            position: relative;
            transition: all 0.3s var(--transition);
        }

        .prize-item:hover {
            border-color: var(--sf-blue);
            transform: translateY(-1px);
        }

        .prize-rank {
            position: absolute;
            top: -8px;
            left: 12px;
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .prize-rank.rank-1 { background: #FFD700; color: var(--sf-black); }
        .prize-rank.rank-2 { background: #C0C0C0; color: var(--sf-black); }
        .prize-rank.rank-3 { background: #CD7F32; color: var(--sf-white); }
        .prize-rank.rank-4 { background: var(--sf-green); }
        .prize-rank.rank-5 { background: var(--sf-purple); }

        .prize-content {
            margin-top: 8px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .prize-name {
            font-weight: 500;
            color: var(--sf-black);
        }

        .prize-value, .prize-count, .prize-purchase {
            font-size: 12px;
            color: var(--sf-gray);
            text-align: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius-small);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--transition);
        }

        .btn-primary {
            background: var(--sf-blue);
            color: var(--sf-white);
        }

        .btn-primary:hover {
            background: #0051D5;
            transform: scale(1.05);
        }

        .btn-danger {
            background: var(--sf-red);
            color: var(--sf-white);
        }

        .btn-danger:hover {
            background: #E6342A;
            transform: scale(1.05);
        }

        .btn-success {
            background: var(--sf-green);
            color: var(--sf-white);
            width: 100%;
            padding: 12px;
            font-size: 14px;
            margin-top: 16px;
        }

        .btn-success:hover {
            background: #248A3D;
        }
        .btn-accent {
            background: var(--sf-orange);
            color: var(--sf-white);
        }
        .btn-accent:hover {
            background: #E6742A;
            transform: scale(1.05);
        }
        
        /* ã‚¬ãƒãƒ£ä½“é¨“ã‚¹ã‚¿ã‚¤ãƒ« */
        .gacha-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .gacha-btn {
            flex: 1;
            min-width: 120px;
            font-weight: 600;
        }
        .gacha-results {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--sf-gray-4);
            border-radius: var(--border-radius-small);
            padding: 20px;
            margin-top: 20px;
        }
        .gacha-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .gacha-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 8px;
        }
        .gacha-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--sf-blue);
        }
        .gacha-stat-label {
            font-size: 0.9em;
            color: var(--sf-gray);
        }
        .gacha-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .gacha-draw-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        .gacha-draw-prize {
            background: linear-gradient(135deg, #34C759, #30D158);
            color: white;
        }
        .gacha-draw-loss {
            background: linear-gradient(135deg, #FF9500, #FF9F0A);
            color: white;
        }

        .add-prize-form {
            background: rgba(0, 122, 255, 0.05);
            border: 1px dashed var(--sf-blue);
            border-radius: var(--border-radius-small);
            padding: 20px;
            margin-top: 16px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .result-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--sf-gray-5);
            box-shadow: var(--shadow-light);
            transition: all 0.3s var(--transition);
        }

        .result-panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .result-panel h3 {
            margin: 0 0 16px 0;
            color: var(--sf-black);
            border-bottom: 2px solid var(--sf-green);
            padding-bottom: 8px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--sf-gray-5);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: var(--sf-black);
        }

        .result-value {
            color: var(--sf-gray);
            font-weight: 600;
        }

        .highlight {
            background: rgba(255, 149, 0, 0.15);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 149, 0, 0.3);
            color: var(--sf-orange);
            font-weight: 600;
        }

        .loss-panel {
            background: rgba(255, 149, 0, 0.08);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        .loss-panel h3 {
            border-bottom-color: var(--sf-orange);
        }

        .expected-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .ev-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 8px;
            font-size: 12px;
        }

        .ev-count {
            font-weight: 600;
            color: var(--sf-blue);
        }

        .ev-value {
            color: var(--sf-gray);
            font-size: 11px;
        }

        .warning {
            background: rgba(255, 59, 48, 0.1);
            color: var(--sf-red);
            padding: 16px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 59, 48, 0.2);
            margin-top: 24px;
            font-size: 14px;
        }

        /* ãƒ—ãƒªã‚»ãƒƒãƒˆã‚ªãƒªãƒ‘ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .preset-section label {
            transition: all 0.2s var(--transition);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
        }

        .preset-section label:hover {
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--sf-blue);
        }

        .preset-section input[type="radio"]:checked + span {
            color: var(--sf-blue);
            font-weight: 600;
        }

        .preset-section input[type="radio"]:checked {
            accent-color: var(--sf-blue);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s var(--transition);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--sf-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s var(--transition);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--sf-gray-5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 600;
            color: var(--sf-black);
        }

        .modal-close {
            font-size: 32px;
            color: var(--sf-gray);
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s var(--transition);
        }

        .modal-close:hover {
            color: var(--sf-red);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--sf-gray-5);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-footer .btn {
            min-width: 100px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ã‚ªãƒªãƒ‘è¨­è¨ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ <span class="version-badge">v1.0</span></h1>
        
        <div class="main-grid">
            <div class="left-panel">
                <!-- åŸºæœ¬è¨­å®š -->
                <div class="panel">
                    <h2>åŸºæœ¬è¨­å®š</h2>
                    <div class="form-group">
                        <label>ãƒ‘ãƒƒã‚¯å˜ä¾¡ (å††)</label>
                        <input type="number" id="packPrice" value="40000">
                    </div>
                    <div class="form-group">
                        <label>ç·å£æ•°</label>
                        <input type="number" id="totalPacks" value="100">
                    </div>
                    <div class="form-group">
                        <label>ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤</label>
                        <div class="calculated-value" id="totalValue">Â¥0</div>
                    </div>

                    <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®š -->
                    <div class="preset-section" style="margin-top: 20px; padding: 16px; background: rgba(0, 122, 255, 0.05); border: 1px solid var(--sf-blue); border-radius: var(--border-radius-small);">
                        <label style="display: block; font-weight: 600; color: var(--sf-black); margin-bottom: 12px; font-size: 14px;">
                            âš¡ ãƒ—ãƒªã‚»ãƒƒãƒˆã‚ªãƒªãƒ‘
                        </label>
                        <div id="presetList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                            <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                        </div>
                        <button class="btn btn-success" onclick="openAddPresetModal()" style="width: 100%; font-size: 12px; padding: 8px; margin-bottom: 8px;">
                            â• æ–°è¦ãƒ—ãƒªã‚»ãƒƒãƒˆè¿½åŠ 
                        </button>
                        <button class="btn btn-primary" onclick="applyPreset()" style="width: 100%; font-size: 13px; padding: 10px;">
                            âš¡ ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰è¨ˆç®—
                        </button>
                    </div>

                    <button class="btn btn-success" onclick="calculate()" style="width: 100%; margin-top: 16px; font-size: 16px; padding: 14px;">
                        ğŸ§® è¨ˆç®—ã™ã‚‹
                    </button>
                </div>

                <!-- ãƒã‚ºãƒ¬ç®¡ç† -->
                <div class="panel">
                    <h2>ãƒã‚ºãƒ¬ç®¡ç†</h2>
                    <p style="color: var(--sf-gray); font-size: 13px; margin-bottom: 16px;">
                        ãƒã‚ºãƒ¬ã‚’æ‰‹å‹•ã§è¨­å®šã—ãªã„å ´åˆã€æœ€ä½ä¿è¨¼ä¾¡å€¤ã§è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™
                    </p>
                    <div class="form-group">
                        <label>è‡ªå‹•è¨ˆç®—ç”¨ï¼šæœ€ä½ä¿è¨¼ä¾¡å€¤ (å††)</label>
                        <input type="number" id="minGuaranteeValue" value="1" min="1" step="1">
                    </div>

                    <div class="prize-list" id="lossList" style="margin-top: 16px;">
                        <!-- ãƒã‚ºãƒ¬ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>

                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>ãƒã‚ºãƒ¬å</label>
                            <input type="text" id="lossName" placeholder="ä¾‹: ãƒã‚ºãƒ¬A">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ä¾¡å€¤ (å††)</label>
                                <input type="number" id="lossValue" placeholder="100" min="1">
                            </div>
                            <div class="form-group">
                                <label>æšæ•°</label>
                                <input type="number" id="lossCount" min="1" value="1">
                            </div>
                        </div>
                        <button class="btn btn-success" id="addLossBtn" onclick="addLoss()">ãƒã‚ºãƒ¬ã‚’è¿½åŠ </button>
                        <button class="btn btn-success" id="updateLossBtn" onclick="updateLoss()" style="display: none;">ãƒã‚ºãƒ¬ã‚’æ›´æ–°</button>
                        <button class="btn btn-danger" id="cancelEditLossBtn" onclick="cancelEditLoss()" style="display: none; margin-top: 8px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>

                <!-- æ™¯å“ç®¡ç† -->
                <div class="panel">
                    <h2>æ™¯å“ç®¡ç†</h2>
                    <div class="prize-list" id="prizeList">
                        <!-- æ™¯å“ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                    
                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>æ™¯å“å</label>
                            <input type="text" id="prizeName" placeholder="ä¾‹: ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰">
                        </div>
                        <div class="form-group">
                            <label>ç­‰ç´š</label>
                            <select id="prizeRank" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                                <option value="1">1ç­‰</option>
                                <option value="2">2ç­‰</option>
                                <option value="3">3ç­‰</option>
                                <option value="4">4ç­‰</option>
                                <option value="5">5ç­‰</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ä»•å…¥ã‚Œä¾¡æ ¼</label>
                                <input type="text" id="prizePurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this)">
                            </div>
                            <div class="form-group">
                                <label>ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒä¾¡å€¤</label>
                                <input type="text" id="prizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>åœ¨åº«æ•°</label>
                            <input type="number" id="prizeCount" min="1" value="1">
                        </div>
                        <button class="btn btn-success" id="addPrizeBtn" onclick="addPrize()">æ™¯å“ã‚’è¿½åŠ </button>
                        <button class="btn btn-success" id="updatePrizeBtn" onclick="updatePrize()" style="display: none;">æ™¯å“ã‚’æ›´æ–°</button>
                        <button class="btn btn-danger" id="cancelEditBtn" onclick="cancelEdit()" style="display: none; margin-top: 8px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>

                <!-- ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šç®¡ç† -->
                <div class="panel" style="background: rgba(0, 122, 255, 0.05); border-color: var(--sf-blue);">
                    <h2 style="border-bottom-color: var(--sf-blue);">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šå…±æœ‰</h2>

                    <!-- ä¿å­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="form-group">
                        <label>è¨­å®šå</label>
                        <input type="text" id="cloudConfigName" placeholder="è¨­å®šåã‚’å…¥åŠ›ï¼ˆä¾‹: ãƒã‚±ãƒ¢ãƒ³ã‚ªãƒªãƒ‘Aæ¡ˆï¼‰">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="saveToCloudWithName()" style="font-size: 12px;">
                            ğŸ’¾ æ–°è¦ä¿å­˜
                        </button>
                        <button class="btn btn-accent" onclick="updateCloudConfig()" style="font-size: 12px;" id="updateCloudBtn" disabled>
                            ğŸ”„ ä¸Šæ›¸ãæ›´æ–°
                        </button>
                    </div>

                    <!-- èª­ã¿è¾¼ã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="form-group">
                        <label>ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šä¸€è¦§</label>
                        <select id="cloudConfigList" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                            <option value="">è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-success" onclick="loadSelectedCloudConfig()" style="font-size: 12px;">
                            ğŸ“‚ èª­ã¿è¾¼ã¿
                        </button>
                        <button class="btn btn-danger" onclick="deleteSelectedCloudConfig()" style="font-size: 12px;">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                    </div>

                    <button class="btn btn-primary" onclick="refreshCloudConfigList()" style="width: 100%; font-size: 12px;">
                        ğŸ”„ ä¸€è¦§ã‚’æ›´æ–°
                    </button>

                    <!-- å…±æœ‰ãƒªãƒ³ã‚¯ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--sf-gray-5);">
                        <label style="display: block; font-weight: 500; color: var(--sf-black); margin-bottom: 8px; font-size: 14px;">
                            ğŸ”— ãƒªãƒ³ã‚¯å…±æœ‰
                        </label>
                        <button class="btn btn-accent" onclick="generateShareLink()" style="width: 100%; font-size: 12px;" id="shareBtn" disabled>
                            ğŸ“‹ å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
                        </button>
                        <div id="shareStatus" style="margin-top: 8px; font-size: 11px; color: var(--sf-gray); text-align: center;"></div>
                    </div>

                    <div id="cloudStatus" style="margin-top: 12px; font-size: 12px; color: var(--sf-gray);"></div>
                </div>
            </div>

            <div class="results-grid">
                <!-- ã‚µãƒãƒªãƒ¼ -->
                <div class="result-panel">
                    <h3>ã‚µãƒãƒªãƒ¼</h3>
                    <div class="result-row">
                        <span class="result-label">ç·é‚„å…ƒç‡</span>
                        <span class="result-value" id="summaryTotalReturn">98.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">å®Ÿè³ªé‚„å…ƒç‡</span>
                        <span class="result-value highlight" id="summaryRealReturn">0.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ç·å½“é¸è€…æ•°</span>
                        <span class="result-value" id="summaryWinnerCount">0äºº</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ç·ä»•å…¥ã‚Œé¡</span>
                        <span class="result-value" id="summaryTotalPurchase">Â¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">å½“ãŸã‚Šæ™¯å“é‚„å…ƒç·é¡</span>
                        <span class="result-value" id="summaryPrizeTotalReward">Â¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ãƒã‚ºãƒ¬é‚„å…ƒç·é¡</span>
                        <span class="result-value" id="summaryLossTotalReward">Â¥0</span>
                    </div>
                </div>

                <!-- æ™¯å“è©³ç´° -->
                <div class="result-panel">
                    <h3>æ™¯å“è©³ç´°</h3>
                    <div id="prizeDetails">
                        <p style="color: var(--sf-gray); text-align: center;">æ™¯å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>

                <!-- ãƒã‚ºãƒ¬è©³ç´° -->
                <div class="result-panel loss-panel">
                    <h3>ãƒã‚ºãƒ¬è©³ç´°ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</h3>
                    <div id="lossDetailsContainer">
                        <!-- ãƒã‚ºãƒ¬è©³ç´°ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                    <div class="result-row">
                        <span class="result-label">ãƒã‚ºãƒ¬ç·æšæ•°</span>
                        <span class="result-value" id="totalLossCount">0æš</span>
                    </div>
                </div>

                <!-- ãƒã‚ºãƒ¬å½“é¸è€…åˆ†å¸ƒ -->
                <div class="result-panel">
                    <h3>ãƒã‚ºãƒ¬å½“é¸è€…åˆ†å¸ƒ</h3>
                    <div class="chart-container">
                        <canvas id="lossDistributionChart" width="400" height="200"></canvas>
                    </div>
                </div>




                <!-- ã‚¬ãƒãƒ£ä½“é¨“ -->
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <h3>ğŸ® ã‚¬ãƒãƒ£ä½“é¨“</h3>
                    <p style="color: var(--sf-gray); font-size: 14px; margin-bottom: 20px;">
                        å®Ÿéš›ã«ã‚ªãƒªãƒ‘ã‚’å¼•ã„ã¦ã€è¨­è¨ˆã—ãŸã‚¬ãƒãƒ£ã®ä½“é¨“ã‚’ç¢ºèªã§ãã¾ã™
                    </p>
                    
                    <!-- ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³ -->
                    <div class="gacha-controls">
                        <button class="btn btn-primary gacha-btn" onclick="drawGacha(1)">
                            ğŸ² 1å›å¼•ã
                        </button>
                        <button class="btn btn-secondary gacha-btn" onclick="drawGacha(10)">
                            ğŸ² 10å›å¼•ã
                        </button>
                        <button class="btn btn-accent gacha-btn" onclick="drawGacha(100)">
                            ğŸ² 100å›å¼•ã
                        </button>
                        <button class="btn btn-danger gacha-btn" onclick="resetGacha()" id="resetGachaBtn" style="display: none;">
                            ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
                        </button>
                    </div>
                    
                    <!-- ã‚¬ãƒãƒ£çµæœ -->
                    <div id="gachaResults" class="gacha-results" style="display: none;">
                        <h4>ã‚¬ãƒãƒ£çµæœ</h4>
                        <div id="gachaStats" class="gacha-stats"></div>
                        <div id="gachaHistory" class="gacha-history"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="warnings"></div>
    </div>

    <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="presetModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ç·¨é›†</h2>
                <span class="modal-close" onclick="closePresetModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ãƒ—ãƒªã‚»ãƒƒãƒˆå</label>
                    <input type="text" id="modalPresetName" placeholder="ä¾‹: ã‚«ã‚¹ã‚¿ãƒ 500">
                </div>
                <div class="form-group">
                    <label>å€ç‡ï¼ˆä½•åˆ†ã®1ã§å½“ãŸã‚‹ã‹ï¼‰</label>
                    <input type="number" id="modalMultiplier" placeholder="ä¾‹: 500" min="1">
                </div>
                <div class="form-group">
                    <label>ãƒ‘ãƒƒã‚¯å˜ä¾¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰</label>
                    <input type="number" id="modalPackPrice" placeholder="ä¾‹: 10" min="1">
                </div>
                <div class="form-group">
                    <label>ãƒã‚ºãƒ¬ä¾¡å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰</label>
                    <input type="number" id="modalMinGuarantee" placeholder="ä¾‹: 1" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="savePreset()">ä¿å­˜</button>
                <button class="btn btn-danger" onclick="closePresetModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let prizes = [];
        let losses = []; // ãƒã‚ºãƒ¬ãƒªã‚¹ãƒˆ
        let editingPrizeId = null; // ç·¨é›†ä¸­ã®æ™¯å“ID
        let editingLossId = null; // ç·¨é›†ä¸­ã®ãƒã‚ºãƒ¬ID

        // ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†
        let presets = [];
        let editingPresetId = null; // ç·¨é›†ä¸­ã®ãƒ—ãƒªã‚»ãƒƒãƒˆID

        // åˆæœŸãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆåˆå›ã®ã¿ä½¿ç”¨ï¼‰
        const INITIAL_PRESETS = [
            {
                id: 'preset_319',
                name: '319',
                multiplier: 319,
                packPrice: 13,
                minGuaranteeValue: 1
            },
            {
                id: 'preset_198',
                name: '198',
                multiplier: 198,
                packPrice: 39,
                minGuaranteeValue: 1
            },
            {
                id: 'preset_nibuchi',
                name: 'ãƒ‹ãƒ–ã‚¤ãƒ',
                multiplier: 2,
                packPrice: 350,
                minGuaranteeValue: 1
            }
        ];

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
        const STORAGE_KEY = 'oripa_simulator_v2';
        const PRESETS_STORAGE_KEY = 'oripa_presets_v1';

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadPresetsFromStorage(); // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿
            attachEventListeners();
            updateTotalValue();
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function attachEventListeners() {
            // ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ã¿
            document.getElementById('packPrice').addEventListener('input', updateTotalValue);
            document.getElementById('totalPacks').addEventListener('input', updateTotalValue);
            // ä»–ã®é …ç›®ã¯æ‰‹å‹•è¨ˆç®—ã«å¤‰æ›´
        }

        // ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤ã®æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ãªã—ï¼‰
        function updateTotalValue() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalValue = packPrice * totalPacks;
            document.getElementById('totalValue').textContent = `Â¥${totalValue.toLocaleString()}`;

            // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå…¥åŠ›ä¸­ã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã—ãªã„ï¼‰
            document.getElementById('packPrice').classList.remove('error');
            document.getElementById('totalPacks').classList.remove('error');
        }

        // ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒä¾¡å€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatPrizeValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // æ•°å­—ä»¥å¤–ã‚’é™¤å»
            if (value) {
                value = parseInt(value).toLocaleString(); // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«å¤‰æ›
            }
            input.value = value;
        }

        // åŸºæœ¬è¨­å®šå€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatBasicValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // æ•°å­—ä»¥å¤–ã‚’é™¤å»
            if (value) {
                value = parseInt(value).toLocaleString(); // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«å¤‰æ›
            }
            input.value = value;
            // ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤ã®ã¿æ›´æ–°
            setTimeout(updateTotalValue, 100);
        }

        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ•°å­—ã‚’æ•°å€¤ã«å¤‰æ›
        function parseFormattedNumber(value) {
            return parseFloat(value.replace(/,/g, '')) || 0;
        }

        // æ™¯å“è¿½åŠ 
        function addPrize() {
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯è¿½åŠ ã—ãªã„
            if (editingPrizeId) {
                alert('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚å…ˆã«ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã¾ãŸã¯ã€Œæ™¯å“ã‚’æ›´æ–°ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const purchasePrice = parseFormattedNumber(document.getElementById('prizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || purchasePrice <= 0 || value <= 0 || count <= 0) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const prize = {
                id: Date.now(),
                name: name,
                rank: rank,
                purchasePrice: purchasePrice,
                value: value,
                count: count
            };

            prizes.push(prize);

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('prizeName').value = '';
            document.getElementById('prizePurchasePrice').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';

            updatePrizeList();
            saveData();
        }

        // æ™¯å“å‰Šé™¤
        function removePrize(id) {
            prizes = prizes.filter(p => p.id !== id);
            updatePrizeList();
            saveData();
        }

        // æ™¯å“ç·¨é›†
        function editPrize(id) {
            const prize = prizes.find(p => p.id === id);
            if (!prize) return;

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('prizeName').value = prize.name;
            document.getElementById('prizeRank').value = prize.rank;
            document.getElementById('prizePurchasePrice').value = prize.purchasePrice.toLocaleString();
            document.getElementById('prizeValue').value = prize.value.toLocaleString();
            document.getElementById('prizeCount').value = prize.count;

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
            editingPrizeId = id;

            // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('addPrizeBtn').style.display = 'none';
            document.getElementById('updatePrizeBtn').style.display = 'inline-block';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // ãƒ•ã‚©ãƒ¼ãƒ ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('prizeName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // æ™¯å“æ›´æ–°
        function updatePrize() {
            if (!editingPrizeId) return;

            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const purchasePrice = parseFormattedNumber(document.getElementById('prizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || purchasePrice <= 0 || value <= 0 || count <= 0) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // æ™¯å“ã‚’æ›´æ–°
            const prizeIndex = prizes.findIndex(p => p.id === editingPrizeId);
            if (prizeIndex !== -1) {
                prizes[prizeIndex] = {
                    id: editingPrizeId,
                    name: name,
                    rank: rank,
                    purchasePrice: purchasePrice,
                    value: value,
                    count: count
                };
            }

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
            cancelEdit();

            updatePrizeList();
            saveData();
        }

        // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelEdit() {
            editingPrizeId = null;

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('prizeName').value = '';
            document.getElementById('prizePurchasePrice').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';

            // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’å…ƒã«æˆ»ã™
            document.getElementById('addPrizeBtn').style.display = 'inline-block';
            document.getElementById('updatePrizeBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // æ™¯å“ãƒªã‚¹ãƒˆæ›´æ–°
        function updatePrizeList() {
            const container = document.getElementById('prizeList');

            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">æ™¯å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }

            // ç­‰ç´šé †ã«ã‚½ãƒ¼ãƒˆ
            prizes.sort((a, b) => a.rank - b.rank);

            container.innerHTML = prizes.map(prize => `
                <div class="prize-item">
                    <div class="prize-rank rank-${prize.rank}">${prize.rank}ç­‰</div>
                    <div class="prize-content">
                        <div class="prize-name">${prize.name}</div>
                        <div class="prize-purchase">ä»•å…¥Â¥${prize.purchasePrice.toLocaleString()}</div>
                        <div class="prize-value">é‚„å…ƒÂ¥${prize.value.toLocaleString()}</div>
                        <div class="prize-count">${prize.count}æš</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="editPrize(${prize.id})">ç·¨é›†</button>
                            <button class="btn btn-danger" onclick="removePrize(${prize.id})">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ========== çŸ›ç›¾ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•° ==========

        function showConflictError(errorData) {
            let message = '';
            let suggestions = '';

            if (errorData.type === 'count_overflow') {
                message = `âš ï¸ æšæ•°ãŒåˆã„ã¾ã›ã‚“\n\n` +
                    `æ™¯å“æšæ•°ï¼š${errorData.prizesTotalCount}æš\n` +
                    `ãƒã‚ºãƒ¬æšæ•°ï¼š${errorData.manualLossTotalCount}æš\n` +
                    `åˆè¨ˆï¼š${errorData.prizesTotalCount + errorData.manualLossTotalCount}æš\n\n` +
                    `ç·å£æ•°ï¼š${errorData.totalPacks}å£\n` +
                    `è¶…éæšæ•°ï¼š${errorData.excess}æš\n\n`;

                suggestions = `ğŸ“‹ ä»£æ›¿æ¡ˆï¼š\n\n` +
                    `1ï¸âƒ£ ç·å£æ•°ã‚’${errorData.prizesTotalCount + errorData.manualLossTotalCount}å£ã«å¢—ã‚„ã™\n\n` +
                    `2ï¸âƒ£ ãƒã‚ºãƒ¬æšæ•°ã‚’${errorData.excess}æšæ¸›ã‚‰ã™\n\n` +
                    `3ï¸âƒ£ æ™¯å“æšæ•°ã‚’${errorData.excess}æšæ¸›ã‚‰ã™`;

            } else if (errorData.type === 'count_shortage') {
                message = `âš ï¸ æšæ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™\n\n` +
                    `æ™¯å“æšæ•°ï¼š${errorData.prizesTotalCount}æš\n` +
                    `ãƒã‚ºãƒ¬æšæ•°ï¼š${errorData.manualLossTotalCount}æš\n` +
                    `åˆè¨ˆï¼š${errorData.prizesTotalCount + errorData.manualLossTotalCount}æš\n\n` +
                    `ç·å£æ•°ï¼š${errorData.totalPacks}å£\n` +
                    `ä¸è¶³æšæ•°ï¼š${errorData.shortage}æš\n\n`;

                suggestions = `ğŸ“‹ ä»£æ›¿æ¡ˆï¼š\n\n` +
                    `1ï¸âƒ£ ç·å£æ•°ã‚’${errorData.prizesTotalCount + errorData.manualLossTotalCount}å£ã«æ¸›ã‚‰ã™\n\n` +
                    `2ï¸âƒ£ ãƒã‚ºãƒ¬æšæ•°ã‚’${errorData.shortage}æšå¢—ã‚„ã™\n\n` +
                    `3ï¸âƒ£ æ™¯å“æšæ•°ã‚’${errorData.shortage}æšå¢—ã‚„ã™\n\n` +
                    `4ï¸âƒ£ ãƒã‚ºãƒ¬ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦è‡ªå‹•è¨ˆç®—ã«åˆ‡ã‚Šæ›¿ãˆã‚‹`;
            }

            alert(message + suggestions);
        }

        // ========== ãƒã‚ºãƒ¬ç®¡ç†é–¢æ•° ==========

        // ãƒã‚ºãƒ¬è¿½åŠ 
        function addLoss() {
            if (editingLossId) {
                alert('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚å…ˆã«ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã¾ãŸã¯ã€Œãƒã‚ºãƒ¬ã‚’æ›´æ–°ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const name = document.getElementById('lossName').value.trim();
            const value = parseInt(document.getElementById('lossValue').value) || 0;
            const count = parseInt(document.getElementById('lossCount').value) || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const loss = {
                id: Date.now(),
                name: name,
                value: value,
                count: count
            };

            losses.push(loss);

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('lossName').value = '';
            document.getElementById('lossValue').value = '';
            document.getElementById('lossCount').value = '1';

            updateLossList();
            saveData();
        }

        // ãƒã‚ºãƒ¬å‰Šé™¤
        function removeLoss(id) {
            losses = losses.filter(l => l.id !== id);
            updateLossList();
            saveData();
        }

        // ãƒã‚ºãƒ¬ç·¨é›†
        function editLoss(id) {
            const loss = losses.find(l => l.id === id);
            if (!loss) return;

            document.getElementById('lossName').value = loss.name;
            document.getElementById('lossValue').value = loss.value;
            document.getElementById('lossCount').value = loss.count;

            editingLossId = id;

            document.getElementById('addLossBtn').style.display = 'none';
            document.getElementById('updateLossBtn').style.display = 'inline-block';
            document.getElementById('cancelEditLossBtn').style.display = 'inline-block';

            document.getElementById('lossName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ãƒã‚ºãƒ¬æ›´æ–°
        function updateLoss() {
            if (!editingLossId) return;

            const name = document.getElementById('lossName').value.trim();
            const value = parseInt(document.getElementById('lossValue').value) || 0;
            const count = parseInt(document.getElementById('lossCount').value) || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const lossIndex = losses.findIndex(l => l.id === editingLossId);
            if (lossIndex !== -1) {
                losses[lossIndex] = {
                    id: editingLossId,
                    name: name,
                    value: value,
                    count: count
                };
            }

            cancelEditLoss();
            updateLossList();
            saveData();
        }

        // ãƒã‚ºãƒ¬ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelEditLoss() {
            editingLossId = null;

            document.getElementById('lossName').value = '';
            document.getElementById('lossValue').value = '';
            document.getElementById('lossCount').value = '1';

            document.getElementById('addLossBtn').style.display = 'inline-block';
            document.getElementById('updateLossBtn').style.display = 'none';
            document.getElementById('cancelEditLossBtn').style.display = 'none';
        }

        // ========== ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†æ©Ÿèƒ½ ==========

        // ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã‚’æ›´æ–°
        function updatePresetList() {
            const container = document.getElementById('presetList');

            if (presets.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 12px 0; font-size: 13px;">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }

            container.innerHTML = presets.map(preset => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 8px; border: 1px solid var(--sf-gray-4);">
                    <label style="flex: 1; cursor: pointer; margin: 0; display: flex; align-items: center;">
                        <input type="radio" name="preset" value="${preset.id}" style="margin-right: 8px;">
                        <span style="font-size: 13px; font-weight: 500;">${preset.name}</span>
                        <span style="font-size: 11px; color: var(--sf-gray); margin-left: 8px;">(${preset.multiplier}åˆ†ã®1)</span>
                    </label>
                    <button class="btn btn-primary" onclick="openEditPresetModal('${preset.id}')" style="font-size: 11px; padding: 4px 8px;">ç·¨é›†</button>
                    <button class="btn btn-danger" onclick="deletePreset('${preset.id}')" style="font-size: 11px; padding: 4px 8px;">å‰Šé™¤</button>
                </div>
            `).join('');
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openAddPresetModal() {
            editingPresetId = null;
            document.getElementById('modalTitle').textContent = 'æ–°è¦ãƒ—ãƒªã‚»ãƒƒãƒˆè¿½åŠ ';
            document.getElementById('modalPresetName').value = '';
            document.getElementById('modalMultiplier').value = '';
            document.getElementById('modalPackPrice').value = '';
            document.getElementById('modalMinGuarantee').value = '1';
            document.getElementById('presetModal').style.display = 'flex';
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEditPresetModal(presetId) {
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;

            editingPresetId = presetId;
            document.getElementById('modalTitle').textContent = 'ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ç·¨é›†';
            document.getElementById('modalPresetName').value = preset.name;
            document.getElementById('modalMultiplier').value = preset.multiplier;
            document.getElementById('modalPackPrice').value = preset.packPrice;
            document.getElementById('modalMinGuarantee').value = preset.minGuaranteeValue;
            document.getElementById('presetModal').style.display = 'flex';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closePresetModal() {
            document.getElementById('presetModal').style.display = 'none';
            editingPresetId = null;
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜
        function savePreset() {
            const name = document.getElementById('modalPresetName').value.trim();
            const multiplier = parseInt(document.getElementById('modalMultiplier').value) || 0;
            const packPrice = parseInt(document.getElementById('modalPackPrice').value) || 0;
            const minGuaranteeValue = parseInt(document.getElementById('modalMinGuarantee').value) || 1;

            if (!name || multiplier <= 0 || packPrice <= 0 || minGuaranteeValue <= 0) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (editingPresetId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                const presetIndex = presets.findIndex(p => p.id === editingPresetId);
                if (presetIndex !== -1) {
                    presets[presetIndex] = {
                        id: editingPresetId,
                        name: name,
                        multiplier: multiplier,
                        packPrice: packPrice,
                        minGuaranteeValue: minGuaranteeValue
                    };
                }
            } else {
                // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                const newPreset = {
                    id: 'preset_' + Date.now(),
                    name: name,
                    multiplier: multiplier,
                    packPrice: packPrice,
                    minGuaranteeValue: minGuaranteeValue
                };
                presets.push(newPreset);
            }

            savePresetsToStorage();
            savePresetsToFirebase();
            updatePresetList();
            closePresetModal();
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤
        function deletePreset(presetId) {
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;

            if (!confirm(`ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${preset.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            presets = presets.filter(p => p.id !== presetId);
            savePresetsToStorage();
            savePresetsToFirebase();
            updatePresetList();
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’LocalStorageã«ä¿å­˜
        function savePresetsToStorage() {
            try {
                localStorage.setItem(PRESETS_STORAGE_KEY, JSON.stringify(presets));
            } catch (e) {
                console.error('ãƒ—ãƒªã‚»ãƒƒãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
            }
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿
        function loadPresetsFromStorage() {
            try {
                const savedPresets = localStorage.getItem(PRESETS_STORAGE_KEY);
                if (savedPresets) {
                    presets = JSON.parse(savedPresets);
                } else {
                    // åˆå›èµ·å‹•æ™‚ã¯åˆæœŸãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½¿ç”¨
                    presets = [...INITIAL_PRESETS];
                    savePresetsToStorage();
                }
                updatePresetList();
            } catch (e) {
                console.error('ãƒ—ãƒªã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                presets = [...INITIAL_PRESETS];
                updatePresetList();
            }
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’Firebaseã«ä¿å­˜
        function savePresetsToFirebase() {
            database.ref('presets').set({
                data: presets,
                updatedAt: Date.now()
            }).then(() => {
                console.log('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’Firebaseã«ä¿å­˜ã—ã¾ã—ãŸ');
            }).catch((error) => {
                console.error('Firebaseã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            });
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’Firebaseã‹ã‚‰èª­ã¿è¾¼ã¿
        function loadPresetsFromFirebase() {
            database.ref('presets').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data && data.data) {
                    presets = data.data;
                    savePresetsToStorage();
                    updatePresetList();
                    console.log('Firebaseã‹ã‚‰ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                }
            }).catch((error) => {
                console.error('Firebaseã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            });
        }

        // ãƒã‚ºãƒ¬ãƒªã‚¹ãƒˆæ›´æ–°
        function updateLossList() {
            const container = document.getElementById('lossList');

            if (losses.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">ãƒã‚ºãƒ¬ã‚’è¿½åŠ ã™ã‚‹ã¨æ‰‹å‹•è¨­å®šã§ãã¾ã™</p>';
                return;
            }

            container.innerHTML = losses.map(loss => `
                <div class="prize-item" style="background: rgba(255, 149, 0, 0.1); border-color: var(--sf-orange);">
                    <div class="prize-content" style="grid-template-columns: 2fr 1fr 1fr auto; margin-top: 8px;">
                        <div class="prize-name">${loss.name}</div>
                        <div class="prize-value">Â¥${loss.value.toLocaleString()}</div>
                        <div class="prize-count">${loss.count}æš</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="editLoss(${loss.id})">ç·¨é›†</button>
                            <button class="btn btn-danger" onclick="removeLoss(${loss.id})">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // å€¤ã‚’10ã®ä½ã§ä¸¸ã‚ã‚‹ï¼ˆ1æ¡ã‚’0ã«ã™ã‚‹ï¼‰
        function roundToTens(value) {
            return Math.round(value / 10) * 10;
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚ªãƒªãƒ‘ã‚’é©ç”¨
        function applyPreset() {
            // é¸æŠã•ã‚ŒãŸãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å–å¾—
            const selectedPresetRadio = document.querySelector('input[name="preset"]:checked');

            if (!selectedPresetRadio) {
                alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // æ™¯å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (prizes.length === 0) {
                alert('å…ˆã«æ™¯å“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„');
                return;
            }

            const presetId = selectedPresetRadio.value;

            // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’æ¤œç´¢
            const preset = presets.find(p => p.id === presetId);
            if (!preset) {
                alert('ãƒ—ãƒªã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }

            // æ™¯å“ã®ç·æšæ•°ã‚’è¨ˆç®—
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // ç·å£æ•°ã‚’è¨ˆç®—
            const totalPacks = prizesTotalCount * preset.multiplier;

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('packPrice').value = preset.packPrice;
            document.getElementById('totalPacks').value = totalPacks;
            document.getElementById('minGuaranteeValue').value = preset.minGuaranteeValue;

            // ãƒã‚ºãƒ¬ã‚’ã‚¯ãƒªã‚¢ï¼ˆè‡ªå‹•è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹ï¼‰
            losses = [];
            updateLossList();

            // ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤ã‚’æ›´æ–°
            updateTotalValue();

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveData();

            // è‡ªå‹•ã§è¨ˆç®—ã‚’å®Ÿè¡Œ
            calculate();

            // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const lossCount = totalPacks - prizesTotalCount;
            alert(`ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${preset.name}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ\n\nç·å£æ•°: ${totalPacks}å£\nãƒ‘ãƒƒã‚¯å˜ä¾¡: Â¥${preset.packPrice.toLocaleString()}\næ™¯å“æšæ•°: ${prizesTotalCount}æš\nãƒã‚ºãƒ¬æšæ•°: ${lossCount}æš\n\nå€¤ã‚’ç·¨é›†ã—ã¦å†è¨ˆç®—ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚`);
        }

        // ã‚¬ãƒãƒ£é›£æ˜“åº¦è¨­å®šã‚’å–å¾—
        function getDifficultySettings(difficulty) {
            switch(difficulty) {
                case 'easy':
                    return {
                        name: 'æ¯”è¼ƒçš„å½“ãŸã‚Šã‚„ã™ã„',
                        description: 'ãƒã‚ºãƒ¬ã®ä¾¡å€¤ãŒé«˜ã‚ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªè¨­è¨ˆ',
                        lossDistribution: [0.4, 0.35, 0.25], // é«˜é‚„å…ƒé‡è¦–
                        maxValueCap: 0.8 // ãƒ‘ãƒƒã‚¯å˜ä¾¡ã®80%ã¾ã§
                    };
                case 'hard':
                    return {
                        name: 'å½“ãŸã‚Šã«ãã„',
                        description: 'ãƒã‚ºãƒ¬ã®ä¾¡å€¤ãŒä½ã‚ã§ã€å¤§å½“ãŸã‚Šé‡è¦–ã®è¨­è¨ˆ',
                        lossDistribution: [0.15, 0.35, 0.5], // ä½é‚„å…ƒé‡è¦–
                        maxValueCap: 0.5 // ãƒ‘ãƒƒã‚¯å˜ä¾¡ã®50%ã¾ã§
                    };
                default: // normal
                    return {
                        name: 'æ™®é€š',
                        description: 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„æ¨™æº–çš„ãªè¨­è¨ˆ',
                        lossDistribution: [0.2, 0.5, 0.3], // ãƒãƒ©ãƒ³ã‚¹é‡è¦–
                        maxValueCap: 0.7 // ãƒ‘ãƒƒã‚¯å˜ä¾¡ã®70%ã¾ã§
                    };
            }
        }

        // ãƒ¡ã‚¤ãƒ³è¨ˆç®—
        function calculate() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;

            if (packPrice <= 0 || totalPacks <= 0) {
                return;
            }

            // åŸºæœ¬è¨ˆç®—
            const totalValue = packPrice * totalPacks;

            // ã‚ªãƒªãƒ‘æä¾›ä¾¡å€¤è¡¨ç¤º
            document.getElementById('totalValue').textContent = `Â¥${totalValue.toLocaleString()}`;

            // æ™¯å“ç·ä¾¡å€¤è¨ˆç®—ï¼ˆãƒã‚¤ãƒ³ãƒˆé‚„å…ƒä¾¡å€¤ï¼‰
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // æ™¯å“ç·ä»•å…¥ã‚Œä¾¡æ ¼è¨ˆç®—
            const prizesTotalPurchasePrice = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);

            // å®Ÿè³ªé‚„å…ƒç‡è¨ˆç®—ï¼ˆä»•å…¥ã‚Œä¾¡æ ¼ãƒ™ãƒ¼ã‚¹ï¼‰
            const realReturnRate = totalValue > 0 ? (prizesTotalPurchasePrice / totalValue) * 100 : 0;

            // ãƒã‚ºãƒ¬è¨ˆç®—ï¼ˆæ‰‹å‹•è¨­å®š or è‡ªå‹•è¨ˆç®—ï¼‰
            const remainingSlots = totalPacks - prizesTotalCount;
            let lossTypes = [];

            // æ‰‹å‹•ã§ãƒã‚ºãƒ¬ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if (losses.length > 0) {
                const manualLossTotalCount = losses.reduce((sum, loss) => sum + loss.count, 0);

                // çŸ›ç›¾ãƒã‚§ãƒƒã‚¯1: æ™¯å“æšæ•° + æ‰‹å‹•ãƒã‚ºãƒ¬æšæ•° > ç·å£æ•°
                if (prizesTotalCount + manualLossTotalCount > totalPacks) {
                    showConflictError({
                        type: 'count_overflow',
                        prizesTotalCount,
                        manualLossTotalCount,
                        totalPacks,
                        excess: (prizesTotalCount + manualLossTotalCount) - totalPacks
                    });
                    return;
                }

                // çŸ›ç›¾ãƒã‚§ãƒƒã‚¯2: æ™¯å“æšæ•° + æ‰‹å‹•ãƒã‚ºãƒ¬æšæ•° < ç·å£æ•°
                if (prizesTotalCount + manualLossTotalCount < totalPacks) {
                    showConflictError({
                        type: 'count_shortage',
                        prizesTotalCount,
                        manualLossTotalCount,
                        totalPacks,
                        shortage: totalPacks - (prizesTotalCount + manualLossTotalCount)
                    });
                    return;
                }

                // æ‰‹å‹•ãƒã‚ºãƒ¬ã‚’lossTypesã«å¤‰æ›
                lossTypes = losses.map(loss => ({
                    name: loss.name,
                    value: loss.value,
                    count: loss.count,
                    type: 'manual'
                }));

            } else {
                // è‡ªå‹•è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰
                if (remainingSlots <= 0) {
                    if (!validateSettings()) {
                        return;
                    }
                }

                if (remainingSlots > 0) {
                    // æœ€ä½ä¿è¨¼ä¾¡å€¤ã§è‡ªå‹•è¨ˆç®—
                    const adjustedMinValue = Math.max(1, Math.round(minGuaranteeValue));

                    lossTypes.push({
                        name: `ãƒã‚ºãƒ¬ï¼ˆæœ€ä½ä¿è¨¼ï¼‰`,
                        value: adjustedMinValue,
                        count: remainingSlots,
                        type: 'auto'
                    });
                }
            }

            // æœŸå¾…å€¤è¨ˆç®—
            let expectedValue = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (prize.value * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                expectedValue += loss.value * probability;
            });

            // æ¨™æº–åå·®è¨ˆç®—
            let variance = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (Math.pow(prize.value - expectedValue, 2) * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                variance += Math.pow(loss.value - expectedValue, 2) * probability;
            });

            const stdDev = Math.sqrt(variance);

            // ç·é‚„å…ƒç‡ã‚’è¨ˆç®—ï¼ˆæ™¯å“ + ãƒã‚ºãƒ¬ã®åˆè¨ˆã‹ã‚‰ç®—å‡ºï¼‰
            const lossTotalValue = lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0);
            const actualTotalReturnValue = prizesTotalValue + lossTotalValue;
            const totalReturnRatePercent = totalValue > 0 ? (actualTotalReturnValue / totalValue) * 100 : 0;

            // çµæœè¡¨ç¤ºæ›´æ–°
            updateResults({
                totalReturnRatePercent,
                realReturnRate,
                expectedValue,
                stdDev,
                lossTypes,
                lossCount,
                totalPacks,
                packPrice
            });
        }

        // çµæœè¡¨ç¤ºæ›´æ–°
        function updateResults(data) {
            document.getElementById('summaryTotalReturn').textContent = `${data.totalReturnRatePercent.toFixed(1)}%`;
            document.getElementById('summaryRealReturn').textContent = `${data.realReturnRate.toFixed(1)}%`;

            // ç·å½“é¸è€…æ•°ã‚’è¡¨ç¤º
            const totalWinners = prizes.reduce((sum, prize) => sum + prize.count, 0);
            document.getElementById('summaryWinnerCount').textContent = `${totalWinners}äºº`;

            // ç·ä»•å…¥ã‚Œé¡ã‚’è¡¨ç¤º
            const totalPurchaseAmount = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);
            document.getElementById('summaryTotalPurchase').textContent = `Â¥${totalPurchaseAmount.toLocaleString()}`;

            // å½“ãŸã‚Šæ™¯å“é‚„å…ƒç·é¡ã‚’è¡¨ç¤º
            const prizeTotalReward = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            document.getElementById('summaryPrizeTotalReward').textContent = `Â¥${prizeTotalReward.toLocaleString()}`;

            // ãƒã‚ºãƒ¬é‚„å…ƒç·é¡ã‚’è¡¨ç¤º
            const lossTotalReward = data.lossTypes ? data.lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0) : 0;
            document.getElementById('summaryLossTotalReward').textContent = `Â¥${lossTotalReward.toLocaleString()}`;

            // æ™¯å“è©³ç´°æ›´æ–°
            updatePrizeDetails();

            // ãƒã‚ºãƒ¬è©³ç´°æ›´æ–°
            updateLossDetails(data.lossTypes, data.lossCount);
            
            // ãƒã‚ºãƒ¬åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            drawLossDistributionChart(data.lossTypes);

            // è­¦å‘Šè¡¨ç¤ºã®æ›´æ–°
            updateWarnings(data);
        }

        // æ™¯å“è©³ç´°æ›´æ–°
        function updatePrizeDetails() {
            const container = document.getElementById('prizeDetails');
            
            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">æ™¯å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }

            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            
            container.innerHTML = prizes.map(prize => {
                const probability = totalPacks > 0 ? (prize.count / totalPacks * 100).toFixed(2) : '0.00';
                return `
                    <div class="result-row">
                        <span class="result-label">${prize.rank}ç­‰ ${prize.name}</span>
                        <span class="result-value">${prize.count}æš / ${probability}% (ä»•å…¥Â¥${prize.purchasePrice.toLocaleString()} / é‚„å…ƒÂ¥${prize.value.toLocaleString()})</span>
                    </div>
                `;
            }).join('');
        }

        // ãƒã‚ºãƒ¬è©³ç´°æ›´æ–°
        function updateLossDetails(lossTypes, lossCount) {
            const container = document.getElementById('lossDetailsContainer');
            
            if (!lossTypes || lossTypes.length === 0) {
                container.innerHTML = '<div class="result-row"><span class="result-label">ãƒã‚ºãƒ¬ãªã—</span><span class="result-value">-</span></div>';
                document.getElementById('totalLossCount').textContent = '0æš';
                return;
            }

            container.innerHTML = lossTypes.map(loss => {
                const probability = lossCount > 0 ? ((loss.count / lossCount) * 100).toFixed(1) : '0.0';
                return `
                    <div class="result-row">
                        <span class="result-label">${loss.name}</span>
                        <span class="result-value">Â¥${loss.value.toLocaleString()} Ã— ${loss.count}æš (${probability}%)</span>
                    </div>
                `;
            }).join('');

            document.getElementById('totalLossCount').textContent = `${lossCount}æš`;
        }



        // ãƒã‚ºãƒ¬å½“é¸è€…åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆæç”»
        function drawLossDistributionChart(lossTypes) {
            const canvas = document.getElementById('lossDistributionChart');
            const ctx = canvas.getContext('2d');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!lossTypes || lossTypes.length === 0) {
                ctx.fillStyle = '#8E8E93';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ãƒã‚ºãƒ¬ãªã—', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const padding = 40;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF'];
            const total = lossTypes.reduce((sum, loss) => sum + loss.count, 0);
            
            if (total === 0) return;
            
            // æ£’ã‚°ãƒ©ãƒ•ã¨ã—ã¦æç”»
            const barWidth = width / lossTypes.length * 0.8;
            const barSpacing = width / lossTypes.length * 0.2;
            const maxCount = Math.max(...lossTypes.map(loss => loss.count));
            
            lossTypes.forEach((loss, index) => {
                const x = padding + index * (barWidth + barSpacing) + barSpacing / 2;
                const barHeight = (loss.count / maxCount) * height;
                const y = canvas.height - padding - barHeight;
                
                // æ£’ã‚’æç”»
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // æšæ•°ã‚’è¡¨ç¤º
                ctx.fillStyle = '#000000';
                ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(loss.count + 'æš', x + barWidth / 2, y - 5);
                
                // åå‰ã‚’è¡¨ç¤º
                ctx.fillText(loss.name, x + barWidth / 2, canvas.height - 10);
                
                // å‰²åˆã‚’è¡¨ç¤º
                const percentage = ((loss.count / total) * 100).toFixed(1);
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(percentage + '%', x + barWidth / 2, y + barHeight / 2);
            });
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ãƒã‚ºãƒ¬å½“é¸è€…åˆ†å¸ƒ', canvas.width / 2, 20);
        }

        // è¨­å®šæ¤œè¨¼ã¨ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function validateSettings() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('totalPacks').classList.remove('error');

            let hasError = false;
            let errorMessages = [];

            // æ™¯å“æšæ•°ãŒç·å£æ•°ã‚’è¶…ãˆã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (prizesTotalCount > totalPacks) {
                document.getElementById('totalPacks').classList.add('error');
                hasError = true;
                errorMessages.push(`æ™¯å“ã®ç·æšæ•°ï¼ˆ${prizesTotalCount}æšï¼‰ãŒç·å£æ•°ï¼ˆ${totalPacks}å£ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
            }

            if (hasError) {
                showErrorPopup(errorMessages);
                return false;
            }

            return true;
        }

        // ã‚¨ãƒ©ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        function showErrorPopup(messages) {
            const errorMessage = messages.join('\n\n');
            alert(`âš ï¸ è¨­å®šã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™\n\n${errorMessage}`);
        }

        // è­¦å‘Šè¡¨ç¤ºæ›´æ–°ï¼ˆè»½å¾®ãªè­¦å‘Šç”¨ï¼‰
        function updateWarnings(data) {
            const warningsContainer = document.getElementById('warnings');
            const warnings = [];

            // å¿…è¦ã«å¿œã˜ã¦è­¦å‘Šã‚’è¿½åŠ ã§ãã¾ã™

            warningsContainer.innerHTML = warnings.join('');
        }



        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆæ™¯å“ã¨ãƒã‚ºãƒ¬ï¼‰
        function saveData() {
            const data = {
                prizes: prizes,
                losses: losses,
                settings: {
                    packPrice: document.getElementById('packPrice').value,
                    totalPacks: document.getElementById('totalPacks').value,
                    minGuaranteeValue: document.getElementById('minGuaranteeValue').value
                }
            };

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæ™¯å“ã¨ãƒã‚ºãƒ¬ï¼‰
        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);

                    if (data.prizes) {
                        prizes = data.prizes;
                        updatePrizeList();
                    }

                    if (data.losses) {
                        losses = data.losses;
                        updateLossList();
                    }

                    if (data.settings) {
                        document.getElementById('packPrice').value = data.settings.packPrice || '40000';
                        document.getElementById('totalPacks').value = data.settings.totalPacks || '100';
                        document.getElementById('minGuaranteeValue').value = data.settings.minGuaranteeValue || '1';
                    }
                }
            } catch (e) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
            }
        }

        // ã‚¬ãƒãƒ£ä½“é¨“æ©Ÿèƒ½
        let gachaDrawHistory = [];
        let gachaPool = [];

        // ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆ
        function generateGachaPool() {
            gachaPool = [];
            
            // æ™¯å“ã‚’è¿½åŠ 
            prizes.forEach(prize => {
                for (let i = 0; i < prize.count; i++) {
                    gachaPool.push({
                        type: 'prize',
                        item: prize
                    });
                }
            });
            
            // ç¾åœ¨ã®è¨­å®šã§ãƒã‚ºãƒ¬ã‚’è¨ˆç®—
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;

            if (totalPacks > 0) {
                const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);
                const remainingSlots = totalPacks - prizesTotalCount;

                console.log('ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆãƒ‡ãƒãƒƒã‚°:', {
                    totalPacks: totalPacks,
                    prizesTotalCount: prizesTotalCount,
                    remainingSlots
                });

                // æ‰‹å‹•ãƒã‚ºãƒ¬ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
                if (losses.length > 0) {
                    losses.forEach(loss => {
                        console.log(`${loss.name} ç”Ÿæˆ:`, { count: loss.count, value: loss.value });
                        for (let j = 0; j < loss.count; j++) {
                            gachaPool.push({
                                type: 'loss',
                                item: {
                                    name: loss.name,
                                    value: loss.value,
                                    rank: 'loss'
                                }
                            });
                        }
                    });
                } else if (remainingSlots > 0) {
                    // è‡ªå‹•è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰
                    const adjustedMinValue = Math.max(1, Math.round(minGuaranteeValue));

                    for (let j = 0; j < remainingSlots; j++) {
                        gachaPool.push({
                            type: 'loss',
                            item: {
                                name: 'ãƒã‚ºãƒ¬ï¼ˆæœ€ä½ä¿è¨¼ï¼‰',
                                value: adjustedMinValue,
                                rank: 'loss'
                            }
                        });
                    }
                } else {
                    console.log('ãƒã‚ºãƒ¬ç”Ÿæˆã‚¹ã‚­ãƒƒãƒ—:', { remainingSlots, reason: 'remainingSlots <= 0' });
                }
            }
            
            // ãƒ—ãƒ¼ãƒ«ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            for (let i = gachaPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gachaPool[i], gachaPool[j]] = [gachaPool[j], gachaPool[i]];
            }
            
            console.log('ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ç”Ÿæˆå®Œäº†:', {
                totalItems: gachaPool.length,
                prizes: gachaPool.filter(item => item.type === 'prize').length,
                losses: gachaPool.filter(item => item.type === 'loss').length,
                expectedTotal: totalPacks
            });

            // æœ€çµ‚çš„ãªã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
            if (gachaPool.length !== totalPacks) {
                console.error('ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼:', {
                    expected: totalPacks,
                    actual: gachaPool.length,
                    difference: gachaPool.length - totalPacks
                });
            }
        }

        // ã‚¬ãƒãƒ£ã‚’å¼•ã
        function drawGacha(count) {
            if (gachaPool.length === 0) {
                alert('å…ˆã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚’ã—ã¦ã‚¬ãƒãƒ£ã®è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ã®ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            if (gachaPool.length !== totalPacks) {
                console.warn('ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚ºãŒè¨­å®šã¨ç•°ãªã‚Šã¾ã™:', {
                    expected: totalPacks,
                    actual: gachaPool.length
                });
            }
            
            if (gachaPool.length < count) {
                alert(`æ®‹ã‚Š${gachaPool.length}æšã—ã‹ã‚ã‚Šã¾ã›ã‚“`);
                count = gachaPool.length;
            }
            
            const draws = [];
            for (let i = 0; i < count; i++) {
                if (gachaPool.length > 0) {
                    const drawnItem = gachaPool.shift();
                    console.log('ã‚¬ãƒãƒ£çµæœ:', drawnItem);
                    draws.push(drawnItem);
                    gachaDrawHistory.push(drawnItem);
                }
            }
            
            updateGachaResults();
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('resetGachaBtn').style.display = 'block';
            document.getElementById('gachaResults').style.display = 'block';
        }

        // ã‚¬ãƒãƒ£çµæœã‚’æ›´æ–°
        function updateGachaResults() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            
            // çµ±è¨ˆè¨ˆç®—
            const totalDraws = gachaDrawHistory.length;
            const prizeCount = gachaDrawHistory.filter(draw => draw.type === 'prize').length;
            const totalValue = gachaDrawHistory.reduce((sum, draw) => sum + draw.item.value, 0);
            const totalCost = totalDraws * packPrice;
            const profit = totalValue - totalCost;
            
            // çµ±è¨ˆè¡¨ç¤º
            document.getElementById('gachaStats').innerHTML = `
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${totalDraws}</div>
                    <div class="gacha-stat-label">ç·å¼•ãå›æ•°</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${prizeCount}</div>
                    <div class="gacha-stat-label">å½“é¸å›æ•°</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">Â¥${totalValue.toLocaleString()}</div>
                    <div class="gacha-stat-label">ç·é‚„å…ƒä¾¡å€¤</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value" style="color: ${profit >= 0 ? 'var(--sf-green)' : 'var(--sf-red)'}">
                        ${profit >= 0 ? '+' : ''}Â¥${profit.toLocaleString()}
                    </div>
                    <div class="gacha-stat-label">åæ”¯</div>
                </div>
            `;
            
            // å±¥æ­´è¡¨ç¤ºï¼ˆæœ€æ–°10ä»¶ï¼‰
            const recentDraws = gachaDrawHistory.slice(-10).reverse();
            document.getElementById('gachaHistory').innerHTML = `
                <h5 style="margin-bottom: 10px;">æœ€æ–°ã®å¼•ãçµæœ</h5>
                ${recentDraws.map(draw => `
                    <div class="gacha-draw-item ${draw.type === 'prize' ? 'gacha-draw-prize' : 'gacha-draw-loss'}">
                        <span>${draw.item.name}</span>
                        <span>Â¥${draw.item.value.toLocaleString()}</span>
                    </div>
                `).join('')}
            `;
        }

        // ã‚¬ãƒãƒ£ãƒªã‚»ãƒƒãƒˆ
        function resetGacha() {
            if (confirm('ã‚¬ãƒãƒ£çµæœã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                gachaDrawHistory = [];
                generateGachaPool();
                document.getElementById('resetGachaBtn').style.display = 'none';
                document.getElementById('gachaResults').style.display = 'none';
            }
        }

        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«ã‚¬ãƒãƒ£ãƒ—ãƒ¼ãƒ«ã‚‚ç”Ÿæˆ
        const originalCalculate = calculate;
        calculate = function() {
            originalCalculate();
            generateGachaPool();
        };
    </script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebaseã®è¨­å®šï¼ˆã“ã“ã«å–å¾—ã—ãŸè¨­å®šã‚’è²¼ã‚Šä»˜ã‘ï¼‰
const firebaseConfig = {
  apiKey: "AIzaSyAe9gDljx8sz-amXm_BWyPJgskR_V1S3Oo",
  authDomain: "oripa-simulator.firebaseapp.com",
  databaseURL: "https://oripa-simulator-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "oripa-simulator",
  storageBucket: "oripa-simulator.firebasestorage.app",
  messagingSenderId: "546810114337",
  appId: "1:546810114337:web:14a0657fd25998bef50e60"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ç¾åœ¨ã®è¨­å®šã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getCurrentConfig() {
  return {
    packPrice: document.getElementById('packPrice').value,
    totalPacks: document.getElementById('totalPacks').value,
    minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
    prizes: [...prizes],
    losses: [...losses]
  };
}

// è¨­å®šã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
function loadConfig(config) {
  document.getElementById('packPrice').value = config.packPrice || '40000';
  document.getElementById('totalPacks').value = config.totalPacks || '100';
  document.getElementById('minGuaranteeValue').value = config.minGuaranteeValue || '1';

  if (config.prizes) {
    prizes = [...config.prizes];
    updatePrizeList();
  }

  if (config.losses) {
    losses = [...config.losses];
    updateLossList();
  }

  updateTotalValue();
}

// ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜æ©Ÿèƒ½
function saveToCloud(configName) {
  const config = getCurrentConfig();
  const configId = configName || prompt('è¨­å®šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (!configId) return;

  database.ref('configs/' + configId).set({
    data: config,
    updatedAt: Date.now()
  }).then(() => {
    alert('ä¿å­˜ã—ã¾ã—ãŸ: ' + configId);
    loadConfigList();
  }).catch((error) => {
    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  });
}

// ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿
function loadFromCloud(configId) {
  database.ref('configs/' + configId).once('value').then((snapshot) => {
    const data = snapshot.val();
    if (data) {
      loadConfig(data.data);
      alert('èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ' + configId);
    } else {
      alert('è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }
  }).catch((error) => {
    alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  });
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šã‚’ç®¡ç†
let cloudConfigs = {};
let currentCloudConfigId = null;

// è¨­å®šä¸€è¦§è¡¨ç¤º
function loadConfigList() {
  database.ref('configs').once('value').then((snapshot) => {
    const configs = snapshot.val();
    console.log('ä¿å­˜æ¸ˆã¿è¨­å®š:', Object.keys(configs || {}));
    // å¿…è¦ã«å¿œã˜ã¦UIè¡¨ç¤º
  });
}

// ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šä¸€è¦§ã‚’æ›´æ–°
function refreshCloudConfigList() {
  updateCloudStatus('è¨­å®šä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');

  database.ref('configs').once('value').then((snapshot) => {
    cloudConfigs = snapshot.val() || {};
    updateCloudConfigSelectBox();
    updateCloudStatus(`${Object.keys(cloudConfigs).length}ä»¶ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
  }).catch((error) => {
    updateCloudStatus('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  });
}

// ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
function updateCloudConfigSelectBox() {
  const selectBox = document.getElementById('cloudConfigList');
  selectBox.innerHTML = '<option value="">è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

  // æœ€çµ‚ä¿å­˜æ—¥ã®æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
  const sortedConfigIds = Object.keys(cloudConfigs).sort((a, b) => {
    const dateA = cloudConfigs[a].updatedAt || 0;
    const dateB = cloudConfigs[b].updatedAt || 0;
    return dateB - dateA; // é™é †ï¼ˆæ–°ã—ã„é †ï¼‰
  });

  sortedConfigIds.forEach(configId => {
    const config = cloudConfigs[configId];
    const date = new Date(config.updatedAt).toLocaleString('ja-JP');
    const option = document.createElement('option');
    option.value = configId;
    option.textContent = `${configId} (${date})`;
    selectBox.appendChild(option);
  });

  // ç¾åœ¨é¸æŠä¸­ã®è¨­å®šãŒã‚ã‚Œã°é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒ
  if (currentCloudConfigId && cloudConfigs[currentCloudConfigId]) {
    selectBox.value = currentCloudConfigId;
    document.getElementById('updateCloudBtn').disabled = false;
  } else {
    document.getElementById('updateCloudBtn').disabled = true;
  }
}

// ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
function updateCloudStatus(message) {
  document.getElementById('cloudStatus').textContent = message;
  setTimeout(() => {
    document.getElementById('cloudStatus').textContent = '';
  }, 3000);
}

// æ–°è¦ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜
function saveToCloudWithName() {
  const configName = document.getElementById('cloudConfigName').value.trim();
  if (!configName) {
    alert('è¨­å®šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  // åŒåã®è¨­å®šãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (cloudConfigs[configName]) {
    if (!confirm(`ã€Œ${configName}ã€ã¨ã„ã†è¨­å®šãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
      return;
    }
  }

  const config = getCurrentConfig();
  updateCloudStatus('ä¿å­˜ä¸­...');

  database.ref('configs/' + configName).set({
    data: config,
    updatedAt: Date.now(),
    createdBy: 'user', // å°†æ¥çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚’è¿½åŠ ã™ã‚‹å ´åˆ
    version: '1.0'
  }).then(() => {
    currentCloudConfigId = configName;
    document.getElementById('updateCloudBtn').disabled = false;
    updateCloudStatus(`ã€Œ${configName}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
    refreshCloudConfigList();
    document.getElementById('cloudConfigName').value = '';
  }).catch((error) => {
    updateCloudStatus('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  });
}

// ç¾åœ¨ã®è¨­å®šã‚’ä¸Šæ›¸ãæ›´æ–°
function updateCloudConfig() {
  if (!currentCloudConfigId) {
    alert('æ›´æ–°ã™ã‚‹è¨­å®šãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }

  if (!confirm(`ã€Œ${currentCloudConfigId}ã€ã‚’ç¾åœ¨ã®è¨­å®šã§ä¸Šæ›¸ãæ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ`)) {
    return;
  }

  const config = getCurrentConfig();
  updateCloudStatus('æ›´æ–°ä¸­...');

  database.ref('configs/' + currentCloudConfigId).update({
    data: config,
    updatedAt: Date.now()
  }).then(() => {
    updateCloudStatus(`ã€Œ${currentCloudConfigId}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
    refreshCloudConfigList();
  }).catch((error) => {
    updateCloudStatus('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  });
}

// é¸æŠã•ã‚ŒãŸã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
function loadSelectedCloudConfig() {
  const selectedConfigId = document.getElementById('cloudConfigList').value;
  if (!selectedConfigId) {
    alert('èª­ã¿è¾¼ã‚€è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }

  updateCloudStatus('èª­ã¿è¾¼ã¿ä¸­...');

  database.ref('configs/' + selectedConfigId).once('value').then((snapshot) => {
    const configData = snapshot.val();
    if (configData && configData.data) {
      loadConfig(configData.data);
      currentCloudConfigId = selectedConfigId;
      document.getElementById('updateCloudBtn').disabled = false;
      document.getElementById('cloudConfigName').value = selectedConfigId;
      updateCloudStatus(`ã€Œ${selectedConfigId}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
    } else {
      updateCloudStatus('è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }
  }).catch((error) => {
    updateCloudStatus('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  });
}

// é¸æŠã•ã‚ŒãŸã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šã‚’å‰Šé™¤
function deleteSelectedCloudConfig() {
  const selectedConfigId = document.getElementById('cloudConfigList').value;
  if (!selectedConfigId) {
    alert('å‰Šé™¤ã™ã‚‹è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }

  if (!confirm(`ã€Œ${selectedConfigId}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
    return;
  }

  updateCloudStatus('å‰Šé™¤ä¸­...');

  database.ref('configs/' + selectedConfigId).remove().then(() => {
    if (currentCloudConfigId === selectedConfigId) {
      currentCloudConfigId = null;
      document.getElementById('updateCloudBtn').disabled = true;
      document.getElementById('cloudConfigName').value = '';
    }
    updateCloudStatus(`ã€Œ${selectedConfigId}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    refreshCloudConfigList();
  }).catch((error) => {
    updateCloudStatus('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  });
}

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰è¨­å®šIDã‚’å–å¾—
function getConfigIdFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('config');
}

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã•ã‚ŒãŸè¨­å®šã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
function loadConfigFromURL() {
  const configId = getConfigIdFromURL();
  if (!configId) return;

  updateCloudStatus(`å…±æœ‰è¨­å®šã€Œ${configId}ã€ã‚’èª­ã¿è¾¼ã¿ä¸­...`);

  database.ref('configs/' + configId).once('value').then((snapshot) => {
    const configData = snapshot.val();
    if (configData && configData.data) {
      loadConfig(configData.data);
      currentCloudConfigId = configId;
      document.getElementById('updateCloudBtn').disabled = false;
      document.getElementById('cloudConfigName').value = configId;

      // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®é¸æŠçŠ¶æ…‹ã‚‚æ›´æ–°
      const selectBox = document.getElementById('cloudConfigList');
      if (selectBox) {
        selectBox.value = configId;
      }

      updateCloudStatus(`å…±æœ‰è¨­å®šã€Œ${configId}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);

      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      setTimeout(() => {
        alert(`ğŸ”— å…±æœ‰ã•ã‚ŒãŸè¨­å®šã€Œ${configId}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼\n\nè¨­å®šã‚’ç·¨é›†ã—ã¦ã€Œä¸Šæ›¸ãæ›´æ–°ã€ã™ã‚‹ã¨ã€å…ƒã®è¨­å®šã«åæ˜ ã•ã‚Œã¾ã™ã€‚\nã€Œåˆ¥åä¿å­˜ã€ã§æ–°ã—ã„è¨­å®šã¨ã—ã¦ä¿å­˜ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚`);
      }, 500);
    } else {
      updateCloudStatus(`å…±æœ‰è¨­å®šã€Œ${configId}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
      alert(`âŒ å…±æœ‰è¨­å®šã€Œ${configId}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nè¨­å®šãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ã€è¨­å®šåãŒæ­£ã—ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
    }
  }).catch((error) => {
    updateCloudStatus('å…±æœ‰è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    alert(`âŒ å…±æœ‰è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
  });
}

// å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ã¦ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
function generateShareLink() {
  if (!currentCloudConfigId) {
    alert('å…±æœ‰ã™ã‚‹è¨­å®šã‚’é¸æŠã¾ãŸã¯ä¿å­˜ã—ã¦ãã ã•ã„');
    return;
  }

  const baseUrl = window.location.origin + window.location.pathname;
  const shareUrl = `${baseUrl}?config=${encodeURIComponent(currentCloudConfigId)}`;

  // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
  navigator.clipboard.writeText(shareUrl).then(() => {
    updateShareStatus('âœ… ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');

    // æˆåŠŸãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
    showCopySuccessPopup(shareUrl);
  }).catch(() => {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    showShareLinkModal(shareUrl);
  });
}

// ã‚³ãƒ”ãƒ¼æˆåŠŸãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
function showCopySuccessPopup(shareUrl) {
  // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒã‚ã‚Œã°å‰Šé™¤
  const existingPopup = document.getElementById('copySuccessPopup');
  if (existingPopup) {
    document.body.removeChild(existingPopup);
  }

  const popup = document.createElement('div');
  popup.id = 'copySuccessPopup';
  popup.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #34C759, #30D158);
    color: white;
    padding: 20px 24px;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(52, 199, 89, 0.3);
    z-index: 10000;
    transform: translateX(400px);
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    max-width: 350px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    backdrop-filter: blur(20px);
  `;

  popup.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
      <div style="font-size: 24px;">âœ…</div>
      <div style="font-size: 16px; font-weight: 600;">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>
    </div>
    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">
      ã€Œ${currentCloudConfigId}ã€ã®å…±æœ‰ãƒªãƒ³ã‚¯ãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸ
    </div>
    <div style="font-size: 11px; opacity: 0.8; word-break: break-all; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px;">
      ${shareUrl}
    </div>
    <div style="position: absolute; top: 8px; right: 8px; cursor: pointer; font-size: 18px; opacity: 0.7; hover: opacity: 1;" onclick="document.body.removeChild(this.parentElement)">
      Ã—
    </div>
  `;

  document.body.appendChild(popup);

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³
  setTimeout(() => {
    popup.style.transform = 'translateX(0)';
  }, 50);

  // 4ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
  setTimeout(() => {
    if (popup.parentElement) {
      popup.style.transform = 'translateX(400px)';
      setTimeout(() => {
        if (popup.parentElement) {
          document.body.removeChild(popup);
        }
      }, 300);
    }
  }, 4000);

  // ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  popup.onclick = (e) => {
    if (e.target.tagName !== 'DIV') return;
    popup.style.transform = 'translateX(400px)';
    setTimeout(() => {
      if (popup.parentElement) {
        document.body.removeChild(popup);
      }
    }, 300);
  };
}

// å…±æœ‰ãƒªãƒ³ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒä½¿ãˆãªã„å ´åˆï¼‰
function showShareLinkModal(shareUrl) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

  modal.innerHTML = `
    <div style="background: white; padding: 32px; border-radius: 16px; max-width: 500px; width: 90%;">
      <h3 style="margin: 0 0 16px 0;">ğŸ”— å…±æœ‰ãƒªãƒ³ã‚¯</h3>
      <p style="margin: 0 0 16px 0; color: #666;">ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãã ã•ã„ï¼š</p>
      <input type="text" value="${shareUrl}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 16px;" readonly onclick="this.select()">
      <div style="display: flex; gap: 12px;">
        <button onclick="copyFromModal('${shareUrl}', this)" style="flex: 1; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer;">
          ğŸ“‹ ã‚³ãƒ”ãƒ¼
        </button>
        <button onclick="document.body.removeChild(this.closest('div[style*=\"fixed\"]'))" style="flex: 1; padding: 12px; background: #8E8E93; color: white; border: none; border-radius: 8px; cursor: pointer;">
          é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  `;

  modal.onclick = (e) => {
    if (e.target === modal) document.body.removeChild(modal);
  };

  document.body.appendChild(modal);
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã®ã‚³ãƒ”ãƒ¼å‡¦ç†
function copyFromModal(shareUrl, buttonElement) {
  navigator.clipboard.writeText(shareUrl).then(() => {
    // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸€æ™‚çš„ã«å¤‰æ›´
    const originalText = buttonElement.textContent;
    buttonElement.textContent = 'âœ… ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
    buttonElement.style.background = '#34C759';

    setTimeout(() => {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      const modal = buttonElement.closest('div[style*="fixed"]');
      if (modal) {
        document.body.removeChild(modal);
      }

      // æˆåŠŸãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
      showCopySuccessPopup(shareUrl);
    }, 800);
  }).catch(() => {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
    const input = buttonElement.closest('div').previousElementSibling;
    input.select();
    input.setSelectionRange(0, 99999);

    buttonElement.textContent = 'âš ï¸ æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼';
    setTimeout(() => {
      buttonElement.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
    }, 2000);
  });
}

// å…±æœ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
function updateShareStatus(message) {
  document.getElementById('shareStatus').textContent = message;
  setTimeout(() => {
    document.getElementById('shareStatus').textContent = '';
  }, 3000);
}

// å…±æœ‰ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
function updateShareButtonState() {
  const shareBtn = document.getElementById('shareBtn');
  if (currentCloudConfigId) {
    shareBtn.disabled = false;
    shareBtn.textContent = `ğŸ“‹ ã€Œ${currentCloudConfigId}ã€ã®ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼`;
  } else {
    shareBtn.disabled = true;
    shareBtn.textContent = 'ğŸ“‹ å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼';
  }
}

// æ—¢å­˜ã®é–¢æ•°ã‚’æ‹¡å¼µï¼šè¨­å®šä¿å­˜ãƒ»èª­ã¿è¾¼ã¿æ™‚ã«å…±æœ‰ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
const originalSaveToCloudWithName = saveToCloudWithName;
saveToCloudWithName = function() {
  const result = originalSaveToCloudWithName.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

const originalLoadSelectedCloudConfig = loadSelectedCloudConfig;
loadSelectedCloudConfig = function() {
  const result = originalLoadSelectedCloudConfig.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

const originalLoadConfigFromURL = loadConfigFromURL;
loadConfigFromURL = function() {
  const result = originalLoadConfigFromURL.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

// åˆæœŸåŒ–æ™‚ã«ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
document.addEventListener('DOMContentLoaded', function() {
  // æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†ã®å¾Œã«è¿½åŠ 
  setTimeout(() => {
    refreshCloudConfigList();
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§è¨­å®šãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è‡ªå‹•èª­ã¿è¾¼ã¿
    loadConfigFromURL();
    // å…±æœ‰ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    updateShareButtonState();
  }, 1000); // Firebaseã®åˆæœŸåŒ–ã‚’å¾…ã¤
});
</script>
</body>
</html>
