# 【重要】オリパ保存エラーの完全解決手順

## 🚨 エラーが出る場合の対処法

設定名に関するエラーが出る場合、以下の手順で**必ず**解決します。

---

## 📋 手順1: ブラウザの完全リロード（最重要！）

**まずこれを実行してください：**

### Mac:
```
Cmd + Shift + R
```

### Windows:
```
Ctrl + Shift + R
```

または、ブラウザを完全に閉じて、再度 `start-server.command` / `start-server.bat` から起動してください。

**⚠️ 重要:** 通常のリロード（Cmd+R / Ctrl+R）では、キャッシュがクリアされません！

---

## 📋 手順2: Firebaseルールの確認

Firebaseルールに **`temporaryPrizeMaster`** が含まれているか確認してください。

### ✅ 正しいルール:

```json
{
  "rules": {
    "configs": {
      ".read": true,
      ".write": true
    },
    "prizeMaster": {
      ".read": true,
      ".write": true
    },
    "temporaryPrizeMaster": {
      ".read": true,
      ".write": true
    },
    "oripas": {
      ".read": true,
      ".write": true
    }
  }
}
```

### または、すべて許可（開発用・最もシンプル）:

```json
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
```

### 設定方法:

1. [Firebase Console](https://console.firebase.google.com/) を開く
2. **Realtime Database** → **ルール** タブ
3. 上記のルールをコピー＆ペースト
4. **「公開」ボタンをクリック**

---

## 📋 手順3: 設定名の入力ルール

### ✅ 使える文字:

- 日本語（ひらがな、カタカナ、漢字）
- 英数字
- スペース
- アンダースコア `_`
- ハイフン `-`
- 丸括弧 `( )`

### ❌ 使えない文字:

以下の文字は**自動的に置換**されますが、使わないことを推奨します：

- `.` → `_`
- `#` → `_`
- `$` → `_`
- `[` → `(`
- `]` → `)`
- `/` → `_`

### 良い例:

```
✅ ポケモンオリパA案
✅ 1_9賞金総額
✅ (仮) テスト用オリパ
✅ oripa-test-001
```

### 悪い例:

```
❌ 1.9賞金総額  → 1_9賞金総額 に自動変換
❌ (仮) 1/1.9 賞金総 → (仮) 1_1_9 賞金総 に自動変換
❌ テスト#1 → テスト_1 に自動変換
```

---

## 📋 手順4: 新しい機能の使い方

### リアルタイムサニタイズ

設定名を入力すると、**使えない文字を入力した瞬間に自動変換**されます。

**例:**
1. `1.9賞金` と入力
2. → 自動的に `1_9賞金` に変換される
3. 画面に警告メッセージが表示される：
   ```
   ⚠️ 使用できない文字（. # $ [ ] /）を自動変換しています
   ```

### 保存時の確認ダイアログ

不正な文字が含まれていた場合、保存前に確認ダイアログが表示されます：

```
設定名に使用できない文字が含まれていたため、以下のように変更されます：

変更前: 1.9賞金総額
変更後: 1_9賞金総額

この名前で保存しますか？
```

---

## 🎯 完全な保存手順

### 1. ブラウザをリロード
```
Cmd + Shift + R (Mac) / Ctrl + Shift + R (Windows)
```

### 2. Firebaseルールを確認
- `temporaryPrizeMaster` が含まれているか確認
- なければ追加して「公開」

### 3. オリパを作成
- 仮装景品を追加
- 計算を実行

### 4. 設定名を入力
- **使える文字のみ**で入力
- 自動変換される場合は警告が表示される

### 5. 保存ボタンをクリック
- 「💾 新規保存」をクリック
- 確認ダイアログが出た場合は内容を確認して「OK」

### 6. 成功を確認
- コンソール（F12キー）で以下が表示される：
  ```
  ✅ 「設定名」を保存しました
  ```

---

## 🔍 トラブルシューティング

### エラー: `child failed: path argument was an invalid path`

**原因:** 設定名に使えない文字が含まれている

**解決策:**
1. ブラウザを **Cmd+Shift+R** で完全リロード
2. 設定名を **使える文字のみ** で入力し直す
3. 自動変換機能が有効になっていることを確認

### エラー: `permission_denied`

**原因:** Firebaseルールに `temporaryPrizeMaster` がない

**解決策:**
1. Firebase Console でルールを確認
2. `temporaryPrizeMaster` を追加
3. 「公開」ボタンをクリック

### エラー: `ガチャプールサイズエラー`

**原因:** 景品とハズレの合計が総口数と一致していない

**解決策:**
1. 「💡 手動ハズレと最低保証を併用する」にチェック
2. 「🧮 計算する」をクリック
3. コンソールで `totalItems` と `expectedTotal` が一致することを確認

---

## ✅ チェックリスト

以下をすべて確認してください：

- [ ] ブラウザを **Cmd+Shift+R** / **Ctrl+Shift+R** で完全リロードした
- [ ] Firebaseルールに `temporaryPrizeMaster` が含まれている
- [ ] Firebaseルールを「公開」した
- [ ] ローカルサーバー経由で起動している（`http://localhost:8000`）
- [ ] 設定名に **使える文字のみ** を使用している
- [ ] コンソール（F12キー）でエラーがないか確認した

すべてにチェックが入れば、**必ず保存できます**。

---

## 💡 それでも解決しない場合

1. ブラウザを**完全に閉じる**
2. `start-server.command` / `start-server.bat` を**再起動**
3. ブラウザで `http://localhost:8000` を開く
4. コンソール（F12キー）を開いて、赤いエラーメッセージをすべて確認

それでも問題が続く場合は、コンソールのエラーメッセージ全文を確認してください。
