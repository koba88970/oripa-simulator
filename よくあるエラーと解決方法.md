# よくあるエラーと解決方法

## 🚨 エラー1: Invalid path "configs//○○"

### エラー内容
```
Uncaught Error: child failed: path argument was an invalid path = "configs//1.9 賞金総"
Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"
```

### 原因
クラウド保存時の設定名に、Firebaseで使用できない特殊文字が含まれています。

**使用できない文字:**
- `.` (ドット)
- `#` (ハッシュ)
- `$` (ドル記号)
- `[` `]` (角括弧)
- `/` (スラッシュ)

### 解決方法

**✅ 自動修正されます！**

最新版では、設定名に不正な文字が含まれていても**自動的にサニタイズ**されます：

- `.` → `_` (アンダースコア)
- `#` → `_`
- `$` → `_`
- `[` → `(` (丸括弧)
- `]` → `)`
- `/` → `_`

**例:**
- 入力: `1.9 賞金総`
- 保存: `1_9 賞金総`

コンソールに以下のように表示されます：
```
⚠️ 設定名をサニタイズしました: "1.9 賞金総" → "1_9 賞金総"
💡 Firebaseパスで使用できない文字（. # $ [ ] /）を置換しました
```

### 推奨設定名

以下の文字のみ使用することを推奨します：
- ✅ 日本語（ひらがな、カタカナ、漢字）
- ✅ 英数字
- ✅ スペース
- ✅ アンダースコア `_`
- ✅ ハイフン `-`

## 🚨 エラー2: ガチャプールサイズエラー

### エラー内容
```
ガチャプールサイズエラー: {
  expected: 300,
  actual: 101,
  difference: -199
}
```

### 原因
景品とハズレの合計数が、総口数と一致していません。

**よくあるケース:**
- 総口数: 300
- 景品: 1個
- 手動ハズレ: 100個
- **合計: 101個** ← 199個不足！

### 解決方法

#### 方法1: 手動ハズレと最低保証を併用する（推奨）

1. **「💡 手動ハズレと最低保証を併用する」にチェック**を入れる
2. 最低保証価値を設定（例: 1円）
3. 「🧮 計算する」をクリック

→ 残りの199個が自動的に最低保証価値（1円）のハズレで埋められます！

#### 方法2: 手動でハズレを追加

1. ハズレ管理で、不足分のハズレを手動で追加
2. 合計が総口数（300個）になるように調整

#### 方法3: 総口数を変更

1. 総口数を実際の数（101個）に変更
2. 「🧮 計算する」をクリック

### 確認方法

計算後、コンソールに以下のように表示されます：

**✅ 正常な場合:**
```
ガチャプール生成完了: {
  totalItems: 300,
  prizes: 1,
  losses: 299,
  expectedTotal: 300
}
```

**⚠️ エラーの場合:**
```
⚠️ 残り199スロットが未割り当てです。「💡 手動ハズレと最低保証を併用する」をONにすることを推奨します。
```

## 🚨 エラー3: permission_denied

### エラー内容
```
Error: permission_denied at /temporaryPrizeMaster
Error: permission_denied at /prizeMaster
```

### 原因
Firebaseデータベースへのアクセス権限がありません。

### 解決方法

**✅ エラーが出ていても、アプリは正常に動作します！**

データは**localStorageに保存**されるため、同じブラウザ内では問題なく使用できます。

#### クラウド同期が必要な場合のみ

1. [Firebase Console](https://console.firebase.google.com/) を開く
2. Realtime Database → ルール
3. 以下のルールに変更：

```json
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
```

詳細は **`Firebaseルール設定ガイド.md`** を参照してください。

## 🚨 エラー4: 仮装景品の仕入れ価格が0になる

### 症状
仮装景品を追加したが、仕入れ価格が0円になっている。

### 解決方法

#### 方法1: 先にポイント還元価値を入力してからチェック
1. ポイント還元価値を入力（例: 70,000）
2. 仮装景品にチェック✓
3. 自動的に仕入れ価格にコピーされます

#### 方法2: チェックしてから入力
1. 仮装景品にチェック✓
2. ポイント還元価値を入力（例: 70,000）
3. リアルタイムで仕入れ価格に反映されます

詳細は **`仮装景品の使い方.md`** を参照してください。

## 🚨 エラー5: file:// プロトコルでのエラー

### エラー内容
```
Failed to execute 'postMessage' on 'DOMWindow'
The target origin provided ('file://') does not match the recipient window's origin ('null')
```

### 原因
HTMLファイルを直接ダブルクリックして開いています。

### 解決方法

**必ずローカルサーバー経由で起動してください！**

1. **Mac**: `start-server.command` をダブルクリック
2. **Windows**: `start-server.bat` をダブルクリック
3. ブラウザで **http://localhost:8000** を開く

詳細は **`起動方法.md`** を参照してください。

## 📋 デバッグ方法

### コンソールの開き方

1. **Chrome/Edge**: `F12` キー
2. **Mac Chrome**: `Cmd + Option + I`
3. **Mac Safari**: `Cmd + Option + C`

### コンソールで確認すべきログ

#### ✅ 正常な場合
```
✅ Firebase匿名認証に成功しました
✅ クラウド接続済み
✅ 仮装景品マスターをlocalStorageに保存しました
ガチャプール生成完了: {totalItems: 300, ...}
```

#### ⚠️ 警告（動作はする）
```
⚠️ クラウド保存の権限がありません（localStorageには保存済み）
⚠️ 残り199スロットが未割り当てです
```

#### ❌ エラー（要対応）
```
❌ エラー: 景品とハズレの合計が総口数を超えています
Uncaught Error: child failed: path argument was an invalid path
```

## 💡 トラブルシューティング

### 問題が解決しない場合

1. **ブラウザのキャッシュをクリア**
   - Mac: `Cmd + Shift + R`
   - Windows: `Ctrl + Shift + R`

2. **ローカルサーバー経由で起動しているか確認**
   - アドレスバーが `http://localhost:8000` になっているか
   - `file://` で開いていないか

3. **コンソールのエラーメッセージを確認**
   - F12キーでコンソールを開く
   - 赤いエラーメッセージをコピーして検索

4. **最新版を使用しているか確認**
   - ブラウザのキャッシュをクリア
   - ページをリロード

## 📚 関連ドキュメント

- **起動方法.md** - 正しい起動手順
- **仮装景品の使い方.md** - 仮装景品機能の詳細
- **Firebaseルール設定ガイド.md** - クラウド同期の設定方法
