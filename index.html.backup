<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オリパ設計シミュレーターオンライン v2.4</title>
    <style>
        :root {
            /* 最新のiOS風カラーパレット */
            --sf-blue: #007AFF;
            --sf-indigo: #5856D6;
            --sf-orange: #FF9500;
            --sf-green: #34C759;
            --sf-teal: #5AC8FA;
            --sf-red: #FF3B30;
            --sf-purple: #AF52DE;
            --sf-pink: #FF2D55;
            --sf-yellow: #FFCC00;
            --sf-gray: #8E8E93;
            --sf-gray-2: #AEAEB2;
            --sf-gray-3: #C7C7CC;
            --sf-gray-4: #D1D1D6;
            --sf-gray-5: #E5E5EA;
            --sf-gray-6: #F2F2F7;
            --sf-white: #FFFFFF;
            --sf-black: #000000;

            /* 強化されたシャドウ */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.16);
            --shadow-2xl: 0 24px 64px rgba(0, 0, 0, 0.20);

            /* グラスモーフィズム用シャドウ */
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);

            /* より大きなborder-radius */
            --radius-xs: 8px;
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;

            /* スムーズなトランジション */
            --transition-fast: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* 動的なグラデーション背景 */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(
                135deg,
                #e8eef3 0%,
                #dce4ec 25%,
                #e0e7ed 50%,
                #dde5ee 75%,
                #e5ebf1 100%
            );
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            min-height: 100vh;
            letter-spacing: -0.02em;
            line-height: 1.6;
            color: rgba(0, 0, 0, 0.9);
            position: relative;
            overflow-x: hidden;
            overflow-y: scroll;
        }

        /* グラスモーフィズム背景レイヤー */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(
                circle at 30% 50%,
                rgba(0, 122, 255, 0.03) 0%,
                transparent 50%
            ),
            radial-gradient(
                circle at 70% 80%,
                rgba(100, 126, 234, 0.04) 0%,
                transparent 50%
            );
            animation: float 25s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            33% {
                transform: translate(30px, -50px) rotate(120deg);
            }
            66% {
                transform: translate(-20px, 20px) rotate(240deg);
            }
        }

        /* メインコンテナ - グラスモーフィズム */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(80px) saturate(200%);
            -webkit-backdrop-filter: blur(80px) saturate(200%);
            padding: 40px;
            border-radius: var(--radius-2xl);
            box-shadow:
                0 30px 90px rgba(0, 0, 0, 0.1),
                0 12px 40px rgba(0, 0, 0, 0.06),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 2px 8px rgba(255, 255, 255, 0.7) inset;
            border: 0.5px solid rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 1;
            animation: containerFadeIn 0.8s var(--transition-smooth);
        }

        @keyframes containerFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* タイトル */
        h1 {
            color: rgba(0, 0, 0, 0.9);
            text-align: center;
            margin: 0 0 40px 0;
            font-size: 3em;
            font-weight: 700;
            letter-spacing: -0.03em;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            animation: titleSlideIn 1s var(--transition-smooth);
        }

        @keyframes titleSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* バージョンバッジ */
        .version-badge {
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 6px 16px;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 700;
            margin-left: 16px;
            vertical-align: middle;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
        }

        /* タブナビゲーション */
        .tab-navigation {
            display: flex;
            gap: 12px;
            margin: 0 0 32px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: var(--radius-xl);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
        }

        .tab-button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            background: transparent;
            color: rgba(0, 0, 0, 0.6);
            font-size: 15px;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            letter-spacing: -0.01em;
        }

        .tab-button:hover {
            background: rgba(0, 122, 255, 0.08);
            color: rgba(0, 0, 0, 0.8);
        }

        .tab-button.active {
            background: rgba(0, 122, 255, 0.85);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            box-shadow:
                0 6px 20px rgba(0, 122, 255, 0.35),
                0 2px 10px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset;
        }

        /* タブコンテンツ */
        .tab-content {
            display: none;
            animation: tabFadeIn 0.4s var(--transition-smooth);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes tabFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* グリッドレイアウト */
        .main-grid {
            display: grid;
            grid-template-columns: 460px 1fr;
            gap: 32px;
            animation: gridFadeIn 1s var(--transition-smooth) 0.2s both;
        }

        @keyframes gridFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* left-panelの表示順を制御 */
        .left-panel > .panel:nth-child(1) { order: 1; } /* 基本設定 */
        .left-panel > .panel:nth-child(2) { order: 4; } /* ハズレ管理 → 4番目へ */
        .left-panel > .panel:nth-child(3) { order: 3; } /* 景品管理 */
        .left-panel > .panel:nth-child(4) { order: 2; } /* クラウド設定 → 2番目へ */
        .left-panel > .panel:nth-child(5) { order: 5; } /* 過去7日間の集計 */

        /* パネル - 強化されたグラスモーフィズム */
        .panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            padding: 28px;
            border-radius: var(--radius-xl);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 16px 50px rgba(0, 0, 0, 0.07),
                0 6px 20px rgba(0, 0, 0, 0.04),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 1px 4px rgba(255, 255, 255, 0.7) inset;
            position: relative;
            overflow: hidden;
        }

        /* パネルヘッダー */
        .panel h2 {
            margin: 0 0 24px 0;
            color: rgba(0, 0, 0, 0.9);
            padding-bottom: 16px;
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: -0.02em;
            position: relative;
        }

        .panel h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--sf-blue);
            border-radius: var(--radius-full);
            transition: width 0.3s var(--transition-smooth);
        }

        .panel:hover h2::after {
            width: 120px;
        }

        /* フォームグループ */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
            font-size: 14px;
            letter-spacing: -0.01em;
            transition: color 0.3s var(--transition-smooth);
        }

        .form-group:focus-within label {
            color: var(--sf-blue);
        }

        /* インプット */
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 18px;
            border: 1.5px solid rgba(0, 0, 0, 0.12);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.04),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset;
            transition: all 0.3s var(--transition-smooth);
            color: rgba(0, 0, 0, 0.9);
        }

        .form-group input:hover,
        .form-group select:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.15);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.06),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--sf-blue);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            box-shadow:
                0 0 0 4px rgba(0, 122, 255, 0.12),
                0 4px 16px rgba(0, 0, 0, 0.08),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset;
            transform: translateY(-1px);
        }

        /* エラー状態 */
        .form-group input.error {
            border-color: var(--sf-red);
            background-color: rgba(255, 59, 48, 0.08);
            animation: shakeError 0.4s var(--transition-smooth);
        }

        @keyframes shakeError {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .form-group input.error:focus {
            border-color: var(--sf-red);
            box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.15);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .calculated-value {
            background: rgba(52, 199, 89, 0.1);
            color: var(--sf-green);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-weight: 600;
            text-align: center;
            border: 2px solid rgba(52, 199, 89, 0.3);
        }

        .prize-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .prize-item {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: var(--radius-md);
            padding: 16px;
            position: relative;
            transition: all 0.3s var(--transition-smooth);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .prize-item:hover {
            border-color: var(--sf-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .prize-rank {
            position: absolute;
            top: -8px;
            left: 12px;
            background: var(--sf-blue);
            color: var(--sf-white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .prize-rank.rank-1 { background: #FFD700; color: var(--sf-black); }
        .prize-rank.rank-2 { background: #C0C0C0; color: var(--sf-black); }
        .prize-rank.rank-3 { background: #CD7F32; color: var(--sf-white); }
        .prize-rank.rank-4 { background: var(--sf-green); }
        .prize-rank.rank-5 { background: var(--sf-blue); }

        .prize-content {
            margin-top: 8px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .prize-name {
            font-weight: 500;
            color: var(--sf-black);
        }

        .prize-value, .prize-count, .prize-purchase {
            font-size: 12px;
            color: var(--sf-gray);
            text-align: center;
        }

        /* ボタン - シンプルなiOS風 */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            letter-spacing: -0.01em;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: rgba(0, 122, 255, 0.85);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 6px 20px rgba(0, 122, 255, 0.35),
                0 2px 10px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset,
                0 1px 4px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-primary:hover {
            background: rgba(0, 102, 221, 0.9);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(0, 122, 255, 0.45),
                0 4px 15px rgba(0, 122, 255, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset,
                0 2px 6px rgba(255, 255, 255, 0.7) inset;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
            background: rgba(0, 81, 213, 0.95);
            box-shadow:
                0 3px 12px rgba(0, 122, 255, 0.35),
                0 1px 6px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-danger {
            background: rgba(255, 59, 48, 0.8);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.75);
            box-shadow:
                0 6px 20px rgba(255, 59, 48, 0.35),
                0 2px 10px rgba(255, 59, 48, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset,
                0 1px 4px rgba(255, 255, 255, 0.5) inset;
        }

        .btn-danger:hover {
            background: rgba(230, 52, 42, 0.85);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(255, 59, 48, 0.45),
                0 4px 15px rgba(255, 59, 48, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.5) inset,
                0 2px 6px rgba(255, 255, 255, 0.4) inset;
        }

        .btn-danger:active {
            transform: translateY(0) scale(0.98);
            background: rgba(204, 46, 36, 0.8);
            box-shadow:
                0 3px 12px rgba(255, 59, 48, 0.35),
                0 1px 6px rgba(255, 59, 48, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.3) inset;
        }

        .btn-success {
            background: rgba(52, 199, 89, 0.8);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            width: 100%;
            padding: 16px;
            font-size: 15px;
            margin-top: 16px;
            border: 0.5px solid rgba(255, 255, 255, 0.75);
            box-shadow:
                0 6px 20px rgba(52, 199, 89, 0.35),
                0 2px 10px rgba(52, 199, 89, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset,
                0 1px 4px rgba(255, 255, 255, 0.5) inset;
        }

        .btn-success:hover {
            background: rgba(47, 179, 80, 0.85);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(52, 199, 89, 0.45),
                0 4px 15px rgba(52, 199, 89, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset,
                0 2px 6px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-success:active {
            transform: translateY(0) scale(0.98);
            background: rgba(40, 167, 69, 0.9);
            box-shadow:
                0 3px 12px rgba(52, 199, 89, 0.35),
                0 1px 6px rgba(52, 199, 89, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.5) inset;
        }

        /* btn-accentをbtn-primaryと統一 */
        .btn-accent {
            background: rgba(0, 122, 255, 0.85);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--sf-white);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 6px 20px rgba(0, 122, 255, 0.35),
                0 2px 10px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.7) inset,
                0 1px 4px rgba(255, 255, 255, 0.6) inset;
        }

        .btn-accent:hover {
            background: rgba(0, 102, 221, 0.9);
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 10px 30px rgba(0, 122, 255, 0.45),
                0 4px 15px rgba(0, 122, 255, 0.35),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset,
                0 2px 6px rgba(255, 255, 255, 0.7) inset;
        }

        .btn-accent:active {
            transform: translateY(0) scale(0.98);
            background: rgba(0, 81, 213, 0.95);
            box-shadow:
                0 3px 12px rgba(0, 122, 255, 0.35),
                0 1px 6px rgba(0, 122, 255, 0.25),
                0 0 0 0.5px rgba(255, 255, 255, 0.6) inset;
        }
        
        /* ガチャ体験スタイル */
        .gacha-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .gacha-btn {
            flex: 1;
            min-width: 120px;
            font-weight: 600;
        }
        .gacha-results {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 0.5px solid rgba(255, 255, 255, 0.85);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 20px;
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.06),
                0 0 0 0.5px rgba(255, 255, 255, 0.8) inset;
        }
        .gacha-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .gacha-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(52, 199, 89, 0.08);
            border-radius: 8px;
        }
        .gacha-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--sf-green);
        }
        .gacha-stat-label {
            font-size: 0.9em;
            color: var(--sf-gray);
        }
        .gacha-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .gacha-draw-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        .gacha-draw-prize {
            background: var(--sf-green);
            color: white;
        }
        .gacha-draw-loss {
            background: var(--sf-orange);
            color: white;
        }

        .add-prize-form {
            background: rgba(0, 122, 255, 0.03);
            border: 2px dashed rgba(0, 122, 255, 0.3);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 16px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 24px;
        }

        /* 結果パネル */
        .result-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            padding: 28px;
            border-radius: var(--radius-xl);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 16px 50px rgba(0, 0, 0, 0.07),
                0 6px 20px rgba(0, 0, 0, 0.04),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 1px 4px rgba(255, 255, 255, 0.7) inset;
            position: relative;
            overflow: hidden;
        }

        .result-panel h3 {
            margin: 0 0 20px 0;
            color: rgba(0, 0, 0, 0.9);
            padding-bottom: 16px;
            font-size: 1.4em;
            font-weight: 700;
            letter-spacing: -0.02em;
            position: relative;
        }

        .result-panel h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--sf-blue);
            border-radius: var(--radius-full);
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--sf-gray-5);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: var(--sf-black);
        }

        .result-value {
            color: var(--sf-gray);
            font-weight: 600;
        }

        .highlight {
            background: rgba(255, 149, 0, 0.12);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 149, 0, 0.3);
            color: var(--sf-orange);
            font-weight: 600;
        }

        .loss-panel {
            background: rgba(255, 149, 0, 0.05);
            border: 1px solid rgba(255, 149, 0, 0.15);
        }

        .loss-panel h3::after {
            background: var(--sf-orange);
        }

        .expected-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .ev-item {
            text-align: center;
            padding: 8px;
            background: rgba(52, 199, 89, 0.08);
            border-radius: 8px;
            font-size: 12px;
        }

        .ev-count {
            font-weight: 600;
            color: var(--sf-green);
        }

        .ev-value {
            color: var(--sf-gray);
            font-size: 11px;
        }

        .warning {
            background: rgba(255, 59, 48, 0.1);
            color: var(--sf-red);
            padding: 16px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 59, 48, 0.2);
            margin-top: 24px;
            font-size: 14px;
        }

        /* プリセットオリパのスタイル */
        .preset-section label {
            transition: all 0.2s var(--transition-smooth);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
        }

        .preset-section label:hover {
            background: rgba(0, 122, 255, 0.05);
            border-color: rgba(0, 122, 255, 0.2);
        }

        .preset-section input[type="radio"]:checked + span {
            color: var(--sf-blue);
            font-weight: 600;
        }

        .preset-section input[type="radio"]:checked {
            accent-color: var(--sf-blue);
        }

        /* モーダルのスタイル */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s var(--transition-smooth);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            border: 0.5px solid rgba(255, 255, 255, 0.9);
            border-radius: var(--radius-xl);
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 2px 8px rgba(255, 255, 255, 0.6) inset;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s var(--transition-smooth);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--sf-gray-5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 600;
            color: var(--sf-black);
        }

        .modal-close {
            font-size: 32px;
            color: var(--sf-gray);
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s var(--transition);
        }

        .modal-close:hover {
            color: var(--sf-red);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--sf-gray-5);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-footer .btn {
            min-width: 100px;
        }

        /* レスポンシブデザイン - 強化 */
        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 420px 1fr;
                gap: 28px;
            }
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 400px 1fr;
                gap: 24px;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        @media (max-width: 1024px) {
            body {
                padding: 16px;
            }

            .container {
                padding: 28px;
                border-radius: var(--radius-xl);
            }

            h1 {
                font-size: 2.2em;
                margin-bottom: 32px;
            }

            .main-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 20px;
                border-radius: var(--radius-lg);
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 24px;
            }

            .version-badge {
                display: block;
                margin: 12px auto 0;
                width: fit-content;
            }

            .panel, .result-panel {
                padding: 20px;
                border-radius: var(--radius-lg);
            }

            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 16px;
                border-radius: var(--radius-md);
            }

            h1 {
                font-size: 1.5em;
            }

            .panel, .result-panel {
                padding: 16px;
            }
        }

        /* スムーズスクロール */
        html {
            scroll-behavior: smooth;
            overflow-y: scroll;
        }

        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-full);
            transition: background 0.3s var(--transition-smooth);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* セレクション */
        ::selection {
            background: rgba(0, 122, 255, 0.3);
            color: var(--sf-white);
        }

        /* フォーカス表示の改善 */
        *:focus-visible {
            outline: 2px solid var(--sf-blue);
            outline-offset: 2px;
        }

        /* ========== スコア評価モーダル ========== */
        #scoreModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            z-index: 10000;
            animation: fadeIn 0.3s var(--transition-smooth);
            overflow: visible;
        }

        #scoreModal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }

        .score-modal-content {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.85), rgba(248, 249, 250, 0.85));
            backdrop-filter: blur(60px) saturate(180%);
            -webkit-backdrop-filter: blur(60px) saturate(180%);
            border: 0.5px solid rgba(255, 255, 255, 0.9);
            border-radius: var(--radius-2xl);
            box-shadow:
                0 30px 80px rgba(0, 0, 0, 0.15),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 2px 8px rgba(255, 255, 255, 0.6) inset;
            width: 90%;
            max-width: 600px;
            padding: 60px 48px;
            text-align: center;
            position: relative;
            animation: slideUp 0.4s var(--transition-smooth);
            overflow: visible;
        }

        .score-close {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: all 0.2s var(--transition-smooth);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.03);
        }

        .score-close:hover {
            background: rgba(0, 0, 0, 0.08);
            color: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }

        .score-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 48px;
            color: rgba(0, 0, 0, 0.85);
            letter-spacing: -0.02em;
        }

        /* スロットコンテナ */
        .score-gauge-container {
            position: relative;
            width: 100%;
            margin: 0 auto 48px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ランク表示 - 高級感のあるスロット */
        .score-rank {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.8), rgba(248, 249, 250, 0.8));
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: 50%;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.08),
                0 0 0 0.5px rgba(255, 255, 255, 0.9) inset,
                0 0 60px rgba(0, 0, 0, 0.03);
            border: 3px solid rgba(255, 255, 255, 0.95);
        }

        .score-rank-container {
            font-size: 6em;
            font-weight: 800;
            letter-spacing: -0.03em;
        }

        .score-rank-item {
            display: inline-block;
        }

        /* スライドアニメーション */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50px);
            }
        }

        @keyframes confirmPop {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            70% {
                transform: scale(0.95);
            }
            100% {
                transform: scale(1);
            }
        }

        .score-rank-item.slide-in {
            animation: slideIn 0.1s ease-out forwards;
        }

        .score-rank-item.slide-out {
            animation: slideOut 0.1s ease-in forwards;
        }

        .score-rank-item.confirm {
            animation: confirmPop 0.4s ease-out forwards;
        }

        /* ランク別カラー - 落ち着いた配色 */
        .score-rank.rank-S {
            background: linear-gradient(145deg, rgba(255, 223, 0, 0.15), rgba(255, 240, 100, 0.15));
            border-color: rgba(255, 215, 0, 0.4);
        }

        .score-rank.rank-S .score-rank-container {
            color: #D4AF37;
            text-shadow: 0 2px 20px rgba(212, 175, 55, 0.3);
        }

        .score-rank.rank-A {
            background: linear-gradient(145deg, rgba(0, 122, 255, 0.08), rgba(0, 122, 255, 0.12));
            border-color: rgba(0, 122, 255, 0.3);
        }

        .score-rank.rank-A .score-rank-container {
            color: #007AFF;
            text-shadow: 0 2px 20px rgba(0, 122, 255, 0.2);
        }

        .score-rank.rank-B {
            background: linear-gradient(145deg, rgba(52, 199, 89, 0.08), rgba(52, 199, 89, 0.12));
            border-color: rgba(52, 199, 89, 0.3);
        }

        .score-rank.rank-B .score-rank-container {
            color: #34C759;
            text-shadow: 0 2px 20px rgba(52, 199, 89, 0.2);
        }

        .score-rank.rank-C {
            background: linear-gradient(145deg, rgba(255, 149, 0, 0.08), rgba(255, 149, 0, 0.12));
            border-color: rgba(255, 149, 0, 0.3);
        }

        .score-rank.rank-C .score-rank-container {
            color: #FF9500;
            text-shadow: 0 2px 20px rgba(255, 149, 0, 0.2);
        }

        .score-rank.rank-D {
            background: linear-gradient(145deg, rgba(255, 59, 48, 0.08), rgba(255, 59, 48, 0.12));
            border-color: rgba(255, 59, 48, 0.3);
        }

        .score-rank.rank-D .score-rank-container {
            color: #FF3B30;
            text-shadow: 0 2px 20px rgba(255, 59, 48, 0.2);
        }

        .score-rank.rank-E {
            background: linear-gradient(145deg, rgba(142, 142, 147, 0.08), rgba(142, 142, 147, 0.12));
            border-color: rgba(142, 142, 147, 0.3);
        }

        .score-rank.rank-E .score-rank-container {
            color: #8E8E93;
            text-shadow: 0 2px 20px rgba(142, 142, 147, 0.2);
        }

        /* スコア詳細 - 高級感のあるデザイン */
        .score-details {
            margin-top: 40px;
            text-align: left;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.75), rgba(248, 249, 250, 0.75));
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            padding: 28px;
            border-radius: var(--radius-lg);
            font-size: 14px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        }

        .score-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        }

        .score-detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .score-detail-label {
            color: rgba(0, 0, 0, 0.6);
            font-weight: 500;
            font-size: 14px;
            letter-spacing: -0.01em;
        }

        .score-detail-value {
            color: rgba(0, 0, 0, 0.9);
            font-weight: 700;
            font-size: 15px;
            letter-spacing: -0.01em;
        }

        /* クラッカーエフェクト */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFD700;
            border-radius: 50%;
            z-index: 1000;
            pointer-events: none;
        }

        /* 自然な散らばりアニメーション */
        @keyframes confettiBurst {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(0.1);
                opacity: 0;
            }
        }

        .confetti {
            animation: confettiBurst var(--duration) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* 景品一覧ページ用スタイル */
        .prize-master-list {
            display: grid;
            gap: 16px;
        }

        .prize-master-item {
            background: rgba(255, 255, 255, 0.95);
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            border-radius: var(--radius-lg);
            padding: 24px;
            position: relative;
            transition: all 0.3s var(--transition-smooth);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        }

        .prize-master-item:hover {
            border-color: var(--sf-blue);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        .prize-master-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .prize-master-title {
            flex: 1;
        }

        .prize-master-name {
            font-size: 18px;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.9);
            margin-bottom: 8px;
        }

        .prize-master-rank-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        .prize-master-rank-badge.rank-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: var(--sf-black);
        }

        .prize-master-rank-badge.rank-2 {
            background: linear-gradient(135deg, #E0E0E0, #B0B0B0);
            color: var(--sf-black);
        }

        .prize-master-rank-badge.rank-3 {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: var(--sf-white);
        }

        .prize-master-rank-badge.rank-4 {
            background: var(--sf-green);
            color: var(--sf-white);
        }

        .prize-master-rank-badge.rank-5 {
            background: var(--sf-blue);
            color: var(--sf-white);
        }

        .prize-master-actions {
            display: flex;
            gap: 8px;
        }

        .prize-master-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .prize-master-info-item {
            text-align: center;
        }

        .prize-master-info-label {
            font-size: 12px;
            color: var(--sf-gray);
            margin-bottom: 4px;
        }

        .prize-master-info-value {
            font-size: 16px;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.9);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--sf-gray);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-state-subtext {
            font-size: 14px;
            color: var(--sf-gray-2);
        }

        /* 編集モーダル */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: var(--radius-xl);
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
            border: 0.5px solid rgba(255, 255, 255, 0.8);
            animation: modalSlideIn 0.3s var(--transition-smooth);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .edit-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.9);
        }

        .edit-modal-close {
            background: transparent;
            border: none;
            font-size: 28px;
            color: var(--sf-gray);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .edit-modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.8);
        }

        .edit-modal-footer {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>オリパ設計シミュレーターオンライン <span class="version-badge">v2.4</span></h1>

        <!-- タブナビゲーション -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('main', event)">メイン</button>
            <button class="tab-button" onclick="switchTab('prize-list', event)">景品マスター</button>
            <button class="tab-button" onclick="switchTab('auto-create', event)">オリパ自動作成</button>
        </div>

        <!-- メインタブコンテンツ -->
        <div id="tab-main" class="tab-content active">
        <div class="main-grid">
            <div class="left-panel" style="display: grid; gap: 24px;">
                <!-- 基本設定 -->
                <div class="panel">
                    <h2>基本設定</h2>
                    <div class="form-group">
                        <label>パック単価 (円)</label>
                        <input type="number" id="packPrice" value="40000">
                    </div>
                    <div class="form-group">
                        <label>総口数</label>
                        <input type="number" id="totalPacks" value="100">
                    </div>
                    <div class="form-group">
                        <label>公開日</label>
                        <input type="date" id="releaseDate" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label>オリパ提供価値</label>
                        <div class="calculated-value" id="totalValue">¥0</div>
                    </div>

                    <!-- プリセット設定 -->
                    <div class="preset-section" style="margin-top: 20px; padding: 16px; background: rgba(0, 122, 255, 0.05); border: 1px solid var(--sf-blue); border-radius: var(--border-radius-small);">
                        <label style="display: block; font-weight: 600; color: var(--sf-black); margin-bottom: 12px; font-size: 14px;">
                            ⚡ プリセットオリパ
                        </label>
                        <div id="presetList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                            <!-- プリセット一覧がここに動的に生成されます -->
                        </div>
                        <button class="btn btn-success" onclick="openAddPresetModal()" style="width: 100%; font-size: 12px; padding: 8px; margin-bottom: 8px;">
                            ➕ 新規プリセット追加
                        </button>
                        <button class="btn btn-primary" onclick="applyPreset()" style="width: 100%; font-size: 13px; padding: 10px;">
                            ⚡ プリセットから計算
                        </button>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <button class="btn btn-success" onclick="calculate()" style="flex: 1; font-size: 16px; padding: 14px;">
                            🧮 計算する
                        </button>
                        <button class="btn btn-primary" onclick="showScoreEvaluation()" style="flex: 1; font-size: 16px; padding: 14px;">
                            ⭐ スコア評価
                        </button>
                    </div>
                </div>

                <!-- ハズレ管理 -->
                <div class="panel">
                    <h2>ハズレ管理</h2>
                    <p style="color: var(--sf-gray); font-size: 13px; margin-bottom: 16px;">
                        ハズレを手動で設定しない場合、最低保証価値で自動計算されます
                    </p>
                    <div class="form-group">
                        <label>自動計算用：最低保証価値 (円)</label>
                        <input type="number" id="minGuaranteeValue" value="1" min="1" step="1">
                    </div>

                    <div class="prize-list" id="lossList" style="margin-top: 16px;">
                        <!-- ハズレリストがここに表示されます -->
                    </div>

                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>ハズレ名</label>
                            <input type="text" id="lossName" placeholder="例: ハズレA">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>価値 (円)</label>
                                <input type="number" id="lossValue" placeholder="100" min="1">
                            </div>
                            <div class="form-group">
                                <label>枚数</label>
                                <input type="number" id="lossCount" min="1" value="1">
                            </div>
                        </div>
                        <button class="btn btn-success" id="addLossBtn" onclick="addLoss()">ハズレを追加</button>
                        <button class="btn btn-success" id="updateLossBtn" onclick="updateLoss()" style="display: none;">ハズレを更新</button>
                        <button class="btn btn-danger" id="cancelEditLossBtn" onclick="cancelEditLoss()" style="display: none; margin-top: 8px;">キャンセル</button>
                    </div>
                </div>

                <!-- 景品管理 -->
                <div class="panel">
                    <h2>景品管理</h2>
                    <div class="prize-list" id="prizeList">
                        <!-- 景品リストがここに表示されます -->
                    </div>

                    <button class="btn btn-accent" onclick="exportPrizesToJSON()" style="width: 100%; margin: 16px 0; font-size: 14px;">
                        💾 景品をJSONでエクスポート
                    </button>

                    <div class="add-prize-form">
                        <div class="form-group">
                            <label>景品名</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="prizeName" placeholder="例: レアカード" style="flex: 1;">
                                <button class="btn btn-primary" onclick="selectFromPrizeMasterForMain()" style="white-space: nowrap; padding: 0 12px;">
                                    📋 マスターから選択
                                </button>
                            </div>
                        </div>

                        <!-- 画像と仕入れ価格の表示エリア（編集不可） -->
                        <div id="prizeReadonlyInfo" style="display: none; background: rgba(0, 0, 0, 0.02); padding: 12px; border-radius: var(--radius-md); margin-bottom: 16px;">
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <div id="prizeImageDisplay"></div>
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">仕入れ価格（編集不可）</div>
                                    <div id="prizePurchasePriceDisplay" style="font-size: 16px; font-weight: 600;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>等級</label>
                            <select id="prizeRank" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                                <option value="1">1等</option>
                                <option value="2">2等</option>
                                <option value="3">3等</option>
                                <option value="4">4等</option>
                                <option value="5">5等</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ポイント還元価値</label>
                            <input type="text" id="prizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                        </div>
                        <div class="form-group">
                            <label>封入数</label>
                            <input type="number" id="prizeCount" min="1" value="1">
                        </div>
                        <button class="btn btn-success" id="addPrizeBtn" onclick="addPrizeFromForm()">景品を追加</button>
                        <button class="btn btn-success" id="updatePrizeBtn" onclick="updatePrizeFromForm()" style="display: none;">景品を更新</button>
                        <button class="btn btn-primary" id="replacePrizeBtn" onclick="selectFromPrizeMasterForReplace()" style="display: none; margin-top: 8px;">🔄 別の景品に置き換え</button>
                        <button class="btn btn-danger" id="cancelEditBtn" onclick="cancelEditPrize()" style="display: none; margin-top: 8px;">キャンセル</button>
                    </div>
                </div>

                <!-- クラウド設定管理 -->
                <div class="panel" style="background: rgba(0, 122, 255, 0.05); border-color: var(--sf-blue);">
                    <h2 style="border-bottom-color: var(--sf-blue);">☁️ クラウド設定共有</h2>

                    <!-- 保存セクション -->
                    <div class="form-group">
                        <label>設定名</label>
                        <input type="text" id="cloudConfigName" placeholder="設定名を入力（例: ポケモンオリパA案）">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="saveToCloudWithName()" style="font-size: 12px;">
                            💾 新規保存
                        </button>
                        <button class="btn btn-accent" onclick="updateCloudConfig()" style="font-size: 12px;" id="updateCloudBtn" disabled>
                            🔄 上書き更新
                        </button>
                    </div>

                    <!-- 読み込みセクション -->
                    <div class="form-group">
                        <label>クラウド設定一覧</label>
                        <select id="cloudConfigList" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                            <option value="">設定を選択してください</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-success" onclick="loadSelectedCloudConfig()" style="font-size: 12px;">
                            📂 読み込み
                        </button>
                        <button class="btn btn-danger" onclick="deleteSelectedCloudConfig()" style="font-size: 12px;">
                            🗑️ 削除
                        </button>
                    </div>

                    <button class="btn btn-primary" onclick="refreshCloudConfigList()" style="width: 100%; font-size: 12px;">
                        🔄 一覧を更新
                    </button>

                    <!-- 共有リンク生成セクション -->
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--sf-gray-5);">
                        <label style="display: block; font-weight: 500; color: var(--sf-black); margin-bottom: 8px; font-size: 14px;">
                            🔗 リンク共有
                        </label>
                        <button class="btn btn-accent" onclick="generateShareLink()" style="width: 100%; font-size: 12px;" id="shareBtn" disabled>
                            📋 共有リンクをコピー
                        </button>
                        <div id="shareStatus" style="margin-top: 8px; font-size: 11px; color: var(--sf-gray); text-align: center;"></div>
                    </div>

                    <div id="cloudStatus" style="margin-top: 12px; font-size: 12px; color: var(--sf-gray);"></div>
                </div>

                <!-- 過去7日間の集計 -->
                <div class="panel" style="background: rgba(175, 82, 222, 0.05); border-color: var(--sf-purple);">
                    <h2 style="border-bottom-color: var(--sf-purple);">📊 過去7日間の集計</h2>

                    <button class="btn btn-primary" onclick="refreshWeeklyStats()" style="width: 100%; margin-bottom: 16px;">
                        🔄 集計を更新
                    </button>

                    <div id="weeklyStatsContainer" style="font-size: 13px;">
                        <p style="color: var(--sf-gray); text-align: center;">「集計を更新」をクリックしてください</p>
                    </div>
                </div>
            </div>

            <div class="results-grid">
                <!-- サマリー -->
                <div class="result-panel">
                    <h3>サマリー</h3>
                    <div class="result-row">
                        <span class="result-label">総還元率</span>
                        <span class="result-value" id="summaryTotalReturn">98.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">実質還元率（売上原価率）</span>
                        <span class="result-value highlight" id="summaryRealReturn">0.0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">総当選者数</span>
                        <span class="result-value" id="summaryWinnerCount">0人</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">総仕入れ額</span>
                        <span class="result-value" id="summaryTotalPurchase">¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">当たり景品還元総額</span>
                        <span class="result-value" id="summaryPrizeTotalReward">¥0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">ハズレ還元総額</span>
                        <span class="result-value" id="summaryLossTotalReward">¥0</span>
                    </div>
                </div>

                <!-- 景品詳細 -->
                <div class="result-panel">
                    <h3>景品詳細</h3>
                    <div id="prizeDetails">
                        <p style="color: var(--sf-gray); text-align: center;">景品を追加してください</p>
                    </div>
                </div>

                <!-- ハズレ詳細 + 分布 -->
                <div class="result-panel loss-panel">
                    <h3>ハズレ詳細（自動計算）</h3>
                    <div id="lossDetailsContainer">
                        <!-- ハズレ詳細がここに動的に表示されます -->
                    </div>
                    <div class="result-row">
                        <span class="result-label">ハズレ総枚数</span>
                        <span class="result-value" id="totalLossCount">0枚</span>
                    </div>

                    <!-- ハズレ当選者分布 -->
                    <div style="margin-top: 24px; padding-top: 24px; border-top: 1.5px solid rgba(255, 255, 255, 0.4);">
                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--sf-black);">ハズレ当選者分布</h4>
                        <div class="chart-container">
                            <canvas id="lossDistributionChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>




                <!-- ガチャ体験 -->
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <h3>🎮 ガチャ体験</h3>
                    <p style="color: var(--sf-gray); font-size: 14px; margin-bottom: 20px;">
                        実際にオリパを引いて、設計したガチャの体験を確認できます
                    </p>
                    
                    <!-- ガチャボタン -->
                    <div class="gacha-controls">
                        <button class="btn btn-primary gacha-btn" onclick="drawGacha(1)">
                            🎲 1回引く
                        </button>
                        <button class="btn btn-secondary gacha-btn" onclick="drawGacha(10)">
                            🎲 10回引く
                        </button>
                        <button class="btn btn-accent gacha-btn" onclick="drawGacha(100)">
                            🎲 100回引く
                        </button>
                        <button class="btn btn-danger gacha-btn" onclick="resetGacha()" id="resetGachaBtn" style="display: none;">
                            🔄 リセット
                        </button>
                    </div>
                    
                    <!-- ガチャ結果 -->
                    <div id="gachaResults" class="gacha-results" style="display: none;">
                        <h4>ガチャ結果</h4>
                        <div id="gachaStats" class="gacha-stats"></div>
                        <div id="gachaHistory" class="gacha-history"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="warnings"></div>
        </div>
        <!-- /メインタブコンテンツ -->

        <!-- 景品一覧タブコンテンツ -->
        <div id="tab-prize-list" class="tab-content">
            <div class="panel">
                <h2>景品マスター</h2>
                <p style="color: var(--sf-gray); font-size: 14px; margin-bottom: 24px;">
                    オリパ自動作成で使用する景品を管理します。メインタブで作成した景品をJSONでエクスポートし、ここでインポートしてください。
                </p>

                <div style="margin-bottom: 24px;">
                    <!-- クラウド同期ステータス -->
                    <div style="background: rgba(52, 199, 89, 0.1); padding: 12px 16px; border-radius: var(--radius-md); border: 1px solid rgba(52, 199, 89, 0.3); margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">☁️ クラウド同期ステータス</div>
                            <div id="syncStatus" style="font-size: 14px; font-weight: 600; color: var(--sf-green);">初期化中...</div>
                        </div>
                        <button class="btn btn-primary" onclick="manualSyncPrizeMaster()" style="padding: 8px 16px; font-size: 13px;">
                            🔄 今すぐ同期
                        </button>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="toggleAddPrizeForm()" style="flex: 1; min-width: 200px;">
                            ➕ 新規景品を登録
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('dataImportFile').click()" style="flex: 1; min-width: 200px;">
                            📥 データファイルから追加
                        </button>
                        <button class="btn btn-danger" onclick="clearPrizeMaster()" style="flex: 1; min-width: 200px;">
                            🗑️ クリア
                        </button>
                    </div>
                    <input type="file" id="dataImportFile" accept=".json,.csv" multiple style="display: none;" onchange="importPrizesFromFile(event)">

                    <!-- 新規景品登録フォーム -->
                    <div id="addPrizeFormContainer" style="display: none; background: rgba(0, 122, 255, 0.05); padding: 20px; border-radius: var(--radius-lg); border: 2px solid rgba(0, 122, 255, 0.3); margin-bottom: 16px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--sf-black);">新規景品を登録</h3>

                        <div class="form-group">
                            <label>景品名</label>
                            <input type="text" id="newPrizeName" placeholder="例: レアカード">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>仕入れ価格</label>
                                <input type="text" id="newPrizePurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this)">
                            </div>
                            <div class="form-group">
                                <label>ポイント還元価値</label>
                                <input type="text" id="newPrizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>在庫数</label>
                            <input type="number" id="newPrizeCount" min="0" value="1">
                        </div>

                        <div class="form-group">
                            <label>景品種類</label>
                            <select id="newPrizeType" style="padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                                <option value="PSA10" selected>PSA10</option>
                                <option value="美品">美品</option>
                                <option value="パック">パック</option>
                                <option value="ボックス">ボックス</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                                <input type="checkbox" id="newPrizeIsWanted" style="width: 20px; height: 20px; cursor: pointer;">
                                <span>❤️ 欲しいものリストに追加</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label>景品画像URL（任意）</label>
                            <input type="text" id="newPrizeImageUrl" placeholder="https://example.com/image.jpg" oninput="previewImageFromUrl(this.value, 'prizeImagePreviewImg', 'prizeImagePreview')">
                            <div id="prizeImagePreview" style="margin-top: 12px; display: none;">
                                <img id="prizeImagePreviewImg" style="max-width: 200px; max-height: 200px; border-radius: var(--radius-md); border: 2px solid rgba(0, 0, 0, 0.1);" onerror="this.style.border='2px solid red';">
                                <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;">プレビュー</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-primary" onclick="addNewPrizeToMaster()" style="flex: 1;">登録</button>
                            <button class="btn btn-danger" onclick="cancelAddPrize()" style="flex: 1;">キャンセル</button>
                        </div>
                    </div>

                    <div style="background: rgba(0, 122, 255, 0.05); padding: 16px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.2);">
                        <div style="font-size: 13px; color: var(--sf-gray); margin-bottom: 8px;">
                            💡 <strong>クラウド共有機能</strong>
                        </div>
                        <div style="font-size: 12px; color: var(--sf-gray); line-height: 1.6;">
                            • 景品マスターは自動的にクラウドに保存されます<br>
                            • 他のユーザーが追加した景品も自動的に同期されます<br>
                            • JSONファイルからインポートした景品も全ユーザーで共有されます
                        </div>
                    </div>
                </div>

                <!-- 並び替え・フィルター設定 -->
                <div style="margin-bottom: 16px; padding: 16px; background: rgba(0, 0, 0, 0.02); border-radius: var(--radius-lg); display: flex; gap: 12px; align-items: center; flex-wrap: wrap; min-height: 60px;">
                    <label style="font-weight: 600; font-size: 14px; color: var(--sf-label); flex-shrink: 0;">並び替え:</label>
                    <select id="prizeMasterSortBy" onchange="updatePrizeMasterList()" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; cursor: pointer; min-width: 140px; height: 38px;">
                        <option value="price">仕入れ価格順</option>
                        <option value="date">登録日時順</option>
                    </select>
                    <select id="prizeMasterSortOrder" onchange="updatePrizeMasterList()" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; cursor: pointer; min-width: 180px; height: 38px;">
                        <option value="desc">降順（高い/新しい順）</option>
                        <option value="asc">昇順（安い/古い順）</option>
                    </select>
                    <div style="width: 1px; height: 24px; background: rgba(0, 0, 0, 0.1); flex-shrink: 0;"></div>
                    <label style="font-weight: 600; font-size: 14px; color: var(--sf-label); flex-shrink: 0;">在庫:</label>
                    <select id="prizeMasterFilter" onchange="updatePrizeMasterList()" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; cursor: pointer; min-width: 140px; height: 38px;">
                        <option value="all">すべて</option>
                        <option value="inStock">在庫あり</option>
                        <option value="outOfStock">在庫なし</option>
                    </select>
                    <label style="font-weight: 600; font-size: 14px; color: var(--sf-label); flex-shrink: 0;">種類:</label>
                    <select id="prizeMasterTypeFilter" onchange="updatePrizeMasterList()" style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; cursor: pointer; min-width: 120px; height: 38px;">
                        <option value="all">すべて</option>
                        <option value="PSA10">PSA10</option>
                        <option value="美品">美品</option>
                        <option value="パック">パック</option>
                        <option value="ボックス">ボックス</option>
                        <option value="その他">その他</option>
                    </select>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; padding: 6px 12px; background: rgba(255, 192, 203, 0.2); border-radius: var(--radius-md); border: 2px solid rgba(255, 105, 180, 0.4);">
                        <input type="checkbox" id="prizeMasterWantedFilter" onchange="updatePrizeMasterList()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; font-size: 14px; color: #ff1493;">❤️ 欲しいものリスト</span>
                    </label>
                    <div style="width: 1px; height: 24px; background: rgba(0, 0, 0, 0.1); flex-shrink: 0;"></div>
                    <label style="font-weight: 600; font-size: 14px; color: var(--sf-label); flex-shrink: 0;">検索:</label>
                    <input type="text" id="prizeMasterSearchText" oninput="updatePrizeMasterList()" placeholder="景品名で検索..." style="padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px; min-width: 200px; height: 38px;">
                </div>

                <div id="prizeMasterList" class="prize-master-list">
                    <!-- 景品一覧がここに表示されます -->
                </div>
            </div>
        </div>
        <!-- /景品一覧タブコンテンツ -->

        <!-- オリパ自動作成タブコンテンツ -->
        <div id="tab-auto-create" class="tab-content">
            <div class="panel">
                <h2>🎯 オリパ自動作成</h2>
                <p style="color: var(--sf-gray); font-size: 14px; margin-bottom: 24px;">
                    景品マスターから最適な景品を自動的に選択してオリパを作成します
                </p>

                <!-- 設定セクション -->
                <div id="autoCreateSettings" style="display: block;">
                    <div class="form-group">
                        <label>パック単価 (円)</label>
                        <input type="number" id="autoPackPrice" value="500" min="1">
                    </div>

                    <div class="form-group">
                        <label>総口数</label>
                        <input type="number" id="autoTotalPacks" value="100" min="1">
                    </div>

                    <div class="form-group">
                        <label>目標還元率 (%)</label>
                        <input type="number" id="autoReturnRate" value="95" min="50" max="100" step="0.1">
                        <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;">
                            この還元率に近いオリパを作成します
                        </div>
                    </div>

                    <div class="form-group">
                        <label>景品選択条件</label>
                        <select id="autoPrizeFilter" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                            <option value="inStock">在庫数があるものだけ</option>
                            <option value="all">在庫数関係なく全て</option>
                            <option value="inStockAndWanted">在庫数あり + 欲しいものリスト</option>
                        </select>
                        <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;">
                            景品マスターからどの景品を選択するかを指定
                        </div>
                    </div>

                    <div class="form-group">
                        <label>各等級の構成</label>
                        <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 8px; align-items: center; font-size: 14px;">
                            <div style="font-weight: 600;">1等</div>
                            <input type="number" id="autoRank1Count" value="1" min="0" style="padding: 8px;">
                            <span style="color: var(--sf-gray); font-size: 12px;">枚</span>

                            <div style="font-weight: 600;">2等</div>
                            <input type="number" id="autoRank2Count" value="3" min="0" style="padding: 8px;">
                            <span style="color: var(--sf-gray); font-size: 12px;">枚</span>

                            <div style="font-weight: 600;">3等</div>
                            <input type="number" id="autoRank3Count" value="5" min="0" style="padding: 8px;">
                            <span style="color: var(--sf-gray); font-size: 12px;">枚</span>

                            <div style="font-weight: 600;">4等</div>
                            <input type="number" id="autoRank4Count" value="10" min="0" style="padding: 8px;">
                            <span style="color: var(--sf-gray); font-size: 12px;">枚</span>

                            <div style="font-weight: 600;">5等</div>
                            <input type="number" id="autoRank5Count" value="15" min="0" style="padding: 8px;">
                            <span style="color: var(--sf-gray); font-size: 12px;">枚</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>最低保証価値（ハズレ1枚あたり）</label>
                        <input type="number" id="autoMinGuarantee" value="100" min="1">
                    </div>

                    <button class="btn btn-primary" onclick="createAutoOripa()" style="width: 100%; font-size: 16px; padding: 16px; margin-top: 8px;">
                        🎯 オリパを作成
                    </button>
                </div>

                <!-- プレビューセクション -->
                <div id="autoCreatePreview" style="display: none; margin-top: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="color: rgba(0, 0, 0, 0.9); margin: 0;">📋 作成されたオリパ</h3>
                        <button class="btn btn-secondary" onclick="backToSettings()" style="padding: 8px 16px;">
                            ⬅️ 設定に戻る
                        </button>
                    </div>

                    <!-- 結果サマリー -->
                    <div id="autoPreviewSummary" style="background: rgba(0, 122, 255, 0.05); padding: 20px; border-radius: var(--radius-lg); border: 2px solid rgba(0, 122, 255, 0.3); margin-bottom: 16px;">
                    </div>

                    <!-- 景品リスト -->
                    <div id="autoPreviewPrizes" style="margin-bottom: 16px;">
                    </div>

                    <!-- アクションボタン -->
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-success" onclick="confirmRegisterOripa()" style="flex: 1; font-size: 16px; padding: 16px;">
                            ✅ このオリパを登録する
                        </button>
                        <button class="btn btn-danger" onclick="backToSettings()" style="flex: 1; font-size: 16px; padding: 16px;">
                            ❌ キャンセル
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- /オリパ自動作成タブコンテンツ -->
    </div>

    <!-- 景品編集モーダル -->
    <div id="editPrizeModal" class="edit-modal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title">景品を編集</h3>
                <button class="edit-modal-close" onclick="closeEditPrizeModal()">&times;</button>
            </div>
            <div class="edit-modal-body">
                <div class="form-group">
                    <label>景品名</label>
                    <input type="text" id="editPrizeName" placeholder="例: レアカード">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>仕入れ価格</label>
                        <input type="text" id="editPrizePurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this)">
                    </div>
                    <div class="form-group">
                        <label>ポイント還元価値</label>
                        <input type="text" id="editPrizeValue" placeholder="70,000" oninput="formatPrizeValue(this)">
                    </div>
                </div>
                <div class="form-group">
                    <label>在庫数</label>
                    <input type="number" id="editPrizeCount" min="0" value="1">
                </div>
                <div class="form-group">
                    <label>景品種類</label>
                    <select id="editPrizeType" style="padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                        <option value="PSA10">PSA10</option>
                        <option value="美品">美品</option>
                        <option value="パック">パック</option>
                        <option value="ボックス">ボックス</option>
                        <option value="その他">その他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="editPrizeIsWanted" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>❤️ 欲しいものリストに追加</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>景品画像URL（任意）</label>
                    <input type="text" id="editPrizeImageUrl" placeholder="https://example.com/image.jpg" oninput="previewImageFromUrl(this.value, 'editPrizeImagePreviewImg', 'editPrizeImagePreview')">
                    <div id="editPrizeImagePreview" style="margin-top: 12px; display: none;">
                        <img id="editPrizeImagePreviewImg" style="max-width: 200px; max-height: 200px; border-radius: var(--radius-md); border: 2px solid rgba(0, 0, 0, 0.1);" onerror="this.style.border='2px solid red';">
                        <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;">プレビュー</div>
                    </div>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="btn btn-primary" onclick="saveEditedPrize()" style="flex: 1;">保存</button>
                <button class="btn btn-danger" onclick="closeEditPrizeModal()" style="flex: 1;">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 景品マスター選択モーダル -->
    <div id="selectPrizeMasterModal" class="edit-modal">
        <div class="edit-modal-content" style="max-width: 900px;">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title">景品マスターから選択</h3>
                <button class="edit-modal-close" onclick="closeSelectPrizeMasterModal()">&times;</button>
            </div>
            <div class="edit-modal-body" style="max-height: 600px; overflow-y: auto; padding: 0;">
                <!-- フィルター・並び替え・検索エリア -->
                <div id="modalFilterArea" style="padding: 16px; background: rgba(0, 0, 0, 0.02); border-bottom: 1px solid rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 10;">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
                        <label style="font-weight: 600; font-size: 13px; color: var(--sf-label); flex-shrink: 0;">並び替え:</label>
                        <select id="modalSortBy" onchange="updatePrizeMasterSelectList()" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 13px; cursor: pointer; min-width: 120px;">
                            <option value="price">仕入れ価格順</option>
                            <option value="date">登録日時順</option>
                        </select>
                        <select id="modalSortOrder" onchange="updatePrizeMasterSelectList()" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 13px; cursor: pointer; min-width: 150px;">
                            <option value="desc">降順（高い/新しい順）</option>
                            <option value="asc">昇順（安い/古い順）</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <label style="font-weight: 600; font-size: 13px; color: var(--sf-label); flex-shrink: 0;">在庫:</label>
                        <select id="modalStockFilter" onchange="updatePrizeMasterSelectList()" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 13px; cursor: pointer; min-width: 120px;">
                            <option value="all">すべて</option>
                            <option value="inStock">在庫あり</option>
                            <option value="outOfStock">在庫なし</option>
                        </select>
                        <label style="font-weight: 600; font-size: 13px; color: var(--sf-label); flex-shrink: 0;">種類:</label>
                        <select id="modalTypeFilter" onchange="updatePrizeMasterSelectList()" style="padding: 6px 10px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 13px; cursor: pointer; min-width: 100px;">
                            <option value="all">すべて</option>
                            <option value="PSA10">PSA10</option>
                            <option value="美品">美品</option>
                            <option value="パック">パック</option>
                            <option value="ボックス">ボックス</option>
                            <option value="その他">その他</option>
                        </select>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; user-select: none; padding: 4px 8px; background: rgba(255, 192, 203, 0.2); border-radius: var(--radius-md); border: 1.5px solid rgba(255, 105, 180, 0.4);">
                            <input type="checkbox" id="modalWantedFilter" onchange="updatePrizeMasterSelectList()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-weight: 600; font-size: 13px; color: #ff1493;">❤️ 欲しいもの</span>
                        </label>
                    </div>
                    <div style="margin-top: 12px;">
                        <input type="text" id="modalSearchText" oninput="updatePrizeMasterSelectList()" placeholder="景品名で検索..." style="width: 100%; padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid rgba(0, 0, 0, 0.1); background: white; font-size: 14px;">
                    </div>
                </div>
                <!-- 景品リスト -->
                <div id="prizeMasterSelectList" style="padding: 16px;"></div>

                <!-- 新規登録フォーム -->
                <div id="modalNewPrizeForm" style="display: none; padding: 16px;">
                    <div style="background: rgba(0, 122, 255, 0.05); padding: 16px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.2); margin-bottom: 16px;">
                        <div style="font-size: 14px; color: var(--sf-blue); font-weight: 600; margin-bottom: 8px;">💡 新規景品登録</div>
                        <div style="font-size: 13px; color: var(--sf-gray); line-height: 1.6;">
                            ここで登録した景品は景品マスターにも追加され、他のオリパでも使用できます。
                        </div>
                    </div>

                    <div class="form-group">
                        <label>景品名 *</label>
                        <input type="text" id="modalPrizeName" placeholder="例: レアカード" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                    </div>

                    <div class="form-group">
                        <label>景品種類</label>
                        <select id="modalPrizeType" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                            <option value="PSA10">PSA10</option>
                            <option value="美品">美品</option>
                            <option value="パック">パック</option>
                            <option value="ボックス">ボックス</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>仕入れ価格 *</label>
                        <input type="text" id="modalPurchasePrice" placeholder="50,000" oninput="formatPrizeValue(this)" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                    </div>

                    <div class="form-group">
                        <label>ポイント還元価値 *</label>
                        <input type="text" id="modalPrizeValue" placeholder="70,000" oninput="formatPrizeValue(this)" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                    </div>

                    <div class="form-group">
                        <label>在庫数 *</label>
                        <input type="number" id="modalPrizeCount" min="0" value="1" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                    </div>

                    <div class="form-group">
                        <label>画像URL</label>
                        <input type="url" id="modalPrizeImage" placeholder="https://example.com/image.jpg" oninput="previewModalImage(this.value)" style="width: 100%; padding: 12px; border: 1px solid var(--sf-gray-4); border-radius: var(--border-radius-small);">
                        <div id="modalImagePreview" style="margin-top: 12px; display: none;">
                            <img id="modalImagePreviewImg" style="width: 100px; height: 150px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1);">
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="modalPrizeWanted" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-weight: 600; color: #ff1493;">❤️ 欲しいものリストに追加</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="edit-modal-footer" style="display: flex; gap: 12px;">
                <button class="btn btn-danger" id="modalCancelBtn" onclick="closeSelectPrizeMasterModal()" style="flex: 1;">キャンセル</button>
                <button class="btn btn-success" id="modalNewPrizeBtn" onclick="showModalNewPrizeForm()" style="flex: 1;">➕ 新規登録</button>
                <button class="btn btn-danger" id="modalFormCancelBtn" onclick="hideModalNewPrizeForm()" style="flex: 1; display: none;">戻る</button>
                <button class="btn btn-success" id="modalFormSaveBtn" onclick="saveModalNewPrize()" style="flex: 1; display: none;">景品を登録</button>
            </div>
        </div>
    </div>

    <!-- 画像拡大表示モーダル -->
    <div id="imageViewModal" class="edit-modal" onclick="closeImageViewModal()">
        <div class="edit-modal-content" style="max-width: 90vw; max-height: 90vh; background: rgba(0, 0, 0, 0.95); border: none;">
            <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                <button class="edit-modal-close" onclick="closeImageViewModal()" style="position: absolute; top: 10px; right: 10px; z-index: 10; background: rgba(255, 255, 255, 0.2); color: white; border: none; font-size: 32px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer;">&times;</button>
                <img id="imageViewImg" style="max-width: 100%; max-height: 85vh; object-fit: contain; border-radius: var(--radius-md);">
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="deleteConfirmModal" class="edit-modal" style="display: none;">
        <div class="edit-modal-content" style="max-width: 500px;">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title">削除確認</h3>
            </div>
            <div class="edit-modal-body">
                <p id="deleteConfirmMessage" style="font-size: 16px; line-height: 1.6; margin: 20px 0;"></p>
            </div>
            <div class="edit-modal-footer" style="display: flex; gap: 12px;">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal(false)" style="flex: 1;">キャンセル</button>
                <button type="button" class="btn btn-danger" onclick="closeDeleteConfirmModal(true)" style="flex: 1;">削除</button>
            </div>
        </div>
    </div>

    <!-- クリア確認モーダル -->
    <div id="clearConfirmModal" class="edit-modal" style="display: none;">
        <div class="edit-modal-content" style="max-width: 600px;">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title" style="color: #ff3b30;">⚠️ 景品マスター全削除</h3>
            </div>
            <div class="edit-modal-body">
                <p style="font-size: 16px; line-height: 1.8; margin: 20px 0; color: #333;">
                    <strong style="color: #ff3b30;">この操作は取り消せません！</strong><br><br>
                    以下の内容が実行されます：<br>
                    • 景品マスターの全データを削除<br>
                    • クラウドのデータも削除<br>
                    • 全ユーザーの景品マスターがクリア<br><br>
                    続行する場合は下のボックスに「<strong>クリア</strong>」と入力してください。
                </p>
                <input type="text" id="clearConfirmInput" placeholder="ここに「クリア」と入力" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ff3b30; border-radius: 8px; margin-top: 12px;">
            </div>
            <div class="edit-modal-footer" style="display: flex; gap: 12px;">
                <button type="button" class="btn btn-secondary" onclick="closeClearConfirmModal()" style="flex: 1;">キャンセル</button>
                <button type="button" class="btn btn-danger" onclick="executeClearPrizeMaster()" style="flex: 1;">全削除を実行</button>
            </div>
        </div>
    </div>

    <!-- プリセット編集モーダル -->
    <div id="presetModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">プリセットを編集</h2>
                <span class="modal-close" onclick="closePresetModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>プリセット名</label>
                    <input type="text" id="modalPresetName" placeholder="例: カスタム500">
                </div>
                <div class="form-group">
                    <label>倍率（何分の1で当たるか）</label>
                    <input type="number" id="modalMultiplier" placeholder="例: 500" min="1">
                </div>
                <div class="form-group">
                    <label>パック単価（デフォルト値）</label>
                    <input type="number" id="modalPackPrice" placeholder="例: 10" min="1">
                </div>
                <div class="form-group">
                    <label>ハズレ価値（デフォルト値）</label>
                    <input type="number" id="modalMinGuarantee" placeholder="例: 1" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="savePreset()">保存</button>
                <button class="btn btn-danger" onclick="closePresetModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let prizes = [];
        let losses = []; // ハズレリスト
        let editingPrizeId = null; // 編集中の景品ID
        let editingLossId = null; // 編集中のハズレID

        // プリセット管理
        let presets = [];
        let editingPresetId = null; // 編集中のプリセットID

        // 初期プリセット（初回のみ使用）
        const INITIAL_PRESETS = [
            {
                id: 'preset_319',
                name: '319',
                multiplier: 319,
                packPrice: 13,
                minGuaranteeValue: 1
            },
            {
                id: 'preset_198',
                name: '198',
                multiplier: 198,
                packPrice: 39,
                minGuaranteeValue: 1
            },
            {
                id: 'preset_nibuchi',
                name: 'ニブイチ',
                multiplier: 2,
                packPrice: 350,
                minGuaranteeValue: 1
            }
        ];

        // ローカルストレージのキー
        const STORAGE_KEY = 'oripa_simulator_v2';
        const PRESETS_STORAGE_KEY = 'oripa_presets_v1';

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadPresetsFromStorage(); // プリセットを読み込み
            attachEventListeners();
            updateTotalValue();
        });

        // イベントリスナー設定
        function attachEventListeners() {
            // オリパ提供価値のリアルタイム更新のみ
            document.getElementById('packPrice').addEventListener('input', updateTotalValue);
            document.getElementById('totalPacks').addEventListener('input', updateTotalValue);
            // 他の項目は手動計算に変更
        }

        // オリパ提供価値の更新（エラーチェックなし）
        function updateTotalValue() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const totalValue = packPrice * totalPacks;
            document.getElementById('totalValue').textContent = `¥${totalValue.toLocaleString()}`;

            // エラー状態をリセット（入力中はエラー表示しない）
            document.getElementById('packPrice').classList.remove('error');
            document.getElementById('totalPacks').classList.remove('error');
        }

        // ポイント還元価値のフォーマット
        function formatPrizeValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // 数字以外を除去
            if (value) {
                value = parseInt(value).toLocaleString(); // カンマ区切りに変換
            }
            input.value = value;
        }

        // 基本設定値のフォーマット
        function formatBasicValue(input) {
            let value = input.value.replace(/[^\d]/g, ''); // 数字以外を除去
            if (value) {
                value = parseInt(value).toLocaleString(); // カンマ区切りに変換
            }
            input.value = value;
            // オリパ提供価値のみ更新
            setTimeout(updateTotalValue, 100);
        }

        // カンマ区切りの数字を数値に変換
        function parseFormattedNumber(value) {
            return parseFloat(value.replace(/,/g, '')) || 0;
        }

        // 景品追加
        // メイン専用：マスターから選択した景品を一時保存
        let selectedMasterPrizeForMain = null;

        // メイン専用：フォームから景品を追加
        function addPrizeFromForm() {
            // 編集モード中は追加しない
            if (editingMainPrize) {
                alert('編集モード中です。先に「キャンセル」または「景品を更新」を実行してください。');
                return;
            }

            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('すべての項目を正しく入力してください');
                return;
            }

            // マスターから選択された景品が必要
            if (!selectedMasterPrizeForMain) {
                alert('「📋 マスターから選択」ボタンで景品を選択してください');
                return;
            }

            const prize = {
                id: Date.now(),
                name: name,
                rank: rank,
                purchasePrice: selectedMasterPrizeForMain.purchasePrice,
                value: value,
                count: count,
                image: selectedMasterPrizeForMain.image || null
            };

            prizes.push(prize);

            // フォームリセット
            clearMainPrizeForm();

            updatePrizeList();
            saveData();
        }

        // メイン専用：フォームから景品を更新
        function updatePrizeFromForm() {
            if (!editingMainPrize) return;

            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('すべての項目を正しく入力してください');
                return;
            }

            // 景品名が変更された場合、景品マスターも更新
            if (name !== editingMainPrize.name) {
                const masterPrize = prizeMaster.find(p => p.name === editingMainPrize.name);
                if (masterPrize) {
                    masterPrize.name = name;
                    savePrizeMaster();
                    updatePrizeMasterList();
                }
            }

            // メインの景品を更新
            const prizeIndex = prizes.findIndex(p => p.id === editingMainPrize.id);
            if (prizeIndex !== -1) {
                prizes[prizeIndex] = {
                    ...prizes[prizeIndex],
                    name: name,
                    rank: rank,
                    value: value,
                    count: count
                };
            }

            // フォームリセット
            clearMainPrizeForm();

            updatePrizeList();
            saveData();
        }

        // メイン専用：編集キャンセル
        function cancelEditPrize() {
            clearMainPrizeForm();
        }

        // メイン専用：フォームをクリア
        function clearMainPrizeForm() {
            editingMainPrize = null;
            selectedMasterPrizeForMain = null;

            document.getElementById('prizeName').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';
            document.getElementById('prizeReadonlyInfo').style.display = 'none';

            // ボタンの表示を元に戻す
            document.getElementById('addPrizeBtn').style.display = 'inline-block';
            document.getElementById('updatePrizeBtn').style.display = 'none';
            document.getElementById('replacePrizeBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // 景品削除
        function removePrize(id) {
            prizes = prizes.filter(p => p.id !== id);
            updatePrizeList();
            saveData();
        }

        // 景品編集
        // メイン専用：景品編集時の一時保存
        let editingMainPrize = null;

        function editPrize(id) {
            const prize = prizes.find(p => p.id === id);
            if (!prize) return;

            // 編集モードを有効化
            editingMainPrize = prize;

            // フォームに値を設定
            document.getElementById('prizeName').value = prize.name;
            document.getElementById('prizeRank').value = prize.rank;
            document.getElementById('prizeValue').value = prize.value.toLocaleString();
            document.getElementById('prizeCount').value = prize.count;

            // 画像と仕入れ価格を表示（編集不可）
            const readonlyInfo = document.getElementById('prizeReadonlyInfo');
            const imageDisplay = document.getElementById('prizeImageDisplay');
            const purchasePriceDisplay = document.getElementById('prizePurchasePriceDisplay');

            if (prize.image) {
                imageDisplay.innerHTML = `<img src="${prize.image}" alt="${prize.name}" style="width: 60px; height: 90px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1);">`;
            } else {
                imageDisplay.innerHTML = `<div style="width: 60px; height: 90px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;">📦</div>`;
            }

            purchasePriceDisplay.textContent = `¥${prize.purchasePrice.toLocaleString()}`;
            readonlyInfo.style.display = 'block';

            // ボタンの表示を切り替え
            document.getElementById('addPrizeBtn').style.display = 'none';
            document.getElementById('updatePrizeBtn').style.display = 'inline-block';
            document.getElementById('replacePrizeBtn').style.display = 'inline-block';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // フォームまでスクロール
            document.getElementById('prizeName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // 景品更新
        async function updatePrize() {
            if (!editingPrizeId) return;

            const name = document.getElementById('prizeName').value.trim();
            const rank = parseInt(document.getElementById('prizeRank').value);
            const purchasePrice = parseFormattedNumber(document.getElementById('prizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('prizeValue').value);
            const count = parseInt(document.getElementById('prizeCount').value) || 0;

            if (!name || purchasePrice <= 0 || value <= 0 || count <= 0) {
                alert('すべての項目を正しく入力してください');
                return;
            }

            // 景品を更新
            const prizeIndex = prizes.findIndex(p => p.id === editingPrizeId);
            if (prizeIndex !== -1) {
                prizes[prizeIndex] = {
                    id: editingPrizeId,
                    name: name,
                    rank: rank,
                    purchasePrice: purchasePrice,
                    value: value,
                    count: count,
                    image: prizes[prizeIndex].image || selectedPrizeImage || null
                };
            }

            // 景品マスターに同じ名前の景品があるか確認
            const masterPrize = prizeMaster.find(p => p.name === name);
            if (masterPrize) {
                const message = `景品マスターに「${name}」が登録されています。\n\n` +
                    `【現在の景品マスター情報】\n` +
                    `仕入れ価格: ¥${masterPrize.purchasePrice.toLocaleString()}\n` +
                    `還元価値: ¥${masterPrize.value.toLocaleString()}\n\n` +
                    `【今回の編集内容】\n` +
                    `仕入れ価格: ¥${purchasePrice.toLocaleString()}\n` +
                    `還元価値: ¥${value.toLocaleString()}\n\n` +
                    `どのように処理しますか？\n\n` +
                    `[1] 景品マスターも更新する（マスターの情報を今回の編集内容で上書き）\n` +
                    `[2] 景品マスターに新しく登録する（同じ名前で別の景品として登録）\n` +
                    `[3] 何もしない（メインの景品のみ更新）`;

                const choice = prompt(message + '\n\n数字を入力してください (1, 2, または 3):', '3');

                if (choice === '1') {
                    // 景品マスターを更新
                    const masterIndex = prizeMaster.findIndex(p => p.id === masterPrize.id);
                    if (masterIndex !== -1) {
                        prizeMaster[masterIndex] = {
                            ...prizeMaster[masterIndex],
                            rank: rank,
                            purchasePrice: purchasePrice,
                            value: value,
                            updatedAt: Date.now()
                        };
                        savePrizeMaster();
                        alert('✅ 景品マスターを更新しました。');
                    }
                } else if (choice === '2') {
                    // 新しく景品マスターに追加
                    prizeMaster.push({
                        id: Date.now() + Math.random(),
                        name: name,
                        rank: rank,
                        purchasePrice: purchasePrice,
                        value: value,
                        count: count,
                        addedAt: Date.now()
                    });
                    savePrizeMaster();
                    alert('✅ 景品マスターに新しく登録しました。');
                }
                // choice === '3' の場合は何もしない
            }

            // 編集モードを解除
            cancelEdit();

            updatePrizeList();
            saveData();
        }

        // 編集キャンセル
        function cancelEdit() {
            editingPrizeId = null;
            selectedPrizeImage = null; // 画像もクリア

            // フォームをリセット
            document.getElementById('prizeName').value = '';
            document.getElementById('prizePurchasePrice').value = '';
            document.getElementById('prizeValue').value = '';
            document.getElementById('prizeCount').value = '1';

            // ボタンの表示を元に戻す
            document.getElementById('addPrizeBtn').style.display = 'inline-block';
            document.getElementById('updatePrizeBtn').style.display = 'none';
            document.getElementById('replacePrizeBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // 景品マスター選択モーダルを開く
        function selectFromPrizeMaster() {
            if (prizeMaster.length === 0) {
                alert('景品マスターが空です。\n\n手順：\n1. メインタブで景品を作成\n2. 「💾 景品をJSONでエクスポート」をクリック\n3. 景品マスタータブで「📥 JSONファイルから景品を追加」をクリック');
                return;
            }

            const modal = document.getElementById('selectPrizeMasterModal');
            const listContainer = document.getElementById('prizeMasterSelectList');

            // 景品マスターリストを表示
            const sortedPrizes = [...prizeMaster].sort((a, b) => a.rank - b.rank);
            listContainer.innerHTML = sortedPrizes.map(prize => {
                return `
                    <div class="prize-master-item" style="cursor: pointer; transition: all 0.2s;" onclick="selectPrizeFromMaster(${prize.id})">
                        <div class="prize-master-header">
                            <div class="prize-master-title">
                                <div class="prize-master-name">${prize.name}</div>
                            </div>
                            <div style="color: var(--sf-blue); font-weight: 600;">選択 →</div>
                        </div>
                        <div class="prize-master-info">
                            <div class="prize-master-info-item">
                                <div class="prize-master-info-label">仕入れ価格</div>
                                <div class="prize-master-info-value">¥${prize.purchasePrice.toLocaleString()}</div>
                            </div>
                            <div class="prize-master-info-item">
                                <div class="prize-master-info-label">ポイント還元価値</div>
                                <div class="prize-master-info-value">¥${prize.value.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            modal.style.display = 'flex';
        }

        // 編集コンテキスト（'main' or 'master'）
        let editContext = 'master';
        let editingMainPrizeId = null; // メインタブで編集中の景品ID

        // メインタブから新規景品登録を開く
        function openAddPrizeForMain() {
            editContext = 'main';
            editingMainPrizeId = null;

            // 景品マスタータブに切り替えてフォームを開く
            showTab('prize-master');

            // 少し遅延させてからフォームを開く
            setTimeout(() => {
                toggleAddPrizeForm();
            }, 100);
        }

        // メインタブからマスター選択を開く
        function selectFromPrizeMasterForMain() {
            if (prizeMaster.length === 0) {
                alert('景品マスターが空です。\n\nまず景品マスタータブで景品を登録してください。');
                return;
            }

            const modal = document.getElementById('selectPrizeMasterModal');

            // フィルター・並び替えをリセット
            document.getElementById('modalSortBy').value = 'price';
            document.getElementById('modalSortOrder').value = 'desc';
            document.getElementById('modalStockFilter').value = 'all';
            document.getElementById('modalTypeFilter').value = 'all';
            document.getElementById('modalWantedFilter').checked = false;
            document.getElementById('modalSearchText').value = '';

            // リストを更新
            updatePrizeMasterSelectList();

            modal.style.display = 'flex';
        }

        // モーダル内の景品マスターリストを更新
        function updatePrizeMasterSelectList() {
            const listContainer = document.getElementById('prizeMasterSelectList');

            if (prizeMaster.length === 0) {
                listContainer.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">景品マスターが空です</p>';
                return;
            }

            // フィルター・並び替え設定を取得
            const sortBy = document.getElementById('modalSortBy')?.value || 'price';
            const sortOrder = document.getElementById('modalSortOrder')?.value || 'desc';
            const stockFilter = document.getElementById('modalStockFilter')?.value || 'all';
            const typeFilter = document.getElementById('modalTypeFilter')?.value || 'all';
            const wantedFilter = document.getElementById('modalWantedFilter')?.checked || false;
            const searchText = document.getElementById('modalSearchText')?.value.trim().toLowerCase() || '';

            // フィルター処理
            let filteredPrizes = [...prizeMaster];

            // 在庫フィルター
            if (stockFilter === 'inStock') {
                filteredPrizes = filteredPrizes.filter(prize => prize.count > 0);
            } else if (stockFilter === 'outOfStock') {
                filteredPrizes = filteredPrizes.filter(prize => prize.count === 0);
            }

            // 種類フィルター
            if (typeFilter !== 'all') {
                filteredPrizes = filteredPrizes.filter(prize => (prize.type || 'PSA10') === typeFilter);
            }

            // 欲しいものリストフィルター
            if (wantedFilter) {
                filteredPrizes = filteredPrizes.filter(prize => prize.isWanted === true);
            }

            // 名前検索フィルター
            if (searchText) {
                filteredPrizes = filteredPrizes.filter(prize =>
                    prize.name.toLowerCase().includes(searchText)
                );
            }

            // フィルター後の件数チェック
            if (filteredPrizes.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--sf-gray);">
                        <div style="font-size: 48px; margin-bottom: 12px;">🔍</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">該当する景品がありません</div>
                        <div style="font-size: 14px;">フィルター条件を変更してください</div>
                    </div>
                `;
                return;
            }

            // ソート処理
            let sortedPrizes = [...filteredPrizes];

            if (sortBy === 'price') {
                sortedPrizes.sort((a, b) => {
                    if (sortOrder === 'desc') {
                        return b.purchasePrice - a.purchasePrice;
                    } else {
                        return a.purchasePrice - b.purchasePrice;
                    }
                });
            } else if (sortBy === 'date') {
                sortedPrizes.sort((a, b) => {
                    if (sortOrder === 'desc') {
                        return b.id - a.id;
                    } else {
                        return a.id - b.id;
                    }
                });
            }

            // 景品マスターリストを表示
            listContainer.innerHTML = sortedPrizes.map(prize => {
                const imageHtml = prize.image
                    ? `<img src="${prize.image}" alt="${prize.name}" style="width: 50px; height: 75px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); margin-right: 12px;">`
                    : `<div style="width: 50px; height: 75px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px;">📦</div>`;

                const typeLabel = prize.type || 'PSA10';
                const isWanted = prize.isWanted || false;
                const stockBadge = prize.count > 0
                    ? `<span style="display: inline-block; padding: 2px 8px; background: rgba(52, 199, 89, 0.1); color: #34C759; border-radius: 8px; font-size: 11px; font-weight: 600;">${prize.count}個</span>`
                    : `<span style="display: inline-block; padding: 2px 8px; background: rgba(255, 59, 48, 0.1); color: #ff3b30; border-radius: 8px; font-size: 11px; font-weight: 600;">売り切れ</span>`;

                return `
                    <div class="prize-master-item" style="cursor: pointer; transition: all 0.2s; display: flex; align-items: center;" onclick="selectPrizeFromMasterForMain(${prize.id})">
                        ${imageHtml}
                        <div style="flex: 1;">
                            <div class="prize-master-header">
                                <div class="prize-master-title">
                                    <div class="prize-master-name">${prize.name}</div>
                                    <div style="display: flex; gap: 6px; margin-top: 6px; align-items: center;">
                                        <span style="display: inline-block; padding: 2px 8px; background: rgba(0, 122, 255, 0.1); color: #007AFF; border-radius: 8px; font-size: 11px; font-weight: 600;">${typeLabel}</span>
                                        ${stockBadge}
                                        ${isWanted ? '<span style="font-size: 14px; filter: none;" title="欲しいものリスト">❤️</span>' : ''}
                                    </div>
                                </div>
                                <div style="color: var(--sf-blue); font-weight: 600;">選択 →</div>
                            </div>
                            <div class="prize-master-info">
                                <div class="prize-master-info-item">
                                    <div class="prize-master-info-label">仕入れ価格</div>
                                    <div class="prize-master-info-value">¥${prize.purchasePrice.toLocaleString()}</div>
                                </div>
                                <div class="prize-master-info-item">
                                    <div class="prize-master-info-label">ポイント還元価値</div>
                                    <div class="prize-master-info-value">¥${prize.value.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 置き換えモードフラグ
        let isReplacingMode = false;

        // メインタブ用：マスターから景品を選択してフォームに反映
        function selectPrizeFromMasterForMain(prizeId) {
            const prize = prizeMaster.find(p => p.id === prizeId);
            if (!prize) return;

            // 置き換えモードの場合
            if (isReplacingMode) {
                replacePrizeFromMaster(prizeId);
                return;
            }

            // 選択した景品を一時保存
            selectedMasterPrizeForMain = prize;

            // フォームに情報を設定
            document.getElementById('prizeName').value = prize.name;
            document.getElementById('prizeValue').value = prize.value.toLocaleString();
            document.getElementById('prizeCount').value = '1';

            // 画像と仕入れ価格を表示
            const readonlyInfo = document.getElementById('prizeReadonlyInfo');
            const imageDisplay = document.getElementById('prizeImageDisplay');
            const purchasePriceDisplay = document.getElementById('prizePurchasePriceDisplay');

            if (prize.image) {
                imageDisplay.innerHTML = `<img src="${prize.image}" alt="${prize.name}" style="width: 60px; height: 90px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1);">`;
            } else {
                imageDisplay.innerHTML = `<div style="width: 60px; height: 90px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;">📦</div>`;
            }

            purchasePriceDisplay.textContent = `¥${prize.purchasePrice.toLocaleString()}`;
            readonlyInfo.style.display = 'block';

            // モーダルを閉じる
            closeSelectPrizeMasterModal();
        }

        // 置き換えモードでモーダルを開く
        function selectFromPrizeMasterForReplace() {
            if (!editingMainPrize) {
                alert('置き換える景品が選択されていません');
                return;
            }

            isReplacingMode = true;
            selectFromPrizeMasterForMain();
        }

        // 選択した景品で現在の景品を置き換える
        function replacePrizeFromMaster(prizeId) {
            const newPrize = prizeMaster.find(p => p.id === prizeId);
            if (!newPrize || !editingMainPrize) return;

            // 現在のフォームの値を保持
            const currentRank = parseInt(document.getElementById('prizeRank').value);
            const currentValue = parseFormattedNumber(document.getElementById('prizeValue').value);
            const currentCount = parseInt(document.getElementById('prizeCount').value) || 0;

            // 新しい景品の情報でフォームを更新
            document.getElementById('prizeName').value = newPrize.name;
            // 等級、還元価値、封入数は現在の値を維持
            document.getElementById('prizeRank').value = currentRank;
            document.getElementById('prizeValue').value = currentValue.toLocaleString();
            document.getElementById('prizeCount').value = currentCount;

            // 画像と仕入れ価格を表示
            const readonlyInfo = document.getElementById('prizeReadonlyInfo');
            const imageDisplay = document.getElementById('prizeImageDisplay');
            const purchasePriceDisplay = document.getElementById('prizePurchasePriceDisplay');

            if (newPrize.image) {
                imageDisplay.innerHTML = `<img src="${newPrize.image}" alt="${newPrize.name}" style="width: 60px; height: 90px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1);">`;
            } else {
                imageDisplay.innerHTML = `<div style="width: 60px; height: 90px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;">📦</div>`;
            }

            purchasePriceDisplay.textContent = `¥${newPrize.purchasePrice.toLocaleString()}`;
            readonlyInfo.style.display = 'block';

            // editingMainPrizeを更新
            editingMainPrize.name = newPrize.name;
            editingMainPrize.image = newPrize.image;
            editingMainPrize.purchasePrice = newPrize.purchasePrice;

            // 置き換えモードを解除
            isReplacingMode = false;

            // モーダルを閉じる
            closeSelectPrizeMasterModal();

            alert(`✅ 景品を「${newPrize.name}」に置き換えました。\n\n「景品を更新」ボタンで保存してください。`);
        }

        // 景品マスター選択モーダルを閉じる
        function closeSelectPrizeMasterModal() {
            const modal = document.getElementById('selectPrizeMasterModal');
            modal.style.display = 'none';

            // フォームをリセットしてリスト表示に戻す
            hideModalNewPrizeForm();

            // 置き換えモードをリセット
            isReplacingMode = false;
        }

        // モーダル内の新規登録フォームを表示
        function showModalNewPrizeForm() {
            // リストとフィルターエリアを非表示
            document.getElementById('prizeMasterSelectList').style.display = 'none';
            document.getElementById('modalFilterArea').style.display = 'none';

            // フォームを表示
            document.getElementById('modalNewPrizeForm').style.display = 'block';

            // ボタンを切り替え
            document.getElementById('modalCancelBtn').style.display = 'none';
            document.getElementById('modalNewPrizeBtn').style.display = 'none';
            document.getElementById('modalFormCancelBtn').style.display = 'inline-block';
            document.getElementById('modalFormSaveBtn').style.display = 'inline-block';

            // フォームをリセット
            document.getElementById('modalPrizeName').value = '';
            document.getElementById('modalPrizeType').value = 'PSA10';
            document.getElementById('modalPurchasePrice').value = '';
            document.getElementById('modalPrizeValue').value = '';
            document.getElementById('modalPrizeCount').value = '1';
            document.getElementById('modalPrizeImage').value = '';
            document.getElementById('modalPrizeWanted').checked = false;
            document.getElementById('modalImagePreview').style.display = 'none';
        }

        // モーダル内の新規登録フォームを非表示にしてリスト表示に戻る
        function hideModalNewPrizeForm() {
            // フォームを非表示
            document.getElementById('modalNewPrizeForm').style.display = 'none';

            // リストとフィルターエリアを表示
            document.getElementById('prizeMasterSelectList').style.display = 'block';
            document.getElementById('modalFilterArea').style.display = 'block';

            // ボタンを切り替え
            document.getElementById('modalCancelBtn').style.display = 'inline-block';
            document.getElementById('modalNewPrizeBtn').style.display = 'inline-block';
            document.getElementById('modalFormCancelBtn').style.display = 'none';
            document.getElementById('modalFormSaveBtn').style.display = 'none';
        }

        // モーダル内の画像プレビュー
        function previewModalImage(url) {
            const preview = document.getElementById('modalImagePreview');
            const previewImg = document.getElementById('modalImagePreviewImg');

            if (url && url.trim()) {
                previewImg.src = url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // モーダルから新規景品を登録
        function saveModalNewPrize() {
            const name = document.getElementById('modalPrizeName').value.trim();
            const type = document.getElementById('modalPrizeType').value;
            const purchasePrice = parseFormattedNumber(document.getElementById('modalPurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('modalPrizeValue').value);
            const count = parseInt(document.getElementById('modalPrizeCount').value) || 0;
            const image = document.getElementById('modalPrizeImage').value.trim();
            const isWanted = document.getElementById('modalPrizeWanted').checked;

            // バリデーション
            if (!name || purchasePrice <= 0 || value <= 0 || isNaN(count) || count < 0) {
                alert('必須項目をすべて正しく入力してください');
                return;
            }

            // 景品マスターに追加
            const newPrize = {
                id: Date.now(),
                name: name,
                type: type,
                purchasePrice: purchasePrice,
                value: value,
                count: count,
                image: image || null,
                isWanted: isWanted
            };

            prizeMaster.push(newPrize);
            savePrizeMaster();
            updatePrizeMasterList();

            // クラウド同期
            syncPrizeMasterToCloud();

            // 登録した景品をメインフォームに自動選択
            selectPrizeFromMasterForMain(newPrize.id);

            alert(`✅ 景品「${name}」を景品マスターに登録しました！\n\nこの景品は他のオリパでも使用できます。`);
        }

        // 景品リスト更新
        function updatePrizeList() {
            const container = document.getElementById('prizeList');

            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">景品を追加してください</p>';
                return;
            }

            // 等級順にソート
            prizes.sort((a, b) => a.rank - b.rank);

            container.innerHTML = prizes.map(prize => {
                const imageHtml = prize.image
                    ? `<img src="${prize.image}"
                           alt="${prize.name}"
                           style="width: 60px; height: 90px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); margin-right: 12px;"
                           onerror="this.style.display='none';">`
                    : `<div style="width: 60px; height: 90px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 12px;">📦</div>`;

                return `
                <div class="prize-item" style="display: flex; align-items: center;">
                    ${imageHtml}
                    <div style="flex: 1; display: flex; align-items: center; gap: 12px;">
                        <div class="prize-rank rank-${prize.rank}">${prize.rank}等</div>
                        <div class="prize-content" style="flex: 1;">
                            <div class="prize-name">${prize.name}</div>
                            <div class="prize-purchase">仕入¥${prize.purchasePrice.toLocaleString()}</div>
                            <div class="prize-value">還元¥${prize.value.toLocaleString()}</div>
                            <div class="prize-count">${prize.count}枚</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="editPrize(${prize.id})">編集</button>
                                <button class="btn btn-danger" onclick="removePrize(${prize.id})">削除</button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // ========== 矛盾エラー表示関数 ==========

        function showConflictError(errorData) {
            let message = '';
            let suggestions = '';

            if (errorData.type === 'count_overflow') {
                message = `⚠️ 枚数が合いません\n\n` +
                    `景品枚数：${errorData.prizesTotalCount}枚\n` +
                    `ハズレ枚数：${errorData.manualLossTotalCount}枚\n` +
                    `合計：${errorData.prizesTotalCount + errorData.manualLossTotalCount}枚\n\n` +
                    `総口数：${errorData.totalPacks}口\n` +
                    `超過枚数：${errorData.excess}枚\n\n`;

                suggestions = `📋 代替案：\n\n` +
                    `1️⃣ 総口数を${errorData.prizesTotalCount + errorData.manualLossTotalCount}口に増やす\n\n` +
                    `2️⃣ ハズレ枚数を${errorData.excess}枚減らす\n\n` +
                    `3️⃣ 景品枚数を${errorData.excess}枚減らす`;

            } else if (errorData.type === 'count_shortage') {
                message = `⚠️ 枚数が不足しています\n\n` +
                    `景品枚数：${errorData.prizesTotalCount}枚\n` +
                    `ハズレ枚数：${errorData.manualLossTotalCount}枚\n` +
                    `合計：${errorData.prizesTotalCount + errorData.manualLossTotalCount}枚\n\n` +
                    `総口数：${errorData.totalPacks}口\n` +
                    `不足枚数：${errorData.shortage}枚\n\n`;

                suggestions = `📋 代替案：\n\n` +
                    `1️⃣ 総口数を${errorData.prizesTotalCount + errorData.manualLossTotalCount}口に減らす\n\n` +
                    `2️⃣ ハズレ枚数を${errorData.shortage}枚増やす\n\n` +
                    `3️⃣ 景品枚数を${errorData.shortage}枚増やす\n\n` +
                    `4️⃣ ハズレをすべて削除して自動計算に切り替える`;
            }

            alert(message + suggestions);
        }

        // ========== ハズレ管理関数 ==========

        // ハズレ追加
        function addLoss() {
            if (editingLossId) {
                alert('編集モード中です。先に「キャンセル」または「ハズレを更新」を実行してください。');
                return;
            }

            const name = document.getElementById('lossName').value.trim();
            const value = parseInt(document.getElementById('lossValue').value) || 0;
            const count = parseInt(document.getElementById('lossCount').value) || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('すべての項目を正しく入力してください');
                return;
            }

            const loss = {
                id: Date.now(),
                name: name,
                value: value,
                count: count
            };

            losses.push(loss);

            // フォームリセット
            document.getElementById('lossName').value = '';
            document.getElementById('lossValue').value = '';
            document.getElementById('lossCount').value = '1';

            updateLossList();
            saveData();
        }

        // ハズレ削除
        function removeLoss(id) {
            losses = losses.filter(l => l.id !== id);
            updateLossList();
            saveData();
        }

        // ハズレ編集
        function editLoss(id) {
            const loss = losses.find(l => l.id === id);
            if (!loss) return;

            document.getElementById('lossName').value = loss.name;
            document.getElementById('lossValue').value = loss.value;
            document.getElementById('lossCount').value = loss.count;

            editingLossId = id;

            document.getElementById('addLossBtn').style.display = 'none';
            document.getElementById('updateLossBtn').style.display = 'inline-block';
            document.getElementById('cancelEditLossBtn').style.display = 'inline-block';

            document.getElementById('lossName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ハズレ更新
        function updateLoss() {
            if (!editingLossId) return;

            const name = document.getElementById('lossName').value.trim();
            const value = parseInt(document.getElementById('lossValue').value) || 0;
            const count = parseInt(document.getElementById('lossCount').value) || 0;

            if (!name || value <= 0 || count <= 0) {
                alert('すべての項目を正しく入力してください');
                return;
            }

            const lossIndex = losses.findIndex(l => l.id === editingLossId);
            if (lossIndex !== -1) {
                losses[lossIndex] = {
                    id: editingLossId,
                    name: name,
                    value: value,
                    count: count
                };
            }

            cancelEditLoss();
            updateLossList();
            saveData();
        }

        // ハズレ編集キャンセル
        function cancelEditLoss() {
            editingLossId = null;

            document.getElementById('lossName').value = '';
            document.getElementById('lossValue').value = '';
            document.getElementById('lossCount').value = '1';

            document.getElementById('addLossBtn').style.display = 'inline-block';
            document.getElementById('updateLossBtn').style.display = 'none';
            document.getElementById('cancelEditLossBtn').style.display = 'none';
        }

        // ========== プリセット管理機能 ==========

        // プリセット一覧を更新
        function updatePresetList() {
            const container = document.getElementById('presetList');

            if (presets.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 12px 0; font-size: 13px;">プリセットを追加してください</p>';
                return;
            }

            container.innerHTML = presets.map(preset => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 8px; border: 1px solid var(--sf-gray-4);">
                    <label style="flex: 1; cursor: pointer; margin: 0; display: flex; align-items: center;">
                        <input type="radio" name="preset" value="${preset.id}" style="margin-right: 8px;">
                        <span style="font-size: 13px; font-weight: 500;">${preset.name}</span>
                        <span style="font-size: 11px; color: var(--sf-gray); margin-left: 8px;">(${preset.multiplier}分の1)</span>
                    </label>
                    <button class="btn btn-primary" onclick="openEditPresetModal('${preset.id}')" style="font-size: 11px; padding: 4px 8px;">編集</button>
                    <button class="btn btn-danger" onclick="deletePreset('${preset.id}')" style="font-size: 11px; padding: 4px 8px;">削除</button>
                </div>
            `).join('');
        }

        // プリセット追加モーダルを開く
        function openAddPresetModal() {
            editingPresetId = null;
            document.getElementById('modalTitle').textContent = '新規プリセット追加';
            document.getElementById('modalPresetName').value = '';
            document.getElementById('modalMultiplier').value = '';
            document.getElementById('modalPackPrice').value = '';
            document.getElementById('modalMinGuarantee').value = '1';
            document.getElementById('presetModal').style.display = 'flex';
        }

        // プリセット編集モーダルを開く
        function openEditPresetModal(presetId) {
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;

            editingPresetId = presetId;
            document.getElementById('modalTitle').textContent = 'プリセットを編集';
            document.getElementById('modalPresetName').value = preset.name;
            document.getElementById('modalMultiplier').value = preset.multiplier;
            document.getElementById('modalPackPrice').value = preset.packPrice;
            document.getElementById('modalMinGuarantee').value = preset.minGuaranteeValue;
            document.getElementById('presetModal').style.display = 'flex';
        }

        // モーダルを閉じる
        function closePresetModal() {
            document.getElementById('presetModal').style.display = 'none';
            editingPresetId = null;
        }

        // プリセットを保存
        function savePreset() {
            const name = document.getElementById('modalPresetName').value.trim();
            const multiplier = parseInt(document.getElementById('modalMultiplier').value) || 0;
            const packPrice = parseInt(document.getElementById('modalPackPrice').value) || 0;
            const minGuaranteeValue = parseInt(document.getElementById('modalMinGuarantee').value) || 1;

            if (!name || multiplier <= 0 || packPrice <= 0 || minGuaranteeValue <= 0) {
                alert('すべての項目を正しく入力してください');
                return;
            }

            if (editingPresetId) {
                // 編集モード
                const presetIndex = presets.findIndex(p => p.id === editingPresetId);
                if (presetIndex !== -1) {
                    presets[presetIndex] = {
                        id: editingPresetId,
                        name: name,
                        multiplier: multiplier,
                        packPrice: packPrice,
                        minGuaranteeValue: minGuaranteeValue
                    };
                }
            } else {
                // 新規追加モード
                const newPreset = {
                    id: 'preset_' + Date.now(),
                    name: name,
                    multiplier: multiplier,
                    packPrice: packPrice,
                    minGuaranteeValue: minGuaranteeValue
                };
                presets.push(newPreset);
            }

            savePresetsToStorage();
            savePresetsToFirebase();
            updatePresetList();
            closePresetModal();
        }

        // プリセットを削除
        function deletePreset(presetId) {
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;

            if (!confirm(`プリセット「${preset.name}」を削除しますか？`)) {
                return;
            }

            presets = presets.filter(p => p.id !== presetId);
            savePresetsToStorage();
            savePresetsToFirebase();
            updatePresetList();
        }

        // プリセットをLocalStorageに保存
        function savePresetsToStorage() {
            try {
                localStorage.setItem(PRESETS_STORAGE_KEY, JSON.stringify(presets));
            } catch (e) {
                console.error('プリセットの保存に失敗しました:', e);
            }
        }

        // プリセットをLocalStorageから読み込み
        function loadPresetsFromStorage() {
            try {
                const savedPresets = localStorage.getItem(PRESETS_STORAGE_KEY);
                if (savedPresets) {
                    presets = JSON.parse(savedPresets);
                } else {
                    // 初回起動時は初期プリセットを使用
                    presets = [...INITIAL_PRESETS];
                    savePresetsToStorage();
                }
                updatePresetList();
            } catch (e) {
                console.error('プリセットの読み込みに失敗しました:', e);
                presets = [...INITIAL_PRESETS];
                updatePresetList();
            }
        }

        // プリセットをFirebaseに保存
        function savePresetsToFirebase() {
            database.ref('presets').set({
                data: presets,
                updatedAt: Date.now()
            }).then(() => {
                console.log('プリセットをFirebaseに保存しました');
            }).catch((error) => {
                console.error('Firebaseへの保存に失敗しました:', error);
            });
        }

        // プリセットをFirebaseから読み込み
        function loadPresetsFromFirebase() {
            database.ref('presets').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data && data.data) {
                    presets = data.data;
                    savePresetsToStorage();
                    updatePresetList();
                    console.log('Firebaseからプリセットを読み込みました');
                }
            }).catch((error) => {
                console.error('Firebaseからの読み込みに失敗しました:', error);
            });
        }

        // ハズレリスト更新
        function updateLossList() {
            const container = document.getElementById('lossList');

            if (losses.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center; margin: 20px 0;">ハズレを追加すると手動設定できます</p>';
                return;
            }

            container.innerHTML = losses.map(loss => `
                <div class="prize-item" style="background: rgba(255, 149, 0, 0.1); border-color: var(--sf-orange);">
                    <div class="prize-content" style="grid-template-columns: 2fr 1fr 1fr auto; margin-top: 8px;">
                        <div class="prize-name">${loss.name}</div>
                        <div class="prize-value">¥${loss.value.toLocaleString()}</div>
                        <div class="prize-count">${loss.count}枚</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="editLoss(${loss.id})">編集</button>
                            <button class="btn btn-danger" onclick="removeLoss(${loss.id})">削除</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 値を10の位で丸める（1桁を0にする）
        function roundToTens(value) {
            return Math.round(value / 10) * 10;
        }

        // プリセットオリパを適用
        function applyPreset() {
            // 選択されたプリセットを取得
            const selectedPresetRadio = document.querySelector('input[name="preset"]:checked');

            if (!selectedPresetRadio) {
                alert('プリセットを選択してください');
                return;
            }

            // 景品が登録されているかチェック
            if (prizes.length === 0) {
                alert('先に景品を登録してください');
                return;
            }

            const presetId = selectedPresetRadio.value;

            // プリセットを検索
            const preset = presets.find(p => p.id === presetId);
            if (!preset) {
                alert('プリセットが見つかりませんでした');
                return;
            }

            // 景品の総枚数を計算
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // 総口数を計算
            const totalPacks = prizesTotalCount * preset.multiplier;

            // フォームに値を設定
            document.getElementById('packPrice').value = preset.packPrice;
            document.getElementById('totalPacks').value = totalPacks;
            document.getElementById('minGuaranteeValue').value = preset.minGuaranteeValue;

            // ハズレをクリア（自動計算モードにする）
            losses = [];
            updateLossList();

            // オリパ提供価値を更新
            updateTotalValue();

            // データを保存
            saveData();

            // 自動で計算を実行
            calculate();

            // 確認メッセージを表示
            const lossCount = totalPacks - prizesTotalCount;
            alert(`プリセット「${preset.name}」を適用しました\n\n総口数: ${totalPacks}口\nパック単価: ¥${preset.packPrice.toLocaleString()}\n景品枚数: ${prizesTotalCount}枚\nハズレ枚数: ${lossCount}枚\n\n値を編集して再計算することもできます。`);
        }

        // ガチャ難易度設定を取得
        function getDifficultySettings(difficulty) {
            switch(difficulty) {
                case 'easy':
                    return {
                        name: '比較的当たりやすい',
                        description: 'ハズレの価値が高めで、ユーザーフレンドリーな設計',
                        lossDistribution: [0.4, 0.35, 0.25], // 高還元重視
                        maxValueCap: 0.8 // パック単価の80%まで
                    };
                case 'hard':
                    return {
                        name: '当たりにくい',
                        description: 'ハズレの価値が低めで、大当たり重視の設計',
                        lossDistribution: [0.15, 0.35, 0.5], // 低還元重視
                        maxValueCap: 0.5 // パック単価の50%まで
                    };
                default: // normal
                    return {
                        name: '普通',
                        description: 'バランスの良い標準的な設計',
                        lossDistribution: [0.2, 0.5, 0.3], // バランス重視
                        maxValueCap: 0.7 // パック単価の70%まで
                    };
            }
        }

        // メイン計算
        function calculate() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;

            if (packPrice <= 0 || totalPacks <= 0) {
                return;
            }

            // 基本計算
            const totalValue = packPrice * totalPacks;

            // オリパ提供価値表示
            document.getElementById('totalValue').textContent = `¥${totalValue.toLocaleString()}`;

            // 景品総価値計算（ポイント還元価値）
            const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // 景品総仕入れ価格計算
            const prizesTotalPurchasePrice = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);

            // 実質還元率計算（仕入れ価格ベース）
            const realReturnRate = totalValue > 0 ? (prizesTotalPurchasePrice / totalValue) * 100 : 0;

            // ハズレ計算（手動設定 or 自動計算）
            const remainingSlots = totalPacks - prizesTotalCount;
            let lossTypes = [];

            // 手動でハズレが設定されている場合
            if (losses.length > 0) {
                const manualLossTotalCount = losses.reduce((sum, loss) => sum + loss.count, 0);

                // 矛盾チェック1: 景品枚数 + 手動ハズレ枚数 > 総口数
                if (prizesTotalCount + manualLossTotalCount > totalPacks) {
                    showConflictError({
                        type: 'count_overflow',
                        prizesTotalCount,
                        manualLossTotalCount,
                        totalPacks,
                        excess: (prizesTotalCount + manualLossTotalCount) - totalPacks
                    });
                    return;
                }

                // 矛盾チェック2: 景品枚数 + 手動ハズレ枚数 < 総口数
                if (prizesTotalCount + manualLossTotalCount < totalPacks) {
                    showConflictError({
                        type: 'count_shortage',
                        prizesTotalCount,
                        manualLossTotalCount,
                        totalPacks,
                        shortage: totalPacks - (prizesTotalCount + manualLossTotalCount)
                    });
                    return;
                }

                // 手動ハズレをlossTypesに変換
                lossTypes = losses.map(loss => ({
                    name: loss.name,
                    value: loss.value,
                    count: loss.count,
                    type: 'manual'
                }));

            } else {
                // 自動計算モード
                if (remainingSlots <= 0) {
                    if (!validateSettings()) {
                        return;
                    }
                }

                if (remainingSlots > 0) {
                    // 最低保証価値で自動計算
                    const adjustedMinValue = Math.max(1, Math.round(minGuaranteeValue));

                    lossTypes.push({
                        name: `ハズレ（最低保証）`,
                        value: adjustedMinValue,
                        count: remainingSlots,
                        type: 'auto'
                    });
                }
            }

            // 期待値計算
            let expectedValue = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (prize.value * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                expectedValue += loss.value * probability;
            });

            // 標準偏差計算
            let variance = prizes.reduce((sum, prize) => {
                const probability = prize.count / totalPacks;
                return sum + (Math.pow(prize.value - expectedValue, 2) * probability);
            }, 0);

            lossTypes.forEach(loss => {
                const probability = loss.count / totalPacks;
                variance += Math.pow(loss.value - expectedValue, 2) * probability;
            });

            const stdDev = Math.sqrt(variance);

            // 総還元率を計算（景品 + ハズレの合計から算出）
            const lossTotalValue = lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0);
            const actualTotalReturnValue = prizesTotalValue + lossTotalValue;
            const totalReturnRatePercent = totalValue > 0 ? (actualTotalReturnValue / totalValue) * 100 : 0;

            // ハズレの総数を計算
            const lossCount = lossTypes.reduce((sum, loss) => sum + loss.count, 0);

            // 結果表示更新
            updateResults({
                totalReturnRatePercent,
                realReturnRate,
                expectedValue,
                stdDev,
                lossTypes,
                lossCount,
                totalPacks,
                packPrice
            });
        }

        // 警告表示済みフラグ
        let lastWarningRealReturnRate = 0;

        // 結果表示更新
        function updateResults(data) {
            document.getElementById('summaryTotalReturn').textContent = `${data.totalReturnRatePercent.toFixed(1)}%`;
            document.getElementById('summaryRealReturn').textContent = `${data.realReturnRate.toFixed(1)}%`;

            // 実質還元率（売上原価率）が50％を超えた場合の警告
            // 値が変わった場合のみ警告を表示
            if (data.realReturnRate > 50 && Math.abs(data.realReturnRate - lastWarningRealReturnRate) > 0.5) {
                lastWarningRealReturnRate = data.realReturnRate;
                setTimeout(() => {
                    alert(`⚠️ 警告：売上原価率が高すぎます\n\n現在の実質還元率（売上原価率）: ${data.realReturnRate.toFixed(1)}%\n\n売上原価率が50％を超えています。\nこのままでは利益率が低く、ビジネスとして成立しにくい可能性があります。\n\n推奨対応：\n• 景品の仕入れ価格を見直す\n• パック単価を上げる\n• 高額景品の枚数を減らす`);
                }, 300);
            } else if (data.realReturnRate <= 50) {
                // 50％以下になったらフラグをリセット
                lastWarningRealReturnRate = 0;
            }

            // 総当選者数を表示
            const totalWinners = prizes.reduce((sum, prize) => sum + prize.count, 0);
            document.getElementById('summaryWinnerCount').textContent = `${totalWinners}人`;

            // 総仕入れ額を表示
            const totalPurchaseAmount = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);
            document.getElementById('summaryTotalPurchase').textContent = `¥${totalPurchaseAmount.toLocaleString()}`;

            // 当たり景品還元総額を表示
            const prizeTotalReward = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
            document.getElementById('summaryPrizeTotalReward').textContent = `¥${prizeTotalReward.toLocaleString()}`;

            // ハズレ還元総額を表示
            const lossTotalReward = data.lossTypes ? data.lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0) : 0;
            document.getElementById('summaryLossTotalReward').textContent = `¥${lossTotalReward.toLocaleString()}`;

            // 景品詳細更新
            updatePrizeDetails();

            // ハズレ詳細更新
            updateLossDetails(data.lossTypes, data.lossCount);
            
            // ハズレ分布チャート更新
            drawLossDistributionChart(data.lossTypes);

            // 警告表示の更新
            updateWarnings(data);
        }

        // 景品詳細更新
        function updatePrizeDetails() {
            const container = document.getElementById('prizeDetails');

            if (prizes.length === 0) {
                container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">景品を追加してください</p>';
                return;
            }

            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;

            container.innerHTML = prizes.map(prize => {
                const probability = totalPacks > 0 ? (prize.count / totalPacks * 100).toFixed(2) : '0.00';
                const imageHtml = prize.image
                    ? `<img src="${prize.image}" alt="${prize.name}" style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.1); margin-right: 10px;" onerror="this.style.display='none';">`
                    : `<div style="width: 40px; height: 60px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.1); display: inline-flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 10px; vertical-align: middle;">📦</div>`;

                return `
                    <div class="result-row" style="display: flex; align-items: center;">
                        ${imageHtml}
                        <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                            <span class="result-label">${prize.rank}等 ${prize.name}</span>
                            <span class="result-value">${prize.count}枚 / ${probability}% (仕入¥${prize.purchasePrice.toLocaleString()} / 還元¥${prize.value.toLocaleString()})</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ハズレ詳細更新
        function updateLossDetails(lossTypes, lossCount) {
            const container = document.getElementById('lossDetailsContainer');
            
            if (!lossTypes || lossTypes.length === 0) {
                container.innerHTML = '<div class="result-row"><span class="result-label">ハズレなし</span><span class="result-value">-</span></div>';
                document.getElementById('totalLossCount').textContent = '0枚';
                return;
            }

            container.innerHTML = lossTypes.map(loss => {
                const probability = lossCount > 0 ? ((loss.count / lossCount) * 100).toFixed(1) : '0.0';
                return `
                    <div class="result-row">
                        <span class="result-label">${loss.name}</span>
                        <span class="result-value">¥${loss.value.toLocaleString()} × ${loss.count}枚 (${probability}%)</span>
                    </div>
                `;
            }).join('');

            document.getElementById('totalLossCount').textContent = `${lossCount}枚`;
        }



        // ハズレ当選者分布チャート描画
        function drawLossDistributionChart(lossTypes) {
            const canvas = document.getElementById('lossDistributionChart');
            const ctx = canvas.getContext('2d');
            
            // キャンバスをクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!lossTypes || lossTypes.length === 0) {
                ctx.fillStyle = '#8E8E93';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ハズレなし', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const padding = 40;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF'];
            const total = lossTypes.reduce((sum, loss) => sum + loss.count, 0);
            
            if (total === 0) return;
            
            // 棒グラフとして描画
            const barWidth = width / lossTypes.length * 0.8;
            const barSpacing = width / lossTypes.length * 0.2;
            const maxCount = Math.max(...lossTypes.map(loss => loss.count));
            
            lossTypes.forEach((loss, index) => {
                const x = padding + index * (barWidth + barSpacing) + barSpacing / 2;
                const barHeight = (loss.count / maxCount) * height;
                const y = canvas.height - padding - barHeight;
                
                // 棒を描画
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // 枚数を表示
                ctx.fillStyle = '#000000';
                ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(loss.count + '枚', x + barWidth / 2, y - 5);
                
                // 名前を表示
                ctx.fillText(loss.name, x + barWidth / 2, canvas.height - 10);
                
                // 割合を表示
                const percentage = ((loss.count / total) * 100).toFixed(1);
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(percentage + '%', x + barWidth / 2, y + barHeight / 2);
            });
            
            // チャートタイトル
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ハズレ当選者分布', canvas.width / 2, 20);
        }

        // 設定検証とエラー表示
        function validateSettings() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

            // エラー状態をリセット
            document.getElementById('totalPacks').classList.remove('error');

            let hasError = false;
            let errorMessages = [];

            // 景品枚数が総口数を超えているかチェック
            if (prizesTotalCount > totalPacks) {
                document.getElementById('totalPacks').classList.add('error');
                hasError = true;
                errorMessages.push(`景品の総枚数（${prizesTotalCount}枚）が総口数（${totalPacks}口）を超えています。`);
            }

            if (hasError) {
                showErrorPopup(errorMessages);
                return false;
            }

            return true;
        }

        // エラーポップアップ表示
        function showErrorPopup(messages) {
            const errorMessage = messages.join('\n\n');
            alert(`⚠️ 設定にエラーがあります\n\n${errorMessage}`);
        }

        // 警告表示更新（軽微な警告用）
        function updateWarnings(data) {
            const warningsContainer = document.getElementById('warnings');
            const warnings = [];

            // 必要に応じて警告を追加できます

            warningsContainer.innerHTML = warnings.join('');
        }



        // データ保存（景品とハズレ）
        function saveData() {
            const data = {
                prizes: prizes,
                losses: losses,
                settings: {
                    packPrice: document.getElementById('packPrice').value,
                    totalPacks: document.getElementById('totalPacks').value,
                    minGuaranteeValue: document.getElementById('minGuaranteeValue').value
                }
            };

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('保存に失敗しました:', e);
            }
        }

        // データ読み込み（景品とハズレ）
        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);

                    if (data.prizes) {
                        prizes = data.prizes;
                        updatePrizeList();
                    }

                    if (data.losses) {
                        losses = data.losses;
                        updateLossList();
                    }

                    if (data.settings) {
                        document.getElementById('packPrice').value = data.settings.packPrice || '40000';
                        document.getElementById('totalPacks').value = data.settings.totalPacks || '100';
                        document.getElementById('minGuaranteeValue').value = data.settings.minGuaranteeValue || '1';
                    }
                }
            } catch (e) {
                console.error('データの読み込みに失敗しました:', e);
            }
        }

        // ガチャ体験機能
        let gachaDrawHistory = [];
        let gachaPool = [];

        // ガチャプール生成
        function generateGachaPool() {
            gachaPool = [];
            
            // 景品を追加
            prizes.forEach(prize => {
                for (let i = 0; i < prize.count; i++) {
                    gachaPool.push({
                        type: 'prize',
                        item: prize
                    });
                }
            });
            
            // 現在の設定でハズレを計算
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;

            if (totalPacks > 0) {
                const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);
                const remainingSlots = totalPacks - prizesTotalCount;

                console.log('ガチャプール生成デバッグ:', {
                    totalPacks: totalPacks,
                    prizesTotalCount: prizesTotalCount,
                    remainingSlots
                });

                // 手動ハズレが設定されている場合
                if (losses.length > 0) {
                    losses.forEach(loss => {
                        console.log(`${loss.name} 生成:`, { count: loss.count, value: loss.value });
                        for (let j = 0; j < loss.count; j++) {
                            gachaPool.push({
                                type: 'loss',
                                item: {
                                    name: loss.name,
                                    value: loss.value,
                                    rank: 'loss'
                                }
                            });
                        }
                    });
                } else if (remainingSlots > 0) {
                    // 自動計算モード
                    const adjustedMinValue = Math.max(1, Math.round(minGuaranteeValue));

                    for (let j = 0; j < remainingSlots; j++) {
                        gachaPool.push({
                            type: 'loss',
                            item: {
                                name: 'ハズレ（最低保証）',
                                value: adjustedMinValue,
                                rank: 'loss'
                            }
                        });
                    }
                } else {
                    console.log('ハズレ生成スキップ:', { remainingSlots, reason: 'remainingSlots <= 0' });
                }
            }
            
            // プールをシャッフル
            for (let i = gachaPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gachaPool[i], gachaPool[j]] = [gachaPool[j], gachaPool[i]];
            }
            
            console.log('ガチャプール生成完了:', {
                totalItems: gachaPool.length,
                prizes: gachaPool.filter(item => item.type === 'prize').length,
                losses: gachaPool.filter(item => item.type === 'loss').length,
                expectedTotal: totalPacks
            });

            // 最終的なサイズチェック
            if (gachaPool.length !== totalPacks) {
                console.error('ガチャプールサイズエラー:', {
                    expected: totalPacks,
                    actual: gachaPool.length,
                    difference: gachaPool.length - totalPacks
                });
            }
        }

        // ガチャを引く
        function drawGacha(count) {
            if (gachaPool.length === 0) {
                alert('先にシミュレーション実行をしてガチャの設定を完了してください');
                return;
            }
            
            // ガチャプールのサイズチェック
            const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
            if (gachaPool.length !== totalPacks) {
                console.warn('ガチャプールサイズが設定と異なります:', {
                    expected: totalPacks,
                    actual: gachaPool.length
                });
            }
            
            if (gachaPool.length < count) {
                alert(`残り${gachaPool.length}枚しかありません`);
                count = gachaPool.length;
            }
            
            const draws = [];
            for (let i = 0; i < count; i++) {
                if (gachaPool.length > 0) {
                    const drawnItem = gachaPool.shift();
                    console.log('ガチャ結果:', drawnItem);
                    draws.push(drawnItem);
                    gachaDrawHistory.push(drawnItem);
                }
            }
            
            updateGachaResults();
            
            // リセットボタンを表示
            document.getElementById('resetGachaBtn').style.display = 'block';
            document.getElementById('gachaResults').style.display = 'block';
        }

        // ガチャ結果を更新
        function updateGachaResults() {
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            
            // 統計計算
            const totalDraws = gachaDrawHistory.length;
            const prizeCount = gachaDrawHistory.filter(draw => draw.type === 'prize').length;
            const totalValue = gachaDrawHistory.reduce((sum, draw) => sum + draw.item.value, 0);
            const totalCost = totalDraws * packPrice;
            const profit = totalValue - totalCost;
            
            // 統計表示
            document.getElementById('gachaStats').innerHTML = `
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${totalDraws}</div>
                    <div class="gacha-stat-label">総引き回数</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">${prizeCount}</div>
                    <div class="gacha-stat-label">当選回数</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value">¥${totalValue.toLocaleString()}</div>
                    <div class="gacha-stat-label">総還元価値</div>
                </div>
                <div class="gacha-stat-item">
                    <div class="gacha-stat-value" style="color: ${profit >= 0 ? 'var(--sf-green)' : 'var(--sf-red)'}">
                        ${profit >= 0 ? '+' : ''}¥${profit.toLocaleString()}
                    </div>
                    <div class="gacha-stat-label">収支</div>
                </div>
            `;
            
            // 履歴表示（最新10件）
            const recentDraws = gachaDrawHistory.slice(-10).reverse();
            document.getElementById('gachaHistory').innerHTML = `
                <h5 style="margin-bottom: 10px;">最新の引き結果</h5>
                ${recentDraws.map(draw => `
                    <div class="gacha-draw-item ${draw.type === 'prize' ? 'gacha-draw-prize' : 'gacha-draw-loss'}">
                        <span>${draw.item.name}</span>
                        <span>¥${draw.item.value.toLocaleString()}</span>
                    </div>
                `).join('')}
            `;
        }

        // ガチャリセット
        function resetGacha() {
            if (confirm('ガチャ結果をリセットしますか？')) {
                gachaDrawHistory = [];
                generateGachaPool();
                document.getElementById('resetGachaBtn').style.display = 'none';
                document.getElementById('gachaResults').style.display = 'none';
            }
        }

        // シミュレーション実行時にガチャプールも生成
        const originalCalculate = calculate;
        calculate = function() {
            originalCalculate();
            generateGachaPool();
        };

        // ==================== タブ機能 ====================
        let currentTab = 'main';

        // タブ切り替え
        function switchTab(tabName, event) {
            currentTab = tabName;

            // すべてのタブボタンとタブコンテンツの active クラスを削除
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // 選択されたタブのボタンとコンテンツに active クラスを追加
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById('tab-' + tabName).classList.add('active');

            // 景品一覧タブが表示された時は景品一覧を更新
            if (tabName === 'prize-list') {
                updatePrizeMasterList();
                // Firebase認証を開始（初回のみ）
                initializeAuth();
            }

            // オリパ自動作成タブが表示された時
            if (tabName === 'auto-create') {
                // 特に何もしない（必要に応じて処理を追加）
            }
        }

        // ==================== 景品一覧機能 ====================
        let editingMasterPrizeId = null; // 編集中の景品ID（景品一覧用）
        let prizeMaster = []; // 景品マスター（クラウドから取得した全景品）
        const PRIZE_MASTER_STORAGE_KEY = 'oripa_prize_master_v1';

        // 景品マスターを読み込み
        function loadPrizeMaster() {
            try {
                const savedData = localStorage.getItem(PRIZE_MASTER_STORAGE_KEY);
                if (savedData) {
                    prizeMaster = JSON.parse(savedData);
                }
            } catch (e) {
                console.error('景品マスターの読み込みに失敗しました:', e);
            }
        }

        // 景品マスターを保存（localStorageとFirebaseの両方）
        function savePrizeMaster() {
            try {
                // localStorageに保存（バックアップ）
                localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));

                // Firebaseに保存（クラウド共有）
                savePrizeMasterToCloud();
            } catch (e) {
                console.error('景品マスターの保存に失敗しました:', e);
            }
        }

        // 景品マスターをFirebaseに保存
        function savePrizeMasterToCloud() {
            if (typeof database === 'undefined') {
                console.warn('Firebaseが初期化されていません');
                return;
            }

            // 認証完了を待つ
            if (!isAuthReady) {
                waitForAuth(() => savePrizeMasterToCloud());
                return;
            }

            try {
                const data = {
                    prizes: prizeMaster,
                    updatedAt: Date.now(),
                    version: '1.0'
                };

                database.ref('prizeMaster').set(data).then(() => {
                    console.log('景品マスターをクラウドに保存しました');
                    updateSyncStatus('✅ クラウドに保存済み');
                }).catch((error) => {
                    console.error('Firebaseへの保存に失敗しました:', error);
                    console.error('エラー詳細:', error.code, error.message);

                    let errorMsg = '❌ 保存失敗';
                    if (error.code === 'PERMISSION_DENIED') {
                        errorMsg = '❌ 権限がありません';
                        console.error('⚠️ Firebase Consoleでデータベースルールを確認してください');
                        console.error('ルール例: { "rules": { "prizeMaster": { ".read": "auth != null", ".write": "auth != null" } } }');
                        alert('❌ クラウド保存に失敗しました\n\nFirebase Realtime Databaseのルール設定を確認してください。\n\n手順：\n1. Firebase Console を開く\n2. Realtime Database > ルール\n3. 認証済みユーザーの読み書きを許可する');
                    }
                    updateSyncStatus(errorMsg);
                });
            } catch (e) {
                console.error('クラウド保存エラー:', e);
            }
        }

        // 景品マスターをFirebaseから読み込み（初回専用）
        let isFirstLoadDone = false;
        function loadPrizeMasterFromCloudOnce() {
            if (isFirstLoadDone) return;
            isFirstLoadDone = true;

            updateSyncStatus('🔄 データ読み込み中... (75%)');

            database.ref('prizeMaster').once('value').then((snapshot) => {
                const data = snapshot.val();

                if (data && data.prizes) {
                    prizeMaster = data.prizes;

                    // localStorageにも保存（バックアップ）
                    try {
                        localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));
                    } catch (e) {
                        console.error('localStorageへの保存に失敗:', e);
                    }

                    updatePrizeMasterList();

                    const updateDate = new Date(data.updatedAt);
                    console.log(`クラウドから景品マスターを読み込みました (${prizeMaster.length}件, 更新日時: ${updateDate.toLocaleString('ja-JP')})`);
                    updateSyncStatus('🔄 リアルタイム同期開始中... (90%)');

                    // リアルタイム同期を開始
                    startRealtimeSyncOnce();
                } else {
                    console.log('クラウドに景品マスターが見つかりませんでした');
                    loadPrizeMaster(); // localStorageから読み込み
                    updateSyncStatus('✅ 準備完了 (100%)');

                    // リアルタイム同期を開始
                    startRealtimeSyncOnce();
                }
            }).catch((error) => {
                console.error('Firebaseからの読み込みに失敗しました:', error);

                let errorMsg = '❌ 同期失敗';
                if (error.code === 'PERMISSION_DENIED') {
                    errorMsg = '❌ 読み込み権限がありません';
                    console.error('⚠️ Firebase Consoleでデータベースルールを確認してください');
                    console.error('ルール例: { "rules": { "prizeMaster": { ".read": "auth != null", ".write": "auth != null" } } }');
                }
                updateSyncStatus(errorMsg);

                loadPrizeMaster(); // localStorageから読み込み
            });
        }

        // 景品マスターをFirebaseから読み込み（手動同期用）
        function loadPrizeMasterFromCloud() {
            if (typeof database === 'undefined') {
                console.warn('Firebaseが初期化されていません');
                loadPrizeMaster(); // localStorageから読み込み
                return;
            }

            // 認証完了を待つ
            if (!isAuthReady) {
                waitForAuth(() => loadPrizeMasterFromCloud());
                return;
            }

            updateSyncStatus('🔄 同期中...');

            database.ref('prizeMaster').once('value').then((snapshot) => {
                const data = snapshot.val();

                if (data && data.prizes) {
                    prizeMaster = data.prizes;

                    // localStorageにも保存（バックアップ）
                    try {
                        localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));
                    } catch (e) {
                        console.error('localStorageへの保存に失敗:', e);
                    }

                    updatePrizeMasterList();

                    const updateDate = new Date(data.updatedAt);
                    console.log(`クラウドから景品マスターを読み込みました (${prizeMaster.length}件, 更新日時: ${updateDate.toLocaleString('ja-JP')})`);
                    updateSyncStatus(`✅ 同期完了 (${prizeMaster.length}件)`);
                } else {
                    console.log('クラウドに景品マスターが見つかりませんでした');
                    loadPrizeMaster(); // localStorageから読み込み
                    updateSyncStatus('📭 クラウドは空です');
                }
            }).catch((error) => {
                console.error('Firebaseからの読み込みに失敗しました:', error);

                let errorMsg = '❌ 同期失敗';
                if (error.code === 'PERMISSION_DENIED') {
                    errorMsg = '❌ 読み込み権限がありません';
                    console.error('⚠️ Firebase Consoleでデータベースルールを確認してください');
                }
                updateSyncStatus(errorMsg);

                loadPrizeMaster(); // localStorageから読み込み
            });
        }

        // 同期ステータスを更新
        function updateSyncStatus(message) {
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.opacity = '1';

                // 5秒後にフェードアウト
                setTimeout(() => {
                    statusElement.style.opacity = '0.5';
                }, 5000);
            }
        }

        // リアルタイム同期を開始（初回専用）
        let isRealtimeSyncStarted = false;
        function startRealtimeSyncOnce() {
            if (isRealtimeSyncStarted) return;
            isRealtimeSyncStarted = true;

            // Firebaseのリアルタイムリスナーを設定
            database.ref('prizeMaster').on('value', (snapshot) => {
                const data = snapshot.val();

                if (data && data.prizes) {
                    const remoteUpdateTime = data.updatedAt;
                    const localUpdateTime = localStorage.getItem('prizeMaster_lastUpdate');

                    // リモートの方が新しい場合のみ更新
                    if (!localUpdateTime || remoteUpdateTime > parseInt(localUpdateTime)) {
                        prizeMaster = data.prizes;

                        // localStorageにも保存
                        try {
                            localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));
                            localStorage.setItem('prizeMaster_lastUpdate', remoteUpdateTime.toString());
                        } catch (e) {
                            console.error('localStorageへの保存に失敗:', e);
                        }

                        updatePrizeMasterList();
                        console.log('クラウドから最新データを取得しました');
                        updateSyncStatus(`✅ 同期完了 (${prizeMaster.length}件)`);
                    }
                }
            });

            console.log('リアルタイム同期を開始しました');
            updateSyncStatus(`✅ リアルタイム同期中 (${prizeMaster.length}件)`);
        }

        // リアルタイム同期を開始（従来の関数、互換性のため残す）
        function startRealtimeSync() {
            if (typeof database === 'undefined') {
                console.warn('Firebaseが初期化されていません');
                return;
            }

            // 認証完了を待つ
            if (!isAuthReady) {
                waitForAuth(() => startRealtimeSync());
                return;
            }

            startRealtimeSyncOnce();
        }


        // 手動で同期
        function manualSyncPrizeMaster() {
            if (typeof database === 'undefined') {
                alert('Firebaseが初期化されていません。\nページを再読み込みしてください。');
                return;
            }

            updateSyncStatus('🔄 同期中...');

            database.ref('prizeMaster').once('value').then((snapshot) => {
                const data = snapshot.val();

                if (data && data.prizes) {
                    prizeMaster = data.prizes;

                    // localStorageにも保存
                    try {
                        localStorage.setItem(PRIZE_MASTER_STORAGE_KEY, JSON.stringify(prizeMaster));
                        localStorage.setItem('prizeMaster_lastUpdate', data.updatedAt.toString());
                    } catch (e) {
                        console.error('localStorageへの保存に失敗:', e);
                    }

                    updatePrizeMasterList();

                    const updateDate = new Date(data.updatedAt);
                    alert(`✅ クラウドから最新データを取得しました。\n\n景品数: ${prizeMaster.length}件\n最終更新: ${updateDate.toLocaleString('ja-JP')}`);
                    updateSyncStatus(`✅ 同期完了 (${prizeMaster.length}件)`);
                } else {
                    alert('クラウドに景品マスターが見つかりませんでした。');
                    updateSyncStatus('📭 クラウドは空です');
                }
            }).catch((error) => {
                console.error('同期エラー:', error);

                let errorMsg = '❌ 同期失敗';
                let alertMsg = `❌ 同期に失敗しました。\n\nエラー: ${error.message}`;

                if (error.code === 'PERMISSION_DENIED') {
                    errorMsg = '❌ 読み込み権限がありません';
                    alertMsg = '❌ クラウド同期に失敗しました\n\n' +
                        'Firebase Realtime Databaseの権限設定を確認してください。\n\n' +
                        '手順：\n' +
                        '1. Firebase Console を開く\n' +
                        '2. Realtime Database > ルール\n' +
                        '3. 以下のルールを設定:\n' +
                        '{\n' +
                        '  "rules": {\n' +
                        '    "prizeMaster": {\n' +
                        '      ".read": "auth != null",\n' +
                        '      ".write": "auth != null"\n' +
                        '    }\n' +
                        '  }\n' +
                        '}';
                    console.error('⚠️ Firebase Consoleでデータベースルールを確認してください');
                }

                alert(alertMsg);
                updateSyncStatus(errorMsg);
            });
        }

        // ==================== JSON エクスポート/インポート機能 ====================

        // 景品をJSONでエクスポート（メインタブの景品）
        function exportPrizesToJSON() {
            if (prizes.length === 0) {
                alert('エクスポートする景品がありません。\n先に景品を追加してください。');
                return;
            }

            // JSONデータを作成
            const jsonData = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                prizes: prizes.map(prize => ({
                    name: prize.name,
                    purchasePrice: prize.purchasePrice,
                    value: prize.value,
                    count: prize.count
                }))
            };

            // JSON文字列に変換（整形あり）
            const jsonString = JSON.stringify(jsonData, null, 2);

            // Blobを作成
            const blob = new Blob([jsonString], { type: 'application/json' });

            // ダウンロードリンクを作成
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // ファイル名を生成（日時付き）
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 5).replace(/:/g, '');
            a.download = `oripa_prizes_${dateStr}_${timeStr}.json`;

            // ダウンロードを実行
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`✅ ${prizes.length}件の景品をJSONファイルでエクスポートしました。\n\nファイル: ${a.download}`);
        }

        // JSONファイルから景品をインポート（景品マスターに追加）
        // データファイルから景品をインポート（JSON/CSV自動判定）
        async function importPrizesFromFile(event) {
            const files = Array.from(event.target.files);
            if (!files || files.length === 0) return;

            // ファイルを拡張子ごとに分類
            const jsonFiles = files.filter(f => f.name.toLowerCase().endsWith('.json'));
            const csvFiles = files.filter(f => f.name.toLowerCase().endsWith('.csv'));

            // JSONファイルがある場合は処理
            if (jsonFiles.length > 0) {
                const jsonEvent = { target: { files: jsonFiles } };
                await importPrizesFromJSON(jsonEvent);
            }

            // CSVファイルがある場合は処理
            if (csvFiles.length > 0) {
                for (const csvFile of csvFiles) {
                    const csvEvent = { target: { files: [csvFile] } };
                    await importPrizesFromCSV(csvEvent);
                }
            }

            // ファイル入力をクリア（同じファイルを再度選択できるように）
            event.target.value = '';
        }

        async function importPrizesFromJSON(event) {
            const files = Array.from(event.target.files);
            if (!files || files.length === 0) return;

            // 全ファイルの集計用
            let totalAddedCount = 0;
            let totalMergedCount = 0;
            let totalOverwriteCount = 0;
            let totalSkippedCount = 0;
            let totalPrizesRead = 0;
            let failedFiles = [];

            // 各ファイルを処理
            for (let fileIndex = 0; fileIndex < files.length; fileIndex++) {
                const file = files[fileIndex];

                try {
                    // ファイル読み込みをPromiseでラップ
                    const jsonData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();

                        reader.onload = function(e) {
                            try {
                                const data = JSON.parse(e.target.result);
                                resolve(data);
                            } catch (error) {
                                reject(error);
                            }
                        };

                        reader.onerror = function() {
                            reject(new Error('ファイルの読み込みに失敗'));
                        };

                        reader.readAsText(file);
                    });

                    // データの検証
                    if (!jsonData.prizes || !Array.isArray(jsonData.prizes)) {
                        failedFiles.push({name: file.name, reason: '無効なJSONフォーマット'});
                        continue;
                    }

                    totalPrizesRead += jsonData.prizes.length;

                    // 各景品を処理
                    for (const prize of jsonData.prizes) {
                        // データの検証
                        if (!prize.name || prize.purchasePrice === undefined || prize.value === undefined) {
                            console.warn('不完全な景品データをスキップ:', prize);
                            totalSkippedCount++;
                            continue;
                        }

                        // 完全一致チェック（名前、仕入れ価格、還元価値が全て同じ）
                        const exactMatch = prizeMaster.find(p =>
                            p.name === prize.name &&
                            p.purchasePrice === prize.purchasePrice &&
                            p.value === prize.value
                        );

                        if (exactMatch) {
                            // 完全一致の場合：countを統合
                            exactMatch.count = (exactMatch.count || 1) + (prize.count || 1);
                            totalMergedCount++;
                            console.log(`統合: ${prize.name} - count: ${exactMatch.count}`);
                            continue;
                        }

                        // 名前だけが同じ景品をチェック
                        const nameMatch = prizeMaster.find(p => p.name === prize.name);

                        if (nameMatch) {
                            // 名前が同じだが他の属性が異なる
                            const action = await showDuplicateDialog(nameMatch, prize);

                            if (action === 'overwrite') {
                                // 上書き
                                const index = prizeMaster.findIndex(p => p.id === nameMatch.id);
                                prizeMaster[index] = {
                                    ...nameMatch,
                                    purchasePrice: prize.purchasePrice,
                                    value: prize.value,
                                    count: prize.count || 1,
                                    updatedAt: Date.now()
                                };
                                totalOverwriteCount++;
                                console.log(`上書き: ${prize.name}`);
                            } else if (action === 'separate') {
                                // 別々に保存
                                prizeMaster.push({
                                    id: Date.now() + Math.random(),
                                    name: prize.name,
                                    purchasePrice: prize.purchasePrice,
                                    value: prize.value,
                                    count: prize.count || 1,
                                    sourceFile: file.name,
                                    addedAt: Date.now()
                                });
                                totalAddedCount++;
                                console.log(`別々に保存: ${prize.name}`);
                            } else {
                                // スキップ
                                totalSkippedCount++;
                                console.log(`スキップ: ${prize.name}`);
                            }
                        } else {
                            // 新しい景品として追加
                            prizeMaster.push({
                                id: Date.now() + Math.random(),
                                name: prize.name,
                                purchasePrice: prize.purchasePrice,
                                value: prize.value,
                                count: prize.count || 1,
                                sourceFile: file.name,
                                addedAt: Date.now()
                            });
                            totalAddedCount++;
                        }
                    }

                } catch (error) {
                    console.error(`${file.name} のパースエラー:`, error);
                    failedFiles.push({name: file.name, reason: error.message});
                }
            }

            // 保存と更新
            savePrizeMaster();
            updatePrizeMasterList();

            // 結果を表示（複数ファイル対応）
            const totalProcessed = totalAddedCount + totalMergedCount + totalOverwriteCount + totalSkippedCount;
            const successFiles = files.length - failedFiles.length;

            let message = `🎉 アップロード完了！\n\n`;
            message += `【ファイル】\n`;
            message += `  📂 選択: ${files.length}ファイル\n`;
            message += `  ✅ 成功: ${successFiles}ファイル\n`;
            if (failedFiles.length > 0) {
                message += `  ❌ 失敗: ${failedFiles.length}ファイル\n`;
            }
            message += `\n`;

            message += `【処理結果】\n`;
            message += `  📥 読み込んだ景品: ${totalPrizesRead}件\n`;
            message += `  ✅ 処理成功: ${totalProcessed}件\n\n`;

            message += `【内訳】\n`;
            message += `  🆕 新規追加: ${totalAddedCount}件\n`;
            if (totalMergedCount > 0) {
                message += `  🔗 統合（完全一致）: ${totalMergedCount}件\n`;
            }
            if (totalOverwriteCount > 0) {
                message += `  ♻️ 上書き: ${totalOverwriteCount}件\n`;
            }
            if (totalSkippedCount > 0) {
                message += `  ⏭️ スキップ: ${totalSkippedCount}件\n`;
            }

            if (failedFiles.length > 0) {
                message += `\n【失敗したファイル】\n`;
                failedFiles.forEach(f => {
                    message += `  ❌ ${f.name}\n     理由: ${f.reason}\n`;
                });
            }

            message += `\n【現在の状態】\n`;
            message += `  📦 景品マスター総数: ${prizeMaster.length}件\n`;
            message += `  💾 ローカルストレージ: 保存済み\n`;
            message += `  ☁️ クラウド同期: 進行中...\n`;

            message += `\n✨ アップロードは正常に完了しました！`;

            alert(message);

            // クラウド同期完了後にステータスを更新
            setTimeout(() => {
                updateSyncStatus(`✅ 最新 (${prizeMaster.length}件)`);
            }, 1000);

            // inputをリセット（同じファイルを再度選択できるように）
            event.target.value = '';
        }

        // 重複景品の処理方法を選択するダイアログ
        function showDuplicateDialog(existingPrize, newPrize) {
            return new Promise((resolve) => {
                const message = `同じ名前の景品「${existingPrize.name}」が既に登録されています。\n\n` +
                    `【既存の景品】\n` +
                    `  仕入れ価格: ¥${existingPrize.purchasePrice.toLocaleString()}\n` +
                    `  還元価値: ¥${existingPrize.value.toLocaleString()}\n` +
                    `  在庫数: ${existingPrize.count}個\n\n` +
                    `【新しい景品】\n` +
                    `  仕入れ価格: ¥${newPrize.purchasePrice.toLocaleString()}\n` +
                    `  還元価値: ¥${newPrize.value.toLocaleString()}\n` +
                    `  在庫数: ${newPrize.count || 1}個\n\n` +
                    `どのように処理しますか？\n\n` +
                    `[1] 上書きする（既存の情報を新しい情報で置き換える）\n` +
                    `[2] 別々に保存する（両方とも保持する）\n` +
                    `[3] スキップする（新しい景品を追加しない）`;

                // カスタムダイアログの代わりに、シンプルなpromptを使用
                const choice = prompt(message + '\n\n数字を入力してください (1, 2, または 3):', '2');

                if (choice === '1') {
                    resolve('overwrite');
                } else if (choice === '2') {
                    resolve('separate');
                } else {
                    resolve('skip');
                }
            });
        }

        // CSVから景品をインポート
        async function importPrizesFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                // ファイルを読み込む
                const csvText = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('ファイルの読み込みに失敗'));
                    reader.readAsText(file, 'UTF-8');
                });

                // CSVをパース（1行目はヘッダー）
                const lines = csvText.split('\n');
                if (lines.length < 2) {
                    alert('❌ CSVファイルにデータがありません');
                    return;
                }

                let addedCount = 0;
                let mergedCount = 0;
                let skippedCount = 0;
                let errorCount = 0;
                let imageDownloadCount = 0;
                let imageFailCount = 0;

                const totalLines = lines.length - 1; // ヘッダーを除く

                // 進捗表示用のアラートを表示
                console.log(`CSVインポート開始: ${totalLines}行を処理します`);

                // ヘッダーをスキップして2行目から処理
                for (let i = 1; i < lines.length; i++) {
                    // 進捗をコンソールに表示
                    if (i % 10 === 0) {
                        console.log(`進捗: ${i}/${totalLines}行処理完了...`);
                    }
                    const line = lines[i].trim();
                    if (!line) continue; // 空行をスキップ

                    try {
                        // CSVの列を解析（カンマ区切り、ただしダブルクォートで囲まれた部分は無視）
                        const columns = parseCSVLine(line);

                        if (columns.length < 9) {
                            console.warn(`行${i + 1}: 列数が不足しています (${columns.length}列)`);
                            skippedCount++;
                            continue;
                        }

                        // 必要な情報を抽出
                        const name = columns[0].trim();
                        const stockText = columns[1].trim();
                        const imageUrl = columns[2].trim();
                        const priceText = columns[7].trim(); // 販売価格
                        const valueText = columns[8].trim(); // 還元ポイント設定

                        // 最初の3行はデバッグ出力
                        if (i <= 3) {
                            console.log(`行${i + 1}:`, {
                                name,
                                stock: stockText,
                                imageUrl: imageUrl.substring(0, 60),
                                price: priceText,
                                value: valueText
                            });
                        }

                        // 名前が空の場合はスキップ
                        if (!name) {
                            skippedCount++;
                            continue;
                        }

                        // 在庫数を数値化（空の場合は0）
                        const count = stockText ? parseInt(stockText) : 0;

                        // 販売価格と還元ポイントから￥と,を除去して数値化
                        const purchasePrice = parsePrice(priceText);
                        const value = parsePrice(valueText);

                        // 価格が0または無効な場合はスキップ
                        if (purchasePrice <= 0 || value <= 0) {
                            console.warn(`行${i + 1}: 無効な価格データ - ${name}`);
                            skippedCount++;
                            continue;
                        }

                        // 既存の景品と完全一致チェック
                        const exactMatch = prizeMaster.find(p =>
                            p.name === name &&
                            p.purchasePrice === purchasePrice &&
                            p.value === value
                        );

                        if (exactMatch) {
                            // 在庫を統合
                            exactMatch.count = (exactMatch.count || 0) + count;
                            mergedCount++;
                            console.log(`統合: ${name} - count: ${exactMatch.count}`);
                        } else {
                            // 画像URLをそのまま保存（Base64変換しない）
                            const imageData = (imageUrl && imageUrl.startsWith('http')) ? imageUrl : null;

                            if (imageData) {
                                imageDownloadCount++;
                                console.log(`✓ 画像URL保存: ${name} - ${imageUrl.substring(0, 60)}...`);
                            }

                            // 新規景品として追加
                            const newPrize = {
                                id: Date.now() + Math.random(),
                                name: name,
                                purchasePrice: purchasePrice,
                                value: value,
                                count: count,
                                type: 'PSA10', // CSVインポート時はデフォルト値
                                isWanted: false, // CSVインポート時はデフォルト値
                                image: imageData, // 画像URLまたはnull
                                addedAt: Date.now(),
                                sourceFile: file.name
                            };

                            prizeMaster.push(newPrize);
                            addedCount++;
                            console.log(`追加: ${name} - ¥${purchasePrice.toLocaleString()} - 画像URL: ${imageData ? 'あり' : 'なし'}`);
                        }
                    } catch (rowError) {
                        console.error(`行${i + 1}の処理中にエラー:`, rowError);
                        errorCount++;
                    }
                }

                // 景品マスターを保存
                savePrizeMaster();
                updatePrizeMasterList();

                // 結果を表示
                const resultMessage = `✅ CSVインポート完了！\n\n` +
                    `📊 処理結果:\n` +
                    `・新規追加: ${addedCount}件\n` +
                    `・在庫統合: ${mergedCount}件\n` +
                    `・スキップ: ${skippedCount}件\n` +
                    (errorCount > 0 ? `・エラー: ${errorCount}件\n` : '') +
                    `\n🖼️ 画像ダウンロード:\n` +
                    `・成功: ${imageDownloadCount}件\n` +
                    `・失敗: ${imageFailCount}件\n` +
                    `\n合計: ${addedCount + mergedCount}件の景品を登録しました`;

                alert(resultMessage);

            } catch (error) {
                console.error('CSVインポートエラー:', error);
                alert(`❌ CSVファイルの読み込みに失敗しました\n\nエラー: ${error.message}`);
            }

            // ファイル入力をリセット
            event.target.value = '';
        }

        // CSV行をパースする関数（ダブルクォート対応）
        function parseCSVLine(line) {
            const columns = [];
            let currentColumn = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    columns.push(currentColumn);
                    currentColumn = '';
                } else {
                    currentColumn += char;
                }
            }

            // 最後の列を追加
            columns.push(currentColumn);

            return columns;
        }

        // 価格文字列をパースする関数（￥と,を除去）
        function parsePrice(priceText) {
            if (!priceText) return 0;
            // ￥と,を除去して数値化
            const cleaned = priceText.replace(/[￥,]/g, '').trim();
            const number = parseInt(cleaned);
            return isNaN(number) ? 0 : number;
        }

        // HTMLエスケープ関数
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, (m) => map[m]);
        }

        // 画像URLからBase64に変換する関数
        async function downloadImageAsBase64(imageUrl) {
            try {
                // CORSプロキシを使用して画像を取得
                // 注: 本番環境では適切なCORSプロキシまたはバックエンドを使用してください
                const corsProxy = 'https://corsproxy.io/?';
                const proxyUrl = corsProxy + encodeURIComponent(imageUrl);

                const response = await fetch(proxyUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const blob = await response.blob();

                // BlobをBase64に変換
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('画像ダウンロードエラー:', error);
                throw error;
            }
        }

        // クリア確認モーダルを開く
        function clearPrizeMaster() {
            console.log('クリア確認モーダルを開きます');
            document.getElementById('clearConfirmInput').value = '';
            document.getElementById('clearConfirmModal').style.display = 'flex';
        }

        // クリア確認モーダルを閉じる
        function closeClearConfirmModal() {
            document.getElementById('clearConfirmModal').style.display = 'none';
            document.getElementById('clearConfirmInput').value = '';
        }

        // 実際のクリア処理を実行
        function executeClearPrizeMaster() {
            const input = document.getElementById('clearConfirmInput').value;

            if (input !== 'クリア') {
                alert('❌ 「クリア」と正確に入力してください');
                return;
            }

            console.log('景品マスターをクリアします');
            closeClearConfirmModal();

            prizeMaster = [];

            // localStorageをクリア
            try {
                localStorage.removeItem(PRIZE_MASTER_STORAGE_KEY);
                localStorage.removeItem('prizeMaster_lastUpdate');
            } catch (e) {
                console.error('localStorageのクリアに失敗:', e);
            }

            // Firebaseもクリア
            if (typeof database !== 'undefined') {
                database.ref('prizeMaster').remove().then(() => {
                    console.log('クラウドの景品マスターをクリアしました');
                    updateSyncStatus('🗑️ クリア完了');
                }).catch((error) => {
                    console.error('Firebaseのクリアに失敗:', error);
                });
            }

            updatePrizeMasterList();
            alert('✅ 景品マスターをクリアしました。\nクラウドのデータも削除されました。');
        }

        // 景品一覧を更新（景品マスターを表示）
        function updatePrizeMasterList() {
            const listContainer = document.getElementById('prizeMasterList');

            if (prizeMaster.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🎁</div>
                        <div class="empty-state-text">景品マスターが空です</div>
                        <div class="empty-state-subtext">メインタブで景品を作成し、JSONでエクスポート後、ここでインポートしてください</div>
                    </div>
                `;
                return;
            }

            // ソート・フィルター設定を取得
            const sortBy = document.getElementById('prizeMasterSortBy')?.value || 'price';
            const sortOrder = document.getElementById('prizeMasterSortOrder')?.value || 'desc';
            const filterBy = document.getElementById('prizeMasterFilter')?.value || 'all';
            const typeFilter = document.getElementById('prizeMasterTypeFilter')?.value || 'all';
            const wantedFilter = document.getElementById('prizeMasterWantedFilter')?.checked || false;
            const searchText = document.getElementById('prizeMasterSearchText')?.value.trim().toLowerCase() || '';

            // 設定をlocalStorageに保存
            try {
                localStorage.setItem('prizeMasterSortBy', sortBy);
                localStorage.setItem('prizeMasterSortOrder', sortOrder);
                localStorage.setItem('prizeMasterFilter', filterBy);
                localStorage.setItem('prizeMasterTypeFilter', typeFilter);
                localStorage.setItem('prizeMasterWantedFilter', wantedFilter);
                localStorage.setItem('prizeMasterSearchText', searchText);
            } catch (e) {
                console.error('設定の保存に失敗:', e);
            }

            // フィルター処理
            let filteredPrizes = [...prizeMaster];

            // 在庫フィルター
            if (filterBy === 'inStock') {
                filteredPrizes = filteredPrizes.filter(prize => prize.count > 0);
            } else if (filterBy === 'outOfStock') {
                filteredPrizes = filteredPrizes.filter(prize => prize.count === 0);
            }

            // 種類フィルター
            if (typeFilter !== 'all') {
                filteredPrizes = filteredPrizes.filter(prize => (prize.type || 'PSA10') === typeFilter);
            }

            // 欲しいものリストフィルター
            if (wantedFilter) {
                filteredPrizes = filteredPrizes.filter(prize => prize.isWanted === true);
            }

            // 名前検索フィルター
            if (searchText) {
                filteredPrizes = filteredPrizes.filter(prize =>
                    prize.name.toLowerCase().includes(searchText)
                );
            }

            // フィルター後の件数チェック
            if (filteredPrizes.length === 0) {
                const filterLabels = [];
                if (filterBy !== 'all') filterLabels.push(filterBy === 'inStock' ? '在庫あり' : '在庫なし');
                if (typeFilter !== 'all') filterLabels.push(`種類: ${typeFilter}`);
                if (wantedFilter) filterLabels.push('欲しいものリスト');
                if (searchText) filterLabels.push(`検索: "${searchText}"`);

                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <div class="empty-state-text">該当する景品がありません</div>
                        <div class="empty-state-subtext">フィルター条件「${filterLabels.join(', ')}」に一致する景品が見つかりませんでした</div>
                    </div>
                `;
                return;
            }

            // ソート処理
            let sortedPrizes = [...filteredPrizes];

            if (sortBy === 'price') {
                // 仕入れ価格順
                sortedPrizes.sort((a, b) => {
                    if (sortOrder === 'desc') {
                        return b.purchasePrice - a.purchasePrice; // 高い順
                    } else {
                        return a.purchasePrice - b.purchasePrice; // 安い順
                    }
                });
            } else if (sortBy === 'date') {
                // 登録日時順
                sortedPrizes.sort((a, b) => {
                    const dateA = a.addedAt || a.id || 0;
                    const dateB = b.addedAt || b.id || 0;
                    if (sortOrder === 'desc') {
                        return dateB - dateA; // 新しい順
                    } else {
                        return dateA - dateB; // 古い順
                    }
                });
            }

            listContainer.innerHTML = sortedPrizes.map(prize => {
                // 画像URLは直接使用（HTMLエスケープするとURLが壊れる）
                // カードは縦長なので、縦横比を2:3に設定（幅70px × 高さ105px）
                const imageHtml = prize.image
                    ? `<img src="${prize.image}"
                           alt="${escapeHtml(prize.name)}"
                           onclick="openImageViewModal('${prize.image.replace(/'/g, "\\'")}', '${prize.name.replace(/'/g, "\\'")}'); event.stopPropagation();"
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                           style="width: 70px; height: 105px; object-fit: cover; border-radius: var(--radius-md); border: 2px solid rgba(0, 0, 0, 0.1); cursor: pointer; transition: transform 0.2s;"
                           onmouseover="this.style.transform='scale(1.05)'"
                           onmouseout="this.style.transform='scale(1)'">
                       <div style="display: none; width: 70px; height: 105px; background: rgba(255, 0, 0, 0.1); border-radius: var(--radius-md); border: 2px solid rgba(255, 0, 0, 0.3); align-items: center; justify-content: center; font-size: 10px; color: red; text-align: center; padding: 4px;">画像<br>読込<br>失敗</div>`
                    : `<div style="width: 70px; height: 105px; background: rgba(0, 0, 0, 0.05); border-radius: var(--radius-md); border: 2px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; font-size: 32px;">📦</div>`;

                const typeLabel = prize.type || 'PSA10';
                const isWanted = prize.isWanted || false;

                return `
                    <div class="prize-master-item">
                        <div class="prize-master-header">
                            <div style="display: flex; gap: 16px; align-items: center; flex: 1;">
                                ${imageHtml}
                                <div class="prize-master-title" style="flex: 1;">
                                    <div class="prize-master-name">${prize.name}</div>
                                    <div style="display: flex; gap: 8px; margin-top: 6px; align-items: center;">
                                        <span style="display: inline-block; padding: 3px 10px; background: rgba(0, 122, 255, 0.1); color: #007AFF; border-radius: 12px; font-size: 12px; font-weight: 600;">${typeLabel}</span>
                                        <button onclick="event.stopPropagation(); togglePrizeWanted(${prize.id})" style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; background: ${isWanted ? 'rgba(255, 192, 203, 0.3)' : 'rgba(0, 0, 0, 0.05)'}; border: 1.5px solid ${isWanted ? 'rgba(255, 105, 180, 0.6)' : 'rgba(0, 0, 0, 0.1)'}; border-radius: 12px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: ${isWanted ? '#ff1493' : '#999'}; filter: ${isWanted ? 'none' : 'grayscale(100%)'};" title="欲しいものリストに${isWanted ? '追加済み' : '追加'}">❤️${isWanted ? ' 欲しい' : ''}</button>
                                    </div>
                                </div>
                            </div>
                            <div class="prize-master-actions">
                                <button type="button" class="btn btn-primary btn-icon" onclick="event.stopPropagation(); event.preventDefault(); openEditPrizeModal(${prize.id})" title="編集">
                                    ✏️
                                </button>
                                <button type="button" class="btn btn-danger btn-icon" onclick="event.stopPropagation(); event.preventDefault(); deletePrizeFromMaster(${prize.id})" title="削除">
                                    🗑️
                                </button>
                            </div>
                        </div>
                        <div class="prize-master-info">
                            <div class="prize-master-info-item">
                                <div class="prize-master-info-label">仕入れ価格</div>
                                <div class="prize-master-info-value">¥${prize.purchasePrice.toLocaleString()}</div>
                            </div>
                            <div class="prize-master-info-item">
                                <div class="prize-master-info-label">ポイント還元価値</div>
                                <div class="prize-master-info-value">¥${prize.value.toLocaleString()}</div>
                            </div>
                            <div class="prize-master-info-item">
                                <div class="prize-master-info-label">在庫数</div>
                                <div class="prize-master-info-value" style="color: ${prize.count === 0 ? 'var(--sf-red)' : 'inherit'}; font-weight: ${prize.count === 0 ? '600' : 'inherit'};">
                                    ${prize.count}個${prize.count === 0 ? ' (売り切れ)' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 欲しいものバッジをトグル
        function togglePrizeWanted(prizeId) {
            const prizeIndex = prizeMaster.findIndex(p => p.id === prizeId);
            if (prizeIndex !== -1) {
                prizeMaster[prizeIndex].isWanted = !prizeMaster[prizeIndex].isWanted;
                savePrizeMaster();
                updatePrizeMasterList();
            }
        }

        // 画像URLからプレビューを表示
        function previewImageFromUrl(url, imgId, previewId) {
            const img = document.getElementById(imgId);
            const preview = document.getElementById(previewId);

            if (url && url.trim()) {
                img.src = url;
                img.style.border = '2px solid rgba(0, 0, 0, 0.1)';
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // 景品編集モーダルを開く（景品マスター用）
        function openEditPrizeModal(prizeId, tempPrize = null) {
            // tempPrizeが渡された場合はそれを使用、なければ景品マスターから検索
            const prize = tempPrize || prizeMaster.find(p => p.id === prizeId);
            if (!prize) return;

            editingMasterPrizeId = prizeId;

            // モーダルのフォームに値を設定
            document.getElementById('editPrizeName').value = prize.name;
            document.getElementById('editPrizePurchasePrice').value = prize.purchasePrice.toLocaleString();
            document.getElementById('editPrizeValue').value = prize.value.toLocaleString();
            document.getElementById('editPrizeCount').value = prize.count;
            document.getElementById('editPrizeType').value = prize.type || 'PSA10';
            document.getElementById('editPrizeIsWanted').checked = prize.isWanted || false;

            // 既存の画像URLを設定
            const imageUrl = prize.image || '';
            document.getElementById('editPrizeImageUrl').value = imageUrl;

            // プレビュー表示
            const imagePreview = document.getElementById('editPrizeImagePreview');
            const imagePreviewImg = document.getElementById('editPrizeImagePreviewImg');
            if (imageUrl) {
                imagePreviewImg.src = imageUrl;
                imagePreviewImg.style.border = '2px solid rgba(0, 0, 0, 0.1)';
                imagePreview.style.display = 'block';
            } else {
                imagePreview.style.display = 'none';
            }

            // モーダルを表示
            document.getElementById('editPrizeModal').classList.add('active');
        }

        // 景品編集モーダルを閉じる
        function closeEditPrizeModal() {
            editingMasterPrizeId = null;
            editingMainPrizeId = null;
            editContext = 'master'; // コンテキストをリセット

            document.getElementById('editPrizeModal').classList.remove('active');

            // フォームをクリア
            document.getElementById('editPrizeName').value = '';
            document.getElementById('editPrizePurchasePrice').value = '';
            document.getElementById('editPrizeValue').value = '';
            document.getElementById('editPrizeCount').value = '1';
            document.getElementById('editPrizeImageUrl').value = '';
            document.getElementById('editPrizeImagePreview').style.display = 'none';
        }

        // 編集した景品を保存（景品マスター用 / メイン用共通）
        function saveEditedPrize() {
            if (!editingMasterPrizeId) return;

            const name = document.getElementById('editPrizeName').value.trim();
            const purchasePrice = parseFormattedNumber(document.getElementById('editPrizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('editPrizeValue').value);
            const count = parseInt(document.getElementById('editPrizeCount').value);
            const type = document.getElementById('editPrizeType').value;
            const isWanted = document.getElementById('editPrizeIsWanted').checked;
            const imageUrl = document.getElementById('editPrizeImageUrl').value.trim();

            if (!name || purchasePrice <= 0 || value <= 0 || isNaN(count) || count < 0) {
                alert('すべての項目を正しく入力してください（在庫数は0以上）');
                return;
            }

            // 画像URLを設定（空の場合はnull）
            const imageData = imageUrl || null;

            // メインから呼ばれた場合
            if (editContext === 'main' && editingMainPrizeId) {
                // メインの景品リストを更新
                const mainPrizeIndex = prizes.findIndex(p => p.id === editingMainPrizeId);
                if (mainPrizeIndex !== -1) {
                    prizes[mainPrizeIndex] = {
                        ...prizes[mainPrizeIndex],
                        name: name,
                        purchasePrice: purchasePrice,
                        value: value,
                        count: count,
                        image: imageData
                    };
                }

                // メインの景品を景品マスターにも反映するか確認
                const existingMasterPrize = prizeMaster.find(p => p.name === name);
                if (existingMasterPrize) {
                    // 同名の景品がマスターに存在する場合、更新するか確認
                    if (confirm(`景品マスターに同名の「${name}」が存在します。\n\n景品マスターも更新しますか？`)) {
                        const masterIndex = prizeMaster.findIndex(p => p.name === name);
                        prizeMaster[masterIndex] = {
                            ...prizeMaster[masterIndex],
                            purchasePrice: purchasePrice,
                            value: value,
                            image: imageData
                        };
                        savePrizeMaster();
                        updatePrizeMasterList();
                    }
                }

                updatePrizeList();
                saveData();

                // コンテキストをリセット
                editContext = 'master';
                editingMainPrizeId = null;

                // メインタブに戻る
                showTab('main');
            } else {
                // 景品マスターを更新
                const prizeIndex = prizeMaster.findIndex(p => p.id === editingMasterPrizeId);
                if (prizeIndex !== -1) {
                    prizeMaster[prizeIndex] = {
                        ...prizeMaster[prizeIndex],
                        name: name,
                        purchasePrice: purchasePrice,
                        value: value,
                        count: count,
                        type: type,
                        isWanted: isWanted,
                        image: imageData
                    };
                }
            }

            // 景品マスターを保存
            savePrizeMaster();

            // 景品一覧を更新
            updatePrizeMasterList();

            // モーダルを閉じる
            closeEditPrizeModal();
        }

        // 削除確認のためのグローバル変数
        let pendingDeletePrizeId = null;

        // 削除確認モーダルを開く
        function openDeleteConfirmModal(prizeId) {
            console.log('削除確認モーダルを開く - prizeId:', prizeId);

            const prize = prizeMaster.find(p => p.id === prizeId);
            if (!prize) {
                console.error('景品が見つかりません');
                alert('景品が見つかりません');
                return;
            }

            pendingDeletePrizeId = prizeId;
            document.getElementById('deleteConfirmMessage').textContent = `「${prize.name}」を景品マスターから削除してもよろしいですか？`;
            document.getElementById('deleteConfirmModal').style.display = 'flex';
        }

        // 削除確認モーダルを閉じる
        function closeDeleteConfirmModal(confirmed) {
            console.log('削除確認モーダルを閉じる - confirmed:', confirmed);
            document.getElementById('deleteConfirmModal').style.display = 'none';

            if (confirmed && pendingDeletePrizeId !== null) {
                executeDeletePrize(pendingDeletePrizeId);
            }

            pendingDeletePrizeId = null;
        }

        // 実際の削除処理
        function executeDeletePrize(prizeId) {
            console.log('削除処理を実行 - prizeId:', prizeId);

            const prize = prizeMaster.find(p => p.id === prizeId);
            if (!prize) {
                console.error('景品が見つかりません');
                return;
            }

            const prizeName = prize.name;
            const beforeCount = prizeMaster.length;

            prizeMaster = prizeMaster.filter(p => p.id !== prizeId);

            const afterCount = prizeMaster.length;
            console.log(`削除前: ${beforeCount}件, 削除後: ${afterCount}件`);

            savePrizeMaster();
            updatePrizeMasterList();

            console.log('削除完了');
            alert(`✅ 「${prizeName}」を削除しました`);
        }

        // 景品を削除（景品マスターから）
        function deletePrizeFromMaster(prizeId) {
            openDeleteConfirmModal(prizeId);
        }

        // 画像拡大表示モーダルを開く
        function openImageViewModal(imageSrc, prizeName) {
            document.getElementById('imageViewImg').src = imageSrc;
            document.getElementById('imageViewImg').alt = prizeName;
            document.getElementById('imageViewModal').classList.add('active');
        }

        // 画像拡大表示モーダルを閉じる
        function closeImageViewModal() {
            document.getElementById('imageViewModal').classList.remove('active');
        }

        // 新規景品登録フォームの表示/非表示切り替え
        function toggleAddPrizeForm() {
            const container = document.getElementById('addPrizeFormContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                clearAddPrizeForm();
            }
        }

        // 新規景品登録フォームをクリア
        function clearAddPrizeForm() {
            document.getElementById('newPrizeName').value = '';
            document.getElementById('newPrizePurchasePrice').value = '';
            document.getElementById('newPrizeValue').value = '';
            document.getElementById('newPrizeCount').value = '1';
            document.getElementById('newPrizeType').value = 'PSA10';
            document.getElementById('newPrizeIsWanted').checked = false;
            document.getElementById('newPrizeImageUrl').value = '';
            document.getElementById('prizeImagePreview').style.display = 'none';
        }

        // 景品画像のプレビュー
        function previewPrizeImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // ファイルサイズチェック（2MB）
                if (file.size > 2 * 1024 * 1024) {
                    alert('画像サイズが大きすぎます。2MB以下の画像を選択してください。');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('prizeImagePreviewImg').src = e.target.result;
                    document.getElementById('prizeImagePreview').style.display = 'block';
                    document.getElementById('newPrizeImageDropZone').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // ペースト・ドロップされた画像ファイルを一時保存
        let tempPastedFile = {
            newPrize: null,
            editPrize: null
        };

        // 画像ファイルを処理する共通関数
        function handleImageFile(file, inputId, previewImgId, previewContainerId, dropZoneId) {
            if (!file || !file.type.startsWith('image/')) {
                alert('画像ファイルを選択してください。');
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                alert('画像サイズが大きすぎます。2MB以下の画像を選択してください。');
                return;
            }

            // 常に一時保存（ペースト/ドロップの場合に確実に保存）
            if (inputId === 'newPrizeImage') {
                tempPastedFile.newPrize = file;
                console.log('新規景品の画像を一時保存:', file.name, file.size);
            } else if (inputId === 'editPrizeImage') {
                tempPastedFile.editPrize = file;
                console.log('編集景品の画像を一時保存:', file.name, file.size);
            }

            // DataTransferも試みる（ファイル選択ダイアログとの互換性のため）
            try {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById(inputId).files = dataTransfer.files;
            } catch (e) {
                // DataTransferが失敗してもtempPastedFileがあるので問題なし
                console.log('DataTransfer失敗（tempPastedFileを使用）');
            }

            // プレビュー表示
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(previewImgId).src = e.target.result;
                document.getElementById(previewContainerId).style.display = 'block';
                if (dropZoneId) {
                    document.getElementById(dropZoneId).style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        }

        // ドラッグ&ドロップのイベント設定
        function setupDragAndDrop(dropZoneId, inputId, previewImgId, previewContainerId) {
            const dropZone = document.getElementById(dropZoneId);

            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = 'rgba(0, 122, 255, 0.8)';
                this.style.background = 'rgba(0, 122, 255, 0.1)';
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = 'rgba(0, 122, 255, 0.3)';
                this.style.background = 'rgba(0, 122, 255, 0.03)';
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = 'rgba(0, 122, 255, 0.3)';
                this.style.background = 'rgba(0, 122, 255, 0.03)';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageFile(files[0], inputId, previewImgId, previewContainerId, dropZoneId);
                }
            });
        }

        // ペーストのイベント設定
        function setupPaste(containerId, inputId, previewImgId, previewContainerId, dropZoneId) {
            const container = document.getElementById(containerId);

            container.addEventListener('paste', function(e) {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        handleImageFile(file, inputId, previewImgId, previewContainerId, dropZoneId);
                        e.preventDefault();
                        break;
                    }
                }
            });
        }

        // 景品画像を削除
        function removePrizeImage() {
            document.getElementById('newPrizeImage').value = '';
            document.getElementById('prizeImagePreview').style.display = 'none';
            document.getElementById('newPrizeImageDropZone').style.display = 'block';
            tempPastedFile.newPrize = null; // 一時保存もクリア
        }

        // 編集モーダル用：景品画像のプレビュー
        function previewEditPrizeImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // ファイルサイズチェック（2MB）
                if (file.size > 2 * 1024 * 1024) {
                    alert('画像サイズが大きすぎます。2MB以下の画像を選択してください。');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editPrizeImagePreviewImg').src = e.target.result;
                    document.getElementById('editPrizeImagePreview').style.display = 'block';
                    document.getElementById('editPrizeImageDropZone').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // 編集モーダル用：景品画像を削除
        function removeEditPrizeImage() {
            document.getElementById('editPrizeImage').value = '';
            document.getElementById('editPrizeImagePreview').style.display = 'none';
            document.getElementById('editPrizeImageDropZone').style.display = 'block';
            // 画像削除フラグを立てる
            document.getElementById('editPrizeImagePreviewImg').setAttribute('data-removed', 'true');
            tempPastedFile.editPrize = null; // 一時保存もクリア
        }

        // 新規景品を景品マスターに追加
        function addNewPrizeToMaster() {
            const name = document.getElementById('newPrizeName').value.trim();
            const purchasePrice = parseFormattedNumber(document.getElementById('newPrizePurchasePrice').value);
            const value = parseFormattedNumber(document.getElementById('newPrizeValue').value);
            const count = parseInt(document.getElementById('newPrizeCount').value);
            const type = document.getElementById('newPrizeType').value;
            const isWanted = document.getElementById('newPrizeIsWanted').checked;
            const imageUrl = document.getElementById('newPrizeImageUrl').value.trim();

            // バリデーション
            if (!name || purchasePrice <= 0 || value <= 0 || isNaN(count) || count < 0) {
                alert('すべての必須項目を正しく入力してください（在庫数は0以上）');
                return;
            }

            // 画像URLを設定（空の場合はnull）
            const imageData = imageUrl || null;

            // 景品を追加
            const newPrize = {
                id: Date.now() + Math.random(),
                name: name,
                purchasePrice: purchasePrice,
                value: value,
                count: count,
                type: type,
                isWanted: isWanted,
                image: imageData,
                addedAt: Date.now()
            };

            prizeMaster.push(newPrize);

            // メインから呼ばれた場合、メインの景品リストにも追加するか確認
            if (editContext === 'main') {
                if (confirm(`景品「${name}」を景品マスターに登録しました。\n\nメインタブの景品管理にも追加しますか？`)) {
                    // 等級を選択させる
                    const rank = prompt('等級を入力してください（1-5）', '1');
                    if (rank && parseInt(rank) >= 1 && parseInt(rank) <= 5) {
                        const mainPrize = {
                            id: Date.now(),
                            name: name,
                            rank: parseInt(rank),
                            purchasePrice: purchasePrice,
                            value: value,
                            count: 1,
                            image: imageData
                        };
                        prizes.push(mainPrize);
                        updatePrizeList();
                        saveData();
                    }
                }

                // コンテキストをリセット
                editContext = 'master';

                // メインタブに戻る
                showTab('main');
            }

            // 保存と更新
            savePrizeMaster();
            updatePrizeMasterList();

            // フォームをクリアして閉じる
            clearAddPrizeForm();
            document.getElementById('addPrizeFormContainer').style.display = 'none';

            alert(`✅ 「${name}」を景品マスターに追加しました！\n\nクラウドに自動同期されます。`);
        }

        // 新規景品登録をキャンセル
        function cancelAddPrize() {
            clearAddPrizeForm();
            document.getElementById('addPrizeFormContainer').style.display = 'none';
        }

        // モーダルの外側をクリックしたら閉じる
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('editPrizeModal');
            if (event.target === modal) {
                closeEditPrizeModal();
            }
        });

        // ==================== オリパ自動作成機能 ====================
        let autoCreatedPrizes = []; // 自動作成された景品リスト
        let autoCreatedSettings = {}; // 自動作成時の設定

        // オリパを自動作成
        function createAutoOripa() {
            if (prizeMaster.length === 0) {
                alert('景品マスターが空です。\n\nまず景品マスタータブで景品を登録してください。');
                return;
            }

            // 基本設定を取得
            const packPrice = parseInt(document.getElementById('autoPackPrice').value) || 0;
            const totalPacks = parseInt(document.getElementById('autoTotalPacks').value) || 0;
            const targetReturnRate = parseFloat(document.getElementById('autoReturnRate').value) || 0;
            const returnRateMax = parseFloat(document.getElementById('autoReturnRateMax').value) || 0;
            const minGuarantee = parseInt(document.getElementById('autoMinGuarantee').value) || 1;
            const lossTypes = parseInt(document.getElementById('autoLossTypes').value) || 3;

            // 当選確率条件（必須）
            const probabilityX = parseInt(document.getElementById('autoProbabilityX').value) || 0;
            const probabilityRank = parseInt(document.getElementById('autoProbabilityRank').value) || 0;

            // 各等級の枚数と条件を取得
            const rankConfigs = [
                {
                    rank: 1,
                    count: parseInt(document.getElementById('autoRank1Count').value) || 0,
                    condition: document.getElementById('autoRank1Condition').value
                },
                {
                    rank: 2,
                    count: parseInt(document.getElementById('autoRank2Count').value) || 0,
                    condition: document.getElementById('autoRank2Condition').value
                },
                {
                    rank: 3,
                    count: parseInt(document.getElementById('autoRank3Count').value) || 0,
                    condition: document.getElementById('autoRank3Condition').value
                },
                {
                    rank: 4,
                    count: parseInt(document.getElementById('autoRank4Count').value) || 0,
                    condition: document.getElementById('autoRank4Condition').value
                },
                {
                    rank: 5,
                    count: parseInt(document.getElementById('autoRank5Count').value) || 0,
                    condition: document.getElementById('autoRank5Condition').value
                }
            ];

            if (packPrice <= 0 || totalPacks <= 0 || returnRateMin <= 0 || returnRateMax <= 0) {
                alert('パック単価、総口数、目標還元率を正しく入力してください');
                return;
            }

            if (returnRateMin > returnRateMax) {
                alert('還元率の範囲が正しくありません。最小値は最大値以下である必要があります。');
                return;
            }

            // 当選確率条件のバリデーション（必須）
            if (probabilityX <= 0 || probabilityRank <= 0) {
                alert('当選確率条件を設定してください。\n\n例: 10分の1で3等以上');
                return;
            }

            // 目標還元率（範囲の中央値を使用）
            const targetReturnRate = (returnRateMin + returnRateMax) / 2;

            // 目標還元総額を計算
            const totalValue = packPrice * totalPacks;
            const targetReturnValue = totalValue * (targetReturnRate / 100);

            // 確率条件から必要な最低枚数を計算
            const requiredMinCount = Math.ceil(totalPacks / probabilityX);

            // 各等級の実際の枚数を決定（条件に基づいて調整）
            const actualRankCounts = [];
            let totalPrizeCount = 0;

            for (const config of rankConfigs) {
                let actualCount = config.count;

                // 条件に応じて枚数を調整
                if (config.condition === 'exact') {
                    actualCount = config.count;
                } else if (config.condition === 'less') {
                    // 以下の場合は指定枚数をそのまま使用（または減らす）
                    actualCount = config.count;
                } else if (config.condition === 'more') {
                    // 以上の場合は指定枚数をそのまま使用（または増やす）
                    actualCount = config.count;
                }

                actualRankCounts.push({
                    rank: config.rank,
                    count: actualCount,
                    condition: config.condition
                });
                totalPrizeCount += actualCount;
            }

            // 確率条件を満たすかチェック
            let targetRankOrAboveCount = 0;
            for (let i = 0; i < probabilityRank; i++) {
                targetRankOrAboveCount += actualRankCounts[i].count;
            }

            if (targetRankOrAboveCount < requiredMinCount) {
                alert(`確率条件を満たしていません。\n\n` +
                    `条件: ${probabilityX}分の1で${probabilityRank}等以上\n` +
                    `必要枚数: ${requiredMinCount}枚以上\n` +
                    `現在の${probabilityRank}等以上: ${targetRankOrAboveCount}枚\n\n` +
                    `${probabilityRank}等以上の景品を${requiredMinCount - targetRankOrAboveCount}枚以上追加してください。`);
                return;
            }

            // 当たり景品の総口数チェック
            if (totalPrizeCount > totalPacks) {
                alert(`当たり景品の総数が総口数を超えています。\n\n` +
                    `総口数: ${totalPacks}枚\n` +
                    `当たり総数: ${totalPrizeCount}枚\n\n` +
                    `当たりの枚数を減らしてください。`);
                return;
            }

            // ハズレ枚数を自動計算
            const lossCount = totalPacks - totalPrizeCount;

            // 各等級の景品を景品マスターから選択
            autoCreatedPrizes = [];
            let currentReturnValue = 0;
            let success = true;
            let errors = [];

            actualRankCounts.forEach(({ rank, count, condition }) => {
                if (count === 0) return;

                // 景品マスター全体から選択（等級はオリパ作成時に割り当てる）
                if (prizeMaster.length === 0) {
                    errors.push(`景品マスターが空です`);
                    success = false;
                    return;
                }

                // 等級ごとの目標還元額を計算（等級が高いほど価値が高くなるように重み付け）
                const rankWeight = [0.5, 0.25, 0.15, 0.07, 0.03]; // 1等50%, 2等25%, 3等15%, 4等7%, 5等3%
                const rankTargetValue = targetReturnValue * rankWeight[rank - 1];
                const perPrizeTargetValue = rankTargetValue / count;

                // 目標価値に最も近い景品を景品マスター全体から選択
                for (let i = 0; i < count; i++) {
                    // 価値の差が最も小さい景品を選ぶ
                    const selectedPrize = prizeMaster.reduce((best, current) => {
                        const currentDiff = Math.abs(current.value - perPrizeTargetValue);
                        const bestDiff = Math.abs(best.value - perPrizeTargetValue);
                        return currentDiff < bestDiff ? current : best;
                    });

                    // 景品を追加（等級はここで割り当てる）
                    autoCreatedPrizes.push({
                        id: Date.now() + Math.random(),
                        name: selectedPrize.name,
                        rank: rank,  // オリパ作成時に等級を割り当て
                        purchasePrice: selectedPrize.purchasePrice,
                        value: selectedPrize.value,
                        count: 1
                    });

                    currentReturnValue += selectedPrize.value;
                }
            });

            if (!success) {
                alert('オリパの自動作成に失敗しました:\n' + errors.join('\n'));
                return;
            }

            // ハズレ1種類の場合は最低保証を自動計算
            let calculatedMinGuarantee = minGuarantee;
            if (lossTypes === 1) {
                // 目標還元額から当たり還元額を引いた残りをハズレ枚数で割る
                const remainingValue = targetReturnValue - currentReturnValue;
                calculatedMinGuarantee = Math.floor(remainingValue / lossCount);

                // 最低1円は保証
                if (calculatedMinGuarantee < 1) {
                    calculatedMinGuarantee = 1;
                }
            }

            // ハズレ分の還元額を計算
            const lossReturnValue = lossCount * calculatedMinGuarantee;
            currentReturnValue += lossReturnValue;

            // 実質還元率を計算
            const actualReturnRate = (currentReturnValue / totalValue) * 100;

            // 還元率が範囲内かチェック
            let returnRateStatus = 'success';
            let returnRateMessage = '';
            if (actualReturnRate < returnRateMin) {
                returnRateStatus = 'warning';
                returnRateMessage = `⚠️ 還元率が目標範囲を下回っています（${returnRateMin}%未満）`;
            } else if (actualReturnRate > returnRateMax) {
                returnRateStatus = 'warning';
                returnRateMessage = `⚠️ 還元率が目標範囲を上回っています（${returnRateMax}%超過）`;
            } else {
                returnRateMessage = `✅ 還元率が目標範囲内です（${returnRateMin}% 〜 ${returnRateMax}%）`;
            }

            // 結果を表示
            displayAutoCreateResult(packPrice, totalPacks, targetReturnValue, currentReturnValue, actualReturnRate, lossCount, calculatedMinGuarantee, returnRateMin, returnRateMax, returnRateStatus, returnRateMessage, probabilityX, probabilityRank, lossTypes);
        }

        // 自動作成結果を表示
        function displayAutoCreateResult(packPrice, totalPacks, targetReturnValue, actualReturnValue, actualReturnRate, lossCount, minGuarantee, returnRateMin, returnRateMax, returnRateStatus, returnRateMessage, probabilityX, probabilityRank, lossTypes) {
            const resultDiv = document.getElementById('autoCreateResult');
            const contentDiv = document.getElementById('autoCreateResultContent');

            // 等級ごとに景品をまとめる
            const rankGroups = {1: [], 2: [], 3: [], 4: [], 5: []};
            autoCreatedPrizes.forEach(prize => {
                rankGroups[prize.rank].push(prize);
            });

            // 還元率ステータスの色を決定
            const statusColor = returnRateStatus === 'success' ? 'var(--sf-green)' : 'var(--sf-orange)';
            const statusBgColor = returnRateStatus === 'success' ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 149, 0, 0.1)';
            const statusBorderColor = returnRateStatus === 'success' ? 'rgba(52, 199, 89, 0.3)' : 'rgba(255, 149, 0, 0.3)';

            let html = `
                <div style="background: ${statusBgColor}; padding: 20px; border-radius: var(--radius-lg); border: 2px solid ${statusBorderColor}; margin-bottom: 16px;">
                    <div style="font-size: 14px; font-weight: 600; color: ${statusColor}; margin-bottom: 12px;">
                        ${returnRateMessage}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div>
                            <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">目標還元率</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--sf-green);">${returnRateMin}% 〜 ${returnRateMax}%</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">実際の還元率</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${statusColor};">${actualReturnRate.toFixed(2)}%</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">目標還元額（中央値）</div>
                            <div style="font-size: 18px; font-weight: 700; color: rgba(0, 0, 0, 0.9);">¥${targetReturnValue.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--sf-gray); margin-bottom: 4px;">実際の還元額</div>
                            <div style="font-size: 18px; font-weight: 700; color: rgba(0, 0, 0, 0.9);">¥${actualReturnValue.toLocaleString()}</div>
                        </div>
                    </div>
                </div>`;

            // 確率条件の表示
            if (probabilityX > 0 && probabilityRank > 0) {
                // y等以上の景品の総数を計算
                let targetRankOrAboveCount = 0;
                for (let r = 1; r <= probabilityRank; r++) {
                    targetRankOrAboveCount += rankGroups[r].length;
                }

                const actualProbability = (targetRankOrAboveCount / totalPacks * 100).toFixed(2);
                const targetProbability = (100 / probabilityX).toFixed(2);

                html += `
                    <div style="background: rgba(0, 122, 255, 0.1); padding: 16px; border-radius: var(--radius-md); border: 1px solid rgba(0, 122, 255, 0.3); margin-bottom: 16px;">
                        <div style="font-weight: 600; color: var(--sf-blue); margin-bottom: 8px;">📊 当選確率条件</div>
                        <div style="font-size: 14px; color: rgba(0, 0, 0, 0.9);">
                            <div style="margin-bottom: 4px;">条件: ${probabilityX}分の1で${probabilityRank}等以上</div>
                            <div style="margin-bottom: 4px;">目標確率: ${targetProbability}%</div>
                            <div style="margin-bottom: 4px;">実際の確率: ${actualProbability}% (${targetRankOrAboveCount}枚 / ${totalPacks}枚)</div>
                            <div style="margin-top: 8px; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: var(--radius-sm);">
                                約${Math.round(totalPacks / targetRankOrAboveCount)}回に1回、${probabilityRank}等以上が当たります
                            </div>
                        </div>
                    </div>
                `;
            }

            html += `<h4 style="margin-bottom: 12px; color: rgba(0, 0, 0, 0.9);">選択された景品</h4>
            `;

            // 等級ごとに表示
            [1, 2, 3, 4, 5].forEach(rank => {
                if (rankGroups[rank].length > 0) {
                    const rankNames = ['1等', '2等', '3等', '4等', '5等'];
                    html += `<div style="margin-bottom: 16px;">`;
                    html += `<div style="font-weight: 600; color: var(--sf-blue); margin-bottom: 8px;">${rankNames[rank - 1]} (${rankGroups[rank].length}枚)</div>`;

                    rankGroups[rank].forEach(prize => {
                        html += `
                            <div style="background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: var(--radius-md); margin-bottom: 8px; border: 1px solid rgba(0, 0, 0, 0.08);">
                                <div style="font-weight: 600; margin-bottom: 4px;">${prize.name}</div>
                                <div style="font-size: 13px; color: var(--sf-gray);">
                                    仕入れ: ¥${prize.purchasePrice.toLocaleString()} / 還元価値: ¥${prize.value.toLocaleString()}
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
            });

            // ハズレ情報
            html += `
                <div style="background: rgba(142, 142, 147, 0.1); padding: 16px; border-radius: var(--radius-md); border: 1px solid rgba(142, 142, 147, 0.3);">
                    <div style="font-weight: 600; color: var(--sf-gray); margin-bottom: 8px;">ハズレ（自動計算）</div>
                    <div style="font-size: 13px; color: var(--sf-gray); margin-bottom: 8px;">
                        <div style="margin-bottom: 4px;">総枚数: ${lossCount}枚</div>
                        <div style="margin-bottom: 4px;">種類数: ${lossTypes}種類${lossTypes === 1 ? '（均等配分）' : ''}</div>
                        <div style="margin-bottom: 4px;">最低保証: ¥${minGuarantee.toLocaleString()}${lossTypes === 1 ? ' <span style="color: var(--sf-orange);">(自動計算)</span>' : ''}</div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(142, 142, 147, 0.2);">
                            合計還元額: ¥${(lossCount * minGuarantee).toLocaleString()}
                        </div>
                    </div>
                    <div style="font-size: 12px; color: var(--sf-gray); font-style: italic;">
                        ※ ハズレは総口数（${totalPacks}枚）から当たり枚数を引いて自動計算されます${lossTypes === 1 ? '<br>※ ハズレ1種類の場合、最低保証は目標還元率から自動計算されます' : ''}
                    </div>
                </div>
            `;

            contentDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        }

        // 自動作成されたオリパをメインタブに適用
        function applyAutoCreatedOripa() {
            if (autoCreatedPrizes.length === 0) {
                alert('適用できるオリパがありません');
                return;
            }

            if (!confirm('現在のメインタブの景品を、自動作成されたオリパで上書きしますか？')) {
                return;
            }

            // メインタブの設定を更新
            document.getElementById('packPrice').value = document.getElementById('autoPackPrice').value;
            document.getElementById('totalPacks').value = document.getElementById('autoTotalPacks').value;
            document.getElementById('minGuaranteeValue').value = document.getElementById('autoMinGuarantee').value;

            // 景品を適用
            prizes = [...autoCreatedPrizes];

            // ハズレをクリア（自動計算モードにする）
            losses = [];

            // データを保存
            saveData();

            // 表示を更新
            updatePrizeList();
            updateLossList();
            updateTotalValue();

            // メインタブに切り替え
            switchTab('main');
            document.querySelector('.tab-button:nth-child(1)').classList.add('active');
            document.querySelector('.tab-button:nth-child(3)').classList.remove('active');

            alert('オリパをメインタブに適用しました！');
        }

        // ページ読み込み時に景品マスターをlocalStorageから読み込む
        document.addEventListener('DOMContentLoaded', function() {
            // まずlocalStorageから読み込み（即座に表示）
            loadPrizeMaster();
            // Firebase認証は景品一覧タブが表示されたときに自動的に開始される

            // ソート・フィルター設定を復元
            try {
                const savedSortBy = localStorage.getItem('prizeMasterSortBy');
                const savedSortOrder = localStorage.getItem('prizeMasterSortOrder');
                const savedFilter = localStorage.getItem('prizeMasterFilter');
                const savedTypeFilter = localStorage.getItem('prizeMasterTypeFilter');
                const savedWantedFilter = localStorage.getItem('prizeMasterWantedFilter');
                const savedSearchText = localStorage.getItem('prizeMasterSearchText');

                if (savedSortBy) {
                    const sortBySelect = document.getElementById('prizeMasterSortBy');
                    if (sortBySelect) sortBySelect.value = savedSortBy;
                }

                if (savedSortOrder) {
                    const sortOrderSelect = document.getElementById('prizeMasterSortOrder');
                    if (sortOrderSelect) sortOrderSelect.value = savedSortOrder;
                }

                if (savedFilter) {
                    const filterSelect = document.getElementById('prizeMasterFilter');
                    if (filterSelect) filterSelect.value = savedFilter;
                }

                if (savedTypeFilter) {
                    const typeFilterSelect = document.getElementById('prizeMasterTypeFilter');
                    if (typeFilterSelect) typeFilterSelect.value = savedTypeFilter;
                }

                if (savedWantedFilter) {
                    const wantedFilterCheckbox = document.getElementById('prizeMasterWantedFilter');
                    if (wantedFilterCheckbox) wantedFilterCheckbox.checked = savedWantedFilter === 'true';
                }

                if (savedSearchText) {
                    const searchTextInput = document.getElementById('prizeMasterSearchText');
                    if (searchTextInput) searchTextInput.value = savedSearchText;
                }
            } catch (e) {
                console.error('設定の復元に失敗:', e);
            }

            // 画像URLモードに変更したため、ドラッグ&ドロップは不要
        });
    </script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebaseの設定（ここに取得した設定を貼り付け）
const firebaseConfig = {
  apiKey: "AIzaSyAe9gDljx8sz-amXm_BWyPJgskR_V1S3Oo",
  authDomain: "oripa-simulator.firebaseapp.com",
  databaseURL: "https://oripa-simulator-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "oripa-simulator",
  storageBucket: "oripa-simulator.firebasestorage.app",
  messagingSenderId: "546810114337",
  appId: "1:546810114337:web:14a0657fd25998bef50e60"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// 匿名認証でサインイン
let isAuthReady = false;
let authCallbacks = []; // 認証完了後に実行するコールバック
let authInitialized = false; // 初期化済みフラグ

// 認証完了を待つ関数
function waitForAuth(callback, timeoutMs = 10000) {
    if (isAuthReady) {
        callback();
        return;
    }

    authCallbacks.push({
        callback: callback,
        timeoutId: setTimeout(() => {
            console.error('⚠️ Firebase認証がタイムアウトしました');
            updateSyncStatus('❌ 認証タイムアウト');
        }, timeoutMs)
    });
}

// 認証を実行
function initializeAuth() {
    if (authInitialized) {
        return;
    }
    authInitialized = true;

    updateSyncStatus('🔄 認証中... (0%)');

    auth.signInAnonymously()
        .then(() => {
            console.log('✅ Firebase匿名認証に成功しました');
            isAuthReady = true;
            updateSyncStatus('🔄 初期化中... (50%)');

            // すべてのコールバックを実行
            authCallbacks.forEach(item => {
                clearTimeout(item.timeoutId);
                item.callback();
            });
            authCallbacks = [];

            // 認証完了後にデータを読み込む
            loadPrizeMasterFromCloudOnce();
        })
        .catch((error) => {
            console.error('❌ Firebase認証エラー:', error);
            console.error('エラーコード:', error.code);
            console.error('エラーメッセージ:', error.message);

            // ユーザーにわかりやすいエラーメッセージ
            let userMessage = '❌ 認証失敗';
            if (error.code === 'auth/admin-restricted-operation') {
                userMessage = '❌ 匿名認証が無効です';
                console.error('⚠️ Firebase Consoleで匿名認証を有効にしてください');
                console.error('手順: Authentication > Sign-in method > 匿名 を有効化');
            }
            updateSyncStatus(userMessage);

            // すべてのコールバックをクリア
            authCallbacks.forEach(item => {
                clearTimeout(item.timeoutId);
            });
            authCallbacks = [];

            // localStorageから読み込みを試みる
            loadPrizeMaster();
        });
}

// 現在の設定を取得する関数
function getCurrentConfig() {
  return {
    packPrice: document.getElementById('packPrice').value,
    totalPacks: document.getElementById('totalPacks').value,
    releaseDate: document.getElementById('releaseDate').value,
    minGuaranteeValue: document.getElementById('minGuaranteeValue').value,
    prizes: [...prizes],
    losses: [...losses]
  };
}

// 設定を読み込む関数
function loadConfig(config) {
  document.getElementById('packPrice').value = config.packPrice || '40000';
  document.getElementById('totalPacks').value = config.totalPacks || '100';
  document.getElementById('releaseDate').value = config.releaseDate || '';
  document.getElementById('minGuaranteeValue').value = config.minGuaranteeValue || '1';

  if (config.prizes) {
    prizes = [...config.prizes];
    updatePrizeList();
  }

  if (config.losses) {
    losses = [...config.losses];
    updateLossList();
  }

  updateTotalValue();
}

// クラウド保存機能
function saveToCloud(configName) {
  const config = getCurrentConfig();
  const configId = configName || prompt('設定名を入力してください');
  if (!configId) return;

  database.ref('configs/' + configId).set({
    data: config,
    updatedAt: Date.now()
  }).then(() => {
    alert('保存しました: ' + configId);
    loadConfigList();
  }).catch((error) => {
    alert('保存に失敗しました: ' + error.message);
  });
}

// クラウドから読み込み
function loadFromCloud(configId) {
  database.ref('configs/' + configId).once('value').then((snapshot) => {
    const data = snapshot.val();
    if (data) {
      loadConfig(data.data);
      alert('読み込みました: ' + configId);
    } else {
      alert('設定が見つかりませんでした');
    }
  }).catch((error) => {
    alert('読み込みに失敗しました: ' + error.message);
  });
}

// グローバル変数でクラウド設定を管理
let cloudConfigs = {};
let currentCloudConfigId = null;

// 設定一覧表示
function loadConfigList() {
  database.ref('configs').once('value').then((snapshot) => {
    const configs = snapshot.val();
    console.log('保存済み設定:', Object.keys(configs || {}));
    // 必要に応じてUI表示
  });
}

// クラウド設定一覧を更新
function refreshCloudConfigList() {
  updateCloudStatus('設定一覧を読み込み中...');

  database.ref('configs').once('value').then((snapshot) => {
    cloudConfigs = snapshot.val() || {};
    updateCloudConfigSelectBox();
    updateCloudStatus(`${Object.keys(cloudConfigs).length}件の設定を読み込みました`);
  }).catch((error) => {
    updateCloudStatus('読み込みに失敗しました: ' + error.message);
  });
}

// クラウド設定のセレクトボックスを更新
function updateCloudConfigSelectBox() {
  const selectBox = document.getElementById('cloudConfigList');
  selectBox.innerHTML = '<option value="">設定を選択してください</option>';

  // 最終保存日の新しい順にソート
  const sortedConfigIds = Object.keys(cloudConfigs).sort((a, b) => {
    const dateA = cloudConfigs[a].updatedAt || 0;
    const dateB = cloudConfigs[b].updatedAt || 0;
    return dateB - dateA; // 降順（新しい順）
  });

  sortedConfigIds.forEach(configId => {
    const config = cloudConfigs[configId];
    const date = new Date(config.updatedAt).toLocaleString('ja-JP');
    const option = document.createElement('option');
    option.value = configId;
    option.textContent = `${configId} (${date})`;
    selectBox.appendChild(option);
  });

  // 現在選択中の設定があれば選択状態を維持
  if (currentCloudConfigId && cloudConfigs[currentCloudConfigId]) {
    selectBox.value = currentCloudConfigId;
    document.getElementById('updateCloudBtn').disabled = false;
  } else {
    document.getElementById('updateCloudBtn').disabled = true;
  }
}

// クラウドステータス表示を更新
function updateCloudStatus(message) {
  document.getElementById('cloudStatus').textContent = message;
  setTimeout(() => {
    document.getElementById('cloudStatus').textContent = '';
  }, 3000);
}

// 新規クラウド保存
function saveToCloudWithName() {
  const configName = document.getElementById('cloudConfigName').value.trim();
  if (!configName) {
    alert('設定名を入力してください');
    return;
  }

  // 同名の設定が既に存在するかチェック
  if (cloudConfigs[configName]) {
    if (!confirm(`「${configName}」という設定が既に存在します。上書きしますか？`)) {
      return;
    }
  }

  const config = getCurrentConfig();
  updateCloudStatus('保存中...');

  database.ref('configs/' + configName).set({
    data: config,
    updatedAt: Date.now(),
    createdBy: 'user', // 将来的にユーザー管理を追加する場合
    version: '1.0'
  }).then(() => {
    currentCloudConfigId = configName;
    document.getElementById('updateCloudBtn').disabled = false;
    updateCloudStatus(`「${configName}」を保存しました`);
    refreshCloudConfigList();
    document.getElementById('cloudConfigName').value = '';
    // 集計を自動更新
    setTimeout(() => refreshWeeklyStats(), 500);
  }).catch((error) => {
    updateCloudStatus('保存に失敗しました: ' + error.message);
  });
}

// 現在の設定を上書き更新
function updateCloudConfig() {
  if (!currentCloudConfigId) {
    alert('更新する設定が選択されていません');
    return;
  }

  if (!confirm(`「${currentCloudConfigId}」を現在の設定で上書き更新しますか？`)) {
    return;
  }

  const config = getCurrentConfig();
  updateCloudStatus('更新中...');

  database.ref('configs/' + currentCloudConfigId).update({
    data: config,
    updatedAt: Date.now()
  }).then(() => {
    updateCloudStatus(`「${currentCloudConfigId}」を更新しました`);
    refreshCloudConfigList();
    // 集計を自動更新
    setTimeout(() => refreshWeeklyStats(), 500);
  }).catch((error) => {
    updateCloudStatus('更新に失敗しました: ' + error.message);
  });
}

// 選択されたクラウド設定を読み込み
function loadSelectedCloudConfig() {
  const selectedConfigId = document.getElementById('cloudConfigList').value;
  if (!selectedConfigId) {
    alert('読み込む設定を選択してください');
    return;
  }

  updateCloudStatus('読み込み中...');

  database.ref('configs/' + selectedConfigId).once('value').then((snapshot) => {
    const configData = snapshot.val();
    if (configData && configData.data) {
      loadConfig(configData.data);
      currentCloudConfigId = selectedConfigId;
      document.getElementById('updateCloudBtn').disabled = false;
      document.getElementById('cloudConfigName').value = selectedConfigId;
      updateCloudStatus(`「${selectedConfigId}」を読み込みました`);
    } else {
      updateCloudStatus('設定データが見つかりませんでした');
    }
  }).catch((error) => {
    updateCloudStatus('読み込みに失敗しました: ' + error.message);
  });
}

// 選択されたクラウド設定を削除
function deleteSelectedCloudConfig() {
  const selectedConfigId = document.getElementById('cloudConfigList').value;
  if (!selectedConfigId) {
    alert('削除する設定を選択してください');
    return;
  }

  if (!confirm(`「${selectedConfigId}」を削除しますか？この操作は取り消せません。`)) {
    return;
  }

  updateCloudStatus('削除中...');

  database.ref('configs/' + selectedConfigId).remove().then(() => {
    if (currentCloudConfigId === selectedConfigId) {
      currentCloudConfigId = null;
      document.getElementById('updateCloudBtn').disabled = true;
      document.getElementById('cloudConfigName').value = '';
    }
    updateCloudStatus(`「${selectedConfigId}」を削除しました`);
    refreshCloudConfigList();
  }).catch((error) => {
    updateCloudStatus('削除に失敗しました: ' + error.message);
  });
}

// URLパラメータから設定IDを取得
function getConfigIdFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('config');
}

// URLパラメータで指定された設定を自動読み込み
function loadConfigFromURL() {
  const configId = getConfigIdFromURL();
  if (!configId) return;

  updateCloudStatus(`共有設定「${configId}」を読み込み中...`);

  database.ref('configs/' + configId).once('value').then((snapshot) => {
    const configData = snapshot.val();
    if (configData && configData.data) {
      loadConfig(configData.data);
      currentCloudConfigId = configId;
      document.getElementById('updateCloudBtn').disabled = false;
      document.getElementById('cloudConfigName').value = configId;

      // セレクトボックスの選択状態も更新
      const selectBox = document.getElementById('cloudConfigList');
      if (selectBox) {
        selectBox.value = configId;
      }

      updateCloudStatus(`共有設定「${configId}」を読み込みました`);

      // 成功メッセージを表示
      setTimeout(() => {
        alert(`🔗 共有された設定「${configId}」を読み込みました！\n\n設定を編集して「上書き更新」すると、元の設定に反映されます。\n「別名保存」で新しい設定として保存することもできます。`);
      }, 500);
    } else {
      updateCloudStatus(`共有設定「${configId}」が見つかりませんでした`);
      alert(`❌ 共有設定「${configId}」が見つかりませんでした。\n\n設定が削除されているか、設定名が正しくない可能性があります。`);
    }
  }).catch((error) => {
    updateCloudStatus('共有設定の読み込みに失敗しました: ' + error.message);
    alert(`❌ 共有設定の読み込みに失敗しました。\n\nエラー: ${error.message}`);
  });
}

// 共有リンクを生成してクリップボードにコピー
function generateShareLink() {
  if (!currentCloudConfigId) {
    alert('共有する設定を選択または保存してください');
    return;
  }

  const baseUrl = window.location.origin + window.location.pathname;
  const shareUrl = `${baseUrl}?config=${encodeURIComponent(currentCloudConfigId)}`;

  // クリップボードにコピー
  navigator.clipboard.writeText(shareUrl).then(() => {
    updateShareStatus('✅ リンクをクリップボードにコピーしました');

    // 成功ポップアップを表示
    showCopySuccessPopup(shareUrl);
  }).catch(() => {
    // フォールバック: モーダル表示
    showShareLinkModal(shareUrl);
  });
}

// コピー成功ポップアップを表示
function showCopySuccessPopup(shareUrl) {
  // 既存のポップアップがあれば削除
  const existingPopup = document.getElementById('copySuccessPopup');
  if (existingPopup) {
    document.body.removeChild(existingPopup);
  }

  const popup = document.createElement('div');
  popup.id = 'copySuccessPopup';
  popup.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #34C759, #30D158);
    color: white;
    padding: 20px 24px;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(52, 199, 89, 0.3);
    z-index: 10000;
    transform: translateX(400px);
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    max-width: 350px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    backdrop-filter: blur(20px);
  `;

  popup.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
      <div style="font-size: 24px;">✅</div>
      <div style="font-size: 16px; font-weight: 600;">リンクをコピーしました！</div>
    </div>
    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">
      「${currentCloudConfigId}」の共有リンクがクリップボードにコピーされました
    </div>
    <div style="font-size: 11px; opacity: 0.8; word-break: break-all; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px;">
      ${shareUrl}
    </div>
    <div style="position: absolute; top: 8px; right: 8px; cursor: pointer; font-size: 18px; opacity: 0.7; hover: opacity: 1;" onclick="document.body.removeChild(this.parentElement)">
      ×
    </div>
  `;

  document.body.appendChild(popup);

  // アニメーション: スライドイン
  setTimeout(() => {
    popup.style.transform = 'translateX(0)';
  }, 50);

  // 4秒後に自動で非表示
  setTimeout(() => {
    if (popup.parentElement) {
      popup.style.transform = 'translateX(400px)';
      setTimeout(() => {
        if (popup.parentElement) {
          document.body.removeChild(popup);
        }
      }, 300);
    }
  }, 4000);

  // クリックで閉じる
  popup.onclick = (e) => {
    if (e.target.tagName !== 'DIV') return;
    popup.style.transform = 'translateX(400px)';
    setTimeout(() => {
      if (popup.parentElement) {
        document.body.removeChild(popup);
      }
    }, 300);
  };
}

// 共有リンクモーダル表示（クリップボードAPIが使えない場合）
function showShareLinkModal(shareUrl) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
    z-index: 10000;
  `;

  modal.innerHTML = `
    <div style="background: white; padding: 32px; border-radius: 16px; max-width: 500px; width: 90%;">
      <h3 style="margin: 0 0 16px 0;">🔗 共有リンク</h3>
      <p style="margin: 0 0 16px 0; color: #666;">以下のリンクをコピーして共有してください：</p>
      <input type="text" value="${shareUrl}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 16px;" readonly onclick="this.select()">
      <div style="display: flex; gap: 12px;">
        <button onclick="copyFromModal('${shareUrl}', this)" style="flex: 1; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer;">
          📋 コピー
        </button>
        <button onclick="document.body.removeChild(this.closest('div[style*=\"fixed\"]'))" style="flex: 1; padding: 12px; background: #8E8E93; color: white; border: none; border-radius: 8px; cursor: pointer;">
          閉じる
        </button>
      </div>
    </div>
  `;

  modal.onclick = (e) => {
    if (e.target === modal) document.body.removeChild(modal);
  };

  document.body.appendChild(modal);
}

// モーダルからのコピー処理
function copyFromModal(shareUrl, buttonElement) {
  navigator.clipboard.writeText(shareUrl).then(() => {
    // ボタンテキストを一時的に変更
    const originalText = buttonElement.textContent;
    buttonElement.textContent = '✅ コピー済み';
    buttonElement.style.background = '#34C759';

    setTimeout(() => {
      // モーダルを閉じる
      const modal = buttonElement.closest('div[style*="fixed"]');
      if (modal) {
        document.body.removeChild(modal);
      }

      // 成功ポップアップを表示
      showCopySuccessPopup(shareUrl);
    }, 800);
  }).catch(() => {
    // フォールバック: テキストを選択状態にする
    const input = buttonElement.closest('div').previousElementSibling;
    input.select();
    input.setSelectionRange(0, 99999);

    buttonElement.textContent = '⚠️ 手動でコピー';
    setTimeout(() => {
      buttonElement.textContent = '📋 コピー';
    }, 2000);
  });
}

// 共有ステータス表示を更新
function updateShareStatus(message) {
  document.getElementById('shareStatus').textContent = message;
  setTimeout(() => {
    document.getElementById('shareStatus').textContent = '';
  }, 3000);
}

// 共有ボタンの状態を更新
function updateShareButtonState() {
  const shareBtn = document.getElementById('shareBtn');
  if (currentCloudConfigId) {
    shareBtn.disabled = false;
    shareBtn.textContent = `📋 「${currentCloudConfigId}」のリンクをコピー`;
  } else {
    shareBtn.disabled = true;
    shareBtn.textContent = '📋 共有リンクをコピー';
  }
}

// 既存の関数を拡張：設定保存・読み込み時に共有ボタンを更新
const originalSaveToCloudWithName = saveToCloudWithName;
saveToCloudWithName = function() {
  const result = originalSaveToCloudWithName.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

const originalLoadSelectedCloudConfig = loadSelectedCloudConfig;
loadSelectedCloudConfig = function() {
  const result = originalLoadSelectedCloudConfig.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

const originalLoadConfigFromURL = loadConfigFromURL;
loadConfigFromURL = function() {
  const result = originalLoadConfigFromURL.apply(this, arguments);
  setTimeout(() => updateShareButtonState(), 100);
  return result;
};

// ========== 過去7日間の集計機能 ==========

// 過去7日間の集計を更新
function refreshWeeklyStats() {
  const container = document.getElementById('weeklyStatsContainer');
  container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">集計中...</p>';

  // 7日前のタイムスタンプを取得
  const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

  database.ref('configs').once('value').then((snapshot) => {
    const allConfigs = snapshot.val() || {};

    // 過去7日間のデータをフィルタリング
    const recentConfigs = Object.entries(allConfigs).filter(([configId, configData]) => {
      return configData.updatedAt && configData.updatedAt >= sevenDaysAgo;
    });

    if (recentConfigs.length === 0) {
      container.innerHTML = '<p style="color: var(--sf-gray); text-align: center;">過去7日間のデータがありません</p>';
      return;
    }

    // 集計処理
    const stats = calculateWeeklyStats(recentConfigs);

    // 結果を表示
    displayWeeklyStats(stats);
  }).catch((error) => {
    container.innerHTML = `<p style="color: var(--sf-red); text-align: center;">集計に失敗しました: ${error.message}</p>`;
  });
}

// 過去7日間のデータから統計を計算
function calculateWeeklyStats(recentConfigs) {
  let totalOripaCount = recentConfigs.length;
  let totalValue = 0;
  let totalPurchase = 0;
  let totalPacks = 0;
  let totalWinners = 0;
  let totalPrizeCount = 0;
  let totalLossCount = 0;
  let totalReturnRates = [];
  let totalRealReturnRates = [];

  recentConfigs.forEach(([configId, configData]) => {
    const config = configData.data;
    if (!config) return;

    const packPrice = parseFloat(config.packPrice) || 0;
    const packs = parseInt(config.totalPacks) || 0;
    const prizes = config.prizes || [];
    const losses = config.losses || [];

    // オリパ提供価値
    const oripaValue = packPrice * packs;
    totalValue += oripaValue;

    // 総口数
    totalPacks += packs;

    // 景品の集計
    let prizeTotalValue = 0;
    let prizeTotalPurchase = 0;
    let prizeCount = 0;

    prizes.forEach(prize => {
      prizeCount += prize.count || 0;
      prizeTotalValue += (prize.value || 0) * (prize.count || 0);
      prizeTotalPurchase += (prize.purchasePrice || 0) * (prize.count || 0);
    });

    totalWinners += prizeCount;
    totalPrizeCount += prizeCount;
    totalPurchase += prizeTotalPurchase;

    // ハズレの集計
    let lossTotalValue = 0;
    let lossCount = 0;

    if (losses.length > 0) {
      losses.forEach(loss => {
        lossCount += loss.count || 0;
        lossTotalValue += (loss.value || 0) * (loss.count || 0);
      });
    } else {
      // 自動計算の場合
      const minGuaranteeValue = parseFloat(config.minGuaranteeValue) || 1;
      const remainingSlots = packs - prizeCount;
      if (remainingSlots > 0) {
        lossCount = remainingSlots;
        lossTotalValue = minGuaranteeValue * remainingSlots;
      }
    }

    totalLossCount += lossCount;

    // 総還元率
    const actualTotalReturnValue = prizeTotalValue + lossTotalValue;
    const totalReturnRate = oripaValue > 0 ? (actualTotalReturnValue / oripaValue) * 100 : 0;
    totalReturnRates.push(totalReturnRate);

    // 実質還元率（売上原価率）
    const realReturnRate = oripaValue > 0 ? (prizeTotalPurchase / oripaValue) * 100 : 0;
    totalRealReturnRates.push(realReturnRate);
  });

  // 平均を計算
  const avgValue = totalOripaCount > 0 ? totalValue / totalOripaCount : 0;
  const avgPurchase = totalOripaCount > 0 ? totalPurchase / totalOripaCount : 0;
  const avgReturnRate = totalReturnRates.length > 0 ? totalReturnRates.reduce((a, b) => a + b, 0) / totalReturnRates.length : 0;
  const avgRealReturnRate = totalRealReturnRates.length > 0 ? totalRealReturnRates.reduce((a, b) => a + b, 0) / totalRealReturnRates.length : 0;
  const avgPacks = totalOripaCount > 0 ? totalPacks / totalOripaCount : 0;

  return {
    totalOripaCount,
    totalValue,
    avgValue,
    totalPurchase,
    avgPurchase,
    totalPacks,
    avgPacks,
    totalWinners,
    totalPrizeCount,
    totalLossCount,
    avgReturnRate,
    avgRealReturnRate,
    totalReturnRates,
    totalRealReturnRates
  };
}

// 集計結果を表示
function displayWeeklyStats(stats) {
  const container = document.getElementById('weeklyStatsContainer');

  container.innerHTML = `
    <div style="margin-bottom: 16px; padding: 12px; background: rgba(175, 82, 222, 0.1); border-radius: 8px; text-align: center;">
      <div style="font-size: 24px; font-weight: 700; color: var(--sf-purple);">${stats.totalOripaCount}</div>
      <div style="font-size: 12px; color: var(--sf-gray); margin-top: 4px;">オリパ設定数</div>
    </div>

    <div style="display: grid; gap: 8px;">
      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">提供価値合計</span>
        <span style="font-weight: 600;">¥${stats.totalValue.toLocaleString()}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">提供価値平均</span>
        <span style="font-weight: 600;">¥${Math.round(stats.avgValue).toLocaleString()}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">仕入れ合計</span>
        <span style="font-weight: 600; color: var(--sf-orange);">¥${stats.totalPurchase.toLocaleString()}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">仕入れ平均</span>
        <span style="font-weight: 600; color: var(--sf-orange);">¥${Math.round(stats.avgPurchase).toLocaleString()}</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">総還元率平均</span>
        <span style="font-weight: 600; color: var(--sf-blue);">${stats.avgReturnRate.toFixed(1)}%</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">実質還元率平均</span>
        <span style="font-weight: 600; color: var(--sf-green);">${stats.avgRealReturnRate.toFixed(1)}%</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">総口数合計</span>
        <span style="font-weight: 600;">${stats.totalPacks.toLocaleString()}口</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">平均口数</span>
        <span style="font-weight: 600;">${Math.round(stats.avgPacks).toLocaleString()}口</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">当選者総数</span>
        <span style="font-weight: 600; color: var(--sf-purple);">${stats.totalWinners.toLocaleString()}人</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--sf-gray-5);">
        <span style="color: var(--sf-gray);">景品総枚数</span>
        <span style="font-weight: 600;">${stats.totalPrizeCount.toLocaleString()}枚</span>
      </div>

      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span style="color: var(--sf-gray);">ハズレ総枚数</span>
        <span style="font-weight: 600;">${stats.totalLossCount.toLocaleString()}枚</span>
      </div>
    </div>

    <div style="margin-top: 12px; padding: 8px; background: rgba(0, 122, 255, 0.05); border-radius: 6px; font-size: 11px; color: var(--sf-gray); text-align: center;">
      過去7日間のデータ（${new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toLocaleDateString('ja-JP')} 〜 ${new Date().toLocaleDateString('ja-JP')}）
    </div>
  `;
}

// 初期化時にクラウド設定一覧を読み込み
document.addEventListener('DOMContentLoaded', function() {
  // 既存の初期化処理の後に追加
  setTimeout(() => {
    refreshCloudConfigList();
    // URLパラメータで設定が指定されている場合は自動読み込み
    loadConfigFromURL();
    // 共有ボタンの初期状態を設定
    updateShareButtonState();
    // 過去7日間の集計を自動読み込み
    refreshWeeklyStats();
  }, 1000); // Firebaseの初期化を待つ
});

// ========== オリパスコア評価機能 ==========

// スコア計算関数
function calculateOripaScore() {
    const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
    const totalPacks = parseInt(document.getElementById('totalPacks').value) || 0;
    const minGuaranteeValue = parseFloat(document.getElementById('minGuaranteeValue').value) || 0;

    if (totalPacks === 0 || packPrice === 0) {
        alert('基本設定を入力してください');
        return null;
    }

    if (prizes.length === 0) {
        alert('景品を追加してください');
        return null;
    }

    // 計算ロジック
    const totalValue = packPrice * totalPacks;

    // 景品総価値計算（ポイント還元価値）
    const prizesTotalValue = prizes.reduce((sum, prize) => sum + (prize.value * prize.count), 0);
    const prizesTotalCount = prizes.reduce((sum, prize) => sum + prize.count, 0);

    // 景品総仕入れ価格計算
    const prizesTotalPurchasePrice = prizes.reduce((sum, prize) => sum + (prize.purchasePrice * prize.count), 0);

    // 実質還元率計算（仕入れ価格ベース）
    const realReturnRate = totalValue > 0 ? (prizesTotalPurchasePrice / totalValue) * 100 : 0;

    // ハズレ計算
    const remainingSlots = totalPacks - prizesTotalCount;
    let lossTypes = [];

    if (losses.length > 0) {
        lossTypes = losses.map(loss => ({
            name: loss.name,
            value: loss.value,
            count: loss.count
        }));
    } else {
        if (remainingSlots > 0) {
            lossTypes = [{
                name: 'ハズレ（自動）',
                value: minGuaranteeValue,
                count: remainingSlots
            }];
        }
    }

    // 総還元率計算
    const lossTotalValue = lossTypes.reduce((sum, loss) => sum + (loss.value * loss.count), 0);
    const actualTotalReturnValue = prizesTotalValue + lossTotalValue;
    const totalReturnRatePercent = totalValue > 0 ? (actualTotalReturnValue / totalValue) * 100 : 0;

    const prizeCount = prizesTotalCount;

    // スコア計算ロジック（実質還元率のみで評価：100点満点）
    let score = 0;

    // 実質還元率スコア（100点満点）
    // 実質還元率が低いほど利益率が高く、良い評価
    if (realReturnRate <= 20) {
        score = 100; // S評価：非常に優れた利益率
    } else if (realReturnRate <= 30) {
        score = 85; // A評価：優れた利益率
    } else if (realReturnRate <= 40) {
        score = 70; // B評価：良好な利益率
    } else if (realReturnRate <= 50) {
        score = 55; // C評価：まあまあの利益率
    } else if (realReturnRate <= 60) {
        score = 40; // D評価：やや厳しい利益率
    } else {
        score = 20; // E評価：厳しい利益率
    }

    // ランク判定
    let rank = 'E';
    if (score >= 90) rank = 'S';
    else if (score >= 75) rank = 'A';
    else if (score >= 60) rank = 'B';
    else if (score >= 45) rank = 'C';
    else if (score >= 30) rank = 'D';

    return {
        score: score,
        rank: rank,
        realReturnRate: realReturnRate,
        totalReturnRate: totalReturnRatePercent,
        prizeCount: prizeCount,
        totalValue: totalValue,
        totalPacks: totalPacks
    };
}

// スコア評価モーダルを表示
function showScoreEvaluation() {
    const scoreData = calculateOripaScore();

    if (!scoreData) {
        return;
    }

    // モーダルを表示
    const modal = document.getElementById('scoreModal');
    modal.classList.add('show');

    // アニメーション開始
    animateScore(scoreData);
}

// スコア評価モーダルを閉じる
function closeScoreModal() {
    const modal = document.getElementById('scoreModal');
    modal.classList.remove('show');
}

// スコア表示（スライドアニメーション）
function animateScore(scoreData) {
    const rankElement = document.getElementById('scoreRank');
    const rankContainer = document.getElementById('scoreRankContainer');

    // ランクの配列（E → D → C → B → A → S の順）
    const ranks = ['E', 'D', 'C', 'B', 'A', 'S'];
    const targetRankIndex = ranks.indexOf(scoreData.rank);

    // Eから目標ランクまでの配列を作成（低い方から順番に上がる）
    const ranksToShow = ranks.slice(0, targetRankIndex + 1);

    let currentIndex = 0;
    const slideInDuration = 100; // スライドインの時間（超高速）
    const displayDuration = 100; // 表示時間（超高速）
    const transitionDelay = 50; // 次のアニメーションまでの遅延（連続的に見えるように短く）

    function showNextRank() {
        if (currentIndex >= ranksToShow.length) return;

        const currentRank = ranksToShow[currentIndex];
        const isLastRank = currentIndex === ranksToShow.length - 1;

        // ランク要素を作成してスライドイン
        rankContainer.innerHTML = `<span class="score-rank-item slide-in">${currentRank}</span>`;
        rankElement.className = `score-rank rank-${currentRank}`;

        if (isLastRank) {
            // 最終ランク：確定アニメーション
            setTimeout(() => {
                const item = rankContainer.querySelector('.score-rank-item');
                item.className = 'score-rank-item confirm';

                // スコア詳細を表示
                setTimeout(() => {
                    displayScoreDetails(scoreData);
                }, 300);
            }, slideInDuration);
        } else {
            // 中間ランク：表示後すぐにスライドアウトし、連続的に次を表示
            setTimeout(() => {
                const item = rankContainer.querySelector('.score-rank-item');
                item.className = 'score-rank-item slide-out';

                // スライドアウトが始まったらすぐに次のランクを準備（連続的な動き）
                setTimeout(() => {
                    currentIndex++;
                    showNextRank();
                }, transitionDelay);
            }, slideInDuration + displayDuration);
        }
    }

    showNextRank();
}

// スコア詳細を表示
function displayScoreDetails(scoreData) {
    const detailsElement = document.getElementById('scoreDetails');

    detailsElement.innerHTML = `
        <div class="score-detail-item">
            <span class="score-detail-label">総合スコア</span>
            <span class="score-detail-value">${scoreData.score.toFixed(1)}点 / 100点</span>
        </div>
        <div class="score-detail-item">
            <span class="score-detail-label">実質還元率（売上原価率）</span>
            <span class="score-detail-value">${scoreData.realReturnRate.toFixed(1)}%</span>
        </div>
        <div class="score-detail-item">
            <span class="score-detail-label">景品当選者数</span>
            <span class="score-detail-value">${scoreData.prizeCount}人</span>
        </div>
        <div class="score-detail-item">
            <span class="score-detail-label">オリパ提供価値</span>
            <span class="score-detail-value">¥${scoreData.totalValue.toLocaleString()}</span>
        </div>
        <div class="score-detail-item">
            <span class="score-detail-label">総口数</span>
            <span class="score-detail-value">${scoreData.totalPacks}口</span>
        </div>
    `;
}

// クラッカーエフェクト - 自然な散らばり
function showConfetti() {
    const modal = document.querySelector('.score-modal-content');
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#FF1493', '#00CED1', '#FFD700', '#FF69B4'];

    // 左側から40個、右側から40個の紙吹雪
    const totalConfetti = 80;

    for (let i = 0; i < totalConfetti; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';

            const isLeft = i < totalConfetti / 2;

            // 発射位置の設定
            if (isLeft) {
                confetti.style.left = '10px';
            } else {
                confetti.style.right = '10px';
            }

            // 垂直位置（中央付近からランダムに）
            confetti.style.top = (40 + Math.random() * 20) + '%';

            // ランダムな移動距離と角度を計算
            const angle = isLeft
                ? (Math.random() * 80 - 10) // 左から: -10度〜70度
                : (Math.random() * 80 + 110); // 右から: 110度〜190度

            const distance = 150 + Math.random() * 200; // 150px〜350px
            const angleRad = (angle * Math.PI) / 180;

            const tx = Math.cos(angleRad) * distance;
            const ty = Math.sin(angleRad) * distance;

            // CSS変数に値を設定
            confetti.style.setProperty('--tx', `${tx}px`);
            confetti.style.setProperty('--ty', `${ty}px`);
            confetti.style.setProperty('--rot', `${Math.random() * 720 - 360}deg`); // -360〜360度
            confetti.style.setProperty('--duration', `${0.8 + Math.random() * 0.8}s`); // 0.8〜1.6秒

            // ランダムな色
            confetti.style.background = colors[Math.floor(Math.random() * colors.length)];

            // ランダムな遅延
            confetti.style.animationDelay = Math.random() * 0.15 + 's';

            modal.appendChild(confetti);

            setTimeout(() => {
                confetti.remove();
            }, 2000);
        }, i * 12);
    }
}

</script>

<!-- スコア評価モーダル -->
<div id="scoreModal" onclick="event.target === this && closeScoreModal()">
    <div class="score-modal-content">
        <span class="score-close" onclick="closeScoreModal()">&times;</span>
        <h2 class="score-title">🎯 オリパスコア測定</h2>

        <div class="score-gauge-container">
            <div class="score-rank" id="scoreRank">
                <div class="score-rank-container" id="scoreRankContainer">
                    <!-- スコアランクがここに表示されます -->
                </div>
            </div>
        </div>

        <div class="score-details" id="scoreDetails">
            <!-- スコア詳細がここに表示されます -->
        </div>
    </div>
</div>

</body>
</html>
